(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();/**
* @vue/shared v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**//*! #__NO_SIDE_EFFECTS__ */function Dd(i){const e=Object.create(null);for(const t of i.split(","))e[t]=1;return t=>t in e}const Xe={},is=[],Qr=()=>{},m_=()=>!1,Dl=i=>i.charCodeAt(0)===111&&i.charCodeAt(1)===110&&(i.charCodeAt(2)>122||i.charCodeAt(2)<97),Ud=i=>i.startsWith("onUpdate:"),jt=Object.assign,Ld=(i,e)=>{const t=i.indexOf(e);t>-1&&i.splice(t,1)},y_=Object.prototype.hasOwnProperty,ze=(i,e)=>y_.call(i,e),Pe=Array.isArray,ss=i=>Ul(i)==="[object Map]",Mp=i=>Ul(i)==="[object Set]",Le=i=>typeof i=="function",Et=i=>typeof i=="string",Zn=i=>typeof i=="symbol",it=i=>i!==null&&typeof i=="object",Ap=i=>(it(i)||Le(i))&&Le(i.then)&&Le(i.catch),Dp=Object.prototype.toString,Ul=i=>Dp.call(i),S_=i=>Ul(i).slice(8,-1),Up=i=>Ul(i)==="[object Object]",Nd=i=>Et(i)&&i!=="NaN"&&i[0]!=="-"&&""+parseInt(i,10)===i,To=Dd(",key,ref,ref_for,ref_key,onVnodeBeforeMount,onVnodeMounted,onVnodeBeforeUpdate,onVnodeUpdated,onVnodeBeforeUnmount,onVnodeUnmounted"),Ll=i=>{const e=Object.create(null);return t=>e[t]||(e[t]=i(t))},__=/-(\w)/g,Yn=Ll(i=>i.replace(__,(e,t)=>t?t.toUpperCase():"")),b_=/\B([A-Z])/g,Fi=Ll(i=>i.replace(b_,"-$1").toLowerCase()),Lp=Ll(i=>i.charAt(0).toUpperCase()+i.slice(1)),cu=Ll(i=>i?`on${Lp(i)}`:""),Gn=(i,e)=>!Object.is(i,e),Ga=(i,...e)=>{for(let t=0;t<i.length;t++)i[t](...e)},Np=(i,e,t,r=!1)=>{Object.defineProperty(i,e,{configurable:!0,enumerable:!1,writable:r,value:t})},dc=i=>{const e=parseFloat(i);return isNaN(e)?i:e};let jh;const Nl=()=>jh||(jh=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});function xd(i){if(Pe(i)){const e={};for(let t=0;t<i.length;t++){const r=i[t],n=Et(r)?T_(r):xd(r);if(n)for(const s in n)e[s]=n[s]}return e}else if(Et(i)||it(i))return i}const E_=/;(?![^(]*\))/g,w_=/:([^]+)/,R_=/\/\*[^]*?\*\//g;function T_(i){const e={};return i.replace(R_,"").split(E_).forEach(t=>{if(t){const r=t.split(w_);r.length>1&&(e[r[0].trim()]=r[1].trim())}}),e}function Kd(i){let e="";if(Et(i))e=i;else if(Pe(i))for(let t=0;t<i.length;t++){const r=Kd(i[t]);r&&(e+=r+" ")}else if(it(i))for(const t in i)i[t]&&(e+=t+" ");return e.trim()}const I_="itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly",C_=Dd(I_);function xp(i){return!!i||i===""}const Kp=i=>!!(i&&i.__v_isRef===!0),Io=i=>Et(i)?i:i==null?"":Pe(i)||it(i)&&(i.toString===Dp||!Le(i.toString))?Kp(i)?Io(i.value):JSON.stringify(i,Fp,2):String(i),Fp=(i,e)=>Kp(e)?Fp(i,e.value):ss(e)?{[`Map(${e.size})`]:[...e.entries()].reduce((t,[r,n],s)=>(t[du(r,s)+" =>"]=n,t),{})}:Mp(e)?{[`Set(${e.size})`]:[...e.values()].map(t=>du(t))}:Zn(e)?du(e):it(e)&&!Pe(e)&&!Up(e)?String(e):e,du=(i,e="")=>{var t;return Zn(i)?`Symbol(${(t=i.description)!=null?t:e})`:i};/**
* @vue/reactivity v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let Wt;class Bp{constructor(e=!1){this.detached=e,this._active=!0,this.effects=[],this.cleanups=[],this._isPaused=!1,this.parent=Wt,!e&&Wt&&(this.index=(Wt.scopes||(Wt.scopes=[])).push(this)-1)}get active(){return this._active}pause(){if(this._active){this._isPaused=!0;let e,t;if(this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].pause();for(e=0,t=this.effects.length;e<t;e++)this.effects[e].pause()}}resume(){if(this._active&&this._isPaused){this._isPaused=!1;let e,t;if(this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].resume();for(e=0,t=this.effects.length;e<t;e++)this.effects[e].resume()}}run(e){if(this._active){const t=Wt;try{return Wt=this,e()}finally{Wt=t}}}on(){Wt=this}off(){Wt=this.parent}stop(e){if(this._active){this._active=!1;let t,r;for(t=0,r=this.effects.length;t<r;t++)this.effects[t].stop();for(this.effects.length=0,t=0,r=this.cleanups.length;t<r;t++)this.cleanups[t]();if(this.cleanups.length=0,this.scopes){for(t=0,r=this.scopes.length;t<r;t++)this.scopes[t].stop(!0);this.scopes.length=0}if(!this.detached&&this.parent&&!e){const n=this.parent.scopes.pop();n&&n!==this&&(this.parent.scopes[this.index]=n,n.index=this.index)}this.parent=void 0}}}function jp(i){return new Bp(i)}function qp(){return Wt}function k_(i,e=!1){Wt&&Wt.cleanups.push(i)}let Ze;const hu=new WeakSet;class Vp{constructor(e){this.fn=e,this.deps=void 0,this.depsTail=void 0,this.flags=5,this.next=void 0,this.cleanup=void 0,this.scheduler=void 0,Wt&&Wt.active&&Wt.effects.push(this)}pause(){this.flags|=64}resume(){this.flags&64&&(this.flags&=-65,hu.has(this)&&(hu.delete(this),this.trigger()))}notify(){this.flags&2&&!(this.flags&32)||this.flags&8||Gp(this)}run(){if(!(this.flags&1))return this.fn();this.flags|=2,qh(this),Hp(this);const e=Ze,t=Pr;Ze=this,Pr=!0;try{return this.fn()}finally{$p(this),Ze=e,Pr=t,this.flags&=-3}}stop(){if(this.flags&1){for(let e=this.deps;e;e=e.nextDep)jd(e);this.deps=this.depsTail=void 0,qh(this),this.onStop&&this.onStop(),this.flags&=-2}}trigger(){this.flags&64?hu.add(this):this.scheduler?this.scheduler():this.runIfDirty()}runIfDirty(){hc(this)&&this.run()}get dirty(){return hc(this)}}let Wp=0,Co,ko;function Gp(i,e=!1){if(i.flags|=8,e){i.next=ko,ko=i;return}i.next=Co,Co=i}function Fd(){Wp++}function Bd(){if(--Wp>0)return;if(ko){let e=ko;for(ko=void 0;e;){const t=e.next;e.next=void 0,e.flags&=-9,e=t}}let i;for(;Co;){let e=Co;for(Co=void 0;e;){const t=e.next;if(e.next=void 0,e.flags&=-9,e.flags&1)try{e.trigger()}catch(r){i||(i=r)}e=t}}if(i)throw i}function Hp(i){for(let e=i.deps;e;e=e.nextDep)e.version=-1,e.prevActiveLink=e.dep.activeLink,e.dep.activeLink=e}function $p(i){let e,t=i.depsTail,r=t;for(;r;){const n=r.prevDep;r.version===-1?(r===t&&(t=n),jd(r),O_(r)):e=r,r.dep.activeLink=r.prevActiveLink,r.prevActiveLink=void 0,r=n}i.deps=e,i.depsTail=t}function hc(i){for(let e=i.deps;e;e=e.nextDep)if(e.dep.version!==e.version||e.dep.computed&&(zp(e.dep.computed)||e.dep.version!==e.version))return!0;return!!i._dirty}function zp(i){if(i.flags&4&&!(i.flags&16)||(i.flags&=-17,i.globalVersion===Wo))return;i.globalVersion=Wo;const e=i.dep;if(i.flags|=2,e.version>0&&!i.isSSR&&i.deps&&!hc(i)){i.flags&=-3;return}const t=Ze,r=Pr;Ze=i,Pr=!0;try{Hp(i);const n=i.fn(i._value);(e.version===0||Gn(n,i._value))&&(i._value=n,e.version++)}catch(n){throw e.version++,n}finally{Ze=t,Pr=r,$p(i),i.flags&=-3}}function jd(i,e=!1){const{dep:t,prevSub:r,nextSub:n}=i;if(r&&(r.nextSub=n,i.prevSub=void 0),n&&(n.prevSub=r,i.nextSub=void 0),t.subs===i&&(t.subs=r,!r&&t.computed)){t.computed.flags&=-5;for(let s=t.computed.deps;s;s=s.nextDep)jd(s,!0)}!e&&!--t.sc&&t.map&&t.map.delete(t.key)}function O_(i){const{prevDep:e,nextDep:t}=i;e&&(e.nextDep=t,i.prevDep=void 0),t&&(t.prevDep=e,i.nextDep=void 0)}let Pr=!0;const Jp=[];function ei(){Jp.push(Pr),Pr=!1}function ti(){const i=Jp.pop();Pr=i===void 0?!0:i}function qh(i){const{cleanup:e}=i;if(i.cleanup=void 0,e){const t=Ze;Ze=void 0;try{e()}finally{Ze=t}}}let Wo=0;class P_{constructor(e,t){this.sub=e,this.dep=t,this.version=t.version,this.nextDep=this.prevDep=this.nextSub=this.prevSub=this.prevActiveLink=void 0}}class qd{constructor(e){this.computed=e,this.version=0,this.activeLink=void 0,this.subs=void 0,this.map=void 0,this.key=void 0,this.sc=0}track(e){if(!Ze||!Pr||Ze===this.computed)return;let t=this.activeLink;if(t===void 0||t.sub!==Ze)t=this.activeLink=new P_(Ze,this),Ze.deps?(t.prevDep=Ze.depsTail,Ze.depsTail.nextDep=t,Ze.depsTail=t):Ze.deps=Ze.depsTail=t,Yp(t);else if(t.version===-1&&(t.version=this.version,t.nextDep)){const r=t.nextDep;r.prevDep=t.prevDep,t.prevDep&&(t.prevDep.nextDep=r),t.prevDep=Ze.depsTail,t.nextDep=void 0,Ze.depsTail.nextDep=t,Ze.depsTail=t,Ze.deps===t&&(Ze.deps=r)}return t}trigger(e){this.version++,Wo++,this.notify(e)}notify(e){Fd();try{for(let t=this.subs;t;t=t.prevSub)t.sub.notify()&&t.sub.dep.notify()}finally{Bd()}}}function Yp(i){if(i.dep.sc++,i.sub.flags&4){const e=i.dep.computed;if(e&&!i.dep.subs){e.flags|=20;for(let r=e.deps;r;r=r.nextDep)Yp(r)}const t=i.dep.subs;t!==i&&(i.prevSub=t,t&&(t.nextSub=i)),i.dep.subs=i}}const al=new WeakMap,Pi=Symbol(""),fc=Symbol(""),Go=Symbol("");function Nt(i,e,t){if(Pr&&Ze){let r=al.get(i);r||al.set(i,r=new Map);let n=r.get(t);n||(r.set(t,n=new qd),n.map=r,n.key=t),n.track()}}function fn(i,e,t,r,n,s){const o=al.get(i);if(!o){Wo++;return}const a=l=>{l&&l.trigger()};if(Fd(),e==="clear")o.forEach(a);else{const l=Pe(i),u=l&&Nd(t);if(l&&t==="length"){const c=Number(r);o.forEach((d,h)=>{(h==="length"||h===Go||!Zn(h)&&h>=c)&&a(d)})}else switch((t!==void 0||o.has(void 0))&&a(o.get(t)),u&&a(o.get(Go)),e){case"add":l?u&&a(o.get("length")):(a(o.get(Pi)),ss(i)&&a(o.get(fc)));break;case"delete":l||(a(o.get(Pi)),ss(i)&&a(o.get(fc)));break;case"set":ss(i)&&a(o.get(Pi));break}}Bd()}function M_(i,e){const t=al.get(i);return t&&t.get(e)}function qi(i){const e=qe(i);return e===i?e:(Nt(e,"iterate",Go),Sr(i)?e:e.map(xt))}function xl(i){return Nt(i=qe(i),"iterate",Go),i}const A_={__proto__:null,[Symbol.iterator](){return fu(this,Symbol.iterator,xt)},concat(...i){return qi(this).concat(...i.map(e=>Pe(e)?qi(e):e))},entries(){return fu(this,"entries",i=>(i[1]=xt(i[1]),i))},every(i,e){return tn(this,"every",i,e,void 0,arguments)},filter(i,e){return tn(this,"filter",i,e,t=>t.map(xt),arguments)},find(i,e){return tn(this,"find",i,e,xt,arguments)},findIndex(i,e){return tn(this,"findIndex",i,e,void 0,arguments)},findLast(i,e){return tn(this,"findLast",i,e,xt,arguments)},findLastIndex(i,e){return tn(this,"findLastIndex",i,e,void 0,arguments)},forEach(i,e){return tn(this,"forEach",i,e,void 0,arguments)},includes(...i){return vu(this,"includes",i)},indexOf(...i){return vu(this,"indexOf",i)},join(i){return qi(this).join(i)},lastIndexOf(...i){return vu(this,"lastIndexOf",i)},map(i,e){return tn(this,"map",i,e,void 0,arguments)},pop(){return Us(this,"pop")},push(...i){return Us(this,"push",i)},reduce(i,...e){return Vh(this,"reduce",i,e)},reduceRight(i,...e){return Vh(this,"reduceRight",i,e)},shift(){return Us(this,"shift")},some(i,e){return tn(this,"some",i,e,void 0,arguments)},splice(...i){return Us(this,"splice",i)},toReversed(){return qi(this).toReversed()},toSorted(i){return qi(this).toSorted(i)},toSpliced(...i){return qi(this).toSpliced(...i)},unshift(...i){return Us(this,"unshift",i)},values(){return fu(this,"values",xt)}};function fu(i,e,t){const r=xl(i),n=r[e]();return r!==i&&!Sr(i)&&(n._next=n.next,n.next=()=>{const s=n._next();return s.value&&(s.value=t(s.value)),s}),n}const D_=Array.prototype;function tn(i,e,t,r,n,s){const o=xl(i),a=o!==i&&!Sr(i),l=o[e];if(l!==D_[e]){const d=l.apply(i,s);return a?xt(d):d}let u=t;o!==i&&(a?u=function(d,h){return t.call(this,xt(d),h,i)}:t.length>2&&(u=function(d,h){return t.call(this,d,h,i)}));const c=l.call(o,u,r);return a&&n?n(c):c}function Vh(i,e,t,r){const n=xl(i);let s=t;return n!==i&&(Sr(i)?t.length>3&&(s=function(o,a,l){return t.call(this,o,a,l,i)}):s=function(o,a,l){return t.call(this,o,xt(a),l,i)}),n[e](s,...r)}function vu(i,e,t){const r=qe(i);Nt(r,"iterate",Go);const n=r[e](...t);return(n===-1||n===!1)&&Gd(t[0])?(t[0]=qe(t[0]),r[e](...t)):n}function Us(i,e,t=[]){ei(),Fd();const r=qe(i)[e].apply(i,t);return Bd(),ti(),r}const U_=Dd("__proto__,__v_isRef,__isVue"),Qp=new Set(Object.getOwnPropertyNames(Symbol).filter(i=>i!=="arguments"&&i!=="caller").map(i=>Symbol[i]).filter(Zn));function L_(i){Zn(i)||(i=String(i));const e=qe(this);return Nt(e,"has",i),e.hasOwnProperty(i)}class Xp{constructor(e=!1,t=!1){this._isReadonly=e,this._isShallow=t}get(e,t,r){if(t==="__v_skip")return e.__v_skip;const n=this._isReadonly,s=this._isShallow;if(t==="__v_isReactive")return!n;if(t==="__v_isReadonly")return n;if(t==="__v_isShallow")return s;if(t==="__v_raw")return r===(n?s?G_:rm:s?tm:em).get(e)||Object.getPrototypeOf(e)===Object.getPrototypeOf(r)?e:void 0;const o=Pe(e);if(!n){let l;if(o&&(l=A_[t]))return l;if(t==="hasOwnProperty")return L_}const a=Reflect.get(e,t,pt(e)?e:r);return(Zn(t)?Qp.has(t):U_(t))||(n||Nt(e,"get",t),s)?a:pt(a)?o&&Nd(t)?a:a.value:it(a)?n?im(a):ha(a):a}}class Zp extends Xp{constructor(e=!1){super(!1,e)}set(e,t,r,n){let s=e[t];if(!this._isShallow){const l=Ni(s);if(!Sr(r)&&!Ni(r)&&(s=qe(s),r=qe(r)),!Pe(e)&&pt(s)&&!pt(r))return l?!1:(s.value=r,!0)}const o=Pe(e)&&Nd(t)?Number(t)<e.length:ze(e,t),a=Reflect.set(e,t,r,pt(e)?e:n);return e===qe(n)&&(o?Gn(r,s)&&fn(e,"set",t,r):fn(e,"add",t,r)),a}deleteProperty(e,t){const r=ze(e,t);e[t];const n=Reflect.deleteProperty(e,t);return n&&r&&fn(e,"delete",t,void 0),n}has(e,t){const r=Reflect.has(e,t);return(!Zn(t)||!Qp.has(t))&&Nt(e,"has",t),r}ownKeys(e){return Nt(e,"iterate",Pe(e)?"length":Pi),Reflect.ownKeys(e)}}class N_ extends Xp{constructor(e=!1){super(!0,e)}set(e,t){return!0}deleteProperty(e,t){return!0}}const x_=new Zp,K_=new N_,F_=new Zp(!0);const vc=i=>i,Ea=i=>Reflect.getPrototypeOf(i);function B_(i,e,t){return function(...r){const n=this.__v_raw,s=qe(n),o=ss(s),a=i==="entries"||i===Symbol.iterator&&o,l=i==="keys"&&o,u=n[i](...r),c=t?vc:e?gc:xt;return!e&&Nt(s,"iterate",l?fc:Pi),{next(){const{value:d,done:h}=u.next();return h?{value:d,done:h}:{value:a?[c(d[0]),c(d[1])]:c(d),done:h}},[Symbol.iterator](){return this}}}}function wa(i){return function(...e){return i==="delete"?!1:i==="clear"?void 0:this}}function j_(i,e){const t={get(n){const s=this.__v_raw,o=qe(s),a=qe(n);i||(Gn(n,a)&&Nt(o,"get",n),Nt(o,"get",a));const{has:l}=Ea(o),u=e?vc:i?gc:xt;if(l.call(o,n))return u(s.get(n));if(l.call(o,a))return u(s.get(a));s!==o&&s.get(n)},get size(){const n=this.__v_raw;return!i&&Nt(qe(n),"iterate",Pi),Reflect.get(n,"size",n)},has(n){const s=this.__v_raw,o=qe(s),a=qe(n);return i||(Gn(n,a)&&Nt(o,"has",n),Nt(o,"has",a)),n===a?s.has(n):s.has(n)||s.has(a)},forEach(n,s){const o=this,a=o.__v_raw,l=qe(a),u=e?vc:i?gc:xt;return!i&&Nt(l,"iterate",Pi),a.forEach((c,d)=>n.call(s,u(c),u(d),o))}};return jt(t,i?{add:wa("add"),set:wa("set"),delete:wa("delete"),clear:wa("clear")}:{add(n){!e&&!Sr(n)&&!Ni(n)&&(n=qe(n));const s=qe(this);return Ea(s).has.call(s,n)||(s.add(n),fn(s,"add",n,n)),this},set(n,s){!e&&!Sr(s)&&!Ni(s)&&(s=qe(s));const o=qe(this),{has:a,get:l}=Ea(o);let u=a.call(o,n);u||(n=qe(n),u=a.call(o,n));const c=l.call(o,n);return o.set(n,s),u?Gn(s,c)&&fn(o,"set",n,s):fn(o,"add",n,s),this},delete(n){const s=qe(this),{has:o,get:a}=Ea(s);let l=o.call(s,n);l||(n=qe(n),l=o.call(s,n)),a&&a.call(s,n);const u=s.delete(n);return l&&fn(s,"delete",n,void 0),u},clear(){const n=qe(this),s=n.size!==0,o=n.clear();return s&&fn(n,"clear",void 0,void 0),o}}),["keys","values","entries",Symbol.iterator].forEach(n=>{t[n]=B_(n,i,e)}),t}function Vd(i,e){const t=j_(i,e);return(r,n,s)=>n==="__v_isReactive"?!i:n==="__v_isReadonly"?i:n==="__v_raw"?r:Reflect.get(ze(t,n)&&n in r?t:r,n,s)}const q_={get:Vd(!1,!1)},V_={get:Vd(!1,!0)},W_={get:Vd(!0,!1)};const em=new WeakMap,tm=new WeakMap,rm=new WeakMap,G_=new WeakMap;function H_(i){switch(i){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function $_(i){return i.__v_skip||!Object.isExtensible(i)?0:H_(S_(i))}function ha(i){return Ni(i)?i:Wd(i,!1,x_,q_,em)}function nm(i){return Wd(i,!1,F_,V_,tm)}function im(i){return Wd(i,!0,K_,W_,rm)}function Wd(i,e,t,r,n){if(!it(i)||i.__v_raw&&!(e&&i.__v_isReactive))return i;const s=n.get(i);if(s)return s;const o=$_(i);if(o===0)return i;const a=new Proxy(i,o===2?r:t);return n.set(i,a),a}function Hn(i){return Ni(i)?Hn(i.__v_raw):!!(i&&i.__v_isReactive)}function Ni(i){return!!(i&&i.__v_isReadonly)}function Sr(i){return!!(i&&i.__v_isShallow)}function Gd(i){return i?!!i.__v_raw:!1}function qe(i){const e=i&&i.__v_raw;return e?qe(e):i}function Hd(i){return!ze(i,"__v_skip")&&Object.isExtensible(i)&&Np(i,"__v_skip",!0),i}const xt=i=>it(i)?ha(i):i,gc=i=>it(i)?im(i):i;function pt(i){return i?i.__v_isRef===!0:!1}function yn(i){return sm(i,!1)}function z_(i){return sm(i,!0)}function sm(i,e){return pt(i)?i:new J_(i,e)}class J_{constructor(e,t){this.dep=new qd,this.__v_isRef=!0,this.__v_isShallow=!1,this._rawValue=t?e:qe(e),this._value=t?e:xt(e),this.__v_isShallow=t}get value(){return this.dep.track(),this._value}set value(e){const t=this._rawValue,r=this.__v_isShallow||Sr(e)||Ni(e);e=r?e:qe(e),Gn(e,t)&&(this._rawValue=e,this._value=r?e:xt(e),this.dep.trigger())}}function Mi(i){return pt(i)?i.value:i}const Y_={get:(i,e,t)=>e==="__v_raw"?i:Mi(Reflect.get(i,e,t)),set:(i,e,t,r)=>{const n=i[e];return pt(n)&&!pt(t)?(n.value=t,!0):Reflect.set(i,e,t,r)}};function om(i){return Hn(i)?i:new Proxy(i,Y_)}function Q_(i){const e=Pe(i)?new Array(i.length):{};for(const t in i)e[t]=Z_(i,t);return e}class X_{constructor(e,t,r){this._object=e,this._key=t,this._defaultValue=r,this.__v_isRef=!0,this._value=void 0}get value(){const e=this._object[this._key];return this._value=e===void 0?this._defaultValue:e}set value(e){this._object[this._key]=e}get dep(){return M_(qe(this._object),this._key)}}function Z_(i,e,t){const r=i[e];return pt(r)?r:new X_(i,e,t)}class eb{constructor(e,t,r){this.fn=e,this.setter=t,this._value=void 0,this.dep=new qd(this),this.__v_isRef=!0,this.deps=void 0,this.depsTail=void 0,this.flags=16,this.globalVersion=Wo-1,this.next=void 0,this.effect=this,this.__v_isReadonly=!t,this.isSSR=r}notify(){if(this.flags|=16,!(this.flags&8)&&Ze!==this)return Gp(this,!0),!0}get value(){const e=this.dep.track();return zp(this),e&&(e.version=this.dep.version),this._value}set value(e){this.setter&&this.setter(e)}}function tb(i,e,t=!1){let r,n;return Le(i)?r=i:(r=i.get,n=i.set),new eb(r,n,t)}const Ra={},ll=new WeakMap;let bi;function rb(i,e=!1,t=bi){if(t){let r=ll.get(t);r||ll.set(t,r=[]),r.push(i)}}function nb(i,e,t=Xe){const{immediate:r,deep:n,once:s,scheduler:o,augmentJob:a,call:l}=t,u=b=>n?b:Sr(b)||n===!1||n===0?vn(b,1):vn(b);let c,d,h,g,v=!1,m=!1;if(pt(i)?(d=()=>i.value,v=Sr(i)):Hn(i)?(d=()=>u(i),v=!0):Pe(i)?(m=!0,v=i.some(b=>Hn(b)||Sr(b)),d=()=>i.map(b=>{if(pt(b))return b.value;if(Hn(b))return u(b);if(Le(b))return l?l(b,2):b()})):Le(i)?e?d=l?()=>l(i,2):i:d=()=>{if(h){ei();try{h()}finally{ti()}}const b=bi;bi=c;try{return l?l(i,3,[g]):i(g)}finally{bi=b}}:d=Qr,e&&n){const b=d,I=n===!0?1/0:n;d=()=>vn(b(),I)}const E=qp(),R=()=>{c.stop(),E&&E.active&&Ld(E.effects,c)};if(s&&e){const b=e;e=(...I)=>{b(...I),R()}}let _=m?new Array(i.length).fill(Ra):Ra;const T=b=>{if(!(!(c.flags&1)||!c.dirty&&!b))if(e){const I=c.run();if(n||v||(m?I.some((y,C)=>Gn(y,_[C])):Gn(I,_))){h&&h();const y=bi;bi=c;try{const C=[I,_===Ra?void 0:m&&_[0]===Ra?[]:_,g];l?l(e,3,C):e(...C),_=I}finally{bi=y}}}else c.run()};return a&&a(T),c=new Vp(d),c.scheduler=o?()=>o(T,!1):T,g=b=>rb(b,!1,c),h=c.onStop=()=>{const b=ll.get(c);if(b){if(l)l(b,4);else for(const I of b)I();ll.delete(c)}},e?r?T(!0):_=c.run():o?o(T.bind(null,!0),!0):c.run(),R.pause=c.pause.bind(c),R.resume=c.resume.bind(c),R.stop=R,R}function vn(i,e=1/0,t){if(e<=0||!it(i)||i.__v_skip||(t=t||new Set,t.has(i)))return i;if(t.add(i),e--,pt(i))vn(i.value,e,t);else if(Pe(i))for(let r=0;r<i.length;r++)vn(i[r],e,t);else if(Mp(i)||ss(i))i.forEach(r=>{vn(r,e,t)});else if(Up(i)){for(const r in i)vn(i[r],e,t);for(const r of Object.getOwnPropertySymbols(i))Object.prototype.propertyIsEnumerable.call(i,r)&&vn(i[r],e,t)}return i}/**
* @vue/runtime-core v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/function fa(i,e,t,r){try{return r?i(...r):i()}catch(n){Kl(n,e,t)}}function Zr(i,e,t,r){if(Le(i)){const n=fa(i,e,t,r);return n&&Ap(n)&&n.catch(s=>{Kl(s,e,t)}),n}if(Pe(i)){const n=[];for(let s=0;s<i.length;s++)n.push(Zr(i[s],e,t,r));return n}}function Kl(i,e,t,r=!0){const n=e?e.vnode:null,{errorHandler:s,throwUnhandledErrorInProduction:o}=e&&e.appContext.config||Xe;if(e){let a=e.parent;const l=e.proxy,u=`https://vuejs.org/error-reference/#runtime-${t}`;for(;a;){const c=a.ec;if(c){for(let d=0;d<c.length;d++)if(c[d](i,l,u)===!1)return}a=a.parent}if(s){ei(),fa(s,null,10,[i,l,u]),ti();return}}ib(i,t,n,r,o)}function ib(i,e,t,r=!0,n=!1){if(n)throw i;console.error(i)}const $t=[];let Vr=-1;const os=[];let Kn=null,Yi=0;const am=Promise.resolve();let ul=null;function $d(i){const e=ul||am;return i?e.then(this?i.bind(this):i):e}function sb(i){let e=Vr+1,t=$t.length;for(;e<t;){const r=e+t>>>1,n=$t[r],s=Ho(n);s<i||s===i&&n.flags&2?e=r+1:t=r}return e}function zd(i){if(!(i.flags&1)){const e=Ho(i),t=$t[$t.length-1];!t||!(i.flags&2)&&e>=Ho(t)?$t.push(i):$t.splice(sb(e),0,i),i.flags|=1,lm()}}function lm(){ul||(ul=am.then(cm))}function ob(i){Pe(i)?os.push(...i):Kn&&i.id===-1?Kn.splice(Yi+1,0,i):i.flags&1||(os.push(i),i.flags|=1),lm()}function Wh(i,e,t=Vr+1){for(;t<$t.length;t++){const r=$t[t];if(r&&r.flags&2){if(i&&r.id!==i.uid)continue;$t.splice(t,1),t--,r.flags&4&&(r.flags&=-2),r(),r.flags&4||(r.flags&=-2)}}}function um(i){if(os.length){const e=[...new Set(os)].sort((t,r)=>Ho(t)-Ho(r));if(os.length=0,Kn){Kn.push(...e);return}for(Kn=e,Yi=0;Yi<Kn.length;Yi++){const t=Kn[Yi];t.flags&4&&(t.flags&=-2),t.flags&8||t(),t.flags&=-2}Kn=null,Yi=0}}const Ho=i=>i.id==null?i.flags&2?-1:1/0:i.id;function cm(i){try{for(Vr=0;Vr<$t.length;Vr++){const e=$t[Vr];e&&!(e.flags&8)&&(e.flags&4&&(e.flags&=-2),fa(e,e.i,e.i?15:14),e.flags&4||(e.flags&=-2))}}finally{for(;Vr<$t.length;Vr++){const e=$t[Vr];e&&(e.flags&=-2)}Vr=-1,$t.length=0,um(),ul=null,($t.length||os.length)&&cm()}}let pr=null,dm=null;function cl(i){const e=pr;return pr=i,dm=i&&i.type.__scopeId||null,e}function ab(i,e=pr,t){if(!e||i._n)return i;const r=(...n)=>{r._d&&Zh(-1);const s=cl(e);let o;try{o=i(...n)}finally{cl(s),r._d&&Zh(1)}return o};return r._n=!0,r._c=!0,r._d=!0,r}function gu(i,e){if(pr===null)return i;const t=ql(pr),r=i.dirs||(i.dirs=[]);for(let n=0;n<e.length;n++){let[s,o,a,l=Xe]=e[n];s&&(Le(s)&&(s={mounted:s,updated:s}),s.deep&&vn(o),r.push({dir:s,instance:t,value:o,oldValue:void 0,arg:a,modifiers:l}))}return i}function ai(i,e,t,r){const n=i.dirs,s=e&&e.dirs;for(let o=0;o<n.length;o++){const a=n[o];s&&(a.oldValue=s[o].value);let l=a.dir[r];l&&(ei(),Zr(l,t,8,[i.el,a,i,e]),ti())}}const lb=Symbol("_vte"),ub=i=>i.__isTeleport;function Jd(i,e){i.shapeFlag&6&&i.component?(i.transition=e,Jd(i.component.subTree,e)):i.shapeFlag&128?(i.ssContent.transition=e.clone(i.ssContent),i.ssFallback.transition=e.clone(i.ssFallback)):i.transition=e}/*! #__NO_SIDE_EFFECTS__ */function hm(i,e){return Le(i)?jt({name:i.name},e,{setup:i}):i}function fm(i){i.ids=[i.ids[0]+i.ids[2]+++"-",0,0]}function dl(i,e,t,r,n=!1){if(Pe(i)){i.forEach((v,m)=>dl(v,e&&(Pe(e)?e[m]:e),t,r,n));return}if(Oo(r)&&!n){r.shapeFlag&512&&r.type.__asyncResolved&&r.component.subTree.component&&dl(i,e,t,r.component.subTree);return}const s=r.shapeFlag&4?ql(r.component):r.el,o=n?null:s,{i:a,r:l}=i,u=e&&e.r,c=a.refs===Xe?a.refs={}:a.refs,d=a.setupState,h=qe(d),g=d===Xe?()=>!1:v=>ze(h,v);if(u!=null&&u!==l&&(Et(u)?(c[u]=null,g(u)&&(d[u]=null)):pt(u)&&(u.value=null)),Le(l))fa(l,a,12,[o,c]);else{const v=Et(l),m=pt(l);if(v||m){const E=()=>{if(i.f){const R=v?g(l)?d[l]:c[l]:l.value;n?Pe(R)&&Ld(R,s):Pe(R)?R.includes(s)||R.push(s):v?(c[l]=[s],g(l)&&(d[l]=c[l])):(l.value=[s],i.k&&(c[i.k]=l.value))}else v?(c[l]=o,g(l)&&(d[l]=o)):m&&(l.value=o,i.k&&(c[i.k]=o))};o?(E.id=-1,cr(E,t)):E()}}}Nl().requestIdleCallback;Nl().cancelIdleCallback;const Oo=i=>!!i.type.__asyncLoader,vm=i=>i.type.__isKeepAlive;function cb(i,e){gm(i,"a",e)}function db(i,e){gm(i,"da",e)}function gm(i,e,t=Bt){const r=i.__wdc||(i.__wdc=()=>{let n=t;for(;n;){if(n.isDeactivated)return;n=n.parent}return i()});if(Fl(e,r,t),t){let n=t.parent;for(;n&&n.parent;)vm(n.parent.vnode)&&hb(r,e,t,n),n=n.parent}}function hb(i,e,t,r){const n=Fl(e,i,r,!0);mm(()=>{Ld(r[e],n)},t)}function Fl(i,e,t=Bt,r=!1){if(t){const n=t[i]||(t[i]=[]),s=e.__weh||(e.__weh=(...o)=>{ei();const a=va(t),l=Zr(e,t,i,o);return a(),ti(),l});return r?n.unshift(s):n.push(s),s}}const In=i=>(e,t=Bt)=>{(!zo||i==="sp")&&Fl(i,(...r)=>e(...r),t)},fb=In("bm"),pm=In("m"),vb=In("bu"),gb=In("u"),pb=In("bum"),mm=In("um"),mb=In("sp"),yb=In("rtg"),Sb=In("rtc");function _b(i,e=Bt){Fl("ec",i,e)}const bb=Symbol.for("v-ndc");function Eb(i,e,t,r){let n;const s=t,o=Pe(i);if(o||Et(i)){const a=o&&Hn(i);let l=!1;a&&(l=!Sr(i),i=xl(i)),n=new Array(i.length);for(let u=0,c=i.length;u<c;u++)n[u]=e(l?xt(i[u]):i[u],u,void 0,s)}else if(typeof i=="number"){n=new Array(i);for(let a=0;a<i;a++)n[a]=e(a+1,a,void 0,s)}else if(it(i))if(i[Symbol.iterator])n=Array.from(i,(a,l)=>e(a,l,void 0,s));else{const a=Object.keys(i);n=new Array(a.length);for(let l=0,u=a.length;l<u;l++){const c=a[l];n[l]=e(i[c],c,l,s)}}else n=[];return n}const pc=i=>i?Km(i)?ql(i):pc(i.parent):null,Po=jt(Object.create(null),{$:i=>i,$el:i=>i.vnode.el,$data:i=>i.data,$props:i=>i.props,$attrs:i=>i.attrs,$slots:i=>i.slots,$refs:i=>i.refs,$parent:i=>pc(i.parent),$root:i=>pc(i.root),$host:i=>i.ce,$emit:i=>i.emit,$options:i=>Sm(i),$forceUpdate:i=>i.f||(i.f=()=>{zd(i.update)}),$nextTick:i=>i.n||(i.n=$d.bind(i.proxy)),$watch:i=>Wb.bind(i)}),pu=(i,e)=>i!==Xe&&!i.__isScriptSetup&&ze(i,e),wb={get({_:i},e){if(e==="__v_skip")return!0;const{ctx:t,setupState:r,data:n,props:s,accessCache:o,type:a,appContext:l}=i;let u;if(e[0]!=="$"){const g=o[e];if(g!==void 0)switch(g){case 1:return r[e];case 2:return n[e];case 4:return t[e];case 3:return s[e]}else{if(pu(r,e))return o[e]=1,r[e];if(n!==Xe&&ze(n,e))return o[e]=2,n[e];if((u=i.propsOptions[0])&&ze(u,e))return o[e]=3,s[e];if(t!==Xe&&ze(t,e))return o[e]=4,t[e];mc&&(o[e]=0)}}const c=Po[e];let d,h;if(c)return e==="$attrs"&&Nt(i.attrs,"get",""),c(i);if((d=a.__cssModules)&&(d=d[e]))return d;if(t!==Xe&&ze(t,e))return o[e]=4,t[e];if(h=l.config.globalProperties,ze(h,e))return h[e]},set({_:i},e,t){const{data:r,setupState:n,ctx:s}=i;return pu(n,e)?(n[e]=t,!0):r!==Xe&&ze(r,e)?(r[e]=t,!0):ze(i.props,e)||e[0]==="$"&&e.slice(1)in i?!1:(s[e]=t,!0)},has({_:{data:i,setupState:e,accessCache:t,ctx:r,appContext:n,propsOptions:s}},o){let a;return!!t[o]||i!==Xe&&ze(i,o)||pu(e,o)||(a=s[0])&&ze(a,o)||ze(r,o)||ze(Po,o)||ze(n.config.globalProperties,o)},defineProperty(i,e,t){return t.get!=null?i._.accessCache[e]=0:ze(t,"value")&&this.set(i,e,t.value,null),Reflect.defineProperty(i,e,t)}};function Gh(i){return Pe(i)?i.reduce((e,t)=>(e[t]=null,e),{}):i}let mc=!0;function Rb(i){const e=Sm(i),t=i.proxy,r=i.ctx;mc=!1,e.beforeCreate&&Hh(e.beforeCreate,i,"bc");const{data:n,computed:s,methods:o,watch:a,provide:l,inject:u,created:c,beforeMount:d,mounted:h,beforeUpdate:g,updated:v,activated:m,deactivated:E,beforeDestroy:R,beforeUnmount:_,destroyed:T,unmounted:b,render:I,renderTracked:y,renderTriggered:C,errorCaptured:w,serverPrefetch:D,expose:x,inheritAttrs:G,components:oe,directives:de,filters:Ee}=e;if(u&&Tb(u,r,null),o)for(const Z in o){const ne=o[Z];Le(ne)&&(r[Z]=ne.bind(t))}if(n){const Z=n.call(t,t);it(Z)&&(i.data=ha(Z))}if(mc=!0,s)for(const Z in s){const ne=s[Z],ce=Le(ne)?ne.bind(t,t):Le(ne.get)?ne.get.bind(t,t):Qr,we=!Le(ne)&&Le(ne.set)?ne.set.bind(t):Qr,Be=gr({get:ce,set:we});Object.defineProperty(r,Z,{enumerable:!0,configurable:!0,get:()=>Be.value,set:Q=>Be.value=Q})}if(a)for(const Z in a)ym(a[Z],r,t,Z);if(l){const Z=Le(l)?l.call(t):l;Reflect.ownKeys(Z).forEach(ne=>{Ha(ne,Z[ne])})}c&&Hh(c,i,"c");function re(Z,ne){Pe(ne)?ne.forEach(ce=>Z(ce.bind(t))):ne&&Z(ne.bind(t))}if(re(fb,d),re(pm,h),re(vb,g),re(gb,v),re(cb,m),re(db,E),re(_b,w),re(Sb,y),re(yb,C),re(pb,_),re(mm,b),re(mb,D),Pe(x))if(x.length){const Z=i.exposed||(i.exposed={});x.forEach(ne=>{Object.defineProperty(Z,ne,{get:()=>t[ne],set:ce=>t[ne]=ce})})}else i.exposed||(i.exposed={});I&&i.render===Qr&&(i.render=I),G!=null&&(i.inheritAttrs=G),oe&&(i.components=oe),de&&(i.directives=de),D&&fm(i)}function Tb(i,e,t=Qr){Pe(i)&&(i=yc(i));for(const r in i){const n=i[r];let s;it(n)?"default"in n?s=Mr(n.from||r,n.default,!0):s=Mr(n.from||r):s=Mr(n),pt(s)?Object.defineProperty(e,r,{enumerable:!0,configurable:!0,get:()=>s.value,set:o=>s.value=o}):e[r]=s}}function Hh(i,e,t){Zr(Pe(i)?i.map(r=>r.bind(e.proxy)):i.bind(e.proxy),e,t)}function ym(i,e,t,r){let n=r.includes(".")?Dm(t,r):()=>t[r];if(Et(i)){const s=e[i];Le(s)&&Mo(n,s)}else if(Le(i))Mo(n,i.bind(t));else if(it(i))if(Pe(i))i.forEach(s=>ym(s,e,t,r));else{const s=Le(i.handler)?i.handler.bind(t):e[i.handler];Le(s)&&Mo(n,s,i)}}function Sm(i){const e=i.type,{mixins:t,extends:r}=e,{mixins:n,optionsCache:s,config:{optionMergeStrategies:o}}=i.appContext,a=s.get(e);let l;return a?l=a:!n.length&&!t&&!r?l=e:(l={},n.length&&n.forEach(u=>hl(l,u,o,!0)),hl(l,e,o)),it(e)&&s.set(e,l),l}function hl(i,e,t,r=!1){const{mixins:n,extends:s}=e;s&&hl(i,s,t,!0),n&&n.forEach(o=>hl(i,o,t,!0));for(const o in e)if(!(r&&o==="expose")){const a=Ib[o]||t&&t[o];i[o]=a?a(i[o],e[o]):e[o]}return i}const Ib={data:$h,props:zh,emits:zh,methods:_o,computed:_o,beforeCreate:Vt,created:Vt,beforeMount:Vt,mounted:Vt,beforeUpdate:Vt,updated:Vt,beforeDestroy:Vt,beforeUnmount:Vt,destroyed:Vt,unmounted:Vt,activated:Vt,deactivated:Vt,errorCaptured:Vt,serverPrefetch:Vt,components:_o,directives:_o,watch:kb,provide:$h,inject:Cb};function $h(i,e){return e?i?function(){return jt(Le(i)?i.call(this,this):i,Le(e)?e.call(this,this):e)}:e:i}function Cb(i,e){return _o(yc(i),yc(e))}function yc(i){if(Pe(i)){const e={};for(let t=0;t<i.length;t++)e[i[t]]=i[t];return e}return i}function Vt(i,e){return i?[...new Set([].concat(i,e))]:e}function _o(i,e){return i?jt(Object.create(null),i,e):e}function zh(i,e){return i?Pe(i)&&Pe(e)?[...new Set([...i,...e])]:jt(Object.create(null),Gh(i),Gh(e??{})):e}function kb(i,e){if(!i)return e;if(!e)return i;const t=jt(Object.create(null),i);for(const r in e)t[r]=Vt(i[r],e[r]);return t}function _m(){return{app:null,config:{isNativeTag:m_,performance:!1,globalProperties:{},optionMergeStrategies:{},errorHandler:void 0,warnHandler:void 0,compilerOptions:{}},mixins:[],components:{},directives:{},provides:Object.create(null),optionsCache:new WeakMap,propsCache:new WeakMap,emitsCache:new WeakMap}}let Ob=0;function Pb(i,e){return function(r,n=null){Le(r)||(r=jt({},r)),n!=null&&!it(n)&&(n=null);const s=_m(),o=new WeakSet,a=[];let l=!1;const u=s.app={_uid:Ob++,_component:r,_props:n,_container:null,_context:s,_instance:null,version:hE,get config(){return s.config},set config(c){},use(c,...d){return o.has(c)||(c&&Le(c.install)?(o.add(c),c.install(u,...d)):Le(c)&&(o.add(c),c(u,...d))),u},mixin(c){return s.mixins.includes(c)||s.mixins.push(c),u},component(c,d){return d?(s.components[c]=d,u):s.components[c]},directive(c,d){return d?(s.directives[c]=d,u):s.directives[c]},mount(c,d,h){if(!l){const g=u._ceVNode||Jt(r,n);return g.appContext=s,h===!0?h="svg":h===!1&&(h=void 0),i(g,c,h),l=!0,u._container=c,c.__vue_app__=u,ql(g.component)}},onUnmount(c){a.push(c)},unmount(){l&&(Zr(a,u._instance,16),i(null,u._container),delete u._container.__vue_app__)},provide(c,d){return s.provides[c]=d,u},runWithContext(c){const d=Ai;Ai=u;try{return c()}finally{Ai=d}}};return u}}let Ai=null;function Ha(i,e){if(Bt){let t=Bt.provides;const r=Bt.parent&&Bt.parent.provides;r===t&&(t=Bt.provides=Object.create(r)),t[i]=e}}function Mr(i,e,t=!1){const r=Bt||pr;if(r||Ai){const n=Ai?Ai._context.provides:r?r.parent==null?r.vnode.appContext&&r.vnode.appContext.provides:r.parent.provides:void 0;if(n&&i in n)return n[i];if(arguments.length>1)return t&&Le(e)?e.call(r&&r.proxy):e}}function Mb(){return!!(Bt||pr||Ai)}const bm={},Em=()=>Object.create(bm),wm=i=>Object.getPrototypeOf(i)===bm;function Ab(i,e,t,r=!1){const n={},s=Em();i.propsDefaults=Object.create(null),Rm(i,e,n,s);for(const o in i.propsOptions[0])o in n||(n[o]=void 0);t?i.props=r?n:nm(n):i.type.props?i.props=n:i.props=s,i.attrs=s}function Db(i,e,t,r){const{props:n,attrs:s,vnode:{patchFlag:o}}=i,a=qe(n),[l]=i.propsOptions;let u=!1;if((r||o>0)&&!(o&16)){if(o&8){const c=i.vnode.dynamicProps;for(let d=0;d<c.length;d++){let h=c[d];if(Bl(i.emitsOptions,h))continue;const g=e[h];if(l)if(ze(s,h))g!==s[h]&&(s[h]=g,u=!0);else{const v=Yn(h);n[v]=Sc(l,a,v,g,i,!1)}else g!==s[h]&&(s[h]=g,u=!0)}}}else{Rm(i,e,n,s)&&(u=!0);let c;for(const d in a)(!e||!ze(e,d)&&((c=Fi(d))===d||!ze(e,c)))&&(l?t&&(t[d]!==void 0||t[c]!==void 0)&&(n[d]=Sc(l,a,d,void 0,i,!0)):delete n[d]);if(s!==a)for(const d in s)(!e||!ze(e,d))&&(delete s[d],u=!0)}u&&fn(i.attrs,"set","")}function Rm(i,e,t,r){const[n,s]=i.propsOptions;let o=!1,a;if(e)for(let l in e){if(To(l))continue;const u=e[l];let c;n&&ze(n,c=Yn(l))?!s||!s.includes(c)?t[c]=u:(a||(a={}))[c]=u:Bl(i.emitsOptions,l)||(!(l in r)||u!==r[l])&&(r[l]=u,o=!0)}if(s){const l=qe(t),u=a||Xe;for(let c=0;c<s.length;c++){const d=s[c];t[d]=Sc(n,l,d,u[d],i,!ze(u,d))}}return o}function Sc(i,e,t,r,n,s){const o=i[t];if(o!=null){const a=ze(o,"default");if(a&&r===void 0){const l=o.default;if(o.type!==Function&&!o.skipFactory&&Le(l)){const{propsDefaults:u}=n;if(t in u)r=u[t];else{const c=va(n);r=u[t]=l.call(null,e),c()}}else r=l;n.ce&&n.ce._setProp(t,r)}o[0]&&(s&&!a?r=!1:o[1]&&(r===""||r===Fi(t))&&(r=!0))}return r}const Ub=new WeakMap;function Tm(i,e,t=!1){const r=t?Ub:e.propsCache,n=r.get(i);if(n)return n;const s=i.props,o={},a=[];let l=!1;if(!Le(i)){const c=d=>{l=!0;const[h,g]=Tm(d,e,!0);jt(o,h),g&&a.push(...g)};!t&&e.mixins.length&&e.mixins.forEach(c),i.extends&&c(i.extends),i.mixins&&i.mixins.forEach(c)}if(!s&&!l)return it(i)&&r.set(i,is),is;if(Pe(s))for(let c=0;c<s.length;c++){const d=Yn(s[c]);Jh(d)&&(o[d]=Xe)}else if(s)for(const c in s){const d=Yn(c);if(Jh(d)){const h=s[c],g=o[d]=Pe(h)||Le(h)?{type:h}:jt({},h),v=g.type;let m=!1,E=!0;if(Pe(v))for(let R=0;R<v.length;++R){const _=v[R],T=Le(_)&&_.name;if(T==="Boolean"){m=!0;break}else T==="String"&&(E=!1)}else m=Le(v)&&v.name==="Boolean";g[0]=m,g[1]=E,(m||ze(g,"default"))&&a.push(d)}}const u=[o,a];return it(i)&&r.set(i,u),u}function Jh(i){return i[0]!=="$"&&!To(i)}const Im=i=>i[0]==="_"||i==="$stable",Yd=i=>Pe(i)?i.map(zr):[zr(i)],Lb=(i,e,t)=>{if(e._n)return e;const r=ab((...n)=>Yd(e(...n)),t);return r._c=!1,r},Cm=(i,e,t)=>{const r=i._ctx;for(const n in i){if(Im(n))continue;const s=i[n];if(Le(s))e[n]=Lb(n,s,r);else if(s!=null){const o=Yd(s);e[n]=()=>o}}},km=(i,e)=>{const t=Yd(e);i.slots.default=()=>t},Om=(i,e,t)=>{for(const r in e)(t||r!=="_")&&(i[r]=e[r])},Nb=(i,e,t)=>{const r=i.slots=Em();if(i.vnode.shapeFlag&32){const n=e._;n?(Om(r,e,t),t&&Np(r,"_",n,!0)):Cm(e,r)}else e&&km(i,e)},xb=(i,e,t)=>{const{vnode:r,slots:n}=i;let s=!0,o=Xe;if(r.shapeFlag&32){const a=e._;a?t&&a===1?s=!1:Om(n,e,t):(s=!e.$stable,Cm(e,n)),o=e}else e&&(km(i,e),o={default:1});if(s)for(const a in n)!Im(a)&&o[a]==null&&delete n[a]},cr=Qb;function Kb(i){return Fb(i)}function Fb(i,e){const t=Nl();t.__VUE__=!0;const{insert:r,remove:n,patchProp:s,createElement:o,createText:a,createComment:l,setText:u,setElementText:c,parentNode:d,nextSibling:h,setScopeId:g=Qr,insertStaticContent:v}=i,m=(k,O,U,V=null,q=null,J=null,te=void 0,$=null,ue=!!O.dynamicChildren)=>{if(k===O)return;k&&!Ls(k,O)&&(V=A(k),Q(k,q,J,!0),k=null),O.patchFlag===-2&&(ue=!1,O.dynamicChildren=null);const{type:ie,ref:Se,shapeFlag:Y}=O;switch(ie){case jl:E(k,O,U,V);break;case xi:R(k,O,U,V);break;case yu:k==null&&_(O,U,V,te);break;case $r:oe(k,O,U,V,q,J,te,$,ue);break;default:Y&1?I(k,O,U,V,q,J,te,$,ue):Y&6?de(k,O,U,V,q,J,te,$,ue):(Y&64||Y&128)&&ie.process(k,O,U,V,q,J,te,$,ue,P)}Se!=null&&q&&dl(Se,k&&k.ref,J,O||k,!O)},E=(k,O,U,V)=>{if(k==null)r(O.el=a(O.children),U,V);else{const q=O.el=k.el;O.children!==k.children&&u(q,O.children)}},R=(k,O,U,V)=>{k==null?r(O.el=l(O.children||""),U,V):O.el=k.el},_=(k,O,U,V)=>{[k.el,k.anchor]=v(k.children,O,U,V,k.el,k.anchor)},T=({el:k,anchor:O},U,V)=>{let q;for(;k&&k!==O;)q=h(k),r(k,U,V),k=q;r(O,U,V)},b=({el:k,anchor:O})=>{let U;for(;k&&k!==O;)U=h(k),n(k),k=U;n(O)},I=(k,O,U,V,q,J,te,$,ue)=>{O.type==="svg"?te="svg":O.type==="math"&&(te="mathml"),k==null?y(O,U,V,q,J,te,$,ue):D(k,O,q,J,te,$,ue)},y=(k,O,U,V,q,J,te,$)=>{let ue,ie;const{props:Se,shapeFlag:Y,transition:pe,dirs:Te}=k;if(ue=k.el=o(k.type,J,Se&&Se.is,Se),Y&8?c(ue,k.children):Y&16&&w(k.children,ue,null,V,q,mu(k,J),te,$),Te&&ai(k,null,V,"created"),C(ue,k,k.scopeId,te,V),Se){for(const je in Se)je!=="value"&&!To(je)&&s(ue,je,null,Se[je],J,V);"value"in Se&&s(ue,"value",null,Se.value,J),(ie=Se.onVnodeBeforeMount)&&xr(ie,V,k)}Te&&ai(k,null,V,"beforeMount");const Ne=Bb(q,pe);Ne&&pe.beforeEnter(ue),r(ue,O,U),((ie=Se&&Se.onVnodeMounted)||Ne||Te)&&cr(()=>{ie&&xr(ie,V,k),Ne&&pe.enter(ue),Te&&ai(k,null,V,"mounted")},q)},C=(k,O,U,V,q)=>{if(U&&g(k,U),V)for(let J=0;J<V.length;J++)g(k,V[J]);if(q){let J=q.subTree;if(O===J||Lm(J.type)&&(J.ssContent===O||J.ssFallback===O)){const te=q.vnode;C(k,te,te.scopeId,te.slotScopeIds,q.parent)}}},w=(k,O,U,V,q,J,te,$,ue=0)=>{for(let ie=ue;ie<k.length;ie++){const Se=k[ie]=$?Fn(k[ie]):zr(k[ie]);m(null,Se,O,U,V,q,J,te,$)}},D=(k,O,U,V,q,J,te)=>{const $=O.el=k.el;let{patchFlag:ue,dynamicChildren:ie,dirs:Se}=O;ue|=k.patchFlag&16;const Y=k.props||Xe,pe=O.props||Xe;let Te;if(U&&li(U,!1),(Te=pe.onVnodeBeforeUpdate)&&xr(Te,U,O,k),Se&&ai(O,k,U,"beforeUpdate"),U&&li(U,!0),(Y.innerHTML&&pe.innerHTML==null||Y.textContent&&pe.textContent==null)&&c($,""),ie?x(k.dynamicChildren,ie,$,U,V,mu(O,q),J):te||ne(k,O,$,null,U,V,mu(O,q),J,!1),ue>0){if(ue&16)G($,Y,pe,U,q);else if(ue&2&&Y.class!==pe.class&&s($,"class",null,pe.class,q),ue&4&&s($,"style",Y.style,pe.style,q),ue&8){const Ne=O.dynamicProps;for(let je=0;je<Ne.length;je++){const xe=Ne[je],yt=Y[xe],he=pe[xe];(he!==yt||xe==="value")&&s($,xe,yt,he,q,U)}}ue&1&&k.children!==O.children&&c($,O.children)}else!te&&ie==null&&G($,Y,pe,U,q);((Te=pe.onVnodeUpdated)||Se)&&cr(()=>{Te&&xr(Te,U,O,k),Se&&ai(O,k,U,"updated")},V)},x=(k,O,U,V,q,J,te)=>{for(let $=0;$<O.length;$++){const ue=k[$],ie=O[$],Se=ue.el&&(ue.type===$r||!Ls(ue,ie)||ue.shapeFlag&70)?d(ue.el):U;m(ue,ie,Se,null,V,q,J,te,!0)}},G=(k,O,U,V,q)=>{if(O!==U){if(O!==Xe)for(const J in O)!To(J)&&!(J in U)&&s(k,J,O[J],null,q,V);for(const J in U){if(To(J))continue;const te=U[J],$=O[J];te!==$&&J!=="value"&&s(k,J,$,te,q,V)}"value"in U&&s(k,"value",O.value,U.value,q)}},oe=(k,O,U,V,q,J,te,$,ue)=>{const ie=O.el=k?k.el:a(""),Se=O.anchor=k?k.anchor:a("");let{patchFlag:Y,dynamicChildren:pe,slotScopeIds:Te}=O;Te&&($=$?$.concat(Te):Te),k==null?(r(ie,U,V),r(Se,U,V),w(O.children||[],U,Se,q,J,te,$,ue)):Y>0&&Y&64&&pe&&k.dynamicChildren?(x(k.dynamicChildren,pe,U,q,J,te,$),(O.key!=null||q&&O===q.subTree)&&Pm(k,O,!0)):ne(k,O,U,Se,q,J,te,$,ue)},de=(k,O,U,V,q,J,te,$,ue)=>{O.slotScopeIds=$,k==null?O.shapeFlag&512?q.ctx.activate(O,U,V,te,ue):Ee(O,U,V,q,J,te,ue):X(k,O,ue)},Ee=(k,O,U,V,q,J,te)=>{const $=k.component=oE(k,V,q);if(vm(k)&&($.ctx.renderer=P),aE($,!1,te),$.asyncDep){if(q&&q.registerDep($,re,te),!k.el){const ue=$.subTree=Jt(xi);R(null,ue,O,U)}}else re($,k,O,U,q,J,te)},X=(k,O,U)=>{const V=O.component=k.component;if(Jb(k,O,U))if(V.asyncDep&&!V.asyncResolved){Z(V,O,U);return}else V.next=O,V.update();else O.el=k.el,V.vnode=O},re=(k,O,U,V,q,J,te)=>{const $=()=>{if(k.isMounted){let{next:Y,bu:pe,u:Te,parent:Ne,vnode:je}=k;{const W=Mm(k);if(W){Y&&(Y.el=je.el,Z(k,Y,te)),W.asyncDep.then(()=>{k.isUnmounted||$()});return}}let xe=Y,yt;li(k,!1),Y?(Y.el=je.el,Z(k,Y,te)):Y=je,pe&&Ga(pe),(yt=Y.props&&Y.props.onVnodeBeforeUpdate)&&xr(yt,Ne,Y,je),li(k,!0);const he=Qh(k),ae=k.subTree;k.subTree=he,m(ae,he,d(ae.el),A(ae),k,q,J),Y.el=he.el,xe===null&&Yb(k,he.el),Te&&cr(Te,q),(yt=Y.props&&Y.props.onVnodeUpdated)&&cr(()=>xr(yt,Ne,Y,je),q)}else{let Y;const{el:pe,props:Te}=O,{bm:Ne,m:je,parent:xe,root:yt,type:he}=k,ae=Oo(O);li(k,!1),Ne&&Ga(Ne),!ae&&(Y=Te&&Te.onVnodeBeforeMount)&&xr(Y,xe,O),li(k,!0);{yt.ce&&yt.ce._injectChildStyle(he);const W=k.subTree=Qh(k);m(null,W,U,V,k,q,J),O.el=W.el}if(je&&cr(je,q),!ae&&(Y=Te&&Te.onVnodeMounted)){const W=O;cr(()=>xr(Y,xe,W),q)}(O.shapeFlag&256||xe&&Oo(xe.vnode)&&xe.vnode.shapeFlag&256)&&k.a&&cr(k.a,q),k.isMounted=!0,O=U=V=null}};k.scope.on();const ue=k.effect=new Vp($);k.scope.off();const ie=k.update=ue.run.bind(ue),Se=k.job=ue.runIfDirty.bind(ue);Se.i=k,Se.id=k.uid,ue.scheduler=()=>zd(Se),li(k,!0),ie()},Z=(k,O,U)=>{O.component=k;const V=k.vnode.props;k.vnode=O,k.next=null,Db(k,O.props,V,U),xb(k,O.children,U),ei(),Wh(k),ti()},ne=(k,O,U,V,q,J,te,$,ue=!1)=>{const ie=k&&k.children,Se=k?k.shapeFlag:0,Y=O.children,{patchFlag:pe,shapeFlag:Te}=O;if(pe>0){if(pe&128){we(ie,Y,U,V,q,J,te,$,ue);return}else if(pe&256){ce(ie,Y,U,V,q,J,te,$,ue);return}}Te&8?(Se&16&&N(ie,q,J),Y!==ie&&c(U,Y)):Se&16?Te&16?we(ie,Y,U,V,q,J,te,$,ue):N(ie,q,J,!0):(Se&8&&c(U,""),Te&16&&w(Y,U,V,q,J,te,$,ue))},ce=(k,O,U,V,q,J,te,$,ue)=>{k=k||is,O=O||is;const ie=k.length,Se=O.length,Y=Math.min(ie,Se);let pe;for(pe=0;pe<Y;pe++){const Te=O[pe]=ue?Fn(O[pe]):zr(O[pe]);m(k[pe],Te,U,null,q,J,te,$,ue)}ie>Se?N(k,q,J,!0,!1,Y):w(O,U,V,q,J,te,$,ue,Y)},we=(k,O,U,V,q,J,te,$,ue)=>{let ie=0;const Se=O.length;let Y=k.length-1,pe=Se-1;for(;ie<=Y&&ie<=pe;){const Te=k[ie],Ne=O[ie]=ue?Fn(O[ie]):zr(O[ie]);if(Ls(Te,Ne))m(Te,Ne,U,null,q,J,te,$,ue);else break;ie++}for(;ie<=Y&&ie<=pe;){const Te=k[Y],Ne=O[pe]=ue?Fn(O[pe]):zr(O[pe]);if(Ls(Te,Ne))m(Te,Ne,U,null,q,J,te,$,ue);else break;Y--,pe--}if(ie>Y){if(ie<=pe){const Te=pe+1,Ne=Te<Se?O[Te].el:V;for(;ie<=pe;)m(null,O[ie]=ue?Fn(O[ie]):zr(O[ie]),U,Ne,q,J,te,$,ue),ie++}}else if(ie>pe)for(;ie<=Y;)Q(k[ie],q,J,!0),ie++;else{const Te=ie,Ne=ie,je=new Map;for(ie=Ne;ie<=pe;ie++){const se=O[ie]=ue?Fn(O[ie]):zr(O[ie]);se.key!=null&&je.set(se.key,ie)}let xe,yt=0;const he=pe-Ne+1;let ae=!1,W=0;const H=new Array(he);for(ie=0;ie<he;ie++)H[ie]=0;for(ie=Te;ie<=Y;ie++){const se=k[ie];if(yt>=he){Q(se,q,J,!0);continue}let ge;if(se.key!=null)ge=je.get(se.key);else for(xe=Ne;xe<=pe;xe++)if(H[xe-Ne]===0&&Ls(se,O[xe])){ge=xe;break}ge===void 0?Q(se,q,J,!0):(H[ge-Ne]=ie+1,ge>=W?W=ge:ae=!0,m(se,O[ge],U,null,q,J,te,$,ue),yt++)}const ee=ae?jb(H):is;for(xe=ee.length-1,ie=he-1;ie>=0;ie--){const se=Ne+ie,ge=O[se],be=se+1<Se?O[se+1].el:V;H[ie]===0?m(null,ge,U,be,q,J,te,$,ue):ae&&(xe<0||ie!==ee[xe]?Be(ge,U,be,2):xe--)}}},Be=(k,O,U,V,q=null)=>{const{el:J,type:te,transition:$,children:ue,shapeFlag:ie}=k;if(ie&6){Be(k.component.subTree,O,U,V);return}if(ie&128){k.suspense.move(O,U,V);return}if(ie&64){te.move(k,O,U,P);return}if(te===$r){r(J,O,U);for(let Y=0;Y<ue.length;Y++)Be(ue[Y],O,U,V);r(k.anchor,O,U);return}if(te===yu){T(k,O,U);return}if(V!==2&&ie&1&&$)if(V===0)$.beforeEnter(J),r(J,O,U),cr(()=>$.enter(J),q);else{const{leave:Y,delayLeave:pe,afterLeave:Te}=$,Ne=()=>r(J,O,U),je=()=>{Y(J,()=>{Ne(),Te&&Te()})};pe?pe(J,Ne,je):je()}else r(J,O,U)},Q=(k,O,U,V=!1,q=!1)=>{const{type:J,props:te,ref:$,children:ue,dynamicChildren:ie,shapeFlag:Se,patchFlag:Y,dirs:pe,cacheIndex:Te}=k;if(Y===-2&&(q=!1),$!=null&&dl($,null,U,k,!0),Te!=null&&(O.renderCache[Te]=void 0),Se&256){O.ctx.deactivate(k);return}const Ne=Se&1&&pe,je=!Oo(k);let xe;if(je&&(xe=te&&te.onVnodeBeforeUnmount)&&xr(xe,O,k),Se&6)K(k.component,U,V);else{if(Se&128){k.suspense.unmount(U,V);return}Ne&&ai(k,null,O,"beforeUnmount"),Se&64?k.type.remove(k,O,U,P,V):ie&&!ie.hasOnce&&(J!==$r||Y>0&&Y&64)?N(ie,O,U,!1,!0):(J===$r&&Y&384||!q&&Se&16)&&N(ue,O,U),V&&le(k)}(je&&(xe=te&&te.onVnodeUnmounted)||Ne)&&cr(()=>{xe&&xr(xe,O,k),Ne&&ai(k,null,O,"unmounted")},U)},le=k=>{const{type:O,el:U,anchor:V,transition:q}=k;if(O===$r){j(U,V);return}if(O===yu){b(k);return}const J=()=>{n(U),q&&!q.persisted&&q.afterLeave&&q.afterLeave()};if(k.shapeFlag&1&&q&&!q.persisted){const{leave:te,delayLeave:$}=q,ue=()=>te(U,J);$?$(k.el,J,ue):ue()}else J()},j=(k,O)=>{let U;for(;k!==O;)U=h(k),n(k),k=U;n(O)},K=(k,O,U)=>{const{bum:V,scope:q,job:J,subTree:te,um:$,m:ue,a:ie}=k;Yh(ue),Yh(ie),V&&Ga(V),q.stop(),J&&(J.flags|=8,Q(te,k,O,U)),$&&cr($,O),cr(()=>{k.isUnmounted=!0},O),O&&O.pendingBranch&&!O.isUnmounted&&k.asyncDep&&!k.asyncResolved&&k.suspenseId===O.pendingId&&(O.deps--,O.deps===0&&O.resolve())},N=(k,O,U,V=!1,q=!1,J=0)=>{for(let te=J;te<k.length;te++)Q(k[te],O,U,V,q)},A=k=>{if(k.shapeFlag&6)return A(k.component.subTree);if(k.shapeFlag&128)return k.suspense.next();const O=h(k.anchor||k.el),U=O&&O[lb];return U?h(U):O};let M=!1;const L=(k,O,U)=>{k==null?O._vnode&&Q(O._vnode,null,null,!0):m(O._vnode||null,k,O,null,null,null,U),O._vnode=k,M||(M=!0,Wh(),um(),M=!1)},P={p:m,um:Q,m:Be,r:le,mt:Ee,mc:w,pc:ne,pbc:x,n:A,o:i};return{render:L,hydrate:void 0,createApp:Pb(L)}}function mu({type:i,props:e},t){return t==="svg"&&i==="foreignObject"||t==="mathml"&&i==="annotation-xml"&&e&&e.encoding&&e.encoding.includes("html")?void 0:t}function li({effect:i,job:e},t){t?(i.flags|=32,e.flags|=4):(i.flags&=-33,e.flags&=-5)}function Bb(i,e){return(!i||i&&!i.pendingBranch)&&e&&!e.persisted}function Pm(i,e,t=!1){const r=i.children,n=e.children;if(Pe(r)&&Pe(n))for(let s=0;s<r.length;s++){const o=r[s];let a=n[s];a.shapeFlag&1&&!a.dynamicChildren&&((a.patchFlag<=0||a.patchFlag===32)&&(a=n[s]=Fn(n[s]),a.el=o.el),!t&&a.patchFlag!==-2&&Pm(o,a)),a.type===jl&&(a.el=o.el)}}function jb(i){const e=i.slice(),t=[0];let r,n,s,o,a;const l=i.length;for(r=0;r<l;r++){const u=i[r];if(u!==0){if(n=t[t.length-1],i[n]<u){e[r]=n,t.push(r);continue}for(s=0,o=t.length-1;s<o;)a=s+o>>1,i[t[a]]<u?s=a+1:o=a;u<i[t[s]]&&(s>0&&(e[r]=t[s-1]),t[s]=r)}}for(s=t.length,o=t[s-1];s-- >0;)t[s]=o,o=e[o];return t}function Mm(i){const e=i.subTree.component;if(e)return e.asyncDep&&!e.asyncResolved?e:Mm(e)}function Yh(i){if(i)for(let e=0;e<i.length;e++)i[e].flags|=8}const qb=Symbol.for("v-scx"),Vb=()=>Mr(qb);function Mo(i,e,t){return Am(i,e,t)}function Am(i,e,t=Xe){const{immediate:r,deep:n,flush:s,once:o}=t,a=jt({},t),l=e&&r||!e&&s!=="post";let u;if(zo){if(s==="sync"){const g=Vb();u=g.__watcherHandles||(g.__watcherHandles=[])}else if(!l){const g=()=>{};return g.stop=Qr,g.resume=Qr,g.pause=Qr,g}}const c=Bt;a.call=(g,v,m)=>Zr(g,c,v,m);let d=!1;s==="post"?a.scheduler=g=>{cr(g,c&&c.suspense)}:s!=="sync"&&(d=!0,a.scheduler=(g,v)=>{v?g():zd(g)}),a.augmentJob=g=>{e&&(g.flags|=4),d&&(g.flags|=2,c&&(g.id=c.uid,g.i=c))};const h=nb(i,e,a);return zo&&(u?u.push(h):l&&h()),h}function Wb(i,e,t){const r=this.proxy,n=Et(i)?i.includes(".")?Dm(r,i):()=>r[i]:i.bind(r,r);let s;Le(e)?s=e:(s=e.handler,t=e);const o=va(this),a=Am(n,s.bind(r),t);return o(),a}function Dm(i,e){const t=e.split(".");return()=>{let r=i;for(let n=0;n<t.length&&r;n++)r=r[t[n]];return r}}const Gb=(i,e)=>e==="modelValue"||e==="model-value"?i.modelModifiers:i[`${e}Modifiers`]||i[`${Yn(e)}Modifiers`]||i[`${Fi(e)}Modifiers`];function Hb(i,e,...t){if(i.isUnmounted)return;const r=i.vnode.props||Xe;let n=t;const s=e.startsWith("update:"),o=s&&Gb(r,e.slice(7));o&&(o.trim&&(n=t.map(c=>Et(c)?c.trim():c)),o.number&&(n=t.map(dc)));let a,l=r[a=cu(e)]||r[a=cu(Yn(e))];!l&&s&&(l=r[a=cu(Fi(e))]),l&&Zr(l,i,6,n);const u=r[a+"Once"];if(u){if(!i.emitted)i.emitted={};else if(i.emitted[a])return;i.emitted[a]=!0,Zr(u,i,6,n)}}function Um(i,e,t=!1){const r=e.emitsCache,n=r.get(i);if(n!==void 0)return n;const s=i.emits;let o={},a=!1;if(!Le(i)){const l=u=>{const c=Um(u,e,!0);c&&(a=!0,jt(o,c))};!t&&e.mixins.length&&e.mixins.forEach(l),i.extends&&l(i.extends),i.mixins&&i.mixins.forEach(l)}return!s&&!a?(it(i)&&r.set(i,null),null):(Pe(s)?s.forEach(l=>o[l]=null):jt(o,s),it(i)&&r.set(i,o),o)}function Bl(i,e){return!i||!Dl(e)?!1:(e=e.slice(2).replace(/Once$/,""),ze(i,e[0].toLowerCase()+e.slice(1))||ze(i,Fi(e))||ze(i,e))}function Qh(i){const{type:e,vnode:t,proxy:r,withProxy:n,propsOptions:[s],slots:o,attrs:a,emit:l,render:u,renderCache:c,props:d,data:h,setupState:g,ctx:v,inheritAttrs:m}=i,E=cl(i);let R,_;try{if(t.shapeFlag&4){const b=n||r,I=b;R=zr(u.call(I,b,c,d,g,h,v)),_=a}else{const b=e;R=zr(b.length>1?b(d,{attrs:a,slots:o,emit:l}):b(d,null)),_=e.props?a:$b(a)}}catch(b){Ao.length=0,Kl(b,i,1),R=Jt(xi)}let T=R;if(_&&m!==!1){const b=Object.keys(_),{shapeFlag:I}=T;b.length&&I&7&&(s&&b.some(Ud)&&(_=zb(_,s)),T=ps(T,_,!1,!0))}return t.dirs&&(T=ps(T,null,!1,!0),T.dirs=T.dirs?T.dirs.concat(t.dirs):t.dirs),t.transition&&Jd(T,t.transition),R=T,cl(E),R}const $b=i=>{let e;for(const t in i)(t==="class"||t==="style"||Dl(t))&&((e||(e={}))[t]=i[t]);return e},zb=(i,e)=>{const t={};for(const r in i)(!Ud(r)||!(r.slice(9)in e))&&(t[r]=i[r]);return t};function Jb(i,e,t){const{props:r,children:n,component:s}=i,{props:o,children:a,patchFlag:l}=e,u=s.emitsOptions;if(e.dirs||e.transition)return!0;if(t&&l>=0){if(l&1024)return!0;if(l&16)return r?Xh(r,o,u):!!o;if(l&8){const c=e.dynamicProps;for(let d=0;d<c.length;d++){const h=c[d];if(o[h]!==r[h]&&!Bl(u,h))return!0}}}else return(n||a)&&(!a||!a.$stable)?!0:r===o?!1:r?o?Xh(r,o,u):!0:!!o;return!1}function Xh(i,e,t){const r=Object.keys(e);if(r.length!==Object.keys(i).length)return!0;for(let n=0;n<r.length;n++){const s=r[n];if(e[s]!==i[s]&&!Bl(t,s))return!0}return!1}function Yb({vnode:i,parent:e},t){for(;e;){const r=e.subTree;if(r.suspense&&r.suspense.activeBranch===i&&(r.el=i.el),r===i)(i=e.vnode).el=t,e=e.parent;else break}}const Lm=i=>i.__isSuspense;function Qb(i,e){e&&e.pendingBranch?Pe(i)?e.effects.push(...i):e.effects.push(i):ob(i)}const $r=Symbol.for("v-fgt"),jl=Symbol.for("v-txt"),xi=Symbol.for("v-cmt"),yu=Symbol.for("v-stc"),Ao=[];let mr=null;function Yr(i=!1){Ao.push(mr=i?null:[])}function Xb(){Ao.pop(),mr=Ao[Ao.length-1]||null}let $o=1;function Zh(i,e=!1){$o+=i,i<0&&mr&&e&&(mr.hasOnce=!0)}function Nm(i){return i.dynamicChildren=$o>0?mr||is:null,Xb(),$o>0&&mr&&mr.push(i),i}function gn(i,e,t,r,n,s){return Nm(Ft(i,e,t,r,n,s,!0))}function Zb(i,e,t,r,n){return Nm(Jt(i,e,t,r,n,!0))}function fl(i){return i?i.__v_isVNode===!0:!1}function Ls(i,e){return i.type===e.type&&i.key===e.key}const xm=({key:i})=>i??null,$a=({ref:i,ref_key:e,ref_for:t})=>(typeof i=="number"&&(i=""+i),i!=null?Et(i)||pt(i)||Le(i)?{i:pr,r:i,k:e,f:!!t}:i:null);function Ft(i,e=null,t=null,r=0,n=null,s=i===$r?0:1,o=!1,a=!1){const l={__v_isVNode:!0,__v_skip:!0,type:i,props:e,key:e&&xm(e),ref:e&&$a(e),scopeId:dm,slotScopeIds:null,children:t,component:null,suspense:null,ssContent:null,ssFallback:null,dirs:null,transition:null,el:null,anchor:null,target:null,targetStart:null,targetAnchor:null,staticCount:0,shapeFlag:s,patchFlag:r,dynamicProps:n,dynamicChildren:null,appContext:null,ctx:pr};return a?(Qd(l,t),s&128&&i.normalize(l)):t&&(l.shapeFlag|=Et(t)?8:16),$o>0&&!o&&mr&&(l.patchFlag>0||s&6)&&l.patchFlag!==32&&mr.push(l),l}const Jt=eE;function eE(i,e=null,t=null,r=0,n=null,s=!1){if((!i||i===bb)&&(i=xi),fl(i)){const a=ps(i,e,!0);return t&&Qd(a,t),$o>0&&!s&&mr&&(a.shapeFlag&6?mr[mr.indexOf(i)]=a:mr.push(a)),a.patchFlag=-2,a}if(dE(i)&&(i=i.__vccOpts),e){e=tE(e);let{class:a,style:l}=e;a&&!Et(a)&&(e.class=Kd(a)),it(l)&&(Gd(l)&&!Pe(l)&&(l=jt({},l)),e.style=xd(l))}const o=Et(i)?1:Lm(i)?128:ub(i)?64:it(i)?4:Le(i)?2:0;return Ft(i,e,t,r,n,o,s,!0)}function tE(i){return i?Gd(i)||wm(i)?jt({},i):i:null}function ps(i,e,t=!1,r=!1){const{props:n,ref:s,patchFlag:o,children:a,transition:l}=i,u=e?nE(n||{},e):n,c={__v_isVNode:!0,__v_skip:!0,type:i.type,props:u,key:u&&xm(u),ref:e&&e.ref?t&&s?Pe(s)?s.concat($a(e)):[s,$a(e)]:$a(e):s,scopeId:i.scopeId,slotScopeIds:i.slotScopeIds,children:a,target:i.target,targetStart:i.targetStart,targetAnchor:i.targetAnchor,staticCount:i.staticCount,shapeFlag:i.shapeFlag,patchFlag:e&&i.type!==$r?o===-1?16:o|16:o,dynamicProps:i.dynamicProps,dynamicChildren:i.dynamicChildren,appContext:i.appContext,dirs:i.dirs,transition:l,component:i.component,suspense:i.suspense,ssContent:i.ssContent&&ps(i.ssContent),ssFallback:i.ssFallback&&ps(i.ssFallback),el:i.el,anchor:i.anchor,ctx:i.ctx,ce:i.ce};return l&&r&&Jd(c,l.clone(c)),c}function rE(i=" ",e=0){return Jt(jl,null,i,e)}function _c(i="",e=!1){return e?(Yr(),Zb(xi,null,i)):Jt(xi,null,i)}function zr(i){return i==null||typeof i=="boolean"?Jt(xi):Pe(i)?Jt($r,null,i.slice()):fl(i)?Fn(i):Jt(jl,null,String(i))}function Fn(i){return i.el===null&&i.patchFlag!==-1||i.memo?i:ps(i)}function Qd(i,e){let t=0;const{shapeFlag:r}=i;if(e==null)e=null;else if(Pe(e))t=16;else if(typeof e=="object")if(r&65){const n=e.default;n&&(n._c&&(n._d=!1),Qd(i,n()),n._c&&(n._d=!0));return}else{t=32;const n=e._;!n&&!wm(e)?e._ctx=pr:n===3&&pr&&(pr.slots._===1?e._=1:(e._=2,i.patchFlag|=1024))}else Le(e)?(e={default:e,_ctx:pr},t=32):(e=String(e),r&64?(t=16,e=[rE(e)]):t=8);i.children=e,i.shapeFlag|=t}function nE(...i){const e={};for(let t=0;t<i.length;t++){const r=i[t];for(const n in r)if(n==="class")e.class!==r.class&&(e.class=Kd([e.class,r.class]));else if(n==="style")e.style=xd([e.style,r.style]);else if(Dl(n)){const s=e[n],o=r[n];o&&s!==o&&!(Pe(s)&&s.includes(o))&&(e[n]=s?[].concat(s,o):o)}else n!==""&&(e[n]=r[n])}return e}function xr(i,e,t,r=null){Zr(i,e,7,[t,r])}const iE=_m();let sE=0;function oE(i,e,t){const r=i.type,n=(e?e.appContext:i.appContext)||iE,s={uid:sE++,vnode:i,type:r,parent:e,appContext:n,root:null,next:null,subTree:null,effect:null,update:null,job:null,scope:new Bp(!0),render:null,proxy:null,exposed:null,exposeProxy:null,withProxy:null,provides:e?e.provides:Object.create(n.provides),ids:e?e.ids:["",0,0],accessCache:null,renderCache:[],components:null,directives:null,propsOptions:Tm(r,n),emitsOptions:Um(r,n),emit:null,emitted:null,propsDefaults:Xe,inheritAttrs:r.inheritAttrs,ctx:Xe,data:Xe,props:Xe,attrs:Xe,slots:Xe,refs:Xe,setupState:Xe,setupContext:null,suspense:t,suspenseId:t?t.pendingId:0,asyncDep:null,asyncResolved:!1,isMounted:!1,isUnmounted:!1,isDeactivated:!1,bc:null,c:null,bm:null,m:null,bu:null,u:null,um:null,bum:null,da:null,a:null,rtg:null,rtc:null,ec:null,sp:null};return s.ctx={_:s},s.root=e?e.root:s,s.emit=Hb.bind(null,s),i.ce&&i.ce(s),s}let Bt=null,vl,bc;{const i=Nl(),e=(t,r)=>{let n;return(n=i[t])||(n=i[t]=[]),n.push(r),s=>{n.length>1?n.forEach(o=>o(s)):n[0](s)}};vl=e("__VUE_INSTANCE_SETTERS__",t=>Bt=t),bc=e("__VUE_SSR_SETTERS__",t=>zo=t)}const va=i=>{const e=Bt;return vl(i),i.scope.on(),()=>{i.scope.off(),vl(e)}},ef=()=>{Bt&&Bt.scope.off(),vl(null)};function Km(i){return i.vnode.shapeFlag&4}let zo=!1;function aE(i,e=!1,t=!1){e&&bc(e);const{props:r,children:n}=i.vnode,s=Km(i);Ab(i,r,s,e),Nb(i,n,t);const o=s?lE(i,e):void 0;return e&&bc(!1),o}function lE(i,e){const t=i.type;i.accessCache=Object.create(null),i.proxy=new Proxy(i.ctx,wb);const{setup:r}=t;if(r){ei();const n=i.setupContext=r.length>1?cE(i):null,s=va(i),o=fa(r,i,0,[i.props,n]),a=Ap(o);if(ti(),s(),(a||i.sp)&&!Oo(i)&&fm(i),a){if(o.then(ef,ef),e)return o.then(l=>{tf(i,l)}).catch(l=>{Kl(l,i,0)});i.asyncDep=o}else tf(i,o)}else Fm(i)}function tf(i,e,t){Le(e)?i.type.__ssrInlineRender?i.ssrRender=e:i.render=e:it(e)&&(i.setupState=om(e)),Fm(i)}function Fm(i,e,t){const r=i.type;i.render||(i.render=r.render||Qr);{const n=va(i);ei();try{Rb(i)}finally{ti(),n()}}}const uE={get(i,e){return Nt(i,"get",""),i[e]}};function cE(i){const e=t=>{i.exposed=t||{}};return{attrs:new Proxy(i.attrs,uE),slots:i.slots,emit:i.emit,expose:e}}function ql(i){return i.exposed?i.exposeProxy||(i.exposeProxy=new Proxy(om(Hd(i.exposed)),{get(e,t){if(t in e)return e[t];if(t in Po)return Po[t](i)},has(e,t){return t in e||t in Po}})):i.proxy}function dE(i){return Le(i)&&"__vccOpts"in i}const gr=(i,e)=>tb(i,e,zo);function Bm(i,e,t){const r=arguments.length;return r===2?it(e)&&!Pe(e)?fl(e)?Jt(i,null,[e]):Jt(i,e):Jt(i,null,e):(r>3?t=Array.prototype.slice.call(arguments,2):r===3&&fl(t)&&(t=[t]),Jt(i,e,t))}const hE="3.5.13";/**
* @vue/runtime-dom v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let Ec;const rf=typeof window<"u"&&window.trustedTypes;if(rf)try{Ec=rf.createPolicy("vue",{createHTML:i=>i})}catch{}const jm=Ec?i=>Ec.createHTML(i):i=>i,fE="http://www.w3.org/2000/svg",vE="http://www.w3.org/1998/Math/MathML",cn=typeof document<"u"?document:null,nf=cn&&cn.createElement("template"),gE={insert:(i,e,t)=>{e.insertBefore(i,t||null)},remove:i=>{const e=i.parentNode;e&&e.removeChild(i)},createElement:(i,e,t,r)=>{const n=e==="svg"?cn.createElementNS(fE,i):e==="mathml"?cn.createElementNS(vE,i):t?cn.createElement(i,{is:t}):cn.createElement(i);return i==="select"&&r&&r.multiple!=null&&n.setAttribute("multiple",r.multiple),n},createText:i=>cn.createTextNode(i),createComment:i=>cn.createComment(i),setText:(i,e)=>{i.nodeValue=e},setElementText:(i,e)=>{i.textContent=e},parentNode:i=>i.parentNode,nextSibling:i=>i.nextSibling,querySelector:i=>cn.querySelector(i),setScopeId(i,e){i.setAttribute(e,"")},insertStaticContent(i,e,t,r,n,s){const o=t?t.previousSibling:e.lastChild;if(n&&(n===s||n.nextSibling))for(;e.insertBefore(n.cloneNode(!0),t),!(n===s||!(n=n.nextSibling)););else{nf.innerHTML=jm(r==="svg"?`<svg>${i}</svg>`:r==="mathml"?`<math>${i}</math>`:i);const a=nf.content;if(r==="svg"||r==="mathml"){const l=a.firstChild;for(;l.firstChild;)a.appendChild(l.firstChild);a.removeChild(l)}e.insertBefore(a,t)}return[o?o.nextSibling:e.firstChild,t?t.previousSibling:e.lastChild]}},pE=Symbol("_vtc");function mE(i,e,t){const r=i[pE];r&&(e=(e?[e,...r]:[...r]).join(" ")),e==null?i.removeAttribute("class"):t?i.setAttribute("class",e):i.className=e}const sf=Symbol("_vod"),yE=Symbol("_vsh"),SE=Symbol(""),_E=/(^|;)\s*display\s*:/;function bE(i,e,t){const r=i.style,n=Et(t);let s=!1;if(t&&!n){if(e)if(Et(e))for(const o of e.split(";")){const a=o.slice(0,o.indexOf(":")).trim();t[a]==null&&za(r,a,"")}else for(const o in e)t[o]==null&&za(r,o,"");for(const o in t)o==="display"&&(s=!0),za(r,o,t[o])}else if(n){if(e!==t){const o=r[SE];o&&(t+=";"+o),r.cssText=t,s=_E.test(t)}}else e&&i.removeAttribute("style");sf in i&&(i[sf]=s?r.display:"",i[yE]&&(r.display="none"))}const of=/\s*!important$/;function za(i,e,t){if(Pe(t))t.forEach(r=>za(i,e,r));else if(t==null&&(t=""),e.startsWith("--"))i.setProperty(e,t);else{const r=EE(i,e);of.test(t)?i.setProperty(Fi(r),t.replace(of,""),"important"):i[r]=t}}const af=["Webkit","Moz","ms"],Su={};function EE(i,e){const t=Su[e];if(t)return t;let r=Yn(e);if(r!=="filter"&&r in i)return Su[e]=r;r=Lp(r);for(let n=0;n<af.length;n++){const s=af[n]+r;if(s in i)return Su[e]=s}return e}const lf="http://www.w3.org/1999/xlink";function uf(i,e,t,r,n,s=C_(e)){r&&e.startsWith("xlink:")?t==null?i.removeAttributeNS(lf,e.slice(6,e.length)):i.setAttributeNS(lf,e,t):t==null||s&&!xp(t)?i.removeAttribute(e):i.setAttribute(e,s?"":Zn(t)?String(t):t)}function cf(i,e,t,r,n){if(e==="innerHTML"||e==="textContent"){t!=null&&(i[e]=e==="innerHTML"?jm(t):t);return}const s=i.tagName;if(e==="value"&&s!=="PROGRESS"&&!s.includes("-")){const a=s==="OPTION"?i.getAttribute("value")||"":i.value,l=t==null?i.type==="checkbox"?"on":"":String(t);(a!==l||!("_value"in i))&&(i.value=l),t==null&&i.removeAttribute(e),i._value=t;return}let o=!1;if(t===""||t==null){const a=typeof i[e];a==="boolean"?t=xp(t):t==null&&a==="string"?(t="",o=!0):a==="number"&&(t=0,o=!0)}try{i[e]=t}catch{}o&&i.removeAttribute(n||e)}function Qi(i,e,t,r){i.addEventListener(e,t,r)}function wE(i,e,t,r){i.removeEventListener(e,t,r)}const df=Symbol("_vei");function RE(i,e,t,r,n=null){const s=i[df]||(i[df]={}),o=s[e];if(r&&o)o.value=r;else{const[a,l]=TE(e);if(r){const u=s[e]=kE(r,n);Qi(i,a,u,l)}else o&&(wE(i,a,o,l),s[e]=void 0)}}const hf=/(?:Once|Passive|Capture)$/;function TE(i){let e;if(hf.test(i)){e={};let r;for(;r=i.match(hf);)i=i.slice(0,i.length-r[0].length),e[r[0].toLowerCase()]=!0}return[i[2]===":"?i.slice(3):Fi(i.slice(2)),e]}let _u=0;const IE=Promise.resolve(),CE=()=>_u||(IE.then(()=>_u=0),_u=Date.now());function kE(i,e){const t=r=>{if(!r._vts)r._vts=Date.now();else if(r._vts<=t.attached)return;Zr(OE(r,t.value),e,5,[r])};return t.value=i,t.attached=CE(),t}function OE(i,e){if(Pe(e)){const t=i.stopImmediatePropagation;return i.stopImmediatePropagation=()=>{t.call(i),i._stopped=!0},e.map(r=>n=>!n._stopped&&r&&r(n))}else return e}const ff=i=>i.charCodeAt(0)===111&&i.charCodeAt(1)===110&&i.charCodeAt(2)>96&&i.charCodeAt(2)<123,PE=(i,e,t,r,n,s)=>{const o=n==="svg";e==="class"?mE(i,r,o):e==="style"?bE(i,t,r):Dl(e)?Ud(e)||RE(i,e,t,r,s):(e[0]==="."?(e=e.slice(1),!0):e[0]==="^"?(e=e.slice(1),!1):ME(i,e,r,o))?(cf(i,e,r),!i.tagName.includes("-")&&(e==="value"||e==="checked"||e==="selected")&&uf(i,e,r,o,s,e!=="value")):i._isVueCE&&(/[A-Z]/.test(e)||!Et(r))?cf(i,Yn(e),r,s,e):(e==="true-value"?i._trueValue=r:e==="false-value"&&(i._falseValue=r),uf(i,e,r,o))};function ME(i,e,t,r){if(r)return!!(e==="innerHTML"||e==="textContent"||e in i&&ff(e)&&Le(t));if(e==="spellcheck"||e==="draggable"||e==="translate"||e==="form"||e==="list"&&i.tagName==="INPUT"||e==="type"&&i.tagName==="TEXTAREA")return!1;if(e==="width"||e==="height"){const n=i.tagName;if(n==="IMG"||n==="VIDEO"||n==="CANVAS"||n==="SOURCE")return!1}return ff(e)&&Et(t)?!1:e in i}const vf=i=>{const e=i.props["onUpdate:modelValue"]||!1;return Pe(e)?t=>Ga(e,t):e};function AE(i){i.target.composing=!0}function gf(i){const e=i.target;e.composing&&(e.composing=!1,e.dispatchEvent(new Event("input")))}const bu=Symbol("_assign"),Eu={created(i,{modifiers:{lazy:e,trim:t,number:r}},n){i[bu]=vf(n);const s=r||n.props&&n.props.type==="number";Qi(i,e?"change":"input",o=>{if(o.target.composing)return;let a=i.value;t&&(a=a.trim()),s&&(a=dc(a)),i[bu](a)}),t&&Qi(i,"change",()=>{i.value=i.value.trim()}),e||(Qi(i,"compositionstart",AE),Qi(i,"compositionend",gf),Qi(i,"change",gf))},mounted(i,{value:e}){i.value=e??""},beforeUpdate(i,{value:e,oldValue:t,modifiers:{lazy:r,trim:n,number:s}},o){if(i[bu]=vf(o),i.composing)return;const a=(s||i.type==="number")&&!/^0\d/.test(i.value)?dc(i.value):i.value,l=e??"";a!==l&&(document.activeElement===i&&i.type!=="range"&&(r&&e===t||n&&i.value.trim()===l)||(i.value=l))}},DE=jt({patchProp:PE},gE);let pf;function UE(){return pf||(pf=Kb(DE))}const LE=(...i)=>{const e=UE().createApp(...i),{mount:t}=e;return e.mount=r=>{const n=xE(r);if(!n)return;const s=e._component;!Le(s)&&!s.render&&!s.template&&(s.template=n.innerHTML),n.nodeType===1&&(n.textContent="");const o=t(n,!1,NE(n));return n instanceof Element&&(n.removeAttribute("v-cloak"),n.setAttribute("data-v-app","")),o},e};function NE(i){if(i instanceof SVGElement)return"svg";if(typeof MathMLElement=="function"&&i instanceof MathMLElement)return"mathml"}function xE(i){return Et(i)?document.querySelector(i):i}/*!
 * pinia v3.0.1
 * (c) 2025 Eduardo San Martin Morote
 * @license MIT
 */let qm;const Vl=i=>qm=i,Vm=Symbol();function wc(i){return i&&typeof i=="object"&&Object.prototype.toString.call(i)==="[object Object]"&&typeof i.toJSON!="function"}var Do;(function(i){i.direct="direct",i.patchObject="patch object",i.patchFunction="patch function"})(Do||(Do={}));function KE(){const i=jp(!0),e=i.run(()=>yn({}));let t=[],r=[];const n=Hd({install(s){Vl(n),n._a=s,s.provide(Vm,n),s.config.globalProperties.$pinia=n,r.forEach(o=>t.push(o)),r=[]},use(s){return this._a?t.push(s):r.push(s),this},_p:t,_a:null,_e:i,_s:new Map,state:e});return n}const Wm=()=>{};function mf(i,e,t,r=Wm){i.push(e);const n=()=>{const s=i.indexOf(e);s>-1&&(i.splice(s,1),r())};return!t&&qp()&&k_(n),n}function Vi(i,...e){i.slice().forEach(t=>{t(...e)})}const FE=i=>i(),yf=Symbol(),wu=Symbol();function Rc(i,e){i instanceof Map&&e instanceof Map?e.forEach((t,r)=>i.set(r,t)):i instanceof Set&&e instanceof Set&&e.forEach(i.add,i);for(const t in e){if(!e.hasOwnProperty(t))continue;const r=e[t],n=i[t];wc(n)&&wc(r)&&i.hasOwnProperty(t)&&!pt(r)&&!Hn(r)?i[t]=Rc(n,r):i[t]=r}return i}const BE=Symbol();function jE(i){return!wc(i)||!i.hasOwnProperty(BE)}const{assign:Dn}=Object;function qE(i){return!!(pt(i)&&i.effect)}function VE(i,e,t,r){const{state:n,actions:s,getters:o}=e,a=t.state.value[i];let l;function u(){a||(t.state.value[i]=n?n():{});const c=Q_(t.state.value[i]);return Dn(c,s,Object.keys(o||{}).reduce((d,h)=>(d[h]=Hd(gr(()=>{Vl(t);const g=t._s.get(i);return o[h].call(g,g)})),d),{}))}return l=Gm(i,u,e,t,r,!0),l}function Gm(i,e,t={},r,n,s){let o;const a=Dn({actions:{}},t),l={deep:!0};let u,c,d=[],h=[],g;const v=r.state.value[i];!s&&!v&&(r.state.value[i]={}),yn({});let m;function E(w){let D;u=c=!1,typeof w=="function"?(w(r.state.value[i]),D={type:Do.patchFunction,storeId:i,events:g}):(Rc(r.state.value[i],w),D={type:Do.patchObject,payload:w,storeId:i,events:g});const x=m=Symbol();$d().then(()=>{m===x&&(u=!0)}),c=!0,Vi(d,D,r.state.value[i])}const R=s?function(){const{state:D}=t,x=D?D():{};this.$patch(G=>{Dn(G,x)})}:Wm;function _(){o.stop(),d=[],h=[],r._s.delete(i)}const T=(w,D="")=>{if(yf in w)return w[wu]=D,w;const x=function(){Vl(r);const G=Array.from(arguments),oe=[],de=[];function Ee(Z){oe.push(Z)}function X(Z){de.push(Z)}Vi(h,{args:G,name:x[wu],store:I,after:Ee,onError:X});let re;try{re=w.apply(this&&this.$id===i?this:I,G)}catch(Z){throw Vi(de,Z),Z}return re instanceof Promise?re.then(Z=>(Vi(oe,Z),Z)).catch(Z=>(Vi(de,Z),Promise.reject(Z))):(Vi(oe,re),re)};return x[yf]=!0,x[wu]=D,x},b={_p:r,$id:i,$onAction:mf.bind(null,h),$patch:E,$reset:R,$subscribe(w,D={}){const x=mf(d,w,D.detached,()=>G()),G=o.run(()=>Mo(()=>r.state.value[i],oe=>{(D.flush==="sync"?c:u)&&w({storeId:i,type:Do.direct,events:g},oe)},Dn({},l,D)));return x},$dispose:_},I=ha(b);r._s.set(i,I);const C=(r._a&&r._a.runWithContext||FE)(()=>r._e.run(()=>(o=jp()).run(()=>e({action:T}))));for(const w in C){const D=C[w];if(pt(D)&&!qE(D)||Hn(D))s||(v&&jE(D)&&(pt(D)?D.value=v[w]:Rc(D,v[w])),r.state.value[i][w]=D);else if(typeof D=="function"){const x=T(D,w);C[w]=x,a.actions[w]=D}}return Dn(I,C),Dn(qe(I),C),Object.defineProperty(I,"$state",{get:()=>r.state.value[i],set:w=>{E(D=>{Dn(D,w)})}}),r._p.forEach(w=>{Dn(I,o.run(()=>w({store:I,app:r._a,pinia:r,options:a})))}),v&&s&&t.hydrate&&t.hydrate(I.$state,v),u=!0,c=!0,I}/*! #__NO_SIDE_EFFECTS__ */function WE(i,e,t){let r;const n=typeof e=="function";r=n?t:e;function s(o,a){const l=Mb();return o=o||(l?Mr(Vm,null):null),o&&Vl(o),o=qm,o._s.has(i)||(n?Gm(i,e,r,o):VE(i,r,o)),o._s.get(i)}return s.$id=i,s}/*!
  * vue-router v4.5.0
  * (c) 2024 Eduardo San Martin Morote
  * @license MIT
  */const Xi=typeof document<"u";function Hm(i){return typeof i=="object"||"displayName"in i||"props"in i||"__vccOpts"in i}function GE(i){return i.__esModule||i[Symbol.toStringTag]==="Module"||i.default&&Hm(i.default)}const He=Object.assign;function Ru(i,e){const t={};for(const r in e){const n=e[r];t[r]=Lr(n)?n.map(i):i(n)}return t}const Uo=()=>{},Lr=Array.isArray,$m=/#/g,HE=/&/g,$E=/\//g,zE=/=/g,JE=/\?/g,zm=/\+/g,YE=/%5B/g,QE=/%5D/g,Jm=/%5E/g,XE=/%60/g,Ym=/%7B/g,ZE=/%7C/g,Qm=/%7D/g,ew=/%20/g;function Xd(i){return encodeURI(""+i).replace(ZE,"|").replace(YE,"[").replace(QE,"]")}function tw(i){return Xd(i).replace(Ym,"{").replace(Qm,"}").replace(Jm,"^")}function Tc(i){return Xd(i).replace(zm,"%2B").replace(ew,"+").replace($m,"%23").replace(HE,"%26").replace(XE,"`").replace(Ym,"{").replace(Qm,"}").replace(Jm,"^")}function rw(i){return Tc(i).replace(zE,"%3D")}function nw(i){return Xd(i).replace($m,"%23").replace(JE,"%3F")}function iw(i){return i==null?"":nw(i).replace($E,"%2F")}function Jo(i){try{return decodeURIComponent(""+i)}catch{}return""+i}const sw=/\/$/,ow=i=>i.replace(sw,"");function Tu(i,e,t="/"){let r,n={},s="",o="";const a=e.indexOf("#");let l=e.indexOf("?");return a<l&&a>=0&&(l=-1),l>-1&&(r=e.slice(0,l),s=e.slice(l+1,a>-1?a:e.length),n=i(s)),a>-1&&(r=r||e.slice(0,a),o=e.slice(a,e.length)),r=cw(r??e,t),{fullPath:r+(s&&"?")+s+o,path:r,query:n,hash:Jo(o)}}function aw(i,e){const t=e.query?i(e.query):"";return e.path+(t&&"?")+t+(e.hash||"")}function Sf(i,e){return!e||!i.toLowerCase().startsWith(e.toLowerCase())?i:i.slice(e.length)||"/"}function lw(i,e,t){const r=e.matched.length-1,n=t.matched.length-1;return r>-1&&r===n&&ms(e.matched[r],t.matched[n])&&Xm(e.params,t.params)&&i(e.query)===i(t.query)&&e.hash===t.hash}function ms(i,e){return(i.aliasOf||i)===(e.aliasOf||e)}function Xm(i,e){if(Object.keys(i).length!==Object.keys(e).length)return!1;for(const t in i)if(!uw(i[t],e[t]))return!1;return!0}function uw(i,e){return Lr(i)?_f(i,e):Lr(e)?_f(e,i):i===e}function _f(i,e){return Lr(e)?i.length===e.length&&i.every((t,r)=>t===e[r]):i.length===1&&i[0]===e}function cw(i,e){if(i.startsWith("/"))return i;if(!i)return e;const t=e.split("/"),r=i.split("/"),n=r[r.length-1];(n===".."||n===".")&&r.push("");let s=t.length-1,o,a;for(o=0;o<r.length;o++)if(a=r[o],a!==".")if(a==="..")s>1&&s--;else break;return t.slice(0,s).join("/")+"/"+r.slice(o).join("/")}const On={path:"/",name:void 0,params:{},query:{},hash:"",fullPath:"/",matched:[],meta:{},redirectedFrom:void 0};var Yo;(function(i){i.pop="pop",i.push="push"})(Yo||(Yo={}));var Lo;(function(i){i.back="back",i.forward="forward",i.unknown=""})(Lo||(Lo={}));function dw(i){if(!i)if(Xi){const e=document.querySelector("base");i=e&&e.getAttribute("href")||"/",i=i.replace(/^\w+:\/\/[^\/]+/,"")}else i="/";return i[0]!=="/"&&i[0]!=="#"&&(i="/"+i),ow(i)}const hw=/^[^#]+#/;function fw(i,e){return i.replace(hw,"#")+e}function vw(i,e){const t=document.documentElement.getBoundingClientRect(),r=i.getBoundingClientRect();return{behavior:e.behavior,left:r.left-t.left-(e.left||0),top:r.top-t.top-(e.top||0)}}const Wl=()=>({left:window.scrollX,top:window.scrollY});function gw(i){let e;if("el"in i){const t=i.el,r=typeof t=="string"&&t.startsWith("#"),n=typeof t=="string"?r?document.getElementById(t.slice(1)):document.querySelector(t):t;if(!n)return;e=vw(n,i)}else e=i;"scrollBehavior"in document.documentElement.style?window.scrollTo(e):window.scrollTo(e.left!=null?e.left:window.scrollX,e.top!=null?e.top:window.scrollY)}function bf(i,e){return(history.state?history.state.position-e:-1)+i}const Ic=new Map;function pw(i,e){Ic.set(i,e)}function mw(i){const e=Ic.get(i);return Ic.delete(i),e}let yw=()=>location.protocol+"//"+location.host;function Zm(i,e){const{pathname:t,search:r,hash:n}=e,s=i.indexOf("#");if(s>-1){let a=n.includes(i.slice(s))?i.slice(s).length:1,l=n.slice(a);return l[0]!=="/"&&(l="/"+l),Sf(l,"")}return Sf(t,i)+r+n}function Sw(i,e,t,r){let n=[],s=[],o=null;const a=({state:h})=>{const g=Zm(i,location),v=t.value,m=e.value;let E=0;if(h){if(t.value=g,e.value=h,o&&o===v){o=null;return}E=m?h.position-m.position:0}else r(g);n.forEach(R=>{R(t.value,v,{delta:E,type:Yo.pop,direction:E?E>0?Lo.forward:Lo.back:Lo.unknown})})};function l(){o=t.value}function u(h){n.push(h);const g=()=>{const v=n.indexOf(h);v>-1&&n.splice(v,1)};return s.push(g),g}function c(){const{history:h}=window;h.state&&h.replaceState(He({},h.state,{scroll:Wl()}),"")}function d(){for(const h of s)h();s=[],window.removeEventListener("popstate",a),window.removeEventListener("beforeunload",c)}return window.addEventListener("popstate",a),window.addEventListener("beforeunload",c,{passive:!0}),{pauseListeners:l,listen:u,destroy:d}}function Ef(i,e,t,r=!1,n=!1){return{back:i,current:e,forward:t,replaced:r,position:window.history.length,scroll:n?Wl():null}}function _w(i){const{history:e,location:t}=window,r={value:Zm(i,t)},n={value:e.state};n.value||s(r.value,{back:null,current:r.value,forward:null,position:e.length-1,replaced:!0,scroll:null},!0);function s(l,u,c){const d=i.indexOf("#"),h=d>-1?(t.host&&document.querySelector("base")?i:i.slice(d))+l:yw()+i+l;try{e[c?"replaceState":"pushState"](u,"",h),n.value=u}catch(g){console.error(g),t[c?"replace":"assign"](h)}}function o(l,u){const c=He({},e.state,Ef(n.value.back,l,n.value.forward,!0),u,{position:n.value.position});s(l,c,!0),r.value=l}function a(l,u){const c=He({},n.value,e.state,{forward:l,scroll:Wl()});s(c.current,c,!0);const d=He({},Ef(r.value,l,null),{position:c.position+1},u);s(l,d,!1),r.value=l}return{location:r,state:n,push:a,replace:o}}function bw(i){i=dw(i);const e=_w(i),t=Sw(i,e.state,e.location,e.replace);function r(s,o=!0){o||t.pauseListeners(),history.go(s)}const n=He({location:"",base:i,go:r,createHref:fw.bind(null,i)},e,t);return Object.defineProperty(n,"location",{enumerable:!0,get:()=>e.location.value}),Object.defineProperty(n,"state",{enumerable:!0,get:()=>e.state.value}),n}function Ew(i){return typeof i=="string"||i&&typeof i=="object"}function ey(i){return typeof i=="string"||typeof i=="symbol"}const ty=Symbol("");var wf;(function(i){i[i.aborted=4]="aborted",i[i.cancelled=8]="cancelled",i[i.duplicated=16]="duplicated"})(wf||(wf={}));function ys(i,e){return He(new Error,{type:i,[ty]:!0},e)}function rn(i,e){return i instanceof Error&&ty in i&&(e==null||!!(i.type&e))}const Rf="[^/]+?",ww={sensitive:!1,strict:!1,start:!0,end:!0},Rw=/[.+*?^${}()[\]/\\]/g;function Tw(i,e){const t=He({},ww,e),r=[];let n=t.start?"^":"";const s=[];for(const u of i){const c=u.length?[]:[90];t.strict&&!u.length&&(n+="/");for(let d=0;d<u.length;d++){const h=u[d];let g=40+(t.sensitive?.25:0);if(h.type===0)d||(n+="/"),n+=h.value.replace(Rw,"\\$&"),g+=40;else if(h.type===1){const{value:v,repeatable:m,optional:E,regexp:R}=h;s.push({name:v,repeatable:m,optional:E});const _=R||Rf;if(_!==Rf){g+=10;try{new RegExp(`(${_})`)}catch(b){throw new Error(`Invalid custom RegExp for param "${v}" (${_}): `+b.message)}}let T=m?`((?:${_})(?:/(?:${_}))*)`:`(${_})`;d||(T=E&&u.length<2?`(?:/${T})`:"/"+T),E&&(T+="?"),n+=T,g+=20,E&&(g+=-8),m&&(g+=-20),_===".*"&&(g+=-50)}c.push(g)}r.push(c)}if(t.strict&&t.end){const u=r.length-1;r[u][r[u].length-1]+=.7000000000000001}t.strict||(n+="/?"),t.end?n+="$":t.strict&&!n.endsWith("/")&&(n+="(?:/|$)");const o=new RegExp(n,t.sensitive?"":"i");function a(u){const c=u.match(o),d={};if(!c)return null;for(let h=1;h<c.length;h++){const g=c[h]||"",v=s[h-1];d[v.name]=g&&v.repeatable?g.split("/"):g}return d}function l(u){let c="",d=!1;for(const h of i){(!d||!c.endsWith("/"))&&(c+="/"),d=!1;for(const g of h)if(g.type===0)c+=g.value;else if(g.type===1){const{value:v,repeatable:m,optional:E}=g,R=v in u?u[v]:"";if(Lr(R)&&!m)throw new Error(`Provided param "${v}" is an array but it is not repeatable (* or + modifiers)`);const _=Lr(R)?R.join("/"):R;if(!_)if(E)h.length<2&&(c.endsWith("/")?c=c.slice(0,-1):d=!0);else throw new Error(`Missing required param "${v}"`);c+=_}}return c||"/"}return{re:o,score:r,keys:s,parse:a,stringify:l}}function Iw(i,e){let t=0;for(;t<i.length&&t<e.length;){const r=e[t]-i[t];if(r)return r;t++}return i.length<e.length?i.length===1&&i[0]===80?-1:1:i.length>e.length?e.length===1&&e[0]===80?1:-1:0}function ry(i,e){let t=0;const r=i.score,n=e.score;for(;t<r.length&&t<n.length;){const s=Iw(r[t],n[t]);if(s)return s;t++}if(Math.abs(n.length-r.length)===1){if(Tf(r))return 1;if(Tf(n))return-1}return n.length-r.length}function Tf(i){const e=i[i.length-1];return i.length>0&&e[e.length-1]<0}const Cw={type:0,value:""},kw=/[a-zA-Z0-9_]/;function Ow(i){if(!i)return[[]];if(i==="/")return[[Cw]];if(!i.startsWith("/"))throw new Error(`Invalid path "${i}"`);function e(g){throw new Error(`ERR (${t})/"${u}": ${g}`)}let t=0,r=t;const n=[];let s;function o(){s&&n.push(s),s=[]}let a=0,l,u="",c="";function d(){u&&(t===0?s.push({type:0,value:u}):t===1||t===2||t===3?(s.length>1&&(l==="*"||l==="+")&&e(`A repeatable param (${u}) must be alone in its segment. eg: '/:ids+.`),s.push({type:1,value:u,regexp:c,repeatable:l==="*"||l==="+",optional:l==="*"||l==="?"})):e("Invalid state to consume buffer"),u="")}function h(){u+=l}for(;a<i.length;){if(l=i[a++],l==="\\"&&t!==2){r=t,t=4;continue}switch(t){case 0:l==="/"?(u&&d(),o()):l===":"?(d(),t=1):h();break;case 4:h(),t=r;break;case 1:l==="("?t=2:kw.test(l)?h():(d(),t=0,l!=="*"&&l!=="?"&&l!=="+"&&a--);break;case 2:l===")"?c[c.length-1]=="\\"?c=c.slice(0,-1)+l:t=3:c+=l;break;case 3:d(),t=0,l!=="*"&&l!=="?"&&l!=="+"&&a--,c="";break;default:e("Unknown state");break}}return t===2&&e(`Unfinished custom RegExp for param "${u}"`),d(),o(),n}function Pw(i,e,t){const r=Tw(Ow(i.path),t),n=He(r,{record:i,parent:e,children:[],alias:[]});return e&&!n.record.aliasOf==!e.record.aliasOf&&e.children.push(n),n}function Mw(i,e){const t=[],r=new Map;e=Of({strict:!1,end:!0,sensitive:!1},e);function n(d){return r.get(d)}function s(d,h,g){const v=!g,m=Cf(d);m.aliasOf=g&&g.record;const E=Of(e,d),R=[m];if("alias"in d){const b=typeof d.alias=="string"?[d.alias]:d.alias;for(const I of b)R.push(Cf(He({},m,{components:g?g.record.components:m.components,path:I,aliasOf:g?g.record:m})))}let _,T;for(const b of R){const{path:I}=b;if(h&&I[0]!=="/"){const y=h.record.path,C=y[y.length-1]==="/"?"":"/";b.path=h.record.path+(I&&C+I)}if(_=Pw(b,h,E),g?g.alias.push(_):(T=T||_,T!==_&&T.alias.push(_),v&&d.name&&!kf(_)&&o(d.name)),ny(_)&&l(_),m.children){const y=m.children;for(let C=0;C<y.length;C++)s(y[C],_,g&&g.children[C])}g=g||_}return T?()=>{o(T)}:Uo}function o(d){if(ey(d)){const h=r.get(d);h&&(r.delete(d),t.splice(t.indexOf(h),1),h.children.forEach(o),h.alias.forEach(o))}else{const h=t.indexOf(d);h>-1&&(t.splice(h,1),d.record.name&&r.delete(d.record.name),d.children.forEach(o),d.alias.forEach(o))}}function a(){return t}function l(d){const h=Uw(d,t);t.splice(h,0,d),d.record.name&&!kf(d)&&r.set(d.record.name,d)}function u(d,h){let g,v={},m,E;if("name"in d&&d.name){if(g=r.get(d.name),!g)throw ys(1,{location:d});E=g.record.name,v=He(If(h.params,g.keys.filter(T=>!T.optional).concat(g.parent?g.parent.keys.filter(T=>T.optional):[]).map(T=>T.name)),d.params&&If(d.params,g.keys.map(T=>T.name))),m=g.stringify(v)}else if(d.path!=null)m=d.path,g=t.find(T=>T.re.test(m)),g&&(v=g.parse(m),E=g.record.name);else{if(g=h.name?r.get(h.name):t.find(T=>T.re.test(h.path)),!g)throw ys(1,{location:d,currentLocation:h});E=g.record.name,v=He({},h.params,d.params),m=g.stringify(v)}const R=[];let _=g;for(;_;)R.unshift(_.record),_=_.parent;return{name:E,path:m,params:v,matched:R,meta:Dw(R)}}i.forEach(d=>s(d));function c(){t.length=0,r.clear()}return{addRoute:s,resolve:u,removeRoute:o,clearRoutes:c,getRoutes:a,getRecordMatcher:n}}function If(i,e){const t={};for(const r of e)r in i&&(t[r]=i[r]);return t}function Cf(i){const e={path:i.path,redirect:i.redirect,name:i.name,meta:i.meta||{},aliasOf:i.aliasOf,beforeEnter:i.beforeEnter,props:Aw(i),children:i.children||[],instances:{},leaveGuards:new Set,updateGuards:new Set,enterCallbacks:{},components:"components"in i?i.components||null:i.component&&{default:i.component}};return Object.defineProperty(e,"mods",{value:{}}),e}function Aw(i){const e={},t=i.props||!1;if("component"in i)e.default=t;else for(const r in i.components)e[r]=typeof t=="object"?t[r]:t;return e}function kf(i){for(;i;){if(i.record.aliasOf)return!0;i=i.parent}return!1}function Dw(i){return i.reduce((e,t)=>He(e,t.meta),{})}function Of(i,e){const t={};for(const r in i)t[r]=r in e?e[r]:i[r];return t}function Uw(i,e){let t=0,r=e.length;for(;t!==r;){const s=t+r>>1;ry(i,e[s])<0?r=s:t=s+1}const n=Lw(i);return n&&(r=e.lastIndexOf(n,r-1)),r}function Lw(i){let e=i;for(;e=e.parent;)if(ny(e)&&ry(i,e)===0)return e}function ny({record:i}){return!!(i.name||i.components&&Object.keys(i.components).length||i.redirect)}function Nw(i){const e={};if(i===""||i==="?")return e;const r=(i[0]==="?"?i.slice(1):i).split("&");for(let n=0;n<r.length;++n){const s=r[n].replace(zm," "),o=s.indexOf("="),a=Jo(o<0?s:s.slice(0,o)),l=o<0?null:Jo(s.slice(o+1));if(a in e){let u=e[a];Lr(u)||(u=e[a]=[u]),u.push(l)}else e[a]=l}return e}function Pf(i){let e="";for(let t in i){const r=i[t];if(t=rw(t),r==null){r!==void 0&&(e+=(e.length?"&":"")+t);continue}(Lr(r)?r.map(s=>s&&Tc(s)):[r&&Tc(r)]).forEach(s=>{s!==void 0&&(e+=(e.length?"&":"")+t,s!=null&&(e+="="+s))})}return e}function xw(i){const e={};for(const t in i){const r=i[t];r!==void 0&&(e[t]=Lr(r)?r.map(n=>n==null?null:""+n):r==null?r:""+r)}return e}const Kw=Symbol(""),Mf=Symbol(""),Gl=Symbol(""),iy=Symbol(""),Cc=Symbol("");function Ns(){let i=[];function e(r){return i.push(r),()=>{const n=i.indexOf(r);n>-1&&i.splice(n,1)}}function t(){i=[]}return{add:e,list:()=>i.slice(),reset:t}}function Bn(i,e,t,r,n,s=o=>o()){const o=r&&(r.enterCallbacks[n]=r.enterCallbacks[n]||[]);return()=>new Promise((a,l)=>{const u=h=>{h===!1?l(ys(4,{from:t,to:e})):h instanceof Error?l(h):Ew(h)?l(ys(2,{from:e,to:h})):(o&&r.enterCallbacks[n]===o&&typeof h=="function"&&o.push(h),a())},c=s(()=>i.call(r&&r.instances[n],e,t,u));let d=Promise.resolve(c);i.length<3&&(d=d.then(u)),d.catch(h=>l(h))})}function Iu(i,e,t,r,n=s=>s()){const s=[];for(const o of i)for(const a in o.components){let l=o.components[a];if(!(e!=="beforeRouteEnter"&&!o.instances[a]))if(Hm(l)){const c=(l.__vccOpts||l)[e];c&&s.push(Bn(c,t,r,o,a,n))}else{let u=l();s.push(()=>u.then(c=>{if(!c)throw new Error(`Couldn't resolve component "${a}" at "${o.path}"`);const d=GE(c)?c.default:c;o.mods[a]=c,o.components[a]=d;const g=(d.__vccOpts||d)[e];return g&&Bn(g,t,r,o,a,n)()}))}}return s}function Af(i){const e=Mr(Gl),t=Mr(iy),r=gr(()=>{const l=Mi(i.to);return e.resolve(l)}),n=gr(()=>{const{matched:l}=r.value,{length:u}=l,c=l[u-1],d=t.matched;if(!c||!d.length)return-1;const h=d.findIndex(ms.bind(null,c));if(h>-1)return h;const g=Df(l[u-2]);return u>1&&Df(c)===g&&d[d.length-1].path!==g?d.findIndex(ms.bind(null,l[u-2])):h}),s=gr(()=>n.value>-1&&Vw(t.params,r.value.params)),o=gr(()=>n.value>-1&&n.value===t.matched.length-1&&Xm(t.params,r.value.params));function a(l={}){if(qw(l)){const u=e[Mi(i.replace)?"replace":"push"](Mi(i.to)).catch(Uo);return i.viewTransition&&typeof document<"u"&&"startViewTransition"in document&&document.startViewTransition(()=>u),u}return Promise.resolve()}return{route:r,href:gr(()=>r.value.href),isActive:s,isExactActive:o,navigate:a}}function Fw(i){return i.length===1?i[0]:i}const Bw=hm({name:"RouterLink",compatConfig:{MODE:3},props:{to:{type:[String,Object],required:!0},replace:Boolean,activeClass:String,exactActiveClass:String,custom:Boolean,ariaCurrentValue:{type:String,default:"page"}},useLink:Af,setup(i,{slots:e}){const t=ha(Af(i)),{options:r}=Mr(Gl),n=gr(()=>({[Uf(i.activeClass,r.linkActiveClass,"router-link-active")]:t.isActive,[Uf(i.exactActiveClass,r.linkExactActiveClass,"router-link-exact-active")]:t.isExactActive}));return()=>{const s=e.default&&Fw(e.default(t));return i.custom?s:Bm("a",{"aria-current":t.isExactActive?i.ariaCurrentValue:null,href:t.href,onClick:t.navigate,class:n.value},s)}}}),jw=Bw;function qw(i){if(!(i.metaKey||i.altKey||i.ctrlKey||i.shiftKey)&&!i.defaultPrevented&&!(i.button!==void 0&&i.button!==0)){if(i.currentTarget&&i.currentTarget.getAttribute){const e=i.currentTarget.getAttribute("target");if(/\b_blank\b/i.test(e))return}return i.preventDefault&&i.preventDefault(),!0}}function Vw(i,e){for(const t in e){const r=e[t],n=i[t];if(typeof r=="string"){if(r!==n)return!1}else if(!Lr(n)||n.length!==r.length||r.some((s,o)=>s!==n[o]))return!1}return!0}function Df(i){return i?i.aliasOf?i.aliasOf.path:i.path:""}const Uf=(i,e,t)=>i??e??t,Ww=hm({name:"RouterView",inheritAttrs:!1,props:{name:{type:String,default:"default"},route:Object},compatConfig:{MODE:3},setup(i,{attrs:e,slots:t}){const r=Mr(Cc),n=gr(()=>i.route||r.value),s=Mr(Mf,0),o=gr(()=>{let u=Mi(s);const{matched:c}=n.value;let d;for(;(d=c[u])&&!d.components;)u++;return u}),a=gr(()=>n.value.matched[o.value]);Ha(Mf,gr(()=>o.value+1)),Ha(Kw,a),Ha(Cc,n);const l=yn();return Mo(()=>[l.value,a.value,i.name],([u,c,d],[h,g,v])=>{c&&(c.instances[d]=u,g&&g!==c&&u&&u===h&&(c.leaveGuards.size||(c.leaveGuards=g.leaveGuards),c.updateGuards.size||(c.updateGuards=g.updateGuards))),u&&c&&(!g||!ms(c,g)||!h)&&(c.enterCallbacks[d]||[]).forEach(m=>m(u))},{flush:"post"}),()=>{const u=n.value,c=i.name,d=a.value,h=d&&d.components[c];if(!h)return Lf(t.default,{Component:h,route:u});const g=d.props[c],v=g?g===!0?u.params:typeof g=="function"?g(u):g:null,E=Bm(h,He({},v,e,{onVnodeUnmounted:R=>{R.component.isUnmounted&&(d.instances[c]=null)},ref:l}));return Lf(t.default,{Component:E,route:u})||E}}});function Lf(i,e){if(!i)return null;const t=i(e);return t.length===1?t[0]:t}const sy=Ww;function Gw(i){const e=Mw(i.routes,i),t=i.parseQuery||Nw,r=i.stringifyQuery||Pf,n=i.history,s=Ns(),o=Ns(),a=Ns(),l=z_(On);let u=On;Xi&&i.scrollBehavior&&"scrollRestoration"in history&&(history.scrollRestoration="manual");const c=Ru.bind(null,A=>""+A),d=Ru.bind(null,iw),h=Ru.bind(null,Jo);function g(A,M){let L,P;return ey(A)?(L=e.getRecordMatcher(A),P=M):P=A,e.addRoute(P,L)}function v(A){const M=e.getRecordMatcher(A);M&&e.removeRoute(M)}function m(){return e.getRoutes().map(A=>A.record)}function E(A){return!!e.getRecordMatcher(A)}function R(A,M){if(M=He({},M||l.value),typeof A=="string"){const U=Tu(t,A,M.path),V=e.resolve({path:U.path},M),q=n.createHref(U.fullPath);return He(U,V,{params:h(V.params),hash:Jo(U.hash),redirectedFrom:void 0,href:q})}let L;if(A.path!=null)L=He({},A,{path:Tu(t,A.path,M.path).path});else{const U=He({},A.params);for(const V in U)U[V]==null&&delete U[V];L=He({},A,{params:d(U)}),M.params=d(M.params)}const P=e.resolve(L,M),B=A.hash||"";P.params=c(h(P.params));const k=aw(r,He({},A,{hash:tw(B),path:P.path})),O=n.createHref(k);return He({fullPath:k,hash:B,query:r===Pf?xw(A.query):A.query||{}},P,{redirectedFrom:void 0,href:O})}function _(A){return typeof A=="string"?Tu(t,A,l.value.path):He({},A)}function T(A,M){if(u!==A)return ys(8,{from:M,to:A})}function b(A){return C(A)}function I(A){return b(He(_(A),{replace:!0}))}function y(A){const M=A.matched[A.matched.length-1];if(M&&M.redirect){const{redirect:L}=M;let P=typeof L=="function"?L(A):L;return typeof P=="string"&&(P=P.includes("?")||P.includes("#")?P=_(P):{path:P},P.params={}),He({query:A.query,hash:A.hash,params:P.path!=null?{}:A.params},P)}}function C(A,M){const L=u=R(A),P=l.value,B=A.state,k=A.force,O=A.replace===!0,U=y(L);if(U)return C(He(_(U),{state:typeof U=="object"?He({},B,U.state):B,force:k,replace:O}),M||L);const V=L;V.redirectedFrom=M;let q;return!k&&lw(r,P,L)&&(q=ys(16,{to:V,from:P}),Be(P,P,!0,!1)),(q?Promise.resolve(q):x(V,P)).catch(J=>rn(J)?rn(J,2)?J:we(J):ne(J,V,P)).then(J=>{if(J){if(rn(J,2))return C(He({replace:O},_(J.to),{state:typeof J.to=="object"?He({},B,J.to.state):B,force:k}),M||V)}else J=oe(V,P,!0,O,B);return G(V,P,J),J})}function w(A,M){const L=T(A,M);return L?Promise.reject(L):Promise.resolve()}function D(A){const M=j.values().next().value;return M&&typeof M.runWithContext=="function"?M.runWithContext(A):A()}function x(A,M){let L;const[P,B,k]=Hw(A,M);L=Iu(P.reverse(),"beforeRouteLeave",A,M);for(const U of P)U.leaveGuards.forEach(V=>{L.push(Bn(V,A,M))});const O=w.bind(null,A,M);return L.push(O),N(L).then(()=>{L=[];for(const U of s.list())L.push(Bn(U,A,M));return L.push(O),N(L)}).then(()=>{L=Iu(B,"beforeRouteUpdate",A,M);for(const U of B)U.updateGuards.forEach(V=>{L.push(Bn(V,A,M))});return L.push(O),N(L)}).then(()=>{L=[];for(const U of k)if(U.beforeEnter)if(Lr(U.beforeEnter))for(const V of U.beforeEnter)L.push(Bn(V,A,M));else L.push(Bn(U.beforeEnter,A,M));return L.push(O),N(L)}).then(()=>(A.matched.forEach(U=>U.enterCallbacks={}),L=Iu(k,"beforeRouteEnter",A,M,D),L.push(O),N(L))).then(()=>{L=[];for(const U of o.list())L.push(Bn(U,A,M));return L.push(O),N(L)}).catch(U=>rn(U,8)?U:Promise.reject(U))}function G(A,M,L){a.list().forEach(P=>D(()=>P(A,M,L)))}function oe(A,M,L,P,B){const k=T(A,M);if(k)return k;const O=M===On,U=Xi?history.state:{};L&&(P||O?n.replace(A.fullPath,He({scroll:O&&U&&U.scroll},B)):n.push(A.fullPath,B)),l.value=A,Be(A,M,L,O),we()}let de;function Ee(){de||(de=n.listen((A,M,L)=>{if(!K.listening)return;const P=R(A),B=y(P);if(B){C(He(B,{replace:!0,force:!0}),P).catch(Uo);return}u=P;const k=l.value;Xi&&pw(bf(k.fullPath,L.delta),Wl()),x(P,k).catch(O=>rn(O,12)?O:rn(O,2)?(C(He(_(O.to),{force:!0}),P).then(U=>{rn(U,20)&&!L.delta&&L.type===Yo.pop&&n.go(-1,!1)}).catch(Uo),Promise.reject()):(L.delta&&n.go(-L.delta,!1),ne(O,P,k))).then(O=>{O=O||oe(P,k,!1),O&&(L.delta&&!rn(O,8)?n.go(-L.delta,!1):L.type===Yo.pop&&rn(O,20)&&n.go(-1,!1)),G(P,k,O)}).catch(Uo)}))}let X=Ns(),re=Ns(),Z;function ne(A,M,L){we(A);const P=re.list();return P.length?P.forEach(B=>B(A,M,L)):console.error(A),Promise.reject(A)}function ce(){return Z&&l.value!==On?Promise.resolve():new Promise((A,M)=>{X.add([A,M])})}function we(A){return Z||(Z=!A,Ee(),X.list().forEach(([M,L])=>A?L(A):M()),X.reset()),A}function Be(A,M,L,P){const{scrollBehavior:B}=i;if(!Xi||!B)return Promise.resolve();const k=!L&&mw(bf(A.fullPath,0))||(P||!L)&&history.state&&history.state.scroll||null;return $d().then(()=>B(A,M,k)).then(O=>O&&gw(O)).catch(O=>ne(O,A,M))}const Q=A=>n.go(A);let le;const j=new Set,K={currentRoute:l,listening:!0,addRoute:g,removeRoute:v,clearRoutes:e.clearRoutes,hasRoute:E,getRoutes:m,resolve:R,options:i,push:b,replace:I,go:Q,back:()=>Q(-1),forward:()=>Q(1),beforeEach:s.add,beforeResolve:o.add,afterEach:a.add,onError:re.add,isReady:ce,install(A){const M=this;A.component("RouterLink",jw),A.component("RouterView",sy),A.config.globalProperties.$router=M,Object.defineProperty(A.config.globalProperties,"$route",{enumerable:!0,get:()=>Mi(l)}),Xi&&!le&&l.value===On&&(le=!0,b(n.location).catch(B=>{}));const L={};for(const B in On)Object.defineProperty(L,B,{get:()=>l.value[B],enumerable:!0});A.provide(Gl,M),A.provide(iy,nm(L)),A.provide(Cc,l);const P=A.unmount;j.add(A),A.unmount=function(){j.delete(A),j.size<1&&(u=On,de&&de(),de=null,l.value=On,le=!1,Z=!1),P()}}};function N(A){return A.reduce((M,L)=>M.then(()=>D(L)),Promise.resolve())}return K}function Hw(i,e){const t=[],r=[],n=[],s=Math.max(e.matched.length,i.matched.length);for(let o=0;o<s;o++){const a=e.matched[o];a&&(i.matched.find(u=>ms(u,a))?r.push(a):t.push(a));const l=i.matched[o];l&&(e.matched.find(u=>ms(u,l))||n.push(l))}return[t,r,n]}function Zd(){return Mr(Gl)}const eh=(i,e)=>{const t=i.__vccOpts||i;for(const[r,n]of e)t[r]=n;return t},$w={id:"app"},zw={__name:"App",setup(i){return(e,t)=>(Yr(),gn("div",$w,[t[0]||(t[0]=Ft("header",null,[Ft("h1",null,"Matrix Chat")],-1)),Ft("main",null,[Jt(Mi(sy))])]))}},Jw=eh(zw,[["__scopeId","data-v-cac1036a"]]);function Nf(i,e,t,r,n,s,o){try{var a=i[s](o),l=a.value}catch(u){return void t(u)}a.done?e(l):Promise.resolve(l).then(r,n)}function S(i){return function(){var e=this,t=arguments;return new Promise(function(r,n){var s=i.apply(e,t);function o(l){Nf(s,r,n,o,a,"next",l)}function a(l){Nf(s,r,n,o,a,"throw",l)}o(void 0)})}}function Qo(i){"@babel/helpers - typeof";return Qo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Qo(i)}function Yw(i,e){if(Qo(i)!="object"||!i)return i;var t=i[Symbol.toPrimitive];if(t!==void 0){var r=t.call(i,e);if(Qo(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}function Qw(i){var e=Yw(i,"string");return Qo(e)=="symbol"?e:e+""}function f(i,e,t){return(e=Qw(e))in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}var qk=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Hl(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Ja={exports:{}},Xw=Ja.exports,xf;function Zw(){return xf||(xf=1,function(i){(function(e,t){i.exports?i.exports=t():e.log=t()})(Xw,function(){var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],s={},o=null;function a(m,E){var R=m[E];if(typeof R.bind=="function")return R.bind(m);try{return Function.prototype.bind.call(R,m)}catch{return function(){return Function.prototype.apply.apply(R,[m,arguments])}}}function l(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function u(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&r?l:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):e}function c(){for(var m=this.getLevel(),E=0;E<n.length;E++){var R=n[E];this[R]=E<m?e:this.methodFactory(R,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(c.call(this),this[m].apply(this,arguments))}}function h(m,E,R){return u(m)||d.apply(this,arguments)}function g(m,E){var R=this,_,T,b,I="loglevel";typeof m=="string"?I+=":"+m:typeof m=="symbol"&&(I=void 0);function y(G){var oe=(n[G]||"silent").toUpperCase();if(!(typeof window===t||!I)){try{window.localStorage[I]=oe;return}catch{}try{window.document.cookie=encodeURIComponent(I)+"="+oe+";"}catch{}}}function C(){var G;if(!(typeof window===t||!I)){try{G=window.localStorage[I]}catch{}if(typeof G===t)try{var oe=window.document.cookie,de=encodeURIComponent(I),Ee=oe.indexOf(de+"=");Ee!==-1&&(G=/^([^;]+)/.exec(oe.slice(Ee+de.length+1))[1])}catch{}return R.levels[G]===void 0&&(G=void 0),G}}function w(){if(!(typeof window===t||!I)){try{window.localStorage.removeItem(I)}catch{}try{window.document.cookie=encodeURIComponent(I)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function D(G){var oe=G;if(typeof oe=="string"&&R.levels[oe.toUpperCase()]!==void 0&&(oe=R.levels[oe.toUpperCase()]),typeof oe=="number"&&oe>=0&&oe<=R.levels.SILENT)return oe;throw new TypeError("log.setLevel() called with invalid level: "+G)}R.name=m,R.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},R.methodFactory=E||h,R.getLevel=function(){return b??T??_},R.setLevel=function(G,oe){return b=D(G),oe!==!1&&y(b),c.call(R)},R.setDefaultLevel=function(G){T=D(G),C()||R.setLevel(G,!1)},R.resetLevel=function(){b=null,w(),c.call(R)},R.enableAll=function(G){R.setLevel(R.levels.TRACE,G)},R.disableAll=function(G){R.setLevel(R.levels.SILENT,G)},R.rebuild=function(){if(o!==R&&(_=D(o.getLevel())),c.call(R),o===R)for(var G in s)s[G].rebuild()},_=D(o?o.getLevel():"WARN");var x=C();x!=null&&(b=D(x)),c.call(R)}o=new g,o.getLogger=function(E){if(typeof E!="symbol"&&typeof E!="string"||E==="")throw new TypeError("You must supply a name when creating a logger.");var R=s[E];return R||(R=s[E]=new g(E,o.methodFactory)),R};var v=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=v),o},o.getLoggers=function(){return s},o.default=o,o})}(Ja)),Ja.exports}var eR=Zw();const Xo=Hl(eR);var oy="matrix";Xo.methodFactory=function(i,e,t){return function(){for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];this.prefix&&n.unshift(this.prefix);var o=i==="error"||i==="warn"||i==="trace"||i==="info"||i==="debug";return o?console[i](...n):console.log(...n)}};function ay(i){var e=i;e.getChild=e.withPrefix=function(t){var r=this.prefix||"";return tR(r+t)}}function tR(i){var e=Xo.getLogger("".concat(oy,"-").concat(i));return e.prefix!==i&&(ay(e),e.prefix=i,e.setLevel(Xo.levels.DEBUG,!1)),e}var p=Xo.getLogger(oy);p.setLevel(Xo.levels.DEBUG,!1);ay(p);class Vk{constructor(e,t){this.parent=e,f(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}}const rR="l",nR="rn",iR={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":",:":","":":","":"::=","":":","":"!",:"!","":"!","":"!!","":"!?",:"?","":"?","":"?",:"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"<","":">",:">",:">",:"4",:"b",:"b",:"d",:"J",:"L",:"P",:"U",:"V",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'",:"'",:"'",:"'",:"'","":"'",:"'","":"'","":"'",:"'",:"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''",:"''",:"''","":"'''","":"'''","":"''''",:"'B",:"'D",:"'n",:"'P",:"'T",:"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"/","":"/",:"/",:"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\",:"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<",:"<",:"<","":"<","":"<",:"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">",:">","":">",:">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2",:"2",:"2","":"2",:"2","":"2","":"","":"","":"","":"","":"","":"",:"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3",:"3",:"3","":"3","":"3",:"3",:"3","":"3","":"3","":"","":"","":"","":"",:"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4",:"4","":"4","":"","":"","":"","":"4,","":"4.",:"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5",:"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6",:"6",:"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8",:"8",:"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a",:"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a",:"a",:"a","":"a","":"a","":"a","":"a","":"a",:"a","":"",:"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A",:"A","":"A","":"A","":"A","":"A","":"A",:"A",:"A",:"A","":"A","":"A","":"A","":"a",:"",:"",:"",:"",:"","":"a/c","":"a/s","":"aa","":"AA",:"ae",:"ae",:"AE",:"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"",:"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b",:"b",:"b",:"b",:"b",:"b",:"B",:"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B",:"B","":"B","":"B","":"B","":"B","":"B",:"B",:"B",:"B","":"B","":"B","":"B","":"B",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b'",:"bl",:"","":"",:"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c",:"c","":"c",:"c","":"c","":"c","":"","":"C","":"C","":"C",:"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C",:"c",:"c",:"C",:"C",:"C'","":"c/o","":"c/u","":"	","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d",:"d",:"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D",:"D",:"D",:"D","":"D",:"d",:"d",:"d",:"d",:"D",:"D",:"D","":"d","":"",:"d",:"d'",:"d",:"dz",:"dz",:"Dz",:"DZ",:"d",:"D",:"D",:"d","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"e",:"e",:"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e",:"e",:"e","":"","":"E",:"E",:"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E",:"E","":"E","":"E","":"E","":"E",:"",:"","":"e","":"E",:"e","":"",:"",:"","":"","":"","":"",:"","":"o","":"o","":"o",:"","":"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f",:"f","":"f",:"f","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F",:"F","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F",:"f",:"F","":"f","":"FAX",:"ff",:"ffi",:"ffl",:"fi",:"fl",:"f",:"","":"","":"",:"",:"g",:"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g",:"g","":"g",:"g",:"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G",:"G",:"G","":"G","":"",:"g",:"",:"",:"",:"g",:"G",:"G'","":"","":"","":"",:"h",:"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h",:"h",:"h",:"h",:"H",:"H",:"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H",:"H",:"H","":"H","":"H","":"",:"h","":"h",:"h","":"H",:"H",:"h",:"h",:"h",:"H","":"H",:"H",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"i","":"i",:"i","":"i",:"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i",:"i",:"i",:"i",:"i",:"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i","":"i","":"i",:"i","":"i","":"","":"i",:"",:"",:"i","":"i","":"i","":"ii","":"iii",:"ij","":"iv","":"ix",:"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j",:"j",:"j",:"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J",:"J",:"J",:"J","":"J","":"j","":"J",:"J","":"",:"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k",:"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K",:"K",:"K","":"K","":"K",:"k","":"K",:"K","":"K","":"K",:"K",:"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:rR,:"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l",:"l",:"l",:"l","":"l","":"l",:"l",:"l","":"l","":"l",:"l","":"l","":"l","":"l","":"l","":"L","":"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L",:"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L",:"l",:"l",:"l",:"L",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l","":"l,","":"l.",:"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9",:"lj",:"lJ",:"Lj",:"LJ","":"ll","":"ll","":"ll",:"ll",:"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll",:"lO","":"lO.","":"lO","":"lO","":"lO",:"ls","":"lt","":"lV","":"lX",:"l",:"lz",:"l",:"l",:"l",:"l",:"l",:"l",:"lo","":"l","":"l","":"l","":"","":"","":"",:"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M",:"M",:"M",:"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n",:"n",:"n",:"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"n",:"n",:"n","":"n","":"n","":"n","":"n","":"n",:"N","":"n",:"nj",:"Nj",:"NJ","":"No","":"",:"","":"",:"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o",:"o",:"o",:"o","":"o","":"o","":"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"",:"",:"","":"o",:"",:"o","":"o",:"O","":"O",:"O",:"o","":"o",:"o",:"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"o",:"o","":"O,","":"O.",:"o'",:"O'",:"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"oe",:"OE",:"o","":"oo","":"oo","":"oo","":"OO","":"OO",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"oo",:"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P",:"P",:"P","":"P","":"P",:"p","":"p",:"p",:"P'","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q",:"q",:"q",:"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q",:"q","":"QE","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r",:"r","":"r","":"R",:"R",:"R",:"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R",:"R",:"R",:"R","":"R",:"R","":"R","":"R",:"r",:"r","":"r",:"r","":"r",:"r'","":"rn",m:nR,"":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn",:"rn","":"rn","":"Rs","":"","":"",:"","":"","":"",:"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s",:"s",:"s","":"s","":"s","":"s",:"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S",:"S",:"S",:"S",:"S","":"S","":"S","":"S","":"S",:"s","":"s","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"sss",:"st","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"t","":"T","":"T",:"",:"T",:"T","":"T",:"t",:"T","":"t",:"","":"T3",:"t","":"TEL","":"tf",:"ts",:"t","":"t",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u",:"u",:"u","":"u","":"u","":"u","":"u","":"u",:"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U",:"U",:"U","":"U",:"U","":"U","":"U","":"U",:"",:"","":"u","":"u","":"U",:"U",:"U",:"U'","":"ue","":"uo",:"",:"",:"","":"",:"",:"","":"","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v",:"v",:"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"V",:"V",:"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w",:"w","":"w",:"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W",:"W",:"W","":"W",:"w","":"w","":"W","":"w","":"",:"","":"","":"","":"x","":"x","":"x","":"x","":"x",:"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x",:"x",:"x",:"x","":"","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"x",:"X","":"X","":"xi","":"xii","":"Xl","":"Xll",:"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y","":"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y",:"y",:"y","":"y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y",:"y","":"y",:"y","":"Y","":"Y",:"Y",:"","":"","":"",:"",:"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z",:"Z",:"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z",:"z",:"z",:"Z",:"z",:"Z","":"z",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"i","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"",:"",:"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"l","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"",:"",:"'",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"l","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo o ",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"l",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"l",:"l",:"l",:"l",:"l",:"l",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"l",:"l",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"","":"",:"",:"'","":"/","":"",:"","":"","":"",:"",:"'",:"",:"",:"'",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"<",:"b",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"b",:"b",:"d",:"P",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"J",:"",:"",:"",:"",:"",:"",:"",:"J",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"",:"","":"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":""};var Cu,Kf;function sR(){if(Kf)return Cu;Kf=1;var i=iR;function e(s){return s.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var t=RegExp(Object.keys(i).map(e).join("|"),"g");function r(s){return i[s]}function n(s){return s.replace(t,r)}return Cu=n,Cu}var oR=sR();const aR=Hl(oR);var xs={exports:{}},ku={},Ou,Ff;function lR(){if(Ff)return Ou;Ff=1;function i(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return Ou=i,i.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},i.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},i.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},r),this._options.unref&&this._timer.unref(),!0},i.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},i.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},i.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},i.prototype.start=i.prototype.try,i.prototype.errors=function(){return this._errors},i.prototype.attempts=function(){return this._attempts},i.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var s=this._errors[n],o=s.message,a=(e[o]||0)+1;e[o]=a,a>=r&&(t=s,r=a)}return t},Ou}var Bf;function uR(){return Bf||(Bf=1,function(i){var e=lR();i.operation=function(t){var r=i.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},i.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var n in t)r[n]=t[n];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],o=0;o<r.retries;o++)s.push(this.createTimeout(o,r));return t&&t.forever&&!s.length&&s.push(this.createTimeout(o,r)),s.sort(function(a,l){return a-l}),s},i.createTimeout=function(t,r){var n=r.randomize?Math.random()+1:1,s=Math.round(n*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return s=Math.min(s,r.maxTimeout),s},i.wrap=function(t,r,n){if(r instanceof Array&&(n=r,r=null),!n){n=[];for(var s in t)typeof t[s]=="function"&&n.push(s)}for(var o=0;o<n.length;o++){var a=n[o],l=t[a];t[a]=(function(c){var d=i.operation(r),h=Array.prototype.slice.call(arguments,1),g=h.pop();h.push(function(v){d.retry(v)||(v&&(arguments[0]=d.mainError()),g.apply(this,arguments))}),d.attempt(function(){c.apply(t,h)})}).bind(t,l),t[a].options=r}}}(ku)),ku}var Pu,jf;function cR(){return jf||(jf=1,Pu=uR()),Pu}var qf;function dR(){if(qf)return xs.exports;qf=1;const i=cR(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class t extends Error{constructor(a){super(),a instanceof Error?(this.originalError=a,{message:a}=a):(this.originalError=new Error(a),this.originalError.stack=this.stack),this.name="AbortError",this.message=a}}const r=(o,a,l)=>{const u=l.retries-(a-1);return o.attemptNumber=a,o.retriesLeft=u,o},n=o=>e.includes(o),s=(o,a)=>new Promise((l,u)=>{a={onFailedAttempt:()=>{},retries:10,...a};const c=i.operation(a);c.attempt(async d=>{try{l(await o(d))}catch(h){if(!(h instanceof Error)){u(new TypeError(`Non-error was thrown: "${h}". You should only throw errors.`));return}if(h instanceof t)c.stop(),u(h.originalError);else if(h instanceof TypeError&&!n(h.message))c.stop(),u(h);else{r(h,d,a);try{await a.onFailedAttempt(h)}catch(g){u(g);return}c.retry(h)||u(c.mainError())}}})});return xs.exports=s,xs.exports.default=s,xs.exports.AbortError=t,xs.exports}var hR=dR();const ly=Hl(hR);let $l=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e==null?void 0:e[this.name]),!t&&this.altName&&(t=e==null?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class zl extends $l{constructor(){super(...arguments),f(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class ut extends $l{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var Mu={},Ks={},Fs={},Vf;function uy(){if(Vf)return Fs;Vf=1,Object.defineProperty(Fs,"__esModule",{value:!0}),Fs.NamespacedMap=void 0;function i(l,u){var c=typeof Symbol<"u"&&l[Symbol.iterator]||l["@@iterator"];if(!c){if(Array.isArray(l)||(c=e(l))||u){c&&(l=c);var d=0,h=function(){};return{s:h,n:function(){return d>=l.length?{done:!0}:{done:!1,value:l[d++]}},e:function(R){throw R},f:h}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var g=!0,v=!1,m;return{s:function(){c=c.call(l)},n:function(){var R=c.next();return g=R.done,R},e:function(R){v=!0,m=R},f:function(){try{!g&&c.return!=null&&c.return()}finally{if(v)throw m}}}}function e(l,u){if(l){if(typeof l=="string")return t(l,u);var c=Object.prototype.toString.call(l).slice(8,-1);if(c==="Object"&&l.constructor&&(c=l.constructor.name),c==="Map"||c==="Set")return Array.from(l);if(c==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return t(l,u)}}function t(l,u){(u==null||u>l.length)&&(u=l.length);for(var c=0,d=new Array(u);c<u;c++)d[c]=l[c];return d}function r(l,u){if(!(l instanceof u))throw new TypeError("Cannot call a class as a function")}function n(l,u){for(var c=0;c<u.length;c++){var d=u[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(l,d.key,d)}}function s(l,u,c){return u&&n(l.prototype,u),Object.defineProperty(l,"prototype",{writable:!1}),l}function o(l,u,c){return u in l?Object.defineProperty(l,u,{value:c,enumerable:!0,configurable:!0,writable:!0}):l[u]=c,l}var a=function(){function l(u){if(r(this,l),o(this,"internalMap",new Map),u){var c=i(u),d;try{for(c.s();!(d=c.n()).done;){var h=d.value;this.set(h[0],h[1])}}catch(g){c.e(g)}finally{c.f()}}}return s(l,[{key:"get",value:function(c){return c.name&&this.internalMap.has(c.name)?this.internalMap.get(c.name):c.altName&&this.internalMap.has(c.altName)?this.internalMap.get(c.altName):null}},{key:"set",value:function(c,d){c.name&&this.internalMap.set(c.name,d),c.altName&&this.internalMap.set(c.altName,d)}},{key:"has",value:function(c){return!!this.get(c)}},{key:"delete",value:function(c){c.name&&this.internalMap.delete(c.name),c.altName&&this.internalMap.delete(c.altName)}},{key:"hasNamespaced",value:function(c){return this.internalMap.has(c)}},{key:"getNamespaced",value:function(c){return this.internalMap.get(c)}}]),l}();return Fs.NamespacedMap=a,Fs}var Bs={},Wf;function ks(){if(Wf)return Bs;Wf=1;function i(v){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},i(v)}Object.defineProperty(Bs,"__esModule",{value:!0}),Bs.InvalidEventError=void 0;function e(v,m,E){return Object.defineProperty(v,"prototype",{writable:!1}),v}function t(v,m){if(!(v instanceof m))throw new TypeError("Cannot call a class as a function")}function r(v,m){if(typeof m!="function"&&m!==null)throw new TypeError("Super expression must either be null or a function");v.prototype=Object.create(m&&m.prototype,{constructor:{value:v,writable:!0,configurable:!0}}),Object.defineProperty(v,"prototype",{writable:!1}),m&&d(v,m)}function n(v){var m=u();return function(){var R=h(v),_;if(m){var T=h(this).constructor;_=Reflect.construct(R,arguments,T)}else _=R.apply(this,arguments);return s(this,_)}}function s(v,m){if(m&&(i(m)==="object"||typeof m=="function"))return m;if(m!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return o(v)}function o(v){if(v===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return v}function a(v){var m=typeof Map=="function"?new Map:void 0;return a=function(R){if(R===null||!c(R))return R;if(typeof R!="function")throw new TypeError("Super expression must either be null or a function");if(typeof m<"u"){if(m.has(R))return m.get(R);m.set(R,_)}function _(){return l(R,arguments,h(this).constructor)}return _.prototype=Object.create(R.prototype,{constructor:{value:_,enumerable:!1,writable:!0,configurable:!0}}),d(_,R)},a(v)}function l(v,m,E){return u()?l=Reflect.construct:l=function(_,T,b){var I=[null];I.push.apply(I,T);var y=Function.bind.apply(_,I),C=new y;return b&&d(C,b.prototype),C},l.apply(null,arguments)}function u(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function c(v){return Function.toString.call(v).indexOf("[native code]")!==-1}function d(v,m){return d=Object.setPrototypeOf||function(R,_){return R.__proto__=_,R},d(v,m)}function h(v){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(E){return E.__proto__||Object.getPrototypeOf(E)},h(v)}var g=function(v){r(E,v);var m=n(E);function E(R){return t(this,E),m.call(this,R)}return e(E)}(a(Error));return Bs.InvalidEventError=g,Bs}var Wi={},js={},qs={},Gf;function ga(){if(Gf)return qs;Gf=1,Object.defineProperty(qs,"__esModule",{value:!0}),qs.ExtensibleEvent=void 0;function i(n,s){if(!(n instanceof s))throw new TypeError("Cannot call a class as a function")}function e(n,s){for(var o=0;o<s.length;o++){var a=s[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(n,a.key,a)}}function t(n,s,o){return s&&e(n.prototype,s),Object.defineProperty(n,"prototype",{writable:!1}),n}var r=function(){function n(s){i(this,n),this.wireFormat=s}return t(n,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),n}();return qs.ExtensibleEvent=r,qs}var Vs={},Hf;function cy(){if(Hf)return Vs;Hf=1,Object.defineProperty(Vs,"__esModule",{value:!0}),Vs.isOptionalAString=i,Vs.isProvided=e;function i(t){return e(t)&&typeof t=="string"}function e(t){return t!=null}return Vs}var or={},ui={},$f;function Os(){if($f)return ui;$f=1;function i(g){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},i(g)}Object.defineProperty(ui,"__esModule",{value:!0}),ui.UnstableValue=ui.NamespacedValue=void 0;function e(g,v){if(typeof v!="function"&&v!==null)throw new TypeError("Super expression must either be null or a function");g.prototype=Object.create(v&&v.prototype,{constructor:{value:g,writable:!0,configurable:!0}}),Object.defineProperty(g,"prototype",{writable:!1}),v&&t(g,v)}function t(g,v){return t=Object.setPrototypeOf||function(E,R){return E.__proto__=R,E},t(g,v)}function r(g){var v=o();return function(){var E=a(g),R;if(v){var _=a(this).constructor;R=Reflect.construct(E,arguments,_)}else R=E.apply(this,arguments);return n(this,R)}}function n(g,v){if(v&&(i(v)==="object"||typeof v=="function"))return v;if(v!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return s(g)}function s(g){if(g===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return g}function o(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function a(g){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(m){return m.__proto__||Object.getPrototypeOf(m)},a(g)}function l(g,v){if(!(g instanceof v))throw new TypeError("Cannot call a class as a function")}function u(g,v){for(var m=0;m<v.length;m++){var E=v[m];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(g,E.key,E)}}function c(g,v,m){return v&&u(g.prototype,v),Object.defineProperty(g,"prototype",{writable:!1}),g}var d=function(){function g(v,m){if(l(this,g),this.stable=v,this.unstable=m,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return c(g,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(m){return!!this.name&&this.name===m||!!this.altName&&this.altName===m}},{key:"findIn",value:function(m){var E;return this.name&&(E=m==null?void 0:m[this.name]),!E&&this.altName&&(E=m==null?void 0:m[this.altName]),E}},{key:"includedIn",value:function(m){var E=!1;return this.name&&(E=m.includes(this.name)),!E&&this.altName&&(E=m.includes(this.altName)),E}}]),g}();ui.NamespacedValue=d;var h=function(g){e(m,g);var v=r(m);function m(E,R){var _;if(l(this,m),_=v.call(this,E,R),!_.unstable)throw new Error("Unstable value must be supplied");return _}return c(m,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),m}(d);return ui.UnstableValue=h,ui}var zf;function en(){if(zf)return or;zf=1,Object.defineProperty(or,"__esModule",{value:!0}),or.M_TEXT=or.M_NOTICE=or.M_MESSAGE=or.M_HTML=or.M_EMOTE=void 0;var i=Os(),e=new i.UnstableValue("m.message","org.matrix.msc1767.message");or.M_MESSAGE=e;var t=new i.UnstableValue("m.text","org.matrix.msc1767.text");or.M_TEXT=t;var r=new i.UnstableValue("m.html","org.matrix.msc1767.html");or.M_HTML=r;var n=new i.UnstableValue("m.emote","org.matrix.msc1767.emote");or.M_EMOTE=n;var s=new i.UnstableValue("m.notice","org.matrix.msc1767.notice");return or.M_NOTICE=s,or}var Ta={},Jf;function Bi(){if(Jf)return Ta;Jf=1,Object.defineProperty(Ta,"__esModule",{value:!0}),Ta.isEventTypeSame=i;function i(e,t){if(typeof e=="string")return typeof t=="string"?t===e:t.matches(e);if(typeof t=="string")return e.matches(t);var r=t,n=e;return r.matches(n.name)||r.matches(n.altName)}return Ta}var Yf;function ji(){if(Yf)return js;Yf=1;function i(b){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},i(b)}Object.defineProperty(js,"__esModule",{value:!0}),js.MessageEvent=void 0;var e=ga(),t=cy(),r=ks(),n=en(),s=Bi();function o(b,I){var y=Object.keys(b);if(Object.getOwnPropertySymbols){var C=Object.getOwnPropertySymbols(b);I&&(C=C.filter(function(w){return Object.getOwnPropertyDescriptor(b,w).enumerable})),y.push.apply(y,C)}return y}function a(b){for(var I=1;I<arguments.length;I++){var y=arguments[I]!=null?arguments[I]:{};I%2?o(Object(y),!0).forEach(function(C){_(b,C,y[C])}):Object.getOwnPropertyDescriptors?Object.defineProperties(b,Object.getOwnPropertyDescriptors(y)):o(Object(y)).forEach(function(C){Object.defineProperty(b,C,Object.getOwnPropertyDescriptor(y,C))})}return b}function l(b,I){if(!(b instanceof I))throw new TypeError("Cannot call a class as a function")}function u(b,I){for(var y=0;y<I.length;y++){var C=I[y];C.enumerable=C.enumerable||!1,C.configurable=!0,"value"in C&&(C.writable=!0),Object.defineProperty(b,C.key,C)}}function c(b,I,y){return I&&u(b.prototype,I),y&&u(b,y),Object.defineProperty(b,"prototype",{writable:!1}),b}function d(b,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");b.prototype=Object.create(I&&I.prototype,{constructor:{value:b,writable:!0,configurable:!0}}),Object.defineProperty(b,"prototype",{writable:!1}),I&&h(b,I)}function h(b,I){return h=Object.setPrototypeOf||function(C,w){return C.__proto__=w,C},h(b,I)}function g(b){var I=E();return function(){var C=R(b),w;if(I){var D=R(this).constructor;w=Reflect.construct(C,arguments,D)}else w=C.apply(this,arguments);return v(this,w)}}function v(b,I){if(I&&(i(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return m(b)}function m(b){if(b===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b}function E(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function R(b){return R=Object.setPrototypeOf?Object.getPrototypeOf:function(y){return y.__proto__||Object.getPrototypeOf(y)},R(b)}function _(b,I,y){return I in b?Object.defineProperty(b,I,{value:y,enumerable:!0,configurable:!0,writable:!0}):b[I]=y,b}var T=function(b){d(y,b);var I=g(y);function y(C){var w;l(this,y),w=I.call(this,C),_(m(w),"text",void 0),_(m(w),"html",void 0),_(m(w),"renderings",void 0);var D=n.M_MESSAGE.findIn(w.wireContent),x=n.M_TEXT.findIn(w.wireContent),G=n.M_HTML.findIn(w.wireContent);if((0,t.isProvided)(D)){if(!Array.isArray(D))throw new r.InvalidEventError("m.message contents must be an array");var oe=D.find(function(Ee){return!(0,t.isProvided)(Ee.mimetype)||Ee.mimetype==="text/plain"}),de=D.find(function(Ee){return Ee.mimetype==="text/html"});if(!oe)throw new r.InvalidEventError("m.message is missing a plain text representation");w.text=oe.body,w.html=de==null?void 0:de.body,w.renderings=D}else if((0,t.isOptionalAString)(x))w.text=x,w.html=G,w.renderings=[{body:x,mimetype:"text/plain"}],w.html&&w.renderings.push({body:w.html,mimetype:"text/html"});else throw new r.InvalidEventError("Missing textual representation for event");return w}return c(y,[{key:"isEmote",get:function(){return n.M_EMOTE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return n.M_NOTICE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(w){return(0,s.isEventTypeSame)(w,n.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var w=_({},n.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var D=this.renderings[0].mimetype;(D===void 0||D==="text/plain")&&(w=_({},n.M_TEXT.name,this.renderings[0].body))}return w}},{key:"serialize",value:function(){var w;return{type:"m.room.message",content:a(a({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(w=this.html)!==null&&w!==void 0?w:void 0})}}}],[{key:"from",value:function(w,D){var x;return new y({type:n.M_MESSAGE.name,content:(x={},_(x,n.M_TEXT.name,w),_(x,n.M_HTML.name,D),x)})}}]),y}(e.ExtensibleEvent);return js.MessageEvent=T,js}var Ws={},Qf;function th(){if(Qf)return Ws;Qf=1;function i(_){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},i(_)}Object.defineProperty(Ws,"__esModule",{value:!0}),Ws.NoticeEvent=void 0;var e=ji(),t=en(),r=Bi();function n(_,T,b){return T in _?Object.defineProperty(_,T,{value:b,enumerable:!0,configurable:!0,writable:!0}):_[T]=b,_}function s(_,T){if(!(_ instanceof T))throw new TypeError("Cannot call a class as a function")}function o(_,T){for(var b=0;b<T.length;b++){var I=T[b];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(_,I.key,I)}}function a(_,T,b){return T&&o(_.prototype,T),b&&o(_,b),Object.defineProperty(_,"prototype",{writable:!1}),_}function l(){return typeof Reflect<"u"&&Reflect.get?l=Reflect.get:l=function(T,b,I){var y=u(T,b);if(y){var C=Object.getOwnPropertyDescriptor(y,b);return C.get?C.get.call(arguments.length<3?T:I):C.value}},l.apply(this,arguments)}function u(_,T){for(;!Object.prototype.hasOwnProperty.call(_,T)&&(_=E(_),_!==null););return _}function c(_,T){if(typeof T!="function"&&T!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(T&&T.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),T&&d(_,T)}function d(_,T){return d=Object.setPrototypeOf||function(I,y){return I.__proto__=y,I},d(_,T)}function h(_){var T=m();return function(){var I=E(_),y;if(T){var C=E(this).constructor;y=Reflect.construct(I,arguments,C)}else y=I.apply(this,arguments);return g(this,y)}}function g(_,T){if(T&&(i(T)==="object"||typeof T=="function"))return T;if(T!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return v(_)}function v(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}function m(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function E(_){return E=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},E(_)}var R=function(_){c(b,_);var T=h(b);function b(I){return s(this,b),T.call(this,I)}return a(b,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(y){return(0,r.isEventTypeSame)(y,t.M_NOTICE)||l(E(b.prototype),"isEquivalentTo",this).call(this,y)}},{key:"serialize",value:function(){var y=l(E(b.prototype),"serialize",this).call(this);return y.content.msgtype="m.notice",y}}],[{key:"from",value:function(y,C){var w;return new b({type:t.M_NOTICE.name,content:(w={},n(w,t.M_TEXT.name,y),n(w,t.M_HTML.name,C),w)})}}]),b}(e.MessageEvent);return Ws.NoticeEvent=R,Ws}var Gs={},Xf;function rh(){if(Xf)return Gs;Xf=1;function i(_){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},i(_)}Object.defineProperty(Gs,"__esModule",{value:!0}),Gs.EmoteEvent=void 0;var e=ji(),t=en(),r=Bi();function n(_,T,b){return T in _?Object.defineProperty(_,T,{value:b,enumerable:!0,configurable:!0,writable:!0}):_[T]=b,_}function s(_,T){if(!(_ instanceof T))throw new TypeError("Cannot call a class as a function")}function o(_,T){for(var b=0;b<T.length;b++){var I=T[b];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(_,I.key,I)}}function a(_,T,b){return T&&o(_.prototype,T),b&&o(_,b),Object.defineProperty(_,"prototype",{writable:!1}),_}function l(){return typeof Reflect<"u"&&Reflect.get?l=Reflect.get:l=function(T,b,I){var y=u(T,b);if(y){var C=Object.getOwnPropertyDescriptor(y,b);return C.get?C.get.call(arguments.length<3?T:I):C.value}},l.apply(this,arguments)}function u(_,T){for(;!Object.prototype.hasOwnProperty.call(_,T)&&(_=E(_),_!==null););return _}function c(_,T){if(typeof T!="function"&&T!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(T&&T.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),T&&d(_,T)}function d(_,T){return d=Object.setPrototypeOf||function(I,y){return I.__proto__=y,I},d(_,T)}function h(_){var T=m();return function(){var I=E(_),y;if(T){var C=E(this).constructor;y=Reflect.construct(I,arguments,C)}else y=I.apply(this,arguments);return g(this,y)}}function g(_,T){if(T&&(i(T)==="object"||typeof T=="function"))return T;if(T!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return v(_)}function v(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}function m(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function E(_){return E=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},E(_)}var R=function(_){c(b,_);var T=h(b);function b(I){return s(this,b),T.call(this,I)}return a(b,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(y){return(0,r.isEventTypeSame)(y,t.M_EMOTE)||l(E(b.prototype),"isEquivalentTo",this).call(this,y)}},{key:"serialize",value:function(){var y=l(E(b.prototype),"serialize",this).call(this);return y.content.msgtype="m.emote",y}}],[{key:"from",value:function(y,C){var w;return new b({type:t.M_EMOTE.name,content:(w={},n(w,t.M_TEXT.name,y),n(w,t.M_HTML.name,C),w)})}}]),b}(e.MessageEvent);return Gs.EmoteEvent=R,Gs}var Zf;function dy(){if(Zf)return Wi;Zf=1,Object.defineProperty(Wi,"__esModule",{value:!0}),Wi.LEGACY_M_ROOM_MESSAGE=void 0,Wi.parseMRoomMessage=u;var i=ji(),e=th(),t=rh(),r=Os(),n=en();function s(c,d){var h=Object.keys(c);if(Object.getOwnPropertySymbols){var g=Object.getOwnPropertySymbols(c);d&&(g=g.filter(function(v){return Object.getOwnPropertyDescriptor(c,v).enumerable})),h.push.apply(h,g)}return h}function o(c){for(var d=1;d<arguments.length;d++){var h=arguments[d]!=null?arguments[d]:{};d%2?s(Object(h),!0).forEach(function(g){a(c,g,h[g])}):Object.getOwnPropertyDescriptors?Object.defineProperties(c,Object.getOwnPropertyDescriptors(h)):s(Object(h)).forEach(function(g){Object.defineProperty(c,g,Object.getOwnPropertyDescriptor(h,g))})}return c}function a(c,d,h){return d in c?Object.defineProperty(c,d,{value:h,enumerable:!0,configurable:!0,writable:!0}):c[d]=h,c}var l=new r.NamespacedValue("m.room.message");Wi.LEGACY_M_ROOM_MESSAGE=l;function u(c){var d,h,g;if(n.M_MESSAGE.findIn(c.content)||n.M_TEXT.findIn(c.content))return new i.MessageEvent(c);var v=(d=c.content)===null||d===void 0?void 0:d.msgtype,m=(h=c.content)===null||h===void 0?void 0:h.body,E=((g=c.content)===null||g===void 0?void 0:g.format)==="org.matrix.custom.html"?c.content.formatted_body:null;if(v==="m.text"){var R;return new i.MessageEvent(o(o({},c),{},{content:o(o({},c.content),{},(R={},a(R,n.M_TEXT.name,m),a(R,n.M_HTML.name,E),R))}))}else if(v==="m.notice"){var _;return new e.NoticeEvent(o(o({},c),{},{content:o(o({},c.content),{},(_={},a(_,n.M_TEXT.name,m),a(_,n.M_HTML.name,E),_))}))}else if(v==="m.emote"){var T;return new t.EmoteEvent(o(o({},c),{},{content:o(o({},c.content),{},(T={},a(T,n.M_TEXT.name,m),a(T,n.M_HTML.name,E),T))}))}else return null}return Wi}var Ia={},ev;function hy(){if(ev)return Ia;ev=1,Object.defineProperty(Ia,"__esModule",{value:!0}),Ia.parseMMessage=n;var i=ji(),e=en(),t=rh(),r=th();function n(s){return e.M_EMOTE.matches(s.type)?new t.EmoteEvent(s):e.M_NOTICE.matches(s.type)?new r.NoticeEvent(s):new i.MessageEvent(s)}return Ia}var ar={},tv;function Ps(){if(tv)return ar;tv=1,Object.defineProperty(ar,"__esModule",{value:!0}),ar.M_POLL_START=ar.M_POLL_RESPONSE=ar.M_POLL_KIND_UNDISCLOSED=ar.M_POLL_KIND_DISCLOSED=ar.M_POLL_END=void 0;var i=Os(),e=new i.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");ar.M_POLL_KIND_DISCLOSED=e;var t=new i.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");ar.M_POLL_KIND_UNDISCLOSED=t;var r=new i.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");ar.M_POLL_START=r;var n=new i.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");ar.M_POLL_RESPONSE=n;var s=new i.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");return ar.M_POLL_END=s,ar}var Ca={},ci={},rv;function fy(){if(rv)return ci;rv=1;function i(X){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(re){return typeof re}:function(re){return re&&typeof Symbol=="function"&&re.constructor===Symbol&&re!==Symbol.prototype?"symbol":typeof re},i(X)}Object.defineProperty(ci,"__esModule",{value:!0}),ci.PollStartEvent=ci.PollAnswerSubevent=void 0;var e=Ps(),t=ji(),r=en(),n=ks(),s=Os(),o=Bi(),a=ga();function l(X){return h(X)||d(X)||c(X)||u()}function u(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function c(X,re){if(X){if(typeof X=="string")return g(X,re);var Z=Object.prototype.toString.call(X).slice(8,-1);if(Z==="Object"&&X.constructor&&(Z=X.constructor.name),Z==="Map"||Z==="Set")return Array.from(X);if(Z==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(Z))return g(X,re)}}function d(X){if(typeof Symbol<"u"&&X[Symbol.iterator]!=null||X["@@iterator"]!=null)return Array.from(X)}function h(X){if(Array.isArray(X))return g(X)}function g(X,re){(re==null||re>X.length)&&(re=X.length);for(var Z=0,ne=new Array(re);Z<re;Z++)ne[Z]=X[Z];return ne}function v(X,re){var Z=Object.keys(X);if(Object.getOwnPropertySymbols){var ne=Object.getOwnPropertySymbols(X);re&&(ne=ne.filter(function(ce){return Object.getOwnPropertyDescriptor(X,ce).enumerable})),Z.push.apply(Z,ne)}return Z}function m(X){for(var re=1;re<arguments.length;re++){var Z=arguments[re]!=null?arguments[re]:{};re%2?v(Object(Z),!0).forEach(function(ne){x(X,ne,Z[ne])}):Object.getOwnPropertyDescriptors?Object.defineProperties(X,Object.getOwnPropertyDescriptors(Z)):v(Object(Z)).forEach(function(ne){Object.defineProperty(X,ne,Object.getOwnPropertyDescriptor(Z,ne))})}return X}function E(X,re){if(!(X instanceof re))throw new TypeError("Cannot call a class as a function")}function R(X,re){for(var Z=0;Z<re.length;Z++){var ne=re[Z];ne.enumerable=ne.enumerable||!1,ne.configurable=!0,"value"in ne&&(ne.writable=!0),Object.defineProperty(X,ne.key,ne)}}function _(X,re,Z){return re&&R(X.prototype,re),Z&&R(X,Z),Object.defineProperty(X,"prototype",{writable:!1}),X}function T(X,re){if(typeof re!="function"&&re!==null)throw new TypeError("Super expression must either be null or a function");X.prototype=Object.create(re&&re.prototype,{constructor:{value:X,writable:!0,configurable:!0}}),Object.defineProperty(X,"prototype",{writable:!1}),re&&b(X,re)}function b(X,re){return b=Object.setPrototypeOf||function(ne,ce){return ne.__proto__=ce,ne},b(X,re)}function I(X){var re=w();return function(){var ne=D(X),ce;if(re){var we=D(this).constructor;ce=Reflect.construct(ne,arguments,we)}else ce=ne.apply(this,arguments);return y(this,ce)}}function y(X,re){if(re&&(i(re)==="object"||typeof re=="function"))return re;if(re!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return C(X)}function C(X){if(X===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return X}function w(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function D(X){return D=Object.setPrototypeOf?Object.getPrototypeOf:function(Z){return Z.__proto__||Object.getPrototypeOf(Z)},D(X)}function x(X,re,Z){return re in X?Object.defineProperty(X,re,{value:Z,enumerable:!0,configurable:!0,writable:!0}):X[re]=Z,X}var G=function(X){T(Z,X);var re=I(Z);function Z(ne){var ce;E(this,Z),ce=re.call(this,ne),x(C(ce),"id",void 0);var we=ne.content.id;if(!we||typeof we!="string")throw new n.InvalidEventError("Answer ID must be a non-empty string");return ce.id=we,ce}return _(Z,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:m({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(ce,we){return new Z({type:"org.matrix.sdk.poll.answer",content:x({id:ce},r.M_TEXT.name,we)})}}]),Z}(t.MessageEvent);ci.PollAnswerSubevent=G;var oe=function(X){T(Z,X);var re=I(Z);function Z(ne){var ce;E(this,Z),ce=re.call(this,ne),x(C(ce),"question",void 0),x(C(ce),"kind",void 0),x(C(ce),"rawKind",void 0),x(C(ce),"maxSelections",void 0),x(C(ce),"answers",void 0);var we=e.M_POLL_START.findIn(ce.wireContent);if(!we.question)throw new n.InvalidEventError("A question is required");if(ce.question=new t.MessageEvent({type:"org.matrix.sdk.poll.question",content:we.question}),ce.rawKind=we.kind,e.M_POLL_KIND_DISCLOSED.matches(ce.rawKind)?ce.kind=e.M_POLL_KIND_DISCLOSED:ce.kind=e.M_POLL_KIND_UNDISCLOSED,ce.maxSelections=Number.isFinite(we.max_selections)&&we.max_selections>0?we.max_selections:1,!Array.isArray(we.answers))throw new n.InvalidEventError("Poll answers must be an array");var Be=we.answers.slice(0,20).map(function(Q){return new G({type:"org.matrix.sdk.poll.answer",content:Q})});if(Be.length<=0)throw new n.InvalidEventError("No answers available");return ce.answers=Be,ce}return _(Z,[{key:"isEquivalentTo",value:function(ce){return(0,o.isEventTypeSame)(ce,e.M_POLL_START)}},{key:"serialize",value:function(){var ce;return{type:e.M_POLL_START.name,content:(ce={},x(ce,e.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(we){return we.serialize().content})}),x(ce,r.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(we,Be){return"".concat(Be+1,". ").concat(we.text)}).join(`
`))),ce)}}}],[{key:"from",value:function(ce,we,Be){var Q,le=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new Z({type:e.M_POLL_START.name,content:(Q={},x(Q,r.M_TEXT.name,ce),x(Q,e.M_POLL_START.name,{question:x({},r.M_TEXT.name,ce),kind:Be instanceof s.NamespacedValue?Be.name:Be,max_selections:le,answers:we.map(function(j){return x({id:Ee()},r.M_TEXT.name,j)})}),Q)})}}]),Z}(a.ExtensibleEvent);ci.PollStartEvent=oe;var de="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Ee(){return l(Array(16)).map(function(){return de.charAt(Math.floor(Math.random()*de.length))}).join("")}return ci}var Hs={},$s={},nv;function nh(){if(nv)return $s;nv=1,Object.defineProperty($s,"__esModule",{value:!0}),$s.REFERENCE_RELATION=void 0;var i=Os(),e=new i.NamespacedValue("m.reference");return $s.REFERENCE_RELATION=e,$s}var iv;function vy(){if(iv)return Hs;iv=1;function i(_){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(T){return typeof T}:function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},i(_)}Object.defineProperty(Hs,"__esModule",{value:!0}),Hs.PollResponseEvent=void 0;var e=ga(),t=Ps(),r=ks(),n=nh(),s=Bi();function o(_,T){if(!(_ instanceof T))throw new TypeError("Cannot call a class as a function")}function a(_,T){for(var b=0;b<T.length;b++){var I=T[b];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(_,I.key,I)}}function l(_,T,b){return T&&a(_.prototype,T),b&&a(_,b),Object.defineProperty(_,"prototype",{writable:!1}),_}function u(_,T){if(typeof T!="function"&&T!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(T&&T.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),T&&c(_,T)}function c(_,T){return c=Object.setPrototypeOf||function(I,y){return I.__proto__=y,I},c(_,T)}function d(_){var T=v();return function(){var I=m(_),y;if(T){var C=m(this).constructor;y=Reflect.construct(I,arguments,C)}else y=I.apply(this,arguments);return h(this,y)}}function h(_,T){if(T&&(i(T)==="object"||typeof T=="function"))return T;if(T!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return g(_)}function g(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}function v(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function m(_){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},m(_)}function E(_,T,b){return T in _?Object.defineProperty(_,T,{value:b,enumerable:!0,configurable:!0,writable:!0}):_[T]=b,_}var R=function(_){u(b,_);var T=d(b);function b(I){var y;o(this,b),y=T.call(this,I),E(g(y),"internalAnswerIds",void 0),E(g(y),"internalSpoiled",void 0),E(g(y),"pollEventId",void 0);var C=y.wireContent["m.relates_to"];if(!n.REFERENCE_RELATION.matches(C==null?void 0:C.rel_type)||typeof(C==null?void 0:C.event_id)!="string")throw new r.InvalidEventError("Relationship must be a reference to an event");return y.pollEventId=C.event_id,y.validateAgainst(null),y}return l(b,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(y){var C=t.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(C==null?void 0:C.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var w=C.answers;if(w.some(function(D){return typeof D!="string"})||w.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(y){if(w.some(function(D){return!y.answers.some(function(x){return x.id===D})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}w=w.slice(0,y.maxSelections)}this.internalAnswerIds=w,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(y){return(0,s.isEventTypeSame)(y,t.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:t.M_POLL_RESPONSE.name,content:E({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:this.pollEventId}},t.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(y,C){return new b({type:t.M_POLL_RESPONSE.name,content:E({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:C}},t.M_POLL_RESPONSE.name,{answers:y})})}}]),b}(e.ExtensibleEvent);return Hs.PollResponseEvent=R,Hs}var zs={},sv;function gy(){if(sv)return zs;sv=1;function i(y){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},i(y)}Object.defineProperty(zs,"__esModule",{value:!0}),zs.PollEndEvent=void 0;var e=Ps(),t=ks(),r=nh(),n=ji(),s=en(),o=Bi(),a=ga();function l(y,C){var w=Object.keys(y);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(y);C&&(D=D.filter(function(x){return Object.getOwnPropertyDescriptor(y,x).enumerable})),w.push.apply(w,D)}return w}function u(y){for(var C=1;C<arguments.length;C++){var w=arguments[C]!=null?arguments[C]:{};C%2?l(Object(w),!0).forEach(function(D){b(y,D,w[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(w)):l(Object(w)).forEach(function(D){Object.defineProperty(y,D,Object.getOwnPropertyDescriptor(w,D))})}return y}function c(y,C){if(!(y instanceof C))throw new TypeError("Cannot call a class as a function")}function d(y,C){for(var w=0;w<C.length;w++){var D=C[w];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(y,D.key,D)}}function h(y,C,w){return C&&d(y.prototype,C),w&&d(y,w),Object.defineProperty(y,"prototype",{writable:!1}),y}function g(y,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");y.prototype=Object.create(C&&C.prototype,{constructor:{value:y,writable:!0,configurable:!0}}),Object.defineProperty(y,"prototype",{writable:!1}),C&&v(y,C)}function v(y,C){return v=Object.setPrototypeOf||function(D,x){return D.__proto__=x,D},v(y,C)}function m(y){var C=_();return function(){var D=T(y),x;if(C){var G=T(this).constructor;x=Reflect.construct(D,arguments,G)}else x=D.apply(this,arguments);return E(this,x)}}function E(y,C){if(C&&(i(C)==="object"||typeof C=="function"))return C;if(C!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return R(y)}function R(y){if(y===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return y}function _(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function T(y){return T=Object.setPrototypeOf?Object.getPrototypeOf:function(w){return w.__proto__||Object.getPrototypeOf(w)},T(y)}function b(y,C,w){return C in y?Object.defineProperty(y,C,{value:w,enumerable:!0,configurable:!0,writable:!0}):y[C]=w,y}var I=function(y){g(w,y);var C=m(w);function w(D){var x;c(this,w),x=C.call(this,D),b(R(x),"pollEventId",void 0),b(R(x),"closingMessage",void 0);var G=x.wireContent["m.relates_to"];if(!r.REFERENCE_RELATION.matches(G==null?void 0:G.rel_type)||typeof(G==null?void 0:G.event_id)!="string")throw new t.InvalidEventError("Relationship must be a reference to an event");return x.pollEventId=G.event_id,x.closingMessage=new n.MessageEvent(x.wireFormat),x}return h(w,[{key:"isEquivalentTo",value:function(x){return(0,o.isEventTypeSame)(x,e.M_POLL_END)}},{key:"serialize",value:function(){return{type:e.M_POLL_END.name,content:u(b({"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:this.pollEventId}},e.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(x,G){var oe;return new w({type:e.M_POLL_END.name,content:(oe={"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:x}},b(oe,e.M_POLL_END.name,{}),b(oe,s.M_TEXT.name,G),oe)})}}]),w}(a.ExtensibleEvent);return zs.PollEndEvent=I,zs}var ov;function py(){if(ov)return Ca;ov=1,Object.defineProperty(Ca,"__esModule",{value:!0}),Ca.parseMPoll=n;var i=Ps(),e=fy(),t=vy(),r=gy();function n(s){return i.M_POLL_START.matches(s.type)?new e.PollStartEvent(s):i.M_POLL_RESPONSE.matches(s.type)?new t.PollResponseEvent(s):i.M_POLL_END.matches(s.type)?new r.PollEndEvent(s):null}return Ca}var av;function fR(){if(av)return Ks;av=1,Object.defineProperty(Ks,"__esModule",{value:!0}),Ks.ExtensibleEvents=void 0;var i=uy(),e=ks(),t=dy(),r=hy(),n=en(),s=Ps(),o=py();function a(m,E){var R=typeof Symbol<"u"&&m[Symbol.iterator]||m["@@iterator"];if(!R){if(Array.isArray(m)||(R=l(m))||E){R&&(m=R);var _=0,T=function(){};return{s:T,n:function(){return _>=m.length?{done:!0}:{done:!1,value:m[_++]}},e:function(w){throw w},f:T}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var b=!0,I=!1,y;return{s:function(){R=R.call(m)},n:function(){var w=R.next();return b=w.done,w},e:function(w){I=!0,y=w},f:function(){try{!b&&R.return!=null&&R.return()}finally{if(I)throw y}}}}function l(m,E){if(m){if(typeof m=="string")return u(m,E);var R=Object.prototype.toString.call(m).slice(8,-1);if(R==="Object"&&m.constructor&&(R=m.constructor.name),R==="Map"||R==="Set")return Array.from(m);if(R==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(R))return u(m,E)}}function u(m,E){(E==null||E>m.length)&&(E=m.length);for(var R=0,_=new Array(E);R<E;R++)_[R]=m[R];return _}function c(m,E){if(!(m instanceof E))throw new TypeError("Cannot call a class as a function")}function d(m,E){for(var R=0;R<E.length;R++){var _=E[R];_.enumerable=_.enumerable||!1,_.configurable=!0,"value"in _&&(_.writable=!0),Object.defineProperty(m,_.key,_)}}function h(m,E,R){return E&&d(m.prototype,E),R&&d(m,R),Object.defineProperty(m,"prototype",{writable:!1}),m}function g(m,E,R){return E in m?Object.defineProperty(m,E,{value:R,enumerable:!0,configurable:!0,writable:!0}):m[E]=R,m}var v=function(){function m(){c(this,m),g(this,"interpreters",new i.NamespacedMap([[t.LEGACY_M_ROOM_MESSAGE,t.parseMRoomMessage],[n.M_MESSAGE,r.parseMMessage],[n.M_EMOTE,r.parseMMessage],[n.M_NOTICE,r.parseMMessage],[s.M_POLL_START,o.parseMPoll],[s.M_POLL_RESPONSE,o.parseMPoll],[s.M_POLL_END,o.parseMPoll]])),g(this,"_unknownInterpretOrder",[n.M_MESSAGE])}return h(m,[{key:"unknownInterpretOrder",get:function(){var R;return(R=this._unknownInterpretOrder)!==null&&R!==void 0?R:[]},set:function(R){this._unknownInterpretOrder=R}},{key:"registerInterpreter",value:function(R,_){this.interpreters.set(R,_)}},{key:"parse",value:function(R){try{if(this.interpreters.hasNamespaced(R.type))return this.interpreters.getNamespaced(R.type)(R);var _=a(this.unknownInterpretOrder),T;try{for(_.s();!(T=_.n()).done;){var b=T.value;if(this.interpreters.has(b)){var I=this.interpreters.get(b)(R);if(I)return I}}}catch(y){_.e(y)}finally{_.f()}return null}catch(y){if(y instanceof e.InvalidEventError)return null;throw y}}}],[{key:"defaultInstance",get:function(){return m._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return m.defaultInstance.unknownInterpretOrder},set:function(R){m.defaultInstance.unknownInterpretOrder=R}},{key:"registerInterpreter",value:function(R,_){m.defaultInstance.registerInterpreter(R,_)}},{key:"parse",value:function(R){return m.defaultInstance.parse(R)}}]),m}();return Ks.ExtensibleEvents=v,g(v,"_defaultInstance",new v),Ks}var Au={},lv;function vR(){return lv||(lv=1,Object.defineProperty(Au,"__esModule",{value:!0})),Au}var di={},uv;function gR(){if(uv)return di;uv=1,Object.defineProperty(di,"__esModule",{value:!0}),di.LegacyMsgType=void 0,di.isEventLike=t;var i=en(),e;di.LegacyMsgType=e,function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"}(e||(di.LegacyMsgType=e={}));function t(r,n){var s=r.content;return n===e.Text?i.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&(s==null?void 0:s.msgtype)==="m.text":n===e.Emote?i.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&(s==null?void 0:s.msgtype)==="m.emote":n===e.Notice?i.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&(s==null?void 0:s.msgtype)==="m.notice":!1}return di}var cv;function pR(){return cv||(cv=1,function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=fR();Object.keys(e).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===e[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return e[y]}})});var t=vR();Object.keys(t).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===t[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return t[y]}})});var r=ks();Object.keys(r).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===r[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return r[y]}})});var n=Os();Object.keys(n).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===n[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return n[y]}})});var s=uy();Object.keys(s).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===s[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return s[y]}})});var o=cy();Object.keys(o).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===o[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return o[y]}})});var a=gR();Object.keys(a).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===a[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return a[y]}})});var l=Bi();Object.keys(l).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===l[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return l[y]}})});var u=dy();Object.keys(u).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===u[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return u[y]}})});var c=hy();Object.keys(c).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===c[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return c[y]}})});var d=py();Object.keys(d).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===d[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return d[y]}})});var h=nh();Object.keys(h).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===h[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return h[y]}})});var g=ga();Object.keys(g).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===g[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return g[y]}})});var v=en();Object.keys(v).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===v[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return v[y]}})});var m=ji();Object.keys(m).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===m[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return m[y]}})});var E=rh();Object.keys(E).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===E[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return E[y]}})});var R=th();Object.keys(R).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===R[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return R[y]}})});var _=Ps();Object.keys(_).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===_[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return _[y]}})});var T=fy();Object.keys(T).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===T[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return T[y]}})});var b=vy();Object.keys(b).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===b[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return b[y]}})});var I=gy();Object.keys(I).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===I[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return I[y]}})})}(Mu)),Mu}var sr=pR();function ih(i){return i!=null}var mR=new sr.UnstableValue("m.message","org.matrix.msc1767.message"),sh=new sr.UnstableValue("m.text","org.matrix.msc1767.text"),yR=new sr.UnstableValue("m.html","org.matrix.msc1767.html"),my=new sr.NamespacedValue("m.reference");function SR(i,e){if(typeof i=="string")return typeof e=="string"?e===i:e.matches(i);if(typeof e=="string")return i.matches(e);var t=e,r=i;return t.matches(r.name)||ih(r.altName)&&t.matches(r.altName)}var Ss=function(i){return i.Self="m.self",i.Pin="m.pin",i}({}),pa=new ut("m.asset","org.matrix.msc3488.asset"),ri=new ut("m.ts","org.matrix.msc3488.ts"),ma=new ut("m.location","org.matrix.msc3488.location"),Gt=function(i){return i.Read="m.read",i.FullyRead="m.fully_read",i.ReadPrivate="m.read.private",i}({}),ya="main";function dv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function hv(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?dv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):dv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Du=new Map;function Uu(i){return i instanceof String&&(i=i.toString()),Du.has(i)||Du.set(i,i),Du.get(i)}function gl(i,e){var t=e??new URLSearchParams,r=function(a){s!=null&&(Array.isArray(s)?s.forEach(l=>{t.append(a,String(l))}):t.append(a,String(s)))};for(var[n,s]of Object.entries(i))r(n);return t}function ka(i,e,t){var r=hv(hv({},t),{},{[e]:t[i]});return delete r[i],r}function me(i,e){for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];r!=null&&(i=i.replace(t,encodeURIComponent(r)))}return i}function pl(i,e,t){var r;if(t){for(r=i.length-1;r>=0;r--)if(e(i[r],r,i))return i.splice(r,1),!0}else for(r=0;r<i.length;r++)if(e(i[r],r,i))return i.splice(r,1),!0;return!1}function yy(i,e){for(var t of e)if(!i.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function Jl(i){return JSON.parse(JSON.stringify(i))}function Ki(i,e){if(i===e)return!0;if(typeof i!=typeof e)return!1;if(typeof i=="number"&&isNaN(i)&&isNaN(e))return!0;if(i===null||e===null)return i===e;if(!(i instanceof Object)||i.constructor!==e.constructor||i.prototype!==e.prototype)return!1;if(i instanceof RegExp||i instanceof Date)return i.toString()===e.toString();if(Array.isArray(i)){if(i.length!==e.length)return!1;for(var t=0;t<i.length;t++)if(!Ki(i[t],e[t]))return!1}else{for(var r in e)if(e.hasOwnProperty(r)!==i.hasOwnProperty(r))return!1;for(var n in i)if(e.hasOwnProperty(n)!==i.hasOwnProperty(n)||!Ki(i[n],e[n]))return!1}return!0}function kc(i){if(typeof i!="object"||i==null||Array.isArray(i))return i;var e=[];for(var[t,r]of Object.entries(i))e.push([t,kc(r)]);return e.sort((n,s)=>Ya(n[0],s[0])),e}function fv(i){return typeof i=="number"&&isFinite(i)}function Di(i){return typeof i=="string"?aR(i.normalize("NFD").replace(bR,"")):""}function Oc(i){return typeof i=="string"?i.replace(/[\u202d-\u202e]/g,""):""}function _R(i){return Di(i.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var bR=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function Sy(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _y(i){return Sy(i).replace(/\\\*/g,".*").replace(/\?/g,".")}function Lu(i){return i!=null&&i.endsWith("/")?i.slice(0,-1):i}function Zo(i,e){return new Promise(t=>{setTimeout(t,i,e)})}function Gk(i,e,t){return Pc.apply(this,arguments)}function Pc(){return Pc=S(function*(i,e,t){var r=Date.now();try{return yield t()}finally{var n=Date.now();i.debug("[Perf]: ".concat(e," took ").concat(n-r,"ms"))}}),Pc.apply(this,arguments)}function ER(){return new Promise(i=>setTimeout(i))}function by(i){return i==null}function ni(){var i,e,t=new Promise((r,n)=>{i=r,e=n});return{resolve:i,reject:e,promise:t}}function rs(i,e){return Mc.apply(this,arguments)}function Mc(){return Mc=S(function*(i,e){for(var t of i)yield e(yield t)}),Mc.apply(this,arguments)}function Ei(i){return Promise.resolve(i())}function wR(i,e){return Ac.apply(this,arguments)}function Ac(){return Ac=S(function*(i,e){for(var t=[],r=0;r<i.length;r+=e)t.push(...yield Promise.all(i.slice(r,r+e).map(n=>n())));return t}),Ac.apply(this,arguments)}function RR(i){return ly(e=>i(e),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var Qn=(()=>{for(var i="",e=32;e<=126;e++)i+=String.fromCharCode(e);return i})();function vv(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Qn;return i.padEnd(e,t[0])}function ea(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Qn,t=BigInt(e.length);if(i<=t){var r;return(r=e[Number(i)-1])!==null&&r!==void 0?r:""}var n=i/t,s=Number(i%t)-1;return s<0&&(n-=BigInt(Math.abs(s)),s=Number(t)-1),ea(n,e)+e[s]}function ml(i){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Qn,t=BigInt(e.length),r=BigInt(0),n=i.length-1,s=BigInt(0);n>=0;n--,s++){var o=i.charCodeAt(n)-e.charCodeAt(0);r+=BigInt(1+o)*t**s}return r}function TR(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Qn,r=Math.max(i.length,e.length),n=ml(vv(i,r,t),t),s=ml(vv(e,r,t),t),o=(n+s)/BigInt(2);return o===n||o==s?ea(o,t)+t[0]:ea(o,t)}function Js(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Qn;return ea(ml(i,e)+BigInt(1),e)}function gv(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Qn;return ea(ml(i,e)-BigInt(1),e)}function Ya(i,e){return i<e?-1:i>e?1:0}var IR=new Intl.Collator;function CR(i,e){return IR.compare(i,e)}function Ey(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[r,n]of Object.entries(e)){if(i[r]instanceof Object&&n){Ey(i[r],n);continue}if(n!=null||!t){Xr(i,r,n);continue}}return i}function pv(i){var e;return(e=ri.findIn(i.getContent()))!==null&&e!==void 0?e:-1}function kR(i,e){return pv(e)-pv(i)}function oh(i){return[Gt.Read,Gt.ReadPrivate].includes(i)}function mv(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(o,a)=>o===a;if(i.size!==e.size)return!1;for(var[r,n]of i){var s=e.get(r);if(s===void 0||!t(n,s))return!1}return!0}function wy(i){return i instanceof Map?Ui(i):Array.isArray(i)?i.map(e=>wy(e)):i}function Ui(i){var e=new Map;for(var[t,r]of i)e.set(t,wy(r));return Object.fromEntries(e.entries())}function No(i){return i==="__proto__"||i==="prototype"||i==="constructor"}function Xr(i,e,t){if(No(e))throw new Error("Trying to modify prototype or constructor");i[e]=t}function Cr(i){return!(No(i.room_id)||No(i.sender)||No(i.event_id))}class ht extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var Dc="migrationState",_s=function(i){return i[i.NOT_STARTED=0]="NOT_STARTED",i[i.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",i[i.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",i[i.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",i[i.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",i[i.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",i}({}),bs=50;function yv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Pn(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?yv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):yv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function hi(i,e){return encodeURIComponent(i)+"/"+encodeURIComponent(e)}function Nu(i){var e=i.split("/"),t=decodeURIComponent(e[0]),r=decodeURIComponent(e[1]);return{senderKey:t,sessionId:r}}class Yl{constructor(){f(this,"migrationState",_s.NOT_STARTED),f(this,"outgoingRoomKeyRequests",[]),f(this,"account",null),f(this,"crossSigningKeys",null),f(this,"privateKeys",{}),f(this,"sessions",{}),f(this,"sessionProblems",{}),f(this,"notifiedErrorDevices",{}),f(this,"inboundGroupSessions",{}),f(this,"inboundGroupSessionsWithheld",{}),f(this,"deviceData",null),f(this,"rooms",{}),f(this,"sessionsNeedingBackup",{}),f(this,"sharedHistoryInboundGroupSessions",{}),f(this,"parkedSharedHistory",new Map)}containsData(){var e=this;return S(function*(){return e.account!==null})()}startup(){var e=this;return S(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return S(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return S(function*(){t.migrationState=e})()}getOrAddOutgoingRoomKeyRequest(e){var t=e.requestBody;return Ei(()=>{var r=this._getOutgoingRoomKeyRequest(t);return r?(p.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),r):(p.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),this.outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(var t of this.outgoingRoomKeyRequests)if(Ki(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(var t of this.outgoingRoomKeyRequests)for(var r of e)if(t.state===r)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,r){var n=[];for(var s of this.outgoingRoomKeyRequests)for(var o of r)s.state===o&&s.recipients.some(a=>a.userId===e&&a.deviceId===t)&&n.push(s);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,r){for(var n of this.outgoingRoomKeyRequests)if(n.requestId===e)return n.state!==t?(p.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(n.state)),Promise.resolve(null)):(Object.assign(n,r),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(var r=0;r<this.outgoingRoomKeyRequests.length;r++){var n=this.outgoingRoomKeyRequests[r];if(n.requestId===e)return n.state!=t?(p.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")")),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(r,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){var n=this.privateKeys[r];t(n||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){var r=0;for(var n of Object.values(this.sessions))r+=Object.keys(n).length;t(r)}getEndToEndSession(e,t,r,n){var s=this.sessions[e]||{};n(s[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach(r=>{var[n,s]=r;Object.entries(s).forEach(o=>{var[a,l]=o;t(Pn(Pn({},l),{},{deviceKey:n,sessionId:a}))})})}storeEndToEndSession(e,t,r,n){var s=this.sessions[e];s===void 0&&(s={},this.sessions[e]=s),Xr(s,t,r)}storeEndToEndSessionProblem(e,t,r){var n=this;return S(function*(){var s=n.sessionProblems[e]=n.sessionProblems[e]||[];s.push({type:t,fixed:r,time:Date.now()}),s.sort((o,a)=>o.time-a.time)})()}getEndToEndSessionProblem(e,t){var r=this;return S(function*(){var n=r.sessionProblems[e]||[];if(!n.length)return null;var s=n[n.length-1];for(var o of n)if(o.time>t)return Object.assign({},o,{fixed:s.fixed});return s.fixed?null:s})()}filterOutNotifiedErrorDevices(e){var t=this;return S(function*(){var r=t.notifiedErrorDevices,n=[];for(var s of e){var{userId:o,deviceInfo:a}=s;o in r?a.deviceId in r[o]||(n.push(s),Xr(r[o],a.deviceId,!0)):(n.push(s),Xr(r,o,{[a.deviceId]:!0}))}return n})()}getEndToEndSessionsBatch(){var e=this;return S(function*(){var t=[];for(var r of Object.values(e.sessions))for(var n of Object.values(r))if(t.push(n),t.length>=bs)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return S(function*(){for(var{deviceKey:r,sessionId:n}of e){var s=t.sessions[r]||{};delete s[n],Object.keys(s).length===0&&delete t.sessions[r]}})()}getEndToEndInboundGroupSession(e,t,r,n){var s=hi(e,t);n(this.inboundGroupSessions[s]||null,this.inboundGroupSessionsWithheld[s]||null)}getAllEndToEndInboundGroupSessions(e,t){for(var r of Object.keys(this.inboundGroupSessions))t(Pn(Pn({},Nu(r)),{},{sessionData:this.inboundGroupSessions[r]}));t(null)}addEndToEndInboundGroupSession(e,t,r,n){var s=hi(e,t);this.inboundGroupSessions[s]===void 0&&(this.inboundGroupSessions[s]=r)}storeEndToEndInboundGroupSession(e,t,r,n){var s=hi(e,t);this.inboundGroupSessions[s]=r}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){var s=hi(e,t);this.inboundGroupSessionsWithheld[s]=r}countEndToEndInboundGroupSessions(){var e=this;return S(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return S(function*(){var t=[];for(var[r,n]of Object.entries(e.inboundGroupSessions))if(t.push(Pn(Pn({},Nu(r)),{},{sessionData:n,needsBackup:r in e.sessionsNeedingBackup})),t.length>=bs)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return S(function*(){for(var{senderKey:r,sessionId:n}of e){var s=hi(r,n);delete t.inboundGroupSessions[s]}})()}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,r){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){var t=[];for(var r in this.sessionsNeedingBackup)if(this.inboundGroupSessions[r]&&(t.push(Pn(Pn({},Nu(r)),{},{sessionData:this.inboundGroupSessions[r]})),e&&r.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(var t of e){var r=hi(t.senderKey,t.sessionId);delete this.sessionsNeedingBackup[r]}return Promise.resolve()}markSessionsNeedingBackup(e){for(var t of e){var r=hi(t.senderKey,t.sessionId);this.sessionsNeedingBackup[r]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,r){var n=this.sharedHistoryInboundGroupSessions[e]||[];n.push([t,r]),this.sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var r,n=(r=this.parkedSharedHistory.get(e))!==null&&r!==void 0?r:[];n.push(t),this.parkedSharedHistory.set(e,n)}takeParkedSharedHistory(e){var t,r=(t=this.parkedSharedHistory.get(e))!==null&&t!==void 0?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function Ql(i,e,t,r,n){var s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,o=arguments.length>6?arguments[6]:void 0,a=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(e.indexOf("mxc://")!==0)return s?e:"";a&&(o=!0);var l=e.slice(6),u;a?u="/_matrix/client/v1/media/download/":u="/_matrix/media/v3/download/";var c={};t&&(c.width=Math.round(t).toString()),r&&(c.height=Math.round(r).toString()),n&&(c.method=n),Object.keys(c).length>0&&(a?u="/_matrix/client/v1/media/thumbnail/":u="/_matrix/media/v3/thumbnail/"),typeof o=="boolean"&&(c.allow_redirect=JSON.stringify(o));var d=l.indexOf("#"),h="";d>=0&&(h=l.slice(d),l=l.slice(0,d));var g=Object.keys(c).length===0?"":"?"+gl(c);return i+u+l+g+h}var Oa={exports:{}},Sv;function Xl(){if(Sv)return Oa.exports;Sv=1;var i=typeof Reflect=="object"?Reflect:null,e=i&&typeof i.apply=="function"?i.apply:function(I,y,C){return Function.prototype.apply.call(I,y,C)},t;i&&typeof i.ownKeys=="function"?t=i.ownKeys:Object.getOwnPropertySymbols?t=function(I){return Object.getOwnPropertyNames(I).concat(Object.getOwnPropertySymbols(I))}:t=function(I){return Object.getOwnPropertyNames(I)};function r(b){console&&console.warn&&console.warn(b)}var n=Number.isNaN||function(I){return I!==I};function s(){s.init.call(this)}Oa.exports=s,Oa.exports.once=R,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(b){if(typeof b!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof b)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(b){if(typeof b!="number"||b<0||n(b))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+b+".");o=b}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(I){if(typeof I!="number"||I<0||n(I))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+I+".");return this._maxListeners=I,this};function l(b){return b._maxListeners===void 0?s.defaultMaxListeners:b._maxListeners}s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(I){for(var y=[],C=1;C<arguments.length;C++)y.push(arguments[C]);var w=I==="error",D=this._events;if(D!==void 0)w=w&&D.error===void 0;else if(!w)return!1;if(w){var x;if(y.length>0&&(x=y[0]),x instanceof Error)throw x;var G=new Error("Unhandled error."+(x?" ("+x.message+")":""));throw G.context=x,G}var oe=D[I];if(oe===void 0)return!1;if(typeof oe=="function")e(oe,this,y);else for(var de=oe.length,Ee=v(oe,de),C=0;C<de;++C)e(Ee[C],this,y);return!0};function u(b,I,y,C){var w,D,x;if(a(y),D=b._events,D===void 0?(D=b._events=Object.create(null),b._eventsCount=0):(D.newListener!==void 0&&(b.emit("newListener",I,y.listener?y.listener:y),D=b._events),x=D[I]),x===void 0)x=D[I]=y,++b._eventsCount;else if(typeof x=="function"?x=D[I]=C?[y,x]:[x,y]:C?x.unshift(y):x.push(y),w=l(b),w>0&&x.length>w&&!x.warned){x.warned=!0;var G=new Error("Possible EventEmitter memory leak detected. "+x.length+" "+String(I)+" listeners added. Use emitter.setMaxListeners() to increase limit");G.name="MaxListenersExceededWarning",G.emitter=b,G.type=I,G.count=x.length,r(G)}return b}s.prototype.addListener=function(I,y){return u(this,I,y,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(I,y){return u(this,I,y,!0)};function c(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(b,I,y){var C={fired:!1,wrapFn:void 0,target:b,type:I,listener:y},w=c.bind(C);return w.listener=y,C.wrapFn=w,w}s.prototype.once=function(I,y){return a(y),this.on(I,d(this,I,y)),this},s.prototype.prependOnceListener=function(I,y){return a(y),this.prependListener(I,d(this,I,y)),this},s.prototype.removeListener=function(I,y){var C,w,D,x,G;if(a(y),w=this._events,w===void 0)return this;if(C=w[I],C===void 0)return this;if(C===y||C.listener===y)--this._eventsCount===0?this._events=Object.create(null):(delete w[I],w.removeListener&&this.emit("removeListener",I,C.listener||y));else if(typeof C!="function"){for(D=-1,x=C.length-1;x>=0;x--)if(C[x]===y||C[x].listener===y){G=C[x].listener,D=x;break}if(D<0)return this;D===0?C.shift():m(C,D),C.length===1&&(w[I]=C[0]),w.removeListener!==void 0&&this.emit("removeListener",I,G||y)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(I){var y,C,w;if(C=this._events,C===void 0)return this;if(C.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):C[I]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete C[I]),this;if(arguments.length===0){var D=Object.keys(C),x;for(w=0;w<D.length;++w)x=D[w],x!=="removeListener"&&this.removeAllListeners(x);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(y=C[I],typeof y=="function")this.removeListener(I,y);else if(y!==void 0)for(w=y.length-1;w>=0;w--)this.removeListener(I,y[w]);return this};function h(b,I,y){var C=b._events;if(C===void 0)return[];var w=C[I];return w===void 0?[]:typeof w=="function"?y?[w.listener||w]:[w]:y?E(w):v(w,w.length)}s.prototype.listeners=function(I){return h(this,I,!0)},s.prototype.rawListeners=function(I){return h(this,I,!1)},s.listenerCount=function(b,I){return typeof b.listenerCount=="function"?b.listenerCount(I):g.call(b,I)},s.prototype.listenerCount=g;function g(b){var I=this._events;if(I!==void 0){var y=I[b];if(typeof y=="function")return 1;if(y!==void 0)return y.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function v(b,I){for(var y=new Array(I),C=0;C<I;++C)y[C]=b[C];return y}function m(b,I){for(;I+1<b.length;I++)b[I]=b[I+1];b.pop()}function E(b){for(var I=new Array(b.length),y=0;y<I.length;++y)I[y]=b[y].listener||b[y];return I}function R(b,I){return new Promise(function(y,C){function w(x){b.removeListener(I,D),C(x)}function D(){typeof b.removeListener=="function"&&b.removeListener("error",w),y([].slice.call(arguments))}T(b,I,D,{once:!0}),I!=="error"&&_(b,w,{once:!0})})}function _(b,I,y){typeof b.on=="function"&&T(b,"error",I,y)}function T(b,I,y,C){if(typeof b.on=="function")C.once?b.once(I,y):b.on(I,y);else if(typeof b.addEventListener=="function")b.addEventListener(I,function w(D){C.once&&b.removeEventListener(I,w),y(D)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof b)}return Oa.exports}var OR=Xl(),Ry=function(i){return i.NewListener="newListener",i.RemoveListener="removeListener",i.Error="error",i}({});class rt extends OR.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}emitPromised(e){var t=arguments,r=this;return S(function*(){for(var n=t.length,s=new Array(n>1?n-1:0),o=1;o<n;o++)s[o-1]=t[o];var a=r.listeners(e);return Promise.allSettled(a.map(l=>l(...s))).then(()=>a.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var ah=new ut("m.beacon_info","org.matrix.msc3672.beacon_info"),Uc=new ut("m.beacon","org.matrix.msc3672.beacon"),PR=new sr.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),MR=new sr.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),AR=new sr.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),ta=new sr.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),yl=new sr.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),F=function(i){return i.RoomCanonicalAlias="m.room.canonical_alias",i.RoomCreate="m.room.create",i.RoomJoinRules="m.room.join_rules",i.RoomMember="m.room.member",i.RoomThirdPartyInvite="m.room.third_party_invite",i.RoomPowerLevels="m.room.power_levels",i.RoomName="m.room.name",i.RoomTopic="m.room.topic",i.RoomAvatar="m.room.avatar",i.RoomPinnedEvents="m.room.pinned_events",i.RoomEncryption="m.room.encryption",i.RoomHistoryVisibility="m.room.history_visibility",i.RoomGuestAccess="m.room.guest_access",i.RoomServerAcl="m.room.server_acl",i.RoomTombstone="m.room.tombstone",i.RoomPredecessor="org.matrix.msc3946.room_predecessor",i.PolicyRuleUser="m.policy.rule.user",i.PolicyRuleRoom="m.policy.rule.room",i.PolicyRuleServer="m.policy.rule.server",i.SpaceChild="m.space.child",i.SpaceParent="m.space.parent",i.RoomRedaction="m.room.redaction",i.RoomMessage="m.room.message",i.RoomMessageEncrypted="m.room.encrypted",i.Sticker="m.sticker",i.CallInvite="m.call.invite",i.CallCandidates="m.call.candidates",i.CallAnswer="m.call.answer",i.CallHangup="m.call.hangup",i.CallReject="m.call.reject",i.CallSelectAnswer="m.call.select_answer",i.CallNegotiate="m.call.negotiate",i.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",i.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",i.CallReplaces="m.call.replaces",i.CallAssertedIdentity="m.call.asserted_identity",i.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",i.CallEncryptionKeysPrefix="io.element.call.encryption_keys",i.KeyVerificationRequest="m.key.verification.request",i.KeyVerificationStart="m.key.verification.start",i.KeyVerificationCancel="m.key.verification.cancel",i.KeyVerificationMac="m.key.verification.mac",i.KeyVerificationDone="m.key.verification.done",i.KeyVerificationKey="m.key.verification.key",i.KeyVerificationAccept="m.key.verification.accept",i.KeyVerificationReady="m.key.verification.ready",i.RoomMessageFeedback="m.room.message.feedback",i.Reaction="m.reaction",i.PollStart="org.matrix.msc3381.poll.start",i.Typing="m.typing",i.Receipt="m.receipt",i.Presence="m.presence",i.FullyRead="m.fully_read",i.Tag="m.tag",i.SpaceOrder="org.matrix.msc3230.space_order",i.PushRules="m.push_rules",i.Direct="m.direct",i.IgnoredUserList="m.ignored_user_list",i.RoomKey="m.room_key",i.RoomKeyRequest="m.room_key_request",i.ForwardedRoomKey="m.forwarded_room_key",i.Dummy="m.dummy",i.GroupCallPrefix="org.matrix.msc3401.call",i.GroupCallMemberPrefix="org.matrix.msc3401.call.member",i.CallNotify="org.matrix.msc4075.call.notify",i}({}),lt=function(i){return i.Annotation="m.annotation",i.Replace="m.replace",i.Reference="m.reference",i.Thread="m.thread",i}({}),Nr=function(i){return i.Text="m.text",i.Emote="m.emote",i.Notice="m.notice",i.Image="m.image",i.File="m.file",i.Audio="m.audio",i.Location="m.location",i.Video="m.video",i.KeyVerificationRequest="m.key.verification.request",i}({}),Sl="type",as=function(i){return i.Space="m.space",i.UnstableCall="org.matrix.msc3417.call",i.ElementVideo="io.element.video",i}({}),Zt="org.matrix.msgid",Lc=new ut("m.room.purpose","org.matrix.msc3088.purpose"),Nc=new ut("m.enabled","org.matrix.msc3088.enabled"),xc=new ut("m.data_tree","org.matrix.msc3089.data_tree"),Ty=new ut("m.leaf","org.matrix.msc3089.leaf"),pn=new ut("m.branch","org.matrix.msc3089.branch"),Iy=new ut("m.room.marker","org.matrix.msc2716.marker"),Kc=new ut("with_rel_types","org.matrix.msc3912.with_relations"),Cy=new ut("io.element.functional_members","io.element.functional_members"),Oi=new ut("m.visibility","org.matrix.msc3531.visibility"),Fc=new ut("enabled","org.matrix.msc3881.enabled"),DR=new ut("device_id","org.matrix.msc3881.device_id"),ky=new ut("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),_l=new ut("thread_id","org.matrix.msc4023.thread_id"),Oy=new $l("membership","io.element.msc4115.membership"),Oe=function(i){return i.Ban="ban",i.Invite="invite",i.Join="join",i.Knock="knock",i.Leave="leave",i}({}),Yt=function(i){return i.Membership="RoomMember.membership",i.Name="RoomMember.name",i.PowerLevel="RoomMember.powerLevel",i.Typing="RoomMember.typing",i}({});class bl extends rt{constructor(e,t){super(),this.roomId=e,this.userId=t,f(this,"_isOutOfBand",!1),f(this,"modified",-1),f(this,"requestedProfileInfo",!1),f(this,"typing",!1),f(this,"name",void 0),f(this,"rawDisplayName",void 0),f(this,"powerLevel",0),f(this,"powerLevelNorm",0),f(this,"user",void 0),f(this,"membership",void 0),f(this,"disambiguate",!1),f(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n,s=(r=e.getDirectionalContent().displayname)!==null&&r!==void 0?r:"";if(e.getType()===F.RoomMember){this._isOutOfBand=!1,this.events.member=e;var o=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&p.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=NR(this.userId,s,t);var a=this.name;this.name=xR(this.userId,s,this.disambiguate),this.rawDisplayName=Oc((n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:""),(!this.rawDisplayName||!Di(this.rawDisplayName))&&(this.rawDisplayName=this.userId),o!==this.membership&&(this.updateModifiedTime(),this.emit(Yt.Membership,e,this,o)),a!==this.name&&(this.updateModifiedTime(),this.emit(Yt.Name,e,this,a))}}setPowerLevelEvent(e){if(!(e.getType()!==F.RoomPowerLevels||e.getStateKey()!=="")){var t=e.getDirectionalContent(),r=t.users_default||0,n=t.users||{};Object.values(n).forEach(a=>{r=Math.max(r,a)});var s=this.powerLevel,o=this.powerLevelNorm;n[this.userId]!==void 0&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:t.users_default!==void 0?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=this.powerLevel*100/r),(s!==this.powerLevel||o!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit(Yt.PowerLevel,e,this))}}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(r.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(Yt.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===Oe.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if(t.membership===Oe.Join&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),t.membership===Oe.Invite&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,o=arguments.length>5?arguments[5]:void 0,a=this.getMxcAvatarUrl();if(!a&&!s)return null;var l=Ql(e,a,t,r,n,o);return l||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}var UR=/@.+:.+/,LR=/[\u200E\u200F\u202A-\u202F]/;function NR(i,e,t){if(!e||e===i||!Di(e)||!t)return!1;if(UR.test(e)||LR.test(e))return!0;var r=t.getUserIdsWithDisplayName(e);return!!r.some(n=>n!==i)}function xR(i,e,t){return!e||e===i?i:t?Oc(e)+" ("+i+")":Di(e)?Oc(e):i}const KR="modulepreload",FR=function(i){return"/"+i},_v={},BR=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.allSettled(t.map(l=>{if(l=FR(l),l in _v)return;_v[l]=!0;const u=l.endsWith(".css"),c=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${c}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":KR,u||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),u)return new Promise((h,g)=>{d.addEventListener("load",h),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return n.then(o=>{for(const a of o||[])a.status==="rejected"&&s(a.reason);return e().catch(s)})};function jR(i,e){if(i==null)return{};var t={};for(var r in i)if({}.hasOwnProperty.call(i,r)){if(e.indexOf(r)!==-1)continue;t[r]=i[r]}return t}function qR(i,e){if(i==null)return{};var t,r,n=jR(i,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(i);for(r=0;r<s.length;r++)t=s[r],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(i,t)&&(n[t]=i[t])}return n}var hr=function(i){return i.DisplayName="User.displayName",i.AvatarUrl="User.avatarUrl",i.Presence="User.presence",i.CurrentlyActive="User.currentlyActive",i.LastPresenceTs="User.lastPresenceTs",i}({});class En extends rt{constructor(e){super(),this.userId=e,f(this,"modified",-1),f(this,"displayName",void 0),f(this,"rawDisplayName",void 0),f(this,"avatarUrl",void 0),f(this,"presenceStatusMsg",void 0),f(this,"presence","offline"),f(this,"lastActiveAgo",0),f(this,"lastPresenceTs",0),f(this,"currentlyActive",!1),f(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var r=new En(e);return t.reEmitter.reEmit(r,[hr.AvatarUrl,hr.DisplayName,hr.Presence,hr.CurrentlyActive,hr.LastPresenceTs]),r}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var r=[];(e.getContent().presence!==this.presence||t)&&r.push(hr.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(hr.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(hr.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&r.push(hr.CurrentlyActive),this.presence=e.getContent().presence,r.push(hr.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var n of r)this.emit(n,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var Ue=function(i){return i.Backward="b",i.Forward="f",i}({});class ve{static setEventMetadata(e,t,r){var n,s;(n=e.sender)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member||(e.sender=t.getSentinelMember(e.getSender())),!((s=e.target)!==null&&s!==void 0&&(s=s.events)!==null&&s!==void 0&&s.member)&&e.getType()===F.RoomMember&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&r&&(e.forwardLooking=!1)}constructor(e){var t,r;this.eventTimelineSet=e,f(this,"roomId",void 0),f(this,"name",void 0),f(this,"events",[]),f(this,"baseIndex",0),f(this,"startState",void 0),f(this,"endState",void 0),f(this,"startToken",null),f(this,"endToken",null),f(this,"prevTimeline",null),f(this,"nextTimeline",null),f(this,"paginationRequests",{[Ue.Backward]:null,[Ue.Forward]:null}),this.roomId=(t=(r=e.room)===null||r===void 0?void 0:r.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new ua(this.roomId),this.endState=new ua(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,r,{timelineWasEmpty:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:n}),(r=this.endState)===null||r===void 0||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){var t=this.getState(e),r=new ve(this.eventTimelineSet);return r.startState=t==null?void 0:t.clone(),r.endState=t,this.endState=t==null?void 0:t.clone(),r}fork(e){var t=this.getState(e),r=new ve(this.eventTimelineSet);return r.startState=t==null?void 0:t.clone(),r.endState=t==null?void 0:t.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==ve.BACKWARDS)return this.startState;if(e==ve.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===Ue.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===Ue.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==ve.BACKWARDS)return this.prevTimeline;if(e==ve.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==ve.BACKWARDS)this.prevTimeline=e;else if(t==ve.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e){var{toStartOfTimeline:t,roomState:r,timelineWasEmpty:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{toStartOfTimeline:!1};r||(r=t?this.startState:this.endState);var s=this.getTimelineSet();if(s.room&&(ve.setEventMetadata(e,r,t),e.isState()&&s.room.getUnfilteredTimelineSet()===s)){var o;(o=r)===null||o===void 0||o.setStateEvents([e],{timelineWasEmpty:n}),(!e.sender||e.getType()===F.RoomMember&&!t)&&ve.setEventMetadata(e,r,t)}var a;t?a=0:a=this.events.length,this.events.splice(a,0,e),t&&this.baseIndex++}insertEvent(e,t,r){var n=this.getTimelineSet();n.room&&(ve.setEventMetadata(e,r,!1),e.isState()&&n.room.getUnfilteredTimelineSet()===n&&(r.setStateEvents([e],{}),(!e.sender||e.getType()===F.RoomMember)&&ve.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}}f(ve,"BACKWARDS",Ue.Backward);f(ve,"FORWARDS",Ue.Forward);var Qa=function(i){return i.Add="Relations.add",i.Remove="Relations.remove",i.Redaction="Relations.redaction",i}({}),VR=function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...r].includes(e)};class lh extends rt{constructor(e,t,r,n){var s;super(),s=this,this.relationType=e,this.eventType=t,this.altEventTypes=n,f(this,"relationEventIds",new Set),f(this,"relations",new Set),f(this,"annotationsByKey",{}),f(this,"annotationsBySender",{}),f(this,"sortedAnnotationsByKey",[]),f(this,"targetEvent",null),f(this,"creationEmitted",!1),f(this,"client",void 0),f(this,"onEventStatus",(o,a)=>{if(!o.isSending()){o.removeListener(Fe.Status,this.onEventStatus);return}a===Re.CANCELLED&&(o.removeListener(Fe.Status,this.onEventStatus),this.removeEvent(o))}),f(this,"onBeforeRedaction",function(){var o=S(function*(a){if(s.relations.has(a)){if(s.relations.delete(a),s.relationType===lt.Annotation)s.removeAnnotationFromAggregation(a);else if(s.relationType===lt.Replace&&s.targetEvent&&!s.targetEvent.isState()){var l=yield s.getLastReplacement();s.targetEvent.makeReplaced(l)}a.removeListener(Fe.BeforeRedaction,s.onBeforeRedaction),s.emit(Qa.Redaction,a)}});return function(a){return o.apply(this,arguments)}}()),this.client=r instanceof eu?r.client:r}addEvent(e){var t=this;return S(function*(){if(!t.relationEventIds.has(e.getId())){var r=e.getRelation();if(!r){p.error("Event must have relation info");return}var n=r.rel_type,s=e.getType();if(t.relationType!==n||!VR(s,t.eventType,t.altEventTypes)){p.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(Fe.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===lt.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===lt.Replace&&t.targetEvent&&!t.targetEvent.isState()){var o=yield t.getLastReplacement();t.targetEvent.makeReplaced(o)}e.on(Fe.BeforeRedaction,t.onBeforeRedaction),t.emit(Qa.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return S(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===lt.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===lt.Replace&&t.targetEvent&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();t.targetEvent.makeReplaced(r)}t.emit(Qa.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort((a,l)=>{var u=a[1],c=l[1];return c.size-u.size});var s=e.getSender(),o=this.annotationsBySender[s];o||(o=this.annotationsBySender[s]=new Set),o.add(e)}}removeAnnotationFromAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((a,l)=>{var u=a[1],c=l[1];return c.size-u.size}));var s=e.getSender(),o=this.annotationsBySender[s];o&&o.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==lt.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==lt.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return S(function*(){if(e.relationType!==lt.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(lt.Replace),r=t==null?void 0:t.origin_server_ts,n=e.getRelations().reduce((s,o)=>o.getSender()!==e.targetEvent.getSender()||r&&r>o.getTs()||s&&s.getTs()>o.getTs()?s:o,null);return n!=null&&n.shouldAttemptDecryption()&&e.client.isCryptoEnabled()?yield n.attemptDecryption(e.client.crypto):n!=null&&n.isBeingDecrypted()&&(yield n.getDecryptionPromise()),n})()}setTargetEvent(e){var t=this;return S(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===lt.Replace&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();r&&t.targetEvent.makeReplaced(r)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(Fe.RelationsCreated,this.relationType,this.eventType))}}class Py{constructor(e,t){this.client=e,this.room=t,f(this,"relations",new Map)}getChildEventsForEvent(e,t,r){var n;return(n=this.relations.get(e))===null||n===void 0||(n=n.get(t))===null||n===void 0?void 0:n.get(r)}getAllChildEventsForEvent(e){var t,r=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,n=[];for(var s of r.values())for(var o of s.values())n.push(...o.getRelations());return n}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var r of t.values())for(var n of r.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===Re.CANCELLED)){var r=e.getRelation();if(r){var n=()=>{if(e.isDecryptionFailure()){e.once(Fe.Decrypted,n);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(Fe.Decrypted,n);return}var{event_id:s,rel_type:o}=r,a=e.getType(),l=this.relations.get(s);l||(l=new Map,this.relations.set(s,l));var u=l.get(o);u||(u=new Map,l.set(o,u));var c=u.get(a);if(!c){var d,h,g;c=new lh(o,a,this.client),u.set(a,c);var v=(d=this.room)!==null&&d!==void 0?d:t==null?void 0:t.room,m=(h=(g=t==null?void 0:t.findEventById(s))!==null&&g!==void 0?g:v==null?void 0:v.findEventById(s))!==null&&h!==void 0?h:v==null?void 0:v.getPendingEvent(s);m&&c.setTargetEvent(m)}c.addEvent(e)}}}}var Zi;Zi=p.log.bind(p);var xo=function(i){return i.Ignore="ignore",i.Replace="replace",i}({});class ns extends rt{constructor(e){var t,r,n,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,l=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=a,this.threadListType=l,f(this,"relations",void 0),f(this,"timelineSupport",void 0),f(this,"displayPendingEvents",void 0),f(this,"liveTimeline",void 0),f(this,"timelines",void 0),f(this,"_eventIdToTimeline",new Map),f(this,"filter",void 0),this.timelineSupport=!!s.timelineSupport,this.liveTimeline=new ve(this),this.displayPendingEvents=s.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=s.filter,this.relations=(t=(r=this.room)===null||r===void 0?void 0:r.relations)!==null&&t!==void 0?t:new Py((n=e==null?void 0:e.client)!==null&&n!==void 0?n:o)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){var r=!this.timelineSupport||!t,n=this.liveTimeline,s=r?n.forkLive(ve.FORWARDS):n.fork(ve.FORWARDS);r?(this.timelines=[s],this._eventIdToTimeline=new Map):this.timelines.push(s),t&&n.setPaginationToken(t,ve.FORWARDS),s.setPaginationToken(e??null,ve.BACKWARDS),this.liveTimeline=s,this.emit(ye.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(r){return r.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new ve(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,n){if(!r)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var s=t?ve.BACKWARDS:ve.FORWARDS,o=t?ve.FORWARDS:ve.BACKWARDS,a=!1,l=!1;for(var u of e){var c=u.getId(),d=this._eventIdToTimeline.get(c);if(!d){this.addEventToTimeline(u,r,{toStartOfTimeline:t}),l=!0,a=!0;continue}if(l=!1,d==r){Zi("Event "+c+" already in timeline "+r);continue}var h=r.getNeighbouringTimeline(s);if(h){d==h?Zi("Event "+c+" in neighbouring timeline - switching to "+d):Zi("Event "+c+" already in a different timeline "+d),r=d;continue}p.info("Already have timeline for "+c+" - joining timeline "+r+" to "+d);var g=d===this.liveTimeline,v=r===this.liveTimeline,m=s===ve.BACKWARDS&&g,E=s===ve.FORWARDS&&v;if(m||E){m&&p.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+d+")"),E&&p.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")");continue}r.setNeighbouringTimeline(d,s),d.setNeighbouringTimeline(r,o),r=d,a=!0}if(l||!a){if(s===ve.FORWARDS&&r===this.liveTimeline){p.warn({lastEventWasNew:l,didUpdate:a}),p.warn("Refusing to set forwards pagination token of live timeline "+"".concat(r," to ").concat(n));return}r.setPaginationToken(n??null,s)}}}addLiveEvent(e){var{duplicateStrategy:t,fromCache:r,roomState:n,timelineWasEmpty:s}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filter){var o=this.filter.filterRoomTimeline([e]);if(!o.length)return}var a=this._eventIdToTimeline.get(e.getId());if(a){if(t===xo.Replace){Zi("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var l=a.getEvents(),u=0;u<l.length;u++)if(l[u].getId()===e.getId()){n||(n=a.getState(ve.FORWARDS)),ve.setEventMetadata(e,n,!1),l[u]=e;break}}else Zi("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:r,roomState:n,timelineWasEmpty:s})}addEventToTimeline(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0,o=!!r,a;if(typeof r=="object"?{toStartOfTimeline:o,fromCache:n=!1,roomState:s,timelineWasEmpty:a}=r:r!==void 0&&p.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),t.getTimelineSet()!==this){var l;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((l=this.thread)===null||l===void 0?void 0:l.id,")"))}var u=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var c,d="event=".concat(u);e.threadRootId&&(d+="(belongs to thread=".concat(e.threadRootId,")")),p.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(d," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((c=this.thread)===null||c===void 0?void 0:c.id,")"));return}t.addEvent(e,{toStartOfTimeline:o,roomState:s,timelineWasEmpty:a}),this._eventIdToTimeline.set(u,t);var h={timeline:t,liveEvent:!o&&t==this.liveTimeline&&!n};this.emit(ye.Timeline,e,this.room,!!o,!1,h)}insertEventIntoTimeline(e,t,r){if(t.getTimelineSet()!==this){var n;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((n=this.thread)===null||n===void 0?void 0:n.id,")"))}var s=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var o,a="event=".concat(s);e.threadRootId&&(a+="(belongs to thread=".concat(e.threadRootId,")")),p.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(a," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((o=this.thread)===null||o===void 0?void 0:o.id,")"));return}var l=e.relationEventId;if(!l){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r});return}for(var u=this.findEventById(l),c=t.getEvents(),d=u!==void 0?c.indexOf(u):0,h=d;h<c.length;h++){var g=c[h];if(g.getTs()>e.getTs())break}t.insertEvent(e,h,r),this._eventIdToTimeline.set(s,t);var v={timeline:t,liveEvent:!1};this.emit(ye.Timeline,e,this.room,!1,!1,v)}handleRemoteEcho(e,t,r){var n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var r=t.removeEvent(e);if(r){this._eventIdToTimeline.delete(e);var n={timeline:t};this.emit(ye.Timeline,r,this.room,void 0,!0,n)}return r}compareEventOrdering(e,t){if(e==t)return 0;var r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(r===void 0||n===void 0)return null;if(r===n){for(var s=void 0,o=void 0,a=r.getEvents(),l=0;l<a.length&&(s===void 0||o===void 0);l++){var u=a[l].getId();u==e&&(s=l),u==t&&(o=l)}var c=s-o;return c<0?-1:c>0?1:0}for(var d=r;d;){if(d===n)return-1;d=d.getNeighbouringTimeline(ve.FORWARDS)}for(d=r;d;){if(d===n)return 1;d=d.getNeighbouringTimeline(ve.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:r,shouldLiveInThread:n}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!r&&!n){var s;p.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((s=this.room)===null||s===void 0?void 0:s.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return r}}var Re=function(i){return i.NOT_SENT="not_sent",i.ENCRYPTING="encrypting",i.SENDING="sending",i.QUEUED="queued",i.SENT="sent",i.CANCELLED="cancelled",i}({});class My{constructor(e,t){this.roomId=e}}class Ay{constructor(e){this.target=e,f(this,"reEmitters",new WeakMap)}reEmit(e,t){var r=this,n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));var s=function(l){if(n.has(l))return 1;var u=function(){if(!(l==="error"&&r.target.listenerCount("error")===0)){for(var d=arguments.length,h=new Array(d),g=0;g<d;g++)h[g]=arguments[g];r.target.emit(l,...h,e)}};e.on(l,u),n.set(l,u)};for(var o of t)s(o)}stopReEmitting(e,t){var r=this.reEmitters.get(e);if(r){for(var n of t)e.off(n,r.get(n)),r.delete(n);r.size===0&&this.reEmitters.delete(e)}}}class Ms extends Ay{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var ra=new zl("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function WR(i,e){if(e.endsWith("*")){var t=e.slice(0,-1);return i.slice(0,t.length)===t}else return i===e}class bv{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,r,n=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},s=Object.keys(n),o=[];return this.userId&&n!==null&&n!==void 0&&(r=n[Je.name])!==null&&r!==void 0&&r.current_user_participated&&o.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,s,o)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[vs.name]:this.filterJson[vs.name]||[],[gs.name]:this.filterJson[gs.name]||[]}}checkFields(e,t,r,n,s,o){var a={rooms:function(R){return e===R},senders:function(R){return t===R},types:function(R){return WR(r,R)}};for(var l in a){var u=a[l],c="not_"+l,d=this.filterJson[c];if(d!=null&&d.some(u))return!1;var h=this.filterJson[l];if(h&&!h.some(u))return!1}var g=this.filterJson.contains_url;if(g!==void 0&&g!==n)return!1;var v=this.filterJson[gs.name];if(v!==void 0&&!this.arrayMatchesFilter(v,s))return!1;var m=this.filterJson[vs.name];return!(m!==void 0&&!this.arrayMatchesFilter(m,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every(r=>t.includes(r))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function Ev(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Gi(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ev(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Ev(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function xu(i,e,t){for(var r=e.split("."),n=i,s=0;s<r.length-1;s++)n[r[s]]||(n[r[s]]={}),n=n[r[s]];n[r[r.length-1]]=t}class rr{static fromJson(e,t,r){var n=new rr(e,t);return n.setDefinition(r),n}constructor(e,t){this.userId=e,this.filterId=t,f(this,"definition",{}),f(this,"roomFilter",void 0),f(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new bv(r,this.userId),this.roomTimelineFilter=new bv((t==null?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){xu(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=Gi(Gi({},this.definition),{},{room:Gi(Gi({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:Gi(Gi({},(r=this.definition)===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.timeline),{},{[ra.name]:e})})})}setLazyLoadMembers(e){xu(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){xu(this.definition,"room.include_leave",e)}}f(rr,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});var uh=new ut("m.topic","org.matrix.msc3765.topic");function wv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function GR(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):wv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Dy(i,e){return{msgtype:Nr.Text,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Uy(i,e){return{msgtype:Nr.Notice,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Ly(i,e){return{msgtype:Nr.Emote,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Ny(i){return{msgtype:Nr.Text,body:i}}function xy(i){return{msgtype:Nr.Notice,body:i}}function Ky(i){return{msgtype:Nr.Emote,body:i}}var Fy=(i,e,t,r)=>{var n="at ".concat(new Date(t).toISOString()),s=e===Ss.Self?"User":void 0,o=r?'"'.concat(r,'"'):void 0;return[s,"Location",o,i,n].filter(Boolean).join(" ")},By=(i,e,t,r,n)=>{var s=i??Fy(e,n||Ss.Self,t,r),o=t?{[ri.name]:t}:{};return GR({msgtype:Nr.Location,body:s,geo_uri:e,[ma.name]:{description:r,uri:e},[pa.name]:{type:n||Ss.Self},[sh.name]:s},o)},HR=i=>{var e,t,r=ma.findIn(i),n=pa.findIn(i),s=ri.findIn(i),o=sh.findIn(i),a=(e=r==null?void 0:r.uri)!==null&&e!==void 0?e:i==null?void 0:i.geo_uri,l=r==null?void 0:r.description,u=(t=n==null?void 0:n.type)!==null&&t!==void 0?t:Ss.Self,c=o??i.body;return By(c,a,s??void 0,l,u)},jy=(i,e)=>{var t=[{body:i,mimetype:"text/plain"}];return ih(e)&&t.push({body:e,mimetype:"text/html"}),{topic:i,[uh.name]:t}},$R=i=>{var e,t,r,n=uh.findIn(i);if(!Array.isArray(n))return{text:i.topic};var s=(e=n==null||(t=n.find(a=>!ih(a.mimetype)||a.mimetype==="text/plain"))===null||t===void 0?void 0:t.body)!==null&&e!==void 0?e:i.topic,o=n==null||(r=n.find(a=>a.mimetype==="text/html"))===null||r===void 0?void 0:r.body;return{text:s,html:o}},zR=(i,e,t,r,n)=>({description:t,timeout:i,live:e,[ri.name]:n||Date.now(),[pa.name]:{type:r??Ss.Self}}),qy=i=>{var e,{description:t,timeout:r,live:n}=i,s=(e=ri.findIn(i))!==null&&e!==void 0?e:void 0,o=pa.findIn(i);return{description:t,timeout:r,live:n,assetType:o==null?void 0:o.type,timestamp:s}},JR=(i,e,t,r)=>({[ma.name]:{description:r,uri:i},[ri.name]:e,"m.relates_to":{rel_type:my.name,event_id:t}}),Bc=i=>{var e,t=ma.findIn(i),r=(e=ri.findIn(i))!==null&&e!==void 0?e:void 0;return{description:t==null?void 0:t.description,uri:t==null?void 0:t.uri,timestamp:r}};const YR=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:Fy,makeBeaconContent:JR,makeBeaconInfoContent:zR,makeEmoteMessage:Ky,makeHtmlEmote:Ly,makeHtmlMessage:Dy,makeHtmlNotice:Uy,makeLocationContent:By,makeNotice:xy,makeTextMessage:Ny,makeTopicContent:jy,parseBeaconContent:Bc,parseBeaconInfoContent:qy,parseLocationEvent:HR,parseTopicContent:$R},Symbol.toStringTag,{value:"Module"}));var tt=function(i){return i.New="Beacon.new",i.Update="Beacon.update",i.LivenessChange="Beacon.LivenessChange",i.Destroy="Beacon.Destroy",i.LocationUpdate="Beacon.LocationUpdate",i}({}),jc=(i,e,t)=>t>=i&&i+e>=t,El=i=>"".concat(i.getRoomId(),"_").concat(i.getStateKey());class Vy extends rt{constructor(e){super(),this.rootEvent=e,f(this,"roomId",void 0),f(this,"_beaconInfo",void 0),f(this,"_isLive",void 0),f(this,"livenessWatchTimeout",void 0),f(this,"_latestLocationEvent",void 0),f(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(tt.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return El(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&Bc(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(El(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(tt.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(tt.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var r=e.filter(s=>{var o=s.getContent(),a=Bc(o);if(!a.uri||!a.timestamp)return!1;var{timestamp:l}=a;return this._beaconInfo.timestamp&&jc(this._beaconInfo.timestamp,this._beaconInfo.timeout,l)&&(!this.latestLocationState||l>this.latestLocationState.timestamp)}),n=(t=r.sort(kR))===null||t===void 0?void 0:t[0];n&&(this._latestLocationEvent=n,this.emit(tt.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=qy(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&jc(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(tt.LivenessChange,this.isLive,this)}}}function Rv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function QR(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Rv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Rv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Wy(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new Ot({content:{[e.getId()]:{[t]:{[i]:QR({ts:e.getTs()},!r&&{thread_id:Cs(e)})}}},type:F.Receipt,room_id:e.getRoomId()})}var Hi=0,$i=1;class Gy extends rt{constructor(){super(...arguments),f(this,"receipts",new ht(()=>new Map)),f(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Gt.Read,[o,a]=(t=(r=this.receipts.get(s))===null||r===void 0?void 0:r.get(e))!==null&&t!==void 0?t:[null,null];return n?o:a??o}compareReceipts(e,t){var r;return(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&r!==void 0?r:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t,r=this.findEventById(e.eventId);if(!r)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===ya){var n=la(r);if(n)return!0}else if(r.threadRootId===e.data.thread_id)return!0;return p.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n,s=this.getReadReceiptForUserId(e,t,Gt.Read),o=this.getReadReceiptForUserId(e,t,Gt.ReadPrivate),a;return s!=null&&s.eventId&&o!==null&&o!==void 0&&o.eventId&&(a=this.compareReceipts(s,o)),a?(n=a<0?o:s)!==null&&n!==void 0?n:null:(r=o??s)!==null&&r!==void 0?r:null}addReceiptToStructure(e,t,r,n,s){var o,a,l=this.receipts.getOrCreate(t),u=l.get(r);u||(u=[null,null],l.set(r,u));var c=u[Hi];if(s){var d;c=(d=u[$i])!==null&&d!==void 0?d:u[Hi]}var h={eventId:e,data:n};if(c){var g=this.compareReceipts(c,h);if(g>=0)return}var v=s?u[Hi]:h,m=s?h:u[$i],E=null;v&&m&&(E=this.getUnfilteredTimelineSet().compareEventOrdering(v.eventId,m.eventId));var R=E===null||E<0,_=(o=u[$i])!==null&&o!==void 0?o:u[Hi];s&&R?u[$i]=h:s||(u[Hi]=h,R||(u[$i]=null));var T=(a=u[$i])!==null&&a!==void 0?a:u[Hi];if(_!==T){if(_&&this.receiptCacheByEventId.get(_.eventId)){var b=_.eventId;this.receiptCacheByEventId.set(b,this.receiptCacheByEventId.get(b).filter(I=>I.type!==t||I.userId!==r)),this.receiptCacheByEventId.get(b).length<1&&this.receiptCacheByEventId.delete(b)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&(t==null?void 0:t.eventId)===r.getId()&&e===r.getSender()&&(this.setUnread(Ve.Total,0),this.setUnread(Ve.Highlight,0))}addLocalEchoReceipt(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(Wy(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return oh(t.type)}).map(function(t){return t.userId})}}var jn=function(i){return i.New="Poll.new",i.End="Poll.end",i.Update="Poll.update",i.Responses="Poll.Responses",i.Destroy="Poll.Destroy",i.UndecryptableRelations="Poll.UndecryptableRelations",i}({}),Tv=(i,e)=>{var t=i.filter(r=>{if(!r.isDecryptionFailure())return ta.matches(r.getType())&&r.getTs()<=e});return{responseEvents:t}};class Hy extends rt{constructor(e,t,r){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=r,f(this,"roomId",void 0),f(this,"pollEvent",void 0),f(this,"_isFetchingResponses",!1),f(this,"relationsNextBatch",void 0),f(this,"responses",null),f(this,"endEvent",void 0),f(this,"undecryptableRelationEventIds",new Set),f(this,"countUndecryptableEvents",n=>{var s=n.filter(a=>a.isDecryptionFailure()).map(a=>a.getId()),o=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...s]),this.undecryptableRelationsCount!==o&&this.emit(jn.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return S(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(yl.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(jn.End)),!!this.responses){var r=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:n}=Tv([e],r);this.countUndecryptableEvents([e]),n.length&&(n.forEach(s=>{this.responses.addEvent(s)}),this.emit(jn.Responses,this.responses))}}fetchResponses(){var e=this;return S(function*(){var t,r;e._isFetchingResponses=!0;var n=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(n.events.map(u=>e.matrixClient.decryptEventIfNeeded(u)));var s=e.responses||new lh("m.reference",ta.name,e.matrixClient,[ta.altName]),o=n.events.find(u=>yl.matches(u.getType()));e.validateEndEvent(o)&&(e.endEvent=o,e.refilterResponsesOnEnd(),e.emit(jn.End));var a=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:l}=Tv(n.events,a);l.forEach(u=>{s.addEvent(u)}),e.relationsNextBatch=(r=n.nextBatch)!==null&&r!==void 0?r:void 0,e.responses=s,e.countUndecryptableEvents(n.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(jn.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(r=>{if(r.getTs()>t){var n;(n=this.responses)===null||n===void 0||n.removeEvent(r)}}),this.emit(jn.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}}var $y=i=>{var e=i.getType();return sr.M_POLL_START.matches(e)||ta.matches(e)||yl.matches(e)};class XR{constructor(e){f(this,"room",void 0),f(this,"threadedReceipts",void 0),f(this,"unthreadedReceipts",void 0),f(this,"danglingReceipts",void 0),f(this,"onTimelineEvent",t=>{var r=t.getId();if(r){var n=this.danglingReceipts.remove(r);n==null||n.forEach(s=>{s.receipt.thread_id?this.threadedReceipts.set(s.receipt.thread_id,s.eventId,s.receiptType,s.userId,s.receipt.ts,s.synthetic):this.unthreadedReceipts.set(r,s.receiptType,s.userId,s.receipt.ts,s.synthetic)})}}),this.room=e,this.threadedReceipts=new rT(e),this.unthreadedReceipts=new zy(e),this.danglingReceipts=new nT,e.on(ye.Timeline,this.onTimelineEvent)}add(e,t){for(var[r,n]of Object.entries(e))for(var[s,o]of Object.entries(n))for(var[a,l]of Object.entries(o)){var u=this.room.findEventById(r);u?l.thread_id?this.threadedReceipts.set(l.thread_id,r,s,a,l.ts,t):this.unthreadedReceipts.set(r,s,a,l.ts,t):this.danglingReceipts.add(new eT(r,s,a,l,t))}}hasUserReadEvent(e,t){var r=this.unthreadedReceipts.get(e);if(r&&qc(r.eventId,t,this.room))return!0;var n=this.room.findEventById(t);if(!n)return p.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var s=Cs(n),o=this.threadedReceipts.get(s,e);return!!(o&&qc(o.eventId,t,this.room)||this.userSentLatestEventInThread(s,e))}userSentLatestEventInThread(e,t){var r,n=e===ya?this.room.getLiveTimeline().getEvents():(r=this.room.getThread(e))===null||r===void 0?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class ZR{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class eT{constructor(e,t,r,n,s){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=s}}class tT{constructor(e){f(this,"room",void 0),f(this,"real",void 0),f(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&qc(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}}class zy{constructor(e){f(this,"room",void 0),f(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,s){var o=ch(this.data,r,()=>new tT(this.room)),a=o.getByType(s);a&&iT(a.eventId,e,this.room)||o.set(s,new ZR(e,t,n))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}}class rT{constructor(e){f(this,"room",void 0),f(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,s,o){var a=ch(this.data,e,()=>new zy(this.room));a.set(t,r,n,s,o)}get(e,t){var r;return(r=this.data.get(e))===null||r===void 0?void 0:r.get(t)}}class nT{constructor(){f(this,"data",new Map)}add(e){var t=ch(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function ch(i,e,t){var r=i.get(e);if(r)return r;var n=t();return i.set(e,n),n}function qc(i,e,t){var r=t.compareEventOrdering(i,e);return r!==null&&r>=0}function iT(i,e,t){var r=t.compareEventOrdering(i,e);return r!==null&&r>0}function sT(i,e,t){var r=i.findEventById(e),n=i.findEventById(t);if(!r||!n)return null;var s=la(r),o=la(n);return s&&o?oT(i,e,t,r,n):aT(e,t,r,n)}function oT(i,e,t,r,n){var s=i.getUnfilteredTimelineSet(),o=s.compareEventOrdering(e,t);if(o!==null)return o;var a=s.getTimelineForEvent(e);if(a===s.getLiveTimeline())return 1;var l=s.getTimelineForEvent(t);return l===s.getLiveTimeline()?-1:Jy(r,n)}function aT(i,e,t,r){var n=Cs(t),s=Cs(r),o=t.getThread();return o&&n===s?o.timelineSet.compareEventOrdering(i,e):Jy(t,r)}function Jy(i,e){var t=i.getTs(),r=e.getTs();return t<r?-1:t>r?1:0}var z=function(i){return i.Get="GET",i.Put="PUT",i.Post="POST",i.Delete="DELETE",i.Options="OPTIONS",i.Head="HEAD",i.Patch="PATCH",i}({});class wl extends Error{constructor(e,t){super(e),this.httpStatus=t}}class Qt extends wl{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),r&&(s="".concat(s," (").concat(r,")")),super("MatrixError: ".concat(s),t),this.httpStatus=t,this.url=r,this.event=n,f(this,"errcode",void 0),f(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}}class Sa extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}var Vc=function(i){return i.SessionLoggedOut="Session.logged_out",i.NoConsent="no_consent",i}({}),Pa={};/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var Iv;function lT(){if(Iv)return Pa;Iv=1;var i=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,e=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,t=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,r=/\\([\u000b\u0020-\u00ff])/g,n=/([\\"])/g,s=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;Pa.format=o,Pa.parse=a;function o(d){if(!d||typeof d!="object")throw new TypeError("argument obj is required");var h=d.parameters,g=d.type;if(!g||!s.test(g))throw new TypeError("invalid type");var v=g;if(h&&typeof h=="object")for(var m,E=Object.keys(h).sort(),R=0;R<E.length;R++){if(m=E[R],!t.test(m))throw new TypeError("invalid parameter name");v+="; "+m+"="+u(h[m])}return v}function a(d){if(!d)throw new TypeError("argument string is required");var h=typeof d=="object"?l(d):d;if(typeof h!="string")throw new TypeError("argument string is required to be a string");var g=h.indexOf(";"),v=g!==-1?h.slice(0,g).trim():h.trim();if(!s.test(v))throw new TypeError("invalid media type");var m=new c(v.toLowerCase());if(g!==-1){var E,R,_;for(i.lastIndex=g;R=i.exec(h);){if(R.index!==g)throw new TypeError("invalid parameter format");g+=R[0].length,E=R[1].toLowerCase(),_=R[2],_.charCodeAt(0)===34&&(_=_.slice(1,-1),_.indexOf("\\")!==-1&&(_=_.replace(r,"$1"))),m.parameters[E]=_}if(g!==h.length)throw new TypeError("invalid parameter format")}return m}function l(d){var h;if(typeof d.getHeader=="function"?h=d.getHeader("content-type"):typeof d.headers=="object"&&(h=d.headers&&d.headers["content-type"]),typeof h!="string")throw new TypeError("content-type header is missing from object");return h}function u(d){var h=String(d);if(t.test(h))return h;if(h.length>0&&!e.test(h))throw new TypeError("invalid parameter value");return'"'+h.replace(n,"\\$1")+'"'}function c(d){this.parameters=Object.create(null),this.type=d}return Pa}var uT=lT();function Zl(i){var e=new AbortController;return setTimeout(()=>{e.abort()},i),e.signal}function Yy(i){var e=new AbortController;function t(){for(var s of i)s.removeEventListener("abort",r)}function r(){e.abort(),t()}for(var n of i){if(n.aborted){r();break}n.addEventListener("abort",r)}return{signal:e.signal,cleanup:t}}function dh(i,e){var t,r,n;try{n=cT(i)}catch(s){return s}return((t=n)===null||t===void 0?void 0:t.type)==="application/json"&&e?new Qt(JSON.parse(e),i.status,Qy(i)?i.responseURL:i.url):((r=n)===null||r===void 0?void 0:r.type)==="text/plain"?new wl("Server returned ".concat(i.status," error: ").concat(e),i.status):new wl("Server returned ".concat(i.status," error"),i.status)}function Qy(i){return"getResponseHeader"in i}function cT(i){var e;if(Qy(i)?e=i.getResponseHeader("Content-Type"):e=i.headers.get("Content-Type"),!e)return null;try{return uT.parse(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}function Xy(i,e){return Wc.apply(this,arguments)}function Wc(){return Wc=S(function*(i,e){for(var t=0,r=null;t<i;)try{if(t>0){var n=1e3*Math.pow(2,t);p.log("network operation failed ".concat(t," times, retrying in ").concat(n,"ms...")),yield Zo(n)}return yield e()}catch(s){if(s instanceof Sa)t+=1,r=s;else throw s}throw r}),Wc.apply(this,arguments)}function Zy(i,e,t){if(e>4||i instanceof Sa&&!t||i.httpStatus&&(i.httpStatus===400||i.httpStatus===403||i.httpStatus===401)||i.name==="AbortError"||i.name==="M_TOO_LARGE")return-1;if(i.name==="M_LIMIT_EXCEEDED"){var r=i.data.retry_after_ms;if(r>0)return r}return 1e3*Math.pow(2,e)}function Cv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ku(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Cv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Cv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class dT{constructor(e,t){var r;this.eventEmitter=e,this.opts=t,f(this,"abortController",new AbortController),yy(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=(r=t.useAuthorizationHeader)!==null&&r!==void 0?r:!0}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):global.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,s){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var o=void 0,a=void 0;e===z.Get?o=r:a=r;var l=this.getUrl(t,o,n,this.opts.idBaseUrl),u={json:!0,headers:{}};return s&&(u.headers.Authorization="Bearer ".concat(s)),this.requestOtherUrl(e,l,a,u)}authedRequest(e,t,r,n){var s=arguments,o=this;return S(function*(){var a=s.length>4&&s[4]!==void 0?s[4]:{};r||(r={});var l=Ku({},a);o.opts.accessToken&&(o.opts.useAuthorizationHeader?(l.headers||(l.headers={}),l.headers.Authorization||(l.headers.Authorization="Bearer "+o.opts.accessToken),r.access_token&&delete r.access_token):r.access_token||(r.access_token=o.opts.accessToken));try{var u=yield o.request(e,t,r,n,l);return u}catch(h){var c=h;if(c.errcode==="M_UNKNOWN_TOKEN"&&!l.doNotAttemptTokenRefresh){var d=yield o.tryRefreshToken();if(d)return o.authedRequest(e,t,r,n,Ku(Ku({},a),{},{doNotAttemptTokenRefresh:!0}))}throw c.errcode=="M_UNKNOWN_TOKEN"&&!(l!=null&&l.inhibitLogoutEmit)?o.eventEmitter.emit(Vc.SessionLoggedOut,c):c.errcode=="M_CONSENT_NOT_GIVEN"&&o.eventEmitter.emit(Vc.NoConsent,c.message,c.data.consent_uri),c}})()}tryRefreshToken(){var e=this;return S(function*(){if(!e.opts.refreshToken||!e.opts.tokenRefreshFunction)return!1;try{var{accessToken:t,refreshToken:r}=yield e.opts.tokenRefreshFunction(e.opts.refreshToken);return e.opts.accessToken=t,e.opts.refreshToken=r,!0}catch(s){var n;return(n=e.opts.logger)===null||n===void 0||n.warn("Failed to refresh token",s),!1}})()}request(e,t,r,n,s){var o=this.getUrl(t,r,s==null?void 0:s.prefix,s==null?void 0:s.baseUrl);return this.requestOtherUrl(e,o,n,s)}requestOtherUrl(e,t,r){var n=arguments,s=this;return S(function*(){var o,a,l,u,c,d=n.length>3&&n[3]!==void 0?n[3]:{},h=s.sanitizeUrlForLogs(t);(o=s.opts.logger)===null||o===void 0||o.debug("FetchHttpApi: --> ".concat(e," ").concat(h));var g=Object.assign({},d.headers||{}),v=(a=d.json)!==null&&a!==void 0?a:!0,m=v&&(r==null||(l=r.constructor)===null||l===void 0?void 0:l.name)===Object.name;v&&(m&&!g["Content-Type"]&&(g["Content-Type"]="application/json"),g.Accept||(g.Accept="application/json"));var E=(u=d.localTimeoutMs)!==null&&u!==void 0?u:s.opts.localTimeoutMs,R=(c=d.keepAlive)!==null&&c!==void 0?c:!1,_=[s.abortController.signal];E!==void 0&&_.push(Zl(E)),d.abortSignal&&_.push(d.abortSignal);var T;m?T=JSON.stringify(r):T=r;var{signal:b,cleanup:I}=Yy(_),y,C=Date.now();try{var w;y=yield s.fetch(t,{signal:b,method:e,body:T,headers:g,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:R,priority:d.priority}),(w=s.opts.logger)===null||w===void 0||w.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-C,"ms ").concat(y.status,"]"))}catch(x){var D;throw(D=s.opts.logger)===null||D===void 0||D.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-C,"ms ").concat(x,"]")),x.name==="AbortError"?x:new Sa("fetch failed",x)}finally{I()}if(!y.ok)throw dh(y,yield y.text());return s.opts.onlyData?v?y.json():y.text():y})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var r=new URLSearchParams;for(var n of t.searchParams.keys())r.append(n,"xxx");var s=r.toString(),o=s?"?".concat(s):"";return t.origin+t.pathname+o}catch{return"??"}}getUrl(e,t,r,n){var s=n??this.opts.baseUrl,o=s.endsWith("/")?s.slice(0,-1):s,a=new URL(o+(r??this.opts.prefix)+e);return t&&gl(t,a.searchParams),a}}var vt=function(i){return i.V1="/_matrix/client/v1",i.V3="/_matrix/client/v3",i.Unstable="/_matrix/client/unstable",i}({}),ln=function(i){return i.V2="/_matrix/identity/v2",i}({}),ls=function(i){return i.V1="/_matrix/media/v1",i.V3="/_matrix/media/v3",i}({}),hT=1e3,fT=0,Fu,Sn=[],vT=function(){};function kv(i,e){for(var t=arguments.length,r=new Array(t>2?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];e=e||0,e<0&&(e=0);var s=Date.now()+e,o=fT++,a={runAt:s,func:i,params:r,key:o},l=pT(Sn,function(u){return u.runAt-s});return Sn.splice(l,0,a),hh(),o}function Ov(i){if(Sn.length!==0){var e;for(e=0;e<Sn.length;e++){var t=Sn[e];if(t.key==i){Sn.splice(e,1);break}}e===0&&hh()}}function hh(){Fu&&global.clearTimeout(Fu);var i=Sn[0];if(i){var e=Date.now(),t=Math.min(i.runAt-e,hT);Fu=global.setTimeout(gT,t)}}function gT(){for(var i=Date.now(),e=[];;){var t=Sn[0];if(!t||t.runAt>i)break;var r=Sn.shift();vT("runCallbacks: popping",r.key),e.push(r)}hh();for(var n of e)try{n.func.apply(global,n.params)}catch(s){p.error("Uncaught exception in callback function",s)}}function pT(i,e){for(var t=0,r=i.length;t<r;){var n=t+r>>1,s=e(i[n]);s>0?r=n:t=n+1}return t}class eS extends dT{constructor(){super(...arguments),f(this,"uploads",[])}uploadContent(e){var t,r,n,s,o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},a=(t=o.includeFilename)!==null&&t!==void 0?t:!0,l=(r=o.abortController)!==null&&r!==void 0?r:new AbortController,u=((n=o.type)!==null&&n!==void 0?n:e.type)||"application/octet-stream",c=(s=o.name)!==null&&s!==void 0?s:e.name,d={loaded:0,total:0,abortController:l},h=ni();if(global.XMLHttpRequest){var g=new global.XMLHttpRequest,v=function(){g.abort(),h.reject(new Error("Timeout"))},m=kv(v,3e4);g.onreadystatechange=function(){switch(g.readyState){case global.XMLHttpRequest.DONE:Ov(m);try{if(g.status===0)throw new DOMException(g.statusText,"AbortError");if(!g.responseText)throw new Error("No response body.");g.status>=400?h.reject(dh(g,g.responseText)):h.resolve(JSON.parse(g.responseText))}catch(T){if(T.name==="AbortError"){h.reject(T);return}h.reject(new Sa("request failed",T))}break}},g.upload.onprogress=T=>{var b;Ov(m),d.loaded=T.loaded,d.total=T.total,m=kv(v,3e4),(b=o.progressHandler)===null||b===void 0||b.call(o,{loaded:T.loaded,total:T.total})};var E=this.getUrl("/upload",void 0,ls.V3);a&&c&&E.searchParams.set("filename",encodeURIComponent(c)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&E.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),g.open(z.Post,E.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&g.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),g.setRequestHeader("Content-Type",u),g.send(e),l.signal.addEventListener("abort",()=>{g.abort()})}else{var R={};a&&c&&(R.filename=c);var _={"Content-Type":u};this.authedRequest(z.Post,"/upload",R,e,{prefix:ls.V3,headers:_,abortSignal:l.signal}).then(T=>this.opts.onlyData?T:T.json()).then(h.resolve,h.reject)}return d.promise=h.promise.finally(()=>{pl(this.uploads,T=>T===d)}),l.signal.addEventListener("abort",()=>{pl(this.uploads,T=>T===d),h.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(d),d.promise}cancelUpload(e){var t=this.uploads.find(r=>r.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:ls.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var mT=6*60*60*1e3,yT=30*1e3,tS=function(i){return i.Stable="stable",i.Unstable="unstable",i}({});class rS{constructor(e){var t=this;this.http=e,f(this,"capabilities",void 0),f(this,"retryTimeout",void 0),f(this,"refreshTimeout",void 0),f(this,"fetchCapabilities",S(function*(){var r=yield t.http.authedRequest(z.Get,"/capabilities");return t.capabilities=r.capabilities,t.capabilities})),f(this,"poll",S(function*(){try{yield t.fetchCapabilities(),t.clearTimeouts(),t.refreshTimeout=setTimeout(t.poll,mT),p.debug("Fetched new server capabilities")}catch(n){t.clearTimeouts();var r=Math.floor(yT+Math.random()*5e3);t.retryTimeout=setTimeout(t.poll,r),p.warn("Failed to refresh capabilities: retrying in ".concat(r,"ms"),n)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}function Pv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ys(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Pv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Pv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var nS="10",ST=["1","2","3","4","5","6","7","8","9","10"],_T=30,Ve=function(i){return i.Highlight="highlight",i.Total="total",i}({}),ye=function(i){return i.MyMembership="Room.myMembership",i.Tags="Room.tags",i.AccountData="Room.accountData",i.Receipt="Room.receipt",i.Name="Room.name",i.Redaction="Room.redaction",i.RedactionCancelled="Room.redactionCancelled",i.LocalEchoUpdated="Room.localEchoUpdated",i.Timeline="Room.timeline",i.TimelineReset="Room.timelineReset",i.TimelineRefresh="Room.TimelineRefresh",i.OldStateUpdated="Room.OldStateUpdated",i.CurrentStateUpdated="Room.CurrentStateUpdated",i.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",i.UnreadNotifications="Room.UnreadNotifications",i.Summary="Room.Summary",i}({});class eu extends Gy{constructor(e,t,r){var n,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),n=this,this.roomId=e,this.client=t,this.myUserId=r,this.opts=s,f(this,"reEmitter",void 0),f(this,"txnToEvent",new Map),f(this,"notificationCounts",{}),f(this,"threadNotifications",new Map),f(this,"cachedThreadReadReceipts",new Map),f(this,"oldestThreadedReceiptTs",1/0),f(this,"unthreadedReceipts",new Map),f(this,"timelineSets",void 0),f(this,"polls",new Map),f(this,"threadsTimelineSets",[]),f(this,"filteredTimelineSets",{}),f(this,"timelineNeedsRefresh",!1),f(this,"pendingEventList",void 0),f(this,"blacklistUnverifiedDevices",void 0),f(this,"selfMembership",void 0),f(this,"summaryHeroes",null),f(this,"getTypeWarning",!1),f(this,"getVersionWarning",!1),f(this,"membersPromise",void 0),f(this,"name",void 0),f(this,"normalizedName",void 0),f(this,"tags",{}),f(this,"accountData",new Map),f(this,"summary",null),f(this,"oldState",void 0),f(this,"currentState",void 0),f(this,"relations",void 0),f(this,"threads",new Map),f(this,"visibilityEvents",new Map),f(this,"roomReceipts",new XR(this)),f(this,"threadTimelineSetsPromise",null),f(this,"threadsReady",!1),f(this,"updateThreadRootEvents",(o,a,l)=>{if(o.length){var u;if(this.updateThreadRootEvent((u=this.threadsTimelineSets)===null||u===void 0?void 0:u[0],o,a,l),o.hasCurrentUserParticipated){var c;this.updateThreadRootEvent((c=this.threadsTimelineSets)===null||c===void 0?void 0:c[1],o,a,l)}}}),f(this,"updateThreadRootEvent",(o,a,l,u)=>{o&&a.rootEvent&&(u&&o.removeEvent(a.id),et.hasServerSideSupport?o.addLiveEvent(a.rootEvent,{duplicateStrategy:xo.Replace,fromCache:!1,roomState:this.currentState}):o.addEventToTimeline(a.rootEvent,o.getLiveTimeline(),{toStartOfTimeline:l}))}),f(this,"applyRedaction",o=>{if(o.isRedaction()){var a=o.event.redacts,l=a?this.findEventById(a):void 0;if(l){var u=l.threadRootId;if(l.makeRedacted(o,this),l.isState()){var c=this.currentState.getStateEvents(l.getType(),l.getStateKey());(c==null?void 0:c.getId())===l.getId()&&this.currentState.setStateEvents([l])}this.emit(ye.Redaction,o,this,u),this.visibilityEvents.delete(a),l.isVisibilityEvent()&&this.redactVisibilityChangeEvent(o)}}}),this.setMaxListeners(100),this.reEmitter=new Ms(this),s.pendingEventOrdering=s.pendingEventOrdering||Is.Chronological,this.name=e,this.normalizedName=e,this.relations=new Py(this.client,this),this.on(ye.Receipt,this.onReceipt),this.timelineSets=[new ns(this,s)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[ye.Timeline,ye.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===Is.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(o=>{var a=this.client.getEventMapper({toDevice:!1,decrypt:!1});o.forEach(function(){var l=S(function*(u){var c=a(u);yield t.decryptEventIfNeeded(c),c.setStatus(Re.NOT_SENT),n.addPendingEvent(c,c.getTxnId())});return function(u){return l.apply(this,arguments)}}())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return S(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Rr.My)]);var r=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=r[0],e.threadsTimelineSets[1]=r[1],r}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return S(function*(){if(e.client.isCryptoEnabled()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),r=e.getLiveTimeline().getEvents(),n=r.findIndex(o=>o.event.event_id===t),s=r.slice(n).reverse().map(o=>e.client.decryptEventIfNeeded(o));yield Promise.allSettled(s)}})()}decryptAllEvents(){var e=this;return S(function*(){if(e.client.isCryptoEnabled()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(r=>e.client.decryptEventIfNeeded(r));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(F.RoomCreate,"");return(e=t==null?void 0:t.getSender())!==null&&e!==void 0?e:null}getVersion(){var e,t=this.currentState.getStateEvents(F.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(p.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getRecommendedVersion(){var e=this;return S(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var r=t["m.room_versions"];if(!r){r={default:nS,available:{}};for(var n of ST)r.available[n]=tS.Stable}var s=e.checkVersionAgainstCapability(r);if(s.urgent&&s.needsUpgrade){p.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(o){p.warn("Failed to refresh room version capabilities",o)}if(r=t["m.room_versions"],r)s=e.checkVersionAgainstCapability(r);else return p.warn("No room version capability - assuming upgrade required."),s}return s})()}checkVersionAgainstCapability(e){var t=this.getVersion();p.log("[".concat(this.roomId,"] Current version: ").concat(t)),p.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return r;var n=Object.keys(e.available).filter(s=>e.available[s]==="stable");return n.includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?p.warn("URGENT upgrade required on ".concat(this.roomId)):p.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(F.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=pl(this.pendingEventList,function(r){return r.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.some(n=>n.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.find(n=>n.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var r=t[t.length-1];return r.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,r=this.getLiveTimeline().getEvents(),n=r[r.length-1],s=this.getLastThread();if(!s)return n;var o=s.events[s.events.length-1];return((e=n==null?void 0:n.getTs())!==null&&e!==void 0?e:0)>((t=o==null?void 0:o.getTs())!==null&&t!==void 0?t:0)?n:o}getLastThread(){return this.getThreads().reduce((e,t)=>{var r,n;if(!e)return t;var s=t.events[t.events.length-1],o=e.events[e.events.length-1];return((r=s==null?void 0:s.getTs())!==null&&r!==void 0?r:0)>=((n=o==null?void 0:o.getTs())!==null&&n!==void 0?n:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:Oe.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===Oe.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var r;return(r=this.summaryHeroes)===null||r===void 0?void 0:r[0]}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];var r=this.currentState.getMembers(),n=r.find(s=>s.userId!==this.myUserId);return n?n.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(Cy.name,"");return Array.isArray(e==null?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),r=0;if(this.getMembers().forEach(h=>{h.membership!=="join"&&h.membership!=="invite"||t.includes(h.userId)||r++}),!(r>2)){var n=(e=this.summaryHeroes)===null||e===void 0?void 0:e.filter(h=>!t.includes(h)),s=Array.isArray(n)&&n.length;if(s){var o=n.map(h=>this.getMember(h)).find(h=>!!h);if(o)return o}var a=this.getMembers(),l=a==null?void 0:a.filter(h=>!t.includes(h.userId));if(l.length<=2){var u=l.find(h=>h.userId!==this.myUserId);if(u)return u}if(s){var c=n.map(h=>this.client.getUser(h)).find(h=>!!h);if(c){var d=new bl(this.roomId,c.userId);return d.user=c,d}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===Oe.Leave&&this.cleanupAfterLeaving(),this.emit(ye.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return S(function*(){var t=e.client.store.getSyncToken(),r=yield e.client.members(e.roomId,void 0,Oe.Leave,t??void 0);return r.chunk})()}loadMembers(){var e=this;return S(function*(){var t=!1,r=yield e.client.store.getOutOfBandMembers(e.roomId);(r===null||e.hasEncryptionStateEvent())&&(t=!0,r=yield e.loadMembersFromServer(),p.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(e.roomId)));var n=r.filter(Cr).map(e.client.getEventMapper());return{memberEvents:n,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var r=this.currentState.getMembers().filter(s=>s.isOutOfBand()).map(s=>{var o;return(o=s.events.member)===null||o===void 0?void 0:o.event});p.log("LL: telling store to write ".concat(r.length)+" members for room ".concat(this.roomId));var n=this.client.store;return n.setOutOfBandMembers(this.roomId,r).catch(s=>{p.log("LL: storing OOB room members failed, oh well",s)})}}).catch(t=>{p.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return S(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{p.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),p.log(e)})}refreshLiveTimeline(){var e=this;return S(function*(){var t=e.getLiveTimeline(),r=t.getPaginationToken(ve.FORWARDS),n=t.getPaginationToken(ve.BACKWARDS),s=t.getEvents(),o=s[s.length-1];p.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(o&&o.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));var a=e.getUnfilteredTimelineSet(),l;o?(e.resetLiveTimeline(null,null),e.emit(ye.TimelineRefresh,e,a),l=yield e.client.getEventTimeline(a,o.getId())):l=yield e.client.getLatestTimeline(a);var u=a.getLiveTimeline();!u||u.getPaginationToken(Ue.Forward)===null&&u.getPaginationToken(Ue.Backward)===null&&u.getEvents().length===0?(p.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),l.setPaginationToken(r,ve.FORWARDS),a.setLiveTimeline(l),e.fixUpLegacyTimelineFields()):p.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(ye.TimelineRefresh,e,a)})()}resetLiveTimeline(e,t){for(var r of this.timelineSets)r.resetLiveTimeline(e??void 0,t??void 0);for(var n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(ve.BACKWARDS),this.currentState=this.getLiveTimeline().getState(ve.FORWARDS),e!==this.oldState&&this.emit(ye.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(ye.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[Ae.Events,Ae.Members,Ae.NewMember,Ae.Update,Ae.Marker,tt.New,tt.Update,tt.Destroy,tt.LivenessChange]),this.reEmitter.reEmit(this.currentState,[Ae.Events,Ae.Members,Ae.NewMember,Ae.Update,Ae.Marker,tt.New,tt.Update,tt.Destroy,tt.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],r=!1,n=e.getContent();for(var s of Object.values(n))for(var[o,a]of Object.entries(s))if(oh(o)&&a){for(var[l,u]of Object.entries(a))if(!(!u||typeof u!="object")){var c=u;l===this.client.getUserId()&&(c.thread_id===void 0?r=!0:typeof c.thread_id=="string"&&t.push(c.thread_id))}}r&&(t=this.getThreads().filter(I=>this.getThreadUnreadNotificationCount(I.id,Ve.Total)>0||this.getThreadUnreadNotificationCount(I.id,Ve.Highlight)>0).map(I=>I.id),t.push("main"));for(var d of t){var h,g=20,v=d==="main"?this.getLiveTimeline():(h=this.getThread(d))===null||h===void 0?void 0:h.liveTimeline;if(!v){p.warn("Couldn't find timeline for thread ID ".concat(d," in room ").concat(this.roomId));continue}for(var m=v.getEvents(),E=0,R=m.length-1;R>=0;R--){var _;if(R===m.length-g)return;var T=m[R];if(this.hasUserReadEvent(this.client.getUserId(),T.getId()))break;var b=this.client.getPushActionsForEvent(T);E+=b!=null&&(_=b.tweaks)!==null&&_!==void 0&&_.highlight?1:0}d==="main"?this.setUnreadNotificationCount(Ve.Highlight,E):this.setThreadUnreadNotificationCount(d,Ve.Highlight,E)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var r=this.getThreads(),n=0;n<r.length;n++){var s=r[n];if(t=s.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ve.Total,t=this.getRoomUnreadNotificationCount(e);for(var r of this.threadNotifications.values()){var n;t+=(n=r[e])!==null&&n!==void 0?n:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ve.Total,r=arguments.length>1?arguments[1]:void 0,n=!!r.threadRootId&&!r.isThreadRoot;return(e=n?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ve.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ve.Total;return(t=(r=this.threadNotifications.get(e))===null||r===void 0?void 0:r[n])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,r;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((r=e.total)!==null&&r!==void 0?r:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,s,o=Ys({highlight:(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n.highlight,total:(s=this.threadNotifications.get(e))===null||s===void 0?void 0:s.total},{[t]:r});this.threadNotifications.set(e,o),this.emit(ye.UnreadNotifications,o,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var r,n;if(((r=t.highlight)!==null&&r!==void 0?r:0)>0)return Ve.Highlight;((n=t.total)!==null&&n!==void 0?n:0)>0&&!e&&(e=Ve.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[r,n]of this.threadNotifications)e.includes(r)||(n.total=0,t||(n.highlight=0));this.emit(ye.UnreadNotifications)}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(ye.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t=e["m.heroes"],r=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(r)&&this.currentState.setJoinedMemberCount(r),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter(s=>s!==this.myUserId)),this.emit(ye.Summary,e)}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,o=this.currentState.getStateEvents(F.RoomAvatar,"");if(!o&&!s)return null;var a=o?o.getContent().url:null;return a?Ql(e,a,t,r,n):null}getMxcAvatarUrl(){var e;return((e=this.currentState.getStateEvents(F.RoomAvatar,""))===null||e===void 0||(e=e.getContent())===null||e===void 0?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents(F.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents(F.RoomCanonicalAlias,"");return e?e.getContent().alt_aliases||[]:[]}addEventsToTimeline(e,t,r,n){r.getTimelineSet().addEventsToTimeline(e,t,r,n)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(Oe.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return S(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(Oe.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(Oe.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(F.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var r=this.getMember(e);return r?r.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var s=Object.assign({filter:e,pendingEvents:n},this.opts),o=new ns(this,s);this.reEmitter.reEmit(o,[ye.Timeline,ye.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));var a=this.getLiveTimeline();if(t){a.getEvents().forEach(function(c){o.addLiveEvent(c)});for(var l=a;l.getNeighbouringTimeline(ve.BACKWARDS);)l=l.getNeighbouringTimeline(ve.BACKWARDS);o.getLiveTimeline().setPaginationToken(l.getPaginationToken(ve.BACKWARDS),ve.BACKWARDS)}else if(r){var u=a.getPaginationToken(Ue.Forward);o.getLiveTimeline().setPaginationToken(u,Ue.Backward)}return o}getThreadListFilter(){var e=arguments,t=this;return S(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:Rr.All,n=t.client.getUserId(),s=new rr(n),o={room:{timeline:{[gs.name]:[Je.name]}}};r===Rr.My&&(o.room.timeline[vs.name]=[n]),s.setDefinition(o);var a=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(r),s);return s.filterId=a,s})()}createThreadTimelineSet(e){var t=this;return S(function*(){var r;if(et.hasServerSideListSupport)r=new ns(t,Ys(Ys({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Rr.All),t.reEmitter.reEmit(r,[ye.Timeline,ye.TimelineReset]);else if(et.hasServerSideSupport){var n=yield t.getThreadListFilter(e);r=t.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else r=new ns(t,{pendingEvents:!1}),Array.from(t.threads).forEach(s=>{var[,o]=s;if(o.length!==0){var a=o.timeline.some(l=>l.getSender()===t.client.getUserId());(e!==Rr.My||a)&&r.getLiveTimeline().addEvent(o.rootEvent,{toStartOfTimeline:!1})}});return r})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var r of e)ve.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}fetchRoomThreads(){var e=this;return S(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(et.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Rr.All),e.fetchRoomThreadList(Rr.My)]);else{var t=yield e.getThreadListFilter(),{chunk:r}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,Ue.Backward,t);if(!r.length)return;var n=r.map(e.client.getEventMapper()).sort((h,g)=>{var v=h.getServerAggregatedRelation(Je.name),m=g.getServerAggregatedRelation(Je.name);return v.latest_event.origin_server_ts-m.latest_event.origin_server_ts}),s,o=e.getLiveTimeline().getState(ve.FORWARDS);for(var a of n){var l,u={duplicateStrategy:xo.Ignore,fromCache:!1,roomState:o};(l=e.threadsTimelineSets[0])===null||l===void 0||l.addLiveEvent(a,u);var c=a.getServerAggregatedRelation(Je.name);if(c!=null&&c.current_user_participated){var d;(d=e.threadsTimelineSets[1])===null||d===void 0||d.addLiveEvent(a,u),s=a}}e.processThreadRoots(n,!0),e.client.decryptEventIfNeeded(n[n.length-1]),s&&e.client.decryptEventIfNeeded(s)}e.on(Ht.NewReply,e.onThreadReply),e.on(Ht.Update,e.onThreadUpdate),e.on(Ht.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return S(function*(){for(var r of e)try{if(!r.isEncrypted()&&!$y(r))continue;yield t.client.decryptEventIfNeeded(r),t.processPollEvent(r)}catch(n){p.warn("Error processing poll event",r.getId(),n)}})()}processPollEvent(e){var t=this;return S(function*(){if(e.isDecryptionFailure()){e.once(Fe.Decrypted,o=>{t.processPollEvent(o)});return}if(sr.M_POLL_START.matches(e.getType())){try{var r=new Hy(e,t.client,t);t.polls.set(e.getId(),r),t.emit(jn.New,r),e.once(Fe.BeforeRedaction,o=>{t.polls.delete(o.getId())})}catch{}return}var n=e.relationEventId;if(n&&t.polls.has(n)){var s=t.polls.get(n);s==null||s.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return S(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var r=e===Rr.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:n,end:s}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,Ue.Backward,r.threadListType,r.getFilter());if(r.getLiveTimeline().setPaginationToken(s??null,Ue.Backward),!!n.length){var o=n.map(t.client.getEventMapper());t.processThreadRoots(o,!0);var a=t.getLiveTimeline().getState(ve.FORWARDS);for(var l of o)r.addLiveEvent(l,{duplicateStrategy:xo.Replace,fromCache:!1,roomState:a})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var r=this.getTimelineForEvent(e.id),n=r==null||(t=r.getEvents())===null||t===void 0?void 0:t.find(o=>o.getId()===e.id);n?e.clearEventMetadata(n):p.debug("onThreadDelete: Could not find root event in room timeline");for(var s of this.threadsTimelineSets)s.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){var n;if(!((n=this.client)!==null&&n!==void 0&&n.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||r!=null&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var s=e.isRelation(Je.name),o=e.getAssociatedId(),a=e.threadRootId;if(o&&!s&&(a===o||r!=null&&r.has(o)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var l;if(o){var u;l=(u=this.findEventById(o))!==null&&u!==void 0?u:t==null?void 0:t.find(c=>c.getId()===o)}return l&&!s?this.eventShouldLiveIn(l,t,r):a!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:a}:!o||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getThread(e);if(n)n.addEvents(t,r);else{var s,o=(s=this.findEventById(e))!==null&&s!==void 0?s:t.find(a=>a.getId()===e);this.createThread(e,o,t,r)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);var r={};for(var n of e){var s,{threadId:o,shouldLiveInThread:a}=this.eventShouldLiveIn(n);a&&!r[o]&&(r[o]=[]),(s=r[o])===null||s===void 0||s.push(n)}Object.entries(r).map(l=>{var[u,c]=l;return this.addThreadedEvents(u,c,t)})}createThread(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],s=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var o=this.relations.getAllChildEventsForEvent(t.getId());o!=null&&o.length&&(n=n.concat(o.filter(l=>!l.isRelation(lt.Replace))))}var a=new et(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(r=this.cachedThreadReadReceipts.get(e))!==null&&r!==void 0?r:[]});return this.reEmitter.reEmit(a,[Ht.Delete,Ht.Update,Ht.NewReply,ye.Timeline,ye.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(a.id,a),a.addEvents(n,!1),this.threadsReady&&a.initialEventsFetched&&this.updateThreadRootEvents(a,s,!1),this.emit(Ht.New,a,s),a}processLiveEvent(e){this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[r,n]of this.txnToEvent)if(n.getId()===e.getId()){p.debug("processLiveEvent: found sent event without txn ID: ",r,e.getId());var s=e.getUnsigned();s.transaction_id=r,e.setUnsigned(s);break}}}addLiveEvent(e,t){var{duplicateStrategy:r,timelineWasEmpty:n,fromCache:s}=t;for(var o of this.timelineSets)o.addLiveEvent(e,{duplicateStrategy:r,fromCache:s,timelineWasEmpty:n});e.sender&&e.getType()!==F.RoomRedaction&&this.addReceipt(Wy(e.sender.userId,e,Gt.Read),!0)}addPendingEvent(e,t){if(e.status!==Re.SENDING&&e.status!==Re.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(ve.setEventMetadata(e,this.getLiveTimeline().getState(ve.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(o=>o.status===Re.NOT_SENT)&&(p.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(Re.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this.pendingEventList.find(o=>o.getId()===r);!n&&r&&(n=this.findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit(ye.Redaction,e,this,n.threadRootId))}}else for(var s of this.timelineSets)s.getFilter()?s.getFilter().filterRoomTimeline([e]).length&&s.addEventToTimeline(e,s.getLiveTimeline(),{toStartOfTimeline:!1}):s.addEventToTimeline(e,s.getLiveTimeline(),{toStartOfTimeline:!1});this.emit(ye.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>Ys(Ys({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var r=t.type===F.RoomMessageEncrypted,n=this.hasEncryptionStateEvent();return r||!n});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var r=t.getId(),n=e.getId(),s=t.status;p.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(s)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:o,threadId:a}=this.eventShouldLiveIn(e),l=a?this.getThread(a):null;if(l==null||l.setEventMetadata(t),l==null||l.timelineSet.handleRemoteEcho(t,r,n),o)for(var u of this.timelineSets)u.handleRemoteEcho(t,r,n);this.emit(ye.LocalEchoUpdated,t,this,r,s)}updatePendingEvent(e,t,r){if(p.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==Re.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==Re.SENT){var n=this.getTimelineForEvent(r);if(n){var s=this.findEventById(r),o=s==null?void 0:s.getUnsigned().transaction_id;if(!o&&s){var a=s.getUnsigned();a.transaction_id=e.getTxnId(),s.setUnsigned(a),this.removeEvent(s.getId()),this.handleRemoteEcho(s,e)}return}}var l=e.status,u=e.getId();if(!l)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var c=bT[l];if(!(c!=null&&c.includes(t)))throw new Error("Invalid EventStatus transition ".concat(l,"->").concat(t));if(e.setStatus(t),t==Re.SENT){e.replaceLocalEventId(r);var{shouldLiveInRoom:d,threadId:h}=this.eventShouldLiveIn(e),g=h?this.getThread(h):void 0;if(g==null||g.setEventMetadata(e),g==null||g.timelineSet.replaceEventId(u,r),d)for(var v of this.timelineSets)v.replaceEventId(u,r)}else if(t==Re.CANCELLED){if(this.pendingEventList){var m=this.getPendingEvent(u);this.removePendingEvent(u),m!=null&&m.isRedaction()&&this.revertRedactionLocalEcho(m)}this.removeEvent(u)}this.savePendingEvents(),this.emit(ye.LocalEchoUpdated,e,this,u,l)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(ye.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}}addLiveEvents(e,t){var r=this;return S(function*(){var{duplicateStrategy:n,fromCache:s,timelineWasEmpty:o=!1}=t??{};if(n&&["replace","ignore"].indexOf(n)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(var a=0;a<r.timelineSets.length;a++){var l=r.timelineSets[a].getLiveTimeline();if(l.getPaginationToken(ve.FORWARDS))throw new Error("live timeline "+a+" is no longer live - it has a pagination token ("+l.getPaginationToken(ve.FORWARDS)+")");if(l.getNeighbouringTimeline(ve.FORWARDS))throw new Error("live timeline ".concat(a," is no longer live - it has a neighbouring timeline"))}var u=r.findThreadRoots(e),c={},d={duplicateStrategy:n,fromCache:s,timelineWasEmpty:o},h=[...e];for(var g of e){var v,m,E;if(r.processLiveEvent(g),g.getUnsigned().transaction_id){var R=r.txnToEvent.get(g.getUnsigned().transaction_id);if(R){r.handleRemoteEcho(g,R);continue}}var{shouldLiveInRoom:_,shouldLiveInThread:T,threadId:b}=r.eventShouldLiveIn(g,h,u);if(!T&&!_&&g.isRelation())try{var I=new Ot(yield r.client.fetchRoomEvent(r.roomId,g.relationEventId));if(h.push(I),I.threadRootId){u.add(I.threadRootId);var y=g.getUnsigned();y[_l.name]=I.threadRootId,g.setUnsigned(y)}({shouldLiveInRoom:_,shouldLiveInThread:T,threadId:b}=r.eventShouldLiveIn(g,h,u))}catch(w){p.error("Failed to load parent event of unhandled relation",w)}if(T&&!c[(v=b)!==null&&v!==void 0?v:""]){var C;c[(C=b)!==null&&C!==void 0?C:""]=[]}(m=c[(E=b)!==null&&E!==void 0?E:""])===null||m===void 0||m.push(g),_?r.addLiveEvent(g,d):!T&&g.isRelation()&&r.relations.aggregateChildEvent(g)}Object.entries(c).forEach(w=>{var[D,x]=w;r.addThreadedEvents(D,x,!1)})})()}partitionThreadedEvents(e){var t=0,r=1,n=2;if(this.client.supportsThreads()){var s=this.findThreadRoots(e);return e.reduce((o,a)=>{var{shouldLiveInRoom:l,shouldLiveInThread:u,threadId:c}=this.eventShouldLiveIn(a,e,s);return l&&o[t].push(a),u&&(a.setThreadId(c??""),o[r].push(a)),!u&&!l&&o[n].push(a),o},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var r of e){var n=r.threadRootId;n!=null&&t.add(n)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach(n=>{Object.keys(r[n]).forEach(s=>{Object.keys(r[n][s]).forEach(o=>{var a,l,u,c=r[n][s][o],d=!c.thread_id||c.thread_id===ya,h=d?this:this.threads.get((a=c.thread_id)!==null&&a!==void 0?a:"");if(h){if(h.addReceiptToStructure(n,s,o,c,t),!t&&this.client.isInitialSyncComplete()&&o===this.client.getUserId()){var g=h.timeline[h.timeline.length-1];g&&n===g.getId()&&o===g.getSender()&&(h.setUnread(Ve.Total,0),h.setUnread(Ve.Highlight,0))}}else{var v;this.cachedThreadReadReceipts.set(c.thread_id,[...(v=this.cachedThreadReadReceipts.get(c.thread_id))!==null&&v!==void 0?v:[],{eventId:n,receiptType:s,userId:o,receipt:c,synthetic:t}])}var m=this.client.getUserId();o===m&&!d&&c.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=c.ts),!c.thread_id&&c.ts>((l=(u=this.unthreadedReceipts.get(o))===null||u===void 0?void 0:u.ts)!==null&&l!==void 0?l:0)&&this.unthreadedReceipts.set(o,c)})})}),this.emit(ye.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===F.Typing?this.currentState.setTypingEvent(t):t.getType()===F.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var r of this.timelineSets){var n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(F.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===Oe.Invite){var r=e.getUnsigned().invite_room_state||[];r.forEach(s=>{var o=this.currentState.getStateEvents(s.type,s.state_key);o||this.currentState.setStateEvents([new Ot({type:s.type,state_key:s.state_key,content:s.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var n=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=_R(this.name),this.summary=new My(this.roomId,{title:this.name}),n!==this.name&&this.emit(ye.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(ye.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var r=t.getType(),n=this.accountData.get(r);this.accountData.set(r,t),this.emit(ye.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===Oe.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(F.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(F.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===Oe.Join,r=this.currentState.getStateEvents(F.RoomPowerLevels,""),n=r&&r.getContent(),s=this.getMember(e);return n&&s&&n.invite>s.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(F.RoomCreate,"");if(!e){this.getTypeWarning||(p.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[Sl]}isSpaceRoom(){return this.getType()===as.Space}isCallRoom(){return this.getType()===as.UnstableCall}isElementVideoRoom(){return this.getType()===as.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(ve.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case Fr.Actual:return e.name;case Fr.Generated:switch(e.subtype){case"Inviting":return"Inviting ".concat(Mv(e.names,e.count));default:return Mv(e.names,e.count)}case Fr.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var r=this.currentState.getStateEvents(F.RoomName,"");if(r!=null&&r.getContent().name)return this.roomNameGenerator({type:Fr.Actual,name:r.getContent().name})}var n=this.getCanonicalAlias();if(n)return this.roomNameGenerator({type:Fr.Actual,name:n});var s=this.currentState.getJoinedMemberCount(),o=this.currentState.getInvitedMemberCount(),a=s+o-1,l=this.getFunctionalMembers(),u=[];if(this.summaryHeroes)this.summaryHeroes.forEach(E=>{if(l.includes(E)){a--;return}var R=this.getMember(E);u.push(R?R.name:E)});else{var c=this.currentState.getMembers().filter(E=>E.userId!==e&&(E.membership===Oe.Invite||E.membership===Oe.Join));c=c.filter(E=>{var{userId:R}=E;return l.includes(R)?(a--,!1):!0}),c.sort((E,R)=>CR(E.userId,R.userId)),c=c.slice(0,5),u=c.map(E=>E.name)}if(a)return this.roomNameGenerator({type:Fr.Generated,names:u,count:a});var d=this.getMyMembership();if(d==Oe.Join){var h=this.currentState.getStateEvents(F.RoomThirdPartyInvite);if(h!=null&&h.length){var g=h.map(E=>E.getContent().display_name);return this.roomNameGenerator({type:Fr.Generated,subtype:"Inviting",names:g,count:g.length+1})}}var v=u;v.length||(v=this.currentState.getMembers().filter(E=>E.userId!==e&&E.membership!==Oe.Invite&&E.membership!==Oe.Join).map(E=>E.name));var m;return v.length&&(m=this.roomNameGenerator({type:Fr.Generated,names:v,count:v.length+1})),this.roomNameGenerator({type:Fr.EmptyRoom,oldName:m})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var r=e.getSender();if(r){var n=Oi.name&&this.currentState.maySendStateEvent(Oi.name,r)||Oi.altName&&this.currentState.maySendStateEvent(Oi.altName,r);if(n){var s=this.visibilityEvents.get(t.eventId);if(s){for(var o=s.length-1,a=Math.max(0,s.length-_T);o>=a;--o){var l=s[o];if(l.getTs()<e.getTs())break}o===-1?s.unshift(e):s.splice(o+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var u=this.findEventById(t.eventId);u&&u.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),r=t==null?void 0:t.event_id,n=this.visibilityEvents.get(r);if(n){var s=n.findIndex(u=>u.getId()===e.getId());if(s!==-1&&(n.splice(s,1),s===n.length)){var o=this.findEventById(r);if(!o)return;if(s===0)this.visibilityEvents.delete(r),o.applyVisibilityEvent();else{var a=n[n.length-1],l=a.asVisibilityChange();if(!l)throw new Error("at this stage, visibility changes should be well-formed");o.applyVisibilityEvent(l)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,!(r.getTs()<e.getTs())&&e.applyVisibilityEvent(n))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(n=>this.getThreadUnreadNotificationCount(n.id,Ve.Total)>0);for(var r of t)r.fixupNotifications(e)}compareEventOrdering(e,t){return sT(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(ve.FORWARDS))===null||e===void 0)&&e.getStateEvents(F.RoomEncryption,""))}}var bT={[Re.ENCRYPTING]:[Re.SENDING,Re.NOT_SENT,Re.CANCELLED],[Re.SENDING]:[Re.ENCRYPTING,Re.QUEUED,Re.NOT_SENT,Re.SENT],[Re.QUEUED]:[Re.SENDING,Re.NOT_SENT,Re.CANCELLED],[Re.SENT]:[],[Re.NOT_SENT]:[Re.SENDING,Re.QUEUED,Re.CANCELLED],[Re.CANCELLED]:[]},Fr=function(i){return i[i.EmptyRoom=0]="EmptyRoom",i[i.Generated=1]="Generated",i[i.Actual=2]="Actual",i}({});function Mv(i,e){var t=e-1;if(i.length){if(i.length===1&&t<=1)return i[0];if(i.length===2&&t<=2)return"".concat(i[0]," and ").concat(i[1]);var r=t>1;return r?"".concat(i[0]," and ").concat(t," others"):"".concat(i[0]," and 1 other")}else return"Empty room"}var gt=function(i){return i[i.Stable=0]="Stable",i[i.Unstable=1]="Unstable",i[i.Unsupported=2]="Unsupported",i}({}),dt=function(i){return i.Thread="Thread",i.ThreadUnreadNotifications="ThreadUnreadNotifications",i.LoginTokenRequest="LoginTokenRequest",i.RelationBasedRedactions="RelationBasedRedactions",i.AccountDataDeletion="AccountDataDeletion",i.RelationsRecursion="RelationsRecursion",i.IntentionalMentions="IntentionalMentions",i.MigrateServerNameToVia="MigrateServerNameToVia",i}({}),ET={[dt.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[dt.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[dt.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[dt.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[dt.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[dt.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"]},[dt.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"},[dt.MigrateServerNameToVia]:{unstablePrefixes:["org.matrix.msc4156"]}};function wT(i){return Gc.apply(this,arguments)}function Gc(){return Gc=S(function*(i){var e=new Map;for(var[t,r]of Object.entries(ET)){var n,s,o,a,l=(n=(s=i.versions)===null||s===void 0?void 0:s.includes(r.matrixVersion||""))!==null&&n!==void 0?n:!1,u=(o=(a=r.unstablePrefixes)===null||a===void 0?void 0:a.every(c=>{var d;return((d=i.unstable_features)===null||d===void 0?void 0:d[c])===!0}))!==null&&o!==void 0?o:!1;l?e.set(t,gt.Stable):u?e.set(t,gt.Unstable):e.set(t,gt.Unsupported)}return e}),Gc.apply(this,arguments)}function Av(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Rl(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Av(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Av(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Dv=80*1e3,RT=3,$e=function(i){return i.Error="ERROR",i.Prepared="PREPARED",i.Stopped="STOPPED",i.Syncing="SYNCING",i.Catchup="CATCHUP",i.Reconnecting="RECONNECTING",i}({}),TT=["org.matrix.msc2716v3"];function Uv(i,e){return"FILTER_SYNC_".concat(i)+(e?"_"+e:"")}function nt(){p.log(...arguments)}var iS=function(i){return i.Offline="offline",i.Online="online",i.Unavailable="unavailable",i}({});function sS(i){return Rl({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:Is.Chronological,threadSupport:!1},i)}function oS(i){return Rl({canResetEntireTimeline:e=>!1},i)}class bo{constructor(e,t,r){var n=this;this.client=e,f(this,"opts",void 0),f(this,"syncOpts",void 0),f(this,"_peekRoom",null),f(this,"currentSyncRequest",void 0),f(this,"abortController",void 0),f(this,"syncState",null),f(this,"syncStateData",void 0),f(this,"catchingUp",!1),f(this,"running",!1),f(this,"keepAliveTimer",void 0),f(this,"connectionReturnedDefer",void 0),f(this,"notifEvents",[]),f(this,"failedSyncCount",0),f(this,"storeIsInvalid",!1),f(this,"presence",void 0),f(this,"getPushRules",S(function*(){try{nt("Getting push rules...");var s=yield n.client.getPushRules();nt("Got push rules"),n.client.pushRules=s}catch(o){return p.error("Getting push rules failed",o),n.shouldAbortSync(o)?void 0:(nt("Waiting for saved sync before retrying push rules..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,o),n.getPushRules())}})),f(this,"buildDefaultFilter",()=>{var s=new rr(this.client.credentials.userId);return this.client.canSupport.get(dt.ThreadUnreadNotifications)!==gt.Unsupported&&s.setUnreadThreadNotifications(!0),s}),f(this,"prepareLazyLoadingForSync",S(function*(){if(nt("Prepare lazy loading for sync..."),n.client.isGuest()&&(n.opts.lazyLoadMembers=!1),n.opts.lazyLoadMembers&&(nt("Enabling lazy load on sync filter..."),n.opts.filter||(n.opts.filter=n.buildDefaultFilter()),n.opts.filter.setLazyLoadMembers(!0)),n.opts.lazyLoadMembers){var s;(s=n.syncOpts.crypto)===null||s===void 0||s.enableLazyLoading()}})),f(this,"storeClientOptions",S(function*(){try{nt("Storing client options..."),yield n.client.storeClientOptions(),nt("Stored client options")}catch(s){throw p.error("Storing client options failed",s),s}})),f(this,"getFilter",S(function*(){nt("Getting filter...");var s;n.opts.filter?s=n.opts.filter:s=n.buildDefaultFilter();var o;try{o=yield n.client.getOrCreateFilter(Uv(n.client.credentials.userId),s)}catch(a){return p.error("Getting filter failed",a),n.shouldAbortSync(a)?{}:(nt("Waiting for saved sync before retrying filter..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,a),n.getFilter())}return{filter:s,filterId:o}})),f(this,"savedSyncPromise",void 0),f(this,"onOnline",()=>{nt("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=sS(t),this.syncOpts=oS(r),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[ye.Timeline,ye.TimelineReset])}createRoom(e){var t=aS(this.client,e,this.opts);return t.on(Ae.Marker,(r,n)=>{this.onMarkerStateEvent(t,r,n)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:r}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(r){p.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var n=TT.includes(e.getVersion())||t.getSender()===e.getCreator();n?(p.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(ye.HistoryImportedWithinTimeline,t,e)):p.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return S(function*(){var t,r=e.client,n=new rr(e.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);var s=e.opts.pollTimeout+Dv,o=yield r.getOrCreateFilter(Uv(r.credentials.userId,"LEFT_ROOMS"),n),a={timeout:0,filter:o},l=yield r.http.authedRequest(z.Get,"/sync",a,void 0,{localTimeoutMs:s}),u=[];(t=l.rooms)!==null&&t!==void 0&&t.leave&&(u=e.mapSyncResponseToRoomArray(l.rooms.leave));var c=yield Promise.all(u.map(function(){var d=S(function*(h){var g=h.room;if(h.isBrandNewRoom){h.timeline=h.timeline||{prev_batch:null,events:[]};var v=e.mapSyncEventsFormat(h.timeline,g),m=e.mapSyncEventsFormat(h.state,g);return g.getLiveTimeline().setPaginationToken(h.timeline.prev_batch,ve.BACKWARDS),yield e.injectRoomEvents(g,m,v),g.recalculate(),r.store.storeRoom(g),r.emit(_e.Room,g),e.processEventsForNotifs(g,v),g}});return function(h){return d.apply(this,arguments)}}()));return c.filter(Boolean)})()}peek(e){var t;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var r=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then(n=>{var s;if(((s=this._peekRoom)===null||s===void 0?void 0:s.roomId)!==e)throw new Error("Peeking aborted");n.messages=n.messages||{chunk:[]},n.messages.chunk=n.messages.chunk||[],n.state=n.state||[];var o=Jl(n.state).map(r.getEventMapper()),a=n.state.map(r.getEventMapper()),l=n.messages.chunk.map(r.getEventMapper());return Array.isArray(n.presence)&&n.presence.map(r.getEventMapper()).forEach(function(u){var c=r.store.getUser(u.getContent().user_id);c?c.setPresenceEvent(u):(c=En.createUser(u.getContent().user_id,r),c.setPresenceEvent(u),r.store.storeUser(c)),r.emit(_e.Event,u)}),n.messages.start&&(this._peekRoom.oldState.paginationToken=n.messages.start),this._peekRoom.oldState.setStateEvents(o),this._peekRoom.currentState.setStateEvents(a),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(l.reverse(),!0,this._peekRoom.getLiveTimeline(),n.messages.start),r.store.storeRoom(this._peekRoom),r.emit(_e.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var r,n=this;if(this._peekRoom!==e){nt("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(z.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal}).then(function(){var s=S(function*(o){if(n._peekRoom!==e){nt("Stopped peeking in room %s",e.roomId);return}o.chunk.filter(function(l){return l.type==="m.presence"}).map(n.client.getEventMapper()).forEach(l=>{var u=n.client.store.getUser(l.getContent().user_id);u?u.setPresenceEvent(l):(u=En.createUser(l.getContent().user_id,n.client),u.setPresenceEvent(l),n.client.store.storeUser(u)),n.client.emit(_e.Event,l)});var a=o.chunk.filter(function(l){return l.room_id===e.roomId&&l.event_id}).map(n.client.getEventMapper());yield e.addLiveEvents(a),n.peekPoll(e,o.end)});return function(o){return s.apply(this,arguments)}}(),s=>{p.error("[%s] Peek poll failed: %s",e.roomId,s),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var r=this;return S(function*(){yield e;var n=r.startKeepAlives();r.updateSyncState($e.Error,{error:t}),yield n})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(p.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState($e.Error,{error:e}),!0):!1}sync(){var e=this;return S(function*(){var t,r;if(e.running=!0,e.abortController=new AbortController,(t=global.window)===null||t===void 0||(r=t.addEventListener)===null||r===void 0||r.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});nt("Getting saved sync token...");var n=e.client.store.getSavedSyncToken().then(c=>(nt("Got saved sync token"),c));e.savedSyncPromise=e.client.store.getSavedSync().then(c=>{if(nt("Got reply from saved sync, exists? ".concat(!!c)),c)return e.syncFromCache(c)}).catch(c=>{p.error("Getting saved sync failed",c)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:s,filter:o}=yield e.getFilter();if(o){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var a=s,l=yield n;if(l)nt("Sending first sync request...");else{nt("Sending initial sync request...");var u=e.buildDefaultFilter();u.setDefinition(o.getDefinition()),u.setTimelineLimit(e.opts.initialSyncLimit),a=JSON.stringify(u.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:a},l)}return nt("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:s})}})()}stop(){var e,t,r;nt("SyncApi.stop"),(e=global.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(r=this.abortController)===null||r===void 0||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedDefer?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return S(function*(){nt("sync(): not doing HTTP hit, instead returning stored /sync data");var r=e.nextBatch;t.client.store.setSyncToken(r);var n={nextSyncToken:r,catchingUp:!1,fromCache:!0},s={next_batch:r,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(n,s)}catch(o){p.error("Error processing cached sync",o)}t.storeIsInvalid||t.updateSyncState($e.Prepared,n)})()}doSync(e){var t=this;return S(function*(){for(;t.running;){var r=t.client.store.getSyncToken(),n=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,r)),n=yield t.currentSyncRequest}catch(a){var s=yield t.onSyncError(a);if(s)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(n.next_batch),t.failedSyncCount=0;var o={oldSyncToken:r??void 0,nextSyncToken:n.next_batch,catchingUp:t.catchingUp};t.syncOpts.crypto&&(yield t.syncOpts.crypto.onSyncWillProcess(o));try{yield t.processSyncResponse(o,n)}catch(a){p.error("Caught /sync error",a),t.client.emit(_e.SyncUnexpectedError,a)}yield t.client.store.setSyncData(n),o.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState($e.Prepared,o),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(o)),t.updateSyncState($e.Syncing,o),t.client.store.wantsSave()&&(t.syncOpts.crypto&&(yield t.syncOpts.crypto.saveDeviceList(0)),yield t.client.store.save())}t.running||(nt("Sync no longer running: exiting."),t.connectionReturnedDefer&&(t.connectionReturnedDefer.reject(),t.connectionReturnedDefer=void 0),t.updateSyncState($e.Stopped))})()}doSyncRequest(e,t){var r,n=this.getSyncParams(e,t);return this.client.http.authedRequest(z.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+Dv,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal})}getSyncParams(e,t){var r=this.opts.pollTimeout;(this.getSyncState()!==$e.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);var n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());var s={filter:n,timeout:r};return this.opts.disablePresence?s.set_presence=iS.Offline:this.presence!==void 0&&(s.set_presence=this.presence),t?s.since=t:s._cacheBuster=Date.now(),[$e.Reconnecting,$e.Error].includes(this.getSyncState())&&(s.timeout=0),s}setPresence(e){this.presence=e}onSyncError(e){var t=this;return S(function*(){if(!t.running)return nt("Sync no longer running: exiting"),t.connectionReturnedDefer&&(t.connectionReturnedDefer.reject(),t.connectionReturnedDefer=void 0),t.updateSyncState($e.Stopped),!0;if(p.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,p.log("Number of consecutive failed sync requests:",t.failedSyncCount),nt("Starting keep-alive");var r=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=RT?$e.Error:$e.Reconnecting,{error:e});var n=yield r;return n&&t.getSyncState()===$e.Error&&t.updateSyncState($e.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var r=this;return S(function*(){var n,s,o,a,l=r.client;if(Array.isArray((n=t.presence)===null||n===void 0?void 0:n.events)&&t.presence.events.filter(Cr).map(l.getEventMapper()).forEach(function(R){var _=l.store.getUser(R.getSender());_?_.setPresenceEvent(R):(_=En.createUser(R.getSender(),l),_.setPresenceEvent(R),l.store.storeUser(_)),l.emit(_e.Event,R)}),Array.isArray((s=t.account_data)===null||s===void 0?void 0:s.events)){var u=t.account_data.events.filter(Cr).map(l.getEventMapper()),c=u.reduce((R,_)=>(R[_.getType()]=l.store.getAccountData(_.getType()),R),{});l.store.storeAccountDataEvents(u),u.forEach(function(R){if(R.getType()===F.PushRules){var _=R.getContent();l.setPushRules(_)}var T=c[R.getType()];return l.emit(_e.AccountData,R,T),R})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var d=t.to_device.events.filter(Cr);r.syncOpts.cryptoCallbacks&&(d=yield r.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(d));var h=[];d.map(l.getEventMapper({toDevice:!0})).map(R=>{if(R.getType()==="m.key.verification.cancel"){var _=R.getContent().transaction_id;_&&h.push(_)}return R}).forEach(function(R){var _=R.getContent();if(R.getType()=="m.room.message"&&_.msgtype=="m.bad.encrypted"){p.log("Ignoring undecryptable to-device event from "+R.getSender());return}if(R.getType()==="m.key.verification.start"||R.getType()==="m.key.verification.request"){var T=_.transaction_id;h.includes(T)&&R.flagCancelled()}l.emit(_e.ToDeviceEvent,R)})}else r.catchingUp=!1;var g=[],v=[],m=[],E=[];t.rooms&&(t.rooms.invite&&(g=r.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(v=r.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(m=r.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(E=r.mapSyncResponseToRoomArray(t.rooms.knock))),r.notifEvents=[],yield rs(g,function(){var R=S(function*(_){var T,b=_.room,I=r.mapSyncEventsFormat(_.invite_state,b);yield r.injectRoomEvents(b,I);var y=(T=b.currentState.getStateEvents(F.RoomMember,l.getUserId()))===null||T===void 0?void 0:T.getSender(),C=l.crypto;if(C){var w=yield C.cryptoStore.takeParkedSharedHistory(b.roomId);for(var D of w)D.senderId===y&&(yield C.olmDevice.addInboundGroupSession(b.roomId,D.senderKey,D.forwardingCurve25519KeyChain,D.sessionId,D.sessionKey,D.keysClaimed,!0,{sharedHistory:!0,untrusted:!0}))}_.isBrandNewRoom?(b.recalculate(),l.store.storeRoom(b),l.emit(_e.Room,b)):b.recalculate(),I.forEach(function(x){l.emit(_e.Event,x)})});return function(_){return R.apply(this,arguments)}}()),yield rs(v,function(){var R=S(function*(_){var T,b=_.room,I=r.mapSyncEventsFormat(_.state,b),y=r.mapSyncEventsFormat(_.timeline,b,!1),C=r.mapSyncEventsFormat(_.ephemeral),w=r.mapSyncEventsFormat(_.account_data),D=r.isRoomEncrypted(b,I,y);if(_.unread_notifications){if(!D||_.unread_notifications.notification_count===0){var x;b.setUnreadNotificationCount(Ve.Total,(x=_.unread_notifications.notification_count)!==null&&x!==void 0?x:0)}if(!D||b.getUnreadNotificationCount(Ve.Highlight)<=0){var G;b.setUnreadNotificationCount(Ve.Highlight,(G=_.unread_notifications.highlight_count)!==null&&G!==void 0?G:0)}}var oe=(T=_[ra.name])!==null&&T!==void 0?T:_[ra.altName];if(oe){b.resetThreadUnreadNotificationCountFromSync(Object.keys(oe));for(var[de,Ee]of Object.entries(oe)){if(!D||Ee.notification_count===0){var X;b.setThreadUnreadNotificationCount(de,Ve.Total,(X=Ee.notification_count)!==null&&X!==void 0?X:0)}var re=b.getThreadUnreadNotificationCount(de,Ve.Highlight)<=0;if(!D||D&&re){var Z;b.setThreadUnreadNotificationCount(de,Ve.Highlight,(Z=Ee.highlight_count)!==null&&Z!==void 0?Z:0)}}}else b.resetThreadUnreadNotificationCountFromSync();if(_.timeline=_.timeline||{},_.isBrandNewRoom)_.timeline.prev_batch!==null&&b.getLiveTimeline().setPaginationToken(_.timeline.prev_batch,ve.BACKWARDS);else if(_.timeline.limited){for(var ne=!0,ce=y.length-1;ce>=0;ce--){var we=y[ce].getId();if(b.getTimelineForEvent(we)){nt("Already have event ".concat(we," in limited sync - not resetting")),ne=!1,y.splice(0,ce);break}}if(ne){var Be;b.resetLiveTimeline(_.timeline.prev_batch,r.syncOpts.canResetEntireTimeline(b.roomId)?null:(Be=e.oldSyncToken)!==null&&Be!==void 0?Be:null),l.resetNotifTimelineSet()}}if(r.syncOpts.cryptoCallbacks)for(var Q of I.concat(y))Q.isState()&&Q.getType()===F.RoomEncryption&&Q.getStateKey()===""&&(yield r.syncOpts.cryptoCallbacks.onCryptoEvent(b,Q));try{yield r.injectRoomEvents(b,I,y,e.fromCache)}catch(j){p.error("Failed to process events on room ".concat(b.roomId,":"),j)}_.summary&&b.setSummary(_.summary),b.addEphemeralEvents(C),b.addAccountData(w),b.recalculate(),_.isBrandNewRoom&&(l.store.storeRoom(b),l.emit(_e.Room,b)),r.processEventsForNotifs(b,y);var le=j=>l.emit(_e.Event,j);I.forEach(le),y.forEach(le),C.forEach(le),w.forEach(le),b.decryptCriticalEvents()});return function(_){return R.apply(this,arguments)}}()),yield rs(m,function(){var R=S(function*(_){var T=_.room,b=r.mapSyncEventsFormat(_.state,T),I=r.mapSyncEventsFormat(_.timeline,T),y=r.mapSyncEventsFormat(_.account_data);yield r.injectRoomEvents(T,b,I),T.addAccountData(y),T.recalculate(),_.isBrandNewRoom&&(l.store.storeRoom(T),l.emit(_e.Room,T)),r.processEventsForNotifs(T,I),b.forEach(function(C){l.emit(_e.Event,C)}),I.forEach(function(C){l.emit(_e.Event,C)}),y.forEach(function(C){l.emit(_e.Event,C)})});return function(_){return R.apply(this,arguments)}}()),yield rs(E,function(){var R=S(function*(_){var T=_.room,b=r.mapSyncEventsFormat(_.knock_state,T);yield r.injectRoomEvents(T,b),_.isBrandNewRoom?(T.recalculate(),l.store.storeRoom(T),l.emit(_e.Room,T)):T.recalculate(),b.forEach(function(I){l.emit(_e.Event,I)})});return function(_){return R.apply(this,arguments)}}()),e.oldSyncToken&&r.notifEvents.length&&(r.notifEvents.sort(function(R,_){return R.getTs()-_.getTs()}),r.notifEvents.forEach(function(R){var _;(_=l.getNotifTimelineSet())===null||_===void 0||_.addLiveEvent(R)})),t.device_lists&&r.syncOpts.cryptoCallbacks&&(yield r.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(o=r.syncOpts.cryptoCallbacks)===null||o===void 0?void 0:o.processKeyCounts(t.device_one_time_keys_count,(a=t.device_unused_fallback_key_types)!==null&&a!==void 0?a:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=ni()),this.connectionReturnedDefer.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject("SyncApi.stop() was called"),this.connectionReturnedDefer=void 0);return}var r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(t),this.connectionReturnedDefer=void 0)};this.client.http.request(z.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{r()},n=>{n.httpStatus==400||n.httpStatus==404?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState($e.Error,{error:n}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(r=>!No(r)).map(r=>{var n=t.store.getRoom(r),s=!1;return n||(n=this.createRoom(r),s=!0),Rl(Rl({},e[r]),{},{room:n,isBrandNewRoom:s})})}mapSyncEventsFormat(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.filter(Cr).map(function(s){return t&&(s.room_id=t.roomId),n(s)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Oe.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),s;n?s=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):s=t.getProfileInfo(r.userId),s.then(function(o){var a=r.events.member;(a==null?void 0:a.getContent().membership)===Oe.Invite&&(a.getContent().avatar_url=o.avatar_url,a.getContent().displayname=o.displayname,r.setMembershipEvent(a,e.currentState))},function(o){})}})}}findEncryptionEvent(e){return e==null?void 0:e.find(t=>t.getType()===F.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t,r){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)||!!this.findEncryptionEvent(r)}injectRoomEvents(e,t,r){var n=arguments,s=this;return S(function*(){var o=n.length>3&&n[3]!==void 0?n[3]:!1,a=e.getLiveTimeline(),l=a.getEvents().length==0;if(l){for(var u of t)s.client.getPushActionsForEvent(u);a.initialiseState(t,{timelineWasEmpty:l})}s.resolveInvites(e),e.recalculate(),l||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),yield e.addLiveEvents(r||[],{fromCache:o,timelineWasEmpty:l}),s.client.processBeaconEvents(e,r)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var r of t){var n,s=this.client.getPushActionsForEvent(r);s!=null&&s.notify&&(n=s.tweaks)!==null&&n!==void 0&&n.highlight&&this.notifEvents.push(r)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(_e.Sync,this.syncState,r,t)}}function aS(i,e,t){var{timelineSupport:r}=i,n=new eu(e,i,i.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:r});return i.reEmitter.reEmit(n,[ye.Name,ye.Redaction,ye.RedactionCancelled,ye.Receipt,ye.Tags,ye.LocalEchoUpdated,ye.AccountData,ye.MyMembership,ye.Timeline,ye.TimelineReset,Ae.Events,Ae.Members,Ae.NewMember,Ae.Update,tt.New,tt.Update,tt.Destroy,tt.LivenessChange]),n.on(Ae.NewMember,(s,o,a)=>{var l;a.user=(l=i.getUser(a.userId))!==null&&l!==void 0?l:void 0,i.reEmitter.reEmit(a,[Yt.Name,Yt.Typing,Yt.PowerLevel,Yt.Membership])}),n}class IT{constructor(){f(this,"accountData",new Map),f(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return S(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return S(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return S(function*(){return Promise.resolve()})()}destroy(){return S(function*(){})()}}var Mt=[];for(var Bu=0;Bu<256;++Bu)Mt.push((Bu+256).toString(16).slice(1));function CT(i,e=0){return(Mt[i[e+0]]+Mt[i[e+1]]+Mt[i[e+2]]+Mt[i[e+3]]+"-"+Mt[i[e+4]]+Mt[i[e+5]]+"-"+Mt[i[e+6]]+Mt[i[e+7]]+"-"+Mt[i[e+8]]+Mt[i[e+9]]+"-"+Mt[i[e+10]]+Mt[i[e+11]]+Mt[i[e+12]]+Mt[i[e+13]]+Mt[i[e+14]]+Mt[i[e+15]]).toLowerCase()}var Ma,kT=new Uint8Array(16);function OT(){if(!Ma&&(Ma=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ma))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ma(kT)}var PT=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Lv={randomUUID:PT};function Ar(i,e,t){if(Lv.randomUUID&&!i)return Lv.randomUUID();i=i||{};var r=i.random||(i.rng||OT)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,CT(r)}var br={},ju={},qu={exports:{}},Nv;function fh(){if(Nv)return qu.exports;Nv=1;var i=qu.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(i).forEach(function(e){var t=i[e];t.forEach(function(r){r.reg||(r.reg=/(.*)/),r.format||(r.format="%s")})}),qu.exports}var xv;function MT(){return xv||(xv=1,function(i){var e=function(a){return String(Number(a))===a?Number(a):a},t=function(a,l,u,c){if(c&&!u)l[c]=e(a[1]);else for(var d=0;d<u.length;d+=1)a[d+1]!=null&&(l[u[d]]=e(a[d+1]))},r=function(a,l,u){var c=a.name&&a.names;a.push&&!l[a.push]?l[a.push]=[]:c&&!l[a.name]&&(l[a.name]={});var d=a.push?{}:c?l[a.name]:l;t(u.match(a.reg),d,a.names,a.name),a.push&&l[a.push].push(d)},n=fh(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);i.parse=function(a){var l={},u=[],c=l;return a.split(/(\r\n|\r|\n)/).filter(s).forEach(function(d){var h=d[0],g=d.slice(2);h==="m"&&(u.push({rtp:[],fmtp:[]}),c=u[u.length-1]);for(var v=0;v<(n[h]||[]).length;v+=1){var m=n[h][v];if(m.reg.test(g))return r(m,c,g)}}),l.media=u,l};var o=function(a,l){var u=l.split(/=(.+)/,2);return u.length===2?a[u[0]]=e(u[1]):u.length===1&&l.length>1&&(a[u[0]]=void 0),a};i.parseParams=function(a){return a.split(/;\s?/).reduce(o,{})},i.parseFmtpConfig=i.parseParams,i.parsePayloads=function(a){return a.toString().split(" ").map(Number)},i.parseRemoteCandidates=function(a){for(var l=[],u=a.split(" ").map(e),c=0;c<u.length;c+=3)l.push({component:u[c],ip:u[c+1],port:u[c+2]});return l},i.parseImageAttributes=function(a){return a.split(" ").map(function(l){return l.substring(1,l.length-1).split(",").reduce(o,{})})},i.parseSimulcastStreamList=function(a){return a.split(";").map(function(l){return l.split(",").map(function(u){var c,d=!1;return u[0]!=="~"?c=e(u):(c=e(u.substring(1,u.length)),d=!0),{scid:c,paused:d}})})}}(ju)),ju}var Vu,Kv;function AT(){if(Kv)return Vu;Kv=1;var i=fh(),e=/%[sdv%]/g,t=function(o){var a=1,l=arguments,u=l.length;return o.replace(e,function(c){if(a>=u)return c;var d=l[a];switch(a+=1,c){case"%%":return"%";case"%s":return String(d);case"%d":return Number(d);case"%v":return""}})},r=function(o,a,l){var u=a.format instanceof Function?a.format(a.push?l:l[a.name]):a.format,c=[o+"="+u];if(a.names)for(var d=0;d<a.names.length;d+=1){var h=a.names[d];a.name?c.push(l[a.name][h]):c.push(l[a.names[d]])}else c.push(l[a.name]);return t.apply(null,c)},n=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return Vu=function(o,a){a=a||{},o.version==null&&(o.version=0),o.name==null&&(o.name=" "),o.media.forEach(function(d){d.payloads==null&&(d.payloads="")});var l=a.outerOrder||n,u=a.innerOrder||s,c=[];return l.forEach(function(d){i[d].forEach(function(h){h.name in o&&o[h.name]!=null?c.push(r(d,h,o)):h.push in o&&o[h.push]!=null&&o[h.push].forEach(function(g){c.push(r(d,h,g))})})}),o.media.forEach(function(d){c.push(r("m",i.m[0],d)),u.forEach(function(h){i[h].forEach(function(g){g.name in d&&d[g.name]!=null?c.push(r(h,g,d)):g.push in d&&d[g.push]!=null&&d[g.push].forEach(function(v){c.push(r(h,g,v))})})})}),c.join(`\r
`)+`\r
`},Vu}var Fv;function DT(){if(Fv)return br;Fv=1;var i=MT(),e=AT(),t=fh();return br.grammar=t,br.write=e,br.parse=i.parse,br.parseParams=i.parseParams,br.parseFmtpConfig=i.parseFmtpConfig,br.parsePayloads=i.parsePayloads,br.parseRemoteCandidates=i.parseRemoteCandidates,br.parseImageAttributes=i.parseImageAttributes,br.parseSimulcastStreamList=i.parseSimulcastStreamList,br}var Hc=DT();function zt(i){if(typeof Buffer=="function")return Buffer.from(i).toString("base64");if(typeof btoa=="function"&&i instanceof Uint8Array)return btoa(i.reduce((e,t)=>e+String.fromCharCode(t),""));throw new Error("No base64 impl found!")}function tu(i){return zt(i).replace(/={1,2}$/,"")}function lS(i){return tu(i).replace(/\+/g,"-").replace(/\//g,"_")}function At(i){if(typeof Buffer=="function")return Buffer.from(i,"base64");if(typeof atob=="function"){var e=function*(){for(var r=atob(i.replace(/-/g,"+").replace(/_/g,"/")),n=0;n<r.length;++n)yield r.charCodeAt(n)};return Uint8Array.from(e())}else throw new Error("No base64 impl found!")}var Wu,Gu,Hu,Tn=globalThis.crypto,Xt=(Wu=(Gu=Tn)===null||Gu===void 0?void 0:Gu.subtle)!==null&&Wu!==void 0?Wu:(Hu=Tn)===null||Hu===void 0?void 0:Hu.webkitSubtle,$n=globalThis.TextEncoder;if(!Tn)try{Tn=require("crypto").webcrypto}catch(i){p.error("Failed to load webcrypto",i)}if(!Xt){var $u;Xt=($u=Tn)===null||$u===void 0?void 0:$u.subtle}if(!$n)try{$n=require("util").TextEncoder}catch(i){p.error("Failed to load TextEncoder util",i)}var UT="abcdefghijklmnopqrstuvwxyz",LT="ABCDEFGHIJKLMNOPQRSTUVWXYZ",NT="0123456789";function xT(i){var e=new Uint8Array(i);return Tn.getRandomValues(e),lS(e)}function Dr(i){return KT(i,LT+UT+NT)}function KT(i,e){for(var t="",r=0;r<i;++r)t+=e.charAt(Math.floor(Math.random()*e.length));return t}var Mn="org.matrix.msc3077.sdp_stream_metadata",Qe=function(i){return i.Usermedia="m.usermedia",i.Screenshare="m.screenshare",i}({}),Ko=null,$c=0,FT=()=>(Ko===null&&(Ko=new AudioContext),$c++,Ko),BT=()=>{if($c--,$c===0){var i;(i=Ko)===null||i===void 0||i.close(),Ko=null}},jT=200,zc=-60,qT=8,Br=function(i){return i.NewStream="new_stream",i.MuteStateChanged="mute_state_changed",i.LocalVolumeChanged="local_volume_changed",i.VolumeChanged="volume_changed",i.ConnectedChanged="connected_changed",i.Speaking="speaking",i.Disposed="disposed",i}({});class mn extends rt{constructor(e){super(),f(this,"stream",void 0),f(this,"sdpMetadataStreamId",void 0),f(this,"userId",void 0),f(this,"deviceId",void 0),f(this,"purpose",void 0),f(this,"speakingVolumeSamples",void 0),f(this,"client",void 0),f(this,"call",void 0),f(this,"roomId",void 0),f(this,"audioMuted",void 0),f(this,"videoMuted",void 0),f(this,"localVolume",1),f(this,"measuringVolumeActivity",!1),f(this,"audioContext",void 0),f(this,"analyser",void 0),f(this,"frequencyBinCount",void 0),f(this,"speakingThreshold",zc),f(this,"speaking",!1),f(this,"volumeLooperTimeout",void 0),f(this,"_disposed",!1),f(this,"_connected",!1),f(this,"onAddTrack",()=>{this.emit(Br.NewStream,this.stream)}),f(this,"onCallState",t=>{t===Ie.Connected?this.connected=!0:t===Ie.Connecting&&(this.connected=!1)}),f(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var r of this.frequencyBinCount)r>t&&(t=r);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(Br.VolumeChanged,t);var n=!1;for(var s of this.speakingVolumeSamples)if(s>this.speakingThreshold){n=!0;break}this.speaking!==n&&(this.speaking=n,this.emit(Br.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,jT)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(qT).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(De.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(Br.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(Br.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=FT()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t==null?void 0:t.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(Br.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(Br.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return p.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===Qe.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new mn({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(De.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,BT()),this._disposed=!0,this.emit(Br.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(Br.LocalVolumeChanged,e)}}var _n=function(i){return i[i.Blocked=-1]="Blocked",i[i.Unverified=0]="Unverified",i[i.Verified=1]="Verified",i}({});class uS{constructor(e){f(this,"deviceId",void 0),f(this,"userId",void 0),f(this,"algorithms",void 0),f(this,"keys",void 0),f(this,"verified",void 0),f(this,"signatures",void 0),f(this,"displayName",void 0),f(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||_n.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}class er{static fromStorage(e,t){var r=new er(t);for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}constructor(e){this.deviceId=e,f(this,"algorithms",[]),f(this,"keys",{}),f(this,"verified",_n.Unverified),f(this,"known",!1),f(this,"unsigned",{}),f(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==_n.Blocked}isVerified(){return this.verified==_n.Verified}isUnverified(){return this.verified==_n.Unverified}isKnown(){return this.known===!0}}f(er,"DeviceVerification",{VERIFIED:_n.Verified,UNVERIFIED:_n.Unverified,BLOCKED:_n.Blocked});var VT=3e3,Jc=function(i){return i.Incoming="Call.incoming",i}({});class WT{constructor(e){f(this,"calls",void 0),f(this,"callEventBuffer",void 0),f(this,"nextSeqByCall",new Map),f(this,"toDeviceEventBuffers",new Map),f(this,"client",void 0),f(this,"candidateEventsByCall",void 0),f(this,"eventBufferPromiseChain",void 0),f(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),f(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),f(this,"onToDeviceEvent",t=>{var r=t.getContent();if(!r.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(r.call_id)||this.nextSeqByCall.set(r.call_id,0),r.seq===void 0){this.callEventBuffer.push(t);return}var n=this.nextSeqByCall.get(r.call_id)||0;if(r.seq!==n){this.toDeviceEventBuffers.has(r.call_id)||this.toDeviceEventBuffers.set(r.call_id,[]);var s=this.toDeviceEventBuffers.get(r.call_id),o=s.findIndex(c=>c.getContent().seq>r.seq);o===-1?s.push(t):s.splice(o,0,t)}else{var a=r.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(a,r.seq+1);for(var l=this.toDeviceEventBuffers.get(a),u=l&&l.shift();u&&u.getContent().seq===this.nextSeqByCall.get(a);)this.callEventBuffer.push(u),this.nextSeqByCall.set(a,u.getContent().seq+1),u=l.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(_e.Sync,this.onSync),this.client.on(ye.Timeline,this.onRoomTimeline),this.client.on(_e.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(_e.Sync,this.onSync),this.client.removeListener(ye.Timeline,this.onRoomTimeline),this.client.removeListener(_e.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return S(function*(){yield Promise.all(e.map(c=>t.client.decryptEventIfNeeded(c)));var r=e.filter(c=>{var d=c.getType();return d.startsWith("m.call.")||d.startsWith("org.matrix.call.")}),n=new Set;for(var s of r){var o=s.getType();(o===F.CallAnswer||o===F.CallHangup)&&n.add(s.getContent().call_id)}for(var a of r){var l=a.getType(),u=a.getContent().call_id;if(!(l===F.CallInvite&&n.has(u)))try{yield t.handleCallEvent(a)}catch(c){p.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",c)}}})()}handleCallEvent(e){var t=this;return S(function*(){var r;t.client.emit(_e.ReceivedVoipEvent,e);var n=e.getContent(),s=e.getRoomId()||((r=t.client.groupCallEventHandler.getGroupCallById(n.conf_id))===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.roomId),o=n.conf_id,a=e.getType(),l=e.getSender(),u=n.call_id?t.calls.get(n.call_id):void 0,c,d;if(o){if(d=t.client.groupCallEventHandler.getGroupCallById(o),!d){p.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(o,", type=").concat(a,")"));return}if(c=n.device_id,!c){p.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(l,")")),d.emit(Ye.Error,new hS(l));return}if(n.dest_session_id!==t.client.getSessionId()){p.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var h=l===t.client.credentials.userId&&(c===void 0||c===t.client.getDeviceId());if(s){if(a===F.CallInvite){var g,v,m;if(h||e.getLocalAge()>n.lifetime-VT||u&&u.state===Ie.Ended||(u&&p.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(n.call_id,")")),n.invitee&&n.invitee!==t.client.getUserId()))return;var E=((g=t.client.getTurnServersExpiry())!==null&&g!==void 0?g:0)-Date.now();if(p.info("CallEventHandler handleCallEvent() current turn creds expire in "+E+" ms"),u=(v=na(t.client,s,{forceTURN:t.client.forceTURN,opponentDeviceId:c,groupCallId:o,opponentSessionId:n.sender_session_id}))!==null&&v!==void 0?v:void 0,!u){p.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(n.call_id,")"));return}u.callId=n.call_id;var R=(m=d)===null||m===void 0?void 0:m.getGroupCallStats();R&&u.initStats(R);try{yield u.initWithInvite(e)}catch(D){if(D instanceof dn)if(D.code===Bo.UnknownDevice){var _;(_=d)===null||_===void 0||_.emit(Ye.Error,D)}else p.error(D)}if(t.calls.set(u.callId,u),t.candidateEventsByCall.get(u.callId))for(var T of t.candidateEventsByCall.get(u.callId))u.onRemoteIceCandidatesReceived(T);var b;for(var I of t.calls.values()){var y,C=[Ie.WaitLocalMedia,Ie.CreateOffer,Ie.InviteSent].includes(I.state);if(u.roomId===I.roomId&&I.direction===Un.Outbound&&((y=u.getOpponentMember())===null||y===void 0?void 0:y.userId)===I.invitee&&C){b=I;break}}b?b.callId>u.callId?(p.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(u.callId,", outgoingId=").concat(b.callId,")")),b.replacedBy(u)):(p.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(u.callId,", outgoingId=").concat(b.callId,")")),u.hangup(Me.Replaced,!0)):t.client.emit(Jc.Incoming,u);return}else if(a===F.CallCandidates){if(h)return;u?u.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(n.call_id)||t.candidateEventsByCall.set(n.call_id,[]),t.candidateEventsByCall.get(n.call_id).push(e));return}else if([F.CallHangup,F.CallReject].includes(a)){if(u)u.state!==Ie.Ended&&(a===F.CallHangup?u.onHangupReceived(n):u.onRejectReceived(n),u.state===Ie.Ended&&t.calls.delete(n.call_id));else{var w;u=(w=na(t.client,s,{opponentDeviceId:c,opponentSessionId:n.sender_session_id}))!==null&&w!==void 0?w:void 0,u&&(u.callId=n.call_id,u.initWithHangup(e),t.calls.set(n.call_id,u))}return}if(!u||!u.hasPeerConnection){p.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(a,")"));return}if(e.getContent().party_id!==u.ourPartyId)switch(a){case F.CallAnswer:h?u.state===Ie.Ringing&&u.onAnsweredElsewhere(n):u.onAnswerReceived(e);break;case F.CallSelectAnswer:u.onSelectAnswerReceived(e);break;case F.CallNegotiate:u.onNegotiateReceived(e);break;case F.CallAssertedIdentity:case F.CallAssertedIdentityPrefix:u.onAssertedIdentityReceived(e);break;case F.CallSDPStreamMetadataChanged:case F.CallSDPStreamMetadataChangedPrefix:u.onSDPStreamMetadataChangedReceived(e);break}}})()}}var Yc=function(i){return i.Incoming="GroupCall.incoming",i.Outgoing="GroupCall.outgoing",i.Ended="GroupCall.ended",i.Participants="GroupCall.participants",i}({});class GT{constructor(e){this.client=e,f(this,"groupCalls",new Map),f(this,"roomDeferreds",new Map),f(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),f(this,"onRoomStateChanged",(t,r)=>{var n=t.getType();if(n===F.GroupCallPrefix){var s=t.getStateKey(),o=t.getContent(),a=this.groupCalls.get(r.roomId);!a&&!o["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):a&&a.groupCallId===s?o["m.terminated"]||t.isRedacted()?a.terminate(!1):o["m.type"]!==a.type&&p.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(r.roomId,")")):a&&a.groupCallId!==s&&p.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(r.roomId,")"))}})}start(){var e=this;return S(function*(){e.client.getSyncState()!==$e.Syncing&&(p.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(n=>{var s=()=>{if(e.client.getSyncState()===$e.Syncing)return e.client.off(_e.Sync,s),n()};e.client.on(_e.Sync,s)}));var t=e.client.getRooms();for(var r of t)e.createGroupCallForRoom(r);e.client.on(_e.Room,e.onRoomsChanged),e.client.on(Ae.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(_e.Room,this.onRoomsChanged),this.client.removeListener(Ae.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var r;t={prom:new Promise(n=>{r=n})},t.resolve=r,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(F.GroupCallPrefix),r=t.sort((o,a)=>a.getTs()-o.getTs());for(var n of r){var s=n.getContent();if(!(s["m.terminated"]||n.isRedacted())){p.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(n.getStateKey(),", ts=").concat(n.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(n);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),r=e.getContent(),n=this.client.getRoom(t);if(!n){p.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var s=e.getStateKey(),o=r["m.type"];if(!Object.values(ru).includes(o)){p.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(o,", roomId=").concat(t,")"));return}var a=r["m.intent"];if(!Object.values(dS).includes(a)){p.warn("Received invalid group call intent (type=".concat(o,", roomId=").concat(t,")"));return}var l=!!r["io.element.ptt"],u;if(r!=null&&r.dataChannelsEnabled&&r!==null&&r!==void 0&&r.dataChannelOptions){var{ordered:c,maxPacketLifeTime:d,maxRetransmits:h,protocol:g}=r.dataChannelOptions;u={ordered:c,maxPacketLifeTime:d,maxRetransmits:h,protocol:g}}var v=new vh(this.client,n,o,l,a,s,(r==null?void 0:r.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,u,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,r["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,v),this.client.emit(Yc.Incoming,v),v}}class HT{constructor(){f(this,"bandwidth",{}),f(this,"bitrate",{}),f(this,"packetLoss",{}),f(this,"transport",[])}}class $T{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}class zT{static buildReport(e,t,r,n){var s=e==null?void 0:e.get(t.localCandidateId),o=e==null?void 0:e.get(t.remoteCandidateId);if(o&&s){var a=o.ip!==void 0?o.ip:o.address,l=o.port,u="".concat(a,":").concat(l),c=s.ip!==void 0?s.ip:s.address,d=s.port,h="".concat(c,":").concat(d),g=o.protocol;r.some(v=>v.ip===u&&v.type===g&&v.localIp===h)||r.push({ip:u,type:g,localIp:h,isFocus:n,localCandidateType:s.candidateType,remoteCandidateType:o.candidateType,networkType:s.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return r}}class JT{constructor(){f(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var r;return this.ssrcToMid[t].forEach((n,s)=>{if(n.find(o=>o==e)){r=s;return}}),r}parse(e,t){var r=Hc.parse(e),n=new Map;r.media.forEach(s=>{if(s.mid&&s.type==="video"||s.type==="audio"){var o,a=[];(o=s.ssrcs)===null||o===void 0||o.forEach(l=>{l.attribute==="cname"&&a.push("".concat(l.id))}),n.set("".concat(s.mid),a)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class YT{constructor(e){this.pc=e}getLocalTracks(e){var t=r=>r!==null&&r.kind===e;return this.pc.getTransceivers().filter(r=>r.currentDirection==="sendonly"||r.currentDirection==="sendrecv").filter(r=>r.sender!==null).map(r=>r.sender).map(r=>r.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if((t==null?void 0:t.sender.track)!==null&&t.sender.track.id===e)return t.sender.track;if((t==null?void 0:t.receiver.track)!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t=this.pc.getTransceivers().find(r=>r.mid===e);if(t!==void 0&&t.sender&&t.sender.track)return t.sender.track.id}getRemoteTrackIdByMid(e){var t=this.pc.getTransceivers().find(r=>r.mid===e);if(t!==void 0&&t.receiver&&t.receiver.track)return t.receiver.track.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class QT{constructor(e,t,r){this.trackId=e,this.type=t,this.kind=r,f(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),f(this,"bitrate",{download:0,upload:0}),f(this,"resolution",{width:-1,height:-1}),f(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),f(this,"framerate",0),f(this,"jitter",0),f(this,"codec",""),f(this,"isAlive",!0),f(this,"isMuted",!1),f(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class XT{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,f(this,"track2stats",new Map)}findTrack2Stats(e,t){var r;if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var n=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!n)return;r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(r){var s=this.track2stats.get(r);if(!s){var o=this.mediaTrackHandler.getTackById(r);if(o!==void 0){var a=o.kind==="audio"?o.kind:"video";s=new QT(r,t,a),this.track2stats.set(r,s)}else return}return s}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class wi{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class dr{static buildFramerateResolution(e,t){var r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){var s=e.getFramerate();if(!s){if(r){var o=t.timestamp-r.timestamp;if(o>0&&t.framesSent){var a=t.framesSent-r.framesSent;s=a/o*1e3}}if(!s)return}s=n?Math.round(s/n):0,e.setFramerate(s)}static buildCodec(e,t,r){var n=e==null?void 0:e.get(r.codecId);if(n){var s=n.mimeType.split("/")[1];s&&t.setCodec(s)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:dr.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){var n=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",s=t[n];(!s||s<0)&&(s=0);var o=wi.getNonNegativeValue(r[n]),a=Math.max(0,s-o),l=wi.getNonNegativeValue(t.packetsLost),u=wi.getNonNegativeValue(r.packetsLost),c=Math.max(0,l-u);e.setLoss({packetsTotal:a+c,packetsLost:c,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,r,n){var s=wi.getNonNegativeValue(e),o=wi.getNonNegativeValue(t),a=Math.max(0,s-o),l=r-n,u=0;return l>0&&(u=Math.round(a*8/l)),u}static setTrackStatsState(e,t){var r;if(t===void 0){e.alive=!1;return}var n=e.getType()==="remote"?t.receiver.track:t==null||(r=t.sender)===null||r===void 0?void 0:r.track;if(n==null){e.alive=!1;return}if(n.readyState==="ended"){e.alive=!1;return}e.muted=n.muted,e.enabled=n.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(o=>o.getType()==="remote"),s=n.filter(o=>o.kind==="audio");return n.forEach(o=>{var a=o.kind==="video"?t:r;if(a.count++,o.alive&&o.muted&&a.muted++,a.maxJitter<o.getJitter()&&(a.maxJitter=o.getJitter()),a.maxPacketLoss<o.getLoss().packetsLost&&(a.maxPacketLoss=o.getLoss().packetsLost),s.length>0){var l,u;a.concealedAudio+=(l=o.getAudioConcealment())===null||l===void 0?void 0:l.concealedAudio,a.totalAudio+=(u=o.getAudioConcealment())===null||u===void 0?void 0:u.totalAudioDuration}}),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var r=t==null?void 0:t.jitter;if(r!==void 0){var n=wi.getNonNegativeValue(r);e.setJitter(Math.round(n*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var r=1e3*(t==null?void 0:t.totalSamplesDuration)/(t==null?void 0:t.totalSamplesReceived),n=r*(t==null?void 0:t.concealedSamples),s=1e3*(t==null?void 0:t.totalSamplesDuration);e.setAudioConcealment(n,s)}}}class Fo{static build(e){var t={},r={download:0,upload:0},n={download:0,upload:0},s=0,o=0,a={local:new Map,remote:new Map},l={local:new Map,remote:new Map},u={local:new Map,remote:new Map},c=new Map,d=new Map,h=0,g=0,v=0,m=0,E=0,R=0;for(var[_,T]of e){var b=T.getLoss(),I=b.isDownloadStream?"download":"upload";if(r[I]+=b.packetsTotal,n[I]+=b.packetsLost,s+=T.getBitrate().download,o+=T.getBitrate().upload,T.kind==="audio"){var y=T.getAudioConcealment();E+=y.concealedAudio,R+=y.totalAudioDuration,h+=T.getBitrate().download,g+=T.getBitrate().upload}else v+=T.getBitrate().download,m+=T.getBitrate().upload;a[T.getType()].set(_,T.getResolution()),l[T.getType()].set(_,T.getFramerate()),u[T.getType()].set(_,T.getCodec()),T.getType()==="remote"&&(c.set(_,T.getJitter()),T.kind==="audio"&&d.set(_,T.getAudioConcealment())),T.resetBitrate()}return t.bitrate={upload:o,download:s},t.bitrate.audio={upload:g,download:h},t.bitrate.video={upload:m,download:v},t.packetLoss={total:Fo.calculatePacketLoss(n.download+n.upload,r.download+r.upload),download:Fo.calculatePacketLoss(n.download,r.download),upload:Fo.calculatePacketLoss(n.upload,r.upload)},t.audioConcealment=d,t.totalAudioConcealment={concealedAudio:E,totalAudioDuration:R},t.framerate=l,t.resolution=a,t.codec=u,t.jitter=c,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Wn{static buildCallFeedReport(e,t,r){var n=r.getTransceivers(),s=[],o=[];return n.forEach(a=>{var l,u=(l=a.sender)!==null&&l!==void 0&&l.track?Wn.buildTrackStats(a.sender.track,"sender"):null,c=Wn.buildTrackStats(a.receiver.track,"receiver");s.push({mid:a.mid==null?"null":a.mid,direction:a.direction,currentDirection:a.currentDirection==null?"null":a.currentDirection,sender:u,receiver:c})}),{callId:e,opponentMemberId:t,transceiver:s,callFeeds:o}}static buildTrackStats(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",s=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,o=(r=e.getConstraints())===null||r===void 0?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:s||"unknown",constrainDeviceId:o||"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return e.callFeeds||(e.callFeeds=[]),t.forEach(n=>{var s=n.stream.getAudioTracks(),o=n.stream.getVideoTracks(),a=s.length>0?Wn.buildTrackStats(n.stream.getAudioTracks()[0],n.purpose):null,l=o.length>0?Wn.buildTrackStats(n.stream.getVideoTracks()[0],n.purpose):null,u={stream:n.stream.id,type:n.isLocal()?"local":"remote",audio:a,video:l,purpose:n.purpose,prefix:r,isVideoMuted:n.isVideoMuted(),isAudioMuted:n.isAudioMuted()};e.callFeeds.push(u)}),e}}function Bv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Aa(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Bv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Bv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class ZT{constructor(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=s,f(this,"isActive",!0),f(this,"previousStatsReport",void 0),f(this,"currentStatsReport",void 0),f(this,"connectionStats",new HT),f(this,"trackStats",void 0),r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new XT(new JT,new YT(r))}processStats(e,t){var r=this;return S(function*(){var n={isFirstCollection:r.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(r.isActive){var s=r.pc.getStats();if(typeof(s==null?void 0:s.then)=="function")return s.then(o=>{var a,l;r.currentStatsReport=typeof(o==null?void 0:o.result)=="function"?o.result():o;try{r.processStatsReport(e,t)}catch(c){return r.handleError(c),n}r.previousStatsReport=r.currentStatsReport,n.receivedMedia=r.connectionStats.bitrate.download,n.receivedAudioMedia=((a=r.connectionStats.bitrate.audio)===null||a===void 0?void 0:a.download)||0,n.receivedVideoMedia=((l=r.connectionStats.bitrate.video)===null||l===void 0?void 0:l.download)||0;var u=dr.buildTrackSummary(Array.from(r.trackStats.getTrack2stats().values()));return Aa(Aa({},n),{},{audioTrackSummary:u.audioTrackSummary,videoTrackSummary:u.videoTrackSummary})}).catch(o=>(r.handleError(o),n));r.isActive=!1}return Promise.resolve(n)})()}processStatsReport(e,t){var r,n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,(r=this.currentStatsReport)===null||r===void 0||r.forEach(s=>{var o=this.previousStatsReport?this.previousStatsReport.get(s.id):null;if(s.type==="candidate-pair"&&s.nominated&&s.state==="succeeded")this.connectionStats.bandwidth=$T.buildBandwidthReport(s),this.connectionStats.transport=zT.buildReport(this.currentStatsReport,s,this.connectionStats.transport,this.isFocus);else if(s.type==="inbound-rtp"||s.type==="outbound-rtp"){var a=this.trackStats.findTrack2Stats(s,s.type==="inbound-rtp"?"remote":"local");if(!a)return;if(o&&dr.buildPacketsLost(a,s,o),s.type==="inbound-rtp"){dr.buildFramerateResolution(a,s),o&&dr.buildBitrateReceived(a,s,o);var l=this.trackStats.findTransceiverByTrackId(a.trackId);dr.setTrackStatsState(a,l),dr.buildJitter(a,s),dr.buildAudioConcealment(a,s)}else o&&(n.set(a.trackId,wi.getNonNegativeValue(s.bytesSent)),dr.buildBitrateSend(a,s,o));dr.buildCodec(this.currentStatsReport,a,s)}else if(s.type==="track"&&s.kind==="video"&&!s.remoteSource){var u=this.trackStats.findLocalVideoTrackStats(s);if(!u)return;dr.buildFramerateResolution(u,s),dr.calculateSimulcastFramerate(u,s,o,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(Wn.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,p.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=Fo.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(Aa(Aa({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var bn=function(i){return i.CONNECTION_STATS="StatsReport.connection_stats",i.CALL_FEED_REPORT="StatsReport.call_feed_report",i.BYTE_SENT_STATS="StatsReport.byte_sent_stats",i.SUMMARY_STATS="StatsReport.summary_stats",i}({});class eI extends rt{emitByteSendReport(e){this.emit(bn.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(bn.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(bn.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(bn.SUMMARY_STATS,e)}}class cS{constructor(e){this.emitter=e}build(e){var t=e.filter(c=>!c.isFirstCollection),r=t.length,n=e.length;if(r!==0){var s={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},o=0,a=0;t.forEach(c=>{this.countTrackListReceivedMedia(s,c),this.countConcealedAudio(s,c),o=this.buildMaxJitter(o,c),a=this.buildMaxPacketLoss(a,c)});var l=5,u={percentageReceivedMedia:Number((s.receivedMedia/r).toFixed(l)),percentageReceivedVideoMedia:Number((s.receivedVideo/r).toFixed(l)),percentageReceivedAudioMedia:Number((s.receivedAudio/r).toFixed(l)),maxJitter:o,maxPacketLoss:a,percentageConcealedAudio:Number(s.totalAudio>0?(s.concealedAudio/s.totalAudio).toFixed(l):0),peerConnections:n};this.emitter.emitSummaryStatsReport(u)}}static extendSummaryReport(e,t){var r=[],n=[];for(var s of t){n.push(s);for(var o of s[1])r.push(o)}e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,r.length-1)==0?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){var r=!1,n=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,r=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class tI{constructor(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=r,f(this,"timer",void 0),f(this,"gatherers",new Map),f(this,"reports",new eI),f(this,"summaryStatsReportGatherer",new cS(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new ZT(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;(r=this.getStatsReportGatherer(e))===null||r===void 0||r.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{p.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}function jv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Da(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):jv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var dS=function(i){return i.Ring="m.ring",i.Prompt="m.prompt",i.Room="m.room",i}({}),ru=function(i){return i.Video="m.video",i.Voice="m.voice",i}({}),rI=function(i){return i.CallEnded="call_ended",i}({}),Ye=function(i){return i.GroupCallStateChanged="group_call_state_changed",i.ActiveSpeakerChanged="active_speaker_changed",i.CallsChanged="calls_changed",i.UserMediaFeedsChanged="user_media_feeds_changed",i.ScreenshareFeedsChanged="screenshare_feeds_changed",i.LocalScreenshareStateChanged="local_screenshare_state_changed",i.LocalMuteStateChanged="local_mute_state_changed",i.ParticipantsChanged="participants_changed",i.Error="group_call_error",i}({}),Eo=function(i){return i.ConnectionStats="GroupCall.connection_stats",i.ByteSentStats="GroupCall.byte_sent_stats",i.SummaryStats="GroupCall.summary_stats",i.CallFeedStats="GroupCall.call_feed_stats",i}({}),Bo=function(i){return i.NoUserMedia="no_user_media",i.UnknownDevice="unknown_device",i.PlaceCallFailed="place_call_failed",i}({});class Qc extends Error{constructor(e,t,r){r?(super(t+": "+r),f(this,"code",void 0)):(super(t),f(this,"code",void 0)),this.code=e}}class hS extends Qc{constructor(e){super(Bo.UnknownDevice,"No device found for "+e),this.userId=e}}var at=function(i){return i.LocalCallFeedUninitialized="local_call_feed_uninitialized",i.InitializingLocalCallFeed="initializing_local_call_feed",i.LocalCallFeedInitialized="local_call_feed_initialized",i.Entered="entered",i.Ended="ended",i}({}),qv=1e3*60*60;function Ua(i){var e;return((e=i.getOpponentMember())===null||e===void 0?void 0:e.userId)||i.invitee||null}class vh extends rt{constructor(e,t,r,n,s,o,a,l,u){var c,d,h=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,g=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=s,this.dataChannelsEnabled=a,this.dataChannelOptions=l,this.useLivekit=h,f(this,"activeSpeakerInterval",1e3),f(this,"retryCallInterval",5e3),f(this,"participantTimeout",1e3*15),f(this,"pttMaxTransmitTime",1e3*20),f(this,"activeSpeaker",void 0),f(this,"localCallFeed",void 0),f(this,"localScreenshareFeed",void 0),f(this,"localDesktopCapturerSourceId",void 0),f(this,"userMediaFeeds",[]),f(this,"screenshareFeeds",[]),f(this,"groupCallId",void 0),f(this,"allowCallWithoutVideoAndAudio",void 0),f(this,"calls",new Map),f(this,"callHandlers",new Map),f(this,"activeSpeakerLoopInterval",void 0),f(this,"retryCallLoopInterval",void 0),f(this,"retryCallCounts",new Map),f(this,"reEmitter",void 0),f(this,"transmitTimer",null),f(this,"participantsExpirationTimer",null),f(this,"resendMemberStateTimer",null),f(this,"initWithAudioMuted",!1),f(this,"initWithVideoMuted",!1),f(this,"initCallFeedPromise",void 0),f(this,"_livekitServiceURL",void 0),f(this,"stats",void 0),f(this,"statsCollectIntervalTime",0),f(this,"onConnectionStats",v=>{this.emit(Eo.ConnectionStats,{report:v})}),f(this,"onByteSentStats",v=>{this.emit(Eo.ByteSentStats,{report:v})}),f(this,"onSummaryStats",v=>{cS.extendSummaryReport(v,this.participants),this.emit(Eo.SummaryStats,{report:v})}),f(this,"onCallFeedReport",v=>{this.localCallFeed&&(v=Wn.expandCallFeedReport(v,[this.localCallFeed],"from-local-feed"));var m=[];this.forEachCall(E=>{E.callId===v.callId&&E.getFeeds().forEach(R=>m.push(R))}),v=Wn.expandCallFeedReport(v,m,"from-call-feed"),this.emit(Eo.CallFeedStats,{report:v})}),f(this,"_state",at.LocalCallFeedUninitialized),f(this,"_participants",new Map),f(this,"_creationTs",null),f(this,"_enteredViaAnotherSession",!1),f(this,"onIncomingCall",v=>{var m,E;if(v.roomId===this.room.roomId){if(v.state!==Ie.Ringing){p.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!v.groupCallId||v.groupCallId!==this.groupCallId){p.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),v.reject();return}var R=(m=v.getOpponentMember())===null||m===void 0?void 0:m.userId;if(R===void 0){p.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){p.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var _=(E=this.calls.get(R))!==null&&E!==void 0?E:new Map,T=_.get(v.getOpponentDeviceId());if((T==null?void 0:T.callId)!==v.callId){p.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(R,", callId=").concat(v.callId,")")),T&&T.hangup(Me.Replaced,!1),_.set(v.getOpponentDeviceId(),v),this.calls.set(R,_),this.initCall(v);var b=this.getLocalFeeds().map(y=>y.clone());if(!this.callExpected(v))for(var I of b)St(I.stream.getAudioTracks(),!1),St(I.stream.getVideoTracks(),!1);v.answerWithCallFeeds(b),this.emit(Ye.CallsChanged,this.calls)}}}),f(this,"onRetryCallLoop",()=>{var v=!1;for(var[{userId:m},E]of this.participants){var R=this.calls.get(m),_=this.retryCallCounts.get(m);for(var[T,b]of E){var I,y,C=R==null?void 0:R.get(T),w=(I=(y=_)===null||y===void 0?void 0:y.get(T))!==null&&I!==void 0?I:0;(C==null?void 0:C.getOpponentSessionId())!==b.sessionId&&this.wantsOutgoingCall(m,T)&&w<3&&(_===void 0&&(_=new Map,this.retryCallCounts.set(m,_)),_.set(T,w+1),v=!0)}}v&&this.placeOutgoingCalls()}),f(this,"onCallFeedsChanged",v=>{var m=Ua(v),E=v.getOpponentDeviceId();if(!m)throw new Error("Cannot change call feeds without user id");var R=this.getUserMediaFeed(m,E),_=v.remoteUsermediaFeed,T=_!==R,b=this.calls.get(m),I=b==null?void 0:b.get(E);if((I==null?void 0:I.callId)===v.callId){T&&(!R&&_?this.addUserMediaFeed(_):R&&_?this.replaceUserMediaFeed(R,_):R&&!_&&this.removeUserMediaFeed(R));var y=this.getScreenshareFeed(m,E),C=v.remoteScreensharingFeed,w=C!==y;w&&(!y&&C?this.addScreenshareFeed(C):y&&C?this.replaceScreenshareFeed(y,C):y&&!C&&this.removeScreenshareFeed(y))}}),f(this,"onCallStateChanged",(v,m,E)=>{var R;if(m!==Ie.Ended){var _=this.localCallFeed.isAudioMuted();v.localUsermediaStream&&v.isMicrophoneMuted()!==_&&v.setMicrophoneMuted(_);var T=this.localCallFeed.isVideoMuted();v.localUsermediaStream&&v.isLocalVideoMuted()!==T&&v.setLocalVideoMuted(T);var b=(R=v.getOpponentMember())===null||R===void 0?void 0:R.userId;if(m===Ie.Connected&&b){var I=this.retryCallCounts.get(b);I==null||I.delete(v.getOpponentDeviceId()),(I==null?void 0:I.size)===0&&this.retryCallCounts.delete(b)}}}),f(this,"onCallHangup",v=>{var m,E;if(v.hangupReason!==Me.Replaced){var R=(m=(E=v.getOpponentMember())===null||E===void 0?void 0:E.userId)!==null&&m!==void 0?m:this.room.getMember(v.invitee).userId,_=this.calls.get(R);(_==null?void 0:_.get(v.getOpponentDeviceId()))===v&&(this.disposeCall(v,v.hangupReason),_.delete(v.getOpponentDeviceId()),_.size===0&&this.calls.delete(R),this.emit(Ye.CallsChanged,this.calls))}}),f(this,"onCallReplaced",(v,m)=>{var E=v.getOpponentMember().userId,R=this.calls.get(E);R===void 0&&(R=new Map,this.calls.set(E,R)),v.hangup(Me.Replaced,!1),this.initCall(m),R.set(v.getOpponentDeviceId(),m),this.emit(Ye.CallsChanged,this.calls)}),f(this,"onActiveSpeakerLoop",()=>{var v=void 0,m=void 0;for(var E of this.userMediaFeeds)if(!(E.isLocal()&&this.userMediaFeeds.length>1)){var R=E.speakingVolumeSamples.reduce((T,b)=>T+Math.max(b,zc)),_=R/E.speakingVolumeSamples.length;(!v||_>v)&&(v=_,m=E)}m&&this.activeSpeaker!==m&&v&&v>zc&&(this.activeSpeaker=m,this.emit(Ye.ActiveSpeakerChanged,this.activeSpeaker))}),f(this,"onRoomState",()=>this.updateParticipants()),f(this,"onParticipantsChanged",()=>{this.forEachCall(v=>{var m=this.callExpected(v);for(var E of v.getLocalFeeds())St(E.stream.getAudioTracks(),!E.isAudioMuted()&&m),St(E.stream.getVideoTracks(),!E.isVideoMuted()&&m)}),this.state===at.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),f(this,"onStateChanged",(v,m)=>{(v===at.Entered||m===at.Entered||v===at.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(E=>p.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),E)))}),f(this,"onLocalFeedsChanged",()=>{this.state===at.Entered&&this.updateMemberState().catch(v=>p.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),v))}),this.reEmitter=new Ay(this),this.groupCallId=o??Ri(),this._livekitServiceURL=g,this.creationTs=(c=(d=t.currentState.getStateEvents(F.GroupCallPrefix,this.groupCallId))===null||d===void 0?void 0:d.getTs())!==null&&c!==void 0?c:null,this.updateParticipants(),t.on(Ae.Update,this.onRoomState),this.on(Ye.ParticipantsChanged,this.onParticipantsChanged),this.on(Ye.GroupCallStateChanged,this.onStateChanged),this.on(Ye.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!u}create(){var e=this;return S(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(Yc.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return S(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,F.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(Ye.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,r=(s,o)=>s.sessionId===o.sessionId&&s.screensharing===o.screensharing,n=(s,o)=>mv(s,o,r);mv(e,t,n)||(this._participants=e,this.emit(Ye.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var r of t.values())e(r)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,r=Ua(e),n=r===null?null:this.room.getMember(r),s=e.getOpponentDeviceId();return n!==null&&s!==void 0&&((t=this.participants.get(n))===null||t===void 0?void 0:t.get(s))!==void 0}initLocalCallFeed(){var e=this;return S(function*(){if(e.useLivekit){p.info("Livekit group call: not starting local call feed.");return}if(e.state!==at.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=at.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return S(function*(){p.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===ru.Video)}catch(n){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=at.LocalCallFeedUninitialized,n}if(e._state!==at.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var r=new mn({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:Qe.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});St(t.getAudioTracks(),!r.isAudioMuted()),St(t.getVideoTracks(),!r.isVideoMuted()),e.localCallFeed=r,e.addUserMediaFeed(r),e.state=at.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return S(function*(){if(t.localCallFeed){var r=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var n=t.localCallFeed.isAudioMuted(),s=t.localCallFeed.isVideoMuted();p.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(r.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(n,", vidShouldBeMuted=").concat(s,")")),St(e.getAudioTracks(),!n),St(e.getVideoTracks(),!s),t.client.getMediaHandler().stopUserMediaStream(r)}})()}enter(){var e=this;return S(function*(){if(e.state===at.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==at.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));p.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=at.Entered,e.client.on(Jc.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===at.Entered&&(this.forEachCall(t=>t.hangup(Me.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(Jc.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=at.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return S(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(Ae.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(Yc.Ended,t),t.state=at.Ended,r){var n=t.room.currentState.getStateEvents(F.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,F.GroupCallPrefix,Da(Da({},n.getContent()),{},{"m.terminated":rI.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return S(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var r=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(o=>{var a;return(a=o.localUsermediaFeed)===null||a===void 0?void 0:a.setAudioVideoMuted(e,null)});var n=function(){var o=S(function*(){var a=[];t.forEachCall(l=>a.push(l.sendMetadataUpdate())),yield Promise.all(a).catch(l=>p.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),l))});return function(){return o.apply(this,arguments)}}();if(r&&(yield n()),t.localCallFeed){p.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var s=yield t.checkAudioPermissionIfNecessary(e);if(!s)return!1;t.localCallFeed.setAudioVideoMuted(e,null),St(t.localCallFeed.stream.getAudioTracks(),!e)}else p.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(o=>St(o.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(o))),t.emit(Ye.LocalMuteStateChanged,e,t.isLocalVideoMuted()),r||(yield n()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return S(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if((r==null?void 0:r.getTracks().length)===0)return p.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return p.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return S(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){p.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(r),t.localCallFeed.setAudioVideoMuted(null,e),St(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return p.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else p.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var n=[];return t.forEachCall(s=>n.push(s.setLocalVideoMuted(e))),yield Promise.all(n),t.forEachCall(s=>St(s.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(s))),t.emit(Ye.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(e===r.isScreensharing())return e;if(e)try{p.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var s=yield r.client.getMediaHandler().getScreensharingStream(n),o=function*(u){var c=()=>{r.setScreensharingEnabled(!1),u.removeEventListener("ended",c)};u.addEventListener("ended",c)};for(var a of s.getTracks())yield*o(a);return p.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),r.localDesktopCapturerSourceId=n.desktopCapturerSourceId,r.localScreenshareFeed=new mn({client:r.client,roomId:r.room.roomId,userId:r.client.getUserId(),deviceId:r.client.getDeviceId(),stream:s,purpose:Qe.Screenshare,audioMuted:!1,videoMuted:!1}),r.addScreenshareFeed(r.localScreenshareFeed),r.emit(Ye.LocalScreenshareStateChanged,!0,r.localScreenshareFeed,r.localDesktopCapturerSourceId),r.forEachCall(l=>l.pushLocalFeed(r.localScreenshareFeed.clone())),!0}catch(l){if(n.throwOnFail)throw l;return p.error("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() enabling screensharing error"),l),r.emit(Ye.Error,new Qc(Bo.NoUserMedia,"Failed to get screen-sharing stream: ",l)),!1}else return r.forEachCall(l=>{l.localScreensharingFeed&&l.removeLocalFeed(l.localScreensharingFeed)}),r.client.getMediaHandler().stopScreensharingStream(r.localScreenshareFeed.stream),r.removeScreenshareFeed(r.localScreenshareFeed),r.localScreenshareFeed=void 0,r.localDesktopCapturerSourceId=void 0,r.emit(Ye.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){var e=this,t=!1,r=function(a){var l,u=(l=e.calls.get(a))!==null&&l!==void 0?l:new Map,c=function(v){var m=u.get(v);if((m==null?void 0:m.getOpponentSessionId())!==h.sessionId&&e.wantsOutgoingCall(a,v)){t=!0,m!==void 0&&(p.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(a,", deviceId=").concat(v,", callId=").concat(m.callId,")")),m.hangup(Me.NewSession,!1));var E=na(e.client,e.room.roomId,{invitee:a,opponentDeviceId:v,opponentSessionId:h.sessionId,groupCallId:e.groupCallId});E===null?(p.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(a,", device=").concat(v,")")),u.delete(v)):(e.initCall(E),u.set(v,E),p.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(a,", deviceId=").concat(v,", sessionId=").concat(h.sessionId,")")),E.placeCallWithCallFeeds(e.getLocalFeeds().map(R=>R.clone()),h.screensharing).then(()=>{e.dataChannelsEnabled&&E.createDataChannel("datachannel",e.dataChannelOptions)}).catch(R=>{p.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(a,")"),R),R instanceof dn&&R.code===Bo.UnknownDevice?e.emit(Ye.Error,R):e.emit(Ye.Error,new Qc(Bo.PlaceCallFailed,"Failed to place call to ".concat(a))),E.hangup(Me.SignallingFailed,!1),u.get(v)===E&&u.delete(v)}))}};for(var[d,h]of s)c(d);u.size>0?e.calls.set(a,u):e.calls.delete(a)};for(var[{userId:n},s]of this.participants)r(n);t&&this.emit(Ye.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(F.GroupCallMemberPrefix):this.room.currentState.getStateEvents(F.GroupCallMemberPrefix,e)}initCall(e){var t=Ua(e);if(!t)throw new Error("Cannot init call without user id");var r=()=>this.onCallFeedsChanged(e),n=(l,u)=>this.onCallStateChanged(e,l,u),s=this.onCallHangup,o=l=>this.onCallReplaced(e,l),a=this.callHandlers.get(t);a===void 0&&(a=new Map,this.callHandlers.set(t,a)),a.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:s,onCallReplaced:o}),e.on(De.FeedsChanged,r),e.on(De.State,n),e.on(De.Hangup,s),e.on(De.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(De)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){var r=Ua(e),n=e.getOpponentDeviceId();if(!r)throw new Error("Cannot dispose call without user id");var s=this.callHandlers.get(r),{onCallFeedsChanged:o,onCallStateChanged:a,onCallHangup:l,onCallReplaced:u}=s.get(n);if(e.removeListener(De.FeedsChanged,o),e.removeListener(De.State,a),e.removeListener(De.Hangup,l),e.removeListener(De.Replaced,u),s.delete(r),s.size===0&&this.callHandlers.delete(r),e.hangupReason!==Me.Replaced){var c=this.getUserMediaFeed(r,n);c&&this.removeUserMediaFeed(c);var d=this.getScreenshareFeed(r,n);d&&this.removeScreenshareFeed(d)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(r=>r.userId===e&&r.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(Ye.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var r=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(Ye.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(Ye.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(Ye.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(r=>r.userId===e&&r.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(Ye.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var r=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(Ye.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(Ye.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getUserId());if(!e){p.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===at.Ended){this.participants=new Map;return}var t=new Map,r=Date.now(),n=this.state===at.Entered||this.enteredViaAnotherSession,s=1/0;for(var o of this.getMemberStateEvents()){var a=this.room.getMember(o.getStateKey()),l=o.getContent(),u=Array.isArray(l["m.calls"])?l["m.calls"]:[],c=u.find(E=>E["m.call_id"]===this.groupCallId),d=Array.isArray(c==null?void 0:c["m.devices"])?c["m.devices"]:[],h=d.filter(E=>typeof E.device_id=="string"&&typeof E.session_id=="string"&&typeof E.expires_ts=="number"&&E.expires_ts>r&&Array.isArray(E.feeds));if(!n&&(a==null?void 0:a.userId)===this.client.getUserId()&&(h=h.filter(E=>E.device_id!==this.client.getDeviceId())),h.length>0&&(a==null?void 0:a.membership)===Oe.Join){var g=new Map;t.set(a,g);for(var v of h)g.set(v.device_id,{sessionId:v.session_id,screensharing:v.feeds.some(E=>E.purpose===Qe.Screenshare)}),v.expires_ts<s&&(s=v.expires_ts)}}if(n){var m=t.get(e);m===void 0&&(m=new Map,t.set(e,m)),m.has(this.client.getDeviceId())||m.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(E=>E.purpose===Qe.Screenshare)})}this.participants=t,s<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),s-r))}updateDevices(e){var t=arguments,r=this;return S(function*(){var n,s=t.length>1&&t[1]!==void 0?t[1]:!1,o=Date.now(),a=r.client.getUserId(),l=r.getMemberStateEvents(a),u=(n=l==null?void 0:l.getContent())!==null&&n!==void 0?n:{},c=Array.isArray(u["m.calls"])?u["m.calls"]:[],d=null,h=[];for(var g of c)g["m.call_id"]===r.groupCallId?d=g:h.push(g);d===null&&(d={});var v=Array.isArray(d["m.devices"])?d["m.devices"]:[],m=v.filter(T=>typeof T.device_id=="string"&&typeof T.session_id=="string"&&typeof T.expires_ts=="number"&&T.expires_ts>o&&Array.isArray(T.feeds)),E=e(m);if(E!==null){var R=[...h];E.length>0&&R.push(Da(Da({},d),{},{"m.call_id":r.groupCallId,"m.devices":E}));var _={"m.calls":R};yield r.client.sendStateEvent(r.room.roomId,F.GroupCallMemberPrefix,_,a,{keepAlive:s})}})()}addDeviceToMemberState(){var e=this;return S(function*(){yield e.updateDevices(t=>[...t.filter(r=>r.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+qv,feeds:e.getLocalFeeds().map(r=>({purpose:r.purpose}))}])})()}updateMemberState(){var e=this;return S(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===at.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(S(function*(){p.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){p.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),qv*3/4)):yield e.updateDevices(t=>t.filter(r=>r.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return S(function*(){var{devices:t}=yield e.client.getDevices(),r=new Map(t.map(n=>[n.device_id,n]));yield e.updateDevices(n=>{var s=n.filter(o=>{var a=r.get(o.device_id);return(a==null?void 0:a.last_seen_ts)!==void 0&&!(o.device_id===e.client.getDeviceId()&&e.state!==at.Entered&&!e.enteredViaAnotherSession)});return s.length===n.length?null:s})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new tI(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(bn.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(bn.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(bn.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(bn.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function Vv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function La(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Vv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Vv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Ie=function(i){return i.Fledgling="fledgling",i.InviteSent="invite_sent",i.WaitLocalMedia="wait_local_media",i.CreateOffer="create_offer",i.CreateAnswer="create_answer",i.Connecting="connecting",i.Connected="connected",i.Ringing="ringing",i.Ended="ended",i}({}),Wv=function(i){return i.Voice="voice",i.Video="video",i}({}),Un=function(i){return i.Inbound="inbound",i.Outbound="outbound",i}({}),ct=function(i){return i.Local="local",i.Remote="remote",i}({}),De=function(i){return i.Hangup="hangup",i.State="state",i.Error="error",i.Replaced="replaced",i.LocalHoldUnhold="local_hold_unhold",i.RemoteHoldUnhold="remote_hold_unhold",i.HoldUnhold="hold_unhold",i.FeedsChanged="feeds_changed",i.AssertedIdentityChanged="asserted_identity_changed",i.LengthChanged="length_changed",i.DataChannel="datachannel",i.SendVoipEvent="send_voip_event",i.PeerConnectionCreated="peer_connection_created",i}({}),Me=function(i){return i.UserHangup="user_hangup",i.LocalOfferFailed="local_offer_failed",i.NoUserMedia="no_user_media",i.UnknownDevices="unknown_devices",i.SendInvite="send_invite",i.CreateAnswer="create_answer",i.CreateOffer="create_offer",i.SendAnswer="send_answer",i.SetRemoteDescription="set_remote_description",i.SetLocalDescription="set_local_description",i.AnsweredElsewhere="answered_elsewhere",i.IceFailed="ice_failed",i.InviteTimeout="invite_timeout",i.Replaced="replaced",i.SignallingFailed="signalling_timeout",i.UserBusy="user_busy",i.Transferred="transferred",i.NewSession="new_session",i}({}),nI="1",iI="stun:turn.matrix.org",zu=60*1e3,sI=1e3,oI=30*1e3,aI=2*1e3;class dn extends Error{constructor(e,t,r){super(t+": "+r),f(this,"code",void 0),this.code=e}}function Ri(){return Date.now().toString()+Dr(16)}function Gv(i){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:i?12e3:void 0}];return e}function Er(i,e){return i+":"+e}class lI extends rt{constructor(e){var t,r;if(super(),t=this,f(this,"roomId",void 0),f(this,"callId",void 0),f(this,"invitee",void 0),f(this,"hangupParty",void 0),f(this,"hangupReason",void 0),f(this,"direction",void 0),f(this,"ourPartyId",void 0),f(this,"peerConn",void 0),f(this,"toDeviceSeq",0),f(this,"isPtt",!1),f(this,"_state",Ie.Fledgling),f(this,"client",void 0),f(this,"forceTURN",void 0),f(this,"turnServers",void 0),f(this,"candidateSendQueue",[]),f(this,"candidateSendTries",0),f(this,"candidatesEnded",!1),f(this,"feeds",[]),f(this,"transceivers",new Map),f(this,"inviteOrAnswerSent",!1),f(this,"waitForLocalAVStream",!1),f(this,"successor",void 0),f(this,"opponentMember",void 0),f(this,"opponentVersion",void 0),f(this,"opponentPartyId",void 0),f(this,"opponentCaps",void 0),f(this,"iceDisconnectedTimeout",void 0),f(this,"iceReconnectionTimeOut",void 0),f(this,"inviteTimeout",void 0),f(this,"removeTrackListeners",new Map),f(this,"remoteOnHold",!1),f(this,"callStatsAtEnd",void 0),f(this,"makingOffer",!1),f(this,"ignoreOffer",!1),f(this,"isSettingRemoteAnswerPending",!1),f(this,"responsePromiseChain",void 0),f(this,"remoteCandidateBuffer",new Map),f(this,"remoteAssertedIdentity",void 0),f(this,"remoteSDPStreamMetadata",void 0),f(this,"callLengthInterval",void 0),f(this,"callStartTime",void 0),f(this,"opponentDeviceId",void 0),f(this,"opponentDeviceInfo",void 0),f(this,"opponentSessionId",void 0),f(this,"groupCallId",void 0),f(this,"stopVideoTrackTimer",void 0),f(this,"isOnlyDataChannelAllowed",void 0),f(this,"stats",void 0),f(this,"gotLocalIceCandidate",s=>{if(s.candidate){if(this.candidatesEnded&&p.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),p.debug("Call ".concat(this.callId," got local ICE ").concat(s.candidate.sdpMid," ").concat(s.candidate.candidate)),this.callHasEnded())return;s.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(s.candidate)}}),f(this,"onIceGatheringStateChange",s=>{var o;p.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((o=this.peerConn)===null||o===void 0?void 0:o.iceGatheringState)==="complete"&&(this.queueCandidate(null),p.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),f(this,"getLocalOfferFailed",s=>{p.error("Call ".concat(this.callId," getLocalOfferFailed() running"),s),this.emit(De.Error,new dn(Me.LocalOfferFailed,"Failed to get local offer!",s),this),this.terminate(ct.Local,Me.LocalOfferFailed,!1)}),f(this,"getUserMediaFailed",s=>{if(this.successor){this.successor.getUserMediaFailed(s);return}p.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),s),this.emit(De.Error,new dn(Me.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",s),this),this.terminate(ct.Local,Me.NoUserMedia,!1)}),f(this,"placeCallFailed",s=>{if(this.successor){this.successor.placeCallFailed(s);return}p.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),s),this.emit(De.Error,new dn(Me.IceFailed,"Couldn't start call! Invalid ICE server configuration.",s),this),this.terminate(ct.Local,Me.IceFailed,!1)}),f(this,"onIceConnectionStateChanged",()=>{var s,o,a,l,u,c;if(!this.callHasEnded()){if(p.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((s=this.peerConn)===null||s===void 0?void 0:s.iceConnectionState,", conn=").concat((o=this.peerConn)===null||o===void 0?void 0:o.connectionState,")")),["connected","completed"].includes((a=(l=this.peerConn)===null||l===void 0?void 0:l.iceConnectionState)!==null&&a!==void 0?a:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=Ie.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(De.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},sI));else if(((u=this.peerConn)===null||u===void 0?void 0:u.iceConnectionState)=="failed"){var d;if(this.candidatesEnded=!1,(d=this.peerConn)!==null&&d!==void 0&&d.restartIce){var h;this.candidatesEnded=!1,p.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((h=this.peerConn)===null||h===void 0?void 0:h.iceConnectionState,")")),this.peerConn.restartIce()}else p.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Me.IceFailed,!1)}else((c=this.peerConn)===null||c===void 0?void 0:c.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var v,m,E;p.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState,", conn=").concat((m=this.peerConn)===null||m===void 0?void 0:m.connectionState,")")),(E=this.peerConn)!==null&&E!==void 0&&E.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},aI),this.iceDisconnectedTimeout=setTimeout(()=>{p.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Me.IceFailed,!1)},oI),this.state=Ie.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var g of this.getRemoteFeeds())g.setAudioVideoMuted(!0,!0)}}),f(this,"onSignallingStateChanged",()=>{var s;p.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((s=this.peerConn)===null||s===void 0?void 0:s.signalingState,")"))}),f(this,"onTrack",s=>{if(s.streams.length===0){p.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(s.track.kind,")"));return}var o=s.streams[0];if(this.pushRemoteFeed(o),!this.removeTrackListeners.has(o)){var a=()=>{o.getTracks().length===0&&(p.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(o.id,")")),this.deleteFeedByStream(o),o.removeEventListener("removetrack",a),this.removeTrackListeners.delete(o))};o.addEventListener("removetrack",a),this.removeTrackListeners.set(o,a)}}),f(this,"onDataChannel",s=>{this.emit(De.DataChannel,s.channel,this)}),f(this,"onNegotiationNeeded",S(function*(){if(p.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==Ie.CreateOffer&&t.opponentVersion===0){p.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),f(this,"onHangupReceived",s=>{p.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(s)||this.state===Ie.Ringing?this.terminate(ct.Remote,s.reason||Me.UserHangup,!0):p.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(s.party_id,": our partner is ").concat(this.opponentPartyId))}),f(this,"onRejectReceived",s=>{p.debug("Call ".concat(this.callId," onRejectReceived() running"));var o=[Ie.InviteSent,Ie.Ringing].includes(this.state)||this.state===Ie.Fledgling&&this.direction===Un.Inbound;o?this.terminate(ct.Remote,s.reason||Me.UserHangup,!0):p.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),f(this,"onAnsweredElsewhere",s=>{p.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(ct.Remote,Me.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(r=e.forceTURN)!==null&&r!==void 0?r:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[iI]});for(var n of this.turnServers)yy(n,["urls"]);this.callId=Ri(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return S(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return S(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var r=this.peerConn.createDataChannel(e,t);return this.emit(De.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(De.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?Wv.Video:Wv.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Qe.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Qe.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(Er(Qe.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(Er(Qe.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Qe.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Qe.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Qe.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Qe.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return S(function*(){var t,r;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.isCryptoEnabled()){e.opponentDeviceInfo=new er(e.opponentDeviceId);return}if(!e.client.crypto)throw new Error("Crypto is not initialised.");var n=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);if(!n)throw new Error("Couldn't find opponent user ID to init crypto");var s=yield e.client.crypto.deviceList.downloadKeys([n],!1);if(e.opponentDeviceInfo=(r=s.get(n))===null||r===void 0?void 0:r.get(e.opponentDeviceId),e.opponentDeviceInfo===void 0)throw new hS(n)}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,s=this.remoteSDPStreamMetadata[e.id].video_muted;if(!r){p.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){p.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new mn({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:s})),this.emit(De.FeedsChanged,this.feeds,this),p.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))}pushRemoteFeedWithoutMetadata(e){var t,r=this.getOpponentMember().userId,n=Qe.Usermedia,s=(t=this.feeds.find(o=>!o.isLocal()))===null||t===void 0?void 0:t.stream;if(s&&e.id!==s.id){p.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){p.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new mn({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(De.FeedsChanged,this.feeds,this),p.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=this.client.getUserId();if(St(e.getAudioTracks(),!0),St(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){p.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new mn({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){var t=this,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(o=>e.stream.id===o.stream.id)){p.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),r){var n=function(){p.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(s.id,", kind=").concat(s.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(s.enabled,")"));var a=Er(e.purpose,s.kind);if(t.transceivers.has(a)){var l=t.transceivers.get(a);l.sender.replaceTrack(s),l.direction=l.direction==="inactive"?"sendonly":"sendrecv"}else{var u=t.peerConn.addTrack(s,e.stream),c=t.peerConn.getTransceivers().find(d=>d.sender===u);c?t.transceivers.set(a,c):p.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var s of e.stream.getTracks())n()}p.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(De.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=Er(e.purpose,"audio"),r=Er(e.purpose,"video");for(var n of[t,r])if(this.transceivers.has(n)){var s=this.transceivers.get(n);s.sender&&this.peerConn.removeTrack(s.sender)}e.purpose===Qe.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(De.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){p.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(De.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return S(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return S(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),r=[];return t.forEach(n=>{r.push(n)}),r}})()}initWithInvite(e){var t=this;return S(function*(){var r,n=e.getContent();t.direction=Un.Inbound;var s=yield t.client.checkTurnServers();s||p.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var o=n[Mn];o?t.updateRemoteSDPStreamMetadata(o):p.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(De.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(n.offer),p.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(n.offer.type)),yield t.addBufferedIceCandidates()}catch(c){p.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),c),t.terminate(ct.Local,Me.SetRemoteDescription,!1);return}var a=(r=t.feeds.find(c=>!c.isLocal()))===null||r===void 0?void 0:r.stream;if(!t.isOnlyDataChannelAllowed&&(!a||a.getTracks().length===0)){p.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(ct.Local,Me.SetRemoteDescription,!1);return}if(t.state=Ie.Ringing,e.getLocalAge()){var l=setTimeout(()=>{if(t.state==Ie.Ringing){var c;p.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=ct.Remote,t.state=Ie.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(c=t.stats)===null||c===void 0||c.removeStatsReportGatherer(t.callId),t.emit(De.Hangup,t)}},n.lifetime-e.getLocalAge()),u=c=>{c!==Ie.Ringing&&(clearTimeout(l),t.off(De.State,u))};t.on(De.State,u)}})()}initWithHangup(e){this.state=Ie.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(p.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):!by(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(p.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t):e??t}answer(e,t){var r=this;return S(function*(){if(!r.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!r.localUsermediaStream&&!r.waitForLocalAVStream){var n=r.state,s=r.shouldAnswerWithMediaType(e,r.hasRemoteUserMediaAudioTrack,"audio"),o=r.shouldAnswerWithMediaType(t,r.hasRemoteUserMediaVideoTrack,"video");r.state=Ie.WaitLocalMedia,r.waitForLocalAVStream=!0;try{var a,l=yield r.client.getMediaHandler().getUserMediaStream(s,o);r.waitForLocalAVStream=!1;var u=new mn({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(a=r.client.getDeviceId())!==null&&a!==void 0?a:void 0,stream:l,purpose:Qe.Usermedia,audioMuted:!1,videoMuted:!1}),c=[u];r.localScreensharingFeed&&c.push(r.localScreensharingFeed),r.answerWithCallFeeds(c)}catch(d){if(o)p.warn("Call ".concat(r.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),r.state=n,r.waitForLocalAVStream=!1,yield r.answer(s,!1);else{r.getUserMediaFailed(d);return}}}else r.waitForLocalAVStream&&(r.state=Ie.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){p.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===Ie.WaitLocalMedia?(p.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[Ie.CreateOffer,Ie.InviteSent].includes(this.state)&&(e.direction===Un.Outbound?e.queueGotCallFeedsForAnswer([]):(p.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(De.Replaced,e,this),this.hangup(Me.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(p.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(ct.Local,e,!t),![Ie.Fledgling,Ie.WaitLocalMedia].includes(this.state))){var r={};(this.opponentVersion&&this.opponentVersion!==0||e!==Me.UserHangup)&&(r.reason=e),this.sendVoipEvent(F.CallHangup,r)}}reject(){if(this.state!==Ie.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){p.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Me.UserHangup,!0);return}p.debug("Rejecting call: "+this.callId),this.terminate(ct.Local,Me.UserHangup,!0),this.sendVoipEvent(F.CallReject,{})}upgradeCall(e,t){var r=this;return S(function*(){if(!(!e&&!t)&&r.opponentSupportsSDPStreamMetadata())try{p.debug("Call ".concat(r.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var n=e||r.hasLocalUserMediaAudioTrack,s=t||r.hasLocalUserMediaVideoTrack,o=yield r.client.getMediaHandler().getUserMediaStream(n,s,!1);yield r.updateLocalUsermediaStream(o,e,t)}catch(a){p.error("Call ".concat(r.callId," upgradeCall() failed to upgrade the call"),a),r.emit(De.Error,new dn(Me.NoUserMedia,"Failed to get camera access: ",a),r)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var r=this;return S(function*(){if(e&&r.isScreensharing())return p.warn("Call ".concat(r.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!r.isScreensharing())return p.warn("Call ".concat(r.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!r.opponentSupportsSDPStreamMetadata())return r.setScreensharingEnabledWithoutMetadataSupport(e,t);if(p.debug("Call ".concat(r.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var n=yield r.client.getMediaHandler().getScreensharingStream(t);return n?(r.pushNewLocalFeed(n,Qe.Screenshare),!0):!1}catch(l){return p.error("Call ".concat(r.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),l),!1}else{var s=r.transceivers.get(Er(Qe.Screenshare,"audio")),o=r.transceivers.get(Er(Qe.Screenshare,"video"));for(var a of[s,o])a&&a.sender&&r.peerConn.removeTrack(a.sender);return r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var r=this;return S(function*(){if(p.debug("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var n,s=yield r.client.getMediaHandler().getScreensharingStream(t);if(!s)return!1;var o=s.getTracks().find(h=>h.kind==="video"),a=(n=r.transceivers.get(Er(Qe.Usermedia,"video")))===null||n===void 0?void 0:n.sender;return a==null||a.replaceTrack(o??null),r.pushNewLocalFeed(s,Qe.Screenshare,!1),!0}catch(h){return p.error("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),h),!1}else{var l,u,c=(l=r.localUsermediaStream)===null||l===void 0?void 0:l.getTracks().find(h=>h.kind==="video"),d=(u=r.transceivers.get(Er(Qe.Usermedia,"video")))===null||u===void 0?void 0:u.sender;return d==null||d.replaceTrack(c??null),r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2&&t[2]!==void 0?t[2]:!1,o=r.localUsermediaFeed,a=n||!o.isAudioMuted()&&!r.remoteOnHold,l=s||!o.isVideoMuted()&&!r.remoteOnHold;p.log("Call ".concat(r.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(a,", video=").concat(l,")")),St(e.getAudioTracks(),a),St(e.getVideoTracks(),l);for(var u of r.localUsermediaStream.getTracks())r.localUsermediaStream.removeTrack(u),u.stop();for(var c of e.getTracks())r.localUsermediaStream.addTrack(c);var d=function*(){var v=Er(Qe.Usermedia,h.kind),m=r.transceivers.get(v),E=m==null?void 0:m.sender,R=!1;if(E)try{p.info("Call ".concat(r.callId," updateLocalUsermediaStream() replacing track (id=").concat(h.id,", kind=").concat(h.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")")),yield E.replaceTrack(h),m.direction=m.direction==="inactive"?"sendonly":"sendrecv",R=!0}catch(b){p.warn("Call ".concat(r.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),b)}if(!R){p.info("Call ".concat(r.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(h.id,", kind=").concat(h.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")"));var _=r.peerConn.addTrack(h,r.localUsermediaStream),T=r.peerConn.getTransceivers().find(b=>b.sender===_);T?r.transceivers.set(v,T):p.warn("Call ".concat(r.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var h of e.getTracks())yield*d()})()}setLocalVideoMuted(e){var t=this;return S(function*(){var r;if(p.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var n;return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var s=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(s)}return(r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var o of t.localUsermediaStream.getVideoTracks())o.stop(),t.localUsermediaStream.removeTrack(o)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return S(function*(){var r;return p.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(De.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==Ie.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var r=["inactive","recvonly"].includes(t.currentDirection);r||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var r;if(((r=t.track)===null||r===void 0?void 0:r.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;p.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),St(this.localUsermediaStream.getAudioTracks(),!e),St(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return S(function*(){yield e.sendVoipEvent(F.CallSDPStreamMetadataChangedPrefix,{[Mn]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var r of e)this.pushLocalFeed(r);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=Ie.CreateOffer,p.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return S(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[Mn]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var r=e.discardDuplicateCandidates();p.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(r," candidates that will be sent in answer"));try{yield e.sendVoipEvent(F.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(o){e.state=Ie.Ringing,o instanceof Qt&&o.event&&e.client.cancelPendingEvent(o.event);var n=Me.SendAnswer,s="Failed to send answer";throw o.name=="UnknownDeviceError"&&(n=Me.UnknownDevices,s="Unknown devices present in the room"),e.emit(De.Error,new dn(n,s,o),e),o}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var r=Hc.parse(e.sdp);r.media.forEach(n=>{var s=new Map,o=new Map;for(var a of n.rtp)s.set(a.payload,a.codec),o.set(a.codec,a.payload);for(var l of t)if(l.mediaType===n.type){if(!o.has(l.codec)){p.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(l.codec," as it's not present."));continue}var u=[];l.enableDtx!==void 0&&u.push("usedtx=".concat(l.enableDtx?"1":"0")),l.maxAverageBitrate!==void 0&&u.push("maxaveragebitrate=".concat(l.maxAverageBitrate));var c=!1;for(var d of n.fmtp)s.get(d.payload)===l.codec&&(c=!0,d.config+=";"+u.join(";"));c||n.fmtp.push({payload:o.get(l.codec),config:u.join(";")})}}),e.sdp=Hc.write(r)}createOffer(){var e=this;return S(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,Gv(e.isPtt)),t})()}createAnswer(){var e=this;return S(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,Gv(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return S(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var r of e)t.pushLocalFeed(r);t.state=Ie.CreateAnswer;var n;try{t.getRidOfRTXCodecs(),n=yield t.createAnswer()}catch(s){p.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),s),t.terminate(ct.Local,Me.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(n),t.callHasEnded()||(t.state=Ie.Connecting,yield new Promise(s=>{setTimeout(s,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(s){p.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),s),t.terminate(ct.Local,Me.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return S(function*(){if(!t.callHasEnded()){var r=e.getContent(),n=r.candidates;if(!n){p.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var s=r.version===0?null:r.party_id||null;if(t.opponentPartyId===void 0){if(s){p.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(n.length," candidates until we pick an opponent"));var o=t.remoteCandidateBuffer.get(s)||[];o.push(...n),t.remoteCandidateBuffer.set(s,o)}return}if(!t.partyIdMatches(r)){p.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(r.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(n)}})()}onAnswerReceived(e){var t=this;return S(function*(){var r=e.getContent();if(p.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(r.party_id,")")),t.callHasEnded()){p.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){p.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(r.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=Ie.Connecting;var n=r[Mn];n?t.updateRemoteSDPStreamMetadata(n):p.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(r.answer),t.isSettingRemoteAnswerPending=!1,p.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(r.answer.type))}catch(s){t.isSettingRemoteAnswerPending=!1,p.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),s),t.terminate(ct.Local,Me.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(F.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(s){p.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),s)}})()}onSelectAnswerReceived(e){var t=this;return S(function*(){if(t.direction!==Un.Inbound){p.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var r=e.getContent().selected_party_id;if(r==null){p.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}r!==t.ourPartyId&&(p.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(r,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(ct.Remote,Me.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return S(function*(){var r=e.getContent(),n=r.description;if(!n||!n.sdp||!n.type){p.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var s=t.direction===Un.Inbound,o=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),a=n.type==="offer"&&!o;if(t.ignoreOffer=!s&&a,t.ignoreOffer){p.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var l=t.isLocalOnHold(),u=r[Mn];u?t.updateRemoteSDPStreamMetadata(u):p.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=n.type=="answer",yield t.peerConn.setRemoteDescription(n),t.isSettingRemoteAnswerPending=!1,p.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(n.type)),n.type==="offer"){var c,d;try{t.getRidOfRTXCodecs(),d=yield t.createAnswer()}catch(g){p.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),g),t.terminate(ct.Local,Me.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(d),p.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(F.CallNegotiate,{lifetime:zu,description:(c=t.peerConn.localDescription)===null||c===void 0?void 0:c.toJSON(),[Mn]:t.getLocalSDPStreamMetadata(!0)})}}catch(g){t.isSettingRemoteAnswerPending=!1,p.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),g)}var h=t.isLocalOnHold();l!==h&&(t.emit(De.LocalHoldUnhold,h,t),t.emit(De.HoldUnhold,h))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=Ey(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var r,n=t.stream.id,s=this.remoteSDPStreamMetadata[n];t.setAudioVideoMuted(s==null?void 0:s.audio_muted,s==null?void 0:s.video_muted),t.purpose=(r=this.remoteSDPStreamMetadata[n])===null||r===void 0?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),r=t[Mn];this.updateRemoteSDPStreamMetadata(r)}onAssertedIdentityReceived(e){var t=this;return S(function*(){var r=e.getContent();r.asserted_identity&&(t.remoteAssertedIdentity={id:r.asserted_identity.id,displayName:r.asserted_identity.display_name},t.emit(De.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===Ie.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return S(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return S(function*(){if(p.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){p.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(c){p.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),c),e.terminate(ct.Local,Me.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(c){p.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),c),e.terminate(ct.Local,Me.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(c=>{setTimeout(c,200)})),!e.callHasEnded()){var r=e.state===Ie.CreateOffer?F.CallInvite:F.CallNegotiate,n={lifetime:zu};if(r===F.CallInvite&&e.invitee&&(n.invitee=e.invitee),e.state===Ie.CreateOffer){var s;n.offer=(s=e.peerConn.localDescription)===null||s===void 0?void 0:s.toJSON()}else{var o;n.description=(o=e.peerConn.localDescription)===null||o===void 0?void 0:o.toJSON()}n.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},n[Mn]=e.getLocalSDPStreamMetadata(!0);var a=e.discardDuplicateCandidates();p.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(a," candidates that will be sent in offer"));try{yield e.sendVoipEvent(r,n)}catch(c){p.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),c),c instanceof Qt&&c.event&&e.client.cancelPendingEvent(c.event);var l=Me.SignallingFailed,u="Signalling failed";e.state===Ie.CreateOffer&&(l=Me.SendInvite,u="Failed to send invite"),c.name=="UnknownDeviceError"&&(l=Me.UnknownDevices,u="Unknown devices present in the room"),e.emit(De.Error,new dn(l,u,c),e),e.terminate(ct.Local,l,!1);return}e.sendCandidateQueue(),e.state===Ie.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=Ie.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===Ie.InviteSent&&e.hangup(Me.InviteTimeout,!1)},zu))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(Er(Qe.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,r=RTCRtpSender.getCapabilities("video").codecs,n=[];for(var s of[...t,...r])if(s.mimeType!=="video/rtx"){n.push(s);try{e.setCodecPreferences(n)}catch(o){p.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",s,o),n.pop()}}}}}sendVoipEvent(e,t){var r=this;return S(function*(){var n=La(La({},t),{},{version:nI,call_id:r.callId,party_id:r.ourPartyId,conf_id:r.groupCallId});if(r.opponentDeviceId){var s,o=r.toDeviceSeq++,a=La(La({},n),{},{device_id:r.client.deviceId,sender_session_id:r.client.getSessionId(),dest_session_id:r.opponentSessionId,seq:o,[Zt]:Ar()});r.emit(De.SendVoipEvent,{type:"toDevice",eventType:e,userId:r.invitee||((s=r.getOpponentMember())===null||s===void 0?void 0:s.userId),opponentDeviceId:r.opponentDeviceId,content:a},r);var l=r.invitee||r.getOpponentMember().userId;if(r.client.getUseE2eForGroupCall()){if(!r.opponentDeviceInfo){p.warn("Call ".concat(r.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}yield r.client.encryptAndSendToDevices([{userId:l,deviceInfo:r.opponentDeviceInfo}],{type:e,content:a})}else yield r.client.sendToDevice(e,new Map([[l,new Map([[r.opponentDeviceId,a]])]]))}else{var u;r.emit(De.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:r.roomId,content:n,userId:r.invitee||((u=r.getOpponentMember())===null||u===void 0?void 0:u.userId)},r),yield r.client.sendEvent(r.roomId,e,n)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===Ie.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===Un.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],r=0;r<this.candidateSendQueue.length;r++){var n=this.candidateSendQueue[r];n.candidate===""?t.push(n):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return S(function*(){var r=yield t.client.getProfileInfo(e),n=Ri(),s={replacement_id:Ri(),target_user:{id:e,display_name:r.displayname,avatar_url:r.avatar_url},create_call:n};yield t.sendVoipEvent(F.CallReplaces,s),yield t.terminate(ct.Local,Me.Transferred,!0)})()}transferToCall(e){var t=this;return S(function*(){var r,n,s=(r=e.getOpponentMember())===null||r===void 0?void 0:r.userId,o=s?yield t.client.getProfileInfo(s):void 0,a=(n=t.getOpponentMember())===null||n===void 0?void 0:n.userId,l=a?yield t.client.getProfileInfo(a):void 0,u=Ri(),c={replacement_id:Ri(),target_user:{id:a,display_name:l==null?void 0:l.displayname,avatar_url:l==null?void 0:l.avatar_url},await_call:u};yield e.sendVoipEvent(F.CallReplaces,c);var d={replacement_id:Ri(),target_user:{id:s,display_name:o==null?void 0:o.displayname,avatar_url:o==null?void 0:o.avatar_url},create_call:u};yield t.sendVoipEvent(F.CallReplaces,d),yield t.terminate(ct.Local,Me.Transferred,!0),yield e.terminate(ct.Local,Me.Transferred,!0)})()}terminate(e,t,r){var n=this;return S(function*(){var s;if(!n.callHasEnded()){n.hangupParty=e,n.hangupReason=t,n.state=Ie.Ended,n.inviteTimeout&&(clearTimeout(n.inviteTimeout),n.inviteTimeout=void 0),n.iceDisconnectedTimeout!==void 0&&(clearTimeout(n.iceDisconnectedTimeout),n.iceDisconnectedTimeout=void 0),n.callLengthInterval&&(clearInterval(n.callLengthInterval),n.callLengthInterval=void 0),n.stopVideoTrackTimer!==void 0&&(clearTimeout(n.stopVideoTrackTimer),n.stopVideoTrackTimer=void 0);for(var[o,a]of n.removeTrackListeners)o.removeEventListener("removetrack",a);n.removeTrackListeners.clear(),n.callStatsAtEnd=yield n.collectCallStats(),n.stopAllMedia(),n.deleteAllFeeds(),n.peerConn&&n.peerConn.signalingState!=="closed"&&n.peerConn.close(),(s=n.stats)===null||s===void 0||s.removeStatsReportGatherer(n.callId),r&&n.emit(De.Hangup,n),n.client.callEventHandler.calls.delete(n.callId)}})()}stopAllMedia(){p.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===Qe.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Qe.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){p.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(Ry.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return S(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var r={candidates:t.map(a=>a.toJSON())};e.candidatesEnded&&r.candidates.push({candidate:""}),p.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(F.CallCandidates,r),e.candidateSendTries=0,e.sendCandidateQueue()}catch(a){if(a instanceof Qt&&a.event&&e.client.cancelPendingEvent(a.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){p.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),a);var n=Me.SignallingFailed,s="Signalling failed";e.emit(De.Error,new dn(n,s,a),e),e.hangup(n,!1);return}var o=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,p.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(o,"ms"),a),setTimeout(()=>{e.sendCandidateQueue()},o)}}})()}placeCall(e,t){var r=this;return S(function*(){if(!e)throw new Error("You CANNOT start a call without audio");r.state=Ie.WaitLocalMedia;var n;try{var s,o=yield r.client.getMediaHandler().getUserMediaStream(e,t);St(o.getAudioTracks(),!0),St(o.getVideoTracks(),!0),n=new mn({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(s=r.client.getDeviceId())!==null&&s!==void 0?s:void 0,stream:o,purpose:Qe.Usermedia,audioMuted:!1,videoMuted:!1})}catch(a){r.getUserMediaFailed(a);return}try{yield r.placeCallWithCallFeeds([n])}catch(a){r.placeCallFailed(a);return}})()}placeCallWithCallFeeds(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;r.checkForErrorListener(),r.direction=Un.Outbound,yield r.initOpponentCrypto(),r.client.callEventHandler.calls.set(r.callId,r);var s=yield r.client.checkTurnServers();s||p.warn("Call ".concat(r.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),r.peerConn=r.createPeerConnection(),r.emit(De.PeerConnectionCreated,r.peerConn,r),r.gotCallFeedsForInvite(e,n)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var r=this.getOpponentMember(),n=r?r.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,r=e.getContent();if(p.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(r.party_id,")")),this.opponentVersion=r.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=r.party_id||null,this.opponentCaps=r.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var n;(n=this.stats)===null||n===void 0||n.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return S(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(p.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return S(function*(){for(var r of e){(r.sdpMid===null||r.sdpMid===void 0)&&(r.sdpMLineIndex===null||r.sdpMLineIndex===void 0)?p.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):p.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(r.sdpMid,", candidate=").concat(r.candidate,")"));try{yield t.peerConn.addIceCandidate(r)}catch(n){t.ignoreOffer?p.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),n):p.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),n)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}}function St(i,e){for(var t of i)t.enabled=e}function Xc(){if(typeof window>"u"||typeof document>"u")return!1;try{var i=!!(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices);if(!i)return p.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return p.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function na(i,e,t){if(!Xc())return null;var r=t?t.forceTURN:!1,n={client:i,roomId:e,invitee:t==null?void 0:t.invitee,turnServers:i.getTurnServers(),forceTURN:i.forceTURN||r,opponentDeviceId:t==null?void 0:t.opponentDeviceId,opponentSessionId:t==null?void 0:t.opponentSessionId,groupCallId:t==null?void 0:t.groupCallId},s=new lI(n);return i.reEmitter.reEmit(s,Object.values(De)),s}var zn=function(i){return i.DontNotify="dont_notify",i.Notify="notify",i.Coalesce="coalesce",i}({}),gh=function(i){return i.Highlight="highlight",i.Sound="sound",i}({}),uI=function(i){return i.ExactEquals="==",i.LessThan="<",i.GreaterThan=">",i.GreaterThanOrEqual=">=",i.LessThanOrEqual="<=",i}({}),cI="2";function dI(i){return i==="==2"||i==="2"}var _t=function(i){return i.EventMatch="event_match",i.EventPropertyIs="event_property_is",i.EventPropertyContains="event_property_contains",i.ContainsDisplayName="contains_display_name",i.RoomMemberCount="room_member_count",i.SenderNotificationPermission="sender_notification_permission",i.CallStarted="call_started",i.CallStartedPrefix="org.matrix.msc3914.call_started",i}({}),Ct=function(i){return i.Override="override",i.ContentSpecific="content",i.RoomSpecific="room",i.SenderSpecific="sender",i.Underride="underride",i}({}),It=function(i){return i.Master=".m.rule.master",i.IsUserMention=".m.rule.is_user_mention",i.IsRoomMention=".m.rule.is_room_mention",i.ContainsDisplayName=".m.rule.contains_display_name",i.ContainsUserName=".m.rule.contains_user_name",i.AtRoomNotification=".m.rule.roomnotif",i.DM=".m.rule.room_one_to_one",i.EncryptedDM=".m.rule.encrypted_room_one_to_one",i.Message=".m.rule.message",i.EncryptedMessage=".m.rule.encrypted",i.InviteToSelf=".m.rule.invite_for_me",i.MemberEvent=".m.rule.member_event",i.IncomingCall=".m.rule.call",i.SuppressNotices=".m.rule.suppress_notices",i.Tombstone=".m.rule.tombstone",i.PollStart=".m.rule.poll_start",i.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",i.PollEnd=".m.rule.poll_end",i.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",i.PollStartOneToOne=".m.rule.poll_start_one_to_one",i.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",i.PollEndOneToOne=".m.rule.poll_end_one_to_one",i.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",i}({});function Hv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function $v(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Hv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Hv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var zv=[Ct.Override,Ct.ContentSpecific,Ct.RoomSpecific,Ct.SenderSpecific,Ct.Underride],hI={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:_t.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:_t.SenderNotificationPermission,key:"room"}],actions:[zn.Notify,{set_tweak:gh.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:_t.EventMatch,key:"type",pattern:"m.reaction"}],actions:[zn.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:_t.EventMatch,key:"type",pattern:F.RoomServerAcl},{kind:_t.EventMatch,key:"state_key",pattern:""}],actions:[]}},ph=Symbol("UserDefinedRules"),fI=[It.Master,ph,It.SuppressNotices,It.InviteToSelf,It.MemberEvent,It.IsUserMention,It.ContainsDisplayName,It.IsRoomMention,It.AtRoomNotification,It.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],vI={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:_t.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:_t.CallStarted}],actions:[zn.Notify,{set_tweak:gh.Sound,value:"default"}]}},gI=[ph,It.IncomingCall,".org.matrix.msc3914.rule.room.call",It.EncryptedDM,It.DM,It.Message,It.EncryptedMessage];function Jv(i,e,t,r){var n=e.filter(g=>g.default),s=e.filter(g=>!g.default);function o(g){g===ph?l.push(...s):g in t?(p.warn("Adding default global ".concat(i," push rule ").concat(g)),l.push(t[g])):p.warn("Missing default global ".concat(i," push rule ").concat(g))}var a=0,l=[];for(var u of n){var c=r.indexOf(u.rule_id);if(c===-1){l.push(u);continue}for(;c>a;){var d=r[a];o(d),a+=1}l.push(u),a+=1}for(var h of r.slice(a))o(h);return l}class Tr{constructor(e){this.client=e,f(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var r of e)r===zn.Notify?t.notify=!0:typeof r=="object"&&(r.value===void 0&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e){var t=JSON.parse(JSON.stringify(e));return t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.underride||(t.global.underride=[]),t.global.override=Jv(Ct.Override,t.global.override,hI,fI),t.global.underride=Jv(Ct.Underride,t.global.underride,vI,gI),t}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var n of r)if(n.conditions)for(var s of n.conditions)s.kind===_t.EventMatch&&(t.delete(s.key),this.parsedKeys.set(s.key,Tr.partsForDottedKey(s.key)));t.forEach(o=>this.parsedKeys.delete(o))}matchingRuleFromKindSet(e,t){for(var r of zv){var n=t[r];if(n){for(var s of n)if(s.enabled){var o=this.templateRuleToRaw(r,s);if(o&&this.ruleMatchesEvent(o,e))return $v($v({},s),{},{kind:r})}}}return null}templateRuleToRaw(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case Ct.Underride:case Ct.Override:r.conditions=t.conditions;break;case Ct.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:_t.EventMatch,key:"room_id",value:t.rule_id});break;case Ct.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:_t.EventMatch,key:"user_id",value:t.rule_id});break;case Ct.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:_t.EventMatch,key:"content.body",pattern:t.pattern});break}return r}eventFulfillsCondition(e,t){switch(e.kind){case _t.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case _t.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case _t.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case _t.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case _t.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case _t.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case _t.CallStarted:case _t.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var r=e.key;if(!r)return!1;var n=this.client.getRoom(t.getRoomId());return n!=null&&n.currentState?n.currentState.mayTriggerNotifOfType(r,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var n=r.currentState.getJoinedMemberCount(),s=e.is.match(/^([=<>]*)(\d*)$/);if(!s)return!1;var o=s[1],a=parseInt(s[2]);if(isNaN(a))return!1;switch(o){case"":case"==":return n==a;case"<":return n<a;case">":return n>a;case"<=":return n<=a;case">=":return n>=a;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r,n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||typeof n.body!="string")return!1;var s=this.client.getRoom(t.getRoomId()),o=s==null||(r=s.currentState)===null||r===void 0?void 0:r.getMember(this.client.credentials.userId);if(!o)return!1;var a=o.name,l=new RegExp("(^|\\W)"+Sy(a)+"(\\W|$)","i");return n.body.search(l)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var r=this.valueForDottedKey(e.key,t);if(typeof r!="string")return!1;if(e.value)return e.value===r;if(typeof e.pattern!="string")return!1;var n=e.key==="content.body"?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var r=this.valueForDottedKey(e.key,t);return Array.isArray(r)?r.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||Ki(t.getPrevContent(),{}))}createCachedRegex(e,t,r){return Tr.cachedGlobToRegex[t]||(Tr.cachedGlobToRegex[t]=new RegExp(e+_y(t)+r,"i")),Tr.cachedGlobToRegex[t]}static partsForDottedKey(e){var t=[],r="",n=!1;for(var s of e){if(n){s==="\\"||s==="."?r+=s:r+="\\"+s,n=!1;continue}s=="."?(t.push(r),r=""):s=="\\"?n=!0:r+=s}return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){var r=this.parsedKeys.get(e);r===void 0&&(r=Tr.partsForDottedKey(e),this.parsedKeys.set(e,r));var n,s=r[0],o=0;for(s==="content"?(n=t.getContent(),++o):s==="type"?(n=t.getType(),++o):n=t.event;o<r.length;++o){if(by(n))return;var a=r[o];n=n[a]}return n}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};var n=Tr.actionListToActionsObject(r.actions);return n.tweaks.highlight===void 0&&(n.tweaks.highlight=r.kind==Ct.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===It.ContainsUserName||e.rule_id===It.ContainsDisplayName||e.rule_id===It.AtRoomNotification)?!1:!((r=e.conditions)!==null&&r!==void 0&&r.some(n=>!this.eventFulfillsCondition(n,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,r=this.getPushRuleAndKindById(e);return(t=r==null?void 0:r.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var r;if(((r=this.client.pushRules)===null||r===void 0?void 0:r[t])!==void 0){for(var n of zv)if(this.client.pushRules[t][n]!==void 0){for(var s of this.client.pushRules[t][n])if(s.rule_id===e)return{rule:s,kind:n}}}}return null}}f(Tr,"cachedGlobToRegex",{});var Tl=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"];Tl[0];Tl[Tl.length-1];var vr=function(i){return i.SUCCESS="SUCCESS",i.IGNORE="IGNORE",i.PROMPT="PROMPT",i.FAIL_PROMPT="FAIL_PROMPT",i.FAIL_ERROR="FAIL_ERROR",i}({}),_r=function(i){return i.Invalid="Invalid homeserver discovery response",i.GenericFailure="Failed to get autodiscovery configuration from server",i.InvalidHsBaseUrl="Invalid base_url for m.homeserver",i.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",i.InvalidIsBaseUrl="Invalid base_url for m.identity_server",i.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",i.InvalidIs="Invalid identity server discovery response",i.MissingWellknown="No .well-known JSON file found",i.InvalidJson="Invalid JSON",i.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",i}({});class ke{static fromDiscoveryConfig(e){var t=this;return S(function*(){var r,n={"m.homeserver":{state:ke.FAIL_ERROR,error:ke.ERROR_INVALID,base_url:null},"m.identity_server":{state:ke.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return p.error("No m.homeserver key in config"),n["m.homeserver"].state=ke.FAIL_PROMPT,n["m.homeserver"].error=ke.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"].base_url)return p.error("No m.homeserver base_url in config"),n["m.homeserver"].state=ke.FAIL_PROMPT,n["m.homeserver"].error=ke.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var s=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!s)return p.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=ke.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var o=yield t.fetchWellKnownObject("".concat(s,"/_matrix/client/versions"));if(!o||!Array.isArray((r=o.raw)===null||r===void 0?void 0:r.versions))return p.error("Invalid /versions response"),n["m.homeserver"].error=ke.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=s,Promise.resolve(n);var a=new Set(o.raw.versions),l=!1;for(var u of Tl)if(a.has(u)){l=!0;break}if(!l)return p.error("Homeserver does not meet version requirements"),n["m.homeserver"].error=ke.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,n["m.homeserver"].base_url=s,Promise.resolve(n);n["m.homeserver"]={state:ke.SUCCESS,error:null,base_url:s};var c="";if(e["m.identity_server"]){var d={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:ke.FAIL_PROMPT,error:ke.ERROR_INVALID_IS,base_url:null}};if(c=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!c)return p.error("Invalid base_url for m.identity_server"),d["m.identity_server"].error=ke.ERROR_INVALID_IS_BASE_URL,Promise.resolve(d);var h=yield t.fetchWellKnownObject("".concat(c,"/_matrix/identity/v2"));if(!(h!=null&&h.raw)||h.action!==vr.SUCCESS)return p.error("Invalid /v2 response"),d["m.identity_server"].error=ke.ERROR_INVALID_IDENTITY_SERVER,d["m.identity_server"].base_url=c,Promise.resolve(d)}return c&&c.toString().length>0&&(n["m.identity_server"]={state:ke.SUCCESS,error:null,base_url:c}),Object.keys(e).forEach(g=>{if(g==="m.homeserver"||g==="m.identity_server"){var v=["error","state","base_url"];for(var m of Object.keys(e[g]))v.includes(m)||(n[g][m]=e[g][m])}else n[g]=e[g]}),Promise.resolve(n)})()}static findClientConfig(e){var t=this;return S(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var r={"m.homeserver":{state:ke.FAIL_ERROR,error:ke.ERROR_INVALID,base_url:null},"m.identity_server":{state:ke.PROMPT,error:null,base_url:null}},n=e.includes("://")?e:"https://".concat(e),s=yield t.fetchWellKnownObject("".concat(n,"/.well-known/matrix/client"));return!s||s.action!==vr.SUCCESS?(p.error("No response or error when parsing .well-known"),s.reason&&p.error(s.reason),s.action===vr.IGNORE?r["m.homeserver"]={state:ke.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=ke.FAIL_PROMPT,r["m.homeserver"].error=ke.ERROR_INVALID),Promise.resolve(r)):ke.fromDiscoveryConfig(s.raw)})()}static getRawClientConfig(e){var t=this;return S(function*(){var r;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return n?(r=n.raw)!==null&&r!==void 0?r:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,r;try{r=new URL(e)}catch(a){p.error("Could not parse url",a)}if(!((t=r)!==null&&t!==void 0&&t.hostname)||r.protocol!=="http:"&&r.protocol!=="https:")return!1;var n=r.port?":".concat(r.port):"",s=r.pathname?r.pathname:"",o="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(s);return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(a){return p.error(a),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):global.fetch(e,t)}static setFetchFn(e){ke.fetchFn=e}static fetchWellKnownObject(e){return S(function*(){var t;try{if(t=yield ke.fetch(e,{method:z.Get,signal:Zl(5e3)}),t.status===404)return{raw:{},action:vr.IGNORE,reason:ke.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:vr.FAIL_PROMPT,reason:"General failure"}}catch(o){var r=o,n="";return typeof r=="object"&&(n=r==null?void 0:r.message),{error:r,raw:{},action:vr.FAIL_PROMPT,reason:n||"General failure"}}try{return{raw:yield t.json(),action:vr.SUCCESS}}catch(o){var s=o;return{error:s,raw:{},action:vr.FAIL_PROMPT,reason:(s==null?void 0:s.name)==="SyntaxError"?ke.ERROR_INVALID_JSON:ke.ERROR_INVALID}}})()}}f(ke,"ERROR_INVALID",_r.Invalid);f(ke,"ERROR_GENERIC_FAILURE",_r.GenericFailure);f(ke,"ERROR_INVALID_HS_BASE_URL",_r.InvalidHsBaseUrl);f(ke,"ERROR_INVALID_HOMESERVER",_r.InvalidHomeserver);f(ke,"ERROR_INVALID_IS_BASE_URL",_r.InvalidIsBaseUrl);f(ke,"ERROR_INVALID_IDENTITY_SERVER",_r.InvalidIdentityServer);f(ke,"ERROR_INVALID_IS",_r.InvalidIs);f(ke,"ERROR_MISSING_WELLKNOWN",_r.MissingWellknown);f(ke,"ERROR_INVALID_JSON",_r.InvalidJson);f(ke,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",_r.UnsupportedHomeserverSpecVersion);f(ke,"ALL_ERRORS",Object.keys(_r));f(ke,"FAIL_ERROR",vr.FAIL_ERROR);f(ke,"FAIL_PROMPT",vr.FAIL_PROMPT);f(ke,"PROMPT",vr.PROMPT);f(ke,"SUCCESS",vr.SUCCESS);f(ke,"fetchFn",void 0);var Ju,Yv;function pI(){if(Yv)return Ju;Yv=1;for(var i=/[\\\"\x00-\x1F]/g,e={},t=0;t<32;++t)e[String.fromCharCode(t)]="\\U"+("0000"+t.toString(16)).slice(-4).toUpperCase();e["\b"]="\\b",e["	"]="\\t",e[`
`]="\\n",e["\f"]="\\f",e["\r"]="\\r",e['"']='\\"',e["\\"]="\\\\";function r(a){return i.lastIndex=0,a.replace(i,function(l){return e[l]})}function n(a){switch(typeof a){case"string":return'"'+r(a)+'"';case"number":return isFinite(a)?a:"null";case"boolean":return a;case"object":return a===null?"null":Array.isArray(a)?s(a):o(a);default:throw new Error("Cannot stringify: "+typeof a)}}function s(a){for(var l="[",u="",c=0;c<a.length;++c)u+=l,l=",",u+=n(a[c]);return l!=","?"[]":u+"]"}function o(a){var l="{",u="",c=Object.keys(a);c.sort();for(var d=0;d<c.length;++d){var h=c[d];u+=l+'"'+r(h)+'":',l=",",u+=n(a[h])}return l!=","?"{}":u+"}"}return Ju={stringify:n},Ju}var mI=pI();const wn=Hl(mI);function Qv(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function yI(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Qv(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Qv(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var nu=function(i){return i.Olm="m.olm.v1.curve25519-aes-sha2",i.Megolm="m.megolm.v1.aes-sha2",i.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2",i}(nu||{}),kt=nu.Olm,nr=nu.Megolm,SI=nu.MegolmBackup;function Xn(i,e,t,r,n,s,o){return Zc.apply(this,arguments)}function Zc(){return Zc=S(function*(i,e,t,r,n,s,o){var a=s.getIdentityKey(),l=yield r.getSessionIdForDevice(a);if(l===null){p.log("[olmlib.encryptMessageForDevice] Unable to find Olm session for device "+"".concat(n,":").concat(s.deviceId));return}p.log("[olmlib.encryptMessageForDevice] Using Olm session ".concat(l," for device ")+"".concat(n,":").concat(s.deviceId));var u=yI({sender:e,sender_device:t,keys:{ed25519:r.deviceEd25519Key},recipient:n,recipient_keys:{ed25519:s.getFingerprint()}},o);i[a]=yield r.encryptMessage(a,l,JSON.stringify(u))}),Zc.apply(this,arguments)}function fS(i,e,t){return ed.apply(this,arguments)}function ed(){return ed=S(function*(i,e,t){var r=new ht(()=>[]),n=new ht(()=>new Map),s=[],o=function*(c){var d=function*(v){var m=v.deviceId,E=v.getIdentityKey();s.push(S(function*(){var R=yield i.getSessionIdForDevice(E,!0);R===null?r.getOrCreate(c).push(v):n.getOrCreate(c).set(m,{device:v,sessionId:R})})())};for(var h of l)yield*d(h)};for(var[a,l]of Object.entries(t))yield*o(a);return yield Promise.all(s),[r,n]}),ed.apply(this,arguments)}function Rn(i,e,t){return td.apply(this,arguments)}function td(){return td=S(function*(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,n=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:p,a=[],l=new Map,u=new Map;for(var c of t.values()){var d=function*(){var re=h.getIdentityKey();if(re===i.deviceCurve25519Key)return 1;i.sessionsInProgress[re]||(i.sessionsInProgress[re]=new Promise(Z=>{u.set(re,ne=>{delete i.sessionsInProgress[re],Z(ne)})}))};for(var h of c)yield*d()}for(var[g,v]of t){var m=new Map;l.set(g,m);for(var E of v){var R=E.deviceId,_=E.getIdentityKey();if(_===i.deviceCurve25519Key){o.info("Attempted to start session with ourself! Ignoring"),m.set(R,{device:E,sessionId:null});continue}var T="for ".concat(_," (").concat(g,":").concat(R,")"),b=yield i.getSessionIdForDevice(_,!!u.get(_),o),I=u.get(_);b!==null&&I&&I(),(b===null||r)&&(r?o.info("Forcing new Olm session ".concat(T)):o.info("Making new Olm session ".concat(T)),a.push([g,R])),m.set(R,{device:E,sessionId:b})}}if(a.length===0)return l;var y="signed_curve25519",C,w="one-time keys for ".concat(a.length," devices");try{o.debug("Claiming ".concat(w)),C=yield e.claimOneTimeKeys(a,y,n),o.debug("Claimed ".concat(w))}catch(X){for(var D of u.values())D();throw o.debug("Failed to claim ".concat(w),X,a),X}s&&"failures"in C&&s.push(...Object.keys(C.failures));var x=C.one_time_keys||{},G=[],oe=function*(re){var Z=x[re]||{},ne=function*(){var Q,le=we.deviceId,j=we.getIdentityKey();if(j===i.deviceCurve25519Key||(Q=l.get(re))!==null&&Q!==void 0&&(Q=Q.get(le))!==null&&Q!==void 0&&Q.sessionId&&!r)return 0;var K=Z[le]||{},N=null;for(var A in K)A.indexOf(y+":")===0&&(N=K[A]);if(!N){var M;return o.warn("No one-time keys (alg=".concat(y,") ")+"for device ".concat(re,":").concat(le)),(M=u.get(j))===null||M===void 0||M(),0}G.push(_I(i,N,re,we).then(L=>{var P,B;(P=u.get(j))===null||P===void 0||P(L??void 0);var k=(B=l.get(re))===null||B===void 0?void 0:B.get(le);k&&(k.sessionId=L)},L=>{var P;throw(P=u.get(j))===null||P===void 0||P(),L}))},ce;for(var we of Ee)ce=yield*ne()};for(var[de,Ee]of t)yield*oe(de);return w="Olm sessions for ".concat(G.length," devices"),o.debug("Starting ".concat(w)),yield Promise.all(G),o.debug("Started ".concat(w)),l}),td.apply(this,arguments)}function _I(i,e,t,r){return rd.apply(this,arguments)}function rd(){return rd=S(function*(i,e,t,r){var n=r.deviceId;try{yield Es(i,e,t,n,r.getFingerprint())}catch(o){return p.error("Unable to verify signature on one-time key for device "+t+":"+n+":",o),null}var s;try{s=yield i.createOutboundSession(r.getIdentityKey(),e.key)}catch(o){return p.error("Error starting olm session with device "+t+":"+n+": "+o),null}return p.log("Started new olm sessionid "+s+" for device "+t+":"+n),s}),rd.apply(this,arguments)}function Es(i,e,t,r,n){return nd.apply(this,arguments)}function nd(){return nd=S(function*(i,e,t,r,n){var s="ed25519:"+r,o=e.signatures||{},a=o[t]||{},l=a[s];if(!l)throw Error("No signature");var u=Object.assign({},e);"unsigned"in u&&delete u.unsigned,delete u.signatures;var c=wn.stringify(u);i.verifySignature(n,c,l)}),nd.apply(this,arguments)}function Xa(i,e,t,r){var n=!1;if(e instanceof Uint8Array){var s=new global.Olm.PkSigning;r=s.init_with_seed(e),e=s,n=!0}var o=i.signatures||{};delete i.signatures;var a=i.unsigned;i.unsigned&&delete i.unsigned;try{var l=o[t]||{};return o[t]=l,l["ed25519:"+r]=e.sign(wn.stringify(i))}finally{i.signatures=o,a&&(i.unsigned=a),n&&e.free()}}function es(i,e,t){var r="ed25519:"+e;if(!(i.signatures&&i.signatures[t]&&i.signatures[t][r]))throw new Error("No signature");var n=i.signatures[t][r],s=new global.Olm.Utility,o=i.signatures;delete i.signatures;var a=i.unsigned;i.unsigned&&delete i.unsigned;try{s.ed25519_verify(e,wn.stringify(i),n)}finally{i.signatures=o,a&&(i.unsigned=a),s.free()}}function mh(i){return i.getSenderKey()?i.getWireType()!==F.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(i.getWireContent().algorithm)?(p.error("Event was not encrypted using an appropriate algorithm"),!1):!0:(p.error("Event has no sender key (not encrypted?)"),!1)}const bI=Object.freeze(Object.defineProperty({__proto__:null,MEGOLM_ALGORITHM:nr,MEGOLM_BACKUP_ALGORITHM:SI,OLM_ALGORITHM:kt,encryptMessageForDevice:Xn,ensureOlmSessionsForDevices:Rn,getExistingOlmSessions:fS,isOlmEncrypted:mh,pkSign:Xa,pkVerify:es,verifySignature:Es},Symbol.toStringTag,{value:"Module"}));var id=function(i){return i.IS="SERVICE_TYPE_IS",i.IM="SERVICE_TYPE_IM",i}({}),ir="crypto.",Xv=ir+"migration",Yu=ir+"account",Zv=ir+"cross_signing_keys",eg=ir+"notified_error_devices",tg=ir+"device_data",Ln=ir+"inboundgroupsessions/",EI=ir+"inboundgroupsessions.withheld/",wI=ir+"rooms/",fi=ir+"sessionsneedingbackup";function vi(i){return ir+"sessions/"+i}function rg(i){return ir+"session.problems/"+i}function Na(i,e){return Ln+i+"/"+e}function ng(i,e){return EI+i+"/"+e}function ig(i){return wI+i}class iu extends Yl{static exists(e){for(var t=e.length,r=0;r<t;r++){var n;if((n=e.key(r))!==null&&n!==void 0&&n.startsWith(ir))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return S(function*(){return iu.exists(e.store)})()}getMigrationState(){var e=this;return S(function*(){var t;return(t=ft(e.store,Xv))!==null&&t!==void 0?t:_s.NOT_STARTED})()}setMigrationState(e){var t=this;return S(function*(){tr(t.store,Xv,e)})()}countEndToEndSessions(e,t){for(var r=0,n=0;n<this.store.length;++n){var s=this.store.key(n);if(s!=null&&s.startsWith(vi(""))){var o=ft(this.store,s);r+=Object.keys(o??{}).length}}t(r)}_getEndToEndSessions(e){var t=ft(this.store,vi(e)),r={};for(var[n,s]of Object.entries(t||{}))typeof s=="string"?r[n]={session:s}:r[n]=s;return r}getEndToEndSession(e,t,r,n){var s=this._getEndToEndSessions(e);n(s[t]||{})}getEndToEndSessions(e,t,r){r(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(var r=0;r<this.store.length;++r){var n;if((n=this.store.key(r))!==null&&n!==void 0&&n.startsWith(vi(""))){var s=this.store.key(r).split("/")[1];for(var o of Object.values(this._getEndToEndSessions(s)))t(o)}}}storeEndToEndSession(e,t,r,n){var s=this._getEndToEndSessions(e)||{};s[t]=r,tr(this.store,vi(e),s)}storeEndToEndSessionProblem(e,t,r){var n=this;return S(function*(){var s=rg(e),o=ft(n.store,s)||[];o.push({type:t,fixed:r,time:Date.now()}),o.sort((a,l)=>a.time-l.time),tr(n.store,s,o)})()}getEndToEndSessionProblem(e,t){var r=this;return S(function*(){var n=rg(e),s=ft(r.store,n)||[];if(!s.length)return null;var o=s[s.length-1];for(var a of s)if(a.time>t)return Object.assign({},a,{fixed:o.fixed});return o.fixed?null:o})()}filterOutNotifiedErrorDevices(e){var t=this;return S(function*(){var r=ft(t.store,eg)||{},n=[];for(var s of e){var{userId:o,deviceInfo:a}=s;o in r?a.deviceId in r[o]||(n.push(s),Xr(r[o],a.deviceId,!0)):(n.push(s),Xr(r,o,{[a.deviceId]:!0}))}return tr(t.store,eg,r),n})()}getEndToEndSessionsBatch(){var e=this;return S(function*(){for(var t=[],r=0;r<e.store.length;++r){var n;if((n=e.store.key(r))!==null&&n!==void 0&&n.startsWith(vi(""))){var s=e.store.key(r).split("/")[1];for(var o of Object.values(e._getEndToEndSessions(s)))if(t.push(o),t.length>=bs)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return S(function*(){for(var{deviceKey:r,sessionId:n}of e){var s=t._getEndToEndSessions(r)||{};delete s[n],Object.keys(s).length===0?t.store.removeItem(vi(r)):tr(t.store,vi(r),s)}})()}getEndToEndInboundGroupSession(e,t,r,n){n(ft(this.store,Na(e,t)),ft(this.store,ng(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(var r=0;r<this.store.length;++r){var n=this.store.key(r);n!=null&&n.startsWith(Ln)&&t({senderKey:n.slice(Ln.length,Ln.length+43),sessionId:n.slice(Ln.length+44),sessionData:ft(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,r,n){var s=ft(this.store,Na(e,t));s||this.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){tr(this.store,Na(e,t),r)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){tr(this.store,ng(e,t),r)}countEndToEndInboundGroupSessions(){var e=this;return S(function*(){for(var t=0,r=0;r<e.store.length;++r){var n=e.store.key(r);n!=null&&n.startsWith(Ln)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return S(function*(){for(var t=ft(e.store,fi)||{},r=[],n=0;n<e.store.length;++n){var s=e.store.key(n);if(s!=null&&s.startsWith(Ln)){var o=s.slice(Ln.length);if(r.push({senderKey:o.slice(0,43),sessionId:o.slice(44),sessionData:ft(e.store,s),needsBackup:o in t}),r.length>=bs)return r}}return r.length===0?null:r})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return S(function*(){for(var{senderKey:r,sessionId:n}of e){var s=Na(r,n);t.store.removeItem(s)}})()}getEndToEndDeviceData(e,t){t(ft(this.store,tg))}storeEndToEndDeviceData(e,t){tr(this.store,tg,e)}storeEndToEndRoom(e,t,r){tr(this.store,ig(e),t)}getEndToEndRooms(e,t){for(var r={},n=ig(""),s=0;s<this.store.length;++s){var o=this.store.key(s);if(o!=null&&o.startsWith(n)){var a=o.slice(n.length);r[a]=ft(this.store,o)}}t(r)}getSessionsNeedingBackup(e){var t=this,r=ft(this.store,fi)||{},n=[],s=function(){if(Object.prototype.hasOwnProperty.call(r,o)){var l=o.slice(0,43),u=o.slice(44);if(t.getEndToEndInboundGroupSession(l,u,null,c=>{n.push({senderKey:l,sessionId:u,sessionData:c})}),e&&n.length>=e)return 1}};for(var o in r)if(s())break;return Promise.resolve(n)}countSessionsNeedingBackup(){var e=ft(this.store,fi)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){var t=ft(this.store,fi)||{};for(var r of e)delete t[r.senderKey+"/"+r.sessionId];return tr(this.store,fi,t),Promise.resolve()}markSessionsNeedingBackup(e){var t=ft(this.store,fi)||{};for(var r of e)t[r.senderKey+"/"+r.sessionId]=!0;return tr(this.store,fi,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(Yu),Promise.resolve()}getAccount(e,t){var r=ft(this.store,Yu);t(r)}storeAccount(e,t){tr(this.store,Yu,t)}getCrossSigningKeys(e,t){var r=ft(this.store,Zv);t(r)}getSecretStorePrivateKey(e,t,r){var n=ft(this.store,ir+"ssss_cache.".concat(r));t(n)}storeCrossSigningKeys(e,t){tr(this.store,Zv,t)}storeSecretStorePrivateKey(e,t,r){tr(this.store,ir+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function ft(i,e){try{return JSON.parse(i.getItem(e))}catch(t){p.log("Error: Failed to get key %s: %s",e,t.message),p.log(t.stack)}return null}function tr(i,e,t){i.setItem(e,JSON.stringify(t))}class RI{constructor(e){this.db=e,f(this,"nextTxnId",0),e.onversionchange=()=>{p.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return S(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return S(function*(){return e})()}deleteAllData(){return S(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return S(function*(){var t=_s.NOT_STARTED;return yield e.doTxn("readonly",[fe.STORE_ACCOUNT],r=>{var n=r.objectStore(fe.STORE_ACCOUNT),s=n.get(Dc);s.onsuccess=()=>{var o;t=(o=s.result)!==null&&o!==void 0?o:_s.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return S(function*(){yield t.doTxn("readwrite",[fe.STORE_ACCOUNT],r=>{var n=r.objectStore(fe.STORE_ACCOUNT);n.put(e,Dc)})})()}getOrAddOutgoingRoomKeyRequest(e){var t=e.requestBody;return new Promise((r,n)=>{var s=this.db.transaction("outgoingRoomKeyRequests","readwrite");s.onerror=n,this._getOutgoingRoomKeyRequest(s,t,o=>{if(o){p.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),r(o);return}p.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),s.oncomplete=()=>{r(e)};var a=s.objectStore("outgoingRoomKeyRequests");a.add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,r)=>{var n=this.db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=r,this._getOutgoingRoomKeyRequest(n,e,s=>{t(s)})})}_getOutgoingRoomKeyRequest(e,t,r){var n=e.objectStore("outgoingRoomKeyRequests"),s=n.index("session"),o=s.openCursor([t.room_id,t.session_id]);o.onsuccess=()=>{var a=o.result;if(!a){r(null);return}var l=a.value;if(Ki(l.requestBody,t)){r(l);return}a.continue()}}getOutgoingRoomKeyRequestByState(e){if(e.length===0)return Promise.resolve(null);var t=0,r;function n(){var u=this.result;if(u){r=u.value;return}if(t++,!(t>=e.length)){var c=e[t],d=this.source.openCursor(c);d.onsuccess=n}}var s=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=s.objectStore("outgoingRoomKeyRequests"),a=e[t],l=o.index("state").openCursor(a);return l.onsuccess=n,gi(s).then(()=>r)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,r)=>{var n=this.db.transaction("outgoingRoomKeyRequests","readonly"),s=n.objectStore("outgoingRoomKeyRequests"),o=s.index("state"),a=o.getAll(e);a.onsuccess=()=>t(a.result),a.onerror=()=>r(a.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,r){var n=0,s=[];function o(){var d=this.result;if(d){var h=d.value;h.recipients.some(m=>m.userId===e&&m.deviceId===t)&&s.push(h),d.continue()}else{if(n++,n>=r.length)return;var g=r[n],v=this.source.openCursor(g);v.onsuccess=o}}var a=this.db.transaction("outgoingRoomKeyRequests","readonly"),l=a.objectStore("outgoingRoomKeyRequests"),u=r[n],c=l.index("state").openCursor(u);return c.onsuccess=o,gi(a).then(()=>s)}updateOutgoingRoomKeyRequest(e,t,r){var n=null;function s(){var l=this.result;if(l){var u=l.value;if(u.state!=t){p.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(u.state));return}Object.assign(u,r),l.update(u),n=u}}var o=this.db.transaction("outgoingRoomKeyRequests","readwrite"),a=o.objectStore("outgoingRoomKeyRequests").openCursor(e);return a.onsuccess=s,gi(o).then(()=>n)}deleteOutgoingRoomKeyRequest(e,t){var r=this.db.transaction("outgoingRoomKeyRequests","readwrite"),n=r.objectStore("outgoingRoomKeyRequests").openCursor(e);return n.onsuccess=()=>{var s=n.result;if(s){var o=s.value;if(o.state!=t){p.warn("Cannot delete room key request in state ".concat(o.state," ")+"(expected ".concat(t,")"));return}s.delete()}},gi(r)}getAccount(e,t){var r=e.objectStore("account"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(s){Rt(e,s)}}}storeAccount(e,t){var r=e.objectStore("account");r.put(t,"-")}getCrossSigningKeys(e,t){var r=e.objectStore("account"),n=r.get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(s){Rt(e,s)}}}getSecretStorePrivateKey(e,t,r){var n=e.objectStore("account"),s=n.get("ssss_cache:".concat(r));s.onsuccess=function(){try{t(s.result||null)}catch(o){Rt(e,o)}}}storeCrossSigningKeys(e,t){var r=e.objectStore("account");r.put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,r){var n=e.objectStore("account");n.put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.count();n.onsuccess=function(){try{t(n.result)}catch(s){Rt(e,s)}}}getEndToEndSessions(e,t,r){var n=t.objectStore("sessions"),s=n.index("deviceKey"),o=s.openCursor(e),a={};o.onsuccess=function(){var l=o.result;if(l)a[l.value.sessionId]={session:l.value.session,lastReceivedMessageTs:l.value.lastReceivedMessageTs},l.continue();else try{r(a)}catch(u){Rt(t,u)}}}getEndToEndSession(e,t,r,n){var s=r.objectStore("sessions"),o=s.get([e,t]);o.onsuccess=function(){try{o.result?n({session:o.result.session,lastReceivedMessageTs:o.result.lastReceivedMessageTs}):n(null)}catch(a){Rt(r,a)}}}getAllEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.openCursor();n.onsuccess=function(){try{var s=n.result;s?(t(s.value),s.continue()):t(null)}catch(o){Rt(e,o)}}}storeEndToEndSession(e,t,r,n){var s=n.objectStore("sessions");s.put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}storeEndToEndSessionProblem(e,t,r){var n=this;return S(function*(){var s=n.db.transaction("session_problems","readwrite"),o=s.objectStore("session_problems");o.put({deviceKey:e,type:t,fixed:r,time:Date.now()}),yield gi(s)})()}getEndToEndSessionProblem(e,t){var r=this;return S(function*(){var n=null,s=r.db.transaction("session_problems","readwrite"),o=s.objectStore("session_problems"),a=o.index("deviceKey"),l=a.getAll(e);return l.onsuccess=()=>{var u=l.result;if(!u.length){n=null;return}u.sort((h,g)=>h.time-g.time);var c=u[u.length-1];for(var d of u)if(d.time>t){n=Object.assign({},d,{fixed:c.fixed});return}c.fixed?n=null:n=c},yield gi(s),n})()}filterOutNotifiedErrorDevices(e){var t=this;return S(function*(){var r=t.db.transaction("notified_error_devices","readwrite"),n=r.objectStore("notified_error_devices"),s=[];return yield Promise.all(e.map(o=>new Promise(a=>{var{userId:l,deviceInfo:u}=o,c=n.get([l,u.deviceId]);c.onsuccess=function(){c.result||(n.put({userId:l,deviceId:u.deviceId}),s.push(o)),a()}}))),s})()}getEndToEndSessionsBatch(){var e=this;return S(function*(){var t=[];return yield e.doTxn("readonly",[fe.STORE_SESSIONS],r=>{var n=r.objectStore(fe.STORE_SESSIONS),s=n.openCursor();s.onsuccess=function(){try{var o=s.result;o&&(t.push(o.value),t.length<bs&&o.continue())}catch(a){Rt(r,a)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return S(function*(){yield t.doTxn("readwrite",[fe.STORE_SESSIONS],function(){var r=S(function*(n){try{var s=n.objectStore(fe.STORE_SESSIONS),o=function*(){var c=s.delete([a,l]);yield new Promise(d=>{c.onsuccess=d})};for(var{deviceKey:a,sessionId:l}of e)yield*o()}catch(u){Rt(n,u)}});return function(n){return r.apply(this,arguments)}}())})()}getEndToEndInboundGroupSession(e,t,r,n){var s=!1,o=!1,a=r.objectStore("inbound_group_sessions"),l=a.get([e,t]);l.onsuccess=function(){try{l.result?s=l.result.session:s=null,o!==!1&&n(s,o)}catch(d){Rt(r,d)}};var u=r.objectStore("inbound_group_sessions_withheld"),c=u.get([e,t]);c.onsuccess=function(){try{c.result?o=c.result.session:o=null,s!==!1&&n(s,o)}catch(d){Rt(r,d)}}}getAllEndToEndInboundGroupSessions(e,t){var r=e.objectStore("inbound_group_sessions"),n=r.openCursor();n.onsuccess=function(){var s=n.result;if(s){try{t({senderKey:s.value.senderCurve25519Key,sessionId:s.value.sessionId,sessionData:s.value.session})}catch(o){Rt(e,o)}s.continue()}else try{t(null)}catch(o){Rt(e,o)}}}addEndToEndInboundGroupSession(e,t,r,n){var s=n.objectStore("inbound_group_sessions"),o=s.add({senderCurve25519Key:e,sessionId:t,session:r});o.onerror=a=>{var l;((l=o.error)===null||l===void 0?void 0:l.name)==="ConstraintError"?(a.stopPropagation(),a.preventDefault(),p.log("Ignoring duplicate inbound group session: "+e+" / "+t)):Rt(n,new Error("Failed to add inbound group session: "+o.error))}}storeEndToEndInboundGroupSession(e,t,r,n){var s=n.objectStore("inbound_group_sessions");s.put({senderCurve25519Key:e,sessionId:t,session:r})}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){var s=n.objectStore("inbound_group_sessions_withheld");s.put({senderCurve25519Key:e,sessionId:t,session:r})}countEndToEndInboundGroupSessions(){var e=this;return S(function*(){var t=0;return yield e.doTxn("readonly",[fe.STORE_INBOUND_GROUP_SESSIONS],r=>{var n=r.objectStore(fe.STORE_INBOUND_GROUP_SESSIONS),s=n.count();s.onsuccess=()=>{t=s.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return S(function*(){var t=[];return yield e.doTxn("readonly",[fe.STORE_INBOUND_GROUP_SESSIONS,fe.STORE_BACKUP],r=>{var n=r.objectStore(fe.STORE_INBOUND_GROUP_SESSIONS),s=r.objectStore(fe.STORE_BACKUP),o=n.openCursor();o.onsuccess=function(){try{var a=o.result;if(a){var l=s.get(a.key);l.onsuccess=()=>{t.push({senderKey:a.value.senderCurve25519Key,sessionId:a.value.sessionId,sessionData:a.value.session,needsBackup:l.result!==void 0}),t.length<bs&&a.continue()}}}catch(u){Rt(r,u)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return S(function*(){yield t.doTxn("readwrite",[fe.STORE_INBOUND_GROUP_SESSIONS],function(){var r=S(function*(n){try{var s=n.objectStore(fe.STORE_INBOUND_GROUP_SESSIONS),o=function*(){var c=s.delete([a,l]);yield new Promise(d=>{c.onsuccess=d})};for(var{senderKey:a,sessionId:l}of e)yield*o()}catch(u){Rt(n,u)}});return function(n){return r.apply(this,arguments)}}())})()}getEndToEndDeviceData(e,t){var r=e.objectStore("device_data"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(s){Rt(e,s)}}}storeEndToEndDeviceData(e,t){var r=t.objectStore("device_data");r.put(e,"-")}storeEndToEndRoom(e,t,r){var n=r.objectStore("rooms");n.put(t,e)}getEndToEndRooms(e,t){var r={},n=e.objectStore("rooms"),s=n.openCursor();s.onsuccess=function(){var o=s.result;if(o)r[o.key]=o.value,o.continue();else try{t(r)}catch(a){Rt(e,a)}}}getSessionsNeedingBackup(e){return new Promise((t,r)=>{var n=[],s=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");s.onerror=r,s.oncomplete=function(){t(n)};var o=s.objectStore("sessions_needing_backup"),a=s.objectStore("inbound_group_sessions"),l=o.openCursor();l.onsuccess=function(){var u=l.result;if(u){var c=a.get(u.key);c.onsuccess=function(){n.push({senderKey:c.result.senderCurve25519Key,sessionId:c.result.sessionId,sessionData:c.result.session})},(!e||n.length<e)&&u.continue()}}})}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));var t=e.objectStore("sessions_needing_backup");return new Promise((r,n)=>{var s=t.count();s.onerror=n,s.onsuccess=()=>r(s.result)})}unmarkSessionsNeedingBackup(e,t){var r=this;return S(function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(s=>new Promise((o,a)=>{var l=n.delete([s.senderKey,s.sessionId]);l.onsuccess=o,l.onerror=a})))})()}markSessionsNeedingBackup(e,t){var r=this;return S(function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(s=>new Promise((o,a)=>{var l=n.put({senderCurve25519Key:s.senderKey,sessionId:s.sessionId});l.onsuccess=o,l.onerror=a})))})()}addSharedHistoryInboundGroupSession(e,t,r,n){n||(n=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));var s=n.objectStore("shared_history_inbound_group_sessions"),o=s.get([e]);o.onsuccess=()=>{var{sessions:a}=o.result||{sessions:[]};a.push([t,r]),s.put({roomId:e,sessions:a})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));var r=t.objectStore("shared_history_inbound_group_sessions"),n=r.get([e]);return new Promise((s,o)=>{n.onsuccess=()=>{var{sessions:a}=n.result||{sessions:[]};s(a)},n.onerror=o})}addParkedSharedHistory(e,t,r){r||(r=this.db.transaction("parked_shared_history","readwrite"));var n=r.objectStore("parked_shared_history"),s=n.get([e]);s.onsuccess=()=>{var{parked:o}=s.result||{parked:[]};o.push(t),n.put({roomId:e,parked:o})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));var r=t.objectStore("parked_shared_history").openCursor(e);return new Promise((n,s)=>{r.onsuccess=()=>{var o=r.result;if(!o){n([]);return}var a=o.value;o.delete(),n(a)},r.onerror=s})}doTxn(e,t,r){var n=this.db.transaction(t,e),s=gi(n),o=r(n);return s.then(()=>o)}}var vS=[i=>{II(i)},i=>{i.createObjectStore("account")},i=>{var e=i.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},i=>{i.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("device_data")},i=>{i.createObjectStore("rooms")},i=>{i.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{var e=i.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),i.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},i=>{i.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},i=>{i.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],gS=vS.length;function TI(i,e){p.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(gS)),vS.forEach((t,r)=>{e<=r&&t(i)})}function II(i){var e=i.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function Rt(i,e){i._mx_abortexception=e;try{i.abort()}catch{}}function gi(i){return new Promise((e,t)=>{i.oncomplete=()=>{i._mx_abortexception!==void 0&&t(i._mx_abortexception),e(null)},i.onerror=r=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(p.log("Error performing indexeddb txn",r),t(i.error))},i.onabort=r=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(p.log("Error performing indexeddb txn",r),t(i.error))}})}var yh=function(i){return i.TooNew="TOO_NEW",i}({});class Sh extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}f(Sh,"TOO_NEW",yh.TooNew);class wo extends Error{constructor(e,t){super(e),this.value=t}}class CI extends Error{constructor(){super("MatrixClient has been stopped")}}function pS(i,e){return new Promise((t,r)=>{var n=!0,s=i.open(e);s.onupgradeneeded=()=>{n=!1},s.onblocked=()=>r(s.error),s.onsuccess=()=>{var o=s.result;o.close(),n||i.deleteDatabase(e),t(n)},s.onerror=()=>r(s.error)})}class fe{static exists(e,t){return pS(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((r,n)=>{var s=!0,o=e.open(t);o.onupgradeneeded=()=>{s=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{var a=o.result;if(!s)a.close(),e.deleteDatabase(t),r(!1);else{var l=a.transaction([fe.STORE_ACCOUNT],"readonly"),u=l.objectStore(fe.STORE_ACCOUNT),c=u.get(Dc);c.onsuccess=()=>{var d,h=(d=c.result)!==null&&d!==void 0?d:_s.NOT_STARTED;r(h===_s.NOT_STARTED)},c.onerror=()=>{n(c.error)},a.close()}},o.onerror=()=>n(o.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,f(this,"backendPromise",void 0),f(this,"backend",void 0)}containsData(){var e=this;return S(function*(){return fe.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}p.log("connecting to indexeddb ".concat(this.dbName));var r=this.indexedDB.open(this.dbName,gS);r.onupgradeneeded=n=>{var s=r.result,o=n.oldVersion;TI(s,o)},r.onblocked=()=>{p.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{p.log("Error connecting to indexeddb",n),t(r.error)},r.onsuccess=()=>{var n=r.result;p.log("connected to indexeddb ".concat(this.dbName)),e(new RI(n))}}).then(e=>e.doTxn("readonly",[fe.STORE_INBOUND_GROUP_SESSIONS,fe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw p.warn("Crypto DB is too new for us to use!",e),new Sh(yh.TooNew);p.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{return new iu(global.localStorage)}catch(t){return p.warn("unable to open localStorage: falling back to in-memory store: ".concat(t)),new Yl}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}p.log("Removing indexeddb instance: ".concat(this.dbName));var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{p.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{p.log("Error deleting data from indexeddb",n),t(r.error)},r.onsuccess=()=>{p.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{p.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,r){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,r)}updateOutgoingRoomKeyRequest(e,t,r){return this.backend.updateOutgoingRoomKeyRequest(e,t,r)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}storeEndToEndSessionProblem(e,t,r){return this.backend.storeEndToEndSessionProblem(e,t,r)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,r,n){this.backend.addEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,r){this.backend.storeEndToEndRoom(e,t,r)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,r,n){this.backend.addSharedHistoryInboundGroupSession(e,t,r,n)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,r){this.backend.addParkedSharedHistory(e,t,r)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}}f(fe,"STORE_ACCOUNT","account");f(fe,"STORE_SESSIONS","sessions");f(fe,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");f(fe,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");f(fe,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");f(fe,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");f(fe,"STORE_DEVICE_DATA","device_data");f(fe,"STORE_ROOMS","rooms");f(fe,"STORE_BACKUP","sessions_needing_backup");var Ti=function(i){return i.Change="change",i}({}),ii=function(i){return i[i.Unsent=1]="Unsent",i[i.Requested=2]="Requested",i[i.Ready=3]="Ready",i[i.Started=4]="Started",i[i.Cancelled=5]="Cancelled",i[i.Done=6]="Done",i}({}),su=function(i){return i.Cancel="cancel",i.ShowSas="show_sas",i.ShowReciprocateQr="show_reciprocate_qr",i}({});function mS(i){return i.phase<ii.Ready&&!i.accepting&&!i.declining}var bt=function(i){return i.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",i.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",i.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",i.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",i.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",i.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",i.UNKNOWN_ERROR="UNKNOWN_ERROR",i.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",i.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",i.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",i.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",i.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",i.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",i.OLM_BAD_ROOM="OLM_BAD_ROOM",i.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",i.OLM_BAD_SENDER="OLM_BAD_SENDER",i.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",i.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",i.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",i.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",i}({});class jo{constructor(e,t,r){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class yS{constructor(e){var t,r,n,s,o;f(this,"signedByOwner",void 0),f(this,"crossSigningVerified",void 0),f(this,"tofu",void 0),f(this,"localVerified",void 0),f(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(r=e.crossSigningVerified)!==null&&r!==void 0?r:!1,this.tofu=(n=e.tofu)!==null&&n!==void 0?n:!1,this.localVerified=(s=e.localVerified)!==null&&s!==void 0?s:!1,this.trustCrossSignedDevices=(o=e.trustCrossSignedDevices)!==null&&o!==void 0?o:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var _h=function(i){return i.Master="master",i.SelfSigning="self_signing",i.UserSigning="user_signing",i}({}),Nn=function(i){return i[i.NONE=0]="NONE",i[i.GREY=1]="GREY",i[i.RED=2]="RED",i}({}),ts=function(i){return i[i.UNKNOWN=0]="UNKNOWN",i[i.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",i[i.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",i[i.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",i[i.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",i[i.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",i}({});const kI=Object.freeze(Object.defineProperty({__proto__:null,CrossSigningKey:_h,DecryptionFailureCode:bt,DeviceVerificationStatus:yS,EventShieldColour:Nn,EventShieldReason:ts,UserVerificationStatus:jo,VerificationPhase:ii,VerificationRequestEvent:Ti,VerifierEvent:su,canAcceptVerificationRequest:mS},Symbol.toStringTag,{value:"Module"}));class wt extends Error{constructor(e,t,r){super(t),this.code=e,f(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=OI(this,r)}}function OI(i,e){var t=i.name+"[msg: "+i.message;return e&&(t+=", "+Object.keys(e).map(r=>r+": "+e[r]).join(", ")),t+="]",t}var sg=65536*3/4;class PI extends Error{constructor(){super(...arguments),f(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function og(i){if(i===void 0)throw new Error("payloadString undefined");if(i.length>sg)throw new PI("Message too long (".concat(i.length," bytes). ")+"The maximum for an encrypted message is ".concat(sg," bytes."))}class ag{constructor(e){this.cryptoStore=e,f(this,"pickleKey","DEFAULT_KEY"),f(this,"deviceCurve25519Key",null),f(this,"deviceEd25519Key",null),f(this,"maxOneTimeKeys",null),f(this,"outboundGroupSessionStore",{}),f(this,"inboundGroupSessionMessageIndexes",{}),f(this,"sessionsInProgress",{}),f(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return global.Olm.get_library_version()}init(){var e=arguments,t=this;return S(function*(){var{pickleKey:r,fromExportedDevice:n}=e.length>0&&e[0]!==void 0?e[0]:{},s,o=new global.Olm.Account;try{n?(r&&p.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),t.pickleKey=n.pickleKey,yield t.initialiseFromExportedDevice(n,o)):(r&&(t.pickleKey=r),yield t.initialiseAccount(o)),s=JSON.parse(o.identity_keys()),t.maxOneTimeKeys=o.max_number_of_one_time_keys()}finally{o.free()}t.deviceCurve25519Key=s.curve25519,t.deviceEd25519Key=s.ed25519})()}initialiseFromExportedDevice(e,t){var r=this;return S(function*(){yield r.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT,fe.STORE_SESSIONS],n=>{r.cryptoStore.storeAccount(n,e.pickledAccount),e.sessions.forEach(s=>{var{deviceKey:o,sessionId:a}=s,l={session:s.session,lastReceivedMessageTs:s.lastReceivedMessageTs};r.cryptoStore.storeEndToEndSession(o,a,l,n)})}),t.unpickle(r.pickleKey,e.pickledAccount)})()}initialiseAccount(e){var t=this;return S(function*(){yield t.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],r=>{t.cryptoStore.getAccount(r,n=>{n!==null?e.unpickle(t.pickleKey,n):(e.create(),n=e.pickle(t.pickleKey),t.cryptoStore.storeAccount(r,n))})})})()}getAccount(e,t){this.cryptoStore.getAccount(e,r=>{var n=new global.Olm.Account;try{n.unpickle(this.pickleKey,r),t(n)}finally{n.free()}})}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}export(){var e=this;return S(function*(){var t={pickleKey:e.pickleKey};return yield e.cryptoStore.doTxn("readonly",[fe.STORE_ACCOUNT,fe.STORE_SESSIONS],r=>{e.cryptoStore.getAccount(r,n=>{t.pickledAccount=n}),t.sessions=[],e.cryptoStore.getAllEndToEndSessions(r,n=>{t.sessions.push(n)})}),t})()}getSession(e,t,r,n){this.cryptoStore.getEndToEndSession(e,t,r,s=>{this.unpickleSession(s,n)})}unpickleSession(e,t){var r=new global.Olm.Session;try{r.unpickle(this.pickleKey,e.session);var n=Object.assign({},e,{session:r});t(n)}finally{r.free()}}saveSession(e,t,r){var n=t.session.session_id();p.debug("Saving Olm session ".concat(n," with device ").concat(e,": ").concat(t.session.describe()));var s=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,n,s,r)}getUtility(e){var t=new global.Olm.Utility;try{return e(t)}finally{t.free()}}sign(e){var t=this;return S(function*(){var r;return yield t.cryptoStore.doTxn("readonly",[fe.STORE_ACCOUNT],n=>{t.getAccount(n,s=>{r=s.sign(e)})}),r})()}getOneTimeKeys(){var e=this;return S(function*(){var t;return yield e.cryptoStore.doTxn("readonly",[fe.STORE_ACCOUNT],r=>{e.getAccount(r,n=>{t=JSON.parse(n.one_time_keys())})}),t})()}maxNumberOfOneTimeKeys(){var e;return(e=this.maxOneTimeKeys)!==null&&e!==void 0?e:-1}markKeysAsPublished(){var e=this;return S(function*(){yield e.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],t=>{e.getAccount(t,r=>{r.mark_keys_as_published(),e.storeAccount(t,r)})})})()}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],t=>{this.getAccount(t,r=>{r.generate_one_time_keys(e),this.storeAccount(t,r)})})}generateFallbackKey(){var e=this;return S(function*(){yield e.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],t=>{e.getAccount(t,r=>{r.generate_fallback_key(),e.storeAccount(t,r)})})})()}getFallbackKey(){var e=this;return S(function*(){var t;return yield e.cryptoStore.doTxn("readonly",[fe.STORE_ACCOUNT],r=>{e.getAccount(r,n=>{t=JSON.parse(n.unpublished_fallback_key())})}),t})()}forgetOldFallbackKey(){var e=this;return S(function*(){yield e.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],t=>{e.getAccount(t,r=>{r.forget_old_fallback_key(),e.storeAccount(t,r)})})})()}createOutboundSession(e,t){var r=this;return S(function*(){var n;return yield r.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT,fe.STORE_SESSIONS],s=>{r.getAccount(s,o=>{var a=new global.Olm.Session;try{a.create_outbound(o,e,t),n=a.session_id(),r.storeAccount(s,o);var l={session:a,lastReceivedMessageTs:Date.now()};r.saveSession(e,l,s)}finally{a.free()}})},p.getChild("[createOutboundSession]")),n})()}createInboundSession(e,t,r){var n=this;return S(function*(){if(t!==0)throw new Error("Need messageType == 0 to create inbound session");var s;return yield n.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT,fe.STORE_SESSIONS],o=>{n.getAccount(o,a=>{var l=new global.Olm.Session;try{l.create_inbound_from(a,e,r),a.remove_one_time_keys(l),n.storeAccount(o,a);var u=l.decrypt(t,r),c={session:l,lastReceivedMessageTs:Date.now()};n.saveSession(e,c,o),s={payload:u,session_id:l.session_id()}}finally{l.free()}})},p.getChild("[createInboundSession]")),s})()}getSessionIdsForDevice(e){var t=this;return S(function*(){var r=p.getChild("[getSessionIdsForDevice]");if(e in t.sessionsInProgress){r.debug("Waiting for Olm session for ".concat(e," to be created"));try{yield t.sessionsInProgress[e]}catch{}}var n;return yield t.cryptoStore.doTxn("readonly",[fe.STORE_SESSIONS],s=>{t.cryptoStore.getEndToEndSessions(e,s,o=>{n=Object.keys(o)})},r),n})()}getSessionIdForDevice(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2?t[2]:void 0,o=yield r.getSessionInfoForDevice(e,n,s);if(o.length===0)return null;for(var a=0,l=1;l<o.length;l++){var u=o[l],c=u.lastReceivedMessageTs===void 0?0:u.lastReceivedMessageTs,d=o[a],h=d.lastReceivedMessageTs===void 0?0:d.lastReceivedMessageTs;(c>h||c===h&&u.sessionId<d.sessionId)&&(a=l)}return o[a].sessionId})()}getSessionInfoForDevice(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2&&t[2]!==void 0?t[2]:p;if(s=s.getChild("[getSessionInfoForDevice]"),e in r.sessionsInProgress&&!n){s.debug("Waiting for Olm session for ".concat(e," to be created"));try{yield r.sessionsInProgress[e]}catch{}}var o=[];return yield r.cryptoStore.doTxn("readonly",[fe.STORE_SESSIONS],a=>{r.cryptoStore.getEndToEndSessions(e,a,l=>{var u=Object.keys(l).sort(),c=function(g){r.unpickleSession(l[g],v=>{o.push({lastReceivedMessageTs:v.lastReceivedMessageTs,hasReceivedMessage:v.session.has_received_message(),sessionId:g})})};for(var d of u)c(d)})},s),o})()}encryptMessage(e,t,r){var n=this;return S(function*(){og(r);var s;return yield n.cryptoStore.doTxn("readwrite",[fe.STORE_SESSIONS],o=>{n.getSession(e,t,o,a=>{var l=a.session.describe();p.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+l),s=a.session.encrypt(r),n.saveSession(e,a,o)})},p.getChild("[encryptMessage]")),s})()}decryptMessage(e,t,r,n){var s=this;return S(function*(){var o;return yield s.cryptoStore.doTxn("readwrite",[fe.STORE_SESSIONS],a=>{s.getSession(e,t,a,l=>{var u=l.session.describe();p.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+u),o=l.session.decrypt(r,n),l.lastReceivedMessageTs=Date.now(),s.saveSession(e,l,a)})},p.getChild("[decryptMessage]")),o})()}matchesSession(e,t,r,n){var s=this;return S(function*(){if(r!==0)return!1;var o;return yield s.cryptoStore.doTxn("readonly",[fe.STORE_SESSIONS],a=>{s.getSession(e,t,a,l=>{o=l.session.matches_inbound(n)})},p.getChild("[matchesSession]")),o})()}recordSessionProblem(e,t,r){var n=this;return S(function*(){p.info("Recording problem on olm session with ".concat(e," of type ").concat(t,". Recreating: ").concat(r)),yield n.cryptoStore.storeEndToEndSessionProblem(e,t,r)})()}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){var r=this.outboundGroupSessionStore[e];if(r===void 0)throw new Error("Unknown outbound group session "+e);var n=new global.Olm.OutboundGroupSession;try{return n.unpickle(this.pickleKey,r),t(n)}finally{n.free()}}createOutboundGroupSession(){var e=new global.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return p.log("encrypting msg with megolm session ".concat(e)),og(t),this.getOutboundGroupSession(e,r=>{var n=r.encrypt(t);return this.saveOutboundGroupSession(r),n})}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,function(t){return{chain_index:t.message_index(),key:t.session_key()}})}unpickleInboundGroupSession(e,t){var r=new global.Olm.InboundGroupSession;try{return r.unpickle(this.pickleKey,e.session),t(r)}finally{r.free()}}getInboundGroupSession(e,t,r,n,s){this.cryptoStore.getEndToEndInboundGroupSession(t,r,n,(o,a)=>{if(o===null){s(null,null,a);return}if(e!==null&&e!==o.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+o.room_id+", was "+e+")");this.unpickleInboundGroupSession(o,l=>{s(l,o,a)})})}addInboundGroupSession(e,t,r,n,s,o,a){var l=arguments,u=this;return S(function*(){var c=l.length>7&&l[7]!==void 0?l[7]:{};yield u.cryptoStore.doTxn("readwrite",[fe.STORE_INBOUND_GROUP_SESSIONS,fe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,fe.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],d=>{u.getInboundGroupSession(e,t,n,d,(h,g)=>{var v=new global.Olm.InboundGroupSession;try{if(a?v.import_session(s):v.create(s),n!=v.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(h&&(p.log("Update for megolm session ".concat(t,"|").concat(n)),h.first_known_index()<=v.first_known_index())){if(!g.untrusted||c.untrusted){p.log("Keeping existing megolm session ".concat(t,"|").concat(n));return}if(h.first_known_index()<v.first_known_index()){h.export_session(v.first_known_index())===v.export_session(v.first_known_index())?(p.info("Upgrading trust of existing megolm session "+"".concat(t,"|").concat(n," based on newly-received trusted session")),g.untrusted=!1,u.cryptoStore.storeEndToEndInboundGroupSession(t,n,g,d)):p.warn("Newly-received megolm session ".concat(t,"|$sessionId}")+" does not match existing session! Keeping existing session");return}}p.debug("Storing megolm session ".concat(t,"|").concat(n," with first index ")+v.first_known_index());var m=Object.assign({},c,{room_id:e,session:v.pickle(u.pickleKey),keysClaimed:o,forwardingCurve25519KeyChain:r});u.cryptoStore.storeEndToEndInboundGroupSession(t,n,m,d),!h&&c.sharedHistory&&u.cryptoStore.addSharedHistoryInboundGroupSession(e,t,n,d)}finally{v.free()}})},p.getChild("[addInboundGroupSession]"))})()}addInboundGroupSessionWithheld(e,t,r,n,s){var o=this;return S(function*(){yield o.cryptoStore.doTxn("readwrite",[fe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],a=>{o.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,r,{room_id:e,code:n,reason:s},a)})})()}decryptGroupMessage(e,t,r,n,s,o){var a=this;return S(function*(){var l=null,u;if(yield a.cryptoStore.doTxn("readwrite",[fe.STORE_INBOUND_GROUP_SESSIONS,fe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],c=>{a.getInboundGroupSession(e,t,r,c,(d,h,g)=>{if(d===null||h===null){g&&(u=new wt(bt.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,lg(g),{session:t+"|"+r})),l=null;return}var v;try{v=d.decrypt(n)}catch(_){(_==null?void 0:_.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&g?u=new wt(bt.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,lg(g),{session:t+"|"+r}):u=_;return}var m=v.plaintext;if(m===void 0)m=v;else{var E=t+"|"+r+"|"+v.message_index;if(E in a.inboundGroupSessionMessageIndexes){var R=a.inboundGroupSessionMessageIndexes[E];if(R.id!==s||R.timestamp!==o){u=new Error("Duplicate message index, possible replay attack: "+E);return}}a.inboundGroupSessionMessageIndexes[E]={id:s,timestamp:o}}h.session=d.pickle(a.pickleKey),a.cryptoStore.storeEndToEndInboundGroupSession(t,r,h,c),l={result:m,keysClaimed:h.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:h.forwardingCurve25519KeyChain||[],untrusted:!!h.untrusted}})},p.getChild("[decryptGroupMessage]")),u)throw u;return l})()}hasInboundSessionKeys(e,t,r){var n=this;return S(function*(){var s;return yield n.cryptoStore.doTxn("readonly",[fe.STORE_INBOUND_GROUP_SESSIONS,fe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{n.cryptoStore.getEndToEndInboundGroupSession(t,r,o,a=>{if(a===null){s=!1;return}e!==a.room_id?(p.warn("requested keys for inbound group session ".concat(t,"|")+"".concat(r,", with incorrect room_id ")+"(expected ".concat(a.room_id,", ")+"was ".concat(e,")")),s=!1):s=!0})},p.getChild("[hasInboundSessionKeys]")),s})()}getInboundGroupSessionKey(e,t,r,n){var s=this;return S(function*(){var o=null;return yield s.cryptoStore.doTxn("readonly",[fe.STORE_INBOUND_GROUP_SESSIONS,fe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],a=>{s.getInboundGroupSession(e,t,r,a,(l,u)=>{if(l===null||u===null){o=null;return}n===void 0&&(n=l.first_known_index());var c=l.export_session(n),d=u.keysClaimed||{},h=d.ed25519||null,g=u.forwardingCurve25519KeyChain||[],v="untrusted"in u?u.untrusted:g.length>0;o={chain_index:n,key:c,forwarding_curve25519_key_chain:g,sender_claimed_ed25519_key:h,shared_history:u.sharedHistory||!1,untrusted:v}})},p.getChild("[getInboundGroupSessionKey]")),o})()}exportInboundGroupSession(e,t,r){return this.unpickleInboundGroupSession(r,n=>{var s=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(s),forwarding_curve25519_key_chain:r.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":r.sharedHistory||!1}})}getSharedHistoryInboundGroupSessions(e){var t=this;return S(function*(){var r;return yield t.cryptoStore.doTxn("readonly",[fe.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],n=>{r=t.cryptoStore.getSharedHistoryInboundGroupSessions(e,n)},p.getChild("[getSharedHistoryInboundGroupSessionsForRoom]")),r})()}verifySignature(e,t,r){this.getUtility(function(n){n.ed25519_verify(e,t,r)})}}var ia={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function lg(i){return i.code&&i.code in ia?ia[i.code]:i.reason?i.reason:"decryption key withheld"}var MI=new Uint8Array(8);function As(i,e,t,r){return sd.apply(this,arguments)}function sd(){return sd=S(function*(i,e,t,r){var n;r?n=At(r):(n=new Uint8Array(16),Tn.getRandomValues(n),n[8]&=127);var[s,o]=yield SS(e,t),a=new $n().encode(i),l=yield Xt.encrypt({name:"AES-CTR",counter:n,length:64},s,a),u=yield Xt.sign({name:"HMAC"},o,l);return{iv:zt(n),ciphertext:zt(l),mac:zt(u)}}),sd.apply(this,arguments)}function _a(i,e,t){return od.apply(this,arguments)}function od(){return od=S(function*(i,e,t){var[r,n]=yield SS(e,t),s=At(i.ciphertext);if(!(yield Xt.verify({name:"HMAC"},n,At(i.mac),s)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var o=yield Xt.decrypt({name:"AES-CTR",counter:At(i.iv),length:64},r,s);return new TextDecoder().decode(new Uint8Array(o))}),od.apply(this,arguments)}function SS(i,e){return ad.apply(this,arguments)}function ad(){return ad=S(function*(i,e){var t=yield Xt.importKey("raw",i,{name:"HKDF"},!1,["deriveBits"]),r=yield Xt.deriveBits({name:"HKDF",salt:MI,info:new $n().encode(e),hash:"SHA-256"},t,512),n=r.slice(0,32),s=r.slice(32),o=Xt.importKey("raw",n,{name:"AES-CTR"},!1,["encrypt","decrypt"]),a=Xt.importKey("raw",s,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([o,a])}),ad.apply(this,arguments)}var AI="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function us(i,e){return As(AI,i,"",e)}var DI=1e3*60;function xa(i){return Object.values(i.keys)[0]}class kr{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.userId=e,this.callbacks=t,this.cacheCallbacks=r,f(this,"keys",{}),f(this,"firstUse",!0),f(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){var r=new kr(t);for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}getCrossSigningKey(e,t){var r=this;return S(function*(){var n=["master","self_signing","user_signing"].indexOf(e)>=0;if(!r.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");t===void 0&&(t=r.getId(e));function s(u){if(u){var c=new global.Olm.PkSigning,d=c.init_with_seed(u);if(d===t)return[d,c];c.free()}}var o=null;r.cacheCallbacks.getCrossSigningKeyCache&&n&&(o=yield r.cacheCallbacks.getCrossSigningKeyCache(e,t));var a=s(o);if(a)return a;o=yield r.callbacks.getCrossSigningKey(e,t);var l=s(o);if(l)return r.cacheCallbacks.storeCrossSigningKeyCache&&n&&(yield r.cacheCallbacks.storeCrossSigningKeyCache(e,o)),l;throw o?new Error("Key type "+e+" from getCrossSigningKey callback did not match"):new Error("getCrossSigningKey callback for "+e+" returned falsey")})()}isStoredInSecretStorage(e){return S(function*(){var t=(yield e.isStored("m.cross_signing.master"))||{};function r(s){for(var o of Object.keys(t))s[o]||delete t[o]}for(var n of["self_signing","user_signing"])r((yield e.isStored("m.cross_signing.".concat(n)))||{});return Object.keys(t).length?t:null})()}static storeInSecretStorage(e,t){return S(function*(){for(var[r,n]of e){var s=zt(n);yield t.store("m.cross_signing.".concat(r),s)}})()}static getFromSecretStorage(e,t){return S(function*(){var r=yield t.get("m.cross_signing.".concat(e));return r?At(r):null})()}isStoredInKeyCache(e){var t=this;return S(function*(){var r=t.cacheCallbacks;if(!r)return!1;var n=e?[e]:["master","self_signing","user_signing"];for(var s of n){var o;if(!(yield(o=r.getCrossSigningKeyCache)===null||o===void 0?void 0:o.call(r,s)))return!1}return!0})()}getCrossSigningKeysFromCache(){var e=this;return S(function*(){var t=new Map,r=e.cacheCallbacks;if(!r)return t;for(var n of["master","self_signing","user_signing"]){var s,o=yield(s=r.getCrossSigningKeyCache)===null||s===void 0?void 0:s.call(r,n);o&&t.set(n,o)}return t})()}getId(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"master";if(!this.keys[e])return null;var t=this.keys[e];return xa(t)}resetKeys(e){var t=this;return S(function*(){if(!t.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(e===void 0||e&pi.MASTER||!t.keys.master)e=pi.MASTER|pi.USER_SIGNING|pi.SELF_SIGNING;else if(e===0)return;var r={},n={},s,o;try{if(e&pi.MASTER?(s=new global.Olm.PkSigning,r.master=s.generate_seed(),o=s.init_with_seed(r.master),n.master={user_id:t.userId,usage:["master"],keys:{["ed25519:"+o]:o}}):[o,s]=yield t.getCrossSigningKey("master"),e&pi.SELF_SIGNING){var a=new global.Olm.PkSigning;try{r.self_signing=a.generate_seed();var l=a.init_with_seed(r.self_signing);n.self_signing={user_id:t.userId,usage:["self_signing"],keys:{["ed25519:"+l]:l}},Xa(n.self_signing,s,t.userId,o)}finally{a.free()}}if(e&pi.USER_SIGNING){var u=new global.Olm.PkSigning;try{r.user_signing=u.generate_seed();var c=u.init_with_seed(r.user_signing);n.user_signing={user_id:t.userId,usage:["user_signing"],keys:{["ed25519:"+c]:c}},Xa(n.user_signing,s,t.userId,o)}finally{u.free()}}Object.assign(t.keys,n),t.callbacks.saveCrossSigningKeys(r)}finally{s&&s.free()}})()}clearKeys(){this.keys={}}setKeys(e){var t={};if(e.master){if(e.master.user_id!==this.userId){var r="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw p.error(r),new Error(r)}this.keys.master?xa(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else if(this.keys.master)t.master=this.keys.master;else throw new Error("Tried to set cross-signing keys without a master key");var n=xa(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){var s="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw p.error(s),new Error(s)}try{es(e.user_signing,n,this.userId)}catch(a){throw p.error("invalid signature on user-signing key"),a}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){var o="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw p.error(o),new Error(o)}try{es(e.self_signing,n,this.userId)}catch(a){throw p.error("invalid signature on self-signing key"),a}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}signObject(e,t){var r=this;return S(function*(){if(!r.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");var[n,s]=yield r.getCrossSigningKey(t);try{return Xa(e,s,r.userId,n),e}finally{s.free()}})()}signUser(e){var t=this;return S(function*(){if(!t.keys.user_signing){p.info("No user signing key: not signing user");return}return t.signObject(e.keys.master,"user_signing")})()}signDevice(e,t){var r=this;return S(function*(){if(e!==r.userId)throw new Error("Trying to sign ".concat(e,"'s device; can only sign our own device"));if(!r.keys.self_signing){p.info("No self signing key: not signing device");return}return r.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing")})()}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new jo(!0,!0,this.firstUse);if(!this.keys.user_signing)return new jo(!1,!1,e.firstUse);var t,r=e.keys.master,n=this.getId("user_signing");try{es(r,n,this.userId),t=!0}catch{t=!1}return new jo(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,r,n){var s=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new cs(!1,!1,r,n);var a=UI(t,e.userId);try{return es(o,e.getId(),e.userId),es(a,xa(o),e.userId),cs.fromUserTrustLevel(s,r,n)}catch{return new cs(!1,!1,r,n)}}getCacheCallbacks(){return this.cacheCallbacks}}function UI(i,e){return{algorithms:i.algorithms,keys:i.keys,device_id:i.deviceId,user_id:e,signatures:i.signatures}}var pi=function(i){return i[i.MASTER=4]="MASTER",i[i.USER_SIGNING=2]="USER_SIGNING",i[i.SELF_SIGNING=1]="SELF_SIGNING",i}({});class cs extends yS{constructor(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;super({crossSigningVerified:e,tofu:t,localVerified:r,trustCrossSignedDevices:n,signedByOwner:s})}static fromUserTrustLevel(e,t,r){return new cs(e.isCrossSigningVerified(),e.isTofu(),t,r,!0)}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function _S(i,e){return{getCrossSigningKeyCache:function(){var t=S(function*(n,s){var o=yield new Promise(u=>{i.doTxn("readonly",[fe.STORE_ACCOUNT],c=>{i.getSecretStorePrivateKey(c,u,n)})});if(o&&o.ciphertext){var a=Buffer.from(e.pickleKey),l=yield _a(o,a,n);return At(l)}else return o});function r(n,s){return t.apply(this,arguments)}return r}(),storeCrossSigningKeyCache:function(){var t=S(function*(n,s){if(!(s instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got ".concat(s));var o=Buffer.from(e.pickleKey),a=yield As(zt(s),o,n);return i.doTxn("readwrite",[fe.STORE_ACCOUNT],l=>{i.storeSecretStorePrivateKey(l,n,a)})});function r(n,s){return t.apply(this,arguments)}return r}()}}function LI(i,e,t){return ld.apply(this,arguments)}function ld(){return ld=S(function*(i,e,t){if(i.getUserId()===e)return p.log("Cross-signing: Self-verification done; requesting keys"),new Promise((r,n)=>{var s=i,o=s.crypto.crossSigningInfo,a=new kr(o.userId,{getCrossSigningKey:function(){var c=S(function*(h){p.debug("Cross-signing: requesting secret",h,t);var{promise:g}=s.requestSecret("m.cross_signing.".concat(h),[t]),v=yield g,m=At(v);return Uint8Array.from(m)});function d(h){return c.apply(this,arguments)}return d}()},o.getCacheCallbacks());a.keys=o.keys;var l=new Promise(c=>{setTimeout(c,DI,new Error("Timeout"))}),u=S(function*(){var c=yield s.crypto.getSessionBackupPrivateKey();if(!c){p.info("No cached backup key found. Requesting...");var d=s.requestSecret("m.megolm_backup.v1",[t]),h=yield d.promise;p.info("Got key backup key, decoding...");var g=At(h);p.info("Decoded backup key, storing..."),yield s.crypto.storeSessionBackupPrivateKey(Uint8Array.from(g)),p.info("Backup key stored. Starting backup restore...");var v=yield s.getKeyBackupVersion();s.restoreKeyBackupWithCache(void 0,void 0,v).then(()=>{p.info("Backup restored.")})}})();Promise.race([Promise.all([a.getCrossSigningKey("master"),a.getCrossSigningKey("self_signing"),a.getCrossSigningKey("user_signing"),u]),l]).then(r,n)}).catch(r=>{p.warn("Cross-signing: failure while requesting keys:",r)})}),ld.apply(this,arguments)}var lr=function(i){return i[i.NotTracked=0]="NotTracked",i[i.PendingDownload=1]="PendingDownload",i[i.DownloadInProgress=2]="DownloadInProgress",i[i.UpToDate=3]="UpToDate",i}({});class NI extends rt{constructor(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:250;super(),this.cryptoStore=t,this.keyDownloadChunkSize=n,f(this,"devices",{}),f(this,"crossSigningInfo",{}),f(this,"userByIdentityKey",{}),f(this,"deviceTrackingStatus",{}),f(this,"syncToken",null),f(this,"keyDownloadsInProgressByUser",new Map),f(this,"dirty",!1),f(this,"savePromise",null),f(this,"resolveSavePromise",null),f(this,"savePromiseTime",null),f(this,"saveTimer",null),f(this,"hasFetched",null),f(this,"serialiser",void 0),this.serialiser=new xI(e,r,this)}load(){var e=this;return S(function*(){yield e.cryptoStore.doTxn("readonly",[fe.STORE_DEVICE_DATA],r=>{e.cryptoStore.getEndToEndDeviceData(r,n=>{var s;e.hasFetched=!!(n!=null&&n.devices),e.devices=n?n.devices:{},e.crossSigningInfo=n?n.crossSigningInfo||{}:{},e.deviceTrackingStatus=n?n.trackingStatus:{},e.syncToken=(s=n==null?void 0:n.syncToken)!==null&&s!==void 0?s:null,e.userByIdentityKey={};for(var o of Object.keys(e.devices)){var a=e.devices[o];for(var l of Object.keys(a)){var u=a[l].keys["curve25519:"+l];u!==void 0&&(e.userByIdentityKey[u]=o)}}})});for(var t of Object.keys(e.deviceTrackingStatus))e.deviceTrackingStatus[t]==lr.DownloadInProgress&&(e.deviceTrackingStatus[t]=lr.PendingDownload)})()}stop(){this.saveTimer!==null&&clearTimeout(this.saveTimer)}saveIfDirty(){var e=arguments,t=this;return S(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:500;if(!t.dirty)return Promise.resolve(!1);var n=Date.now()+r;t.savePromiseTime&&n<t.savePromiseTime&&(clearTimeout(t.saveTimer),t.saveTimer=null,t.savePromiseTime=null);var s=t.savePromise;if(s===null&&(s=new Promise(a=>{t.resolveSavePromise=a}),t.savePromise=s),t.saveTimer===null){var o=t.resolveSavePromise;t.savePromiseTime=n,t.saveTimer=setTimeout(()=>{p.log("Saving device tracking data",t.syncToken),t.savePromiseTime=null,t.saveTimer=null,t.savePromise=null,t.resolveSavePromise=null,t.cryptoStore.doTxn("readwrite",[fe.STORE_DEVICE_DATA],a=>{var l;t.cryptoStore.storeEndToEndDeviceData({devices:t.devices,crossSigningInfo:t.crossSigningInfo,trackingStatus:t.deviceTrackingStatus,syncToken:(l=t.syncToken)!==null&&l!==void 0?l:void 0},a)}).then(()=>{t.dirty=!1,o==null||o(!0)},a=>{p.error("Failed to save device tracking data",t.syncToken),p.error(a)})},r)}return s})()}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){var r=[],n=[];if(e.forEach(o=>{var a=this.deviceTrackingStatus[o];this.keyDownloadsInProgressByUser.has(o)?(p.log("downloadKeys: already have a download in progress for "+"".concat(o,": awaiting its result")),n.push(this.keyDownloadsInProgressByUser.get(o))):(t||a!=lr.UpToDate)&&r.push(o)}),r.length!=0){p.log("downloadKeys: downloading for",r);var s=this.doKeyDownload(r);n.push(s)}return n.length===0&&p.log("downloadKeys: already have all necessary keys"),Promise.all(n).then(()=>this.getDevicesFromStore(e))}getDevicesFromStore(e){var t=new Map;return e.forEach(r=>{var n,s=new Map;(n=this.getStoredDevicesForUser(r))===null||n===void 0||n.forEach(function(o){s.set(o.deviceId,o)}),t.set(r,s)}),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){var t=this.devices[e];if(!t)return null;var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(er.fromStorage(t[n],n));return r}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?kr.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){var r=this.devices[e];if(r!=null&&r[t])return er.fromStorage(r[t],t)}getUserByIdentityKey(e,t){return e!==kt&&e!==nr?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){var r=this.getUserByIdentityKey(e,t);if(!r)return null;var n=this.devices[r];if(!n)return null;for(var s in n)if(n.hasOwnProperty(s)){var o=n[s];for(var a in o.keys)if(o.keys.hasOwnProperty(a)&&a.indexOf("curve25519:")===0){var l=o.keys[a];if(l==t)return er.fromStorage(o,s)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if(typeof e!="string")throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(p.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=lr.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(p.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=lr.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(var e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=lr.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(p.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=lr.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();var e=[];for(var t of Object.keys(this.deviceTrackingStatus)){var r=this.deviceTrackingStatus[t];r==lr.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(this.devices[e]!==void 0)for(var[r,n]of Object.entries(this.devices[e])){var s=n.keys["curve25519:"+r];delete this.userByIdentityKey[s]}this.devices[e]=t;for(var[o,a]of Object.entries(t)){var l=a.keys["curve25519:"+o];this.userByIdentityKey[l]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(e.length===0)return Promise.resolve();var t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then(()=>{r(!0)},n=>{throw p.error("Error downloading keys for "+e+":",n),r(!1),n});e.forEach(n=>{this.keyDownloadsInProgressByUser.set(n,t);var s=this.deviceTrackingStatus[n];s==lr.PendingDownload&&(this.deviceTrackingStatus[n]=lr.DownloadInProgress)});var r=n=>{this.emit(Ce.WillUpdateDevices,e,!this.hasFetched),e.forEach(s=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(s)!==t){p.log("Another update in the queue for",s,"- not marking up-to-date");return}this.keyDownloadsInProgressByUser.delete(s);var o=this.deviceTrackingStatus[s];o==lr.DownloadInProgress&&(n?(this.deviceTrackingStatus[s]=lr.UpToDate,p.log("Device list for",s,"now up to date")):this.deviceTrackingStatus[s]=lr.PendingDownload)}),this.saveIfDirty(),this.emit(Ce.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class xI{constructor(e,t,r){this.baseApis=e,this.olmDevice=t,this.deviceList=r,f(this,"downloadInProgress",!1),f(this,"keyDownloadsQueuedByUser",{}),f(this,"queuedQueryDeferred",void 0),f(this,"syncToken",void 0)}updateDevicesForUsers(e,t){return e.forEach(r=>{this.keyDownloadsQueuedByUser[r]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=ni()),this.syncToken=t,this.downloadInProgress?(p.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){var e=this;if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");var t=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};var r=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,p.log("Starting key download for",t),this.downloadInProgress=!0;var n={};this.syncToken&&(n.token=this.syncToken);for(var s=[],o=function(){var u=t.slice(a,a+e.deviceList.keyDownloadChunkSize);s.push(()=>e.baseApis.downloadKeysForUsers(u,n))},a=0;a<t.length;a+=this.deviceList.keyDownloadChunkSize)o();return wR(s,3).then(function(){var l=S(function*(u){var c=Object.assign({},...u.map(m=>m.device_keys||{})),d=Object.assign({},...u.map(m=>m.master_keys||{})),h=Object.assign({},...u.map(m=>m.self_signing_keys||{})),g=Object.assign({},...u.map(m=>m.user_signing_keys||{}));for(var v of t){yield Zo(5);try{yield e.processQueryResponseForUser(v,c[v],{master:d==null?void 0:d[v],self_signing:h==null?void 0:h[v],user_signing:g==null?void 0:g[v]})}catch(m){p.error("Error processing keys for ".concat(v,":"),m)}}});return function(u){return l.apply(this,arguments)}}()).then(()=>{p.log("Completed key download for "+t),this.downloadInProgress=!1,r==null||r.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},l=>{p.warn("Error downloading keys for "+t+":",l),this.downloadInProgress=!1,r==null||r.reject(l)}),r.promise}processQueryResponseForUser(e,t,r){var n=this;return S(function*(){p.log("got device keys for "+e+":",t),p.log("got cross-signing keys for "+e+":",r);{var s={},o=n.deviceList.getRawStoredDevicesForUser(e);o&&Object.keys(o).forEach(u=>{var c=er.fromStorage(o[u],u);s[u]=c}),yield KI(n.olmDevice,e,s,t||{},n.baseApis.getUserId(),n.baseApis.deviceId);var a={};Object.keys(s).forEach(u=>{a[u]=s[u].toStorage()}),n.deviceList.setRawStoredDevicesForUser(e,a)}if(r&&(r.master||r.self_signing||r.user_signing)){var l=n.deviceList.getStoredCrossSigningForUser(e)||new kr(e);l.setKeys(r),n.deviceList.setRawStoredCrossSigningForUser(e,l.toStorage()),n.deviceList.emit(Ce.UserCrossSigningUpdated,e)}})()}}function KI(i,e,t,r,n,s){return ud.apply(this,arguments)}function ud(){return ud=S(function*(i,e,t,r,n,s){var o=!1;for(var a in t)if(t.hasOwnProperty(a)&&!(a in r)){if(e===n&&a===s){p.warn("Local device ".concat(a," missing from sync, skipping removal"));continue}p.log("Device "+e+":"+a+" has been removed"),delete t[a],o=!0}for(var l in r)if(r.hasOwnProperty(l)){var u=r[l];if(u.user_id!==e){p.warn("Mismatched user_id "+u.user_id+" in keys from "+e+":"+l);continue}if(u.device_id!==l){p.warn("Mismatched device_id "+u.device_id+" in keys from "+e+":"+l);continue}(yield FI(i,t,u))&&(o=!0)}return o}),ud.apply(this,arguments)}function FI(i,e,t){return cd.apply(this,arguments)}function cd(){return cd=S(function*(i,e,t){if(!t.keys)return!1;var r=t.device_id,n=t.user_id,s="ed25519:"+r,o=t.keys[s];if(!o)return p.warn("Device "+n+":"+r+" has no ed25519 key"),!1;var a=t.unsigned||{},l=t.signatures||{};try{yield Es(i,t,n,r,o)}catch(c){return p.warn("Unable to verify signature on device "+n+":"+r+":"+c),!1}var u;if(r in e){if(u=e[r],u.getFingerprint()!=o)return p.warn("Ed25519 key for device "+n+":"+r+" has changed"),!1}else e[r]=u=new er(r);return u.keys=t.keys||{},u.algorithms=t.algorithms||[],u.unsigned=a,u.signatures=l,!0}),cd.apply(this,arguments)}var bS=new Map,dd=new Map;class ES{constructor(e){f(this,"userId",void 0),f(this,"deviceId",void 0),f(this,"crypto",void 0),f(this,"olmDevice",void 0),f(this,"baseApis",void 0),f(this,"roomId",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,r){}}class wS{constructor(e){f(this,"userId",void 0),f(this,"crypto",void 0),f(this,"olmDevice",void 0),f(this,"baseApis",void 0),f(this,"roomId",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}onRoomKeyEvent(e){return S(function*(){})()}importRoomKey(e,t){return S(function*(){})()}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}retryDecryptionFromSender(e){return S(function*(){return!1})()}}class BI extends Error{constructor(e,t,r){super(e),this.devices=t,this.event=r,this.name="UnknownDeviceError",this.devices=t}}function RS(i,e,t){bS.set(i,e),dd.set(i,t)}var jI=er.DeviceVerification;class qI extends ES{constructor(){super(...arguments),f(this,"sessionPrepared",!1),f(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then(()=>this.crypto.ensureOlmSessionsForUsers(e)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}encryptMessage(e,t,r){var n=this;return S(function*(){var s=yield e.getEncryptionTargetMembers(),o=s.map(function(v){return v.userId});yield n.ensureSession(o);var a={room_id:e.roomId,type:t,content:r},l={algorithm:kt,sender_key:n.olmDevice.deviceCurve25519Key,ciphertext:{}},u=[];for(var c of o){var d=n.crypto.getStoredDevicesForUser(c)||[];for(var h of d){var g=h.getIdentityKey();g!=n.olmDevice.deviceCurve25519Key&&h.verified!=jI.BLOCKED&&u.push(Xn(l.ciphertext,n.userId,n.deviceId,n.olmDevice,c,h,a))}}return Promise.all(u).then(()=>l)})()}}class VI extends wS{decryptEvent(e){var t=this;return S(function*(){var r=e.getWireContent(),n=r.sender_key,s=r.ciphertext;if(!s)throw new wt(bt.OLM_MISSING_CIPHERTEXT,"Missing ciphertext");if(!(t.olmDevice.deviceCurve25519Key in s))throw new wt(bt.OLM_NOT_INCLUDED_IN_RECIPIENTS,"Not included in recipients");var o=s[t.olmDevice.deviceCurve25519Key],a;try{a=yield t.decryptMessage(n,o)}catch(d){throw new wt(bt.OLM_BAD_ENCRYPTED_MESSAGE,"Bad Encrypted Message",{sender:n,err:d})}var l=JSON.parse(a);if(l.recipient!=t.userId)throw new wt(bt.OLM_BAD_RECIPIENT,"Message was intended for "+l.recipient);if(l.recipient_keys.ed25519!=t.olmDevice.deviceEd25519Key)throw new wt(bt.OLM_BAD_RECIPIENT_KEY,"Message not intended for this device",{intended:l.recipient_keys.ed25519,our_key:t.olmDevice.deviceEd25519Key});var u=t.crypto.deviceList.getUserByIdentityKey(kt,n);if(u==null){try{yield t.crypto.deviceList.downloadKeys([e.getSender()],!1)}catch(d){throw new wt(bt.OLM_BAD_SENDER_CHECK_FAILED,"Could not verify sender identity",{sender:n,err:d})}u=t.crypto.deviceList.getUserByIdentityKey(kt,n)}if(u!==e.getSender()&&u!==void 0&&u!==null)throw new wt(bt.OLM_BAD_SENDER,"Message claimed to be from "+e.getSender(),{real_sender:u});if(l.sender!=e.getSender())throw new wt(bt.OLM_FORWARDED_MESSAGE,"Message forwarded from "+l.sender,{reported_sender:e.getSender()});if(l.room_id!==e.getRoomId())throw new wt(bt.OLM_BAD_ROOM,"Message intended for room "+l.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});var c=l.keys||{};return{clearEvent:l,senderCurve25519Key:n,claimedEd25519Key:c.ed25519||null}})()}decryptMessage(e,t){if(t.type!==0)return this.reallyDecryptMessage(e,t);var r=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(e,t));return this.olmDevice.olmPrekeyPromise=r.catch(()=>{}),r}reallyDecryptMessage(e,t){var r=this;return S(function*(){var n=yield r.olmDevice.getSessionIdsForDevice(e),s={};for(var o of n)try{var a=yield r.olmDevice.decryptMessage(e,o,t.type,t.body);return p.log("Decrypted Olm message from "+e+" with session "+o),a}catch(c){var l=yield r.olmDevice.matchesSession(e,o,t.type,t.body);if(l)throw new Error("Error decrypting prekey message with existing session id "+o+": "+c.message);s[o]=c.message}if(t.type!==0)throw n.length===0?new Error("No existing sessions"):new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(s));var u;try{u=yield r.olmDevice.createInboundSession(e,t.type,t.body)}catch(c){throw s["(new)"]=c.message,new Error("Error decrypting prekey message: "+JSON.stringify(s))}return p.log("created new inbound Olm session ID "+u.session_id+" with "+e),u.payload})()}}RS(kt,qI,VI);function ug(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function cg(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ug(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ug(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var WI=500,Ge=function(i){return i[i.Unsent=0]="Unsent",i[i.Sent=1]="Sent",i[i.CancellationPending=2]="CancellationPending",i[i.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend",i}({});class GI{constructor(e,t,r){this.baseApis=e,this.deviceId=t,this.cryptoStore=r,f(this,"sendOutgoingRoomKeyRequestsTimer",void 0),f(this,"sendOutgoingRoomKeyRequestsRunning",!1),f(this,"clientRunning",!0)}stop(){p.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}queueRoomKeyRequest(e,t){var r=arguments,n=this;return S(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!1,o=yield n.cryptoStore.getOutgoingRoomKeyRequest(e);if(!o)yield n.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:n.baseApis.makeTxnId(),state:Ge.Unsent});else switch(o.state){case Ge.CancellationPendingAndWillResend:case Ge.Unsent:return;case Ge.CancellationPending:{var a=s?Ge.CancellationPendingAndWillResend:Ge.Sent;yield n.cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,Ge.CancellationPending,{state:a,cancellationTxnId:n.baseApis.makeTxnId()});break}case Ge.Sent:{if(s){var l=Ge.CancellationPendingAndWillResend,u=yield n.cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,Ge.Sent,{state:l,cancellationTxnId:n.baseApis.makeTxnId(),requestTxnId:n.baseApis.makeTxnId()});if(!u)return n.queueRoomKeyRequest(e,t,s);try{yield n.sendOutgoingRoomKeyRequestCancellation(u,!0)}catch(c){p.error("Error sending room key request cancellation; will retry later.",c)}}break}default:throw new Error("unhandled state: "+o.state)}})()}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case Ge.CancellationPending:case Ge.CancellationPendingAndWillResend:return;case Ge.Unsent:return p.log("deleting unnecessary room key request for "+Ka(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,Ge.Unsent);case Ge.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,Ge.Sent,{state:Ge.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then(r=>{if(!r){p.log("Tried to cancel room key request for "+Ka(e)+" but it was already cancelled in another tab");return}this.sendOutgoingRoomKeyRequestCancellation(r).catch(n=>{p.error("Error sending room key request cancellation; will retry later.",n),this.startTimer()})});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[Ge.Sent])}cancelAndResendAllOutgoingRequests(){var e=this;return S(function*(){var t=yield e.cryptoStore.getAllOutgoingRoomKeyRequestsByState(Ge.Sent);return Promise.all(t.map(r=>{var{requestBody:n,recipients:s}=r;return e.queueRoomKeyRequest(n,s,!0)}))})()}startTimer(){if(!this.sendOutgoingRoomKeyRequestsTimer){var e=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(t=>{p.warn("error in OutgoingRoomKeyRequestManager: ".concat(t))})};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(e,WI)}}sendOutgoingRoomKeyRequests(){var e=this;return S(function*(){if(!e.clientRunning){e.sendOutgoingRoomKeyRequestsTimer=void 0;return}var t=yield e.cryptoStore.getOutgoingRoomKeyRequestByState([Ge.CancellationPending,Ge.CancellationPendingAndWillResend,Ge.Unsent]);if(!t){e.sendOutgoingRoomKeyRequestsTimer=void 0;return}try{switch(t.state){case Ge.Unsent:yield e.sendOutgoingRoomKeyRequest(t);break;case Ge.CancellationPending:yield e.sendOutgoingRoomKeyRequestCancellation(t);break;case Ge.CancellationPendingAndWillResend:yield e.sendOutgoingRoomKeyRequestCancellation(t,!0);break}return e.sendOutgoingRoomKeyRequests()}catch(r){p.error("Error sending room key request; will retry later.",r),e.sendOutgoingRoomKeyRequestsTimer=void 0}})()}sendOutgoingRoomKeyRequest(e){p.log("Requesting keys for ".concat(Ka(e.requestBody))+" from ".concat(dg(e.recipients))+"(id ".concat(e.requestId,")"));var t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,Ge.Unsent,{state:Ge.Sent}))}sendOutgoingRoomKeyRequestCancellation(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;p.log("Sending cancellation for key request for "+"".concat(Ka(e.requestBody)," to ")+"".concat(dg(e.recipients)," ")+"(cancellation id ".concat(e.cancellationTxnId,")"));var r={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(r,e.recipients,e.cancellationTxnId).then(()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,Ge.CancellationPendingAndWillResend,{state:Ge.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,Ge.CancellationPending))}sendMessageToDevices(e,t,r){var n=new ht(()=>new Map);for(var s of t){var o=n.getOrCreate(s.userId);o.set(s.deviceId,cg(cg({},e),{},{[Zt]:Ar()}))}return this.baseApis.sendToDevice(F.RoomKeyRequest,n,r)}}function Ka(i){return i.room_id+" / "+i.session_id}function dg(i){return"[".concat(i.map(e=>"".concat(e.userId,":").concat(e.deviceId)).join(","),"]")}function hg(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function fg(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hg(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):hg(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function TS(i){var e,t,r=i==null||(e=i.currentState)===null||e===void 0?void 0:e.getStateEvents("m.room.history_visibility",""),n=r==null||(t=r.getContent())===null||t===void 0?void 0:t.history_visibility;return["world_readable","shared"].includes(n)}var HI=i=>typeof i.ciphertext=="string"?!!i.ciphertext.length:!!Object.keys(i.ciphertext).length;class $I{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.sessionId=e,this.sharedHistory=t,f(this,"useCount",0),f(this,"creationTime",void 0),f(this,"sharedWithDevices",new ht(()=>new Map)),f(this,"blockedDevicesNotified",new ht(()=>new Map)),this.creationTime=new Date().getTime()}needsRotation(e,t){var r=new Date().getTime()-this.creationTime;return this.useCount>=e||r>=t?(p.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0):!1}markSharedWithDevice(e,t,r,n){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:r,messageIndex:n})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){for(var[t,r]of this.sharedWithDevices){if(!e.has(t))return p.log("Starting new megolm session because we shared with "+t),!0;for(var[n]of r){var s;if(!((s=e.get(t))!==null&&s!==void 0&&s.get(n)))return p.log("Starting new megolm session because we shared with "+t+":"+n),!0}}return!1}}class zI extends ES{constructor(e){var t,r,n,s;super(e),f(this,"setupPromise",Promise.resolve(null)),f(this,"outboundSessions",{}),f(this,"sessionRotationPeriodMsgs",void 0),f(this,"sessionRotationPeriodMs",void 0),f(this,"encryptionPreparation",void 0),f(this,"roomId",void 0),f(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=p.getChild("[".concat(this.roomId," encryption]")),this.sessionRotationPeriodMsgs=(t=(r=e.config)===null||r===void 0?void 0:r.rotation_period_msgs)!==null&&t!==void 0?t:100,this.sessionRotationPeriodMs=(n=(s=e.config)===null||s===void 0?void 0:s.rotation_period_ms)!==null&&n!==void 0?n:7*24*3600*1e3}ensureOutboundSession(e,t,r){var n=arguments,s=this;return S(function*(){var o=n.length>3&&n[3]!==void 0?n[3]:!1,a=function(){var u=S(function*(c){var d=TS(e),h=yield s.prepareSession(t,d,c);return yield s.shareSession(t,d,o,r,h),h});return function(d){return u.apply(this,arguments)}}(),l=s.setupPromise.then(a);return s.setupPromise=l.catch(u=>(s.prefixedLogger.error("Failed to setup outbound session",u),null)),l})()}prepareSession(e,t,r){var n=this;return S(function*(){var s,o;return r&&t!==r.sharedHistory&&(r=null),(s=r)!==null&&s!==void 0&&s.needsRotation(n.sessionRotationPeriodMsgs,n.sessionRotationPeriodMs)&&(n.prefixedLogger.debug("Starting new megolm session because we need to rotate."),r=null),(o=r)!==null&&o!==void 0&&o.sharedWithTooManyDevices(e)&&(r=null),r||(n.prefixedLogger.debug("Starting new megolm session"),r=yield n.prepareNewSession(t),n.prefixedLogger.debug("Started new megolm session ".concat(r.sessionId)),n.outboundSessions[r.sessionId]=r),r})()}shareSession(e,t,r,n,s){var o=this;return S(function*(){var a={};for(var[l,u]of e)for(var[c,d]of u){var h,g=d.getIdentityKey();g!=o.olmDevice.deviceCurve25519Key&&((h=s.sharedWithDevices.get(l))!==null&&h!==void 0&&h.get(c)||(a[l]=a[l]||[],a[l].push(d)))}var v=o.olmDevice.getOutboundGroupSessionKey(s.sessionId),m={type:"m.room_key",content:{algorithm:nr,room_id:o.roomId,session_id:s.sessionId,session_key:v.key,chain_index:v.chain_index,"org.matrix.msc3061.shared_history":t}},[E,R]=yield fS(o.olmDevice,o.baseApis,a);yield Promise.all([S(function*(){var _=Array.from(R.entries()).map(T=>{var[b,I]=T;return Array.from(I.entries()).map(y=>{var[C,w]=y;return"".concat(b,"/").concat(C,": ").concat(w.sessionId)})}).flat(1);o.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",_),yield o.shareKeyWithOlmSessions(s,v,m,R),o.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),S(function*(){var _=Array.from(E.entries()).map(y=>{var[C,w]=y;return w.map(D=>"".concat(C,"/").concat(D.deviceId))}).flat(1);o.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",_);var T=[],b=Date.now(),I=[];yield o.shareKeyWithDevices(s,v,m,E,T,r?1e4:2e3,I),o.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!r&&Date.now()-b<1e4?S(function*(){var y=new ht(()=>[]),C=new Set;for(var w of I)C.add(w);var D=[];for(var{userId:x,deviceInfo:G}of T){var oe=x.slice(x.indexOf(":")+1);C.has(oe)?y.getOrCreate(x).push(G):D.push({userId:x,deviceInfo:G})}var de=Array.from(y.entries()).map(Ee=>{var[X,re]=Ee;return re.map(Z=>"".concat(X,"/").concat(Z.deviceId))}).flat(1);de.length>0&&(o.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",de),yield o.shareKeyWithDevices(s,v,m,y,D,3e4),o.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),yield o.notifyFailedOlmDevices(s,v,D)})():yield o.notifyFailedOlmDevices(s,v,T)})(),S(function*(){o.prefixedLogger.debug("There are ".concat(n.size," blocked devices:"),Array.from(n.entries()).map(D=>{var[x,G]=D;return Array.from(G.entries()).map(oe=>{var[de,Ee]=oe;return"".concat(x,"/").concat(de)})}).flat(1));var _=new ht(()=>new Map),T=0;for(var[b,I]of n)for(var[y,C]of I){var w;((w=s.blockedDevicesNotified.get(b))===null||w===void 0?void 0:w.get(y))===void 0&&(_.getOrCreate(b).set(y,{device:C}),T++)}T&&(o.prefixedLogger.debug("Notifying ".concat(T," newly blocked devices:"),Array.from(_.entries()).map(D=>{var[x,G]=D;return Object.entries(G).map(oe=>{var[de,Ee]=oe;return"".concat(x,"/").concat(de)})}).flat(1)),yield o.notifyBlockedDevices(s,_),o.prefixedLogger.debug("Notified ".concat(T," newly blocked devices")))})()])})()}prepareNewSession(e){var t=this;return S(function*(){var r=t.olmDevice.createOutboundGroupSession(),n=t.olmDevice.getOutboundGroupSessionKey(r);return yield t.olmDevice.addInboundGroupSession(t.roomId,t.olmDevice.deviceCurve25519Key,[],r,n.key,{ed25519:t.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),t.crypto.backupManager.backupGroupSession(t.olmDevice.deviceCurve25519Key,r),new $I(r,e)})()}getDevicesWithoutSessions(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];for(var[n,s]of t){var o=e.get(n);for(var a of s){var l=a.deviceId,u=o==null?void 0:o.get(l);if(!(u!=null&&u.sessionId)){r.push({userId:n,deviceInfo:a}),o==null||o.delete(l);continue}}}return r}splitDevices(e){var t=20,r=[],n=[r];for(var[s,o]of e){for(var a of o.values())r.push({userId:s,deviceInfo:a.device});r.length>t&&(r=[],n.push(r))}return r.length===0&&n.pop(),n}encryptAndSendKeysToDevices(e,t,r,n){return this.crypto.encryptAndSendToDevices(r,n).then(()=>{for(var s of r)e.markSharedWithDevice(s.userId,s.deviceInfo.deviceId,s.deviceInfo.getIdentityKey(),t)}).catch(s=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",s),s})}sendBlockedNotificationsToDevices(e,t,r){var n=this;return S(function*(){var s=new ht(()=>new Map);for(var o of t){var a=o.userId,l=o.deviceInfo,u=l.deviceInfo,c=u.deviceId,d=fg(fg({},r),{},{code:l.code,reason:l.reason,[Zt]:Ar()});d.code==="m.no_olm"&&(delete d.room_id,delete d.session_id),s.getOrCreate(a).set(c,d)}yield n.baseApis.sendToDevice("m.room_key.withheld",s);for(var[h,g]of s)for(var v of g.keys())e.markNotifiedBlockedDevice(h,v)})()}reshareKeyWithDevice(e,t,r,n){var s=this;return S(function*(){var o,a=s.outboundSessions[t];if(!a){s.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," not found: not re-sharing keys"));return}if(!a.sharedWithDevices.has(r)){s.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with user ").concat(r));return}var l=(o=a.sharedWithDevices.get(r))===null||o===void 0?void 0:o.get(n.deviceId);if(l===void 0){s.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with device ").concat(r,":").concat(n.deviceId));return}if(l.deviceKey!==n.getIdentityKey()){s.prefixedLogger.warn("Megolm session ".concat(e,"|").concat(t," has been shared with device ").concat(n.deviceId," but ")+"with identity key ".concat(l.deviceKey,". Key is now ").concat(n.getIdentityKey(),"!"));return}var u=yield s.olmDevice.getInboundGroupSessionKey(s.roomId,e,t,l.messageIndex);if(!u){s.prefixedLogger.warn("No inbound session key found for megolm session ".concat(e,"|").concat(t,": not re-sharing keys"));return}yield Rn(s.olmDevice,s.baseApis,new Map([[r,[n]]]));var c={type:"m.forwarded_room_key",content:{algorithm:nr,room_id:s.roomId,session_id:t,session_key:u.key,chain_index:u.chain_index,sender_key:e,sender_claimed_ed25519_key:u.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:u.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":u.shared_history||!1}},d={algorithm:kt,sender_key:s.olmDevice.deviceCurve25519Key,ciphertext:{},[Zt]:Ar()};yield Xn(d.ciphertext,s.userId,s.deviceId,s.olmDevice,r,n,c),yield s.baseApis.sendToDevice("m.room.encrypted",new Map([[r,new Map([[n.deviceId,d]])]])),s.prefixedLogger.debug("Re-shared key for megolm session ".concat(e,"|").concat(t," with ").concat(r,":").concat(n.deviceId))})()}shareKeyWithDevices(e,t,r,n,s,o,a){var l=this;return S(function*(){var u=yield Rn(l.olmDevice,l.baseApis,n,!1,o,a,l.prefixedLogger);l.getDevicesWithoutSessions(u,n,s),yield l.shareKeyWithOlmSessions(e,t,r,u)})()}shareKeyWithOlmSessions(e,t,r,n){var s=this;return S(function*(){for(var o=s.splitDevices(n),a=0;a<o.length;a++){var l="megolm keys for ".concat(e.sessionId," (slice ").concat(a+1,"/").concat(o.length,")");try{s.prefixedLogger.debug("Sharing ".concat(l),o[a].map(u=>"".concat(u.userId,"/").concat(u.deviceInfo.deviceId))),yield s.encryptAndSendKeysToDevices(e,t.chain_index,o[a],r),s.prefixedLogger.debug("Shared ".concat(l))}catch(u){throw s.prefixedLogger.error("Failed to share ".concat(l)),u}}})()}notifyFailedOlmDevices(e,t,r){var n=this;return S(function*(){n.prefixedLogger.debug("Notifying ".concat(r.length," devices we failed to create Olm sessions"));for(var{userId:s,deviceInfo:o}of r){var a=o.deviceId;e.markSharedWithDevice(s,a,o.getIdentityKey(),t.chain_index)}var l=yield n.olmDevice.filterOutNotifiedErrorDevices(r);n.prefixedLogger.debug("Need to notify ".concat(l.length," failed devices which haven't been notified before"));var u=new ht(()=>new Map);for(var{userId:c,deviceInfo:d}of l)u.getOrCreate(c).set(d.deviceId,{device:{code:"m.no_olm",reason:ia["m.no_olm"],deviceInfo:d}});yield n.notifyBlockedDevices(e,u),n.prefixedLogger.debug("Notified ".concat(l.length," devices we failed to create Olm sessions"))})()}notifyBlockedDevices(e,t){var r=this;return S(function*(){for(var n={room_id:r.roomId,session_id:e.sessionId,algorithm:nr,sender_key:r.olmDevice.deviceCurve25519Key},s=r.splitDevices(t),o=0;o<s.length;o++)try{yield r.sendBlockedNotificationsToDevices(e,s[o],n),r.prefixedLogger.debug("Completed blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(o+1,"/").concat(s.length,")"))}catch(a){throw r.prefixedLogger.debug("blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(o+1,"/").concat(s.length,") failed")),a}})()}prepareToEncrypt(e){var t=this;if(e.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(this.encryptionPreparation!=null){var r=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug("Already started preparing to encrypt for this room ".concat(r,"ms ago, skipping")),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");var n=!1,s=()=>n;return this.encryptionPreparation={startTime:Date.now(),promise:S(function*(){try{var o=yield t.getDevicesInRoom(e,!1,s);if(o===null)return;var[a,l]=o;t.crypto.globalErrorOnUnknownDevices&&t.removeUnknownDevices(a),t.prefixedLogger.debug("Ensuring outbound megolm session"),yield t.ensureOutboundSession(e,a,l,!0),t.prefixedLogger.debug("Ready to encrypt events")}catch(u){t.prefixedLogger.error("Failed to prepare to encrypt events",u)}finally{delete t.encryptionPreparation}})(),cancel:()=>{n=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}encryptMessage(e,t,r){var n=this;return S(function*(){if(n.prefixedLogger.debug("Starting to encrypt event"),n.encryptionPreparation!=null)try{yield n.encryptionPreparation.promise}catch{}var s=n.isVerificationEvent(t,r),[o,a]=yield n.getDevicesInRoom(e,s);n.crypto.globalErrorOnUnknownDevices&&n.checkForUnknownDevices(o);var l=yield n.ensureOutboundSession(e,o,a),u={room_id:n.roomId,type:t,content:r},c=n.olmDevice.encryptGroupMessage(l.sessionId,JSON.stringify(u)),d={algorithm:nr,sender_key:n.olmDevice.deviceCurve25519Key,ciphertext:c,session_id:l.sessionId,device_id:n.deviceId};return l.useCount++,d})()}isVerificationEvent(e,t){switch(e){case F.KeyVerificationCancel:case F.KeyVerificationDone:case F.KeyVerificationMac:case F.KeyVerificationStart:case F.KeyVerificationKey:case F.KeyVerificationReady:case F.KeyVerificationAccept:return!0;case F.RoomMessage:return t.msgtype===Nr.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(e){var t=new ht(()=>new Map);for(var[r,n]of e)for(var[s,o]of n)o.isUnverified()&&!o.isKnown()&&t.getOrCreate(r).set(s,o);if(t.size)throw new BI("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(var[t,r]of e){for(var[n,s]of r)s.isUnverified()&&!s.isKnown()&&r.delete(n);r.size===0&&e.delete(t)}}getDevicesInRoom(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=t.length>2?t[2]:void 0,o=yield e.getEncryptionTargetMembers();r.prefixedLogger.debug("Encrypting for users (shouldEncryptForInvitedMembers: ".concat(e.shouldEncryptForInvitedMembers(),"):"),o.map(T=>"".concat(T.userId," (").concat(T.membership,")")));var a=o.map(function(T){return T.userId}),l=r.crypto.globalBlacklistUnverifiedDevices,u=e.getBlacklistUnverifiedDevices();typeof u=="boolean"&&(l=u);var c=yield r.crypto.downloadKeys(a,!1);if((s==null?void 0:s())===!0)return null;var d=new ht(()=>new Map);for(var[h,g]of c)for(var[v,m]of g){if(s!==void 0&&(yield ER()),(s==null?void 0:s())===!0)return null;var E=r.crypto.checkDeviceTrust(h,v);if(m.isBlocked()||!E.isVerified()&&l&&!n){var R=d.getOrCreate(h),_=m.isBlocked();R.set(v,{code:_?"m.blacklisted":"m.unverified",reason:ia[_?"m.blacklisted":"m.unverified"],deviceInfo:m}),g.delete(v)}}return[c,d]})()}}class JI extends wS{constructor(e){super(e),f(this,"pendingEvents",new Map),f(this,"olmlib",bI),f(this,"roomId",void 0),f(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=p.getChild("[".concat(this.roomId," decryption]"))}decryptEvent(e){var t=this;return S(function*(){var r=e.getWireContent();if(!r.sender_key||!r.session_id||!r.ciphertext)throw new wt(bt.MEGOLM_MISSING_FIELDS,"Missing fields in input");t.addEventToPendingList(e);var n;try{n=yield t.olmDevice.decryptGroupMessage(e.getRoomId(),r.sender_key,r.session_id,r.ciphertext,e.getId(),e.getTs())}catch(u){if(u.name==="DecryptionError")throw u;var s=bt.OLM_DECRYPT_GROUP_MESSAGE_ERROR;throw(u==null?void 0:u.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&(t.requestKeysForEvent(e),s=bt.OLM_UNKNOWN_MESSAGE_INDEX),new wt(s,u instanceof Error?u.message:"Unknown Error: Error is undefined",{session:r.sender_key+"|"+r.session_id})}if(n===null){t.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),r.session_id).catch(()=>{}),t.requestKeysForEvent(e);var o=yield t.olmDevice.sessionMayHaveProblems(r.sender_key,e.getTs()-12e4);if(o){t.prefixedLogger.info("When handling UISI from ".concat(e.getSender()," (sender key ").concat(r.sender_key,"): ")+"recent session problem with that sender:",o);var a=vg[o.type]||vg.unknown;throw o.fixed&&(a+=" Trying to create a new secure channel and re-requesting the keys."),new wt(bt.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,a,{session:r.sender_key+"|"+r.session_id})}throw new wt(bt.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",{session:r.sender_key+"|"+r.session_id})}n.untrusted||t.removeEventFromPendingList(e);var l=JSON.parse(n.result);if(l.room_id!==e.getRoomId())throw new wt(bt.MEGOLM_BAD_ROOM,"Message intended for room "+l.room_id);return{clearEvent:l,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted}})()}requestKeysForEvent(e){var t=e.getWireContent(),r=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)}addEventToPendingList(e){var t,r=e.getWireContent(),n=r.sender_key,s=r.session_id;this.pendingEvents.has(n)||this.pendingEvents.set(n,new Map);var o=this.pendingEvents.get(n);o.has(s)||o.set(s,new Set),(t=o.get(s))===null||t===void 0||t.add(e)}removeEventFromPendingList(e){var t=e.getWireContent(),r=t.sender_key,n=t.session_id,s=this.pendingEvents.get(r),o=s==null?void 0:s.get(n);o&&(o.delete(e),o.size===0&&s.delete(n),s.size===0&&this.pendingEvents.delete(r))}roomKeyFromEvent(e){var t=e.getSenderKey(),r=e.getContent(),n={};if(!r.room_id||!r.session_key||!r.session_id||!r.algorithm){this.prefixedLogger.error("key event is missing fields");return}if(!mh(e)){this.prefixedLogger.error("key event not properly encrypted");return}r["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0);var s={senderKey:t,sessionId:r.session_id,sessionKey:r.session_key,extraSessionData:n,exportFormat:!1,roomId:r.room_id,algorithm:r.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()};return s}forwardedRoomKeyFromEvent(e){var t=this.roomKeyFromEvent(e);if(t){var r=e.getSenderKey(),n=e.getContent(),s=this.baseApis.crypto.deviceList.getUserByIdentityKey(kt,r),o=n.sender_key,a=n.sender_claimed_ed25519_key,l=Array.isArray(n.forwarding_curve25519_key_chain)?n.forwarding_curve25519_key_chain:[];if(l=l.slice(),l.push(r),s!==e.getSender()){this.prefixedLogger.error("sending device does not belong to the user it claims to be from");return}if(!o){this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");return}if(!a){this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");return}var u={ed25519:a};return t.senderKey=o,t.keysClaimed=u,t.exportFormat=!0,t.forwardingKeyChain=l,t.extraSessionData.untrusted=!0,t}}shouldAcceptForwardedKey(e,t){var r=this;return S(function*(){var n,s=e.getSenderKey(),o=(n=r.crypto.deviceList.getDeviceByIdentityKey(kt,s))!==null&&n!==void 0?n:void 0,a=r.crypto.checkDeviceInfoTrust(e.getSender(),o),l=e.getSender()===r.baseApis.getUserId(),u=a.isVerified()&&l,c=yield r.wasRoomKeyRequested(e,t),d=r.wasRoomKeyForwardedByInviter(e,t),h=r.wasRoomKeyForwardedAsHistory(t);return c&&u||d&&h})()}wasRoomKeyRequested(e,t){var r=this;return S(function*(){var n=yield r.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[Ge.Sent]);return n.some(s=>s.requestBody.room_id===t.roomId&&s.requestBody.session_id===t.sessionId)})()}wasRoomKeyForwardedByInviter(e,t){var r,n,s,o=this.baseApis.getRoom(t.roomId),a=e.getSenderKey();if(!a)return!1;var l=this.crypto.deviceList.getUserByIdentityKey(kt,a);if(!l)return!1;var u=o==null||(r=o.getMember(this.userId))===null||r===void 0?void 0:r.events.member,c=(u==null?void 0:u.getSender())===l||(u==null||(n=u.getUnsigned())===null||n===void 0?void 0:n.prev_sender)===l&&(u==null||(s=u.getPrevContent())===null||s===void 0?void 0:s.membership)===Oe.Invite;return!!(o&&c)}wasRoomKeyForwardedAsHistory(e){var t=this.baseApis.getRoom(e.roomId);return!!(t&&e.extraSessionData.sharedHistory)}shouldParkForwardedKey(e){var t=this.baseApis.getRoom(e.roomId);return!!(!t&&e.extraSessionData.sharedHistory)}parkForwardedKey(e,t){var r=this;return S(function*(){var n={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};yield r.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],s=>r.crypto.cryptoStore.addParkedSharedHistory(t.roomId,n,s),p.getChild("[addParkedSharedHistory]"))})()}addRoomKey(e){var t=this;return S(function*(){try{yield t.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),(yield t.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted))&&t.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),yield t.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(r){t.prefixedLogger.error("Error handling m.room_key_event: ".concat(r))}})()}onForwardedRoomKey(e){var t=this;return S(function*(){var r=t.forwardedRoomKeyFromEvent(e);r&&((yield t.shouldAcceptForwardedKey(e,r))?yield t.addRoomKey(r):t.shouldParkForwardedKey(r)&&(yield t.parkForwardedKey(e,r)))})()}onRoomKeyEvent(e){var t=this;return S(function*(){if(e.getType()=="m.forwarded_room_key")yield t.onForwardedRoomKey(e);else{var r=t.roomKeyFromEvent(e);if(!r)return;yield t.addRoomKey(r)}})()}onRoomKeyWithheldEvent(e){var t=this;return S(function*(){var r=e.getContent(),n=r.sender_key;r.code==="m.no_olm"?yield t.onNoOlmWithheldEvent(e):r.code==="m.unavailable"||(yield t.olmDevice.addInboundGroupSessionWithheld(r.room_id,n,r.session_id,r.code,r.reason)),r.session_id?yield t.retryDecryption(n,r.session_id):yield t.retryDecryptionFromSender(n)})()}onNoOlmWithheldEvent(e){var t=this;return S(function*(){var r=e.getContent(),n=r.sender_key,s=e.getSender();if(t.prefixedLogger.warn("".concat(s,":").concat(n," was unable to establish an olm session with us")),yield t.olmDevice.getSessionIdForDevice(n)){t.prefixedLogger.debug("New session already created.  Not creating a new one."),yield t.olmDevice.recordSessionProblem(n,"no_olm",!0);return}var o=t.crypto.deviceList.getDeviceByIdentityKey(r.algorithm,n);if(!o&&(yield t.crypto.downloadKeys([s],!1),o=t.crypto.deviceList.getDeviceByIdentityKey(r.algorithm,n),!o)){t.prefixedLogger.info("Couldn't find device for identity key "+n+": not establishing session"),yield t.olmDevice.recordSessionProblem(n,"no_olm",!1);return}yield Rn(t.olmDevice,t.baseApis,new Map([[s,[o]]]),!1);var a={algorithm:kt,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[Zt]:Ar()};yield Xn(a.ciphertext,t.userId,void 0,t.olmDevice,s,o,{type:"m.dummy"}),yield t.olmDevice.recordSessionProblem(n,"no_olm",!0),yield t.baseApis.sendToDevice("m.room.encrypted",new Map([[s,new Map([[o.deviceId,a]])]]))})()}hasKeysForKeyRequest(e){var t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){var t=e.userId,r=e.deviceId,n=this.crypto.getStoredDevice(t,r),s=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[n]]])).then(o=>{var a,l=(a=o.get(t))===null||a===void 0?void 0:a.get(r);return l!=null&&l.sessionId?(this.prefixedLogger.debug("sharing keys for session "+s.sender_key+"|"+s.session_id+" with device "+t+":"+r),this.buildKeyForwardingMessage(s.room_id,s.sender_key,s.session_id)):null}).then(o=>{var a={algorithm:kt,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[Zt]:Ar()};return this.olmlib.encryptMessageForDevice(a.ciphertext,this.userId,void 0,this.olmDevice,t,n,o).then(()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[r,a]])]])))})}buildKeyForwardingMessage(e,t,r){var n=this;return S(function*(){var s=yield n.olmDevice.getInboundGroupSessionKey(e,t,r);return{type:"m.forwarded_room_key",content:{algorithm:nr,room_id:e,sender_key:t,sender_claimed_ed25519_key:s.sender_claimed_ed25519_key,session_id:r,session_key:s.key,chain_index:s.chain_index,forwarding_curve25519_key_chain:s.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":s.shared_history||!1}}})()}importRoomKey(e){var{untrusted:t,source:r}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={};return(t||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then(()=>{r!=="backup"&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch(s=>{this.prefixedLogger.debug("Failed to back up megolm session",s)}),this.retryDecryption(e.sender_key,e.session_id,!n.untrusted)})}retryDecryption(e,t,r){var n=this;return S(function*(){var s,o=n.pendingEvents.get(e);if(!o)return!0;var a=o.get(t);if(!a)return!0;var l=[...a];return n.prefixedLogger.debug("Retrying decryption on events:",l.map(u=>"".concat(u.getId()))),yield Promise.all(l.map(function(){var u=S(function*(c){try{yield c.attemptDecryption(n.crypto,{isRetry:!0,forceRedecryptIfUntrusted:r})}catch{}});return function(c){return u.apply(this,arguments)}}())),!((s=n.pendingEvents.get(e))!==null&&s!==void 0&&s.has(t))})()}retryDecryptionFromSender(e){var t=this;return S(function*(){var r=t.pendingEvents.get(e);return r?(t.pendingEvents.delete(e),yield Promise.all([...r].map(function(){var n=S(function*(s){var[o,a]=s;yield Promise.all([...a].map(function(){var l=S(function*(u){try{yield u.attemptDecryption(t.crypto)}catch{}});return function(u){return l.apply(this,arguments)}}()))});return function(s){return n.apply(this,arguments)}}())),!t.pendingEvents.has(e)):!0})()}sendSharedHistoryInboundSessions(e){var t=this;return S(function*(){yield Rn(t.olmDevice,t.baseApis,e);var r=yield t.olmDevice.getSharedHistoryInboundGroupSessions(t.roomId);t.prefixedLogger.debug("Sharing history in with users ".concat(Array.from(e.keys())),r.map(_=>{var[T,b]=_;return"".concat(T,"|").concat(b)}));for(var[n,s]of r){var o=yield t.buildKeyForwardingMessage(t.roomId,n,s),a=[],l=new Map;for(var[u,c]of e){var d=new Map;l.set(u,d);for(var h of c){var g={algorithm:kt,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[Zt]:Ar()};d.set(h.deviceId,g),a.push(Xn(g.ciphertext,t.userId,void 0,t.olmDevice,u,h,o))}}yield Promise.all(a);for(var[v,m]of l){for(var[E,R]of m)HI(R)||(t.prefixedLogger.debug("No ciphertext for device "+v+":"+E+": pruning"),m.delete(E));m.size===0&&(t.prefixedLogger.debug("Pruned all devices for user "+v),l.delete(v))}if(l.size===0){t.prefixedLogger.debug("No users left to send to: aborting");return}yield t.baseApis.sendToDevice("m.room.encrypted",l)}})()}}var vg={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};RS(nr,zI,JI);class gg{constructor(e,t){f(this,"accountDataClientAdapter",void 0),f(this,"crossSigningCallbacks",void 0),f(this,"ssssCryptoCallbacks",void 0),f(this,"crossSigningKeys",void 0),f(this,"keySignatures",void 0),f(this,"keyBackupInfo",void 0),f(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new QI(e),this.crossSigningCallbacks=new XI,this.ssssCryptoCallbacks=new ZI(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,r){this.keySignatures||(this.keySignatures={});var n=this.keySignatures[e]||{};this.keySignatures[e]=n,n[t]=r}setAccountData(e,t){var r=this;return S(function*(){yield r.accountDataClientAdapter.setAccountData(e,t)})()}buildOperation(){var e=this.accountDataClientAdapter.values;return new YI(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}persist(e){var t=this;return S(function*(){if(t.crossSigningKeys){var r=_S(e.cryptoStore,e.olmDevice);for(var n of["master","self_signing","user_signing"]){var s;p.log("Cache ".concat(n," cross-signing private key locally"));var o=t.crossSigningCallbacks.privateKeys.get(n);yield(s=r.storeCrossSigningKeyCache)===null||s===void 0?void 0:s.call(r,n,o)}yield e.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],a=>{e.cryptoStore.storeCrossSigningKeys(a,t.crossSigningKeys.keys)})}t.sessionBackupPrivateKey&&(yield e.storeSessionBackupPrivateKey(t.sessionBackupPrivateKey))})()}}class YI{constructor(e,t,r,n){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=r,this.keySignatures=n}apply(e){var t=this;return S(function*(){var r=e.baseApis;if(t.crossSigningKeys){var n,s,o={};for(var[a,l]of Object.entries(t.crossSigningKeys.keys))o[a+"_key"]=l;yield(n=(s=t.crossSigningKeys).authUpload)===null||n===void 0?void 0:n.call(s,d=>r.uploadDeviceSigningKeys(d??void 0,o)),e.crossSigningInfo.setKeys(t.crossSigningKeys.keys)}if(t.accountData)for(var[u,c]of t.accountData)yield r.setAccountData(u,c);t.keySignatures&&(yield r.uploadKeySignatures(t.keySignatures)),t.keyBackupInfo&&(t.keyBackupInfo.version?yield r.http.authedRequest(z.Put,"/room_keys/version/"+t.keyBackupInfo.version,void 0,{algorithm:t.keyBackupInfo.algorithm,auth_data:t.keyBackupInfo.auth_data},{prefix:vt.V3}):yield r.http.authedRequest(z.Post,"/room_keys/version",void 0,t.keyBackupInfo,{prefix:vt.V3}),yield e.backupManager.checkKeyBackup())})()}}class QI extends rt{constructor(e){super(),this.existingValues=e,f(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){var t=this.values.get(e);if(t)return t;var r=this.existingValues.get(e);return r?r.getContent():null}setAccountData(e,t){var r=this.values.get(e);return this.values.set(e,t),Promise.resolve().then(()=>{var n=new Ot({type:e,content:t});return this.emit(_e.AccountData,n,r),{}})}}class XI{constructor(){f(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){var r;return Promise.resolve((r=this.privateKeys.get(e))!==null&&r!==void 0?r:null)}saveCrossSigningKeys(e){for(var[t,r]of Object.entries(e))this.privateKeys.set(t,r)}}class ZI{constructor(e){this.delegateCryptoCallbacks=e,f(this,"privateKeys",new Map)}getSecretStorageKey(e,t){var r=this;return S(function*(){var n,{keys:s}=e;for(var o of Object.keys(s)){var a=r.privateKeys.get(o);if(a)return[o,a]}if(r!=null&&(n=r.delegateCryptoCallbacks)!==null&&n!==void 0&&n.getSecretStorageKey){var l=yield r.delegateCryptoCallbacks.getSecretStorageKey({keys:s},t);if(l){var[u,c]=l;r.privateKeys.set(u,c)}return l}return null})()}addPrivateKey(e,t,r){var n,s;this.privateKeys.set(e,r),(n=this.delegateCryptoCallbacks)===null||n===void 0||(s=n.cacheSecretStorageKey)===null||s===void 0||s.call(n,e,t,r)}}var Jr="m.secret_storage.v1.aes-hmac-sha2";class sa{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return S(function*(){var t=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return t?t.key:null})()}setDefaultKeyId(e){return new Promise((t,r)=>{var n=s=>{s.getType()==="m.secret_storage.default_key"&&s.getContent().key===e&&(this.accountDataAdapter.removeListener(_e.AccountData,n),t())};this.accountDataAdapter.on(_e.AccountData,n),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch(s=>{this.accountDataAdapter.removeListener(_e.AccountData,n),r(s)})})}addKey(e,t,r){var n=this;return S(function*(){if(e!==Jr)throw new Error("Unknown key algorithm ".concat(e));var s={algorithm:e};t.name&&(s.name=t.name),t.passphrase&&(s.passphrase=t.passphrase);var{iv:o,mac:a}=yield us(t.key);if(s.iv=o,s.mac=a,!r)do r=Dr(32);while(yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(r)));return yield n.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(r),s),{keyId:r,keyInfo:s}})()}getKey(e){var t=this;return S(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var r=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return r?[e,r]:null})()}hasKey(e){var t=this;return S(function*(){var r=yield t.getKey(e);return!!r})()}checkKey(e,t){return S(function*(){if(t.algorithm===Jr)if(t.mac){var{mac:r}=yield us(e,t.iv);return hd(t.mac)===hd(r)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,r){var n=this;return S(function*(){var s={};if(!r){var o=yield n.getDefaultKeyId();if(!o)throw new Error("No keys specified and no default key present");r=[o]}if(r.length===0)throw new Error("Zero keys given to encrypt with!");for(var a of r){var l=yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+a);if(!l)throw new Error("Unknown key: "+a);if(l.algorithm===Jr){var u={[a]:l},[,c]=yield n.getSecretStorageKey(u,e);s[a]=yield c.encrypt(t)}else p.warn("unknown algorithm for secret storage key "+a+": "+l.algorithm)}yield n.accountDataAdapter.setAccountData(e,{encrypted:s})})()}get(e){var t=this;return S(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(r){if(!r.encrypted)throw new Error("Content is not encrypted!");var n={};for(var s of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s),a=r.encrypted[s];(o==null?void 0:o.algorithm)===Jr&&a.iv&&a.ciphertext&&a.mac&&(n[s]=o)}if(Object.keys(n).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[l,u]=yield t.getSecretStorageKey(n,e),c=r.encrypted[l];return u.decrypt(c)}})()}isStored(e){var t=this;return S(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(r!=null&&r.encrypted))return null;var n={};for(var s of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s);if(o){var a=r.encrypted[s];o.algorithm===Jr&&a.iv&&a.ciphertext&&a.mac&&(n[s]=o)}}return Object.keys(n).length?n:null})()}getSecretStorageKey(e,t){var r=this;return S(function*(){if(!r.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var n=yield r.callbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[s,o]=n;if(!e[s])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[s].algorithm===Jr){var a={encrypt:function(u){return As(u,o,t)},decrypt:function(u){return _a(u,o,t)}};return[s,a]}else throw new Error("Unknown key type: "+e[s].algorithm)})()}}function hd(i){for(var e=i.length;e>=1&&i.charCodeAt(e-1)==61;)e--;return e<i.length?i.substring(0,e):i}const e0=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:Jr,ServerSideSecretStorageImpl:sa,trimTrailingEquals:hd},Symbol.toStringTag,{value:"Module"}));class t0{constructor(e,t){this.baseApis=e,this.cryptoCallbacks=t,f(this,"requests",new Map)}request(e,t){var r=this.baseApis.makeTxnId(),n=ni();this.requests.set(r,{name:e,devices:t,deferred:n});var s=u=>{var c={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:r},d=new Map;for(var h of t)d.set(h,c);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),d]])),n.reject(new Error(u||"Cancelled"))},o={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:r,[Zt]:Ar()},a=new Map;for(var l of t)a.set(l,o);return p.info("Request secret ".concat(e," from ").concat(t,", id ").concat(r)),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),a]])),{requestId:r,promise:n.promise,cancel:s}}onRequestReceived(e){var t=this;return S(function*(){var r=e.getSender(),n=e.getContent();if(!(r!==t.baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))){var s=n.requesting_device_id;if(n.action!=="request_cancellation"){if(n.action==="request"){if(s===t.baseApis.deviceId||(p.info("received request for secret ("+r+", "+s+", "+n.request_id+")"),!t.cryptoCallbacks.onSecretRequested))return;var o=yield t.cryptoCallbacks.onSecretRequested(r,s,n.request_id,n.name,t.baseApis.checkDeviceTrust(r,s));if(o){p.info("Preparing ".concat(n.name," secret for ").concat(s));var a={type:"m.secret.send",content:{request_id:n.request_id,secret:o}},l={algorithm:kt,sender_key:t.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[Zt]:Ar()};yield Rn(t.baseApis.crypto.olmDevice,t.baseApis,new Map([[r,[t.baseApis.getStoredDevice(r,s)]]])),yield Xn(l.ciphertext,t.baseApis.getUserId(),t.baseApis.deviceId,t.baseApis.crypto.olmDevice,r,t.baseApis.getStoredDevice(r,s),a);var u=new Map([[r,new Map([[s,l]])]]);p.info("Sending ".concat(n.name," secret for ").concat(s)),t.baseApis.sendToDevice("m.room.encrypted",u)}else p.info("Request denied for ".concat(n.name," secret for ").concat(s))}}}})()}onSecretReceived(e){if(e.getSender()===this.baseApis.getUserId()){if(!mh(e)){p.error("secret event not properly encrypted");return}var t=e.getContent(),r=this.baseApis.crypto.deviceList.getUserByIdentityKey(kt,e.getSenderKey()||"");if(r!==e.getSender()){p.error("sending device does not belong to the user it claims to be from");return}p.log("got secret share for request",t.request_id);var n=this.requests.get(t.request_id);if(n){var s=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(kt,e.getSenderKey());if(!s){p.log("secret share from unknown device with key",e.getSenderKey());return}if(!n.devices.includes(s.deviceId)){p.log("unsolicited secret share from device",s.deviceId);return}var o=this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),s);if(!o.isVerified()){p.log("secret share from unverified device");return}p.log("Successfully received secret ".concat(n.name," ")+"from ".concat(s.deviceId)),n.deferred.resolve(t.secret)}}}}class r0{constructor(e,t,r){f(this,"storageImpl",void 0),f(this,"sharingImpl",void 0),this.storageImpl=new sa(e,t),this.sharingImpl=new t0(r,t)}getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(e){return this.storageImpl.setDefaultKeyId(e)}addKey(e,t,r){return this.storageImpl.addKey(e,t,r)}getKey(e){return this.storageImpl.getKey(e)}hasKey(e){return this.storageImpl.hasKey(e)}checkKey(e,t){return this.storageImpl.checkKey(e,t)}store(e,t,r){return this.storageImpl.store(e,t,r)}get(e){return this.storageImpl.get(e)}isStored(e){var t=this;return S(function*(){return t.storageImpl.isStored(e)})()}request(e,t){return this.sharingImpl.request(e,t)}onRequestReceived(e){return this.sharingImpl.onRequestReceived(e)}onSecretReceived(e){this.sharingImpl.onSecretReceived(e)}}function n0(i,e,t){var r=Object.assign({},{code:i,reason:e},t);return new Ot({type:F.KeyVerificationCancel,content:r})}function Cn(i,e){return function(t){return n0(i,e,t)}}var IS=Cn("m.user","Cancelled by user"),i0=Cn("m.timeout","Timed out"),qo=Cn("m.unknown_method","Unknown method"),CS=Cn("m.unexpected_message","Unexpected message"),Ci=Cn("m.key_mismatch","Key mismatch"),s0=Cn("m.invalid_message","Invalid message");function fd(i){var e=i.getContent();if(e){var{code:t,reason:r}=e;return{code:t,reason:r}}else return{code:"Unknown error",reason:"m.unknown"}}var pg=new Error("Verification timed out");class vd extends Error{constructor(e){super(),this.startEvent=e}}var o0=su;class bh extends rt{constructor(e,t,r,n,s,o){super(),this.channel=e,this.baseApis=t,this.userId=r,this.deviceId=n,this.startEvent=s,this.request=o,f(this,"cancelled",!1),f(this,"_done",!1),f(this,"promise",null),f(this,"transactionTimeoutTimer",null),f(this,"expectedEvent",void 0),f(this,"resolve",void 0),f(this,"reject",void 0),f(this,"resolveEvent",void 0),f(this,"rejectEvent",void 0),f(this,"started",void 0),f(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;var e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){p.info("Refreshing/starting the verification transaction timeout timer"),this.transactionTimeoutTimer!==null&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{!this._done&&!this.cancelled&&(p.info("Triggering verification timeout"),this.cancel(pg))},10*60*1e3)}endTimer(){this.transactionTimeoutTimer!==null&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));var t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise((r,n)=>{this.resolveEvent=r,this.rejectEvent=n}))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(p.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){var t=this.rejectEvent;this.rejectEvent=void 0,t(new vd(e))}else this.startEvent=e}handleEvent(e){if(!this._done){if(e.getType()===this.expectedEvent){if(this.expectedEvent!==F.KeyVerificationDone){var t;this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),(t=this.resolveEvent)===null||t===void 0||t.call(this,e)}}else if(e.getType()===F.KeyVerificationCancel){var r=this.reject;if(this.reject=void 0,r){var n=e.getContent(),{reason:s,code:o}=n;r(new Error("Other side cancelled verification "+"because ".concat(s," (").concat(o,")")))}}else if(this.expectedEvent){var a=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){var l=this.rejectEvent;this.rejectEvent=void 0,l(a)}this.cancel(a)}}}done(){var e=this;return S(function*(){if(e.endTimer(),!e._done){var t;return e.request.onVerifierFinished(),(t=e.resolve)===null||t===void 0||t.call(e),LI(e.baseApis,e.userId,e.deviceId)}})()}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===pg){var t=i0();this.send(t.getType(),t.getContent())}else if(e instanceof Ot){var r=e.getSender();if(r!==this.userId){var n=e.getContent();e.getType()===F.KeyVerificationCancel?(n.code=n.code||"m.unknown",n.reason=n.reason||n.body||"Unknown reason",this.send(F.KeyVerificationCancel,n)):this.send(F.KeyVerificationCancel,{code:"m.unknown",reason:n.body||"Unknown reason"})}}else this.send(F.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()});this.promise!==null?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(o0.Cancel,e)}}verify(){var e=this;return this.promise?this.promise:(this.promise=new Promise((t,r)=>{this.resolve=function(){e._done=!0,e.endTimer(),t(...arguments)},this.reject=n=>{this._done=!0,this.endTimer(),r(n)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise((t,r)=>{var n,s=(n=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))===null||n===void 0?void 0:n.getId();s===this.deviceId&&r(new Error("Device ID is the same as the cross-signing ID")),t()}).then(()=>this.doVerification()).then(this.done.bind(this),this.cancel.bind(this))),this.promise)}verifyKeys(e,t,r){var n=this;return S(function*(){var s=[];for(var[o,a]of Object.entries(t)){var l=o.split(":",2)[1],u=n.baseApis.getStoredDevice(e,l);if(u)r(o,u,a),s.push([l,o,u.keys[o]]);else{var c=n.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===l?(r(o,er.fromStorage({keys:{[o]:l}},l),a),s.push([l,o,l])):p.warn("verification: Could not find device ".concat(l," to verify"))}}if(!s.length)throw new Error("No devices could be verified");p.info("Verification completed! Marking devices verified: ",s);for(var[d,h,g]of s)yield n.baseApis.crypto.setDeviceVerification(e,d,!0,null,null,{[h]:g});e==n.baseApis.credentials.userId&&(yield n.baseApis.checkKeyBackup())})()}get events(){}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}var Eh=function(i){return i.Sas="m.sas.v1",i.ShowQrCode="m.qr_code.show.v1",i.ScanQrCode="m.qr_code.scan.v1",i.Reciprocate="m.reciprocate.v1",i}({}),a0=Eh.ShowQrCode,kS=Eh.ScanQrCode,l0=su;class oa extends bh{constructor(){var e;super(...arguments),e=this,f(this,"reciprocateQREvent",void 0),f(this,"doVerification",S(function*(){if(!e.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");var{qrCodeData:t}=e.request;if(e.startEvent.getContent().secret!==(t==null?void 0:t.encodedSharedSecret))throw Ci();yield new Promise((a,l)=>{e.reciprocateQREvent={confirm:a,cancel:()=>l(IS())},e.emit(l0.ShowReciprocateQr,e.reciprocateQREvent)});var r={};switch(t==null?void 0:t.mode){case fr.VerifyOtherUser:{var n=t.otherUserMasterKey;r["ed25519:".concat(n)]=n;break}case fr.VerifySelfTrusted:{var s=e.request.targetDevice.deviceId;r["ed25519:".concat(s)]=t.otherDeviceKey;break}case fr.VerifySelfUntrusted:{var o=t.myMasterKey;r["ed25519:".concat(o)]=o;break}}yield e.verifyKeys(e.userId,r,(a,l,u)=>{var c=r[a];if(!c)throw Ci();if(u!==c)throw p.error("key ID from key info does not match"),Ci();for(var d in l.keys)if(d.startsWith("ed25519")){var h=r[d];if(!h)throw Ci();if(l.keys[d]!==h)throw p.error("master key does not match"),Ci()}})}))}static factory(e,t,r,n,s,o){return new oa(e,t,r,n,s,o)}static get NAME(){return"m.reciprocate.v1"}getReciprocateQrCodeCallbacks(){var e;return(e=this.reciprocateQREvent)!==null&&e!==void 0?e:null}}var u0=2,c0="MATRIX",fr=function(i){return i[i.VerifyOtherUser=0]="VerifyOtherUser",i[i.VerifySelfTrusted=1]="VerifySelfTrusted",i[i.VerifySelfUntrusted=2]="VerifySelfUntrusted",i}(fr||{});class qn{constructor(e,t,r,n,s,o){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=r,this.otherDeviceKey=n,this.myMasterKey=s,this.buffer=o}static create(e,t){return S(function*(){var r=qn.generateSharedSecret(),n=qn.determineMode(e,t),s=null,o=null,a=null;if(n===fr.VerifyOtherUser){var l=t.getStoredCrossSigningForUser(e.otherUserId);s=l.getId("master")}else if(n===fr.VerifySelfTrusted)o=yield qn.getOtherDeviceKey(e,t);else if(n===fr.VerifySelfUntrusted){var u=t.getUserId(),c=t.getStoredCrossSigningForUser(u);a=c.getId("master")}var d=qn.generateQrData(e,t,n,r,s,o,a),h=qn.generateBuffer(d);return new qn(n,r,s,o,a,h)})()}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){var e=new Uint8Array(11);return Tn.getRandomValues(e),tu(e)}static getOtherDeviceKey(e,t){return S(function*(){var r=t.getUserId(),n=e.targetDevice,s=n.deviceId?t.getStoredDevice(r,n.deviceId):void 0;if(!s)throw new Error("could not find device "+(n==null?void 0:n.deviceId));return s.getFingerprint()})()}static determineMode(e,t){var r=t.getUserId(),n=e.otherUserId,s=fr.VerifyOtherUser;if(r===n){var o=t.checkUserTrust(r);o.isCrossSigningVerified()?s=fr.VerifySelfTrusted:s=fr.VerifySelfUntrusted}return s}static generateQrData(e,t,r,n,s,o,a){var l=t.getUserId(),u=e.channel.transactionId,c={prefix:c0,version:u0,mode:r,transactionId:u,firstKeyB64:"",secondKeyB64:"",secretB64:n},d=t.getStoredCrossSigningForUser(l);return r===fr.VerifyOtherUser?(c.firstKeyB64=d.getId("master"),c.secondKeyB64=s):r===fr.VerifySelfTrusted?(c.firstKeyB64=d.getId("master"),c.secondKeyB64=o):r===fr.VerifySelfUntrusted&&(c.firstKeyB64=t.getDeviceEd25519Key(),c.secondKeyB64=a),c}static generateBuffer(e){var t=Buffer.alloc(0),r=a=>{var l=Buffer.from([a]);t=Buffer.concat([t,l])},n=a=>{var l=Buffer.alloc(2);l.writeInt16BE(a,0),t=Buffer.concat([t,l])},s=function(l,u){var c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,d=Buffer.from(l,u);c&&n(d.byteLength),t=Buffer.concat([t,d])},o=a=>{var l=At(a),u=Buffer.from(l);t=Buffer.concat([t,u])};return s(e.prefix,"ascii",!1),r(e.version),r(e.mode),s(e.transactionId,"utf-8"),o(e.firstKeyB64),o(e.secondKeyB64),o(e.secretB64),t}}function d0(i){return[(i[0]<<5|i[1]>>3)+1e3,((i[1]&7)<<10|i[2]<<2|i[3]>>6)+1e3,((i[3]&63)<<7|i[4]>>1)+1e3]}var Qu=F.KeyVerificationStart,h0=[F.KeyVerificationAccept,F.KeyVerificationKey,F.KeyVerificationMac],Fa,f0=Cn("m.mismatched_sas","Mismatched short authentication string"),v0=Cn("m.mismatched_commitment","Mismatched commitment"),g0=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];function p0(i){var e=[i[0]>>2,(i[0]&3)<<4|i[1]>>4,(i[1]&15)<<2|i[2]>>6,i[2]&63,i[3]>>2,(i[3]&3)<<4|i[4]>>4,(i[4]&15)<<2|i[5]>>6];return e.map(t=>g0[t])}var gd={decimal:d0,emoji:p0};function m0(i,e){var t={};for(var r of e)r in gd&&(t[r]=gd[r](Array.from(i)));return t}var y0={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function Qs(i,e){return function(t,r){var n=i[y0[e]](t,r);return p.log("SAS calculateMAC:",e,[t,r],n),n}}var S0={"curve25519-hkdf-sha256":function(e,t,r){var n="".concat(e.baseApis.getUserId(),"|").concat(e.baseApis.deviceId,"|")+"".concat(e.ourSASPubKey,"|"),s="".concat(e.userId,"|").concat(e.deviceId,"|").concat(e.theirSASPubKey,"|"),o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+s:s+n)+e.channel.transactionId;return t.generate_bytes(o,r)},curve25519:function(e,t,r){var n="".concat(e.baseApis.getUserId()).concat(e.baseApis.deviceId),s="".concat(e.userId).concat(e.deviceId),o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+s:s+n)+e.channel.transactionId;return t.generate_bytes(o,r)}},pd=["curve25519-hkdf-sha256","curve25519"],md=["sha256"],yd=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],OS=Object.keys(gd),_0=new Set(pd),b0=new Set(md),E0=new Set(yd),mg=new Set(OS);function Xs(i,e){return Array.isArray(i)?i.filter(t=>e.has(t)):[]}var w0=su;class ws extends bh{constructor(){var e;super(...arguments),e=this,f(this,"waitingForAccept",void 0),f(this,"ourSASPubKey",void 0),f(this,"theirSASPubKey",void 0),f(this,"sasEvent",void 0),f(this,"doVerification",S(function*(){yield global.Olm.init(),Fa=Fa||new global.Olm.Utility,yield e.baseApis.downloadKeys([e.userId]);var t=!1;do try{return e.initiatedByMe?yield e.doSendVerification():yield e.doRespondVerification()}catch(r){if(r instanceof vd)e.startEvent=r.startEvent,t=!0;else throw r}while(t)}))}static get NAME(){return Eh.Sas}get events(){return h0}canSwitchStartEvent(e){if(e.getType()!==Qu)return!1;var t=e.getContent();return(t==null?void 0:t.method)===ws.NAME&&!!this.waitingForAccept}sendStart(){var e=this;return S(function*(){var t=e.channel.completeContent(Qu,{method:ws.NAME,from_device:e.baseApis.deviceId,key_agreement_protocols:pd,hashes:md,message_authentication_codes:yd,short_authentication_string:OS});return yield e.channel.sendCompleted(Qu,t),t})()}verifyAndCheckMAC(e,t,r,n){var s=this;return S(function*(){var o=S0[e](s,r,6),a=new Promise((c,d)=>{s.sasEvent={sas:m0(o,t),confirm:function(){var h=S(function*(){try{yield s.sendMAC(r,n),c()}catch(v){d(v)}});function g(){return h.apply(this,arguments)}return g}(),cancel:()=>d(IS()),mismatch:()=>d(f0())},s.emit(w0.ShowSas,s.sasEvent)}),[l]=yield Promise.all([s.waitForEvent(F.KeyVerificationMac).then(c=>(s.expectedEvent=F.KeyVerificationDone,c)),a]),u=l.getContent();yield s.checkMAC(r,u,n)})()}doSendVerification(){var e=this;return S(function*(){e.waitingForAccept=!0;var t;if(e.startEvent?t=e.channel.completedContentFromEvent(e.startEvent):t=yield e.sendStart(),!e.initiatedByMe)throw new vd(e.startEvent);var r;try{r=yield e.waitForEvent(F.KeyVerificationAccept)}finally{e.waitingForAccept=!1}var n=r.getContent(),s=Xs(n.short_authentication_string,mg);if(!(_0.has(n.key_agreement_protocol)&&b0.has(n.hash)&&E0.has(n.message_authentication_code)&&s.length))throw qo();if(typeof n.commitment!="string")throw s0();var o=n.key_agreement_protocol,a=n.message_authentication_code,l=n.commitment,u=new global.Olm.SAS;try{e.ourSASPubKey=u.get_pubkey(),yield e.send(F.KeyVerificationKey,{key:e.ourSASPubKey}),r=yield e.waitForEvent(F.KeyVerificationKey),n=r.getContent();var c=n.key+wn.stringify(t);if(Fa.sha256(c)!==l)throw v0();e.theirSASPubKey=n.key,u.set_their_key(n.key),yield e.verifyAndCheckMAC(o,s,u,a)}finally{u.free()}})()}doRespondVerification(){var e=this;return S(function*(){var t=e.channel.completedContentFromEvent(e.startEvent),r=Xs(pd,new Set(t.key_agreement_protocols))[0],n=Xs(md,new Set(t.hashes))[0],s=Xs(yd,new Set(t.message_authentication_codes))[0],o=Xs(t.short_authentication_string,mg);if(!(r!==void 0&&n!==void 0&&s!==void 0&&o.length))throw qo();var a=new global.Olm.SAS;try{var l=a.get_pubkey()+wn.stringify(t);yield e.send(F.KeyVerificationAccept,{key_agreement_protocol:r,hash:n,message_authentication_code:s,short_authentication_string:o,commitment:Fa.sha256(l)});var u=yield e.waitForEvent(F.KeyVerificationKey);t=u.getContent(),e.theirSASPubKey=t.key,a.set_their_key(t.key),e.ourSASPubKey=a.get_pubkey(),yield e.send(F.KeyVerificationKey,{key:e.ourSASPubKey}),yield e.verifyAndCheckMAC(r,o,a,s)}finally{a.free()}})()}sendMAC(e,t){var r={},n=[],s="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,o="ed25519:".concat(this.baseApis.deviceId);r[o]=Qs(e,t)(this.baseApis.getDeviceEd25519Key(),s+o),n.push(o);var a=this.baseApis.getCrossSigningId();if(a){var l="ed25519:".concat(a);r[l]=Qs(e,t)(a,s+l),n.push(l)}var u=Qs(e,t)(n.sort().join(","),s+"KEY_IDS");return this.send(F.KeyVerificationMac,{mac:r,keys:u})}checkMAC(e,t,r){var n=this;return S(function*(){var s="MATRIX_KEY_VERIFICATION_MAC"+n.userId+n.deviceId+n.baseApis.getUserId()+n.baseApis.deviceId+n.channel.transactionId;if(t.keys!==Qs(e,r)(Object.keys(t.mac).sort().join(","),s+"KEY_IDS"))throw Ci();yield n.verifyKeys(n.userId,t.mac,(o,a,l)=>{if(l!==Qs(e,r)(a.keys[o],s+o))throw Ci()})})()}getShowSasCallbacks(){var e;return(e=this.sasEvent)!==null&&e!==void 0?e:null}}var yg=5e5,wh=256;function Sg(i,e){if(!global.Olm)throw new Error("Olm is not available");if(!i.private_key_salt||!i.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return PS(e,i.private_key_salt,i.private_key_iterations,i.private_key_bits||wh)}function Rh(i){return Sd.apply(this,arguments)}function Sd(){return Sd=S(function*(i){if(!global.Olm)throw new Error("Olm is not available");var e=Dr(32),t=yield PS(i,e,yg,wh);return{key:t,salt:e,iterations:yg}}),Sd.apply(this,arguments)}function PS(i,e,t){return _d.apply(this,arguments)}function _d(){return _d=S(function*(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:wh;if(!Xt||!$n)throw new Error("Password-based backup is not available on this platform");var n=yield Xt.importKey("raw",new $n().encode(i),{name:"PBKDF2"},!1,["deriveBits"]),s=yield Xt.deriveBits({name:"PBKDF2",salt:new $n().encode(e),iterations:t,hash:"SHA-512"},n,r);return new Uint8Array(s)}),_d.apply(this,arguments)}var Xu,_g;function R0(){if(_g)return Xu;_g=1;function i(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var n=0;n<e.length;n++){var s=e.charAt(n),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=n}var a=e.length,l=e.charAt(0),u=Math.log(a)/Math.log(256),c=Math.log(256)/Math.log(a);function d(v){if(v instanceof Uint8Array||(ArrayBuffer.isView(v)?v=new Uint8Array(v.buffer,v.byteOffset,v.byteLength):Array.isArray(v)&&(v=Uint8Array.from(v))),!(v instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(v.length===0)return"";for(var m=0,E=0,R=0,_=v.length;R!==_&&v[R]===0;)R++,m++;for(var T=(_-R)*c+1>>>0,b=new Uint8Array(T);R!==_;){for(var I=v[R],y=0,C=T-1;(I!==0||y<E)&&C!==-1;C--,y++)I+=256*b[C]>>>0,b[C]=I%a>>>0,I=I/a>>>0;if(I!==0)throw new Error("Non-zero carry");E=y,R++}for(var w=T-E;w!==T&&b[w]===0;)w++;for(var D=l.repeat(m);w<T;++w)D+=e.charAt(b[w]);return D}function h(v){if(typeof v!="string")throw new TypeError("Expected String");if(v.length===0)return new Uint8Array;for(var m=0,E=0,R=0;v[m]===l;)E++,m++;for(var _=(v.length-m)*u+1>>>0,T=new Uint8Array(_);v[m];){var b=t[v.charCodeAt(m)];if(b===255)return;for(var I=0,y=_-1;(b!==0||I<R)&&y!==-1;y--,I++)b+=a*T[y]>>>0,T[y]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");R=I,m++}for(var C=_-R;C!==_&&T[C]===0;)C++;for(var w=new Uint8Array(E+(_-C)),D=E;C!==_;)w[D++]=T[C++];return w}function g(v){var m=h(v);if(m)return m;throw new Error("Non-base"+a+" character")}return{encode:d,decodeUnsafe:h,decode:g}}return Xu=i,Xu}var Zu,bg;function T0(){return bg||(bg=1,Zu=R0()("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")),Zu}var MS=T0(),Vn=[139,1],Eg=32;function bd(i){var e,t=Buffer.alloc(Vn.length+i.length+1);t.set(Vn,0),t.set(i,Vn.length);for(var r=0,n=0;n<t.length-1;++n)r^=t[n];t[t.length-1]=r;var s=MS.encode(t);return(e=s.match(/.{1,4}/g))===null||e===void 0?void 0:e.join(" ")}function Za(i){var e=MS.decode(i.replace(/ /g,"")),t=0;for(var r of e)t^=r;if(t!==0)throw new Error("Incorrect parity");for(var n=0;n<Vn.length;++n)if(e[n]!==Vn[n])throw new Error("Incorrect prefix");if(e.length!==Vn.length+Eg+1)throw new Error("Incorrect length");return Uint8Array.from(e.slice(Vn.length,Vn.length+Eg))}var I0=10*60*1e3,C0=2*60*1e3,k0=3*1e3,Ds="m.key.verification.",We=Ds+"request",Tt=Ds+"start",Or=Ds+"cancel",O0=Ds+"done",Ir=Ds+"ready",nn=ii.Unsent,wr=ii.Requested,Wr=ii.Ready,hn=ii.Started,Zs=ii.Cancelled,eo=ii.Done;class ki extends rt{constructor(e,t,r){var n;super(),n=this,this.channel=e,this.verificationMethods=t,this.client=r,f(this,"eventsByUs",new Map),f(this,"eventsByThem",new Map),f(this,"_observeOnly",!1),f(this,"timeoutTimer",null),f(this,"_accepting",!1),f(this,"_declining",!1),f(this,"verifierHasFinished",!1),f(this,"_cancelled",!1),f(this,"_chosenMethod",null),f(this,"_qrCodeData",null),f(this,"requestReceivedAt",null),f(this,"commonMethods",[]),f(this,"_phase",void 0),f(this,"_cancellingUserId",void 0),f(this,"_verifier",void 0),f(this,"cancelOnTimeout",S(function*(){try{n.initiatedByMe?yield n.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):yield n.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(s){p.error("Error while cancelling verification request",s)}})),this.channel.request=this,this.setPhase(nn,!1)}static validateEvent(e,t,r){var n=t.getContent();return!e||!e.startsWith(Ds)?!1:n?(e===We||e===Ir)&&!Array.isArray(n.methods)?(p.log("VerificationRequest: validateEvent: fail because methods"),!1):(e===We||e===Ir||e===Tt)&&(typeof n.from_device!="string"||n.from_device.length===0)?(p.log("VerificationRequest: validateEvent: fail because from_device"),!1):!0:(p.log("VerificationRequest: validateEvent: no content"),!1)}get transactionId(){return this.channel.transactionId}get roomId(){return this.channel.roomId}get invalid(){return this.phase===nn}get requested(){return this.phase===wr}get cancelled(){return this.phase===Zs}get ready(){return this.phase===Wr}get started(){return this.phase===hn}get done(){return this.phase===eo}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){var t=this.channel.getTimestamp(e)+I0;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=wr){var r=this.requestReceivedAt+C0;t=Math.min(t,r)}return Math.max(0,t-Date.now())}get timeout(){var e=this.getEventByEither(We);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(We)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return mS(this)}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==eo&&this._phase!==Zs}get qrCodeData(){return this._qrCodeData}getQRCodeBytes(){var e;return(e=this._qrCodeData)===null||e===void 0?void 0:e.getBuffer()}generateQRCode(){var e=this;return S(function*(){return e.getQRCodeBytes()})()}otherPartySupportsMethod(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t&&!this.ready&&!this.started)return!1;var r=this.eventsByThem.get(We)||this.eventsByThem.get(Ir);if(!r){if(this.started&&this.initiatedByMe){var n=this.eventsByUs.get(Tt),s=n&&n.getContent(),o=s&&s.method;return e==o}return!1}var a=r.getContent();if(!a)return!1;var{methods:l}=a;return Array.isArray(l)?l.includes(e):!1}get initiatedByMe(){var e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===nn&&e)return!0;var t=this.eventsByUs.has(We),r=this.eventsByThem.has(We);if(t&&!r)return!0;if(!t&&r)return!1;var n=this.eventsByUs.has(Tt),s=this.eventsByThem.has(Tt);return!!(n&&!s)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get otherDeviceId(){return this.channel.deviceId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){var e=this.eventsByUs.get(Or),t=this.eventsByThem.get(Or);if(e&&(!t||e.getId()<t.getId()))return e.getSender();if(t)return t.getSender()}get cancellationCode(){var e=this.getEventByEither(Or);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){var e=this.eventsByThem.get(We)||this.eventsByThem.get(Ir)||this.eventsByThem.get(Tt),t=e==null?void 0:e.getContent(),r=t==null?void 0:t.from_device;return{userId:this.otherUserId,deviceId:r}}beginKeyVerification(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(!this.observeOnly&&!this._verifier){var r=this.phase===wr||this.phase===Wr||this.phase===nn&&this.channel.canCreateRequest(Tt);if(r){if(this.commonMethods.length&&!this.commonMethods.includes(e)||(this._verifier=this.createVerifier(e,null,t),!this._verifier))throw qo();this._chosenMethod=e}}return this._verifier}startVerification(e){var t=this;return S(function*(){var r=t.beginKeyVerification(e);return r.verify(),r})()}scanQRCode(e){throw new Error("QR code scanning not supported by legacy crypto")}sendRequest(){var e=this;return S(function*(){if(!e.observeOnly&&e._phase===nn){var t=[...e.verificationMethods.keys()];yield e.channel.send(We,{methods:t})}})()}cancel(){var e=arguments,t=this;return S(function*(){var{reason:r="User declined",code:n="m.user"}=e.length>0&&e[0]!==void 0?e[0]:{};if(!t.observeOnly&&t._phase!==Zs){if(t._declining=!0,t.emit(Ti.Change),t._verifier)return t._verifier.cancel(Cn(n,r)());t._cancellingUserId=t.client.getUserId(),yield t.channel.send(Or,{code:n,reason:r})}})()}accept(){var e=this;return S(function*(){if(!e.observeOnly&&e.phase===wr&&!e.initiatedByMe){var t=[...e.verificationMethods.keys()];e._accepting=!0,e.emit(Ti.Change),yield e.channel.send(Ir,{methods:t})}})()}waitFor(e){return new Promise((t,r)=>{var n=()=>{var s=!1;return e(this)?(t(this),s=!0):this.cancelled&&(r(new Error("cancelled")),s=!0),s&&this.off(Ti.Change,n),s};n()||this.on(Ti.Change,n)})}setPhase(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;this._phase=e,t&&this.emit(Ti.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){var e=[{phase:nn}],t=()=>e[e.length-1].phase,r=this.eventsByThem.has(We),n=this.getEventBy(We,r);n&&e.push({phase:wr,event:n});var s=n&&this.getEventBy(Ir,!r);s&&t()===wr&&e.push({phase:Wr,event:s});var o;if(s||!n){var a=this.eventsByThem.get(Tt),l=this.eventsByUs.get(Tt);a&&l?o=a.getSender()<l.getSender()?a:l:o=a||l}else o=this.getEventBy(Tt,!r);if(o){var u=t()===wr&&(n==null?void 0:n.getSender())!==o.getSender(),c=t()===nn&&this.channel.canCreateRequest(Tt);(u||t()===Wr||c)&&e.push({phase:hn,event:o})}var d=this.eventsByUs.get(O0);(this.verifierHasFinished||d&&t()===hn)&&e.push({phase:eo});var h=this.getEventByEither(Or);return(this._cancelled||h)&&t()!==eo&&e.push({phase:Zs,event:h}),e}transitionToPhase(e){var{phase:t,event:r}=e;if((t===wr||t===Wr)&&!this.wasSentByOwnDevice(r)){var n=r.getContent();this.commonMethods=n.methods.filter(o=>this.verificationMethods.has(o))}if(this.observeOnly||(t===wr||t===hn||t===Wr)&&this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(r)&&!this.wasSentByOwnDevice(r)&&(this._observeOnly=!0),t===hn){var{method:s}=r.getContent();!this._verifier&&!this.observeOnly&&(this._verifier=this.createVerifier(s,r),this._verifier?this._chosenMethod=s:this.cancel({code:"m.unknown_method",reason:"Unknown method: ".concat(s)}))}}applyPhaseTransitions(){var e=this.calculatePhaseTransitions(),t=e.findIndex(s=>s.phase===this.phase),r=e.slice(t+1);for(var n of r)this.transitionToPhase(n);return r}isWinningStartRace(e){if(e.getType()!==Tt)return!1;var t=this._verifier.startEvent,r;if(this.isSelfVerification)if(t){var n=t.getContent();r=n&&n.from_device}else r=this.client.getDeviceId();else t?r=t.getSender():r=this.client.getUserId();var s;if(this.isSelfVerification){var o=e.getContent();s=o&&o.from_device}else s=e.getSender();return s<r}hasEventId(e){for(var t of this.eventsByUs.values())if(t.getId()===e)return!0;for(var r of this.eventsByThem.values())if(r.getId()===e)return!0;return!1}handleEvent(e,t,r,n,s){var o=this;return S(function*(){if(!(o.done||o.cancelled)){var a=o._observeOnly;if(o.adjustObserveOnly(t,r),!(!o.observeOnly&&!n&&(yield o.cancelOnError(e,t)))){var l=s?o.eventsByUs.has(e):o.eventsByThem.has(e);if(!l){var u=o.phase;o.addEvent(e,t,s);var c=o.applyPhaseTransitions();try{if(o._verifier&&!o.observeOnly){var d=o.isWinningStartRace(t);if(o._verifier.canSwitchStartEvent(t)&&d)o._verifier.switchStartEvent(t);else if(!n){var h;(e===Or||(h=o._verifier.events)!==null&&h!==void 0&&h.includes(e))&&o._verifier.handleEvent(t)}}if(c.length){if(r&&c.some(E=>E.phase===Wr)){var g=o.otherPartySupportsMethod(kS,!0);g&&(o._qrCodeData=yield qn.create(o,o.client))}var v=c[c.length-1],{phase:m}=v;o.setupTimeout(m),o.setPhase(m)}else o._observeOnly!==a&&o.emit(Ti.Change)}finally{p.log("Verification request ".concat(o.channel.transactionId,": ")+"".concat(e," event with id:").concat(t.getId(),", ")+"content:".concat(JSON.stringify(t.getContent())," ")+"deviceId:".concat(o.channel.deviceId,", ")+"sender:".concat(t.getSender(),", isSentByUs:").concat(s,", ")+"isLiveEvent:".concat(r,", isRemoteEcho:").concat(n,", ")+"phase:".concat(u,"=>").concat(o.phase,", ")+"observeOnly:".concat(a,"=>").concat(o._observeOnly))}}}}})()}setupTimeout(e){var t=!this.timeoutTimer&&!this.observeOnly&&e===wr;if(t&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){var r=e===hn||e===Wr||e===eo||e===Zs;r&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}cancelOnError(e,t){var r=this;return S(function*(){if(e===Tt){var n=t.getContent().method;if(!r.verificationMethods.has(n))return yield r.cancel(fd(qo())),!0}var s=e===We&&r.phase!==nn,o=e===Ir&&r.phase!==wr&&r.phase!==hn;if(r.phase!==nn&&(s||o)){p.warn("Cancelling, unexpected ".concat(e," verification ")+"event from ".concat(t.getSender()));var a="Unexpected ".concat(e," event in phase ").concat(r.phase);return yield r.cancel(fd(CS({reason:a}))),!0}return!1})()}adjustObserveOnly(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t||(this._observeOnly=!0),this.calculateEventTimeout(e)<k0&&(this._observeOnly=!0)}addEvent(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(r?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===We){for(var[n,s]of this.eventsByThem.entries())s.getSender()!==this.otherUserId&&this.eventsByThem.delete(n);this.requestReceivedAt=Date.now()}}createVerifier(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;r||(r=this.targetDevice);var{userId:n,deviceId:s}=r,o=this.verificationMethods.get(e);if(!o){p.warn("could not find verifier constructor for method",e);return}return new o(this.channel,this.client,n,s,t,this)}wasSentByOwnUser(e){return(e==null?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;var t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;var e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send(F.KeyVerificationDone,{}),this.verifierHasFinished=!0;var e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}var wg=F.RoomMessage,Rg="m.reference",Tg="m.relates_to";class Ut{constructor(e,t,r){this.client=e,this.roomId=t,this.userId=r,f(this,"requestEventId",void 0)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){var r=Ut.getEventType(e);if(r===We){var n=t.getUserId(),s=e.getSender(),o=e.getContent(),a=o.to;if(s===n)return a;if(a===n)return s}}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===We}canCreateRequest(e){return Ut.canCreateRequest(e)}static getTransactionId(e){if(Ut.getEventType(e)===We)return e.getId();var t=e.getRelation();if((t==null?void 0:t.rel_type)===Rg)return t.event_id}static validateEvent(e,t){var r=Ut.getTransactionId(e);if(typeof r!="string"||r.length===0)return!1;var n=Ut.getEventType(e),s=e.getContent();if(n===We){if(!s||typeof s.to!="string"||!s.to.length)return p.log("InRoomChannel: validateEvent: no valid to "+s.to),!1;if(!Ut.getOtherPartyUserId(e,t))return p.log("InRoomChannel: validateEvent: "+"not directed to or sent by me: ".concat(e.getSender())+", ".concat(s.to)),!1}return ki.validateEvent(n,e,t)}static getEventType(e){var t=e.getType();if(t===wg){var r=e.getContent();if(r){var{msgtype:n}=r;if(n===We)return We}}return t&&t!==We?t:""}handleEvent(e,t){var r=arguments,n=this;return S(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!1;if(!t.hasEventId(e.getId())){var o=Ut.getEventType(e);if(e.getRoomId()===n.roomId){if(!n.userId){var a=Ut.getOtherPartyUserId(e,n.client);a&&(n.userId=a)}var l=n.client.getUserId(),u=e.getSender();if(n.userId&&u!==l&&u!==n.userId){p.log("InRoomChannel: ignoring verification event from non-participating sender ".concat(u));return}n.requestEventId||(n.requestEventId=Ut.getTransactionId(e));var c=!!e.getTxnId(),d=!!e.getUnsigned().transaction_id,h=e.getSender()===n.client.getUserId();return t.handleEvent(o,e,s,c||d,h)}}})()}completedContentFromEvent(e){var t=Object.assign({},e.getContent());return t[Tg]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),(e===We||e===Ir||e===Tt)&&(t.from_device=this.client.getDeviceId()),e===We?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:We,to:this.userId,from_device:t.from_device,methods:t.methods}:t[Tg]={rel_type:Rg,event_id:this.transactionId},t}send(e,t){var r=this.completeContent(e,t);return this.sendCompleted(e,r)}sendCompleted(e,t){var r=this;return S(function*(){var n=e;e===We&&(n=wg);var s=yield r.client.sendEvent(r.roomId,n,t);e===We&&(r.requestEventId=s.event_id)})()}}class P0{constructor(){f(this,"requestsByRoomId",new Map)}getRequest(e){var t=e.getRoomId(),r=Ut.getTransactionId(e);return this.getRequestByTxnId(t,r)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){var r=this.requestsByRoomId.get(e);if(r)return r.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),Ut.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,r){var n=this.requestsByRoomId.get(e);n||(n=new Map,this.requestsByRoomId.set(e,n)),n.set(t,r)}removeRequest(e){var t=e.getRoomId(),r=this.requestsByRoomId.get(t);r&&(r.delete(Ut.getTransactionId(e)),r.size===0&&this.requestsByRoomId.delete(t))}findRequestInProgress(e,t){var r=this.requestsByRoomId.get(e);if(r){for(var n of r.values())if(n.pending&&(t===void 0||n.requestingUserId===t))return n}}}class Dt{constructor(e,t,r,n,s){this.client=e,this.userId=t,this.devices=r,this.transactionId=n,this.deviceId=s,f(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(var t of e)if(!this.devices.includes(t))return!1;return!0}else return!1}static getEventType(e){return e.getType()}static getTransactionId(e){var t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===We||e===Tt}canCreateRequest(e){return Dt.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return p.warn("Ignoring flagged verification request from "+e.getSender()),!1;var r=e.getContent();if(!r)return p.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!r.transaction_id)return p.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;var n=e.getType();if(n===We){if(!Number.isFinite(r.timestamp))return p.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&r.from_device==t.getDeviceId())return p.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return ki.validateEvent(n,e,t)}getTimestamp(e){var t=e.getContent();return t&&t.timestamp}handleEvent(e,t){var r=arguments,n=this;return S(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!1,o=e.getType(),a=e.getContent();if(o===We||o===Ir||o===Tt){n.transactionId||(n.transactionId=a.transaction_id);var l=a.from_device;if(!n.deviceId&&n.devices.includes(l)&&(n.deviceId=l),!n.deviceId||n.deviceId!==l){var u=n.completeContent(Or,fd(CS()));return n.sendToDevices(Or,u,[l])}}var c=t.phase===hn||t.phase===Wr;yield t.handleEvent(e.getType(),e,s,!1,!1);var d=t.phase===hn||t.phase===Wr,h=o===Tt||o===Ir;if(h&&!c&&d&&n.deviceId){var g=n.devices.filter(m=>m!==n.deviceId&&m!==n.client.getDeviceId());if(g.length){var v=n.completeContent(Or,{code:"m.accepted",reason:"Verification request accepted by another device"});yield n.sendToDevices(Or,v,g)}}})()}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),(e===We||e===Ir||e===Tt)&&(t.from_device=this.client.getDeviceId()),e===We&&(t.timestamp=Date.now()),t}send(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};(e===We||e===Tt)&&!this.transactionId&&(this.transactionId=Dt.makeTransactionId());var r=this.completeContent(e,t);return this.sendCompleted(e,r)}sendCompleted(e,t){var r=this;return S(function*(){var n;e===We||e===Or&&!r.deviceId?n=yield r.sendToDevices(e,t,r.devices):n=yield r.sendToDevices(e,t,[r.deviceId]);var s=new Ot({sender:r.client.getUserId(),content:t,type:e});return yield r.request.handleEvent(e,s,!0,!0,!0),n})()}sendToDevices(e,t,r){var n=this;return S(function*(){if(r.length){var s=new Map;for(var o of r)s.set(o,t);yield n.client.sendToDevice(e,new Map([[n.userId,s]]))}})()}static makeTransactionId(){return Dr(32)}}class M0{constructor(){f(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),Dt.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){var r=this.requestsByUserId.get(e);if(r)return r.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),Dt.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,r){var n=this.requestsByUserId.get(e);n||(n=new Map,this.requestsByUserId.set(e,n)),n.set(t,r)}removeRequest(e){var t=e.getSender(),r=this.requestsByUserId.get(t);r&&(r.delete(Dt.getTransactionId(e)),r.size===0&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){var r=this.requestsByUserId.get(e);if(r){for(var n of r.values())if(n.pending&&n.channel.isToDevices(t))return n}}getRequestsInProgress(e){var t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter(r=>r.pending):[]}}class Il extends bh{constructor(){super(...arguments),f(this,"doVerification",S(function*(){throw new Error("Verification is not possible with this method")}))}static factory(e,t,r,n,s,o){return new Il(e,t,r,n,s,o)}static get NAME(){return"org.matrix.illegal_method"}}var el="org.matrix.msc2697.v1.olm.libolm_pickle",Ig=7*24*60*60*1e3;class A0{constructor(e){this.crypto=e,f(this,"inProgress",!1),f(this,"timeoutId",void 0),f(this,"key",void 0),f(this,"keyInfo",void 0),f(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){var e=this;return this.crypto.cryptoStore.doTxn("readonly",[fe.STORE_ACCOUNT],t=>{this.crypto.cryptoStore.getSecretStorePrivateKey(t,function(){var r=S(function*(n){if(n){var{key:s,keyInfo:o,deviceDisplayName:a,time:l}=n,u=Buffer.from(e.crypto.olmDevice.pickleKey),c=yield _a(s,u,el);e.key=At(c),e.keyInfo=o,e.deviceDisplayName=a;var d=Date.now(),h=Math.max(1,l+Ig-d);e.timeoutId=global.setTimeout(e.dehydrateDevice.bind(e),h)}});return function(n){return r.apply(this,arguments)}}(),"dehydration")})}setKeyAndQueueDehydration(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{},s=t.length>2?t[2]:void 0,o=yield r.setKey(e,n,s);o||r.dehydrateDevice()})()}setKey(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{},s=t.length>2?t[2]:void 0;if(!e){r.timeoutId&&(global.clearTimeout(r.timeoutId),r.timeoutId=void 0),yield r.crypto.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],l=>{r.crypto.cryptoStore.storeSecretStorePrivateKey(l,"dehydration",null)}),r.key=void 0,r.keyInfo=void 0;return}for(var o=!!r.key&&e.length==r.key.length,a=0;o&&a<e.length;a++)e[a]!=r.key[a]&&(o=!1);return o||(r.key=e,r.keyInfo=n,r.deviceDisplayName=s),o})()}dehydrateDevice(){var e=this;return S(function*(){if(e.inProgress){p.log("Dehydration already in progress -- not starting new dehydration");return}e.inProgress=!0,e.timeoutId&&(global.clearTimeout(e.timeoutId),e.timeoutId=void 0);try{var t=Buffer.from(e.crypto.olmDevice.pickleKey),r=yield As(zt(e.key),t,el);yield e.crypto.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],D=>{e.crypto.cryptoStore.storeSecretStorePrivateKey(D,"dehydration",{keyInfo:e.keyInfo,key:r,deviceDisplayName:e.deviceDisplayName,time:Date.now()})}),p.log("Attempting to dehydrate device"),p.log("Creating account");var n=new global.Olm.Account;n.create();var s=JSON.parse(n.identity_keys()),o=n.max_number_of_one_time_keys();n.generate_one_time_keys(o/2),n.generate_fallback_key();var a=JSON.parse(n.one_time_keys()),l=JSON.parse(n.fallback_key());n.mark_keys_as_published();var u=n.pickle(new Uint8Array(e.key)),c={algorithm:el,account:u};e.keyInfo.passphrase&&(c.passphrase=e.keyInfo.passphrase),p.log("Uploading account to server");var d=yield e.crypto.baseApis.http.authedRequest(z.Put,"/dehydrated_device",void 0,{device_data:c,initial_device_display_name:e.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"}),h=d.device_id;p.log("Preparing device keys",h);var g={algorithms:e.crypto.supportedAlgorithms,device_id:h,user_id:e.crypto.userId,keys:{["ed25519:".concat(h)]:s.ed25519,["curve25519:".concat(h)]:s.curve25519}},v=n.sign(wn.stringify(g));g.signatures={[e.crypto.userId]:{["ed25519:".concat(h)]:v}},e.crypto.crossSigningInfo.getId("self_signing")&&(yield e.crypto.crossSigningInfo.signObject(g,"self_signing")),p.log("Preparing one-time keys");var m={};for(var[E,R]of Object.entries(a.curve25519)){var _={key:R},T=n.sign(wn.stringify(_));_.signatures={[e.crypto.userId]:{["ed25519:".concat(h)]:T}},m["signed_curve25519:".concat(E)]=_}p.log("Preparing fallback keys");var b={};for(var[I,y]of Object.entries(l.curve25519)){var C={key:y,fallback:!0},w=n.sign(wn.stringify(C));C.signatures={[e.crypto.userId]:{["ed25519:".concat(h)]:w}},b["signed_curve25519:".concat(I)]=C}return p.log("Uploading keys to server"),yield e.crypto.baseApis.http.authedRequest(z.Post,"/keys/upload/"+encodeURI(h),void 0,{device_keys:g,one_time_keys:m,"org.matrix.msc2732.fallback_keys":b}),p.log("Done dehydrating"),e.timeoutId=global.setTimeout(e.dehydrateDevice.bind(e),Ig),h}finally{e.inProgress=!1}})()}stop(){this.timeoutId&&(global.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}var D0=200,U0=5e3;class Li{constructor(e,t){this.baseApis=e,this.getKey=t,f(this,"algorithm",void 0),f(this,"backupInfo",void 0),f(this,"checkedForBackup",void 0),f(this,"sendingBackups",void 0),f(this,"sessionLastCheckAttemptedTime",{}),f(this,"clientRunning",!0),this.checkedForBackup=!1,this.sendingBackups=!1}stop(){this.clientRunning=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){var t=ec[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if(typeof e.auth_data!="object")throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){var r=ec[e.algorithm];if(!r)throw new Error("Unknown backup algorithm");return r.init(e.auth_data,t)}enableKeyBackup(e){var t=this;return S(function*(){t.backupInfo=e,t.algorithm&&t.algorithm.free(),t.algorithm=yield Li.makeAlgorithm(e,t.getKey),t.baseApis.emit(Ce.KeyBackupStatus,!0),t.scheduleKeyBackupSend()})()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(Ce.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?!!this.algorithm:null}prepareKeyBackupVersion(e,t){return S(function*(){var r=t?ec[t]:x0;if(!r)throw new Error("Unknown backup algorithm");var[n,s]=yield r.prepare(e),o=bd(n);return{algorithm:r.algorithmName,auth_data:s,recovery_key:o,privateKey:n}})()}createKeyBackupVersion(e){var t=this;return S(function*(){t.algorithm=yield Li.makeAlgorithm(e,t.getKey)})()}deleteAllKeyBackupVersions(){var e=this;return S(function*(){for(var t,r,n=(t=(r=yield e.baseApis.getKeyBackupVersion())===null||r===void 0?void 0:r.version)!==null&&t!==void 0?t:null;n!=null;){var s,o;yield e.deleteKeyBackupVersion(n),e.disableKeyBackup(),n=(s=(o=yield e.baseApis.getKeyBackupVersion())===null||o===void 0?void 0:o.version)!==null&&s!==void 0?s:null}})()}deleteKeyBackupVersion(e){var t=this;return S(function*(){var r=me("/room_keys/version/$version",{$version:e});yield t.baseApis.http.authedRequest(z.Delete,r,void 0,void 0,{prefix:vt.V3})})()}checkAndStart(){var e=this;return S(function*(){if(p.log("Checking key backup status..."),e.baseApis.isGuest())return p.log("Skipping key backup check since user is guest"),e.checkedForBackup=!0,null;var t;try{var r;t=(r=yield e.baseApis.getKeyBackupVersion())!==null&&r!==void 0?r:void 0}catch(s){return p.log("Error checking for active key backup",s),s.httpStatus===404&&(e.checkedForBackup=!0),null}e.checkedForBackup=!0;var n=yield e.isKeyBackupTrusted(t);return n.usable&&!e.backupInfo?(p.log("Found usable key backup v".concat(t.version,": enabling key backups")),yield e.enableKeyBackup(t)):!n.usable&&e.backupInfo?(p.log("No usable key backup: disabling key backup"),e.disableKeyBackup()):!n.usable&&!e.backupInfo?p.log("No usable key backup: not enabling key backup"):n.usable&&e.backupInfo&&(t.version!==e.backupInfo.version?(p.log("On backup version ".concat(e.backupInfo.version," but ")+"found version ".concat(t.version,": switching.")),e.disableKeyBackup(),yield e.enableKeyBackup(t),yield e.scheduleAllGroupSessionsForBackup()):p.log("Backup version ".concat(t.version," still current"))),{backupInfo:t,trustInfo:n}})()}checkKeyBackup(){var e=this;return S(function*(){return e.checkedForBackup=!1,e.checkAndStart()})()}queryKeyBackupRateLimited(e,t){var r=this;return S(function*(){if(r.backupInfo){var n=new Date().getTime();(!r.sessionLastCheckAttemptedTime[t]||n-r.sessionLastCheckAttemptedTime[t]>U0)&&(r.sessionLastCheckAttemptedTime[t]=n,yield r.baseApis.restoreKeyBackupWithCache(e,t,r.backupInfo,{}))}})()}isKeyBackupTrusted(e){var t=this;return S(function*(){var r={usable:!1,trusted_locally:!1,sigs:[]};if(!e||!e.algorithm||!e.auth_data||!e.auth_data.signatures)return p.info("Key backup is absent or missing required data: ".concat(JSON.stringify(e))),r;var n=t.baseApis.getUserId(),s=yield t.baseApis.crypto.getSessionBackupPrivateKey();if(s){var o=null;try{o=yield Li.makeAlgorithm(e,S(function*(){return s})),(yield o.keyMatches(s))&&(p.info("Backup is trusted locally"),r.trusted_locally=!0)}catch{}finally{var a;(a=o)===null||a===void 0||a.free()}}var l=e.auth_data.signatures[n]||{};for(var u of Object.keys(l)){var c=u.split(":");if(c[0]!=="ed25519"){p.log("Ignoring unknown signature type: "+c[0]);continue}var d={deviceId:c[1]},h=t.baseApis.crypto.crossSigningInfo.getId();if(h===d.deviceId){d.crossSigningId=!0;try{yield Es(t.baseApis.crypto.olmDevice,e.auth_data,n,d.deviceId,h),d.valid=!0}catch(v){p.warn("Bad signature from cross signing key "+h,v),d.valid=!1}r.sigs.push(d);continue}var g=t.baseApis.crypto.deviceList.getStoredDevice(n,d.deviceId);if(g){d.device=g,d.deviceTrust=t.baseApis.checkDeviceTrust(n,d.deviceId);try{yield Es(t.baseApis.crypto.olmDevice,e.auth_data,n,g.deviceId,g.getFingerprint()),d.valid=!0}catch(v){p.info("Bad signature from key ID "+u+" userID "+t.baseApis.getUserId()+" device ID "+g.deviceId+" fingerprint: "+g.getFingerprint(),e.auth_data,v),d.valid=!1}}else d.valid=null,p.info("Ignoring signature from unknown key "+u);r.sigs.push(d)}return r.usable=r.sigs.some(v=>{var m;return v.valid&&(v.device&&((m=v.deviceTrust)===null||m===void 0?void 0:m.isVerified())||v.crossSigningId)}),r})()}scheduleKeyBackupSend(){var e=arguments,t=this;return S(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:1e4;if(p.debug("Key backup: scheduleKeyBackupSend currentSending:".concat(t.sendingBackups," delay:").concat(r)),!t.sendingBackups){t.sendingBackups=!0;try{var n=Math.random()*r;if(yield Zo(n),!t.clientRunning){t.sendingBackups=!1;return}for(var s=0;;){if(!t.algorithm)return;try{var o=yield t.backupPendingKeys(D0);if(o===0){t.sendingBackups=!1;return}s=0}catch(l){if(s++,p.log("Key backup request failed",l),l instanceof Qt){var a=l.data.errcode;if(a=="M_NOT_FOUND"||a=="M_WRONG_ROOM_KEYS_VERSION"){t.sendingBackups=!1,t.baseApis.crypto.emit(Ce.KeyBackupFailed,a),yield t.checkKeyBackup();return}}}if(s&&(yield Zo(1e3*Math.pow(2,Math.min(s-1,4)))),!t.clientRunning){p.debug("Key backup send loop aborted, client stopped"),t.sendingBackups=!1;return}}}catch(l){p.log("Backup loop failed ".concat(l)),t.sendingBackups=!1}}})()}backupPendingKeys(e){var t=this;return S(function*(){var r=yield t.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!r.length)return 0;var n=yield t.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();t.baseApis.crypto.emit(Ce.KeyBackupSessionsRemaining,n);var s={};for(var o of r){var a,l=o.sessionData.room_id;Xr(s,l,s[l]||{sessions:{}});var u=t.baseApis.crypto.olmDevice.exportInboundGroupSession(o.senderKey,o.sessionId,o.sessionData);u.algorithm=nr;var c=(u.forwarding_curve25519_key_chain||[]).length,d=t.baseApis.crypto.deviceList.getUserByIdentityKey(nr,o.senderKey),h=(a=t.baseApis.crypto.deviceList.getDeviceByIdentityKey(nr,o.senderKey))!==null&&a!==void 0?a:void 0,g=t.baseApis.crypto.checkDeviceInfoTrust(d,h).isVerified();Xr(s[l].sessions,o.sessionId,{first_message_index:u.first_known_index,forwarded_count:c,is_verified:g,session_data:yield t.algorithm.encryptSession(u)})}return yield t.baseApis.sendKeyBackup(void 0,void 0,t.backupInfo.version,{rooms:s}),yield t.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(r),n=yield t.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),t.baseApis.crypto.emit(Ce.KeyBackupSessionsRemaining,n),r.length})()}backupGroupSession(e,t){var r=this;return S(function*(){yield r.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),r.backupInfo&&r.scheduleKeyBackupSend()})()}scheduleAllGroupSessionsForBackup(){var e=this;return S(function*(){yield e.flagAllGroupSessionsForBackup(),e.scheduleKeyBackupSend(0)})()}flagAllGroupSessionsForBackup(){var e=this;return S(function*(){yield e.baseApis.crypto.cryptoStore.doTxn("readwrite",[fe.STORE_INBOUND_GROUP_SESSIONS,fe.STORE_BACKUP],r=>{e.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(r,n=>{n!==null&&e.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([n],r)})});var t=yield e.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return e.baseApis.emit(Ce.KeyBackupSessionsRemaining,t),t})()}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class Rs{constructor(e,t,r){this.authData=e,this.publicKey=t,this.getKey=r}static init(e,t){return S(function*(){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");var r=new global.Olm.PkEncryption;return r.set_recipient_key(e.public_key),new Rs(e,r,t)})()}static prepare(e){return S(function*(){var t=new global.Olm.PkDecryption;try{var r={};if(!e)r.public_key=t.generate_key();else if(e instanceof Uint8Array)r.public_key=t.init_with_private_key(e);else{var n=yield Rh(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,r.public_key=t.init_with_private_key(n.key)}var s=new global.Olm.PkEncryption;return s.set_recipient_key(r.public_key),[t.get_private_key(),r]}finally{t.free()}})()}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}encryptSession(e){var t=this;return S(function*(){var r=Object.assign({},e);return delete r.session_id,delete r.room_id,delete r.first_known_index,t.publicKey.encrypt(JSON.stringify(r))})()}decryptSessions(e){var t=this;return S(function*(){var r=yield t.getKey(),n=new global.Olm.PkDecryption;try{var s=n.init_with_private_key(r);if(s!==t.authData.public_key)throw new Qt({errcode:si.RESTORE_BACKUP_ERROR_BAD_KEY});var o=[];for(var[a,l]of Object.entries(e))try{var u=JSON.parse(n.decrypt(l.session_data.ephemeral,l.session_data.mac,l.session_data.ciphertext));u.session_id=a,o.push(u)}catch(c){p.log("Failed to decrypt megolm session from backup",c,l)}return o}finally{n.free()}})()}keyMatches(e){var t=this;return S(function*(){var r=new global.Olm.PkDecryption,n;try{n=r.init_with_private_key(e)}finally{r.free()}return n===t.authData.public_key})()}free(){this.publicKey.free()}}f(Rs,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");function L0(i){var e=new Uint8Array(i);return Tn.getRandomValues(e),e}var N0=new ut("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class aa{constructor(e,t){this.authData=e,this.key=t}static init(e,t){return S(function*(){if(!e)throw new Error("auth_data missing");var r=yield t();if(e.mac){var{mac:n}=yield us(r,e.iv);if(e.mac.replace(/=+$/g,"")!==n.replace(/=+/g,""))throw new Error("Key does not match")}return new aa(e,r)})()}static prepare(e){return S(function*(){var t,r={};if(!e)t=L0(32);else if(e instanceof Uint8Array)t=new Uint8Array(e);else{var n=yield Rh(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,t=n.key}var{iv:s,mac:o}=yield us(t);return r.iv=s,r.mac=o,[t,r]})()}static checkBackupVersion(e){if(!("iv"in e.auth_data&&"mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){var t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,As(JSON.stringify(t),this.key,e.session_id)}decryptSessions(e){var t=this;return S(function*(){var r=[];for(var[n,s]of Object.entries(e))try{var o=JSON.parse(yield _a(s.session_data,t.key,n));o.session_id=n,r.push(o)}catch(a){p.log("Failed to decrypt megolm session from backup",a,s)}return r})()}keyMatches(e){var t=this;return S(function*(){if(t.authData.mac){var{mac:r}=yield us(e,t.authData.iv);return t.authData.mac.replace(/=+$/g,"")===r.replace(/=+/g,"")}else return!0})()}free(){this.key.fill(0)}}f(aa,"algorithmName",N0.name);var ec={[Rs.algorithmName]:Rs,[aa.algorithmName]:aa},x0=Rs;function Cg(i){var e;return{trusted:i.usable,matchesDecryptionKey:(e=i.trusted_locally)!==null&&e!==void 0?e:!1}}class K0{constructor(e){f(this,"algorithm",void 0),f(this,"sourceTrusted",void 0),this.algorithm=e,this.sourceTrusted=!e.untrusted}free(){this.algorithm.free()}decryptSessions(e){var t=this;return S(function*(){return yield t.algorithm.decryptSessions(e)})()}}class F0{constructor(e){this.cryptoStore=e,f(this,"roomEncryption",{})}init(){var e=this;return S(function*(){yield e.cryptoStore.doTxn("readwrite",[fe.STORE_ROOMS],t=>{e.cryptoStore.getEndToEndRooms(t,r=>{e.roomEncryption=r})})})()}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return!!this.getRoomEncryption(e)}setRoomEncryption(e,t){var r=this;return S(function*(){r.roomEncryption[e]=t,yield r.cryptoStore.doTxn("readwrite",[fe.STORE_ROOMS],n=>{r.cryptoStore.storeEndToEndRoom(e,t,n)})})()}}function kg(i,e){var t=new Map(Object.entries(i.keys)),r=i.getDisplayName()||void 0,n=new Map;if(i.signatures)for(var s in i.signatures)n.set(s,new Map(Object.entries(i.signatures[s])));return new uS({deviceId:i.deviceId,userId:e,keys:t,algorithms:i.algorithms,verified:i.verified,signatures:n,displayName:r})}function Og(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function B0(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Og(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Og(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var sn=er.DeviceVerification,tc={[oa.NAME]:oa,[ws.NAME]:ws,[a0]:Il,[kS]:Il};oa.NAME,ws.NAME;function AS(){return!!globalThis.Olm}var j0=60*60*1e3,q0=5*60*1e3,Ce=function(i){return i.DeviceVerificationChanged="deviceVerificationChanged",i.UserTrustStatusChanged="userTrustStatusChanged",i.UserCrossSigningUpdated="userCrossSigningUpdated",i.RoomKeyRequest="crypto.roomKeyRequest",i.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",i.KeyBackupStatus="crypto.keyBackupStatus",i.KeyBackupFailed="crypto.keyBackupFailed",i.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",i.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",i.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",i.VerificationRequest="crypto.verification.request",i.VerificationRequestReceived="crypto.verificationRequestReceived",i.Warning="crypto.warning",i.WillUpdateDevices="crypto.willUpdateDevices",i.DevicesUpdated="crypto.devicesUpdated",i.KeysChanged="crossSigning.keysChanged",i.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",i}({});class Cl extends rt{static getOlmVersion(){return ag.getOlmVersion()}constructor(e,t,r,n,s,o){var a;if(super(),a=this,this.baseApis=e,this.userId=t,this.deviceId=r,this.clientStore=n,this.cryptoStore=s,f(this,"backupManager",void 0),f(this,"crossSigningInfo",void 0),f(this,"olmDevice",void 0),f(this,"deviceList",void 0),f(this,"dehydrationManager",void 0),f(this,"secretStorage",void 0),f(this,"roomList",void 0),f(this,"reEmitter",void 0),f(this,"verificationMethods",void 0),f(this,"supportedAlgorithms",void 0),f(this,"outgoingRoomKeyRequestManager",void 0),f(this,"toDeviceVerificationRequests",void 0),f(this,"inRoomVerificationRequests",void 0),f(this,"trustCrossSignedDevices",!0),f(this,"lastOneTimeKeyCheck",null),f(this,"oneTimeKeyCheckInProgress",!1),f(this,"roomEncryptors",new Map),f(this,"roomDecryptors",new Map),f(this,"deviceKeys",{}),f(this,"globalBlacklistUnverifiedDevices",!1),f(this,"globalErrorOnUnknownDevices",!0),f(this,"receivedRoomKeyRequests",[]),f(this,"receivedRoomKeyRequestCancellations",[]),f(this,"processingRoomKeyRequests",!1),f(this,"lazyLoadMembers",!1),f(this,"roomDeviceTrackingState",{}),f(this,"forceNewSessionRetryTime",new ht(()=>new ht(()=>0))),f(this,"sendKeyRequestsImmediately",!1),f(this,"oneTimeKeyCount",void 0),f(this,"needsNewFallback",void 0),f(this,"fallbackCleanup",void 0),f(this,"onDeviceListUserCrossSigningUpdated",function(){var d=S(function*(h){if(h===a.userId){var g=a.deviceList.getStoredCrossSigningForUser(h),v=g?g.getId():null,m=a.crossSigningInfo.getId(),E=m!==v;m&&v&&!E?yield a.checkOwnCrossSigningTrust():(a.storeTrustedSelfKeys(null),a.emit(Ce.KeysChanged,{}),a.emit(Ce.UserTrustStatusChanged,a.userId,a.checkUserTrust(h)))}else{yield a.checkDeviceVerifications(h);var R=a.deviceList.getStoredCrossSigningForUser(h);R&&(R.updateCrossSigningVerifiedBefore(a.checkUserTrust(h).isCrossSigningVerified()),a.deviceList.setRawStoredCrossSigningForUser(h,R.toStorage())),a.emit(Ce.UserTrustStatusChanged,h,a.checkUserTrust(h))}});return function(h){return d.apply(this,arguments)}}()),f(this,"onMembership",(d,h,g)=>{try{this.onRoomMembership(d,h,g)}catch(v){p.error("Error handling membership change:",v)}}),f(this,"onToDeviceEvent",d=>{try{p.log("received to-device ".concat(d.getType()," from: ")+"".concat(d.getSender()," id: ").concat(d.getContent()[Zt])),d.getType()=="m.room_key"||d.getType()=="m.forwarded_room_key"?this.onRoomKeyEvent(d):d.getType()=="m.room_key_request"?this.onRoomKeyRequestEvent(d):d.getType()==="m.secret.request"?this.secretStorage.onRequestReceived(d):d.getType()==="m.secret.send"?this.secretStorage.onSecretReceived(d):d.getType()==="m.room_key.withheld"?this.onRoomKeyWithheldEvent(d):d.getContent().transaction_id?this.onKeyVerificationMessage(d):d.getContent().msgtype==="m.bad.encrypted"?this.onToDeviceBadEncrypted(d):(d.isBeingDecrypted()||d.shouldAttemptDecryption())&&(d.isBeingDecrypted()||d.attemptDecryption(this),d.once(Fe.Decrypted,h=>{this.onToDeviceEvent(h)}))}catch(h){p.error("Error handling toDeviceEvent:",h)}}),f(this,"onTimelineEvent",function(d,h,g,v){var{liveEvent:m=!0}=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};if(Ut.validateEvent(d,a.baseApis)){var E=R=>{var _=new Ut(a.baseApis,R.getRoomId());return new ki(_,a.verificationMethods,a.baseApis)};a.handleVerificationEvent(d,a.inRoomVerificationRequests,E,m)}}),p.debug("Crypto: initialising roomlist..."),this.roomList=new F0(s),this.reEmitter=new Ms(this),o){this.verificationMethods=new Map;for(var l of o)typeof l=="string"?tc[l]&&this.verificationMethods.set(l,tc[l]):l.NAME?this.verificationMethods.set(l.NAME,l):p.warn("Excluding unknown verification method ".concat(l))}else this.verificationMethods=new Map(Object.entries(tc));this.backupManager=new Li(e,S(function*(){var d=yield a.getSessionBackupPrivateKey();if(d)return d;var h=yield a.secretStorage.get("m.megolm_backup.v1");if(h){var g=tl(h);if(g){var v=yield a.secretStorage.getKey();yield a.secretStorage.store("m.megolm_backup.v1",g,[v[0]])}return At(g||h)}if(a.baseApis.cryptoCallbacks&&a.baseApis.cryptoCallbacks.getBackupKey)return a.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new ag(s),this.deviceList=new NI(e,s,this.olmDevice),this.deviceList.on(Ce.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[Ce.DevicesUpdated,Ce.WillUpdateDevices]),this.supportedAlgorithms=Array.from(dd.keys()),this.outgoingRoomKeyRequestManager=new GI(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new M0,this.inRoomVerificationRequests=new P0;var u=this.baseApis.cryptoCallbacks||{},c=_S(s,this.olmDevice);this.crossSigningInfo=new kr(t,u,c),this.secretStorage=new r0(e,u,e),this.dehydrationManager=new A0(this),!u.getCrossSigningKey&&u.getSecretStorageKey&&(u.getCrossSigningKey=function(){var d=S(function*(h){return kr.getFromSecretStorage(h,a.secretStorage)});return function(h){return d.apply(this,arguments)}}())}init(){var e=arguments,t=this;return S(function*(){var{exportedOlmDevice:r,pickleKey:n}=e.length>0&&e[0]!==void 0?e[0]:{};p.log("Crypto: initialising Olm..."),yield global.Olm.init(),p.log(r?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),yield t.olmDevice.init({fromExportedDevice:r,pickleKey:n}),p.log("Crypto: loading device list..."),yield t.deviceList.load(),t.deviceKeys["ed25519:"+t.deviceId]=t.olmDevice.deviceEd25519Key,t.deviceKeys["curve25519:"+t.deviceId]=t.olmDevice.deviceCurve25519Key,p.log("Crypto: fetching own devices...");var s=t.deviceList.getRawStoredDevicesForUser(t.userId);if(s||(s={}),!s[t.deviceId]){p.log("Crypto: adding this device to the store...");var o={keys:t.deviceKeys,algorithms:t.supportedAlgorithms,verified:sn.VERIFIED,known:!0};s[t.deviceId]=o,t.deviceList.storeDevicesForUser(t.userId,s),t.deviceList.saveIfDirty()}yield t.cryptoStore.doTxn("readonly",[fe.STORE_ACCOUNT],a=>{t.cryptoStore.getCrossSigningKeys(a,l=>{l&&Object.keys(l).length!==0&&(p.log("Loaded cross-signing public keys from crypto store"),t.crossSigningInfo.setKeys(l))})}),t.deviceList.startTrackingDeviceList(t.userId),p.debug("Crypto: initialising roomlist..."),yield t.roomList.init(),p.log("Crypto: checking for key backup..."),t.backupManager.checkAndStart()})()}getVersion(){var e=Cl.getOlmVersion();return"Olm ".concat(e[0],".").concat(e[1],".").concat(e[2])}getTrustCrossSignedDevices(){return this.trustCrossSignedDevices}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(var t of this.deviceList.getKnownUserIds()){var r=this.deviceList.getRawStoredDevicesForUser(t);for(var n of Object.keys(r)){var s=this.checkDeviceTrust(t,n);if(!s.isLocallyVerified()&&s.isCrossSigningVerified()){var o=this.deviceList.getStoredDevice(t,n);this.emit(Ce.DeviceVerificationChanged,t,n,o)}}}}setCryptoTrustCrossSignedDevices(e){this.setTrustCrossSignedDevices(e)}createRecoveryKeyFromPassphrase(e){return S(function*(){var t=new global.Olm.PkDecryption;try{if(e){var r=yield Rh(e);t.init_with_private_key(r.key);var n=t.get_private_key();return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:r.iterations,salt:r.salt}},privateKey:n,encodedPrivateKey:bd(n)}}else{t.generate_key();var s=t.get_private_key();return{privateKey:s,encodedPrivateKey:bd(s)}}}finally{t==null||t.free()}})()}userHasCrossSigningKeys(){var e=arguments,t=this;return S(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:t.userId;return yield t.downloadKeys([r]),t.deviceList.getStoredCrossSigningForUser(r)!==null})()}isCrossSigningReady(){var e=this;return S(function*(){var t=e.crossSigningInfo.getId(),r=(yield e.crossSigningInfo.isStoredInKeyCache())||(yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage));return!!(t&&r)})()}isSecretStorageReady(){var e=this;return S(function*(){var t=yield e.secretStorage.hasKey(),r=yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage),n=!e.backupManager.getKeyBackupEnabled()||(yield e.baseApis.isKeyBackupKeyStored());return!!(t&&r&&n)})()}getCrossSigningStatus(){var e=this;return S(function*(){var t,r,n,s=!!e.crossSigningInfo.getId(),o=!!(yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage)),a=e.crossSigningInfo.getCacheCallbacks(),l=!!(yield(t=a.getCrossSigningKeyCache)===null||t===void 0?void 0:t.call(a,"master")),u=!!(yield(r=a.getCrossSigningKeyCache)===null||r===void 0?void 0:r.call(a,"self_signing")),c=!!(yield(n=a.getCrossSigningKeyCache)===null||n===void 0?void 0:n.call(a,"user_signing"));return{publicKeysOnDevice:s,privateKeysInSecretStorage:o,privateKeysCachedLocally:{masterKey:l,selfSigningKey:u,userSigningKey:c}}})()}bootstrapCrossSigning(){var e=arguments,t=this;return S(function*(){var{authUploadDeviceSigningKeys:r,setupNewCrossSigning:n}=e.length>0&&e[0]!==void 0?e[0]:{};p.log("Bootstrapping cross-signing");var s=t.baseApis.cryptoCallbacks,o=new gg(t.baseApis.store.accountData,s),a=new kr(t.userId,o.crossSigningCallbacks,o.crossSigningCallbacks),l=function(){var E=S(function*(){a.resetKeys(),yield t.signObject(a.keys.master),o.addCrossSigningKeys(r,a.keys);var R=t.deviceList.getStoredDevice(t.userId,t.deviceId),_=yield a.signDevice(t.userId,R);o.addKeySignature(t.userId,t.deviceId,_),t.backupManager.backupInfo&&(yield a.signObject(t.backupManager.backupInfo.auth_data,"master"),o.addSessionBackup(t.backupManager.backupInfo))});return function(){return E.apply(this,arguments)}}(),u=t.crossSigningInfo.getId(),c=yield t.crossSigningInfo.isStoredInKeyCache(),d=yield t.crossSigningInfo.isStoredInSecretStorage(t.secretStorage),h=c||d;p.log({setupNewCrossSigning:n,publicKeysOnDevice:u,privateKeysInCache:c,privateKeysInStorage:d,privateKeysExistSomewhere:h}),!h||n?(p.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),yield l()):u&&c?p.log("Cross-signing public keys trusted and private keys found locally"):d&&(p.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),yield t.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));var g=o.crossSigningCallbacks.privateKeys;if(g.size&&!t.baseApis.cryptoCallbacks.saveCrossSigningKeys){var v=new sa(o.accountDataClientAdapter,o.ssssCryptoCallbacks);(yield v.hasKey())&&(p.log("Storing new cross-signing private keys in secret storage"),yield kr.storeInSecretStorage(g,v))}var m=o.buildOperation();yield m.apply(t),yield o.persist(t),p.log("Cross-signing ready")})()}bootstrapSecretStorage(){var e=arguments,t=this;return S(function*(){var{createSecretStorageKey:r=S(function*(){return{}}),keyBackupInfo:n,setupNewKeyBackup:s,setupNewSecretStorage:o,getKeyBackupPassphrase:a}=e.length>0&&e[0]!==void 0?e[0]:{};p.log("Bootstrapping Secure Secret Storage");var l=t.baseApis.cryptoCallbacks,u=new gg(t.baseApis.store.accountData,l),c=new sa(u.accountDataClientAdapter,u.ssssCryptoCallbacks),d=null,h=function(){var Z=S(function*(ne){var{keyId:ce,keyInfo:we}=yield c.addKey(Jr,ne);return u.ssssCryptoCallbacks.addPrivateKey(ce,we,ne.key),yield c.setDefaultKeyId(ce),ce});return function(ce){return Z.apply(this,arguments)}}(),g=function(){var Z=S(function*(ne,ce){if(!ce.mac){var we,Be,Q=yield(we=(Be=t.baseApis.cryptoCallbacks).getSecretStorageKey)===null||we===void 0?void 0:we.call(Be,{keys:{[ne]:ce}},"");if(Q){var le=Q[1];u.ssssCryptoCallbacks.addPrivateKey(ne,ce,le);var{iv:j,mac:K}=yield us(le);ce.iv=j,ce.mac=K,yield u.setAccountData("m.secret_storage.key.".concat(ne),ce)}}});return function(ce,we){return Z.apply(this,arguments)}}(),v=function(){var Z=S(function*(ne){if(t.crossSigningInfo.getId()&&(yield t.crossSigningInfo.isStoredInKeyCache("master")))try{p.log("Adding cross-signing signature to key backup"),yield t.crossSigningInfo.signObject(ne,"master")}catch(ce){p.error("Signing key backup with cross-signing keys failed",ce)}else p.warn("Cross-signing keys not available, skipping signature on key backup")});return function(ce){return Z.apply(this,arguments)}}(),m=yield t.secretStorage.getKey(),[E,R]=m||[null,null],_=!o&&R&&R.algorithm===Jr;if(p.log({keyBackupInfo:n,setupNewKeyBackup:s,setupNewSecretStorage:o,storageExists:_,oldKeyInfo:R}),!_&&!n){p.log("Secret storage does not exist, creating new storage key");var{keyInfo:T,privateKey:b}=yield r();d=yield h({passphrase:T==null?void 0:T.passphrase,key:b,name:T==null?void 0:T.name})}else if(!_&&n){p.log("Secret storage does not exist, using key backup key");var I=(yield t.getSessionBackupPrivateKey())||(yield a==null?void 0:a()),y={key:I};n.auth_data.private_key_salt&&n.auth_data.private_key_iterations&&(y.passphrase={algorithm:"m.pbkdf2",iterations:n.auth_data.private_key_iterations,salt:n.auth_data.private_key_salt,bits:256}),d=yield h(y),yield c.store("m.megolm_backup.v1",zt(I),[d]),yield v(n.auth_data),u.addSessionBackup(n)}else p.log("Secret storage exists"),R&&R.algorithm===Jr&&(yield g(E,R));if(!t.baseApis.cryptoCallbacks.saveCrossSigningKeys&&(yield t.isCrossSigningReady())&&(d||!(yield t.crossSigningInfo.isStoredInSecretStorage(c)))){p.log("Copying cross-signing private keys from cache to secret storage");var C=yield t.crossSigningInfo.getCrossSigningKeysFromCache();yield kr.storeInSecretStorage(C,c)}if(s&&!n){p.log("Creating new message key backup version");var w=yield t.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),D=Za(w.recovery_key);yield c.store("m.megolm_backup.v1",zt(D));var x={algorithm:w.algorithm,auth_data:w.auth_data};yield v(x.auth_data),yield t.signObject(x.auth_data),u.addSessionBackup(x)}var G=yield c.get("m.megolm_backup.v1");if(G){p.info("Got session backup key from secret storage: caching");var oe=tl(G);if(oe){var de=d||E;yield c.store("m.megolm_backup.v1",oe,de?[de]:null)}var Ee=new Uint8Array(At(oe||G));u.addSessionBackupPrivateKeyToCache(Ee)}else if(t.backupManager.getKeyBackupEnabled()){var X=(yield t.getSessionBackupPrivateKey())||(yield a==null?void 0:a());if(!X){p.error("Key backup is enabled but couldn't get key backup key!");return}p.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),yield c.store("m.megolm_backup.v1",zt(X))}var re=u.buildOperation();yield re.apply(t),yield u.persist(t),p.log("Secure Secret Storage ready")})()}resetKeyBackup(){var e=this;return S(function*(){yield e.backupManager.deleteAllKeyBackupVersions();var t=yield e.backupManager.prepareKeyBackupVersion();yield e.signObject(t.auth_data);var{version:r}=yield e.baseApis.http.authedRequest(z.Post,"/room_keys/version",void 0,t,{prefix:vt.V3});p.log("Created backup version ".concat(r));var n=t.privateKey;yield e.secretStorage.store("m.megolm_backup.v1",zt(n)),yield e.storeSessionBackupPrivateKey(n),yield e.backupManager.checkAndStart(),yield e.backupManager.scheduleAllGroupSessionsForBackup()})()}deleteKeyBackupVersion(e){var t=this;return S(function*(){yield t.backupManager.deleteKeyBackupVersion(e)})()}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){var r=null;try{r=new global.Olm.PkDecryption;var n=r.init_with_private_key(e);return n===t}finally{var s;(s=r)===null||s===void 0||s.free()}}getSessionBackupPrivateKey(){var e=this;return S(function*(){var t=yield new Promise(o=>{e.cryptoStore.doTxn("readonly",[fe.STORE_ACCOUNT],a=>{e.cryptoStore.getSecretStorePrivateKey(a,o,"m.megolm_backup.v1")})}),r=null;if(typeof t=="string"&&(r=new Uint8Array(At(tl(t)||t)),yield e.storeSessionBackupPrivateKey(r)),t&&typeof t=="object"&&"ciphertext"in t){var n=Buffer.from(e.olmDevice.pickleKey),s=yield _a(t,n,"m.megolm_backup.v1");r=At(s)}return r})()}storeSessionBackupPrivateKey(e,t){var r=this;return S(function*(){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got ".concat(e));var n=Buffer.from(r.olmDevice.pickleKey),s=yield As(zt(e),n,"m.megolm_backup.v1");return r.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],o=>{r.cryptoStore.storeSecretStorePrivateKey(o,"m.megolm_backup.v1",s)})})()}getActiveSessionBackupVersion(){var e=this;return S(function*(){if(e.backupManager.getKeyBackupEnabled()){var t;return(t=e.backupManager.version)!==null&&t!==void 0?t:null}return null})()}isKeyBackupTrusted(e){var t=this;return S(function*(){var r=yield t.backupManager.isKeyBackupTrusted(e);return Cg(r)})()}checkKeyBackupAndEnable(){var e=this;return S(function*(){var t=yield e.backupManager.checkKeyBackup();return!t||!t.backupInfo?null:{backupInfo:t.backupInfo,trustInfo:Cg(t.trustInfo)}})()}checkCrossSigningPrivateKey(e,t){var r=null;try{r=new global.Olm.PkSigning;var n=r.init_with_seed(e);return n===t}finally{var s;(s=r)===null||s===void 0||s.free()}}afterCrossSigningLocalKeyChange(){var e=this;return S(function*(){p.info("Starting cross-signing key change post-processing");var t=e.deviceList.getStoredDevice(e.userId,e.deviceId),r=yield e.crossSigningInfo.signDevice(e.userId,t);p.info("Starting background key sig upload for ".concat(e.deviceId));var n=h=>{var{shouldEmit:g=!1}=h;return e.baseApis.uploadKeySignatures({[e.userId]:{[e.deviceId]:r}}).then(v=>{var{failures:m}=v||{};if(Object.keys(m||[]).length>0)throw g&&e.baseApis.emit(Ce.KeySignatureUploadFailure,m,"afterCrossSigningLocalKeyChange",n),new wo("Key upload failed",{failures:m});p.info("Finished background key sig upload for ".concat(e.deviceId))}).catch(v=>{p.error("Error during background key sig upload for ".concat(e.deviceId),v)})};n({shouldEmit:!0});var s=e.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(s){p.info("Starting device verification upgrade");var o={};for(var[a,l]of Object.entries(e.deviceList.crossSigningInfo)){var u=yield e.checkForDeviceVerificationUpgrade(a,kr.fromStorage(l,a));u&&(o[a]=u)}if(Object.keys(o).length>0){p.info("Found ".concat(Object.keys(o).length," verif users to upgrade"));try{var c=yield s({users:o});if(c)for(var d of c)d in o&&(yield e.baseApis.setDeviceVerified(d,o[d].crossSigningInfo.getId()))}catch(h){p.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",h)}}p.info("Finished device verification upgrade")}p.info("Finished cross-signing key change post-processing")})()}checkForDeviceVerificationUpgrade(e,t){var r=this;return S(function*(){var n=r.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.isVerified()){var s=r.deviceList.getRawStoredDevicesForUser(e),o=yield r.checkForValidDeviceSignature(e,t.keys.master,s);if(o.length)return{devices:o.map(a=>er.fromStorage(s[a],a)),crossSigningInfo:t}}})()}checkForValidDeviceSignature(e,t,r){var n=this;return S(function*(){var s=[];if(r&&t.signatures&&t.signatures[e])for(var o of Object.keys(t.signatures[e])){var[,a]=o.split(":",2);if(a in r&&r[a].verified===sn.VERIFIED)try{yield Es(n.olmDevice,t,e,a,r[a].keys[o]),s.push(a)}catch{}}return s})()}getCrossSigningKeyId(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:_h.Master;return Promise.resolve(this.getCrossSigningId(e))}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){var t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new jo(!1,!1,!1)}getUserVerificationStatus(e){var t=this;return S(function*(){return t.checkUserTrust(e)})()}getDeviceVerificationStatus(e,t){var r=this;return S(function*(){var n=r.deviceList.getStoredDevice(e,t);return n?r.checkDeviceInfoTrust(e,n):null})()}checkDeviceTrust(e,t){var r=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,r)}checkDeviceInfoTrust(e,t){var r=!!(t!=null&&t.isVerified()),n=this.deviceList.getStoredCrossSigningForUser(e);if(t&&n){var s=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(n,t,r,s)}else return new cs(!1,!1,r,!1)}checkIfOwnDeviceCrossSigned(e){var t,r=this.deviceList.getStoredDevice(this.userId,e);if(!r)return!1;var n=this.deviceList.getStoredCrossSigningForUser(this.userId);return(t=n==null?void 0:n.checkDeviceTrust(n,r,!1,!0).isCrossSigningVerified())!==null&&t!==void 0?t:!1}checkOwnCrossSigningTrust(){var e=arguments,t=this;return S(function*(){var{allowPrivateKeyRequests:r=!1}=e.length>0&&e[0]!==void 0?e[0]:{},n=t.userId;yield t.downloadKeys([t.userId]);var s=yield t.crossSigningInfo.getCrossSigningKeysFromCache(),o=t.deviceList.getStoredCrossSigningForUser(n);if(!o){p.error("Got cross-signing update event for user "+n+" but no new cross-signing information found!");return}var a=o.getId(),l=t.crossSigningInfo.getId()!==a,u=o.getId()&&!s.has("master");if(l&&p.info("Got new master public key",a),r&&(l||u)){p.info("Attempting to retrieve cross-signing master private key");var c=null;try{var d=yield t.crossSigningInfo.getCrossSigningKey("master",a);c=d[1],p.info("Got cross-signing master private key")}finally{var h;(h=c)===null||h===void 0||h.free()}}var g=t.crossSigningInfo.getId("self_signing"),v=t.crossSigningInfo.getId("user_signing");t.storeTrustedSelfKeys(o.keys);var m=g!==o.getId("self_signing"),E=v!==o.getId("user_signing"),R=o.getId("self_signing")&&!s.has("self_signing"),_=o.getId("user_signing")&&!s.has("user_signing"),T={};if(m&&p.info("Got new self-signing key",o.getId("self_signing")),r&&(m||R)){p.info("Attempting to retrieve cross-signing self-signing private key");var b=null;try{var I=yield t.crossSigningInfo.getCrossSigningKey("self_signing",o.getId("self_signing"));b=I[1],p.info("Got cross-signing self-signing private key")}finally{var y;(y=b)===null||y===void 0||y.free()}var C=t.deviceList.getStoredDevice(t.userId,t.deviceId),w=yield t.crossSigningInfo.signDevice(t.userId,C);T[t.deviceId]=w}if(E&&p.info("Got new user-signing key",o.getId("user_signing")),r&&(E||_)){p.info("Attempting to retrieve cross-signing user-signing private key");var D=null;try{var x=yield t.crossSigningInfo.getCrossSigningKey("user_signing",o.getId("user_signing"));D=x[1],p.info("Got cross-signing user-signing private key")}finally{var G;(G=D)===null||G===void 0||G.free()}}if(l){var oe=t.crossSigningInfo.keys.master;yield t.signObject(oe);var de=oe.signatures[t.userId]["ed25519:"+t.deviceId];T[t.crossSigningInfo.getId()]=Object.assign({},oe,{signatures:{[t.userId]:{["ed25519:"+t.deviceId]:de}}})}var Ee=Object.keys(T);if(Ee.length){var X=re=>{var{shouldEmit:Z=!1}=re;return p.info("Starting background key sig upload for ".concat(Ee)),t.baseApis.uploadKeySignatures({[t.userId]:T}).then(ne=>{var{failures:ce}=ne||{};if(p.info("Finished background key sig upload for ".concat(Ee)),Object.keys(ce||[]).length>0)throw Z&&t.baseApis.emit(Ce.KeySignatureUploadFailure,ce,"checkOwnCrossSigningTrust",X),new wo("Key upload failed",{failures:ce})}).catch(ne=>{p.error("Error during background key sig upload for ".concat(Ee),ne)})};X({shouldEmit:!0})}t.emit(Ce.UserTrustStatusChanged,n,t.checkUserTrust(n)),l&&(t.emit(Ce.KeysChanged,{}),yield t.afterCrossSigningLocalKeyChange()),yield t.backupManager.checkKeyBackup()})()}getBackupDecryptor(e,t){return S(function*(){if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor expects Uint8Array");var r=yield Li.makeAlgorithm(e,S(function*(){return t}));return(yield r.keyMatches(t))?new K0(r):Promise.reject(new Qt({errcode:si.RESTORE_BACKUP_ERROR_BAD_KEY}))})()}importBackedUpRoomKeys(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return r.source="backup",this.importRoomKeys(e,r)}storeTrustedSelfKeys(e){var t=this;return S(function*(){e?t.crossSigningInfo.setKeys(e):t.crossSigningInfo.clearKeys(),yield t.cryptoStore.doTxn("readwrite",[fe.STORE_ACCOUNT],r=>{t.cryptoStore.storeCrossSigningKeys(r,t.crossSigningInfo.keys)})})()}checkDeviceVerifications(e){var t=this;return S(function*(){var r=t.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(r){if(p.info("Starting device verification upgrade for ".concat(e)),t.crossSigningInfo.keys.user_signing){var n=t.deviceList.getStoredCrossSigningForUser(e);if(n){var s=yield t.checkForDeviceVerificationUpgrade(e,n);if(s){var o=yield r({users:{[e]:s}});o.includes(e)&&(yield t.baseApis.setDeviceVerified(e,n.getId()))}}}p.info("Finished device verification upgrade for ".concat(e))}})()}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(Yt.Membership,this.onMembership),e.on(_e.ToDeviceEvent,this.onToDeviceEvent),e.on(ye.Timeline,this.onTimelineEvent),e.on(Fe.Decrypted,this.onTimelineEvent)}start(){p.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop(),this.backupManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}getOwnDeviceKeys(){var e=this;return S(function*(){if(!e.olmDevice.deviceCurve25519Key)throw new Error("Curve25519 key not yet created");if(!e.olmDevice.deviceEd25519Key)throw new Error("Ed25519 key not yet created");return{ed25519:e.olmDevice.deviceEd25519Key,curve25519:e.olmDevice.deviceCurve25519Key}})()}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){var e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then(()=>this.baseApis.uploadKeysRequest({device_keys:e}))}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){var e=this,t=1e3*60,r=5;if(!this.oneTimeKeyCheckInProgress){var n=Date.now();if(!(this.lastOneTimeKeyCheck!==null&&n-this.lastOneTimeKeyCheck<t)){this.lastOneTimeKeyCheck=n;var s=this.olmDevice.maxNumberOfOneTimeKeys(),o=Math.floor(s/2),a=function(){var l=S(function*(u){for(;o>u||e.getNeedsNewFallback();){if(o>u){p.info("generating oneTimeKeys");var c=Math.min(o-u,r);yield e.olmDevice.generateOneTimeKeys(c)}if(e.getNeedsNewFallback()){var d=yield e.olmDevice.getFallbackKey();(!d.curve25519||Object.keys(d.curve25519).length==0)&&(p.info("generating fallback key"),e.fallbackCleanup&&(clearTimeout(e.fallbackCleanup),delete e.fallbackCleanup),yield e.olmDevice.generateFallbackKey())}p.info("calling uploadOneTimeKeys");var h=yield e.uploadOneTimeKeys();if(h.one_time_key_counts&&h.one_time_key_counts.signed_curve25519)u=h.one_time_key_counts.signed_curve25519;else throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")}});return function(c){return l.apply(this,arguments)}}();this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>this.oneTimeKeyCount!==void 0?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(l=>l.one_time_key_counts.signed_curve25519||0)).then(l=>a(l)).catch(l=>{p.error("Error uploading one-time keys",l.stack||l)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}}}uploadOneTimeKeys(){var e=this;return S(function*(){var t=[],r;if(e.getNeedsNewFallback()){r={};var n=yield e.olmDevice.getFallbackKey();for(var[s,o]of Object.entries(n.curve25519)){var a={key:o,fallback:!0};r["signed_curve25519:"+s]=a,t.push(e.signObject(a))}e.needsNewFallback=!1}var l=yield e.olmDevice.getOneTimeKeys(),u={};for(var c in l.curve25519)if(l.curve25519.hasOwnProperty(c)){var d={key:l.curve25519[c]};u["signed_curve25519:"+c]=d,t.push(e.signObject(d))}yield Promise.all(t);var h={one_time_keys:u};r&&(h["org.matrix.msc2732.fallback_keys"]=r,h.fallback_keys=r);var g=yield e.baseApis.uploadKeysRequest(h);return r&&(e.fallbackCleanup=setTimeout(()=>{delete e.fallbackCleanup,e.olmDevice.forgetOldFallbackKey()},60*60*1e3)),yield e.olmDevice.markKeysAsPublished(),g})()}downloadKeys(e,t){return this.deviceList.downloadKeys(e,!!t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getUserDeviceInfo(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,s=new Map,o=[],a=function*(d){var h=yield r.getStoredDevicesForUser(d);if(h){var g=new Map(h.map(v=>[v.deviceId,kg(v,d)]));s.set(d,g)}else o.push(d)};for(var l of e)yield*a(l);if(n&&o.length>0){var u=yield r.downloadKeys(o);u.forEach((c,d)=>{var h=new Map;c.forEach((g,v)=>h.set(v,kg(g,d))),s.set(d,h)})}return s})()}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}setDeviceVerified(e,t){var r=arguments,n=this;return S(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!0;yield n.setDeviceVerification(e,t,s)})()}crossSignDevice(e){var t=this;return S(function*(){yield t.setDeviceVerified(t.userId,e,!0)})()}setDeviceVerification(e,t){var r=arguments,n=this;return S(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:null,o=r.length>3&&r[3]!==void 0?r[3]:null,a=r.length>4&&r[4]!==void 0?r[4]:null,l=r.length>5?r[5]:void 0,u=n.deviceList.getStoredCrossSigningForUser(e);if((u==null?void 0:u.getId())===t){if(o!==null||a!==null)throw new Error("Cannot set blocked or known for a cross-signing key");if(!s)throw new Error("Cannot set a cross-signing key as unverified");var c=l?Object.values(l)[0]:null;if(l&&(Object.values(l).length!==1||c!==u.getId()))throw new Error("Key did not match expected value: expected ".concat(u.getId(),", got ").concat(c));if(!n.crossSigningInfo.getId()&&e===n.crossSigningInfo.userId&&(n.storeTrustedSelfKeys(u.keys),n.emit(Ce.UserTrustStatusChanged,n.userId,n.checkUserTrust(e))),e!==n.userId){p.info("Master key "+u.getId()+" for "+e+" marked verified. Signing...");var d=yield n.crossSigningInfo.signUser(u);if(d){var h=function(){var C=S(function*(w){var{shouldEmit:D=!1}=w;p.info("Uploading signature for "+e+"...");var x=yield n.baseApis.uploadKeySignatures({[e]:{[t]:d}}),{failures:G}=x||{};if(Object.keys(G||[]).length>0)throw D&&n.baseApis.emit(Ce.KeySignatureUploadFailure,G,"setDeviceVerification",h),new wo("Key upload failed",{failures:G})});return function(D){return C.apply(this,arguments)}}();yield h({shouldEmit:!0})}return d}else return u}var g=n.deviceList.getRawStoredDevicesForUser(e);if(!g||!g[t])throw new Error("Unknown device "+e+":"+t);var v=g[t],m=v.verified;if(s){if(l){for(var[E,R]of Object.entries(l))if(v.keys[E]!==R)throw new Error("Key did not match expected value: expected ".concat(R,", got ").concat(v.keys[E]))}m=sn.VERIFIED}else s!==null&&m==sn.VERIFIED&&(m=sn.UNVERIFIED);o?m=sn.BLOCKED:o!==null&&m==sn.BLOCKED&&(m=sn.UNVERIFIED);var _=v.known;if(a!==null&&(_=a),(v.verified!==m||v.known!==_)&&(v.verified=m,v.known=_,n.deviceList.storeDevicesForUser(e,g),n.deviceList.saveIfDirty()),s&&e===n.userId){p.info("Own device "+t+" marked verified: signing");var T,b=n.checkDeviceTrust(e,t);if(b.isCrossSigningVerified()?p.log("Own device ".concat(t," already cross-signing verified")):T=yield n.crossSigningInfo.signDevice(e,er.fromStorage(v,t)),T){var I=function(){var C=S(function*(w){var{shouldEmit:D=!1}=w;p.info("Uploading signature for "+t);var x=yield n.baseApis.uploadKeySignatures({[e]:{[t]:T}}),{failures:G}=x||{};if(Object.keys(G||[]).length>0)throw D&&n.baseApis.emit(Ce.KeySignatureUploadFailure,G,"setDeviceVerification",I),new wo("Key upload failed",{failures:G})});return function(D){return C.apply(this,arguments)}}();yield I({shouldEmit:!0})}}var y=er.fromStorage(v,t);return n.emit(Ce.DeviceVerificationChanged,e,t,y),y})()}findVerificationRequestDMInProgress(e,t){return this.inRoomVerificationRequests.findRequestInProgress(e,t)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){var r=this.inRoomVerificationRequests.findRequestInProgress(t);if(r)return Promise.resolve(r);var n=new Ut(this.baseApis,t,e);return this.requestVerificationWithChannel(e,n,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));var r=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(r)return Promise.resolve(r);var n=new Dt(this.baseApis,e,t,Dt.makeTransactionId());return this.requestVerificationWithChannel(e,n,this.toDeviceVerificationRequests)}requestOwnUserVerification(){return this.requestVerification(this.userId)}requestDeviceVerification(e,t){return this.requestVerification(e,[t])}requestVerificationWithChannel(e,t,r){var n=this;return S(function*(){var s=new ki(t,n.verificationMethods,n.baseApis);t.transactionId&&r.setRequestByChannel(t,s),yield s.sendRequest();var o=r.getRequestByChannel(t);return o?s=o:(p.log("Crypto: adding new request to "+"requestsByTxnId with id ".concat(t.transactionId," ").concat(t.roomId)),r.setRequestByChannel(t,s)),s})()}beginKeyVerification(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null,s;if(n){if(s=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!s)throw new Error("No request found for user ".concat(t," with ")+"transactionId ".concat(n))}else{n=Dt.makeTransactionId();var o=new Dt(this.baseApis,t,[r],n,r);s=new ki(o,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,s)}return s.beginKeyVerification(e,{userId:t,deviceId:r})}legacyDeviceVerification(e,t,r){var n=this;return S(function*(){var s=Dt.makeTransactionId(),o=new Dt(n.baseApis,e,[t],s,t),a=new ki(o,n.verificationMethods,n.baseApis);n.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,s,a);var l=a.beginKeyVerification(r,{userId:e,deviceId:t});return yield Promise.race([l.verify(),a.waitFor(u=>u.started)]),a})()}getOlmSessionsForUser(e){var t=this;return S(function*(){var r=t.getStoredDevicesForUser(e)||[],n={};for(var s of r){var o=s.getIdentityKey(),a=yield t.olmDevice.getSessionInfoForDevice(o);n[s.deviceId]={deviceIdKey:o,sessions:a}}return n})()}getEventSenderDeviceInfo(e){var t=e.getSenderKey(),r=e.getWireContent().algorithm;if(!t||!r||e.isKeySourceUntrusted())return null;var n=this.deviceList.getDeviceByIdentityKey(r,t);if(n===null)return null;var s=e.getClaimedEd25519Key();return s?s!==n.getFingerprint()?(p.warn("Event "+e.getId()+" claims ed25519 key "+s+" but sender device has key "+n.getFingerprint()),null):n:(p.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){var t,r,n={};if(n.senderKey=(t=e.getSenderKey())!==null&&t!==void 0?t:void 0,n.algorithm=e.getWireContent().algorithm,!n.senderKey||!n.algorithm)return n.encrypted=!1,n;n.encrypted=!0,e.isKeySourceUntrusted()?n.authenticated=!1:n.authenticated=!0,n.sender=(r=this.deviceList.getDeviceByIdentityKey(n.algorithm,n.senderKey))!==null&&r!==void 0?r:void 0;var s=e.getClaimedEd25519Key();return s||(p.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),n.mismatchedSender=!0),n.sender&&s!==n.sender.getFingerprint()&&(p.warn("Event "+e.getId()+" claims ed25519 key "+s+"but sender device has key "+n.sender.getFingerprint()),n.mismatchedSender=!0),n}getEncryptionInfoForEvent(e){var t=this;return S(function*(){var r=t.getEventEncryptionInfo(e);if(!r.encrypted)return null;var n=e.getSender();if(!n||r.mismatchedSender)return{shieldColour:Nn.RED,shieldReason:ts.MISMATCHED_SENDER_KEY};var s=t.checkUserTrust(n);if(!s.isCrossSigningVerified())return r.authenticated?{shieldColour:Nn.NONE,shieldReason:null}:{shieldColour:Nn.GREY,shieldReason:ts.AUTHENTICITY_NOT_GUARANTEED};var o=n&&r.sender&&(yield t.getDeviceVerificationStatus(n,r.sender.deviceId));return o?o.isVerified()?r.authenticated?{shieldColour:Nn.NONE,shieldReason:null}:{shieldColour:Nn.GREY,shieldReason:ts.AUTHENTICITY_NOT_GUARANTEED}:{shieldColour:Nn.RED,shieldReason:ts.UNSIGNED_DEVICE}:{shieldColour:Nn.GREY,shieldReason:ts.UNKNOWN_DEVICE}})()}forceDiscardSession(e){var t=this.roomEncryptors.get(e);if(t===void 0)throw new Error("Room not encrypted");if(t.forceDiscardSession===void 0)throw new Error("Room encryption algorithm doesn't support session discarding");return t.forceDiscardSession(),Promise.resolve()}setRoomEncryption(e,t,r){var n=this;return S(function*(){var s=n.clientStore.getRoom(e);if(!s)throw new Error("Unable to enable encryption tracking devices in unknown room ".concat(e));yield n.setRoomEncryptionImpl(s,t),!n.lazyLoadMembers&&!r&&n.deviceList.refreshOutdatedDeviceLists()})()}setRoomEncryptionImpl(e,t){var r=this;return S(function*(){var n=e.roomId;if(!t.algorithm){p.log("Ignoring setRoomEncryption with no algorithm");return}var s=r.roomList.getRoomEncryption(n);if(s&&JSON.stringify(s)!=JSON.stringify(t)){p.error("Ignoring m.room.encryption event which requests a change of config in "+n);return}var o=r.roomEncryptors.get(n);if(!o){var a=null;s||(a=r.roomList.setRoomEncryption(n,t));var l=bS.get(t.algorithm);if(!l)throw new Error("Unable to encrypt with "+t.algorithm);var u=new l({userId:r.userId,deviceId:r.deviceId,crypto:r,olmDevice:r.olmDevice,baseApis:r.baseApis,roomId:n,config:t});if(r.roomEncryptors.set(n,u),a&&(yield a),p.log("Enabling encryption in ".concat(n)),e.membersLoaded())yield r.trackRoomDevicesImpl(e);else{var c=d=>{e.off(Ae.Update,c),e.membersLoaded()&&r.trackRoomDevicesImpl(e).catch(h=>{p.error("Error enabling device tracking in ".concat(n),h)})};e.on(Ae.Update,c)}}})()}trackRoomDevices(e){var t=this.clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room ".concat(e));return this.trackRoomDevicesImpl(t)}trackRoomDevicesImpl(e){var t=this,r=e.roomId,n=function(){var o=S(function*(){if(t.roomEncryptors.has(r)){p.log("Starting to track devices for room ".concat(r," ..."));var a=yield e.getEncryptionTargetMembers();a.forEach(l=>{t.deviceList.startTrackingDeviceList(l.userId)})}});return function(){return o.apply(this,arguments)}}(),s=this.roomDeviceTrackingState[r];return s||(s=n(),this.roomDeviceTrackingState[r]=s.catch(o=>{throw delete this.roomDeviceTrackingState[r],o})),s}ensureOlmSessionsForUsers(e,t){var r=new Map;for(var n of e){var s=[];r.set(n,s);var o=this.getStoredDevicesForUser(n)||[];for(var a of o){var l=a.getIdentityKey();l!=this.olmDevice.deviceCurve25519Key&&a.verified!=sn.BLOCKED&&s.push(a)}}return Rn(this.olmDevice,this.baseApis,r,t)}exportRoomKeys(){var e=this;return S(function*(){var t=[];return yield e.cryptoStore.doTxn("readonly",[fe.STORE_INBOUND_GROUP_SESSIONS],r=>{e.cryptoStore.getAllEndToEndInboundGroupSessions(r,n=>{if(n!==null){var s=e.olmDevice.exportInboundGroupSession(n.senderKey,n.sessionId,n.sessionData);delete s.first_known_index,s.algorithm=nr,t.push(s)}})}),t})()}exportRoomKeysAsJson(){var e=this;return S(function*(){return JSON.stringify(yield e.exportRoomKeys())})()}importRoomKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=0,n=0,s=e.length;function o(){var a;(a=t.progressCallback)===null||a===void 0||a.call(t,{stage:"load_keys",successes:r,failures:n,total:s})}return Promise.all(e.map(a=>{if(!a.room_id||!a.algorithm)return p.warn("ignoring room key entry with missing fields",a),n++,t.progressCallback&&o(),null;var l=this.getRoomDecryptor(a.room_id,a.algorithm);return l.importRoomKey(a,t).finally(()=>{r++,t.progressCallback&&o()})})).then()}importRoomKeysAsJson(e,t){var r=this;return S(function*(){return yield r.importRoomKeys(JSON.parse(e))})()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){var t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}encryptEvent(e,t){var r=this;return S(function*(){var n=e.getRoomId(),s=r.roomEncryptors.get(n);if(!s)throw new Error("Room "+n+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");yield r.trackRoomDevicesImpl(t);var o=e.getContent(),a=o["m.relates_to"];a&&(o=Object.assign({},o),delete o["m.relates_to"]);var l=o["io.element.performance_metrics"];l&&(o=Object.assign({},o),delete o["io.element.performance_metrics"]);var u=yield s.encryptMessage(t,e.getType(),o);a&&(u["m.relates_to"]=a),l&&(u["io.element.performance_metrics"]=l),e.makeEncrypted("m.room.encrypted",u,r.olmDevice.deviceCurve25519Key,r.olmDevice.deviceEd25519Key)})()}decryptEvent(e){var t=this;return S(function*(){if(e.isRedacted()){var r=new Ot(B0({room_id:e.getRoomId()},e.getUnsigned().redacted_because)),n=e.getUnsigned().redacted_because;if(r.isEncrypted())try{var s=yield t.decryptEvent(r);n=s.clearEvent}catch(l){p.warn("Decryption of redaction failed. Falling back to unencrypted event.",l)}return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n}}}}else{var o=e.getWireContent(),a=t.getRoomDecryptor(e.getRoomId(),o.algorithm);return a.decryptEvent(e)}})()}processDeviceLists(e){var t=this;return S(function*(){yield t.evalDeviceListChanges(e)})()}requestRoomKey(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,r).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(n=>{p.error("Error requesting key for event",n)})}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(t=>{p.warn("Error clearing pending room key requests",t)})}cancelAndResendAllOutgoingKeyRequests(){var e=this;return S(function*(){yield e.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()})()}onCryptoEvent(e,t){var r=this;return S(function*(){var n=t.getContent();yield r.setRoomEncryptionImpl(e,n)})()}onSyncWillProcess(e){var t=this;return S(function*(){e.oldSyncToken||(p.log("Initial sync performed - resetting device tracking state"),t.deviceList.stopTrackingAllDeviceLists(),t.deviceList.startTrackingDeviceList(t.userId),t.roomDeviceTrackingState={}),t.sendKeyRequestsImmediately=!1})()}onSyncCompleted(e){var t=this;return S(function*(){var r;t.deviceList.setSyncToken((r=e.nextSyncToken)!==null&&r!==void 0?r:null),t.deviceList.saveIfDirty(),t.deviceList.startTrackingDeviceList(t.userId),t.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(t.maybeUploadOneTimeKeys(),t.processReceivedRoomKeyRequests(),t.outgoingRoomKeyRequestManager.sendQueuedRequests(),t.sendKeyRequestsImmediately=!0)})()}evalDeviceListChanges(e){var t=this;return S(function*(){if(Array.isArray(e==null?void 0:e.changed)&&e.changed.forEach(n=>{t.deviceList.invalidateUserDeviceList(n)}),Array.isArray(e==null?void 0:e.left)&&e.left.length){var r=new Set(yield t.getTrackedE2eUsers());e.left.forEach(n=>{r.has(n)||t.deviceList.stopTrackingDeviceList(n)})}})()}getTrackedE2eUsers(){var e=this;return S(function*(){var t=[];for(var r of e.getTrackedE2eRooms()){var n=yield r.getEncryptionTargetMembers();for(var s of n)t.push(s.userId)}return t})()}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(e=>{var t=this.roomEncryptors.get(e.roomId);if(!t||!this.roomDeviceTrackingState[e.roomId])return!1;var r=e.getMyMembership();return r===Oe.Join||r===Oe.Invite})}encryptAndSendToDevices(e,t){var r=this;return S(function*(){var n={eventType:F.RoomMessageEncrypted,batch:[]};try{yield Promise.all(e.map(function(){var s=S(function*(o){var{userId:a,deviceInfo:l}=o,u=l.deviceId,c={algorithm:kt,sender_key:r.olmDevice.deviceCurve25519Key,ciphertext:{},[Zt]:Ar()};n.batch.push({userId:a,deviceId:u,payload:c}),yield Rn(r.olmDevice,r.baseApis,new Map([[a,[l]]])),yield Xn(c.ciphertext,r.userId,r.deviceId,r.olmDevice,a,l,t)});return function(o){return s.apply(this,arguments)}}())),n.batch=n.batch.filter(s=>Object.keys(s.payload.ciphertext).length>0?!0:(p.log("No ciphertext for device ".concat(s.userId,":").concat(s.deviceId,": pruning")),!1));try{yield r.baseApis.queueToDevice(n)}catch(s){throw p.error("sendToDevice failed",s),s}}catch(s){throw p.error("encryptAndSendToDevices promises failed",s),s}})()}preprocessToDeviceMessages(e){return S(function*(){return e.filter(t=>{var r;return t.type===F.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes((r=t.content)===null||r===void 0?void 0:r.algorithm)?(p.log("Ignoring invalid encrypted to-device event from "+t.sender),!1):!0})})()}updateOneTimeKeyCount(e){if(isFinite(e))this.oneTimeKeyCount=e;else throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number")}processKeyCounts(e,t){return e!==void 0&&this.updateOneTimeKeyCount(e.signed_curve25519||0),t!==void 0&&(this.needsNewFallback=!t.includes("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(e){var t=e.getContent();if(!t.room_id||!t.algorithm){p.error("key event is missing fields");return}this.backupManager.checkedForBackup||this.backupManager.checkAndStart();var r=this.getRoomDecryptor(t.room_id,t.algorithm);r.onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){var t=e.getContent();if(t.code!=="m.no_olm"&&(!t.room_id||!t.session_id)||!t.algorithm||!t.sender_key){p.error("key withheld event is missing fields");return}p.info("Got room key withheld event from ".concat(e.getSender()," ")+"for ".concat(t.algorithm," session ").concat(t.sender_key,"|").concat(t.session_id," ")+"in room ".concat(t.room_id," with code ").concat(t.code," (").concat(t.reason,")"));var r=this.getRoomDecryptor(t.room_id,t.algorithm);if(r.onRoomKeyWithheldEvent&&r.onRoomKeyWithheldEvent(e),!t.room_id){var n=this.getRoomDecryptors(t.algorithm);for(var s of n)s.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(Dt.validateEvent(e,this.baseApis)){var t=r=>{if(Dt.canCreateRequest(Dt.getEventType(r))){var n=r.getContent(),s=n&&n.from_device;if(s){var o=r.getSender(),a=new Dt(this.baseApis,o,[s]);return new ki(a,this.verificationMethods,this.baseApis)}}};this.handleVerificationEvent(e,this.toDeviceVerificationRequests,t)}}handleVerificationEvent(e,t,r){var n=arguments,s=this;return S(function*(){var o=n.length>3&&n[3]!==void 0?n[3]:!0;if(e.isSending()&&e.status!=Re.SENT){var a,l;try{yield new Promise((h,g)=>{a=h,l=()=>{e.status==Re.CANCELLED&&g(new Error("Event status set to CANCELLED."))},e.once(Fe.LocalEventIdReplaced,a),e.on(Fe.Status,l)})}catch(h){p.error("error while waiting for the verification event to be sent: ",h);return}finally{e.removeListener(Fe.LocalEventIdReplaced,a),e.removeListener(Fe.Status,l)}}var u=t.getRequest(e),c=!1;if(!u){if(u=r(e),!u){p.log("Crypto: could not find VerificationRequest for "+"".concat(e.getType(),", and could not create one, so ignoring."));return}c=!0,t.setRequest(e,u)}e.setVerificationRequest(u);try{yield u.channel.handleEvent(e,u,o)}catch(h){p.error("error while handling verification event",h)}var d=c&&!u.initiatedByMe&&!u.invalid&&!u.observeOnly;d&&(s.baseApis.emit(Ce.VerificationRequest,u),s.baseApis.emit(Ce.VerificationRequestReceived,u))})()}onToDeviceBadEncrypted(e){var t=this;return S(function*(){var r=e.getWireContent(),n=e.getSender(),s=r.algorithm,o=r.sender_key;t.baseApis.emit(_e.UndecryptableToDeviceEvent,e);var a=()=>{var m=t.getRoomDecryptors(nr);for(var E of m)E.retryDecryptionFromSender(o)};if(!(n===void 0||o===void 0||o===void 0)){var l=t.forceNewSessionRetryTime.getOrCreate(n),u=l.getOrCreate(o);if(u>Date.now()){p.debug("New session already forced with device ".concat(n,":").concat(o,": ")+"not forcing another until at least ".concat(new Date(u).toUTCString())),yield t.olmDevice.recordSessionProblem(o,"wedged",!0),a();return}l.set(o,Date.now()+q0);var c=t.deviceList.getDeviceByIdentityKey(s,o);if(!c&&(yield t.downloadKeys([n],!1),c=t.deviceList.getDeviceByIdentityKey(s,o),!c)){p.info("Couldn't find device for identity key "+o+": not re-establishing session"),yield t.olmDevice.recordSessionProblem(o,"wedged",!1),a();return}var d=new Map([[n,[c]]]);yield Rn(t.olmDevice,t.baseApis,d,!0),l.set(o,Date.now()+j0);var h={algorithm:kt,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[Zt]:Ar()};yield Xn(h.ciphertext,t.userId,t.deviceId,t.olmDevice,n,c,{type:"m.dummy"}),yield t.olmDevice.recordSessionProblem(o,"wedged",!0),a(),yield t.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[c.deviceId,h]])]]));var g=yield t.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,c.deviceId);for(var v of g)t.requestRoomKey(v.requestBody,v.recipients,!0)}})()}onRoomMembership(e,t,r){var n=t.roomId,s=this.roomEncryptors.get(n);if(s){if(n in this.roomDeviceTrackingState){var o;t.membership==Oe.Join?(p.log("Join event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId)):t.membership==Oe.Invite&&(o=this.clientStore.getRoom(n))!==null&&o!==void 0&&o.shouldEncryptForInvitedMembers()&&(p.log("Invite event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId))}s.onRoomMembership(e,t,r)}}onRoomKeyRequestEvent(e){var t=e.getContent();if(t.action==="request"){var r=new V0(e);this.receivedRoomKeyRequests.push(r)}else if(t.action==="request_cancellation"){var n=new W0(e);this.receivedRoomKeyRequestCancellations.push(n)}}processReceivedRoomKeyRequests(){var e=this;return S(function*(){if(!e.processingRoomKeyRequests){e.processingRoomKeyRequests=!0;try{var t=e.receivedRoomKeyRequests;e.receivedRoomKeyRequests=[];var r=e.receivedRoomKeyRequestCancellations;e.receivedRoomKeyRequestCancellations=[],yield Promise.all(t.map(n=>e.processReceivedRoomKeyRequest(n))),yield Promise.all(r.map(n=>e.processReceivedRoomKeyRequestCancellation(n)))}catch(n){p.error("Error processing room key requsts: ".concat(n))}finally{e.processingRoomKeyRequests=!1}}})()}processReceivedRoomKeyRequest(e){var t=this;return S(function*(){var r=e.userId,n=e.deviceId,s=e.requestBody,o=s.room_id,a=s.algorithm;if(p.log("m.room_key_request from ".concat(r,":").concat(n)+" for ".concat(o," / ").concat(s.session_id," (id ").concat(e.requestId,")")),r!==t.userId){if(!t.roomEncryptors.get(o)){p.debug("room key request for unencrypted room ".concat(o));return}var l=t.roomEncryptors.get(o),u=t.deviceList.getStoredDevice(r,n);if(!u){p.debug("Ignoring keyshare for unknown device ".concat(r,":").concat(n));return}try{yield l.reshareKeyWithDevice(s.sender_key,s.session_id,r,u)}catch(d){p.warn("Failed to re-share keys for session "+s.session_id+" with device "+r+":"+u.deviceId,d)}return}if(n===t.deviceId){p.log("Ignoring room key request from ourselves");return}if(!t.roomDecryptors.has(o)){p.log("room key request for unencrypted room ".concat(o));return}var c=t.roomDecryptors.get(o).get(a);if(!c){p.log("room key request for unknown alg ".concat(a," in room ").concat(o));return}if(!(yield c.hasKeysForKeyRequest(e))){p.log("room key request for unknown session ".concat(o," / ")+s.session_id);return}if(e.share=()=>{c.shareKeysWithDevice(e)},t.checkDeviceTrust(r,n).isVerified()){p.log("device is already verified: sharing keys"),e.share();return}t.emit(Ce.RoomKeyRequest,e)})()}processReceivedRoomKeyRequestCancellation(e){var t=this;return S(function*(){p.log("m.room_key_request cancellation for ".concat(e.userId,":")+"".concat(e.deviceId," (id ").concat(e.requestId,")")),t.emit(Ce.RoomKeyRequestCancellation,e)})()}getRoomDecryptor(e,t){var r,n;if(e&&(r=this.roomDecryptors.get(e),r||(r=new Map,this.roomDecryptors.set(e,r)),n=r.get(t),n))return n;var s=dd.get(t);if(!s)throw new wt(bt.UNKNOWN_ENCRYPTION_ALGORITHM,'Unknown encryption algorithm "'+t+'".');return n=new s({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e??void 0}),r&&r.set(t,n),n}getRoomDecryptors(e){var t=[];for(var r of this.roomDecryptors.values())r.has(e)&&t.push(r.get(e));return t}signObject(e){var t=this;return S(function*(){var r=new Map(Object.entries(e.signatures||{})),n=e.unsigned;delete e.signatures,delete e.unsigned;var s=r.get(t.userId)||{};r.set(t.userId,s),s["ed25519:"+t.deviceId]=yield t.olmDevice.sign(wn.stringify(e)),e.signatures=Ui(r),n!==void 0&&(e.unsigned=n)})()}isRoomEncrypted(e){return this.roomList.isRoomEncrypted(e)}isEncryptionEnabledInRoom(e){var t=this;return S(function*(){return t.isRoomEncrypted(e)})()}getRoomEncryption(e){return this.roomList.getRoomEncryption(e)}isDehydrationSupported(){return S(function*(){return!1})()}startDehydration(e){return S(function*(){throw new Error("Not implemented")})()}}function tl(i){if(typeof i!="string"||i.indexOf(",")<0)return null;var e=Uint8Array.from(i.split(","),t=>parseInt(t));return zt(e)}class V0{constructor(e){f(this,"userId",void 0),f(this,"deviceId",void 0),f(this,"requestId",void 0),f(this,"requestBody",void 0),f(this,"share",void 0);var t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class W0{constructor(e){f(this,"userId",void 0),f(this,"deviceId",void 0),f(this,"requestId",void 0);var t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}class G0{constructor(e){this.ourEvent=e,f(this,"timeline",void 0),f(this,"ourEventIndex",0),f(this,"paginateTokens",{[Ue.Backward]:null,[Ue.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?Ue.Backward:Ue.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?Ue.Backward:Ue.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class ou{static fromJson(e,t){var r=e.context||{},n=(r.events_before||[]).map(t),s=(r.events_after||[]).map(t),o=new G0(t(e.result)),a=o.ourEvent.threadRootId;return n=n.filter(l=>l.threadRootId===a),s=s.filter(l=>l.threadRootId===a),o.setPaginateToken(r.start,!0),o.addEvents(n,!0),o.addEvents(s,!1),o.setPaginateToken(r.end,!1),new ou(e.rank,o)}constructor(e,t){this.rank=e,this.context=t}}var H0=function(i){return i.Public="public",i.Private="private",i}({}),Th=function(i){return i.PrivateChat="private_chat",i.TrustedPrivateChat="trusted_private_chat",i.PublicChat="public_chat",i}({}),DS=function(i){return i.Public="public",i.Invite="invite",i.Private="private",i.Knock="knock",i.Restricted="restricted",i}({}),$0=function(i){return i.RoomMembership="m.room_membership",i}({}),kl=function(i){return i.CanJoin="can_join",i.Forbidden="forbidden",i}({}),Ih=function(i){return i.Invited="invited",i.Joined="joined",i.Shared="shared",i.WorldReadable="world_readable",i}({});function Pg(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Mg(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Pg(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Pg(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function z0(i,e){var t=!!e.preventReEmit,r=e.decrypt!==!1;function n(s){e.toDevice&&delete s.room_id;var o=i.getRoom(s.room_id),a;o&&s.state_key===void 0&&(a=o.findEventById(s.event_id)),!a||a.status?a=new Ot(s):(a.setUnsigned(Mg(Mg({},a.getUnsigned()),s.unsigned)),t=!0);var l=a.getServerAggregatedRelation(lt.Replace);if(l!=null&&l.content){var u=n(l);a.makeReplaced(u)}var c=o==null?void 0:o.findThreadForEvent(a);return c&&a.setThread(c),a.isEncrypted()&&(t||i.reEmitter.reEmit(a,[Fe.Decrypted]),r&&i.decryptEventIfNeeded(a)),t||(i.reEmitter.reEmit(a,[Fe.Replaced,Fe.VisibilityChange]),o==null||o.reEmitter.reEmit(a,[Fe.BeforeRedaction])),a}return n}function Ag(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function An(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ag(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Ag(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class Dg{constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return S(function*(){yield e.client.sendStateEvent(e.roomId,pn.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return S(function*(){yield t.client.sendStateEvent(t.roomId,pn.name,An(An({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return S(function*(){yield t.client.sendStateEvent(t.roomId,pn.name,An(An({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return S(function*(){var t=yield e.getFileEvent(),r=t.getOriginalContent().file,n=e.client.mxcUrlToHttp(r.url);if(!n)throw new Error("No HTTP URL available for ".concat(r.url));return{info:r,httpUrl:n}})()}getFileEvent(){var e=this;return S(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var r=t.getUnfilteredTimelineSet().findEventById(e.id);!r&&t.getLiveTimeline().getState(ve.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),r=t.getUnfilteredTimelineSet().findEventById(e.id);if(!r)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(r),r})()}createNewVersion(e,t,r,n){var s=this;return S(function*(){var o=yield s.directory.createFile(e,t,r,An(An({},n??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:lt.Replace,event_id:s.id}}));return yield s.client.sendStateEvent(s.roomId,pn.name,{active:!0,name:e,version:s.version+1},o.event_id),yield s.client.sendStateEvent(s.roomId,pn.name,An(An({},s.indexEvent.getContent()),{},{active:!1}),s.id),o})()}getVersionHistory(){var e=this;return S(function*(){var t=[];t.push(e);var r=e.client.getRoom(e.roomId);if(!r)throw new Error("Invalid or unknown room");var n=[...r.getLiveTimeline().getEvents()].reverse(),s,o=yield e.getFileEvent();do if(s=n.find(l=>l.replacingEventId()===o.getId()),s){var a=e.directory.getFile(s.getId());if(a)t.push(a),o=s;else break}while(s);return t})()}}function Ug(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function mi(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ug(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Ug(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var J0={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[F.RoomPowerLevels]:100,[F.RoomHistoryVisibility]:100,[F.RoomTombstone]:100,[F.RoomEncryption]:100,[F.RoomName]:50,[F.RoomMessage]:50,[F.RoomMessageEncrypted]:50,[F.Sticker]:50},users:{}},zi=function(i){return i.Viewer="viewer",i.Editor="editor",i.Owner="owner",i}({});class Lg{constructor(e,t){if(this.client=e,this.roomId=t,f(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(F.SpaceParent);return e!=null&&e.length?e.every(t=>{var r;return!((r=t.getContent())!==null&&r!==void 0&&r.via)}):!0}setName(e){var t=this;return S(function*(){yield t.client.sendStateEvent(t.roomId,F.RoomName,{name:e},"")})()}invite(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!0,s=t.length>2&&t[2]!==void 0?t[2]:!0,o=[r.retryInvite(e)];return n&&o.push(...r.getDirectories().map(a=>a.invite(e,n,s))),Promise.all(o).then(()=>{s&&TS(r.room)&&r.client.sendSharedHistoryKeys(r.roomId,[e])})})()}retryInvite(e){var t=this;return RR(S(function*(){yield t.client.invite(t.roomId,e).catch(r=>{throw(r==null?void 0:r.errcode)==="M_FORBIDDEN"?new ly.AbortError(r):r})}))}setPermissions(e,t){var r=this;return S(function*(){var n,s=r.room.currentState.getStateEvents(F.RoomPowerLevels,"");if(Array.isArray(s))throw new Error("Unexpected return type for power levels");var o=(s==null?void 0:s.getContent())||{},a=o.users_default||0,l=o.events_default||50,u=((n=o.events)===null||n===void 0?void 0:n[F.RoomPowerLevels])||100,c=o.users||{};switch(t){case zi.Viewer:c[e]=a;break;case zi.Editor:c[e]=l;break;case zi.Owner:c[e]=u;break;default:throw new Error("Invalid role: "+t)}o.users=c,yield r.client.sendStateEvent(r.roomId,F.RoomPowerLevels,o,"")})()}getPermissions(e){var t,r,n=this.room.currentState.getStateEvents(F.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");var s=(n==null?void 0:n.getContent())||{},o=s.users_default||0,a=s.events_default||50,l=((t=s.events)===null||t===void 0?void 0:t[F.RoomPowerLevels])||100,u=((r=s.users)===null||r===void 0?void 0:r[e])||o;return u>=l?zi.Owner:u>=a?zi.Editor:zi.Viewer}createDirectory(e){var t=this;return S(function*(){var r=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,F.SpaceChild,{via:[t.client.getDomain()]},r.roomId),yield t.client.sendStateEvent(r.roomId,F.SpaceParent,{via:[t.client.getDomain()]},t.roomId),r})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(F.SpaceChild);for(var r of t)try{var n=r.getStateKey();if(n){var s=this.client.unstableGetFileTreeSpace(n);s&&e.push(s)}}catch(o){p.warn("Unable to create tree space instance for listing. Are we joined?",o)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return S(function*(){var t=e.getDirectories();for(var r of t)yield r.delete();var n=[Oe.Invite,Oe.Knock,Oe.Join],s=e.room.currentState.getStateEvents(F.RoomMember);for(var o of s){var a=o.getStateKey()!==e.client.getUserId();if(a&&n.includes(o.getContent().membership)){var l=o.getStateKey();if(!l)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,l,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(r=>({roomId:r.getStateKey(),order:r.getContent().order})).filter(r=>r.roomId);return t.sort((r,n)=>{if(r.order&&!n.order)return-1;if(!r.order&&n.order)return 1;if(!r.order&&!n.order){var s,o,a,l,u=this.client.getRoom(r.roomId),c=this.client.getRoom(n.roomId);if(!u||!c)return Ya(r.roomId,n.roomId);var d=(s=(o=u.currentState.getStateEvents(F.RoomCreate,""))===null||o===void 0?void 0:o.getTs())!==null&&s!==void 0?s:0,h=(a=(l=c.currentState.getStateEvents(F.RoomCreate,""))===null||l===void 0?void 0:l.getTs())!==null&&a!==void 0?a:0;return d===h?Ya(r.roomId,n.roomId):d-h}else return Ya(r.order,n.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(F.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var r=t.getStateKey();if(!r)throw new Error("No state key found for parent");var n=this.client.getRoom(r);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(F.SpaceChild),r=this.getOrderedChildren(t);return r.findIndex(n=>n.roomId===this.roomId)}setOrder(e){var t=this;return S(function*(){var r;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var n=t.getParentRoom(),s=n.currentState.getStateEvents(F.SpaceChild),o=t.getOrderedChildren(s);e=Math.max(Math.min(e,o.length-1),0);var a=t.getOrder(),l=a<e;l&&e===o.length-1?e--:!l&&e===0&&e++;var u=o[l?e:e-1],c=o[l?e+1:e],d=Qn[0],h=!1;if(!u)c!=null&&c.order&&(d=gv(c.order));else if(e===o.length-1)c!=null&&c.order&&(d=Js(c.order));else{var g=u==null?void 0:u.order,v=c==null?void 0:c.order;g&&v?g===v?d=Js(g):d=TR(g,v):g?d=Js(g):v?d=gv(v):h=!0}if(h){for(var m,E=0;E<=e;E++){var R=o[E];if(E===0&&(m=R.order),R.order)m=R.order;else{var _;m=m?Js(m):Qn[0];var T=n.currentState.getStateEvents(F.SpaceChild,R.roomId),b=(_=T==null?void 0:T.getContent())!==null&&_!==void 0?_:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,F.SpaceChild,mi(mi({},b),{},{order:m}),R.roomId)}}m&&(d=Js(m))}var I=n.currentState.getStateEvents(F.SpaceChild,t.roomId),y=(r=I==null?void 0:I.getContent())!==null&&r!==void 0?r:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,F.SpaceChild,mi(mi({},y),{},{order:d}),t.roomId)})()}createFile(e,t,r,n){var s=this;return S(function*(){var o,{content_uri:a}=yield s.client.uploadContent(t,{includeFilename:!1});r.url=a;var l={msgtype:Nr.File,body:e,url:a,file:r};n=(o=n)!==null&&o!==void 0?o:{},n["m.new_content"]&&(n["m.new_content"]=l);var u=yield s.client.sendMessage(s.roomId,mi(mi(mi({},n),l),{},{[Ty.name]:{}}));return yield s.client.sendStateEvent(s.roomId,pn.name,{active:!0,name:e},u.event_id),u})()}getFile(e){var t=this.room.currentState.getStateEvents(pn.name,e);return t?new Dg(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(pn.name))!==null&&e!==void 0?e:[];return t.map(r=>new Dg(this.client,r,this))}}var US=function(i){return i.Recent="recent",i.Rank="rank",i}({}),Ii=function(i){return i.LocalStreamsChanged="local_streams_changed",i}({});class Y0 extends rt{constructor(e){super(),this.client=e,f(this,"audioInput",void 0),f(this,"audioSettings",void 0),f(this,"videoInput",void 0),f(this,"localUserMediaStream",void 0),f(this,"userMediaStreams",[]),f(this,"screensharingStreams",[]),f(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return S(function*(){p.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return S(function*(){p.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return S(function*(){p.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var r=this;return S(function*(){p.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),r.audioInput=e,r.videoInput=t,yield r.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return S(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var r of e.client.callEventHandler.calls.values())t.set(r.callId,{audio:r.hasLocalUserMediaAudioTrack,video:r.hasLocalUserMediaVideoTrack});for(var n of e.userMediaStreams){p.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(n.id,")"));for(var s of n.getTracks())s.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var o of e.client.callEventHandler.calls.values())if(!(o.callHasEnded()||!t.has(o.callId))){var{audio:a,video:l}=t.get(o.callId);p.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(o.callId,")"));var u=yield e.getUserMediaStream(a,l);o.callHasEnded()||(yield o.updateLocalUsermediaStream(u))}for(var c of e.client.groupCallEventHandler.groupCalls.values())if(c.localCallFeed){p.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(c.groupCallId,")"));var d=yield e.getUserMediaStream(!0,c.type===ru.Video);c.state!==at.Ended&&(yield c.updateLocalUsermediaStream(d))}e.emit(Ii.LocalStreamsChanged)}})()}hasAudioDevice(){return S(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return p.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return S(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return p.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var r=arguments,n=this;return S(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!0;return n.getMediaStreamPromise?n.getMediaStreamPromise=n.getMediaStreamPromise.then(()=>n.getUserMediaStreamInternal(e,t,s)):n.getMediaStreamPromise=n.getUserMediaStreamInternal(e,t,s),n.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,r){var n=this;return S(function*(){var s=e&&(yield n.hasAudioDevice()),o=t&&(yield n.hasVideoDevice()),a,l=!0;if(n.localUserMediaStream){var u,c;s!==n.localUserMediaStream.getAudioTracks().length>0&&(l=!1),o!==n.localUserMediaStream.getVideoTracks().length>0&&(l=!1),s&&((u=n.localUserMediaStream.getAudioTracks()[0])===null||u===void 0||(u=u.getSettings())===null||u===void 0?void 0:u.deviceId)!==n.audioInput&&(l=!1),o&&((c=n.localUserMediaStream.getVideoTracks()[0])===null||c===void 0||(c=c.getSettings())===null||c===void 0?void 0:c.deviceId)!==n.videoInput&&(l=!1)}else l=!1;if(l){var v;if(a=n.localUserMediaStream.clone(),p.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((v=n.localUserMediaStream)===null||v===void 0?void 0:v.id," newStreamId=").concat(a.id," shouldRequestAudio=").concat(s," shouldRequestVideo=").concat(o,")")),!s)for(var m of a.getAudioTracks())a.removeTrack(m);if(!o)for(var E of a.getVideoTracks())a.removeTrack(E)}else{var d=n.getUserMediaContraints(s,o);a=yield navigator.mediaDevices.getUserMedia(d),p.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(a.id,", shouldRequestAudio=").concat(s,", shouldRequestVideo=").concat(o,", constraints=").concat(JSON.stringify(d),")"));for(var h of a.getTracks()){var g=h.getSettings();h.kind==="audio"?n.audioInput=g.deviceId:h.kind==="video"&&(n.videoInput=g.deviceId)}r&&(n.localUserMediaStream=a)}return r&&n.userMediaStreams.push(a),n.emit(Ii.LocalStreamsChanged),a})()}stopUserMediaStream(e){p.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.userMediaStreams.indexOf(e);if(r!==-1&&(p.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(r,1)),this.emit(Ii.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var n of e.getTracks()){var s;if((s=this.localUserMediaStream)!==null&&s!==void 0&&s.getTrackById(n.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return S(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:{},n=e.length>1&&e[1]!==void 0?e[1]:!0,s;if(t.screensharingStreams.length===0){var o=t.getScreenshareContraints(r);r.desktopCapturerSourceId?(p.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(r),")")),s=yield navigator.mediaDevices.getUserMedia(o)):(p.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(r),")")),s=yield navigator.mediaDevices.getDisplayMedia(o))}else{var a=t.screensharingStreams[t.screensharingStreams.length-1];p.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(a.id,")")),s=a.clone()}return n&&t.screensharingStreams.push(s),t.emit(Ii.LocalStreamsChanged),s})()}stopScreensharingStream(e){p.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.screensharingStreams.indexOf(e);r!==-1&&(p.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(r,1)),this.emit(Ii.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){p.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var r of this.screensharingStreams)for(var n of r.getTracks())n.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(Ii.LocalStreamsChanged)}getUserMediaContraints(e,t){var r=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:t?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:r??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:r??!1,video:!0}}}var Ng=function(i){return i.RequestFinished="FINISHED",i.Complete="COMPLETE",i}({}),ba=function(i){return i.PreProcess="ExtState.PreProcess",i.PostProcess="ExtState.PostProcess",i}({}),Ed=function(i){return i.RoomData="SlidingSync.RoomData",i.Lifecycle="SlidingSync.Lifecycle",i.List="SlidingSync.List",i}({}),Q0=3;class X0{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return ba.PreProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return S(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class Z0{constructor(e,t){this.client=e,this.cryptoCallbacks=t,f(this,"nextBatch",null)}name(){return"to_device"}when(){return ba.PreProcess}onRequest(e){var t={since:this.nextBatch!==null?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}onResponse(e){var t=this;return S(function*(){var r=[],n=e.events||[];n.length>0&&t.cryptoCallbacks&&(n=yield t.cryptoCallbacks.preprocessToDeviceMessages(n)),n.map(t.client.getEventMapper()).map(s=>{if(s.getType()==="m.key.verification.cancel"){var o=s.getContent().transaction_id;o&&r.push(o)}return s}).forEach(s=>{var o=s.getContent();if(s.getType()=="m.room.message"&&o.msgtype=="m.bad.encrypted"){p.log("Ignoring undecryptable to-device event from "+s.getSender());return}if(s.getType()==="m.key.verification.start"||s.getType()==="m.key.verification.request"){var a=o.transaction_id;r.includes(a)&&s.flagCancelled()}t.client.emit(_e.ToDeviceEvent,s)}),t.nextBatch=e.next_batch})()}}class eC{constructor(e){this.client=e}name(){return"account_data"}when(){return ba.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return S(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var r in e.rooms){var n=ds(t.client,r,e.rooms[r]),s=t.client.getRoom(r);if(!s){p.warn("got account data for room but room doesn't exist on client:",r);continue}s.addAccountData(n),n.forEach(o=>{t.client.emit(_e.Event,o)})}})()}processGlobalAccountData(e){var t=ds(this.client,void 0,e),r=t.reduce((n,s)=>(n[s.getType()]=this.client.store.getAccountData(s.getType()),n),{});this.client.store.storeAccountDataEvents(t),t.forEach(n=>{if(n.getType()===F.PushRules){var s=n.getContent();this.client.setPushRules(s)}var o=r[n.getType()];return this.client.emit(_e.AccountData,n,o),n})}}class tC{constructor(e){this.client=e}name(){return"typing"}when(){return ba.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return S(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)NS(t.client,r,[e.rooms[r]])})()}}class rC{constructor(e){this.client=e}name(){return"receipts"}when(){return ba.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return S(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)NS(t.client,r,[e.rooms[r]])})()}}class LS{constructor(e,t,r,n){this.slidingSync=e,this.client=t,f(this,"opts",void 0),f(this,"syncOpts",void 0),f(this,"syncState",null),f(this,"syncStateData",void 0),f(this,"lastPos",null),f(this,"failCount",0),f(this,"notifEvents",[]),this.opts=sS(r),this.syncOpts=oS(n),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[ye.Timeline,ye.TimelineReset]),this.slidingSync.on(Ed.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(Ed.RoomData,this.onRoomData.bind(this));var s=[new Z0(this.client,this.syncOpts.cryptoCallbacks),new eC(this.client),new tC(this.client),new rC(this.client)];this.syncOpts.crypto&&s.push(new X0(this.syncOpts.crypto)),s.forEach(o=>{this.slidingSync.registerExtension(o)})}onRoomData(e,t){var r=this;return S(function*(){var n=r.client.store.getRoom(e);if(!n){if(!t.initial){p.debug("initial flag not set but no stored room exists for room ",e,t);return}n=aS(r.client,e,r.opts)}yield r.processRoomData(r.client,n,t)})()}onLifecycle(e,t,r){switch(r&&p.debug("onLifecycle",e,r),e){case Ng.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState($e.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState($e.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case Ng.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>Q0?$e.Error:$e.Reconnecting,{error:new Qt(r)}),this.shouldAbortSync(new Qt(r)))return}else this.failCount=0;break}}syncLeftRooms(){return S(function*(){return[]})()}peek(e){return S(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,r=new eu(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[ye.Name,ye.Redaction,ye.RedactionCancelled,ye.Receipt,ye.Tags,ye.LocalEchoUpdated,ye.AccountData,ye.MyMembership,ye.Timeline,ye.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[Ae.Events,Ae.Members,Ae.NewMember,Ae.Update]),e.currentState.on(Ae.NewMember,(t,r,n)=>{var s;n.user=(s=this.client.getUser(n.userId))!==null&&s!==void 0?s:void 0,this.client.reEmitter.reEmit(n,[Yt.Name,Yt.Typing,Yt.PowerLevel,Yt.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(p.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState($e.Error,{error:e}),!0):!1}processRoomData(e,t,r){var n=this;return S(function*(){r=nC(e,t.roomId,r);var s=ds(n.client,t.roomId,r.required_state),o=ds(n.client,t.roomId,r.timeline,!1),a=[];if(r.initial){var l=new Set;t.getLiveTimeline().getEvents().forEach(_=>{l.add(_.getId())});for(var u=[],c=[],d=!1,h=o.length-1;h>=0;h--){var g=o[h];if(l.has(g.getId())){d=!0;continue}d?u.push(g):c.unshift(g)}o=c,u.length>0&&t.addEventsToTimeline(u,!0,t.getLiveTimeline(),r.prev_batch)}var v=t.hasEncryptionStateEvent();if(r.notification_count!=null&&t.setUnreadNotificationCount(Ve.Total,r.notification_count),r.highlight_count!=null&&(!v||v&&t.getUnreadNotificationCount(Ve.Highlight)<=0)&&t.setUnreadNotificationCount(Ve.Highlight,r.highlight_count),Number.isInteger(r.invited_count)&&t.currentState.setInvitedMemberCount(r.invited_count),Number.isInteger(r.joined_count)&&t.currentState.setJoinedMemberCount(r.joined_count),r.invite_state){var m=ds(n.client,t.roomId,r.invite_state);yield n.injectRoomEvents(t,m),r.initial&&(t.recalculate(),n.client.store.storeRoom(t),n.client.emit(_e.Room,t)),m.forEach(_=>{n.client.emit(_e.Event,_)}),t.updateMyMembership(Oe.Invite);return}if(r.initial){var E;t.getLiveTimeline().setPaginationToken((E=r.prev_batch)!==null&&E!==void 0?E:null,ve.BACKWARDS)}yield n.injectRoomEvents(t,s,o,r.num_live),t.addEphemeralEvents(a),t.updateMyMembership(Oe.Join),t.recalculate(),r.initial&&(e.store.storeRoom(t),e.emit(_e.Room,t)),n.addNotifications(o);var R=function(){var _=S(function*(T){e.emit(_e.Event,T),T.isState()&&T.getType()==F.RoomEncryption&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(t,T))});return function(b){return _.apply(this,arguments)}}();yield rs(s,R),yield rs(o,R),a.forEach(function(_){e.emit(_e.Event,_)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t,r,n){var s=this;return S(function*(){r=r||[],t=t||[],n=n||0;var o=e.getLiveTimeline(),a=o.getEvents().length==0;if(a){for(var l of t)s.client.getPushActionsForEvent(l);o.initialiseState(t)}a||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var u=[];n>0&&(u=r.slice(-1*n),r=r.slice(0,-1*u.length)),yield e.addLiveEvents(r,{fromCache:!0}),u.length>0&&(yield e.addLiveEvents(u,{fromCache:!1})),e.recalculate(),s.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Oe.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),s;n?s=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):s=t.getProfileInfo(r.userId),s.then(function(o){var a=r.events.member;a.getContent().membership===Oe.Invite&&(a.getContent().avatar_url=o.avatar_url,a.getContent().displayname=o.displayname,r.setMembershipEvent(a,e.currentState))},function(o){})}})}}retryImmediately(){return!0}sync(){var e=this;return S(function*(){for(p.debug("Sliding sync init loop");!e.client.isGuest();)try{p.debug("Getting push rules...");var t=yield e.client.getPushRules();p.debug("Got push rules"),e.client.pushRules=t;break}catch(r){if(p.error("Getting push rules failed",r),e.shouldAbortSync(r))return}yield e.slidingSync.start()})()}stop(){p.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(_e.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var r=this.client.getPushActionsForEvent(t);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e)}),this.notifEvents=[]}}function nC(i,e,t){if(!t.name)return t;for(var r of t.required_state)if(r.type===F.RoomName&&r.state_key==="")return r.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:F.RoomName,content:{name:t.name},sender:i.getUserId(),origin_server_ts:new Date().getTime()}),t}function ds(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,n=i.getEventMapper({decrypt:r});return t.map(function(s){return s.room_id=e,n(s)})}function NS(i,e,t){var r=ds(i,e,t),n=i.getRoom(e);if(!n){p.warn("got ephemeral events for room but room doesn't exist on client:",e);return}n.addEphemeralEvents(r),r.forEach(s=>{i.emit(_e.Event,s)})}class Ts{static RETRY_BACKOFF_RATELIMIT(e,t,r){return Zy(r,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===F.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ts.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ts.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,f(this,"queues",{}),f(this,"activeQueues",[]),f(this,"procFn",null),f(this,"processQueue",r=>{var n=this.peekNextEvent(r);if(!n){this.disableQueue(r);return}this.queues[r].length,Promise.resolve().then(()=>this.procFn(n.event)).then(s=>{this.removeNextEvent(r),n.event.getId(),n.defer.resolve(s),this.processQueue(r)},s=>{n.attempts+=1;var o=this.retryAlgorithm(n.event,n.attempts,s);n.attempts,n.event.getId(),o===-1?(p.info("Queue '%s' giving up on event %s",r,n.event.getId()),this.clearQueue(r,s)):setTimeout(this.processQueue,o,r)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(r){return r.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var r=!1;return pl(this.queues[t],n=>n.event.getId()===e.getId()?(r=!0,!0):!1),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var r=ni();return this.queues[t].push({event:e,defer:r,attempts:0}),e.getId(),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),p.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){p.info("clearing queue '%s'",e);for(var r;r=this.removeNextEvent(e);)r.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}var xg=20;class iC{constructor(e){var t=this;this.client=e,f(this,"sending",!1),f(this,"running",!0),f(this,"retryTimeout",null),f(this,"retryAttempts",0),f(this,"sendQueue",S(function*(){if(t.retryTimeout!==null&&clearTimeout(t.retryTimeout),t.retryTimeout=null,!(t.sending||!t.running)){p.debug("Attempting to send queued to-device messages"),t.sending=!0;var r;try{for(;t.running&&(r=yield t.client.store.getOldestToDeviceBatch(),r!==null);)yield t.sendBatch(r),yield t.client.store.removeToDeviceBatch(r.id),t.retryAttempts=0;if(!t.running)return;p.debug("All queued to-device messages sent")}catch(s){++t.retryAttempts;var n=Ts.RETRY_BACKOFF_RATELIMIT(null,t.retryAttempts,s);if(n===-1){Math.floor(s.httpStatus/100)===4?(p.error("Fatal error when sending to-device message - dropping to-device batch!",s),yield t.client.store.removeToDeviceBatch(r.id)):p.info("Automatic retry limit reached for to-device messages.");return}p.info("Failed to send batch of to-device messages. Will retry in ".concat(n,"ms"),s),t.retryTimeout=setTimeout(t.sendQueue,n)}finally{t.sending=!1}}})),f(this,"onResumedSync",(r,n)=>{r===$e.Syncing&&n!==$e.Syncing&&(p.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(_e.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(_e.Sync,this.onResumedSync)}queueBatch(e){var t=this;return S(function*(){for(var r=[],n=0;n<e.batch.length;n+=xg){var s={eventType:e.eventType,batch:e.batch.slice(n,n+xg),txnId:t.client.makeTxnId()};r.push(s);var o=s.batch.map(a=>"".concat(a.userId,"/").concat(a.deviceId," (msgid ").concat(a.payload[Zt],")"));p.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(s.txnId),o)}yield t.client.store.saveToDeviceBatches(r),t.sendQueue()})()}sendBatch(e){var t=this;return S(function*(){var r=new ht(()=>new Map);for(var n of e.batch)r.getOrCreate(n.userId).set(n.deviceId,n.payload);p.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,r,e.txnId)})()}}var rc=new sr.UnstableValue("m.policies","org.matrix.msc3847.policies"),Ba=new sr.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),Kg=function(i){return i.Ban="m.ban",i}({}),hs=function(i){return i.User="m.policy.user",i.Room="m.policy.room",i.Server="m.policy.server",i}({}),Fg={[hs.User]:F.PolicyRuleUser,[hs.Room]:F.PolicyRuleRoom,[hs.Server]:F.PolicyRuleServer};class sC{constructor(e){this.client=e}addRule(e,t,r){var n=this;return S(function*(){var s=yield n.getOrCreateTargetRoom(),o=yield n.client.sendStateEvent(s.roomId,Fg[e],{entity:t,reason:r,recommendation:Kg.Ban});return o.event_id})()}removeRule(e){var t=this;return S(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return S(function*(){yield t.client.joinRoom(e);var r=(yield t.getOrCreateSourceRooms()).map(n=>n.roomId);return r.includes(e)?!1:(r.push(e),yield t.withIgnoreInvitesPolicies(n=>{n.sources=r}),!0)})()}getRuleForInvite(e){var t=this;return S(function*(){var{sender:r,roomId:n}=e,s=yield t.getOrCreateSourceRooms(),o=r.split(":")[1],a=n.split(":")[1];for(var l of s){var u=l.getUnfilteredTimelineSet().getLiveTimeline().getState(ve.FORWARDS);for(var{scope:c,entities:d}of[{scope:hs.Room,entities:[n]},{scope:hs.User,entities:[r]},{scope:hs.Server,entities:[o,a]}]){var h=u.getStateEvents(Fg[c]);for(var g of h){var v=g.getContent();if((v==null?void 0:v.recommendation)==Kg.Ban){var m=v==null?void 0:v.entity;if(m){var E=void 0;try{E=new RegExp(_y(m))}catch{continue}for(var R of d)if(R&&E.test(R))return g}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return S(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.target;if(typeof r!="string"&&(r=null),r){var n=e.client.getRoom(r);if(n)return n;r=null}return r=(yield e.client.createRoom({name:"Individual Policy Room",preset:Th.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(s=>{s.target=r}),e.client.getRoom(r)})()}getOrCreateSourceRooms(){var e=this;return S(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.sources,n=!1;Array.isArray(r)||(n=!0,r=[]);var s=r.filter(a=>typeof a=="string").map(a=>e.client.getRoom(a)).filter(a=>!!a);if(s.length!=r.length&&(n=!0),s.length==0){var o=yield e.getOrCreateTargetRoom();n=!0,s=[o]}return n&&(yield e.withIgnoreInvitesPolicies(a=>{a.sources=r})),s})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return S(function*(){var{policies:r,ignoreInvitesPolicies:n}=t.getPoliciesAndIgnoreInvitesPolicies();e(n),r[Ba.name]=n,yield t.client.setAccountData(rc.name,r)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[rc.name,rc.altName]){var r;if(t){var n=(r=this.client.getAccountData(t))===null||r===void 0?void 0:r.getContent();if(n){e=n;break}}}var s={},o=!1;for(var a of[Ba.name,Ba.altName])if(a){var l=e[a];if(l&&typeof l=="object"){s=l,o=!0;break}}return o||(e[Ba.name]=s),{policies:e,ignoreInvitesPolicies:s}}}var nc="matrix-js-sdk",xS=i=>i.type==="livekit"&&"focus_selection"in i,oC=(i,e)=>{var t,r="Malformed session membership event: ";return typeof i.device_id!="string"&&e.push(r+"device_id must be string"),typeof i.call_id!="string"&&e.push(r+"call_id must be string"),typeof i.application!="string"&&e.push(r+"application must be a string"),typeof((t=i.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(r+"focus_active.type must be a string"),Array.isArray(i.foci_preferred)||e.push(r+"foci_preferred must be an array"),i.created_ts&&typeof i.created_ts!="number"&&e.push(r+"created_ts must be number"),i.scope&&typeof i.scope!="string"&&e.push(r+"scope must be string"),e.length===0},xn=i=>"membershipID"in i,aC=(i,e)=>{var t="Malformed legacy rtc membership event: ";return"expires"in i||"expires_ts"in i||e.push(t+"expires_ts or expires must be present"),"expires"in i&&typeof i.expires!="number"&&e.push(t+"expires must be numeric"),"expires_ts"in i&&typeof i.expires_ts!="number"&&e.push(t+"expires_ts must be numeric"),typeof i.device_id!="string"&&e.push(t+"device_id must be string"),typeof i.call_id!="string"&&e.push(t+"call_id must be string"),typeof i.application!="string"&&e.push(t+"application must be a string"),typeof i.membershipID!="string"&&e.push(t+"membershipID must be a string"),i.created_ts&&typeof i.created_ts!="number"&&e.push(t+"created_ts must be number"),i.scope&&typeof i.scope!="string"&&e.push(t+"scope must be string"),e.length===0};class to{static equal(e,t){return Ki(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,f(this,"membershipData",void 0);var r=[],n=[];if(!oC(t,r)&&!aC(t,n))throw Error("unknown CallMembership data. Does not match legacy call.member (".concat(n.join(" & "),") events nor MSC4143 (").concat(r.join(" & "),")"));this.membershipData=t}get sender(){return this.parentEvent.getSender()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return xn(this.membershipData)?this.membershipData.membershipID:this.createdTs().toString()}createdTs(){var e;return(e=this.membershipData.created_ts)!==null&&e!==void 0?e:this.parentEvent.getTs()}getAbsoluteExpiry(){if(xn(this.membershipData))return"expires"in this.membershipData?this.createdTs()+this.membershipData.expires:this.membershipData.expires_ts}getLocalExpiry(){if(xn(this.membershipData))if("expires"in this.membershipData){var e=this.parentEvent.getTs()-this.createdTs(),t=this.parentEvent.localTimestamp-e;return t+this.membershipData.expires}else return this.membershipData.expires_ts}getMsUntilExpiry(){if(xn(this.membershipData))return this.getLocalExpiry()-Date.now()}isExpired(){return xn(this.membershipData)?this.getMsUntilExpiry()<=0:!1}getPreferredFoci(){var e;return xn(this.membershipData)?(e=this.membershipData.foci_active)!==null&&e!==void 0?e:[]:this.membershipData.foci_preferred}getFocusSelection(){if(xn(this.membershipData))return"oldest_membership";var e=this.membershipData.focus_active;if(xS(e))return e.focus_selection}}function Bg(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function lC(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Bg(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Bg(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var ic=60*60*1e3,jg=2*60*1e3,uC=3e3,qg=3e3,cC=3e3,dC=5e3,rl=(i,e)=>"".concat(i,":").concat(e),Vg=i=>rl(i.sender,i.deviceId);function hC(i,e){return i===e?!0:i&&e&&i.length===e.length&&i.every((t,r)=>t===e[r])}var ro=function(i){return i.MembershipsChanged="memberships_changed",i.JoinStateChanged="join_state_changed",i.EncryptionKeyChanged="encryption_key_changed",i}({});class fs extends rt{get callId(){return this._callId}static callMembershipsForRoom(e){var t=e.getLiveTimeline().getState(ve.FORWARDS);if(!t)throw p.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var r=t.getStateEvents(F.GroupCallMemberPrefix),n=[];for(var s of r){var o=s.getContent(),a=[];if("memberships"in o){if(!Array.isArray(o.memberships)){p.warn("Malformed member event from ".concat(s.getSender(),": memberships is not an array"));continue}a=o.memberships}else Object.keys(o).length!==0&&a.push(o);if(a.length!==0)for(var l of a)try{var u,c=new to(s,l);if(c.callId!==""||c.scope!=="m.room"){p.info("Ignoring user-scoped call");continue}if(c.isExpired()){p.info("Ignoring expired device membership ".concat(c.sender,"/").concat(c.deviceId));continue}if(!e.hasMembershipState((u=c.sender)!==null&&u!==void 0?u:"",Oe.Join)){p.info("Ignoring membership of user ".concat(c.sender," who is not in the room."));continue}n.push(c)}catch(d){p.warn("Couldn't construct call membership: ",d)}}return n.sort((d,h)=>d.createdTs()-h.createdTs()),n.length>1&&p.debug("Call memberships in room ".concat(e.roomId,", in order: "),n.map(d=>[d.createdTs(),d.sender])),n}static roomSessionForRoom(e,t){var r=fs.callMembershipsForRoom(t);return new fs(e,t,r)}constructor(e,t,r){var n,s;super(),n=this,this.client=e,this.room=t,this.memberships=r,f(this,"_callId",void 0),f(this,"relativeExpiry",void 0),f(this,"membershipId",void 0),f(this,"memberEventTimeout",void 0),f(this,"expiryTimeout",void 0),f(this,"keysEventUpdateTimeout",void 0),f(this,"makeNewKeyTimeout",void 0),f(this,"setNewKeyTimeouts",new Set),f(this,"ownFocusActive",void 0),f(this,"ownFociPreferred",void 0),f(this,"updateCallMembershipRunning",!1),f(this,"needCallMembershipUpdate",!1),f(this,"manageMediaKeys",!1),f(this,"useLegacyMemberEvents",!0),f(this,"encryptionKeys",new Map),f(this,"lastEncryptionKeyUpdateRequest",void 0),f(this,"sendEncryptionKeysEvent",S(function*(){if(n.keysEventUpdateTimeout!==void 0&&(clearTimeout(n.keysEventUpdateTimeout),n.keysEventUpdateTimeout=void 0),n.lastEncryptionKeyUpdateRequest=Date.now(),p.info("Sending encryption keys event"),!!n.isJoined()){var a=n.client.getUserId(),l=n.client.getDeviceId();if(!a)throw new Error("No userId");if(!l)throw new Error("No deviceId");var u=n.getKeysForParticipant(a,l);if(!u){p.warn("Tried to send encryption keys event but no keys found!");return}try{yield n.client.sendEvent(n.room.roomId,F.CallEncryptionKeysPrefix,{keys:u.map((v,m)=>({index:m,key:tu(v)})),device_id:l,call_id:""}),p.debug("Embedded-E2EE-LOG updateEncryptionKeyEvent participantId=".concat(a,":").concat(l," numSent=").concat(u.length),n.encryptionKeys)}catch(v){var c=v;if(c.event&&n.client.cancelPendingEvent(c.event),n.keysEventUpdateTimeout===void 0){var d,h,g=(d=(h=c.data)===null||h===void 0?void 0:h.retry_after_ms)!==null&&d!==void 0?d:5e3;p.warn("Failed to send m.call.encryption_key, retrying in ".concat(g),v),n.keysEventUpdateTimeout=setTimeout(n.sendEncryptionKeysEvent,g)}else p.info("Not scheduling key resend as another re-send is already pending")}}})),f(this,"onCallEncryption",a=>{var l=a.getSender(),u=a.getContent(),c=u.device_id,d=u.call_id;if(!l){p.warn("Received m.call.encryption_keys with no userId: callId=".concat(d));return}if(d!==""){p.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(l,", deviceId=").concat(c,", callId=").concat(d));return}if(!Array.isArray(u.keys)){p.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(d));return}if(l===this.client.getUserId()&&c===this.client.getDeviceId()){p.info("Ignoring our own keys event");return}for(var h of u.keys){if(!h){p.info("Ignoring false-y key in keys event");continue}var g=h.key,v=h.index;!g||v===void 0||v===null||d===void 0||d===null||typeof c!="string"||typeof d!="string"||typeof g!="string"||typeof v!="number"?p.warn("Malformed call encryption_key: userId=".concat(l,", deviceId=").concat(c,", encryptionKeyIndex=").concat(v," callId=").concat(d)):(p.debug("Embedded-E2EE-LOG onCallEncryption userId=".concat(l,":").concat(c," encryptionKeyIndex=").concat(v),this.encryptionKeys),this.setEncryptionKey(l,c,v,g))}}),f(this,"onMembershipUpdate",()=>{var a,l,u=this.memberships;this.memberships=fs.callMembershipsForRoom(this.room),this._callId=(a=this._callId)!==null&&a!==void 0?a:(l=this.memberships[0])===null||l===void 0?void 0:l.callId;var c=u.length!=this.memberships.length||u.some((E,R)=>!to.equal(E,this.memberships[R]));c&&(p.info("Memberships for call in room ".concat(this.room.roomId," have changed: emitting")),this.emit(ro.MembershipsChanged,u,this.memberships));var d=E=>E.sender===this.client.getUserId()&&E.deviceId===this.client.getDeviceId();if(this.manageMediaKeys&&this.isJoined()&&this.makeNewKeyTimeout===void 0){var h=new Set(u.filter(E=>!d(E)).map(Vg)),g=new Set(this.memberships.filter(E=>!d(E)).map(Vg)),v=Array.from(h).some(E=>!g.has(E)),m=Array.from(g).some(E=>!h.has(E));v?(p.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,cC)):m&&(p.debug("New member(s) have joined: re-sending keys"),this.requestKeyEventSend())}this.setExpiryTimer()}),f(this,"triggerCallMembershipEventUpdate",S(function*(){if(n.updateCallMembershipRunning){n.needCallMembershipUpdate=!0;return}n.updateCallMembershipRunning=!0;try{do n.needCallMembershipUpdate=!1,yield n.updateCallMembershipEvent();while(n.needCallMembershipUpdate)}finally{n.updateCallMembershipRunning=!1}})),f(this,"onRotateKeyTimeout",()=>{this.manageMediaKeys&&(this.makeNewKeyTimeout=void 0,p.info("Making new sender key for key rotation"),this.makeNewSenderKey(!0),this.sendEncryptionKeysEvent())}),this._callId=(s=r[0])===null||s===void 0?void 0:s.callId;var o=this.room.getLiveTimeline().getState(ve.FORWARDS);o==null||o.on(Ae.Members,this.onMembershipUpdate),this.setExpiryTimer()}isJoined(){return this.relativeExpiry!==void 0}stop(){var e=this;return S(function*(){yield e.leaveRoomSession(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0),e.memberEventTimeout&&(clearTimeout(e.memberEventTimeout),e.memberEventTimeout=void 0);var t=e.room.getLiveTimeline().getState(ve.FORWARDS);t==null||t.off(Ae.Members,e.onMembershipUpdate)})()}joinRoomSession(e,t,r){var n,s;if(this.isJoined()){p.info("Already joined to session in room ".concat(this.room.roomId,": ignoring join call"));return}this.ownFocusActive=t,this.ownFociPreferred=e,this.relativeExpiry=ic,this.manageMediaKeys=(n=r==null?void 0:r.manageMediaKeys)!==null&&n!==void 0?n:this.manageMediaKeys,this.useLegacyMemberEvents=(s=r==null?void 0:r.useLegacyMemberEvents)!==null&&s!==void 0?s:this.useLegacyMemberEvents,this.membershipId=Dr(5),p.info("Joining call session in room ".concat(this.room.roomId," with manageMediaKeys=").concat(this.manageMediaKeys)),r!=null&&r.manageMediaKeys&&(this.makeNewSenderKey(),this.requestKeyEventSend()),this.triggerCallMembershipEventUpdate(),this.emit(ro.JoinStateChanged,!0)}leaveRoomSession(){var e=arguments,t=this;return S(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return p.info("Not joined to session in room ".concat(t.room.roomId,": ignoring leave call")),new Promise(l=>l(!1));var n=t.client.getUserId(),s=t.client.getDeviceId();if(!n)throw new Error("No userId");if(!s)throw new Error("No deviceId");t.encryptionKeys.set(rl(n,s),[]),t.makeNewKeyTimeout!==void 0&&(clearTimeout(t.makeNewKeyTimeout),t.makeNewKeyTimeout=void 0);for(var o of t.setNewKeyTimeouts)clearTimeout(o);t.setNewKeyTimeouts.clear(),p.info("Leaving call session in room ".concat(t.room.roomId)),t.relativeExpiry=void 0,t.ownFocusActive=void 0,t.manageMediaKeys=!1,t.membershipId=void 0,t.emit(ro.JoinStateChanged,!1);var a=new Promise(l=>{r&&setTimeout(l,r,"timeout")});return new Promise(l=>{Promise.race([t.triggerCallMembershipEventUpdate(),a]).then(u=>{l(u!="timeout")})})})()}getActiveFocus(){if(this.ownFocusActive&&xS(this.ownFocusActive)&&this.ownFocusActive.focus_selection==="oldest_membership"){var e=this.getOldestMembership();return e==null?void 0:e.getPreferredFoci()[0]}if(!this.ownFocusActive){var t=this.getOldestMembership();return t==null?void 0:t.getPreferredFoci()[0]}}getKeysForParticipant(e,t){return this.encryptionKeys.get(rl(e,t))}getEncryptionKeys(){return this.encryptionKeys.entries()}getNewEncryptionKeyIndex(){var e,t,r=this.client.getUserId(),n=this.client.getDeviceId();if(!r)throw new Error("No userId!");if(!n)throw new Error("No deviceId!");return((e=(t=this.getKeysForParticipant(r,n))===null||t===void 0?void 0:t.length)!==null&&e!==void 0?e:0)%16}setEncryptionKey(e,t,r,n){var s,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1,a=At(n),l=rl(e,t),u=(s=this.encryptionKeys.get(l))!==null&&s!==void 0?s:[];if(!hC(u[r],a))if(u[r]=a,this.encryptionKeys.set(l,u),o){var c=setTimeout(()=>{this.setNewKeyTimeouts.delete(c),p.info("Delayed-emitting key changed event for ".concat(l," idx ").concat(r)),this.emit(ro.EncryptionKeyChanged,a,r,l)},dC);this.setNewKeyTimeouts.add(c)}else this.emit(ro.EncryptionKeyChanged,a,r,l)}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.client.getUserId(),r=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!r)throw new Error("No deviceId");var n=xT(16),s=this.getNewEncryptionKeyIndex();p.info("Generated new key at index "+s),this.setEncryptionKey(t,r,s,n,e)}requestKeyEventSend(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+qg>Date.now()){p.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,qg));return}this.sendEncryptionKeysEvent()}}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var r=t.getMsUntilExpiry();r!==void 0&&(e===void 0||r<e)&&(e=r)}e!=null&&(this.expiryTimeout=setTimeout(this.onMembershipUpdate,e))}getOldestMembership(){return this.memberships[0]}getFocusInUse(){var e=this.getOldestMembership();if((e==null?void 0:e.getFocusSelection())==="oldest_membership")return e.getPreferredFoci()[0]}makeMyMembershipLegacy(e,t){if(this.relativeExpiry===void 0)throw new Error("Tried to create our own membership event when we're not joined!");if(this.membershipId===void 0)throw new Error("Tried to create our own membership event when we have no membership ID!");var r=t==null?void 0:t.createdTs();return lC({call_id:"",scope:"m.room",application:"m.call",device_id:e,expires:this.relativeExpiry,expires_ts:this.relativeExpiry+(r??Date.now()),foci_active:this.ownFociPreferred,membershipID:this.membershipId},r?{created_ts:r}:{})}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.ownFociPreferred)!==null&&t!==void 0?t:[]}}membershipEventNeedsUpdate(e,t){if(t&&t.getMsUntilExpiry()===void 0)return!1;if(!this.isJoined())return!!e;if(!t)return!0;var r=t.getMsUntilExpiry();return r!==void 0&&r<ic/2?(this.relativeExpiry+=ic,!0):!1}makeNewMembership(e){return this.isJoined()?this.makeMyMembership(e):{}}makeNewLegacyMemberships(e,t,r,n){var s=l=>{var u;try{u=new to(r,l)}catch{return!1}return!u.isExpired()},o=l=>(l.created_ts===void 0&&(l.created_ts=r.getTs()),l),a=e.filter(s).filter(l=>l.device_id!==t);return a=a.map(o),this.isJoined()&&a.push(this.makeMyMembershipLegacy(t,n)),{memberships:a}}updateCallMembershipEvent(){var e=this;return S(function*(){e.memberEventTimeout&&(clearTimeout(e.memberEventTimeout),e.memberEventTimeout=void 0);var t=e.room.getLiveTimeline().getState(ve.FORWARDS);if(!t)throw new Error("Couldn't get room state for room "+e.room.roomId);var r=e.client.getUserId(),n=e.client.getDeviceId();if(!r||!n)throw new Error("User ID or device ID was null!");var s=t.events.get(F.GroupCallMemberPrefix),o=!!e.useLegacyMemberEvents||(s==null?void 0:s.size)&&e.stateEventsContainOngoingLegacySession(s),a={};if(o){var l,u=s==null?void 0:s.get(r),c=(l=u==null?void 0:u.getContent())!==null&&l!==void 0?l:{},d,h=Array.isArray(c.memberships)?c.memberships:[],g=h.find(m=>m.device_id===n);try{u&&g&&xn(g)&&g.membershipID===e.membershipId&&(d=new to(u,g))}catch(m){p.warn("Our previous call membership was invalid - this shouldn't happen.",m)}if(d&&p.debug("".concat(d.getMsUntilExpiry()," until our membership expires")),!e.membershipEventNeedsUpdate(g,d)){e.memberEventTimeout=setTimeout(e.triggerCallMembershipEventUpdate,jg);return}a=e.makeNewLegacyMemberships(h,n,u,d)}else a=e.makeNewMembership(n);try{yield e.client.sendStateEvent(e.room.roomId,F.GroupCallMemberPrefix,a,o?r:e.makeMembershipStateKey(r,n)),p.info("Sent updated call member event."),e.isJoined()&&o&&(e.memberEventTimeout=setTimeout(e.triggerCallMembershipEventUpdate,jg))}catch{var v=uC+Math.random()*2e3;p.warn("Failed to send call member event: retrying in ".concat(v)),yield new Promise(E=>setTimeout(E,v)),yield e.triggerCallMembershipEventUpdate()}})()}stateEventsContainOngoingLegacySession(e){for(var t of e.values()){var r=t.getContent();if(Array.isArray(r.memberships)){for(var n of r.memberships)if(!new to(t,n).isExpired())return!0}}return!1}makeMembershipStateKey(e,t){var r="".concat(e,"_").concat(t);return/^org\.matrix\.msc3779\b/.exec(this.room.getVersion())?r:"_".concat(r)}}var Wg=function(i){return i.SessionStarted="session_started",i.SessionEnded="session_ended",i}({});class fC extends rt{constructor(e){super(),this.client=e,f(this,"roomSessions",new Map),f(this,"onTimeline",t=>{this.consumeCallEncryptionEvent(t)}),f(this,"onRoom",t=>{this.refreshRoom(t)}),f(this,"onRoomState",(t,r)=>{var n=this.client.getRoom(t.getRoomId());if(!n){p.error("Got room state event for unknown room ".concat(t.getRoomId(),"!"));return}t.getType()==F.GroupCallMemberPrefix&&this.refreshRoom(n)})}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,r=fs.roomSessionForRoom(this.client,e);r.memberships.length>0&&this.roomSessions.set(e.roomId,r)}this.client.on(_e.Room,this.onRoom),this.client.on(ye.Timeline,this.onTimeline),this.client.on(Ae.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(_e.Room,this.onRoom),this.client.off(ye.Timeline,this.onTimeline),this.client.off(Ae.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,fs.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}consumeCallEncryptionEvent(e){var t=this;return S(function*(){if(yield t.client.decryptEventIfNeeded(e),e.getType()!==F.CallEncryptionKeysPrefix)return Promise.resolve();var r=t.client.getRoom(e.getRoomId());if(!r)return p.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();t.getRoomSession(r).onCallEncryption(e)})()}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),r=this.getRoomSession(e),n=r.memberships.length>0&&!t;r.onMembershipUpdate();var s=r.memberships.length>0;n&&!s?this.emit(Wg.SessionEnded,e.roomId,this.roomSessions.get(e.roomId)):!n&&s&&this.emit(Wg.SessionStarted,e.roomId,this.roomSessions.get(e.roomId))}}function sc(i){return e=>{var t,r;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==i||((r=e.content)===null||r===void 0||(r=r["m.relates_to"])===null||r===void 0?void 0:r.rel_type)===Je.name}}var vC=["server","limit","since"];function Gg(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Pt(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Gg(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Gg(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var gC=3e3,pC=AS(),Hg=10*60*1e3,mC=new ut("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),Is=function(i){return i.Chronological="chronological",i.Detached="detached",i}({}),yC=new $l("m.get_login_token","org.matrix.msc3882.get_login_token"),KS="uk.half-shot.msc2666",FS="uk.half-shot.msc2666.mutual_rooms",BS="uk.half-shot.msc2666.query_mutual_rooms",Kr="$",_e=function(i){return i.Sync="sync",i.Event="event",i.ToDeviceEvent="toDeviceEvent",i.AccountData="accountData",i.Room="Room",i.DeleteRoom="deleteRoom",i.SyncUnexpectedError="sync.unexpectedError",i.ClientWellKnown="WellKnown.client",i.ReceivedVoipEvent="received_voip_event",i.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",i.TurnServers="turnServers",i.TurnServersError="turnServers.error",i}({}),SC=new ut("action","org.matrix.msc3824.action");class si extends rt{constructor(e){var t,r,n,s;super(),n=this,f(this,"logger",void 0),f(this,"reEmitter",new Ms(this)),f(this,"olmVersion",null),f(this,"usingExternalCrypto",!1),f(this,"_store",void 0),f(this,"deviceId",void 0),f(this,"credentials",void 0),f(this,"pickleKey",void 0),f(this,"scheduler",void 0),f(this,"clientRunning",!1),f(this,"timelineSupport",!1),f(this,"urlPreviewCache",{}),f(this,"identityServer",void 0),f(this,"http",void 0),f(this,"crypto",void 0),f(this,"cryptoBackend",void 0),f(this,"cryptoCallbacks",void 0),f(this,"callEventHandler",void 0),f(this,"groupCallEventHandler",void 0),f(this,"supportsCallTransfer",!1),f(this,"forceTURN",!1),f(this,"iceCandidatePoolSize",0),f(this,"idBaseUrl",void 0),f(this,"baseUrl",void 0),f(this,"isVoipWithNoMediaAllowed",void 0),f(this,"useLivekitForGroupCalls",void 0),f(this,"canSupportVoip",!1),f(this,"peekSync",null),f(this,"isGuestAccount",!1),f(this,"ongoingScrollbacks",{}),f(this,"notifTimelineSet",null),f(this,"cryptoStore",void 0),f(this,"verificationMethods",void 0),f(this,"fallbackICEServerAllowed",!1),f(this,"syncApi",void 0),f(this,"roomNameGenerator",void 0),f(this,"pushRules",void 0),f(this,"syncLeftRoomsPromise",void 0),f(this,"syncedLeftRooms",!1),f(this,"clientOpts",void 0),f(this,"clientWellKnownIntervalID",void 0),f(this,"canResetTimelineCallback",void 0),f(this,"canSupport",new Map),f(this,"pushProcessor",new Tr(this)),f(this,"serverVersionsPromise",void 0),f(this,"clientWellKnown",void 0),f(this,"clientWellKnownPromise",void 0),f(this,"turnServers",[]),f(this,"turnServersExpiry",0),f(this,"checkTurnServersIntervalID",void 0),f(this,"exportedOlmDeviceToImport",void 0),f(this,"txnCtr",0),f(this,"mediaHandler",new Y0(this)),f(this,"sessionId",void 0),f(this,"eventsBeingEncrypted",new Set),f(this,"useE2eForGroupCall",!0),f(this,"toDeviceMessageQueue",void 0),f(this,"livekitServiceURL",void 0),f(this,"_secretStorage",void 0),f(this,"ignoredInvites",void 0),f(this,"matrixRTC",void 0),f(this,"serverCapabilitiesService",void 0),f(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(Xc()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(_e.Sync,this.startCallEventHandler))}),f(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(_e.Sync,this.startMatrixRTC))}),f(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var a,l=((a=this.getRooms())!==null&&a!==void 0?a:[]).filter(d=>d.getUnreadNotificationCount(Ve.Total)>0);for(var u of l){var c=this.getSafeUserId();u.fixupNotifications(c)}this.off(_e.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:p,e.baseUrl=Lu(e.baseUrl),e.idBaseUrl=Lu(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(r=e.usingExternalCrypto)!==null&&r!==void 0?r:!1,this.store=e.store||new IT,this.deviceId=e.deviceId||null,this.sessionId=Dr(10);var o=e.userId||null;this.credentials={userId:o},this.http=new eS(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:vt.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.deviceToImport?this.deviceId?this.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?this.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):this.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var a=S(function*(l){var u=n.getRoom(l.getRoomId());l.status!==Re.SENDING&&n.updatePendingEventStatus(u,l,Re.SENDING);var c=yield n.sendEventHttpRequest(l);return u&&u.updatePendingEvent(l,Re.SENT,c.event_id),c});return function(l){return a.apply(this,arguments)}}()),Xc()&&(this.callEventHandler=new WT(this),this.groupCallEventHandler=new GT(this),this.canSupportVoip=!0,this.on(_e.Sync,this.startCallEventHandler)),this.matrixRTC=new fC(this),this.serverCapabilitiesService=new rS(this.http),this.on(_e.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new iC(this),this.on(Fe.Decrypted,a=>{jS(this,a)}),this.ignoredInvites=new sC(this),this._secretStorage=new sa(this,(s=e.cryptoCallbacks)!==null&&s!==void 0?s:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>En.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return S(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(_e.Sync,t.startMatrixRTC);var r=t.getUserId();r&&t.store.storeUser(new En(r)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},Hg),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:n,list:s,fwdPagination:o}=yield t.doesServerSupportThread();et.setServerSideSupport(n),et.setServerSideListSupport(s),et.setServerSideFwdPaginationSupport(o)}catch(a){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",a)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new LS(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new bo(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(a=>t.logger.info("Sync startup aborted with an error:",a)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1}}stopClient(){var e,t,r,n,s;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(_e.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(r=this.peekSync)===null||r===void 0||r.stopPeeking(),(n=this.callEventHandler)===null||n===void 0||n.stop(),(s=this.groupCallEventHandler)===null||s===void 0||s.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,global.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&global.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}rehydrateDevice(){var e=this;return S(function*(){if(e.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(e.cryptoCallbacks.getDehydrationKey){var t=yield e.getDehydratedDevice();if(t){if(!t.device_data||!t.device_id){e.logger.info("no dehydrated device found");return}var r=new global.Olm.Account;try{var n=t.device_data;if(n.algorithm!==el){e.logger.warn("Wrong algorithm for dehydrated device");return}e.logger.debug("unpickling dehydrated device");var s=yield e.cryptoCallbacks.getDehydrationKey(n,l=>{r.unpickle(new Uint8Array(l),n.account)});r.unpickle(s,n.account),e.logger.debug("unpickled device");var o=yield e.http.authedRequest(z.Post,"/dehydrated_device/claim",void 0,{device_id:t.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"});if(o.success){e.deviceId=t.device_id,e.logger.info("using dehydrated device");var a=e.pickleKey||"DEFAULT_KEY";return e.exportedOlmDeviceToImport={pickledAccount:r.pickle(a),sessions:[],pickleKey:a},r.free(),e.deviceId}else{r.free(),e.logger.info("not using dehydrated device");return}}catch(l){r.free(),e.logger.warn("could not unpickle",l)}}}})()}getDehydratedDevice(){var e=this;return S(function*(){try{return yield e.http.authedRequest(z.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(t){e.logger.info("could not get dehydrated device",t);return}})()}setDehydrationKey(e,t,r){var n=this;return S(function*(){if(!n.crypto){n.logger.warn("not dehydrating device if crypto is not enabled");return}return n.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,r)})()}createDehydratedDevice(e,t,r){var n=this;return S(function*(){if(!n.crypto){n.logger.warn("not dehydrating device if crypto is not enabled");return}return yield n.crypto.dehydrationManager.setKey(e,t,r),n.crypto.dehydrationManager.dehydrateDevice()})()}exportDevice(){var e=this;return S(function*(){if(!e.crypto){e.logger.warn("not exporting device if crypto is not enabled");return}return{userId:e.credentials.userId,deviceId:e.deviceId,olmDevice:yield e.crypto.olmDevice.export()}})()}clearStores(){var e=this;if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var t=[];t.push(this.store.deleteAllData()),this.cryptoStore&&t.push(this.cryptoStore.deleteAllData());var r=function(){var n=S(function*(){var s;try{if(s=global.indexedDB,!s)return}catch{return}var o=function*(u){var c=new Promise((d,h)=>{e.logger.info("Removing IndexedDB instance ".concat(u));var g=s.deleteDatabase(u);g.onsuccess=v=>{e.logger.info("Removed IndexedDB instance ".concat(u)),d(0)},g.onerror=v=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(u,":"),v),d(0)},g.onblocked=v=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(u))}});yield c};for(var a of["".concat(nc,"::matrix-sdk-crypto"),"".concat(nc,"::matrix-sdk-crypto-meta")])yield*o(a)});return function(){return n.apply(this,arguments)}}();return t.push(r()),Promise.all(t).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return na(this,e)}createGroupCall(e,t,r,n,s,o){var a=this;return S(function*(){if(a.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var l=a.getRoom(e);if(!l)throw new Error("Cannot find room ".concat(e));return new vh(a,l,t,r,n,void 0,s||a.isVoipWithNoMediaAllowed,o,a.isVoipWithNoMediaAllowed,a.useLivekitForGroupCalls,a.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===$e.Prepared||e===$e.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return S(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initCrypto(){var e=this;return S(function*(){if(!AS())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(e.cryptoBackend){e.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}if(!e.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");e.logger.debug("Crypto: Starting up crypto store..."),yield e.cryptoStore.startup();var t=e.getUserId();if(t===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(e.deviceId===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");var r=new Cl(e,t,e.deviceId,e.store,e.cryptoStore,e.verificationMethods);e.reEmitter.reEmit(r,[Ce.KeyBackupFailed,Ce.KeyBackupSessionsRemaining,Ce.RoomKeyRequest,Ce.RoomKeyRequestCancellation,Ce.Warning,Ce.DevicesUpdated,Ce.WillUpdateDevices,Ce.DeviceVerificationChanged,Ce.UserTrustStatusChanged,Ce.KeysChanged]),e.logger.debug("Crypto: initialising crypto object..."),yield r.init({exportedOlmDevice:e.exportedOlmDeviceToImport,pickleKey:e.pickleKey}),delete e.exportedOlmDeviceToImport,e.olmVersion=Cl.getOlmVersion(),r.registerEventHandlers(e),e.cryptoBackend=e.crypto=r,e.crypto.uploadDeviceKeys().catch(n=>{e.logger.error("Error uploading device keys",n)})})()}initRustCrypto(){var e=arguments,t=this;return S(function*(){var r,n,s=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var o=t.getUserId();if(o===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var a=t.getDeviceId();if(a===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var l=yield BR(()=>import("./index-B_KghNvw.js"),[]),u=yield l.initRustCrypto({logger:t.logger,http:t.http,userId:o,deviceId:a,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:s.useIndexedDB===!1?null:nc,storeKey:s.storageKey,storePassphrase:(r=s.storagePassword)!==null&&r!==void 0?r:t.pickleKey,legacyCryptoStore:t.cryptoStore,legacyPickleKey:(n=t.pickleKey)!==null&&n!==void 0?n:"DEFAULT_KEY",legacyMigrationProgressListener:(c,d)=>{t.emit(Ce.LegacyCryptoStoreMigrationProgress,c,d)}});u.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=u,t.on(Yt.Membership,u.onRoomMembership.bind(u)),t.on(_e.Event,c=>{u.onLiveEventFromSync(c)}),t.reEmitter.reEmit(u,[Ce.VerificationRequestReceived,Ce.UserTrustStatusChanged,Ce.KeyBackupStatus,Ce.KeyBackupSessionsRemaining,Ce.KeyBackupFailed,Ce.KeyBackupDecryptionKeyCached,Ce.KeysChanged,Ce.DevicesUpdated,Ce.WillUpdateDevices])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return(e=(t=this.crypto)===null||t===void 0?void 0:t.getDeviceEd25519Key())!==null&&e!==void 0?e:null}getDeviceCurve25519Key(){var e,t;return(e=(t=this.crypto)===null||t===void 0?void 0:t.getDeviceCurve25519Key())!==null&&e!==void 0?e:null}uploadKeys(){var e=this;return S(function*(){e.logger.warn("MatrixClient.uploadKeys is deprecated")})()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=this.setDeviceVerification(e,t,r,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return this.setDeviceVerification(e,t,null,r,null)}setDeviceKnown(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return this.setDeviceVerification(e,t,null,null,r)}setDeviceVerification(e,t,r,n,s){var o=this;return S(function*(){if(!o.crypto)throw new Error("End-to-end encryption disabled");yield o.crypto.setDeviceVerification(e,t,r,n,s)})()}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(this.cryptoBackend){if(!this.crypto)return}else throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,r)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:_h.Master;if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,r)}prepareToEncrypt(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.setTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}getEventSenderDeviceInfo(e){var t=this;return S(function*(){return t.crypto?t.crypto.getEventSenderDeviceInfo(e):null})()}isEventSenderVerified(e){var t=this;return S(function*(){var r=yield t.getEventSenderDeviceInfo(e);return r?r.isVerified():!1})()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");var t=e.getWireContent(),r={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return!r.session_id||!r.sender_key||!r.algorithm||!r.room_id?Promise.resolve(null):this.crypto.cryptoStore.getOutgoingRoomKeyRequest(r)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){var t,r,n=this.getRoom(e);return n?n.hasEncryptionStateEvent()?!0:(t=(r=this.crypto)===null||r===void 0?void 0:r.isRoomEncrypted(e))!==null&&t!==void 0?t:!1:!1}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw new Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}getKeyBackupVersion(){var e=this;return S(function*(){var t;try{t=yield e.http.authedRequest(z.Get,"/room_keys/version",void 0,void 0,{prefix:vt.V3})}catch(r){if(r.errcode==="M_NOT_FOUND")return null;throw r}return Li.checkBackupVersion(t),t})()}isKeyBackupTrusted(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}prepareKeyBackupVersion(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{secureSecretStorage:!1};if(!r.crypto)throw new Error("End-to-end encryption disabled");var{algorithm:s,auth_data:o,recovery_key:a,privateKey:l}=yield r.crypto.backupManager.prepareKeyBackupVersion(e);return n.secureSecretStorage&&(yield r.secretStorage.store("m.megolm_backup.v1",zt(l)),r.logger.info("Key backup private key stored in secret storage")),{algorithm:s,auth_data:o,recovery_key:a}})()}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}createKeyBackupVersion(e){var t=this;return S(function*(){if(!t.crypto)throw new Error("End-to-end encryption disabled");yield t.crypto.backupManager.createKeyBackupVersion(e);var r={algorithm:e.algorithm,auth_data:e.auth_data};yield t.crypto.signObject(r.auth_data),t.cryptoCallbacks.getCrossSigningKey&&t.crypto.crossSigningInfo.getId()&&(yield t.crypto.crossSigningInfo.signObject(r.auth_data,"master"));var n=yield t.http.authedRequest(z.Post,"/room_keys/version",void 0,r);return yield t.checkKeyBackup(),t.getKeyBackupEnabled()||t.logger.error("Key backup not usable even though we just created it"),n})()}deleteKeyBackupVersion(e){var t=this;return S(function*(){if(!t.cryptoBackend)throw new Error("End-to-end encryption disabled");yield t.cryptoBackend.deleteKeyBackupVersion(e)})()}makeKeyBackupPath(e,t,r){var n;t!==void 0?n=me("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?n=me("/room_keys/keys/$roomId",{$roomId:e}):n="/room_keys/keys";var s=r===void 0?void 0:{version:r};return{path:n,queryData:s}}sendKeyBackup(e,t,r,n){var s=this;return S(function*(){if(!s.crypto)throw new Error("End-to-end encryption disabled");var o=s.makeKeyBackupPath(e,t,r);yield s.http.authedRequest(z.Put,o.path,o.queryData,n,{prefix:vt.V3})})()}scheduleAllGroupSessionsForBackup(){var e=this;return S(function*(){if(!e.crypto)throw new Error("End-to-end encryption disabled");yield e.crypto.backupManager.scheduleAllGroupSessionsForBackup()})()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return Za(e),!0}catch{return!1}}keyBackupKeyFromPassword(e,t){return Sg(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return Za(e)}restoreKeyBackupWithPassword(e,t,r,n,s){var o=this;return S(function*(){var a=yield Sg(n.auth_data,e);return o.restoreKeyBackup(a,t,r,n,s)})()}restoreKeyBackupWithSecretStorage(e,t,r,n){var s=this;return S(function*(){if(!s.cryptoBackend)throw new Error("End-to-end encryption disabled");var o=yield s.secretStorage.get("m.megolm_backup.v1"),a=tl(o);if(a){var l=yield s.secretStorage.getKey();yield s.secretStorage.store("m.megolm_backup.v1",a,[l[0]])}var u=At(a||o);return s.restoreKeyBackup(u,t,r,e,n)})()}restoreKeyBackupWithRecoveryKey(e,t,r,n,s){var o=Za(e);return this.restoreKeyBackup(o,t,r,n,s)}restoreKeyBackupWithCache(e,t,r,n){var s=this;return S(function*(){if(!s.cryptoBackend)throw new Error("End-to-end encryption disabled");var o=yield s.cryptoBackend.getSessionBackupPrivateKey();if(!o)throw new Error("Couldn't get key");return s.restoreKeyBackup(o,e,t,r,n)})()}restoreKeyBackup(e,t,r,n,s){var o=this;return S(function*(){var a=s==null?void 0:s.cacheCompleteCallback,l=s==null?void 0:s.progressCallback;if(!o.cryptoBackend)throw new Error("End-to-end encryption disabled");if(!n.version)throw new Error("Backup version must be defined");var u=n.version,c=0,d=0,h=0,g=o.makeKeyBackupPath(t,r,u),v=yield o.cryptoBackend.getBackupDecryptor(n,e),m=!v.sourceTrusted;try{if(!(e instanceof Uint8Array))throw new Error("restoreKeyBackup expects Uint8Array, got ".concat(e));o.cryptoBackend.storeSessionBackupPrivateKey(e,u).catch(I=>{o.logger.warn("Error caching session backup key:",I)}).then(a),l&&l({stage:"fetch"});var E=yield o.http.authedRequest(z.Get,g.path,g.queryData,void 0,{prefix:vt.V3});if(l&&l({stage:"load_keys"}),E.rooms)c=o.getTotalKeyCount(E),yield o.handleDecryptionOfAFullBackup(E,v,200,function(){var I=S(function*(y){try{var C=n.version;yield o.cryptoBackend.importBackedUpRoomKeys(y,C,{untrusted:m}),h+=y.length}catch(w){d+=y.length,p.error("Error importing keys from backup",w)}l&&l({total:c,successes:h,stage:"load_keys",failures:d})});return function(y){return I.apply(this,arguments)}}());else if(E.sessions){var R=E.sessions;c=Object.keys(R).length;var _=yield v.decryptSessions(R);for(var T of _)T.room_id=t;yield o.cryptoBackend.importBackedUpRoomKeys(_,u,{progressCallback:l,untrusted:m}),h=_.length}else{c=1;try{var[b]=yield v.decryptSessions({[r]:E});b.room_id=t,b.session_id=r,yield o.cryptoBackend.importBackedUpRoomKeys([b],u,{progressCallback:l,untrusted:m}),h=1}catch(I){o.logger.debug("Failed to decrypt megolm session from backup",I)}}}finally{v.free()}return yield o.cryptoBackend.checkKeyBackupAndEnable(),{total:c,imported:h}})()}getTotalKeyCount(e){var t=e.rooms,r=0;for(var n of Object.values(t))n.sessions&&(r+=Object.keys(n.sessions).length);return r}handleDecryptionOfAFullBackup(e,t,r,n){return S(function*(){var s=e.rooms,o=0,a=new Map,l=function(){var v=S(function*(m){var E=[];for(var R of m.keys()){var _=yield t.decryptSessions(m.get(R));for(var T in _){var b=_[T];b.room_id=R,E.push(b)}}yield n(E)});return function(E){return v.apply(this,arguments)}}();for(var[u,c]of Object.entries(s))if(c.sessions){a.set(u,{});for(var[d,h]of Object.entries(c.sessions)){var g=a.get(u);g[d]=h,o+=1,o>=r&&(yield l(a),a=new Map,a.set(u,{}),o=0)}}o>0&&(yield l(a))})()}deleteKeysFromBackup(e,t,r){var n=this;return S(function*(){if(!n.crypto)throw new Error("End-to-end encryption disabled");var s=n.makeKeyBackupPath(e,t,r);yield n.http.authedRequest(z.Delete,s.path,s.queryData,void 0,{prefix:vt.V3})})()}sendSharedHistoryKeys(e,t){var r=this;return S(function*(){var n;if(!r.crypto)throw new Error("End-to-end encryption disabled");var s=(n=r.crypto)===null||n===void 0?void 0:n.getRoomEncryption(e);if(!s){r.logger.error("Unknown room.  Not sharing decryption keys");return}var o=yield r.crypto.downloadKeys(t),a=new Map;for(var[l,u]of o)a.set(l,Array.from(u.values()));var c=r.crypto.getRoomDecryptor(e,s.algorithm);c.sendSharedHistoryInboundSessions?yield c.sendSharedHistoryInboundSessions(a):r.logger.warn("Algorithm does not support sharing previous keys",s.algorithm)})()}getMediaConfig(){return this.http.authedRequest(z.Get,"/config",void 0,void 0,{prefix:ls.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),r=new Set;for(var n of t){var s,o=(s=n.findPredecessor(e))===null||s===void 0?void 0:s.roomId;o&&r.add(o)}return t.filter(a=>{var l=a.currentState.getStateEvents(F.RoomTombstone,"");return!(l&&r.has(a.roomId))})}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var r=me("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return Xy(5,()=>this.http.authedRequest(z.Put,r,void 0,t))}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return S(function*(){if(t.isInitialSyncComplete()){var r=t.store.getAccountData(e);return r?r.getContent():null}var n=me("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(z.Get,n)}catch(o){var s;if(((s=o.data)===null||s===void 0?void 0:s.errcode)==="M_NOT_FOUND")return null;throw o}})()}deleteAccountData(e){var t=this;return S(function*(){var r=t.canSupport.get(dt.AccountDataDeletion);if(r===gt.Unsupported){yield t.setAccountData(e,{});return}var n=me("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),s=r===gt.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(z.Delete,n,void 0,void 0,s)})()}getIgnoredUsers(){var e=this.getAccountData("m.ignored_user_list");return!e||!e.getContent()||!e.getContent().ignored_users?[]:Object.keys(e.getContent().ignored_users)}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(r=>{t.ignored_users[r]={}}),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};n.syncRoom===void 0&&(n.syncRoom=!0);var s=r.getRoom(e);if(s!=null&&s.hasMembershipState(r.credentials.userId,Oe.Join))return s;var o=Promise.resolve();if(n.inviteSignUrl){var a=new URL(n.inviteSignUrl);a.searchParams.set("mxid",r.credentials.userId),o=r.http.requestOtherUrl(z.Post,a)}var l={};n.viaServers&&(l.server_name=n.viaServers,l.via=n.viaServers,r.canSupport.get(dt.MigrateServerNameToVia)===gt.Unstable&&(l=ka("via","org.matrix.msc4156.via",l)));var u={},c=yield o;c&&(u.third_party_signed=c);var d=me("/join/$roomid",{$roomid:e}),h=yield r.http.authedRequest(z.Post,d,l,u),g=h.room_id,v=r.getRoom(g);if(v!=null&&v.hasMembershipState(r.credentials.userId,Oe.Join))return v;var m=new bo(r,r.clientOpts,r.buildSyncApiOptions()),E=m.createRoom(g);return n.syncRoom,E})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this.getRoom(e);if(r!=null&&r.hasMembershipState(this.credentials.userId,Oe.Knock))return Promise.resolve({room_id:r.roomId});var n=me("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),s={};t.viaServers&&(s.server_name=t.viaServers,s.via=t.viaServers,this.canSupport.get(dt.MigrateServerNameToVia)===gt.Unstable&&(s=ka("via","org.matrix.msc4156.via",s)));var o={};return t.reason&&(o.reason=t.reason),this.http.authedRequest(z.Post,n,s,o)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,Re.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![Re.QUEUED,Re.NOT_SENT,Re.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===Re.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===Re.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,Re.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,F.RoomName,{name:t})}setRoomTopic(e,t,r){var n=jy(t,r);return this.sendStateEvent(e,F.RoomTopic,n)}getRoomTags(e){var t=me("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(z.Get,t)}setRoomTag(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=me("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(z.Put,n,void 0,r)}deleteRoomTag(e,t){var r=me("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(z.Delete,r)}setRoomAccountData(e,t,r){var n=me("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(z.Put,n,void 0,r)}setPowerLevel(e,t,r){var n=this;return S(function*(){var s,o;if(n.clientRunning&&n.isInitialSyncComplete()){var a;o=(a=n.getRoom(e))===null||a===void 0||(a=a.currentState)===null||a===void 0||(a=a.getStateEvents(F.RoomPowerLevels,""))===null||a===void 0?void 0:a.getContent()}if(!o)try{o=yield n.getStateEvent(e,F.RoomPowerLevels,"")}catch(c){if(c instanceof Qt&&c.errcode==="M_NOT_FOUND")o={};else throw c}o=Jl(o),(s=o)!==null&&s!==void 0&&s.users||(o.users={});var l=Array.isArray(t)?t:[t];for(var u of l)r==null?delete o.users[u]:o.users[u]=r;return n.sendStateEvent(e,F.RoomPowerLevels,o,"")})()}unstable_createLiveBeacon(e,t){var r=this;return S(function*(){return r.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var r=this;return S(function*(){return r.sendStateEvent(e,ah.name,t,r.getUserId())})()}sendEvent(e,t,r,n,s){var o,a,l,u,c;if(!(t!=null&&t.startsWith(Kr))&&t!==null?(c=n,u=r,l=t,a=null):(c=s,u=n,l=r,a=t),a&&!((o=u["m.relates_to"])!==null&&o!==void 0&&o.rel_type)){var d,h,g=!!((d=u["m.relates_to"])!==null&&d!==void 0&&d["m.in_reply_to"]);u["m.relates_to"]=Pt(Pt({},u["m.relates_to"]),{},{rel_type:Je.name,event_id:a,is_falling_back:!g});var v=(h=this.getRoom(e))===null||h===void 0?void 0:h.getThread(a);if(v&&!g){var m,E;u["m.relates_to"]["m.in_reply_to"]={event_id:(m=(E=v.lastReply(R=>R.isRelation(Je.name)&&!R.status))===null||E===void 0?void 0:E.getId())!==null&&m!==void 0?m:a}}}return this.sendCompleteEvent(e,a,{type:l,content:u},c)}sendCompleteEvent(e,t,r,n){n||(n=this.makeTxnId());var s=new Ot(Object.assign(r,{event_id:"~"+e+":"+n,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),o=this.getRoom(e),a=t?o==null?void 0:o.getThread(t):void 0;a&&s.setThread(a),this.reEmitter.reEmit(s,[Fe.Replaced,Fe.VisibilityChange]),o==null||o.reEmitter.reEmit(s,[Fe.BeforeRedaction]);var l=s.getAssociatedId();if(l!=null&&l.startsWith("~")){var u=o==null?void 0:o.getPendingEvents().find(d=>d.getId()===l);u==null||u.once(Fe.LocalEventIdReplaced,()=>{s.updateAssociatedId(u.getId())})}var c=s.getType();return this.logger.debug("sendEvent of type ".concat(c," in ").concat(e," with txnId ").concat(n)),s.setTxnId(n),s.setStatus(Re.SENDING),o==null||o.addPendingEvent(s,n),s.status===Re.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,s)}encryptAndSendEvent(e,t){var r=this;return S(function*(){try{var n;r.eventsBeingEncrypted.add(t.getId());try{yield r.encryptEventIfNeeded(t,e??void 0)}finally{n=!r.eventsBeingEncrypted.delete(t.getId())}if(n)return{};t.status===Re.ENCRYPTING&&r.updatePendingEventStatus(e,t,Re.SENDING);var s=null;return r.scheduler&&(s=r.scheduler.queueEvent(t),s&&r.scheduler.getQueueForEvent(t).length>1&&r.updatePendingEventStatus(e,t,Re.QUEUED)),s||(s=r.sendEventHttpRequest(t),e&&(s=s.then(o=>(e.updatePendingEvent(t,Re.SENT,o.event_id),o)))),yield s}catch(o){r.logger.error("Error sending event",o);try{t.error=o,r.updatePendingEventStatus(e,t,Re.NOT_SENT)}catch(a){r.logger.error("Exception in error handler!",a)}throw o instanceof Qt&&(o.event=t),o}})()}encryptEventIfNeeded(e,t){var r=this;return S(function*(){if(t&&(yield r.shouldEncryptEventForRoom(e,t))&&!(!r.cryptoBackend&&r.usingExternalCrypto)){if(!r.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");r.updatePendingEventStatus(t,e,Re.ENCRYPTING),yield r.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var r=this;return S(function*(){var n;return e.isEncrypted()||e.getType()===F.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(n=r.cryptoBackend)===null||n===void 0?void 0:n.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var r;return t===F.Reaction?t:(r=this.getRoom(e))!==null&&r!==void 0&&r.hasEncryptionStateEvent()?F.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e){var t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));var r={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t},n;if(e.isState()){var s="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(s="/rooms/$roomId/state/$eventType/$stateKey"),n=me(s,r)}else if(e.isRedaction()&&e.event.redacts){var o="/rooms/$roomId/redact/$redactsEventId/$txnId";n=me(o,Pt({$redactsEventId:e.event.redacts},r))}else n=me("/rooms/$roomId/send/$eventType/$txnId",r);return this.http.authedRequest(z.Put,n,void 0,e.getWireContent()).then(a=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(a.event_id)),a))}redactEvent(e,t,r,n,s){var o,a,l;(o=r)!==null&&o!==void 0&&o.startsWith(Kr)||(s=n,n=r,r=t,t=null);var u=(a=s)===null||a===void 0?void 0:a.reason,c={reason:u};if(((l=s)===null||l===void 0?void 0:l.with_rel_types)!==void 0){if(this.canSupport.get(dt.RelationBasedRedactions)===gt.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(n," threadId ").concat(t));var d=this.canSupport.get(dt.RelationBasedRedactions)===gt.Stable?Kc.stable:Kc.unstable;c[d]=s.with_rel_types}return this.sendCompleteEvent(e,t,{type:F.RoomRedaction,content:c,redacts:r},n)}sendMessage(e,t,r,n){typeof t!="string"&&t!==null&&(n=r,r=t,t=null);var s=F.RoomMessage,o=r;return this.sendEvent(e,t,s,o,n)}sendTextMessage(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(n=r,r=t,t=null);var o=Ny(r);return this.sendMessage(e,t,o,n)}sendNotice(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(n=r,r=t,t=null);var o=xy(r);return this.sendMessage(e,t,o,n)}sendEmoteMessage(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(n=r,r=t,t=null);var o=Ky(r);return this.sendMessage(e,t,o,n)}sendImageMessage(e,t,r,n){var s,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(o=n||"Image",n=r,r=t,t=null);var a={msgtype:Nr.Image,url:r,info:n,body:o};return this.sendMessage(e,t,a)}sendStickerMessage(e,t,r,n){var s,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(o=n||"Sticker",n=r,r=t,t=null);var a={url:r,info:n,body:o};return this.sendEvent(e,t,F.Sticker,a)}sendHtmlMessage(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(n=r,r=t,t=null);var o=Dy(r,n);return this.sendMessage(e,t,o)}sendHtmlNotice(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(n=r,r=t,t=null);var o=Uy(r,n);return this.sendMessage(e,t,o)}sendHtmlEmote(e,t,r,n){var s;!((s=t)!==null&&s!==void 0&&s.startsWith(Kr))&&t!==null&&(n=r,r=t,t=null);var o=Ly(r,n);return this.sendMessage(e,t,o)}sendReceipt(e,t,r){var n=arguments,s=this;return S(function*(){var o=n.length>3&&n[3]!==void 0?n[3]:!1;if(s.isGuest())return Promise.resolve({});var a=me("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),l=!o&&s.supportsThreads(),u=l?Pt(Pt({},r),{},{thread_id:Cs(e)}):r,c=s.http.authedRequest(z.Post,a,void 0,u||{}),d=s.getRoom(e.getRoomId());return d&&s.credentials.userId&&d.addLocalEchoReceipt(s.credentials.userId,e,t,o),c})()}sendReadReceipt(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:Gt.Read,s=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var o=e.getId(),a=r.getRoom(e.getRoomId());if(a!=null&&a.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));return r.sendReceipt(e,n,{},s)}})()}setRoomReadMarkers(e,t,r,n){var s=this;return S(function*(){var o=s.getRoom(e);if(o!=null&&o.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var a;if(r){if(a=r.getId(),o!=null&&o.hasPendingEvent(a))throw new Error("Cannot set read receipt to a pending event (".concat(a,")"));o==null||o.addLocalEchoReceipt(s.credentials.userId,r,Gt.Read)}var l;if(n){if(l=n.getId(),o!=null&&o.hasPendingEvent(l))throw new Error("Cannot set read receipt to a pending event (".concat(l,")"));o==null||o.addLocalEchoReceipt(s.credentials.userId,n,Gt.ReadPrivate)}return yield s.setRoomReadMarkersHttpRequest(e,t,a,l)})()}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var r=new URL(e);r.hash="",e=r.toString();var n=t+"_"+e;if(n in this.urlPreviewCache)return this.urlPreviewCache[n];var s=this.http.authedRequest(z.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:ls.V3,priority:"low"});return this.urlPreviewCache[n]=s,s}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});var n=me("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),s={typing:t};return t&&(s.timeout=r||2e4),this.http.authedRequest(z.Put,n,void 0,s)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getRoom(e);if(!n)return[];var s=this.findPredecessorRooms(n,t,r),o=this.findSuccessorRooms(n,t,r);return[...s,n,...o]}findPredecessorRooms(e,t,r){for(var n,s=[],o=(n=e.findPredecessor(r))===null||n===void 0?void 0:n.roomId;o!==null;){var a,l=this.getRoom(o);if(l===null)break;if(t){var u=l.currentState.getStateEvents(F.RoomTombstone,"");if(!u||u.getContent().replacement_room!==e.roomId)break}s.splice(0,0,l),e=l,o=(a=e.findPredecessor(r))===null||a===void 0?void 0:a.roomId}return s}findSuccessorRooms(e,t,r){for(var n=[],s=e.currentState.getStateEvents(F.RoomTombstone,"");s;){var o=this.getRoom(s.getContent().replacement_room);if(!o||o.roomId===e.roomId)break;if(t){var a,l=(a=o.findPredecessor(r))===null||a===void 0?void 0:a.roomId;if(!l||l!==e.roomId)break}n.push(o);var u=new Set(n.map(c=>c.roomId));if(u.size<n.length)return n.slice(0,n.length-1);e=o,s=e.currentState.getStateEvents(F.RoomTombstone,"")}return n}invite(e,t,r){return this.membershipChange(e,t,Oe.Invite,r)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,r){var n=this;return S(function*(){var s,o=me("/rooms/$roomId/invite",{$roomId:e}),a=n.getIdentityServerUrl(!0);if(!a)return Promise.reject(new Qt({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var l={id_server:a,medium:t,address:r};if((s=n.identityServer)!==null&&s!==void 0&&s.getAccessToken){var u=yield n.identityServer.getAccessToken();u&&(l.id_access_token=u)}return n.http.authedRequest(z.Post,o,void 0,l)})()}leave(e){return this.membershipChange(e,void 0,Oe.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=this.getRoomUpgradeHistory(e),n=r;if(!t){n=[];for(var s of r)if(n.push(s),s.roomId===e)break}var o={},a=[],l=c=>this.leave(c).then(()=>{delete o[c]}).catch(d=>{o[c]=d});for(var u of n)a.push(l(u.roomId));return Promise.all(a).then(()=>o)}ban(e,t,r){return this.membershipChange(e,t,Oe.Ban,r)}forget(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=this.membershipChange(e,void 0,"forget");return t?r.then(n=>(this.store.removeRoom(e),this.emit(_e.DeleteRoom,e),n)):r}unban(e,t){var r=me("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(z.Post,r,void 0,n)}kick(e,t,r){var n=me("/rooms/$roomId/kick",{$roomId:e}),s={user_id:t,reason:r};return this.http.authedRequest(z.Post,n,void 0,s)}membershipChange(e,t,r,n){var s=me("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(z.Post,s,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushDetails()}setProfileInfo(e,t){var r=me("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(z.Put,r,void 0,t)}setDisplayName(e){var t=this;return S(function*(){var r=yield t.setProfileInfo("displayname",{displayname:e}),n=t.getUser(t.getUserId());return n&&(n.displayName=e,n.emit(hr.DisplayName,n.events.presence,n)),r})()}setAvatarUrl(e){var t=this;return S(function*(){var r=yield t.setProfileInfo("avatar_url",{avatar_url:e}),n=t.getUser(t.getUserId());return n&&(n.avatarUrl=e,n.emit(hr.AvatarUrl,n.events.presence,n)),r})()}mxcUrlToHttp(e,t,r,n,s,o,a){return Ql(this.baseUrl,e,t,r,n,s,o,a)}setSyncPresence(e){var t=this;return S(function*(){var r;(r=t.syncApi)===null||r===void 0||r.setPresence(e)})()}setPresence(e){var t=this;return S(function*(){var r=me("/presence/$userId/status",{$userId:t.credentials.userId}),n=["offline","online","unavailable"];if(n.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(z.Put,r,void 0,e)})()}getPresence(e){var t=me("/presence/$userId/status",{$userId:e});return this.http.authedRequest(z.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,r=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){var s=Date.now()-n.errorTs;r=Math.max(gC-s,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t=t-o;var a=new Promise((l,u)=>{Zo(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,Ue.Backward)).then(c=>{var d,h,g=c.chunk.map(this.getEventMapper());if(c.state){var v=c.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(v)}var[m,E,R]=e.partitionThreadedEvents(g);this.processAggregatedTimelineEvents(e,m),e.addEventsToTimeline(m,!0,e.getLiveTimeline()),this.processThreadEvents(e,E,!0),R.forEach(_=>e.relations.aggregateChildEvent(_)),e.oldState.paginationToken=(d=c.end)!==null&&d!==void 0?d:null,c.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,g,(h=c.end)!==null&&h!==void 0?h:null,!0),delete this.ongoingScrollbacks[e.roomId],l(e)}).catch(c=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},u(c)})});return n={promise:a},this.ongoingScrollbacks[e.roomId]=n,a}getEventMapper(e){return z0(this,e||{})}getEventTimeline(e,t){var r=this;return S(function*(){var n,s,o,a;if(!r.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&r.supportsThreads())return r.getThreadTimeline(e,t);var l=me("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),u=void 0;(n=r.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(u={filter:JSON.stringify(rr.LAZY_LOADING_MESSAGES_FILTER)});var c=yield r.http.authedRequest(z.Get,l,u);if(!c.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var d=r.getEventMapper(),h=d(c.event);if(h.isRelation(Je.name)){r.logger.warn("Tried loading a regular timeline at the position of a thread event");return}var g=[...c.events_after.reverse().map(d),h,...c.events_before.map(d)],v=e.getTimelineForEvent(g[0].getId());v?v.getState(ve.BACKWARDS).setUnknownStateEvents(c.state.map(d)):(v=e.addTimeline(),v.initialiseState(c.state.map(d)),v.getState(ve.FORWARDS).paginationToken=c.end);var[m,E,R]=e.room.partitionThreadedEvents(g);return e.addEventsToTimeline(m,!0,v,c.start),r.processThreadEvents(e.room,E,!0),r.processAggregatedTimelineEvents(e.room,m),R.forEach(_=>e.relations.aggregateChildEvent(_)),(s=(o=e.getTimelineForEvent(t))!==null&&o!==void 0?o:(a=e.room.findThreadForEvent(h))===null||a===void 0?void 0:a.liveTimeline)!==null&&s!==void 0?s:v})()}getThreadTimeline(e,t){var r=this;return S(function*(){var n;if(!r.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var s=me("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),o={limit:"0"};(n=r.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(o.filter=JSON.stringify(rr.LAZY_LOADING_MESSAGES_FILTER));var a=yield r.http.authedRequest(z.Get,s,o),l=r.getEventMapper(),u=l(a.event);if(e.canContain(u)){var c=r.canSupport.get(dt.RelationsRecursion)!==gt.Unsupported;if(et.hasServerSideSupport)if(et.hasServerSideFwdPaginationSupport){var d,h,g;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var v=e.thread,m=yield r.fetchRelations(e.room.roomId,v.id,null,null,{dir:Ue.Backward,from:a.start,recurse:c||void 0}),E=yield r.fetchRelations(e.room.roomId,v.id,null,null,{dir:Ue.Forward,from:a.end,recurse:c||void 0}),R=[...E.chunk.reverse().filter(sc(v.id)).map(l),u,...m.chunk.filter(sc(v.id)).map(l)];for(var _ of R){var T;yield(T=e.thread)===null||T===void 0?void 0:T.processEvent(_)}var b=e.getTimelineForEvent(u.getId());if(b?b.getState(ve.BACKWARDS).setUnknownStateEvents(a.state.map(l)):(b=e.addTimeline(),b.initialiseState(a.state.map(l))),e.addEventsToTimeline(R,!0,b,E.next_batch),!m.next_batch){var I=yield r.fetchRoomEvent(e.room.roomId,v.id);e.addEventsToTimeline([l(I)],!0,b,null)}return b.setPaginationToken((d=m.next_batch)!==null&&d!==void 0?d:null,Ue.Backward),b.setPaginationToken((h=E.next_batch)!==null&&h!==void 0?h:null,Ue.Forward),r.processAggregatedTimelineEvents(e.room,R),(g=e.getTimelineForEvent(t))!==null&&g!==void 0?g:b}else{for(var y,C=e.thread,w=yield r.fetchRelations(e.room.roomId,C.id,Je.name,null,{dir:Ue.Backward,from:a.start,recurse:c||void 0}),D=[],x=a.end;x;){var G,oe=yield r.fetchRelations(e.room.roomId,C.id,Je.name,null,{dir:Ue.Forward,from:x,recurse:c||void 0});x=(G=oe.next_batch)!==null&&G!==void 0?G:null,D.push(...oe.chunk)}var de=[...D.reverse().map(l),u,...w.chunk.map(l)];for(var Ee of de){var X;yield(X=e.thread)===null||X===void 0?void 0:X.processEvent(Ee)}var re=e.getLiveTimeline();if(re.getState(ve.BACKWARDS).setUnknownStateEvents(a.state.map(l)),e.addEventsToTimeline(de,!0,re,null),!w.next_batch){var Z=yield r.fetchRoomEvent(e.room.roomId,C.id);e.addEventsToTimeline([l(Z)],!0,re,null)}return re.setPaginationToken((y=w.next_batch)!==null&&y!==void 0?y:null,Ue.Backward),re.setPaginationToken(null,Ue.Forward),r.processAggregatedTimelineEvents(e.room,de),re}}})()}getLatestTimeline(e){var t=this;return S(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var r;if(e.threadListType!==null){var n,s=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,Ue.Backward,e.threadListType,e.getFilter());r=(n=s.chunk)===null||n===void 0?void 0:n[0]}else if(e.thread&&et.hasServerSideSupport){var o,a=t.canSupport.get(dt.RelationsRecursion)!==gt.Unsupported,l=yield t.fetchRelations(e.room.roomId,e.thread.id,Je.name,null,{dir:Ue.Backward,limit:1,recurse:a||void 0});r=(o=l.chunk)===null||o===void 0?void 0:o[0]}else{var u,c,d=me("/rooms/$roomId/messages",{$roomId:e.room.roomId}),h={dir:"b"};(u=t.clientOpts)!==null&&u!==void 0&&u.lazyLoadMembers&&(h.filter=JSON.stringify(rr.LAZY_LOADING_MESSAGES_FILTER));var g=yield t.http.authedRequest(z.Get,d,h);r=(c=g.chunk)===null||c===void 0?void 0:c[0]}if(!r)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,r.event_id)})()}createMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,s=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,a=me("/rooms/$roomId/messages",{$roomId:e}),l={limit:n.toString(),dir:s};t&&(l.from=t);var u=null;if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(u=Object.assign({},rr.LAZY_LOADING_MESSAGES_FILTER)),o){var c;u=u||{},Object.assign(u,(c=o.getRoomTimelineFilterComponent())===null||c===void 0?void 0:c.toJSON())}return u&&(l.filter=JSON.stringify(u)),this.http.authedRequest(z.Get,a,l)}createThreadListMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:Ue.Backward,o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Rr.All,a=arguments.length>5?arguments[5]:void 0,l=me("/rooms/$roomId/threads",{$roomId:e}),u={limit:n.toString(),dir:s,include:qS(o)};t&&(u.from=t);var c={};if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(c=Pt({},rr.LAZY_LOADING_MESSAGES_FILTER)),a){var d;c=Pt(Pt({},c),(d=a.getRoomTimelineFilterComponent())===null||d===void 0?void 0:d.toJSON())}Object.keys(c).length&&(u.filter=JSON.stringify(c));var h={prefix:et.hasServerSideListSupport===Lt.Stable?vt.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(z.Get,l,u,void 0,h).then(g=>{var v;return Pt(Pt({},g),{},{chunk:(v=g.chunk)===null||v===void 0?void 0:v.reverse(),start:g.prev_batch,end:g.next_batch})})}paginateEventTimeline(e,t){var r=this,n=e.getTimelineSet()===this.notifTimelineSet,s=this.getRoom(e.getRoomId()),o=e.getTimelineSet().threadListType,a=e.getTimelineSet().thread;t=t||{};var l=t.backwards||!1;if(n&&!l)throw new Error("paginateNotifTimeline can only paginate backwards");var u=l?ve.BACKWARDS:ve.FORWARDS,c=e.getPaginationToken(u),d=e.paginationRequests[u];if(d)return d;var h,g,v;if(n){var m;h="/notifications",g={limit:((m=t.limit)!==null&&m!==void 0?m:30).toString(),only:"highlight"},c&&c!=="end"&&(g.from=c),v=this.http.authedRequest(z.Get,h,g).then(function(){var b=S(function*(I){var y=I.next_token,C=[];I.notifications=I.notifications.filter(Cr);for(var w=0;w<I.notifications.length;w++){var D=I.notifications[w],x=r.getEventMapper()(D.event);r.getPushDetailsForEvent(x,!0),x.event.room_id=D.room_id,C[w]=x}var G=e.getTimelineSet();return G.addEventsToTimeline(C,l,e,y),r.processAggregatedTimelineEvents(G.room,C),l&&!I.next_token&&e.setPaginationToken(null,u),!!I.next_token});return function(I){return b.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}else if(o!==null){if(!s)throw new Error("Unknown room "+e.getRoomId());if(!et.hasServerSideFwdPaginationSupport&&u===Ue.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");v=this.createThreadListMessagesRequest(e.getRoomId(),c,t.limit,u,o,e.getFilter()).then(b=>{if(b.state){var I=e.getState(u),y=b.state.filter(Cr).map(this.getEventMapper());I.setUnknownStateEvents(y)}var C=b.end,w=b.chunk.filter(Cr).map(this.getEventMapper()),D=e.getTimelineSet();return D.addEventsToTimeline(w,l,e,C),this.processAggregatedTimelineEvents(s,w),this.processThreadRoots(s,w,l),l&&b.end==b.start&&e.setPaginationToken(null,u),b.end!==b.start}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}else if(a){var E,R,_=this.getRoom((E=e.getRoomId())!==null&&E!==void 0?E:void 0);if(!_)throw new Error("Unknown room "+e.getRoomId());var T=this.canSupport.get(dt.RelationsRecursion)!==gt.Unsupported;v=this.fetchRelations((R=e.getRoomId())!==null&&R!==void 0?R:"",a.id,null,null,{dir:u,limit:t.limit,from:c??void 0,recurse:T||void 0}).then(function(){var b=S(function*(I){var y=r.getEventMapper(),C=I.chunk.filter(Cr).filter(sc(a.id)).map(y);for(var w of C.slice().reverse()){yield a==null?void 0:a.processEvent(w);var D=w.getSender();(!l||(a==null?void 0:a.getEventReadUpTo(D))===null)&&_.addLocalEchoReceipt(D,w,Gt.Read)}var x=I.next_batch,G=e.getTimelineSet();if(G.addEventsToTimeline(C,l,e,x??null),!x&&l){var oe,de,Ee=(oe=a.rootEvent)!==null&&oe!==void 0?oe:y(yield r.fetchRoomEvent((de=e.getRoomId())!==null&&de!==void 0?de:"",a.id));G.addEventsToTimeline([Ee],!0,e,null)}return r.processAggregatedTimelineEvents(G.room,C),l&&!x&&e.setPaginationToken(null,u),!!x});return function(I){return b.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}else{if(!s)throw new Error("Unknown room "+e.getRoomId());v=this.createMessagesRequest(e.getRoomId(),c,t.limit,u,e.getFilter()).then(b=>{if(b.state){var I=e.getState(u),y=b.state.filter(Cr).map(this.getEventMapper());I.setUnknownStateEvents(y)}var C=b.end,w=b.chunk.filter(Cr).map(this.getEventMapper()),D=e.getTimelineSet(),[x,,G]=s.partitionThreadedEvents(w);D.addEventsToTimeline(x,l,e,C),this.processAggregatedTimelineEvents(s,x),this.processThreadRoots(s,x.filter(de=>de.getServerAggregatedRelation(Je.name)),!1),G.forEach(de=>s.relations.aggregateChildEvent(de));var oe=b.end===void 0||b.end===b.start;return l&&oe&&e.setPaginationToken(null,u),!oe}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}return v}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new bo(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var r=this.sendStateEvent(e,F.RoomGuestAccess,{guest_access:t.allowJoin?kl.CanJoin:kl.Forbidden},""),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,F.RoomHistoryVisibility,{history_visibility:Ih.WorldReadable},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,s){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:s})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,s){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:s})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,s){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:s})}requestTokenFromEndpoint(e,t){var r=this;return S(function*(){var n=Object.assign({},t);return r.http.request(z.Post,e,void 0,n)})()}getRoomPushRule(e,t){if(this.pushRules){var r;return(r=this.pushRules[e])===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.find(n=>n.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){var n,s=!1,o=this.getRoomPushRule(e,t);if(o!=null&&o.actions.includes(zn.DontNotify)&&(s=!0),!r)s&&(n=this.deletePushRule(e,Ct.RoomSpecific,o.rule_id));else if(!o)n=this.addPushRule(e,Ct.RoomSpecific,t,{actions:[zn.DontNotify]});else if(!s){var a=ni();this.deletePushRule(e,Ct.RoomSpecific,o.rule_id).then(()=>{this.addPushRule(e,Ct.RoomSpecific,t,{actions:[zn.DontNotify]}).then(()=>{a.resolve()}).catch(l=>{a.reject(l)})}).catch(l=>{a.reject(l)}),n=a.promise}if(n)return new Promise((l,u)=>{n.then(()=>{this.getPushRules().then(c=>{this.pushRules=c,l()}).catch(c=>{u(c)})}).catch(c=>{this.getPushRules().then(d=>{this.pushRules=d,u(c)}).catch(d=>{u(c)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:US.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(n=>this.processRoomEventsSearch(r,n))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(n=>this.processRoomEventsSearch(e,n)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,n,s=t.search_categories.room_events;e.count=s.count,e.next_batch=s.next_batch;var o=new Set(s.highlights);e.highlights.forEach(v=>{o.add(v)}),e.highlights=Array.from(o);for(var a=this.getEventMapper(),l=(r=(n=s.results)===null||n===void 0?void 0:n.length)!==null&&r!==void 0?r:0,u=0;u<l;u++){var c=ou.fromJson(s.results[u],a),d=this.getRoom(c.context.getEvent().getRoomId());if(d)for(var h of c.context.getTimeline()){var g=d.getMember(h.getSender());!h.sender&&g&&(h.sender=g)}e.results.push(c)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new bo(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=me("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(z.Post,t,void 0,e).then(r=>{var n=rr.fromJson(this.credentials.userId,r.filter_id,e);return this.store.storeFilter(n),n})}getFilter(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var s=me("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(z.Get,s).then(o=>{var a=rr.fromJson(e,t,o);return this.store.storeFilter(a),a})}getOrCreateFilter(e,t){var r=this;return S(function*(){var n=r.store.getFilterIdByName(e),s;if(n){try{var o=yield r.getFilter(r.credentials.userId,n,!0);if(o){var a=o.getDefinition(),l=t.getDefinition();Ki(a,l)&&(s=n)}}catch(c){if(c.errcode!=="M_UNKNOWN"&&c.errcode!=="M_NOT_FOUND")throw c}s||r.store.setFilterIdByName(e,void 0)}if(s)return s;var u=yield r.createFilter(t.getDefinition());return r.store.setFilterIdByName(e,u.filterId),u.filterId})()}getOpenIdToken(){var e=me("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(z.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(z.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return S(function*(){if(e.canSupportVoip){var t=!1,r=e.turnServersExpiry-Date.now();if(r>Hg)e.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var n=yield e.turnServer();if(n.uris){e.logger.debug("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs");var s={urls:n.uris,username:n.username,credential:n.password};e.turnServers=[s],e.turnServersExpiry=Date.now()+n.ttl*1e3,t=!0,e.emit(_e.TurnServers,e.turnServers)}}catch(o){e.logger.error("Failed to get TURN URIs",o),o.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&global.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(_e.TurnServersError,o,!0)):e.emit(_e.TurnServersError,o,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=me("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(z.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=me("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(z.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=me("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(z.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return S(function*(){var t;e.clientWellKnownPromise=ke.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(_e.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(r=>{var[n,s]=r;return e.includes(typeof s)}).reduce((r,n)=>{var[s,o]=n;return r[s]=o,r},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return S(function*(){var r=yield t.doesServerSupportUnstableFeature(KS),n=yield t.doesServerSupportUnstableFeature(FS),s=yield t.doesServerSupportUnstableFeature(BS);if(!r&&!n&&!s)throw Error("Server does not support the Mutual Rooms API");var o,a;s?(o="/uk.half-shot.msc2666/user/mutual_rooms",a={user_id:e}):(o=me("/uk.half-shot.msc2666/user/".concat(n?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),a={});var l=[],u=null;do{var c={};u!=null&&s&&(c.batch_token=u);var d=yield t.http.authedRequest(z.Get,o,Pt(Pt({},a),c),void 0,{prefix:vt.Unstable});l.push(...d.joined),d.next_batch_token!==void 0?u=d.next_batch_token:u=null}while(u!=null);return l})()}getVersions(){var e=this;return S(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(z.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(r=>{throw e.serverVersionsPromise=void 0,r});var t=yield e.serverVersionsPromise;return e.canSupport=yield wT(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return S(function*(){var{versions:r}=yield t.getVersions();return r&&r.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return S(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features;return n&&!!n[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return S(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features,s=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced.".concat(s)]})()}doesServerSupportThread(){var e=this;return S(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:Lt.Stable,list:Lt.Stable,fwdPagination:Lt.Stable};try{var[t,r,n,s,o,a]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:nl(r,t),list:nl(s,n),fwdPagination:nl(a,o)}}catch{return{threads:Lt.None,list:Lt.None,fwdPagination:Lt.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,r,n){var s=arguments,o=this;return S(function*(){var a,l,u=s.length>4&&s[4]!==void 0?s[4]:{dir:Ue.Backward},c=n?o.getEncryptedIfNeededEventType(e,n):null,[d,h]=yield Promise.all([o.fetchRoomEvent(e,t),o.fetchRelations(e,t,r,c,u)]),g=o.getEventMapper(),v=d?g(d):void 0,m=h.chunk.map(g);if(c===F.RoomMessageEncrypted){var E=v?m.concat(v):m;yield Promise.all(E.map(R=>o.decryptEventIfNeeded(R))),n!==null&&(m=m.filter(R=>R.getType()===n))}return v&&r===lt.Replace&&(m=m.filter(R=>R.getSender()===v.getSender())),{originalEvent:v??null,events:m,nextBatch:(a=h.next_batch)!==null&&a!==void 0?a:null,prevBatch:(l=h.prev_batch)!==null&&l!==void 0?l:null}})()}getCrossSigningCacheCallbacks(){var e;return(e=this.crypto)===null||e===void 0?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return Dr(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case id.IS:return this.http.getUrl("/terms",void 0,ln.V2,t);case id.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return r&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=Lu(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(z.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,r,n,s,o,a){r&&(n.session=r);var l={auth:n,refresh_token:!0};return e!=null&&(l.username=e),t!=null&&(l.password=t),o!=null&&(l.guest_access_token=o),a!=null&&(l.inhibit_login=a),this.registerRequest(l)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var r={};return t&&(r.kind=t),this.http.request(z.Post,"/register",r,e)}refreshToken(e){var t=r=>this.http.authedRequest(z.Post,"/refresh",void 0,{refresh_token:e},{prefix:r,inhibitLogoutEmit:!0});return t(vt.V3).catch(r=>{if(r.errcode==="M_UNRECOGNIZED")return t(vt.V1);throw r})}loginFlows(){return this.http.request(z.Get,"/login")}login(e,t){return this.http.authedRequest(z.Post,"/login",void 0,Pt(Pt({},t),{},{type:e})).then(r=>(r.access_token&&r.user_id&&(this.http.opts.accessToken=r.access_token,this.credentials={userId:r.user_id}),r))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,s="/login/"+t+"/redirect";r&&(s+="/"+r);var o={redirectUrl:e,[SC.unstable]:n};return this.http.getUrl(s,o).href}loginWithToken(e){return this.login("m.login.token",{token:e})}logout(){var e=arguments,t=this;return S(function*(){var r,n=e.length>0&&e[0]!==void 0?e[0]:!1;if((r=t.crypto)!==null&&r!==void 0&&(r=r.backupManager)!==null&&r!==void 0&&r.getKeyBackupEnabled())try{for(;(yield t.crypto.backupManager.backupPendingKeys(200))>0;);}catch(s){t.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",s)}return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest(z.Post,"/logout")})()}deactivateAccount(e,t){var r={};return e&&(r.auth=e),t!==void 0&&(r.erase=t),this.http.authedRequest(z.Post,"/account/deactivate",void 0,r)}requestLoginToken(e){var t=this;return S(function*(){var r={auth:e};return t.http.authedRequest(z.Post,"/login/get_token",void 0,r,{prefix:vt.V1})})()}getFallbackAuthUrl(e,t){var r=me("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}createRoom(e){var t=this;return S(function*(){var r,n=(e.invite_3pid||[]).filter(a=>!a.id_access_token);if(n.length>0&&(r=t.identityServer)!==null&&r!==void 0&&r.getAccessToken){var s=yield t.identityServer.getAccessToken();if(s)for(var o of n)o.id_access_token=s}return t.http.authedRequest(z.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,r,n){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:Ue.Backward},o=s;et.hasServerSideFwdPaginationSupport===Lt.Experimental&&(o=ka("dir","org.matrix.msc3715.dir",o)),this.canSupport.get(dt.RelationsRecursion)===gt.Unstable&&(o=ka("recurse","org.matrix.msc3981.recurse",o));var a=gl(o),l="/rooms/$roomId/relations/$eventId";r!==null?(l+="/$relationType",n!==null&&(l+="/$eventType")):n!==null&&(this.logger.warn("eventType: ".concat(n,` ignored when fetching
            relations as relationType is null`)),n=null);var u=me(l+"?"+a,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return this.http.authedRequest(z.Get,u,void 0,void 0,{prefix:vt.V1})}roomState(e){var t=me("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(z.Get,t)}fetchRoomEvent(e,t){var r=me("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(z.Get,r)}members(e,t,r,n){var s={};t&&(s.membership=t),r&&(s.not_membership=r),n&&(s.at=n);var o=gl(s),a=me("/rooms/$roomId/members?"+o,{$roomId:e});return this.http.authedRequest(z.Get,a)}upgradeRoom(e,t){var r=me("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(z.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){var n={$roomId:e,$eventType:t,$stateKey:r},s=me("/rooms/$roomId/state/$eventType",n);return r!==void 0&&(s=me(s+"/$stateKey",n)),this.http.authedRequest(z.Get,s)}sendStateEvent(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{},o={$roomId:e,$eventType:t,$stateKey:n},a=me("/rooms/$roomId/state/$eventType",o);return n!==void 0&&(a=me(a+"/$stateKey",o)),this.http.authedRequest(z.Put,a,void 0,r,s)}roomInitialSync(e,t){var r,n=me("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(z.Get,n,{limit:(r=t==null?void 0:t.toString())!==null&&r!==void 0?r:"30"})}setRoomReadMarkersHttpRequest(e,t,r,n){var s=this;return S(function*(){var o=me("/rooms/$roomId/read_markers",{$roomId:e}),a={[Gt.FullyRead]:t,[Gt.Read]:r};return((yield s.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield s.isVersionSupported("v1.4")))&&(a[Gt.ReadPrivate]=n),s.http.authedRequest(z.Post,o,void 0,a)})()}getJoinedRooms(){var e=me("/joined_rooms",{});return this.http.authedRequest(z.Get,e)}getJoinedRoomMembers(e){var t=me("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(z.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:r,since:n}=e,s=qR(e,vC);if(Object.keys(s).length===0){var o={server:t,limit:r,since:n};return this.http.authedRequest(z.Get,"/publicRooms",o)}else{var a={server:t},l=Pt({limit:r,since:n},s);return this.http.authedRequest(z.Post,"/publicRooms",a,l)}}createAlias(e,t){var r=me("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(z.Put,r,void 0,n)}deleteAlias(e){var t=me("/directory/room/$alias",{$alias:e});return this.http.authedRequest(z.Delete,t)}getLocalAliases(e){var t=me("/rooms/$roomId/aliases",{$roomId:e}),r=vt.V3;return this.http.authedRequest(z.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){var t=me("/directory/room/$alias",{$alias:e});return this.http.authedRequest(z.Get,t)}getRoomDirectoryVisibility(e){var t=me("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(z.Get,t)}setRoomDirectoryVisibility(e,t){var r=me("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(z.Put,r,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:r}=e,n={search_term:t};return r!==void 0&&(n.limit=r),this.http.authedRequest(z.Post,"/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var r=t?me("/profile/$userId/$info",{$userId:e,$info:t}):me("/profile/$userId",{$userId:e});return this.http.authedRequest(z.Get,r)}getThreePids(){return this.http.authedRequest(z.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return S(function*(){var r="/account/3pid/add";return t.http.authedRequest(z.Post,r,void 0,e)})()}bindThreePid(e){var t=this;return S(function*(){var r="/account/3pid/bind";return t.http.authedRequest(z.Post,r,void 0,e)})()}unbindThreePid(e,t){var r=this;return S(function*(){var n="/account/3pid/unbind",s={medium:e,address:t,id_server:r.getIdentityServerUrl(!0)};return r.http.authedRequest(z.Post,n,void 0,s)})()}deleteThreePid(e,t){var r="/account/3pid/delete";return this.http.authedRequest(z.Post,r,void 0,{medium:e,address:t})}setPassword(e,t,r){var n="/account/password",s={auth:e,new_password:t,logout_devices:r};return this.http.authedRequest(z.Post,n,void 0,s)}getDevices(){return this.http.authedRequest(z.Get,"/devices")}getDevice(e){var t=me("/devices/$device_id",{$device_id:e});return this.http.authedRequest(z.Get,t)}setDeviceDetails(e,t){var r=me("/devices/$device_id",{$device_id:e});return this.http.authedRequest(z.Put,r,void 0,t)}deleteDevice(e,t){var r=me("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(z.Delete,r,void 0,n)}deleteMultipleDevices(e,t){var r={devices:e};t&&(r.auth=t);var n="/delete_devices";return this.http.authedRequest(z.Post,n,void 0,r)}getPushers(){var e=this;return S(function*(){var t=yield e.http.authedRequest(z.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(r=>(r.hasOwnProperty(Fc.name)||(r[Fc.name]=!0),r))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(z.Post,t,void 0,e)}removePusher(e,t){var r="/pushers/set",n={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(z.Post,r,void 0,n)}setLocalNotificationSettings(e,t){var r="".concat(ky.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(z.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Tr.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,n){var s=me("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(z.Put,s,void 0,n)}deletePushRule(e,t,r){var n=me("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(z.Delete,n)}setPushRuleEnabled(e,t,r,n){var s=me("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(z.Put,s,void 0,{enabled:n})}setPushRuleActions(e,t,r,n){var s=me("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(z.Put,s,void 0,{actions:n})}search(e,t){var{body:r,next_batch:n}=e,s={};return n&&(s.next_batch=n),this.http.authedRequest(z.Post,"/search",s,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(z.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(z.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r={device_keys:{}};return t!==void 0&&(r.token=t),e.forEach(n=>{r.device_keys[n]=[]}),this.http.authedRequest(z.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,n={};t===void 0&&(t="signed_curve25519");for(var[s,o]of e){var a=n[s]||{};Xr(n,s,a),Xr(a,o,t)}var l={one_time_keys:n};r&&(l.timeout=r);var u="/keys/claim";return this.http.authedRequest(z.Post,u,void 0,l)}getKeyChanges(e,t){var r={from:e,to:t};return this.http.authedRequest(z.Get,"/keys/changes",r)}uploadDeviceSigningKeys(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(z.Post,"/keys/device_signing/upload",void 0,r,{prefix:vt.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,ln.V2,this.idBaseUrl);return this.http.requestOtherUrl(z.Post,t,e)}requestEmailToken(e,t,r,n,s){var o={client_secret:t,email:e,send_attempt:r==null?void 0:r.toString()};return n&&(o.next_link=n),this.http.idServerRequest(z.Post,"/validate/email/requestToken",o,ln.V2,s)}requestMsisdnToken(e,t,r,n,s,o){var a={client_secret:r,country:e,phone_number:t,send_attempt:n==null?void 0:n.toString()};return s&&(a.next_link=s),this.http.idServerRequest(z.Post,"/validate/msisdn/requestToken",a,ln.V2,o)}submitMsisdnToken(e,t,r,n){var s={sid:e,client_secret:t,token:r};return this.http.idServerRequest(z.Post,"/validate/msisdn/submitToken",s,ln.V2,n??void 0)}submitMsisdnTokenOtherUrl(e,t,r,n){var s={sid:t,client_secret:r,token:n};return this.http.requestOtherUrl(z.Post,e,s)}getIdentityHashDetails(e){return this.http.idServerRequest(z.Get,"/hash_details",void 0,ln.V2,e)}identityHashedLookup(e,t){var r=this;return S(function*(){var n={},s=yield r.getIdentityHashDetails(t);if(!s||!s.lookup_pepper||!s.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=s.lookup_pepper;var o={};if(s.algorithms.includes("sha256")){var a=new global.Olm.Utility;n.addresses=e.map(g=>{var v=g[0].toLowerCase(),m=g[1].toLowerCase(),E=a.sha256("".concat(v," ").concat(m," ").concat(n.pepper)).replace(/\+/g,"-").replace(/\//g,"_");return o[E]=g[0],E}),n.algorithm="sha256"}else if(s.algorithms.includes("none"))n.addresses=e.map(g=>{var v=g[0].toLowerCase(),m=g[1].toLowerCase(),E="".concat(v," ").concat(m);return o[E]=g[0],E}),n.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var l=yield r.http.idServerRequest(z.Post,"/lookup",n,ln.V2,t);if(!(l!=null&&l.mappings))return[];var u=[];for(var c of Object.keys(l.mappings)){var d=l.mappings[c],h=o[c];if(!h)throw new Error("Identity server returned more results than expected");u.push({address:h,mxid:d})}return u})()}lookupThreePid(e,t,r){var n=this;return S(function*(){var s=yield n.identityHashedLookup([[t,e]],r),o=s.find(l=>l.address===t);if(!o)return{};var a={address:t,medium:e,mxid:o.mxid};return a})()}bulkLookupThreePids(e,t){var r=this;return S(function*(){var n=yield r.identityHashedLookup(e.map(l=>[l[1],l[0]]),t),s=[],o=function*(u){var c=e.find(d=>d[1]===u.address);if(!c)throw new Error("Identity sever returned unexpected results");s.push([c[0],u.address,u.mxid])};for(var a of n)yield*o(a);return{threepids:s}})()}getIdentityAccount(e){return this.http.idServerRequest(z.Get,"/account",void 0,ln.V2,e)}sendToDevice(e,t,r){var n=me("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),s={messages:Ui(t)},o=new Map;for(var[a,l]of t)o.set(a,Array.from(l.keys()));return this.logger.debug("PUT ".concat(n),o),this.http.authedRequest(z.Put,n,void 0,s)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(z.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var r=me("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(z.Get,r,t)}getThirdpartyUser(e,t){var r=me("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(z.Get,r,t)}getTerms(e,t){var r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(z.Get,r)}agreeToTerms(e,t,r,n){var s=this.termsUrlForService(e,t),o={Authorization:"Bearer "+r};return this.http.requestOtherUrl(z.Post,s,{user_accepts:n},{headers:o})}reportEvent(e,t,r,n){var s=me("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(z.Post,s,void 0,{score:r,reason:n})}getRoomHierarchy(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0,o=me("/rooms/$roomId/hierarchy",{$roomId:e}),a={suggested_only:String(n),max_depth:r==null?void 0:r.toString(),from:s,limit:t==null?void 0:t.toString()};return this.http.authedRequest(z.Get,o,a,void 0,{prefix:vt.V1}).catch(l=>{if(l.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(z.Get,o,a,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw l})}unstableCreateFileTree(e){var t=this;return S(function*(){var{room_id:r}=yield t.createRoom({name:e,preset:Th.PrivateChat,power_level_content_override:Pt(Pt({},J0),{},{users:{[t.getUserId()]:100}}),creation_content:{[Sl]:as.Space},initial_state:[{type:Lc.name,state_key:xc.name,content:{[Nc.name]:!0}},{type:F.RoomEncryption,state_key:"",content:{algorithm:nr}}]});return new Lg(t,r)})()}unstableGetFileTreeSpace(e){var t,r,n=this.getRoom(e);if((n==null?void 0:n.getMyMembership())!==Oe.Join)return null;var s=n.currentState.getStateEvents(F.RoomCreate,""),o=n.currentState.getStateEvents(Lc.name,xc.name);if(!s)throw new Error("Expected single room create event");return!(o!=null&&(t=o.getContent())!==null&&t!==void 0&&t[Nc.name])||((r=s.getContent())===null||r===void 0?void 0:r[Sl])!==as.Space?null:new Lg(this,e)}slidingSync(e,t,r){var n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);var s=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(z.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:s,abortSignal:r})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(dt.IntentionalMentions)!==gt.Unsupported}getRoomSummary(e,t){var r=this;return S(function*(){var n={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var s=me("/summary/$roomid",{$roomid:e});return yield r.http.authedRequest(z.Get,s,{via:t},void 0,n)}catch(a){if(a instanceof Qt&&a.errcode==="M_UNRECOGNIZED"){var o=me("/rooms/$roomid/summary",{$roomid:e});return yield r.http.authedRequest(z.Get,o,{via:t},void 0,n)}else throw a}})()}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return S(function*(){return e.http.authedRequest(z.Get,"/account/whoami")})()}timestampToEvent(e,t,r){var n=this;return S(function*(){var s=me("/rooms/$roomId/timestamp_to_event",{$roomId:e}),o={ts:t.toString(),dir:r};try{return yield n.http.authedRequest(z.Get,s,o,void 0,{prefix:vt.V1})}catch(a){if(a.errcode==="M_UNRECOGNIZED"&&(a.httpStatus===400||a.httpStatus===404||a.httpStatus===405))return yield n.http.authedRequest(z.Get,s,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw a}})()}getAuthIssuer(){var e=this;return S(function*(){return e.http.request(z.Get,"/auth_issuer",void 0,void 0,{prefix:vt.Unstable+"/org.matrix.msc2965"})})()}}f(si,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function jS(i,e){var t,r=i.getUserId(),n=e.getId(),s=i.getRoom(e.getRoomId());if(!(!s||!r||!n)){if(!s.findEventById(n)){p.info("Decrypted event ".concat(e.getId()," is not in room ").concat(s.roomId,": ignoring"));return}var o=!!e.threadRootId&&!e.isThreadRoot,a;if(o){var l=s.getThread(e.threadRootId);a=l?l.hasUserReadEvent(r,n):!0}else a=s.hasUserReadEvent(r,n);if(!a){var u=i.getPushActionsForEvent(e,!0),c=!!(u!=null&&(t=u.tweaks)!==null&&t!==void 0&&t.highlight);if(c){var d=s.getUnreadCountForEventContext(Ve.Highlight,e)+1;o?s.setThreadUnreadNotificationCount(e.threadRootId,Ve.Highlight,d):s.setUnreadNotificationCount(Ve.Highlight,d)}var h=!!(u!=null&&u.notify);if(h){var g=s.getUnreadCountForEventContext(Ve.Total,e)+1;o?s.setThreadUnreadNotificationCount(e.threadRootId,Ve.Total,g):s.setUnreadNotificationCount(Ve.Total,g)}}}}function Cs(i){return la(i)?ya:i.threadRootId}function la(i){if(!i.threadRootId||i.isThreadRoot)return!0;if(!i.isRelation())return p.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(i.getId())),!0;if(i.isRelation(Je.name))return!1;var e=i.relationEventId===i.threadRootId;return e}function $g(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function zg(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$g(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):$g(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Ht=function(i){return i.New="Thread.new",i.Update="Thread.update",i.NewReply="Thread.newReply",i.ViewThread="Thread.viewThread",i.Delete="Thread.delete",i}({}),Lt=function(i){return i[i.None=0]="None",i[i.Experimental=1]="Experimental",i[i.Stable=2]="Stable",i}({});function nl(i,e){return i?Lt.Stable:e?Lt.Experimental:Lt.None}class et extends Gy{constructor(e,t,r){var n,s;if(super(),n=this,this.id=e,this.rootEvent=t,f(this,"timelineSet",void 0),f(this,"_currentUserParticipated",!1),f(this,"reEmitter",void 0),f(this,"lastEvent",void 0),f(this,"replyCount",0),f(this,"lastPendingEvent",void 0),f(this,"pendingReplyCount",0),f(this,"room",void 0),f(this,"client",void 0),f(this,"pendingEventOrdering",void 0),f(this,"processRootEventPromise",void 0),f(this,"initialEventsFetched",!et.hasServerSideSupport),f(this,"initalEventFetchProm",void 0),f(this,"replayEvents",[]),f(this,"onTimelineReset",S(function*(){yield n.processRootEventPromise,n.processRootEventPromise=void 0})),f(this,"onBeforeRedaction",(o,a)=>{o!=null&&o.isRelation(Je.name)&&this.room.eventShouldLiveIn(o).threadId===this.id&&o.getId()!==this.id&&!a.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(Ht.Update,this))}),f(this,"onRedaction",function(){var o=S(function*(a,l,u){if(u===n.id)if(n.replyCount<=0){for(var c of n.timeline)n.clearEventMetadata(c);n.lastEvent=n.rootEvent,n._currentUserParticipated=!1,n.emit(Ht.Delete,n)}else{var d;((d=n.lastEvent)===null||d===void 0?void 0:d.getId())===a.getAssociatedId()&&(yield n.processRootEventPromise,n.processRootEventPromise=void 0),yield n.updateThreadMetadata()}});return function(a,l,u){return o.apply(this,arguments)}}()),f(this,"onTimelineEvent",(o,a,l)=>{if(!l){var u=o.getSender();u&&a&&this.shouldSendLocalEchoReceipt(u,o)&&a.addLocalEchoReceipt(u,o,Gt.Read),o.getId()!==this.id&&o.isRelation(Je.name)&&this.replyCount++}this.onEcho(o,l??!1)}),f(this,"onLocalEcho",o=>{this.onEcho(o,!1)}),f(this,"onEcho",function(){var o=S(function*(a,l){a.threadRootId===n.id&&n.lastEvent!==a&&(yield n.updateThreadMetadata(),a.isRelation(Je.name)&&(l||(n.lastEvent=void 0,n.emit(Ht.NewReply,n,a))))});return function(a,l){return o.apply(this,arguments)}}()),this.setMaxListeners(1e3),!(r!=null&&r.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=r.room,this.client=r.client,this.pendingEventOrdering=(s=r.pendingEventOrdering)!==null&&s!==void 0?s:Is.Chronological,this.timelineSet=new ns(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new Ms(this),this.reEmitter.reEmit(this.timelineSet,[ye.Timeline,ye.TimelineReset]),this.room.on(Fe.BeforeRedaction,this.onBeforeRedaction),this.room.on(ye.Redaction,this.onRedaction),this.room.on(ye.LocalEchoUpdated,this.onLocalEcho),this.room.on(ye.TimelineReset,this.onTimelineReset),this.timelineSet.on(ye.Timeline,this.onTimelineEvent),this.processReceipts(r.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return S(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),r=e.client.getEventMapper();e.rootEvent=r(t)}catch(n){p.error("Failed to fetch thread root to construct thread with",n)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){et.hasServerSideSupport=e,e!==Lt.Stable&&(vs.setPreferUnstable(!0),gs.setPreferUnstable(!0),Je.setPreferUnstable(!0))}static setServerSideListSupport(e){et.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){et.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var r,n=(r=this.client.canSupport.get(dt.RelationsRecursion))!==null&&r!==void 0?r:gt.Unsupported;if(n===gt.Unsupported){var s,o=(s=this.getReadReceiptForUserId(e))===null||s===void 0?void 0:s.eventId;if(o){var a=this.findEventById(o);if(a&&a.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(ve.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState))}addEvents(e,t){e.forEach(r=>this.addEvent(r,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var n=this.lastReply(),s=!n||e.localTimestamp>=n.localTimestamp;if(!et.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(lt.Annotation)||e.isRelation(lt.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&s?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(Je.name)&&!t&&s&&(this.lastEvent=void 0),r&&(this.emit(Ht.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var r,n;if(this.initialEventsFetched){var o,a=(o=this.client.canSupport.get(dt.RelationsRecursion))!==null&&o!==void 0?o:gt.Unsupported;a===gt.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var s;(s=this.replayEvents)===null||s===void 0||s.push(e)}(r=this.timelineSet.relations)===null||r===void 0||r.aggregateParentEvent(e),(n=this.timelineSet.relations)===null||n===void 0||n.aggregateChildEvent(e,this.timelineSet)}processEvent(e){var t=this;return S(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:r,userId:n,receipt:s,synthetic:o}of e)this.addReceiptToStructure(t,r,n,s,o)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e==null?void 0:e.getServerAggregatedRelation(Je.name)}processRootEvent(){var e=this;return S(function*(){var t=e.getRootEventBundledRelationship();if(et.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var r=e.client.getEventMapper();e.lastEvent=r(zg(zg({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===Is.Detached?this.room.getPendingEvents():this.events,t=e.filter(r=>{var n;return r.threadRootId===this.id&&r.isRelation(Je.name)&&r.status!==null&&r.getId()!==((n=this.lastEvent)===null||n===void 0?void 0:n.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var r=this;return S(function*(){var n=r.liveTimeline;r.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var s=r.liveTimeline,o,a;if(e){var l=yield r.client.createMessagesRequest(r.roomId,e,1,Ue.Forward);o=l.end}if(t){var u=yield r.client.createMessagesRequest(r.roomId,t,1,Ue.Backward);a=u.start}if(t&&n.getPaginationToken(Ue.Forward)===t){var c;n.setPaginationToken((c=a)!==null&&c!==void 0?c:null,Ue.Forward)}if(e&&s.getPaginationToken(Ue.Backward)===e){var d;s.setPaginationToken((d=o)!==null&&d!==void 0?d:null,Ue.Backward)}})()}updateThreadFromRootEvent(){var e=this;return S(function*(){et.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return S(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,Ue.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(ye.TimelineReset,e.room,e.timelineSet,!0)}catch(r){p.error("Failed to load start of newly created thread: ",r),e.initialEventsFetched=!1}e.emit(Ht.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return S(function*(){var r,n=(r=t.client.canSupport.get(dt.RelationsRecursion))!==null&&r!==void 0?r:gt.Unsupported;if(n===gt.Unsupported){for(var s=e.length,o=new Array(s),a=0;a<s;a++)o[a]=e[a];return Promise.all(o.filter(_C).map(function(){var l=S(function*(u){try{var c=yield t.client.relations(t.roomId,u.getId(),lt.Replace,u.getType(),{limit:1});if(c.events.length){var d=c.events[0];u.makeReplaced(d),t.insertEventIntoTimeline(d)}}catch(h){p.error("Failed to load edits for encrypted thread event",h)}});return function(u){return l.apply(this,arguments)}}()))}})()}setEventMetadata(e){e&&(ve.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[Je.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:n=>n.isRelation(Je.name),t=this.timeline.length-1;t>=0;t--){var r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof Ot}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){var s=n.getTs()<this.room.getOldestThreadedReceiptTs(),o=n.getId();if(s&&o)return o}var a=super.getEventReadUpTo(e,t);if(n){var l=this.room.getLastUnthreadedReceiptFor(e);if(!l)return a;for(var u=((c=this.timeline)===null||c===void 0?void 0:c.length)-1;u>=0;--u){var c,d,h=this.timeline[u];if(h.getId()===a)return a;if(h.getTs()<l.ts)return(d=h.getId())!==null&&d!==void 0?d:a}}return a}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,s,o,a,l,u=((r=(n=this.lastReply())===null||n===void 0?void 0:n.getTs())!==null&&r!==void 0?r:0)<this.room.getOldestThreadedReceiptTs(),c=(s=(o=this.room.getLastUnthreadedReceiptFor(e))===null||o===void 0?void 0:o.ts)!==null&&s!==void 0?s:0,d=((a=this===null||this===void 0||(l=this.lastReply())===null||l===void 0?void 0:l.getTs())!==null&&a!==void 0?a:0)<c;if(u||d)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}f(et,"hasServerSideSupport",Lt.None);f(et,"hasServerSideListSupport",Lt.None);f(et,"hasServerSideFwdPaginationSupport",Lt.None);function _C(i){return i.isEncrypted()&&(i.isRelation(Je.name)||i.isThreadRoot)}var vs=new zl("related_by_senders","io.element.relation_senders"),gs=new zl("related_by_rel_types","io.element.relation_types"),Je=new zl("m.thread","io.element.thread"),Rr=function(i){return i[i.My=0]="My",i[i.All=1]="All",i}({});function qS(i){switch(i){case Rr.My:return"participated";default:return"all"}}var Jg=Object.freeze({visible:!0}),Fe=function(i){return i.Decrypted="Event.decrypted",i.BeforeRedaction="Event.beforeRedaction",i.VisibilityChange="Event.visibilityChange",i.LocalEventIdReplaced="Event.localEventIdReplaced",i.Status="Event.status",i.Replaced="Event.replaced",i.RelationsCreated="Event.relationsCreated",i}({});class Ot extends rt{constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,f(this,"pushDetails",{}),f(this,"_replacingEvent",null),f(this,"_localRedactionEvent",null),f(this,"_isCancelled",!1),f(this,"clearEvent",void 0),f(this,"visibility",Jg),f(this,"_hasCachedExtEv",!1),f(this,"_cachedExtEv",void 0),f(this,"_decryptionFailureReason",null),f(this,"senderCurve25519Key",null),f(this,"claimedEd25519Key",null),f(this,"forwardingCurve25519KeyChain",[]),f(this,"untrusted",null),f(this,"decryptionPromise",null),f(this,"retryDecryption",!1),f(this,"txnId",void 0),f(this,"thread",void 0),f(this,"threadId",void 0),f(this,"encryptedDisabledForUnverifiedDevices",!1),f(this,"localTimestamp",void 0),f(this,"sender",null),f(this,"target",null),f(this,"status",null),f(this,"error",null),f(this,"forwardLooking",!0),f(this,"verificationRequest",void 0),f(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(n=>{typeof t[n]=="string"&&(t[n]=Uu(t[n]))}),["membership","avatar_url","displayname"].forEach(n=>{var s;typeof((s=t.content)===null||s===void 0?void 0:s[n])=="string"&&(t.content[n]=Uu(t.content[n]))}),["rel_type"].forEach(n=>{var s;typeof((s=t.content)===null||s===void 0||(s=s["m.relates_to"])===null||s===void 0?void 0:s[n])=="string"&&(t.content["m.relates_to"][n]=Uu(t.content["m.relates_to"][n]))}),this.txnId=t.txn_id;var r=this.getAge();this.localTimestamp=r!==void 0?Date.now()-r:(e=this.getTs())!==null&&e!==void 0?e:Date.now(),this.reEmitter=new Ms(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=sr.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===F.RoomMessageEncrypted)for(var[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var r=this.getContent()[Zt];return"msgid=".concat(r," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if((t==null?void 0:t.rel_type)===Je.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var r=this.getUnsigned();if(typeof r[_l.name]=="string")return r[_l.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(Je.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return Oy.findIn(e)}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.isDecryptionFailure()&&this.encryptedDisabledForUnverifiedDevices}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(!r.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var s=r.clearEvent&&!r.isDecryptionFailure(),o=n.forceRedecryptIfUntrusted&&r.isKeySourceUntrusted();if(s&&!o)throw new Error("Attempt to decrypt event which has already been decrypted");return r.decryptionPromise?(p.log("Event ".concat(r.getId()," already being decrypted; queueing a retry")),r.retryDecryption=!0,r.decryptionPromise):(r.decryptionPromise=r.decryptionLoop(e,n),r.decryptionPromise)})()}cancelAndResendKeyRequest(e,t){var r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){r.retryDecryption=!1;var s=void 0;try{var o=yield e.decryptEvent(r);n.isRetry===!0&&p.info("Decrypted event on retry (".concat(r.getDetails(),")")),r.setClearData(o),r._decryptionFailureReason=null}catch(l){var a=l instanceof wt?l.detailedString:String(l);if(s=l,r.retryDecryption){p.log("Error decrypting event (".concat(r.getDetails(),"), but retrying: ").concat(a));continue}p.warn("Error decrypting event (".concat(r.getDetails(),"): ").concat(a)),r.setClearDataForDecryptionFailure(String(l)),r._decryptionFailureReason=l instanceof wt?l.code:bt.UNKNOWN_ERROR}r.decryptionPromise=null,r.retryDecryption=!1,r.setPushDetails(),n.emit!==!1&&r.emit(Fe.Decrypted,r,s);return}})()}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(r=e.claimedEd25519Key)!==null&&r!==void 0?r:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.encryptedDisabledForUnverifiedDevices=!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:F.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.encryptedDisabledForUnverifiedDevices=e==="DecryptionError: ".concat(ia["m.unverified"]),this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===F.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(Fe.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r,n=(t=e==null?void 0:e.visible)!==null&&t!==void 0?t:!0,s=(r=e==null?void 0:e.reason)!==null&&r!==void 0?r:null,o=!1;(this.visibility.visible!==n||!this.visibility.visible&&this.visibility.reason!==s)&&(o=!0),o&&(n?this.visibility=Jg:this.visibility=Object.freeze({visible:!1,reason:s}),this.emit(Fe.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(Fe.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var r in this.event)this.event.hasOwnProperty(r)&&!bC.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=void 0);var n=this.getType()in Yg?Yg[this.getType()]:{},s=this.getContent();for(var o in s)s.hasOwnProperty(o)&&!n[o]&&delete s[o];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var r of t.events){var n;((n=r.getRelation())===null||n===void 0?void 0:n.event_id)===this.getId()&&r.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(ve.FORWARDS))}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===F.RoomRedaction}asVisibilityChange(){if(!Oi.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var r=this.getWireContent(),n=!!r.visible,s=r.reason;return s&&typeof s!="string"?null:{visible:n,reason:s,eventId:t}}isVisibilityEvent(){return Oi.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var r,n;return(r=(n=this.clearEvent)===null||n===void 0?void 0:n.unsigned.redacted_because)!==null&&r!==void 0?r:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t=this.getUnsigned(),r=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit(Fe.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(Fe.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(Fe.LocalEventIdReplaced,this)}isRelation(e){var t,r=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(r!=null&&r.rel_type)&&[lt.Replace,lt.Thread].includes(r.rel_type)?!1:!!(r!=null&&r.rel_type&&r.event_id&&(!e||r.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(Fe.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(lt.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(lt.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var r;return(r=this._replacingEvent.getDate())!==null&&r!==void 0?r:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new Ot(JSON.parse(JSON.stringify(this.event)));for(var[t,r]of Object.entries(this))t!=="event"&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=kc(this.event),r=kc(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[Ht.Update]),this.thread=e,this.setThreadId(e==null?void 0:e.id),e&&this.reEmitter.reEmit(e,[Ht.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}var bC=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),Yg={[F.RoomMember]:{membership:1},[F.RoomJoinRules]:{join_rule:1},[F.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},ur=function(i){return i[i.NotStarted=0]="NotStarted",i[i.InProgress=1]="InProgress",i[i.Finished=2]="Finished",i}(ur||{}),Ae=function(i){return i.Events="RoomState.events",i.Members="RoomState.members",i.NewMember="RoomState.newMember",i.Update="RoomState.update",i.BeaconLiveness="RoomState.BeaconLiveness",i.Marker="RoomState.Marker",i}({});class ua extends rt{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:ur.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,f(this,"reEmitter",new Ms(this)),f(this,"sentinels",{}),f(this,"displayNameToUserIds",new Map),f(this,"userIdsToDisplayNames",{}),f(this,"tokenToInvite",{}),f(this,"joinedMemberCount",null),f(this,"summaryJoinedMemberCount",null),f(this,"invitedMemberCount",null),f(this,"summaryInvitedMemberCount",null),f(this,"modified",-1),f(this,"members",{}),f(this,"events",new Map),f(this,"paginationToken",null),f(this,"beacons",new Map),f(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Oe.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Oe.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new bl(this.roomId,e);var r=this.members[e];r!=null&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var r=this.events.get(e).get(t);return r||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new ua(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=ur.NotStarted,Array.from(this.events.values()).forEach(r=>{e.setStateEvents(Array.from(r.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==ur.Finished&&this.getMembers().forEach(r=>{if(r.isOutOfBand()){var n;(n=e.getMember(r.userId))===null||n===void 0||n.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(r=>!this.events.has(r.getType())||!this.events.get(r.getType()).has(r.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(r=>{if(!(r.getRoomId()!==this.roomId||!r.isState())){ah.matches(r.getType())&&this.setBeacon(r);var n=this.getStateEventMatching(r);if(this.setStateEvent(r),r.getType()===F.RoomMember){var s;this.updateDisplayNameCache(r.getStateKey(),(s=r.getContent().displayname)!==null&&s!==void 0?s:""),this.updateThirdPartyTokenCache(r)}this.emit(Ae.Events,r,this,n)}}),this.onBeaconLivenessChange(),e.forEach(r=>{if(!(r.getRoomId()!==this.roomId||!r.isState()))if(r.getType()===F.RoomMember){var n=r.getStateKey();(r.getContent().membership===Oe.Leave||r.getContent().membership===Oe.Ban)&&(r.getContent().avatar_url=r.getContent().avatar_url||r.getPrevContent().avatar_url,r.getContent().displayname=r.getContent().displayname||r.getPrevContent().displayname);var s=this.getOrCreateMember(n,r);s.setMembershipEvent(r,this),this.updateMember(s),this.emit(Ae.Members,r,this,s)}else if(r.getType()===F.RoomPowerLevels){if(r.getStateKey()!=="")return;var o=Object.values(this.members);o.forEach(a=>{var l=a.getLastModifiedTime();a.setPowerLevelEvent(r),l!==a.getLastModifiedTime()&&this.emit(Ae.Members,r,this,a)}),this.sentinels={}}else Iy.matches(r.getType())&&this.emit(Ae.Marker,r,t)}),this.emit(Ae.Update,this)}processBeaconEvents(e,t){var r=this;return S(function*(){if(!(!e.length||!r.beacons.size)){var n=[...r.beacons.values()].reduce((u,c)=>(u[c.beaconInfoId]=c,u),{}),s=(u,c)=>{if(Uc.matches(c.getType())){var d=n[u];d&&d.addLocations([c])}},o=function*(c){var d,h=(d=c.getRelation())===null||d===void 0?void 0:d.event_id;if(!h||!n[h])return{v:void 0};if(!Uc.matches(c.getType())&&!c.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(c),s(h,c)}catch{c.isDecryptionFailure()&&c.once(Fe.Decrypted,S(function*(){s(h,c)}))}},a;for(var l of e)if(a=yield*o(l),a)return a.v}})()}getOrCreateMember(e,t){var r=this.members[e];return r||(r=new bl(this.roomId,e),this.members[e]=r,this.emit(Ae.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=El(e);if(this.beacons.has(t)){var r=this.beacons.get(t);if(e.isRedacted()){var n;r.beaconInfoId===((n=e.getRedactionEvent())===null||n===void 0?void 0:n.redacts)&&(r.destroy(),this.beacons.delete(t));return}return r.update(e)}if(!e.isRedacted()){var s=new Vy(e);this.reEmitter.reEmit(s,[tt.New,tt.Update,tt.Destroy,tt.LivenessChange]),this.emit(tt.New,e,s),s.on(tt.LivenessChange,this.onBeaconLivenessChange.bind(this)),s.on(tt.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(s.identifier,s)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(Ae.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return(t=(r=this.events.get(e.getType()))===null||r===void 0?void 0:r.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(F.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===ur.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===ur.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===ur.NotStarted&&(this.oobMemberFlags.status=ur.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===ur.InProgress&&(this.oobMemberFlags.status=ur.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var r=this.members[t];r.isOutOfBand()&&(++e,delete this.members[t])}),p.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=ur.NotStarted}setOutOfBandMembers(e){p.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===ur.InProgress&&(p.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=ur.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(Ae.Update,this))}setOutOfBandMember(e){if(e.getType()===F.RoomMember){var t=e.getStateKey(),r=this.getMember(t);if(!(r&&!r.isOutOfBand())){var n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(Ae.Members,e,this,n)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(Di(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var r=this.getMember(t);if(!r||r.membership===Oe.Leave||e.status||e.isRedacted())return!1;var n=this.maySendEvent(F.RoomRedaction,t);return n?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",r.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var r=this.getStateEvents(F.RoomPowerLevels,""),n={};r&&(n=r.getContent());var s=50;return fv(n[e])&&(s=n[e]),t>=s}maySendMessage(e){return this.maySendEventOfType(F.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){var n=this.getStateEvents(F.RoomPowerLevels,""),s,o={},a=0,l=0,u=0;if(n){s=n.getContent(),o=s.events||{},Number.isSafeInteger(s.state_default)?a=s.state_default:a=50;var c=s.users&&s.users[t];Number.isSafeInteger(c)?u=c:Number.isSafeInteger(s.users_default)&&(u=s.users_default),Number.isSafeInteger(s.events_default)&&(l=s.events_default)}var d=r?a:l;return Number.isSafeInteger(o[e])&&(d=o[e]),u>=d}mayTriggerNotifOfType(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents(F.RoomPowerLevels,""),s=50;return n&&n.getContent()&&n.getContent().notifications&&fv(n.getContent().notifications[e])&&(s=n.getContent().notifications[e]),r.powerLevel>=s}getJoinRule(){var e,t=this.getStateEvents(F.RoomJoinRules,""),r=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return r.join_rule||DS.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(F.RoomHistoryVisibility,""),r=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return r.history_visibility||Ih.Shared}getGuestAccess(){var e,t=this.getStateEvents(F.RoomGuestAccess,""),r=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return r.guest_access||kl.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(F.RoomPredecessor,"");if(t){var r=t.getContent(),n=r.predecessor_room_id,s=r.last_known_event_id;typeof s!="string"&&(s=void 0);var o=r.via_servers;if(Array.isArray(o)||(o=void 0),typeof n=="string")return{roomId:n,eventId:s,viaServers:o}}}var a=this.getStateEvents(F.RoomCreate,"");if(a){var l=a.getContent().predecessor;if(l){var u=l.room_id;if(typeof u=="string"){var c=l.event_id;return(typeof c!="string"||c==="")&&(c=void 0),{roomId:u,eventId:c}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var r=this.getStateEvents(F.RoomThirdPartyInvite,t);r&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){var n=Di(r),s=this.displayNameToUserIds.get(n);if(s){var o=s.filter(c=>c!==e);this.displayNameToUserIds.set(n,o)}}this.userIdsToDisplayNames[e]=t;var a=t&&Di(t);if(a){var l,u=(l=this.displayNameToUserIds.get(a))!==null&&l!==void 0?l:[];u.push(e),this.displayNameToUserIds.set(a,u)}}}function Qg(i){var e=typeof i=="string"&&!!i&&i!=="undefined"&&i!=="null";return e||typeof i=="number"}class Ch{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};f(this,"rooms",{}),f(this,"users",{}),f(this,"syncToken",null),f(this,"filters",new ht(()=>new Map)),f(this,"accountData",new Map),f(this,"localStorage",void 0),f(this,"oobMembers",new Map),f(this,"pendingEvents",{}),f(this,"clientOptions",void 0),f(this,"pendingToDeviceBatches",[]),f(this,"nextToDeviceBatchId",0),f(this,"createUser",void 0),f(this,"onRoomMember",(t,r,n)=>{var s;if(n.membership!==Oe.Invite){var o=this.users[n.userId]||((s=this.createUser)===null||s===void 0?void 0:s.call(this,n.userId));n.name&&(o.setDisplayName(n.name),n.events.member&&o.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&o.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[o.userId]=o}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(Ae.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(Ae.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return((r=this.filters.get(e))===null||r===void 0?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var r=this.localStorage.getItem(t);if(Qg(r))return r}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{Qg(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var r=!Object.keys(t.getContent()).length;r?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new ht(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return S(function*(){var r;return(r=t.pendingEvents[e])!==null&&r!==void 0?r:[]})()}setPendingEvents(e,t){var r=this;return S(function*(){r.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return S(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return S(function*(){})()}}var oc={},yi={},Ji={},Xg;function kh(){if(Xg)return Ji;Xg=1,Object.defineProperty(Ji,"__esModule",{value:!0}),Ji.WidgetApiDirection=void 0,Ji.invertedDirection=e;var i=function(t){return t.ToWidget="toWidget",t.FromWidget="fromWidget",t}({});Ji.WidgetApiDirection=i;function e(t){if(t===i.ToWidget)return i.FromWidget;if(t===i.FromWidget)return i.ToWidget;throw new Error("Invalid direction")}return Ji}var on={},Zg;function Oh(){if(Zg)return on;Zg=1,Object.defineProperty(on,"__esModule",{value:!0}),on.UnstableApiVersion=on.MatrixApiVersion=on.CurrentApiVersions=void 0;var i=function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r}({});on.MatrixApiVersion=i;var e=function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",r.MSC2871="org.matrix.msc2871",r.MSC2873="org.matrix.msc2873",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r}({});on.UnstableApiVersion=e;var t=[i.Prerelease1,i.Prerelease2,e.MSC2762,e.MSC2762_UPDATE_STATE,e.MSC2871,e.MSC2873,e.MSC2931,e.MSC2974,e.MSC2876,e.MSC3819,e.MSC3846,e.MSC3869,e.MSC3973,e.MSC4039];return on.CurrentApiVersions=t,on}var no={},ep;function Ph(){if(ep)return no;ep=1,Object.defineProperty(no,"__esModule",{value:!0}),no.PostmessageTransport=void 0;var i=Xl(),e=au(),t=["message"];function r(y){"@babel/helpers - typeof";return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},r(y)}function n(y,C){if(y==null)return{};var w=s(y,C),D,x;if(Object.getOwnPropertySymbols){var G=Object.getOwnPropertySymbols(y);for(x=0;x<G.length;x++)D=G[x],!(C.indexOf(D)>=0)&&Object.prototype.propertyIsEnumerable.call(y,D)&&(w[D]=y[D])}return w}function s(y,C){if(y==null)return{};var w={},D=Object.keys(y),x,G;for(G=0;G<D.length;G++)x=D[G],!(C.indexOf(x)>=0)&&(w[x]=y[x]);return w}function o(y,C){var w=Object.keys(y);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(y);C&&(D=D.filter(function(x){return Object.getOwnPropertyDescriptor(y,x).enumerable})),w.push.apply(w,D)}return w}function a(y){for(var C=1;C<arguments.length;C++){var w=arguments[C]!=null?arguments[C]:{};C%2?o(Object(w),!0).forEach(function(D){_(y,D,w[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(w)):o(Object(w)).forEach(function(D){Object.defineProperty(y,D,Object.getOwnPropertyDescriptor(w,D))})}return y}function l(y,C){if(!(y instanceof C))throw new TypeError("Cannot call a class as a function")}function u(y,C){for(var w=0;w<C.length;w++){var D=C[w];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(y,T(D.key),D)}}function c(y,C,w){return C&&u(y.prototype,C),Object.defineProperty(y,"prototype",{writable:!1}),y}function d(y,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");y.prototype=Object.create(C&&C.prototype,{constructor:{value:y,writable:!0,configurable:!0}}),Object.defineProperty(y,"prototype",{writable:!1}),C&&h(y,C)}function h(y,C){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(D,x){return D.__proto__=x,D},h(y,C)}function g(y){var C=E();return function(){var D=R(y),x;if(C){var G=R(this).constructor;x=Reflect.construct(D,arguments,G)}else x=D.apply(this,arguments);return v(this,x)}}function v(y,C){if(C&&(r(C)==="object"||typeof C=="function"))return C;if(C!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return m(y)}function m(y){if(y===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return y}function E(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function R(y){return R=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(w){return w.__proto__||Object.getPrototypeOf(w)},R(y)}function _(y,C,w){return C=T(C),C in y?Object.defineProperty(y,C,{value:w,enumerable:!0,configurable:!0,writable:!0}):y[C]=w,y}function T(y){var C=b(y,"string");return r(C)==="symbol"?C:String(C)}function b(y,C){if(r(y)!=="object"||y===null)return y;var w=y[Symbol.toPrimitive];if(w!==void 0){var D=w.call(y,C);if(r(D)!=="object")return D;throw new TypeError("@@toPrimitive must return a primitive value.")}return(C==="string"?String:Number)(y)}var I=function(y){d(w,y);var C=g(w);function w(D,x,G,oe){var de;return l(this,w),de=C.call(this),de.sendDirection=D,de.initialWidgetId=x,de.transportWindow=G,de.inboundWindow=oe,_(m(de),"strictOriginCheck",!1),_(m(de),"targetOrigin","*"),_(m(de),"timeoutSeconds",10),_(m(de),"_ready",!1),_(m(de),"_widgetId",null),_(m(de),"outboundRequests",new Map),_(m(de),"stopController",new AbortController),de._widgetId=x,de}return c(w,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var x="widgetapi-".concat(Date.now()),G=0,oe=x;this.outboundRequests.has(oe);)oe="".concat(x,"-").concat(G++);return this.outboundRequests.set(oe,null),oe}},{key:"sendInternal",value:function(x){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),x),this.transportWindow.postMessage(x,this.targetOrigin)}},{key:"reply",value:function(x,G){return this.sendInternal(a(a({},x),{},{response:G}))}},{key:"send",value:function(x,G){return this.sendComplete(x,G).then(function(oe){return oe.response})}},{key:"sendComplete",value:function(x,G){var oe=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var de={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:x,data:G};return x===e.WidgetApiToWidgetAction.UpdateVisibility&&(de.visible=G.visible),new Promise(function(Ee,X){var re=function(Q){we(),Ee(Q)},Z=function(Q){we(),X(Q)},ne=setTimeout(function(){return Z(new Error("Request timed out"))},(oe.timeoutSeconds||1)*1e3),ce=function(){return Z(new Error("Transport stopped"))};oe.stopController.signal.addEventListener("abort",ce);var we=function(){oe.outboundRequests.delete(de.requestId),clearTimeout(ne),oe.stopController.signal.removeEventListener("abort",ce)};oe.outboundRequests.set(de.requestId,{request:de,resolve:re,reject:Z}),oe.sendInternal(de)})}},{key:"start",value:function(){var x=this;this.inboundWindow.addEventListener("message",function(G){x.handleMessage(G)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(x){if(!this.stopController.signal.aborted&&x.data&&!(this.strictOriginCheck&&x.origin!==window.origin)){var G=x.data;if(!(!G.action||!G.requestId||!G.widgetId))if(G.response){if(G.api!==this.sendDirection)return;this.handleResponse(G)}else{var oe=G;if(oe.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(oe)}}}},{key:"handleRequest",value:function(x){if(this.widgetId){if(this.widgetId!==x.widgetId)return}else this._widgetId=x.widgetId;this.emit("message",new CustomEvent("message",{detail:x}))}},{key:"handleResponse",value:function(x){if(x.widgetId===this.widgetId){var G=this.outboundRequests.get(x.requestId);if(G)if((0,e.isErrorResponse)(x.response)){var oe=x.response.error,de=oe.message,Ee=n(oe,t);G.reject(new e.WidgetApiResponseError(de,Ee))}else G.resolve(x)}}}]),w}(i.EventEmitter);return no.PostmessageTransport=I,no}var Si={},tp;function Mh(){if(tp)return Si;tp=1,Object.defineProperty(Si,"__esModule",{value:!0}),Si.WidgetApiToWidgetAction=Si.WidgetApiFromWidgetAction=void 0;var i=function(t){return t.SupportedApiVersions="supported_api_versions",t.Capabilities="capabilities",t.NotifyCapabilities="notify_capabilities",t.ThemeChange="theme_change",t.LanguageChange="language_change",t.TakeScreenshot="screenshot",t.UpdateVisibility="visibility",t.OpenIDCredentials="openid_credentials",t.WidgetConfig="widget_config",t.CloseModalWidget="close_modal",t.ButtonClicked="button_clicked",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.UpdateState="update_state",t.UpdateTurnServers="update_turn_servers",t}({});Si.WidgetApiToWidgetAction=i;var e=function(t){return t.SupportedApiVersions="supported_api_versions",t.ContentLoaded="content_loaded",t.SendSticker="m.sticker",t.UpdateAlwaysOnScreen="set_always_on_screen",t.GetOpenIDCredentials="get_openid",t.CloseModalWidget="close_modal",t.OpenModalWidget="open_modal",t.SetModalButtonEnabled="set_button_enabled",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.WatchTurnServers="watch_turn_servers",t.UnwatchTurnServers="unwatch_turn_servers",t.BeeperReadRoomAccountData="com.beeper.read_room_account_data",t.MSC2876ReadEvents="org.matrix.msc2876.read_events",t.MSC2931Navigate="org.matrix.msc2931.navigate",t.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",t.MSC3869ReadRelations="org.matrix.msc3869.read_relations",t.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",t.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",t.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",t.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",t.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",t}({});return Si.WidgetApiFromWidgetAction=e,Si}var io={},rp;function Ah(){if(rp)return io;rp=1,Object.defineProperty(io,"__esModule",{value:!0}),io.OpenIDRequestState=void 0;var i=function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e}({});return io.OpenIDRequestState=i,io}var so={},np;function VS(){if(np)return so;np=1,Object.defineProperty(so,"__esModule",{value:!0}),so.MatrixWidgetType=void 0;var i=function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e}({});return so.MatrixWidgetType=i,so}var oo={},ip;function WS(){if(ip)return oo;ip=1,Object.defineProperty(oo,"__esModule",{value:!0}),oo.BuiltInModalButtonID=void 0;var i=function(e){return e.Close="m.close",e}({});return oo.BuiltInModalButtonID=i,oo}var an={},sp;function Dh(){if(sp)return an;sp=1,Object.defineProperty(an,"__esModule",{value:!0}),an.WidgetEventCapability=an.EventKind=an.EventDirection=void 0;function i(h){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},i(h)}function e(h,g){var v=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(!v){if(Array.isArray(h)||(v=t(h))||g){v&&(h=v);var m=0,E=function(){};return{s:E,n:function(){return m>=h.length?{done:!0}:{done:!1,value:h[m++]}},e:function(I){throw I},f:E}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var R=!0,_=!1,T;return{s:function(){v=v.call(h)},n:function(){var I=v.next();return R=I.done,I},e:function(I){_=!0,T=I},f:function(){try{!R&&v.return!=null&&v.return()}finally{if(_)throw T}}}}function t(h,g){if(h){if(typeof h=="string")return r(h,g);var v=Object.prototype.toString.call(h).slice(8,-1);if(v==="Object"&&h.constructor&&(v=h.constructor.name),v==="Map"||v==="Set")return Array.from(h);if(v==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(v))return r(h,g)}}function r(h,g){(g==null||g>h.length)&&(g=h.length);for(var v=0,m=new Array(g);v<g;v++)m[v]=h[v];return m}function n(h,g){if(!(h instanceof g))throw new TypeError("Cannot call a class as a function")}function s(h,g){for(var v=0;v<g.length;v++){var m=g[v];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(h,a(m.key),m)}}function o(h,g,v){return g&&s(h.prototype,g),v&&s(h,v),Object.defineProperty(h,"prototype",{writable:!1}),h}function a(h){var g=l(h,"string");return i(g)==="symbol"?g:String(g)}function l(h,g){if(i(h)!=="object"||h===null)return h;var v=h[Symbol.toPrimitive];if(v!==void 0){var m=v.call(h,g);if(i(m)!=="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(h)}var u=function(h){return h.Event="event",h.State="state_event",h.ToDevice="to_device",h.RoomAccount="room_account",h}({});an.EventKind=u;var c=function(h){return h.Send="send",h.Receive="receive",h}({});an.EventDirection=c;var d=function(){function h(g,v,m,E,R){n(this,h),this.direction=g,this.eventType=v,this.kind=m,this.keyStr=E,this.raw=R}return o(h,[{key:"matchesAsStateEvent",value:function(v,m,E){return this.kind!==u.State||this.direction!==v||this.eventType!==m?!1:this.keyStr===null||this.keyStr===E}},{key:"matchesAsToDeviceEvent",value:function(v,m){return!(this.kind!==u.ToDevice||this.direction!==v||this.eventType!==m)}},{key:"matchesAsRoomEvent",value:function(v,m){var E=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==u.Event||this.direction!==v||this.eventType!==m)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===E)return!0}else return!0;return!1}},{key:"matchesAsRoomAccountData",value:function(v,m){return!(this.kind!==u.RoomAccount||this.direction!==v||this.eventType!==m)}}],[{key:"forStateEvent",value:function(v,m,E){m=m.replace(/#/g,"\\#"),E=E!=null?"#".concat(E):"";var R="org.matrix.msc2762.".concat(v,".state_event:").concat(m).concat(E);return h.findEventCapabilities([R])[0]}},{key:"forToDeviceEvent",value:function(v,m){var E="org.matrix.msc3819.".concat(v,".to_device:").concat(m);return h.findEventCapabilities([E])[0]}},{key:"forRoomEvent",value:function(v,m){var E="org.matrix.msc2762.".concat(v,".event:").concat(m);return h.findEventCapabilities([E])[0]}},{key:"forRoomMessageEvent",value:function(v,m){m=m??"";var E="org.matrix.msc2762.".concat(v,".event:m.room.message#").concat(m);return h.findEventCapabilities([E])[0]}},{key:"forRoomAccountData",value:function(v,m){var E="com.beeper.capabilities.".concat(v,".room_account_data:").concat(m);return h.findEventCapabilities([E])[0]}},{key:"findEventCapabilities",value:function(v){var m=[],E=e(v),R;try{for(E.s();!(R=E.n()).done;){var _=R.value,T=null,b=void 0,I=null;if(_.startsWith("org.matrix.msc2762.send.event:")?(T=c.Send,I=u.Event,b=_.substring(30)):_.startsWith("org.matrix.msc2762.send.state_event:")?(T=c.Send,I=u.State,b=_.substring(36)):_.startsWith("org.matrix.msc3819.send.to_device:")?(T=c.Send,I=u.ToDevice,b=_.substring(34)):_.startsWith("org.matrix.msc2762.receive.event:")?(T=c.Receive,I=u.Event,b=_.substring(33)):_.startsWith("org.matrix.msc2762.receive.state_event:")?(T=c.Receive,I=u.State,b=_.substring(39)):_.startsWith("org.matrix.msc3819.receive.to_device:")?(T=c.Receive,I=u.ToDevice,b=_.substring(37)):_.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(T=c.Receive,I=u.RoomAccount,b=_.substring(50)),!(T===null||I===null||b===void 0)){var y=b.startsWith("m.room.message#")||I===u.State,C=null;if(b.includes("#")&&y){var w=b.split("#"),D=w.findIndex(function(x){return!x.endsWith("\\")});b=w.slice(0,D+1).map(function(x){return x.endsWith("\\")?x.substring(0,x.length-1):x}).join("#"),C=w.slice(D+1).join("#")}m.push(new h(T,b,I,C,_))}}}catch(x){E.e(x)}finally{E.f()}return m}}]),h}();return an.WidgetEventCapability=d,an}var ao={},op;function Uh(){if(op)return ao;op=1,Object.defineProperty(ao,"__esModule",{value:!0}),ao.Symbols=void 0;var i=function(e){return e.AnyRoom="*",e}({});return ao.Symbols=i,ao}var ap;function EC(){if(ap)return yi;ap=1;function i(Q){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(le){return typeof le}:function(le){return le&&typeof Symbol=="function"&&le.constructor===Symbol&&le!==Symbol.prototype?"symbol":typeof le},i(Q)}Object.defineProperty(yi,"__esModule",{value:!0}),yi.WidgetApiResponseError=yi.WidgetApi=void 0;var e=Xl(),t=kh(),r=Oh(),n=Ph(),s=Mh(),o=Ah(),a=VS(),l=WS(),u=Dh(),c=Uh();function d(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */d=function(){return Q};var Q={},le=Object.prototype,j=le.hasOwnProperty,K=Object.defineProperty||function(he,ae,W){he[ae]=W.value},N=typeof Symbol=="function"?Symbol:{},A=N.iterator||"@@iterator",M=N.asyncIterator||"@@asyncIterator",L=N.toStringTag||"@@toStringTag";function P(he,ae,W){return Object.defineProperty(he,ae,{value:W,enumerable:!0,configurable:!0,writable:!0}),he[ae]}try{P({},"")}catch{P=function(W,H,ee){return W[H]=ee}}function B(he,ae,W,H){var ee=ae&&ae.prototype instanceof U?ae:U,se=Object.create(ee.prototype),ge=new je(H||[]);return K(se,"_invoke",{value:Y(he,W,ge)}),se}function k(he,ae,W){try{return{type:"normal",arg:he.call(ae,W)}}catch(H){return{type:"throw",arg:H}}}Q.wrap=B;var O={};function U(){}function V(){}function q(){}var J={};P(J,A,function(){return this});var te=Object.getPrototypeOf,$=te&&te(te(xe([])));$&&$!==le&&j.call($,A)&&(J=$);var ue=q.prototype=U.prototype=Object.create(J);function ie(he){["next","throw","return"].forEach(function(ae){P(he,ae,function(W){return this._invoke(ae,W)})})}function Se(he,ae){function W(ee,se,ge,be){var Ke=k(he[ee],he,se);if(Ke.type!=="throw"){var st=Ke.arg,ot=st.value;return ot&&i(ot)=="object"&&j.call(ot,"__await")?ae.resolve(ot.__await).then(function(qt){W("next",qt,ge,be)},function(qt){W("throw",qt,ge,be)}):ae.resolve(ot).then(function(qt){st.value=qt,ge(st)},function(qt){return W("throw",qt,ge,be)})}be(Ke.arg)}var H;K(this,"_invoke",{value:function(se,ge){function be(){return new ae(function(Ke,st){W(se,ge,Ke,st)})}return H=H?H.then(be,be):be()}})}function Y(he,ae,W){var H="suspendedStart";return function(ee,se){if(H==="executing")throw new Error("Generator is already running");if(H==="completed"){if(ee==="throw")throw se;return yt()}for(W.method=ee,W.arg=se;;){var ge=W.delegate;if(ge){var be=pe(ge,W);if(be){if(be===O)continue;return be}}if(W.method==="next")W.sent=W._sent=W.arg;else if(W.method==="throw"){if(H==="suspendedStart")throw H="completed",W.arg;W.dispatchException(W.arg)}else W.method==="return"&&W.abrupt("return",W.arg);H="executing";var Ke=k(he,ae,W);if(Ke.type==="normal"){if(H=W.done?"completed":"suspendedYield",Ke.arg===O)continue;return{value:Ke.arg,done:W.done}}Ke.type==="throw"&&(H="completed",W.method="throw",W.arg=Ke.arg)}}}function pe(he,ae){var W=ae.method,H=he.iterator[W];if(H===void 0)return ae.delegate=null,W==="throw"&&he.iterator.return&&(ae.method="return",ae.arg=void 0,pe(he,ae),ae.method==="throw")||W!=="return"&&(ae.method="throw",ae.arg=new TypeError("The iterator does not provide a '"+W+"' method")),O;var ee=k(H,he.iterator,ae.arg);if(ee.type==="throw")return ae.method="throw",ae.arg=ee.arg,ae.delegate=null,O;var se=ee.arg;return se?se.done?(ae[he.resultName]=se.value,ae.next=he.nextLoc,ae.method!=="return"&&(ae.method="next",ae.arg=void 0),ae.delegate=null,O):se:(ae.method="throw",ae.arg=new TypeError("iterator result is not an object"),ae.delegate=null,O)}function Te(he){var ae={tryLoc:he[0]};1 in he&&(ae.catchLoc=he[1]),2 in he&&(ae.finallyLoc=he[2],ae.afterLoc=he[3]),this.tryEntries.push(ae)}function Ne(he){var ae=he.completion||{};ae.type="normal",delete ae.arg,he.completion=ae}function je(he){this.tryEntries=[{tryLoc:"root"}],he.forEach(Te,this),this.reset(!0)}function xe(he){if(he){var ae=he[A];if(ae)return ae.call(he);if(typeof he.next=="function")return he;if(!isNaN(he.length)){var W=-1,H=function ee(){for(;++W<he.length;)if(j.call(he,W))return ee.value=he[W],ee.done=!1,ee;return ee.value=void 0,ee.done=!0,ee};return H.next=H}}return{next:yt}}function yt(){return{value:void 0,done:!0}}return V.prototype=q,K(ue,"constructor",{value:q,configurable:!0}),K(q,"constructor",{value:V,configurable:!0}),V.displayName=P(q,L,"GeneratorFunction"),Q.isGeneratorFunction=function(he){var ae=typeof he=="function"&&he.constructor;return!!ae&&(ae===V||(ae.displayName||ae.name)==="GeneratorFunction")},Q.mark=function(he){return Object.setPrototypeOf?Object.setPrototypeOf(he,q):(he.__proto__=q,P(he,L,"GeneratorFunction")),he.prototype=Object.create(ue),he},Q.awrap=function(he){return{__await:he}},ie(Se.prototype),P(Se.prototype,M,function(){return this}),Q.AsyncIterator=Se,Q.async=function(he,ae,W,H,ee){ee===void 0&&(ee=Promise);var se=new Se(B(he,ae,W,H),ee);return Q.isGeneratorFunction(ae)?se:se.next().then(function(ge){return ge.done?ge.value:se.next()})},ie(ue),P(ue,L,"Generator"),P(ue,A,function(){return this}),P(ue,"toString",function(){return"[object Generator]"}),Q.keys=function(he){var ae=Object(he),W=[];for(var H in ae)W.push(H);return W.reverse(),function ee(){for(;W.length;){var se=W.pop();if(se in ae)return ee.value=se,ee.done=!1,ee}return ee.done=!0,ee}},Q.values=xe,je.prototype={constructor:je,reset:function(ae){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Ne),!ae)for(var W in this)W.charAt(0)==="t"&&j.call(this,W)&&!isNaN(+W.slice(1))&&(this[W]=void 0)},stop:function(){this.done=!0;var ae=this.tryEntries[0].completion;if(ae.type==="throw")throw ae.arg;return this.rval},dispatchException:function(ae){if(this.done)throw ae;var W=this;function H(st,ot){return ge.type="throw",ge.arg=ae,W.next=st,ot&&(W.method="next",W.arg=void 0),!!ot}for(var ee=this.tryEntries.length-1;ee>=0;--ee){var se=this.tryEntries[ee],ge=se.completion;if(se.tryLoc==="root")return H("end");if(se.tryLoc<=this.prev){var be=j.call(se,"catchLoc"),Ke=j.call(se,"finallyLoc");if(be&&Ke){if(this.prev<se.catchLoc)return H(se.catchLoc,!0);if(this.prev<se.finallyLoc)return H(se.finallyLoc)}else if(be){if(this.prev<se.catchLoc)return H(se.catchLoc,!0)}else{if(!Ke)throw new Error("try statement without catch or finally");if(this.prev<se.finallyLoc)return H(se.finallyLoc)}}}},abrupt:function(ae,W){for(var H=this.tryEntries.length-1;H>=0;--H){var ee=this.tryEntries[H];if(ee.tryLoc<=this.prev&&j.call(ee,"finallyLoc")&&this.prev<ee.finallyLoc){var se=ee;break}}se&&(ae==="break"||ae==="continue")&&se.tryLoc<=W&&W<=se.finallyLoc&&(se=null);var ge=se?se.completion:{};return ge.type=ae,ge.arg=W,se?(this.method="next",this.next=se.finallyLoc,O):this.complete(ge)},complete:function(ae,W){if(ae.type==="throw")throw ae.arg;return ae.type==="break"||ae.type==="continue"?this.next=ae.arg:ae.type==="return"?(this.rval=this.arg=ae.arg,this.method="return",this.next="end"):ae.type==="normal"&&W&&(this.next=W),O},finish:function(ae){for(var W=this.tryEntries.length-1;W>=0;--W){var H=this.tryEntries[W];if(H.finallyLoc===ae)return this.complete(H.completion,H.afterLoc),Ne(H),O}},catch:function(ae){for(var W=this.tryEntries.length-1;W>=0;--W){var H=this.tryEntries[W];if(H.tryLoc===ae){var ee=H.completion;if(ee.type==="throw"){var se=ee.arg;Ne(H)}return se}}throw new Error("illegal catch attempt")},delegateYield:function(ae,W,H){return this.delegate={iterator:xe(ae),resultName:W,nextLoc:H},this.method==="next"&&(this.arg=void 0),O}},Q}function h(Q,le,j,K,N,A,M){try{var L=Q[A](M),P=L.value}catch(B){j(B);return}L.done?le(P):Promise.resolve(P).then(K,N)}function g(Q){return function(){var le=this,j=arguments;return new Promise(function(K,N){var A=Q.apply(le,j);function M(P){h(A,K,N,M,L,"next",P)}function L(P){h(A,K,N,M,L,"throw",P)}M(void 0)})}}function v(Q,le){var j=Object.keys(Q);if(Object.getOwnPropertySymbols){var K=Object.getOwnPropertySymbols(Q);le&&(K=K.filter(function(N){return Object.getOwnPropertyDescriptor(Q,N).enumerable})),j.push.apply(j,K)}return j}function m(Q){for(var le=1;le<arguments.length;le++){var j=arguments[le]!=null?arguments[le]:{};le%2?v(Object(j),!0).forEach(function(K){E(Q,K,j[K])}):Object.getOwnPropertyDescriptors?Object.defineProperties(Q,Object.getOwnPropertyDescriptors(j)):v(Object(j)).forEach(function(K){Object.defineProperty(Q,K,Object.getOwnPropertyDescriptor(j,K))})}return Q}function E(Q,le,j){return le=T(le),le in Q?Object.defineProperty(Q,le,{value:j,enumerable:!0,configurable:!0,writable:!0}):Q[le]=j,Q}function R(Q,le){for(var j=0;j<le.length;j++){var K=le[j];K.enumerable=K.enumerable||!1,K.configurable=!0,"value"in K&&(K.writable=!0),Object.defineProperty(Q,T(K.key),K)}}function _(Q,le,j){return le&&R(Q.prototype,le),Object.defineProperty(Q,"prototype",{writable:!1}),Q}function T(Q){var le=b(Q,"string");return i(le)==="symbol"?le:String(le)}function b(Q,le){if(i(Q)!=="object"||Q===null)return Q;var j=Q[Symbol.toPrimitive];if(j!==void 0){var K=j.call(Q,le);if(i(K)!=="object")return K;throw new TypeError("@@toPrimitive must return a primitive value.")}return(le==="string"?String:Number)(Q)}function I(Q,le){if(!(Q instanceof le))throw new TypeError("Cannot call a class as a function")}function y(Q,le){if(typeof le!="function"&&le!==null)throw new TypeError("Super expression must either be null or a function");Q.prototype=Object.create(le&&le.prototype,{constructor:{value:Q,writable:!0,configurable:!0}}),Object.defineProperty(Q,"prototype",{writable:!1}),le&&Ee(Q,le)}function C(Q){var le=oe();return function(){var K=X(Q),N;if(le){var A=X(this).constructor;N=Reflect.construct(K,arguments,A)}else N=K.apply(this,arguments);return w(this,N)}}function w(Q,le){if(le&&(i(le)==="object"||typeof le=="function"))return le;if(le!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return D(Q)}function D(Q){if(Q===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return Q}function x(Q){var le=typeof Map=="function"?new Map:void 0;return x=function(K){if(K===null||!de(K))return K;if(typeof K!="function")throw new TypeError("Super expression must either be null or a function");if(typeof le<"u"){if(le.has(K))return le.get(K);le.set(K,N)}function N(){return G(K,arguments,X(this).constructor)}return N.prototype=Object.create(K.prototype,{constructor:{value:N,enumerable:!1,writable:!0,configurable:!0}}),Ee(N,K)},x(Q)}function G(Q,le,j){return oe()?G=Reflect.construct.bind():G=function(N,A,M){var L=[null];L.push.apply(L,A);var P=Function.bind.apply(N,L),B=new P;return M&&Ee(B,M.prototype),B},G.apply(null,arguments)}function oe(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function de(Q){return Function.toString.call(Q).indexOf("[native code]")!==-1}function Ee(Q,le){return Ee=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(K,N){return K.__proto__=N,K},Ee(Q,le)}function X(Q){return X=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(j){return j.__proto__||Object.getPrototypeOf(j)},X(Q)}function re(Q){return new ce(Q,0)}function Z(Q){return function(){return new ne(Q.apply(this,arguments))}}function ne(Q){var le,j;function K(A,M){try{var L=Q[A](M),P=L.value,B=P instanceof ce;Promise.resolve(B?P.v:P).then(function(k){if(B){var O=A==="return"?"return":"next";if(!P.k||k.done)return K(O,k);k=Q[O](k).value}N(L.done?"return":"normal",k)},function(k){K("throw",k)})}catch(k){N("throw",k)}}function N(A,M){switch(A){case"return":le.resolve({value:M,done:!0});break;case"throw":le.reject(M);break;default:le.resolve({value:M,done:!1})}(le=le.next)?K(le.key,le.arg):j=null}this._invoke=function(A,M){return new Promise(function(L,P){var B={key:A,arg:M,resolve:L,reject:P,next:null};j?j=j.next=B:(le=j=B,K(A,M))})},typeof Q.return!="function"&&(this.return=void 0)}ne.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},ne.prototype.next=function(Q){return this._invoke("next",Q)},ne.prototype.throw=function(Q){return this._invoke("throw",Q)},ne.prototype.return=function(Q){return this._invoke("return",Q)};function ce(Q,le){this.v=Q,this.k=le}var we=function(Q){y(j,Q);var le=C(j);function j(K,N){var A;return I(this,j),A=le.call(this,K),A.data=N,A}return _(j)}(x(Error));yi.WidgetApiResponseError=we,we.prototype.name=we.name;var Be=function(Q){y(j,Q);var le=C(j);function j(){var K,N=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(I(this,j),K=le.call(this),K.clientOrigin=A,E(D(K),"transport",void 0),E(D(K),"capabilitiesFinished",!1),E(D(K),"supportsMSC2974Renegotiate",!1),E(D(K),"requestedCapabilities",[]),E(D(K),"approvedCapabilities",void 0),E(D(K),"cachedClientVersions",void 0),E(D(K),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return K.transport=new n.PostmessageTransport(t.WidgetApiDirection.FromWidget,N,window.parent,window),K.transport.targetOrigin=A,K.transport.on("message",K.handleMessage.bind(D(K))),K}return _(j,[{key:"hasCapability",value:function(N){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(N):this.requestedCapabilities.includes(N)}},{key:"requestCapability",value:function(N){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(N)}},{key:"requestCapabilities",value:function(N){var A=this;N.forEach(function(M){return A.requestCapability(M)})}},{key:"requestCapabilityForRoomTimeline",value:function(N){this.requestCapability("org.matrix.msc2762.timeline:".concat(N))}},{key:"requestCapabilityToSendState",value:function(N,A){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Send,N,A).raw)}},{key:"requestCapabilityToReceiveState",value:function(N,A){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Receive,N,A).raw)}},{key:"requestCapabilityToSendToDevice",value:function(N){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Send,N).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(N){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Receive,N).raw)}},{key:"requestCapabilityToSendEvent",value:function(N){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Send,N).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(N){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Receive,N).raw)}},{key:"requestCapabilityToSendMessage",value:function(N){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Send,N).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(N){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Receive,N).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(N){this.requestCapability(u.WidgetEventCapability.forRoomAccountData(u.EventDirection.Receive,N).raw)}},{key:"requestOpenIDConnectToken",value:function(){var N=this;return new Promise(function(A,M){N.transport.sendComplete(s.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(L){var P=L.response;if(P.state===o.OpenIDRequestState.Allowed)A(P);else if(P.state===o.OpenIDRequestState.Blocked)M(new Error("User declined to verify their identity"));else if(P.state===o.OpenIDRequestState.PendingUserConfirmation){var B=function k(O){O.preventDefault();var U=O.detail;U.data.original_request_id===L.requestId&&(U.data.state===o.OpenIDRequestState.Allowed?(A(U.data),N.transport.reply(U,{})):U.data.state===o.OpenIDRequestState.Blocked?(M(new Error("User declined to verify their identity")),N.transport.reply(U,{})):(M(new Error("Invalid state on reply: "+P.state)),N.transport.reply(U,{error:{message:"Invalid state"}})),N.off("action:".concat(s.WidgetApiToWidgetAction.OpenIDCredentials),k))};N.on("action:".concat(s.WidgetApiToWidgetAction.OpenIDCredentials),B)}else M(new Error("Invalid state: "+P.state))}).catch(M)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(s.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(s.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(N){return this.transport.send(s.WidgetApiFromWidgetAction.SendSticker,N).then()}},{key:"setAlwaysOnScreen",value:function(N){return this.transport.send(s.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:N}).then(function(A){return A.success})}},{key:"openModalWidget",value:function(N,A){var M=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],L=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},P=arguments.length>4&&arguments[4]!==void 0?arguments[4]:a.MatrixWidgetType.Custom;return this.transport.send(s.WidgetApiFromWidgetAction.OpenModalWidget,{type:P,url:N,name:A,buttons:M,data:L}).then()}},{key:"closeModalWidget",value:function(){var N=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(s.WidgetApiFromWidgetAction.CloseModalWidget,N).then()}},{key:"sendRoomEvent",value:function(N,A,M,L,P){return this.sendEvent(N,void 0,A,M,L,P)}},{key:"sendStateEvent",value:function(N,A,M,L,P,B){return this.sendEvent(N,A,M,L,P,B)}},{key:"sendEvent",value:function(N,A,M,L,P,B){return this.transport.send(s.WidgetApiFromWidgetAction.SendEvent,m(m(m(m({type:N,content:M},A!==void 0&&{state_key:A}),L!==void 0&&{room_id:L}),P!==void 0&&{delay:P}),B!==void 0&&{parent_delay_id:B}))}},{key:"updateDelayedEvent",value:function(N,A){return this.transport.send(s.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:N,action:A})}},{key:"sendToDevice",value:function(N,A,M){return this.transport.send(s.WidgetApiFromWidgetAction.SendToDevice,{type:N,encrypted:A,messages:M})}},{key:"readRoomAccountData",value:function(N,A){var M={type:N};return A&&(A.includes(c.Symbols.AnyRoom)?M.room_ids=c.Symbols.AnyRoom:M.room_ids=A),this.transport.send(s.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,M).then(function(L){return L.events})}},{key:"readRoomEvents",value:function(N,A,M,L,P){var B={type:N,msgtype:M};return A!==void 0&&(B.limit=A),L&&(L.includes(c.Symbols.AnyRoom)?B.room_ids=c.Symbols.AnyRoom:B.room_ids=L),P&&(B.since=P),this.transport.send(s.WidgetApiFromWidgetAction.MSC2876ReadEvents,B).then(function(k){return k.events})}},{key:"readEventRelations",value:function(){var K=g(d().mark(function A(M,L,P,B,k,O,U,V){var q,J;return d().wrap(function($){for(;;)switch($.prev=$.next){case 0:return $.next=2,this.getClientVersions();case 2:if(q=$.sent,q.includes(r.UnstableApiVersion.MSC3869)){$.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return J={event_id:M,rel_type:P,event_type:B,room_id:L,to:U,from:O,limit:k,direction:V},$.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC3869ReadRelations,J));case 7:case"end":return $.stop()}},A,this)}));function N(A,M,L,P,B,k,O,U){return K.apply(this,arguments)}return N}()},{key:"readStateEvents",value:function(N,A,M,L){var P={type:N,state_key:M===void 0?!0:M};return A!==void 0&&(P.limit=A),L&&(L.includes(c.Symbols.AnyRoom)?P.room_ids=c.Symbols.AnyRoom:P.room_ids=L),this.transport.send(s.WidgetApiFromWidgetAction.MSC2876ReadEvents,P).then(function(B){return B.events})}},{key:"setModalButtonEnabled",value:function(N,A){if(N===l.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(s.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:N,enabled:A}).then()}},{key:"navigateTo",value:function(N){if(!N||!N.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(s.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:N}).then()}},{key:"getTurnServers",value:function(){var N=this;return Z(d().mark(function A(){var M,L;return d().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(L=function(){var k=g(d().mark(function O(U){return d().wrap(function(q){for(;;)switch(q.prev=q.next){case 0:return U.preventDefault(),M(U.detail.data),q.next=4,N.transport.reply(U.detail,{});case 4:case"end":return q.stop()}},O)}));return function(U){return k.apply(this,arguments)}}(),N.on("action:".concat(s.WidgetApiToWidgetAction.UpdateTurnServers),L),N.turnServerWatchers!==0){B.next=12;break}return B.prev=3,B.next=6,re(N.transport.send(s.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:B.next=12;break;case 8:throw B.prev=8,B.t0=B.catch(3),N.off("action:".concat(s.WidgetApiToWidgetAction.UpdateTurnServers),L),B.t0;case 12:N.turnServerWatchers++,B.prev=13;case 14:return B.next=17,re(new Promise(function(k){return M=k}));case 17:return B.next=19,B.sent;case 19:B.next=14;break;case 21:if(B.prev=21,N.off("action:".concat(s.WidgetApiToWidgetAction.UpdateTurnServers),L),N.turnServerWatchers--,N.turnServerWatchers!==0){B.next=27;break}return B.next=27,re(N.transport.send(s.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return B.finish(21);case 28:case"end":return B.stop()}},A,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:function(){var K=g(d().mark(function A(M,L){var P,B;return d().wrap(function(O){for(;;)switch(O.prev=O.next){case 0:return O.next=2,this.getClientVersions();case 2:if(P=O.sent,P.includes(r.UnstableApiVersion.MSC3973)){O.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return B={search_term:M,limit:L},O.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,B));case 7:case"end":return O.stop()}},A,this)}));function N(A,M){return K.apply(this,arguments)}return N}()},{key:"getMediaConfig",value:function(){var K=g(d().mark(function A(){var M,L;return d().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:return B.next=2,this.getClientVersions();case 2:if(M=B.sent,M.includes(r.UnstableApiVersion.MSC4039)){B.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return L={},B.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,L));case 7:case"end":return B.stop()}},A,this)}));function N(){return K.apply(this,arguments)}return N}()},{key:"uploadFile",value:function(){var K=g(d().mark(function A(M){var L,P;return d().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:return k.next=2,this.getClientVersions();case 2:if(L=k.sent,L.includes(r.UnstableApiVersion.MSC4039)){k.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return P={file:M},k.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC4039UploadFileAction,P));case 7:case"end":return k.stop()}},A,this)}));function N(A){return K.apply(this,arguments)}return N}()},{key:"downloadFile",value:function(){var K=g(d().mark(function A(M){var L,P;return d().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:return k.next=2,this.getClientVersions();case 2:if(L=k.sent,L.includes(r.UnstableApiVersion.MSC4039)){k.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return P={content_uri:M},k.abrupt("return",this.transport.send(s.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,P));case 7:case"end":return k.stop()}},A,this)}));function N(A){return K.apply(this,arguments)}return N}()},{key:"start",value:function(){var N=this;this.transport.start(),this.getClientVersions().then(function(A){A.includes(r.UnstableApiVersion.MSC2974)&&(N.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(N){var A=new CustomEvent("action:".concat(N.detail.action),{detail:N.detail,cancelable:!0});if(this.emit("action:".concat(N.detail.action),A),!A.defaultPrevented)switch(N.detail.action){case s.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(N.detail);case s.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(N.detail);case s.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(N.detail,{});case s.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(N.detail,{});default:return this.transport.reply(N.detail,{error:{message:"Unknown or unsupported action: "+N.detail.action}})}}},{key:"replyVersions",value:function(N){this.transport.reply(N,{supported_versions:r.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var N=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(s.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(A){return N.cachedClientVersions=A.supported_versions,A.supported_versions}).catch(function(A){return console.warn("non-fatal error getting supported client versions: ",A),[]})}},{key:"handleCapabilities",value:function(N){var A=this;return this.capabilitiesFinished?this.transport.reply(N,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(M){return M.includes(r.UnstableApiVersion.MSC2871)?A.once("action:".concat(s.WidgetApiToWidgetAction.NotifyCapabilities),function(L){A.approvedCapabilities=L.detail.data.approved,A.emit("ready")}):A.emit("ready"),A.capabilitiesFinished=!0,A.transport.reply(N,{capabilities:A.requestedCapabilities})})}}]),j}(e.EventEmitter);return yi.WidgetApi=Be,yi}var lo={},yr={},lp;function GS(){if(lp)return yr;lp=1,Object.defineProperty(yr,"__esModule",{value:!0}),yr.VideoConferenceCapabilities=yr.StickerpickerCapabilities=yr.MatrixCapabilities=void 0,yr.getTimelineRoomIDFromCapability=s,yr.isTimelineCapability=r,yr.isTimelineCapabilityFor=n;var i=function(o){return o.Screenshots="m.capability.screenshot",o.StickerSending="m.sticker",o.AlwaysOnScreen="m.always_on_screen",o.RequiresClient="io.element.requires_client",o.MSC2931Navigate="org.matrix.msc2931.navigate",o.MSC3846TurnServers="town.robin.msc3846.turn_servers",o.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",o.MSC4039UploadFile="org.matrix.msc4039.upload_file",o.MSC4039DownloadFile="org.matrix.msc4039.download_file",o.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",o.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",o}({});yr.MatrixCapabilities=i;var e=[i.StickerSending];yr.StickerpickerCapabilities=e;var t=[i.AlwaysOnScreen];yr.VideoConferenceCapabilities=t;function r(o){return o==null?void 0:o.startsWith("org.matrix.msc2762.timeline:")}function n(o,a){return o==="org.matrix.msc2762.timeline:".concat(a)}function s(o){return o.substring(o.indexOf(":")+1)}return yr}var uo={},up;function HS(){if(up)return uo;up=1,Object.defineProperty(uo,"__esModule",{value:!0}),uo.SimpleObservable=void 0;function i(d){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},i(d)}function e(d,h){var g=typeof Symbol<"u"&&d[Symbol.iterator]||d["@@iterator"];if(!g){if(Array.isArray(d)||(g=t(d))||h){g&&(d=g);var v=0,m=function(){};return{s:m,n:function(){return v>=d.length?{done:!0}:{done:!1,value:d[v++]}},e:function(b){throw b},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var E=!0,R=!1,_;return{s:function(){g=g.call(d)},n:function(){var b=g.next();return E=b.done,b},e:function(b){R=!0,_=b},f:function(){try{!E&&g.return!=null&&g.return()}finally{if(R)throw _}}}}function t(d,h){if(d){if(typeof d=="string")return r(d,h);var g=Object.prototype.toString.call(d).slice(8,-1);if(g==="Object"&&d.constructor&&(g=d.constructor.name),g==="Map"||g==="Set")return Array.from(d);if(g==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(g))return r(d,h)}}function r(d,h){(h==null||h>d.length)&&(h=d.length);for(var g=0,v=new Array(h);g<h;g++)v[g]=d[g];return v}function n(d,h){if(!(d instanceof h))throw new TypeError("Cannot call a class as a function")}function s(d,h){for(var g=0;g<h.length;g++){var v=h[g];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(d,l(v.key),v)}}function o(d,h,g){return h&&s(d.prototype,h),Object.defineProperty(d,"prototype",{writable:!1}),d}function a(d,h,g){return h=l(h),h in d?Object.defineProperty(d,h,{value:g,enumerable:!0,configurable:!0,writable:!0}):d[h]=g,d}function l(d){var h=u(d,"string");return i(h)==="symbol"?h:String(h)}function u(d,h){if(i(d)!=="object"||d===null)return d;var g=d[Symbol.toPrimitive];if(g!==void 0){var v=g.call(d,h);if(i(v)!=="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return(h==="string"?String:Number)(d)}var c=function(){function d(h){n(this,d),a(this,"listeners",[]),h&&this.listeners.push(h)}return o(d,[{key:"onUpdate",value:function(g){this.listeners.push(g)}},{key:"update",value:function(g){var v=e(this.listeners),m;try{for(v.s();!(m=v.n()).done;){var E=m.value;E(g)}}catch(R){v.e(R)}finally{v.f()}}},{key:"close",value:function(){this.listeners=[]}}]),d}();return uo.SimpleObservable=c,uo}var co={},cp;function $S(){if(cp)return co;cp=1,Object.defineProperty(co,"__esModule",{value:!0}),co.UpdateDelayedEventAction=void 0;var i=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({});return co.UpdateDelayedEventAction=i,co}var dp;function wC(){if(dp)return lo;dp=1,Object.defineProperty(lo,"__esModule",{value:!0}),lo.ClientWidgetApi=void 0;var i=Xl(),e=Ph(),t=kh(),r=Mh(),n=GS(),s=Oh(),o=Dh(),a=Ah(),l=HS(),u=Uh(),c=$S();function d(j){"@babel/helpers - typeof";return d=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(K){return typeof K}:function(K){return K&&typeof Symbol=="function"&&K.constructor===Symbol&&K!==Symbol.prototype?"symbol":typeof K},d(j)}function h(j,K){var N=Object.keys(j);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(j);K&&(A=A.filter(function(M){return Object.getOwnPropertyDescriptor(j,M).enumerable})),N.push.apply(N,A)}return N}function g(j){for(var K=1;K<arguments.length;K++){var N=arguments[K]!=null?arguments[K]:{};K%2?h(Object(N),!0).forEach(function(A){ne(j,A,N[A])}):Object.getOwnPropertyDescriptors?Object.defineProperties(j,Object.getOwnPropertyDescriptors(N)):h(Object(N)).forEach(function(A){Object.defineProperty(j,A,Object.getOwnPropertyDescriptor(N,A))})}return j}function v(j,K){var N=typeof Symbol<"u"&&j[Symbol.iterator]||j["@@iterator"];if(!N){if(Array.isArray(j)||(N=R(j))||K){N&&(j=N);var A=0,M=function(){};return{s:M,n:function(){return A>=j.length?{done:!0}:{done:!1,value:j[A++]}},e:function(O){throw O},f:M}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var L=!0,P=!1,B;return{s:function(){N=N.call(j)},n:function(){var O=N.next();return L=O.done,O},e:function(O){P=!0,B=O},f:function(){try{!L&&N.return!=null&&N.return()}finally{if(P)throw B}}}}function m(j){return T(j)||_(j)||R(j)||E()}function E(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function R(j,K){if(j){if(typeof j=="string")return b(j,K);var N=Object.prototype.toString.call(j).slice(8,-1);if(N==="Object"&&j.constructor&&(N=j.constructor.name),N==="Map"||N==="Set")return Array.from(j);if(N==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(N))return b(j,K)}}function _(j){if(typeof Symbol<"u"&&j[Symbol.iterator]!=null||j["@@iterator"]!=null)return Array.from(j)}function T(j){if(Array.isArray(j))return b(j)}function b(j,K){(K==null||K>j.length)&&(K=j.length);for(var N=0,A=new Array(K);N<K;N++)A[N]=j[N];return A}function I(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */I=function(){return j};var j={},K=Object.prototype,N=K.hasOwnProperty,A=Object.defineProperty||function(W,H,ee){W[H]=ee.value},M=typeof Symbol=="function"?Symbol:{},L=M.iterator||"@@iterator",P=M.asyncIterator||"@@asyncIterator",B=M.toStringTag||"@@toStringTag";function k(W,H,ee){return Object.defineProperty(W,H,{value:ee,enumerable:!0,configurable:!0,writable:!0}),W[H]}try{k({},"")}catch{k=function(ee,se,ge){return ee[se]=ge}}function O(W,H,ee,se){var ge=H&&H.prototype instanceof q?H:q,be=Object.create(ge.prototype),Ke=new yt(se||[]);return A(be,"_invoke",{value:Te(W,ee,Ke)}),be}function U(W,H,ee){try{return{type:"normal",arg:W.call(H,ee)}}catch(se){return{type:"throw",arg:se}}}j.wrap=O;var V={};function q(){}function J(){}function te(){}var $={};k($,L,function(){return this});var ue=Object.getPrototypeOf,ie=ue&&ue(ue(he([])));ie&&ie!==K&&N.call(ie,L)&&($=ie);var Se=te.prototype=q.prototype=Object.create($);function Y(W){["next","throw","return"].forEach(function(H){k(W,H,function(ee){return this._invoke(H,ee)})})}function pe(W,H){function ee(ge,be,Ke,st){var ot=U(W[ge],W,be);if(ot.type!=="throw"){var qt=ot.arg,kn=qt.value;return kn&&d(kn)=="object"&&N.call(kn,"__await")?H.resolve(kn.__await).then(function(oi){ee("next",oi,Ke,st)},function(oi){ee("throw",oi,Ke,st)}):H.resolve(kn).then(function(oi){qt.value=oi,Ke(qt)},function(oi){return ee("throw",oi,Ke,st)})}st(ot.arg)}var se;A(this,"_invoke",{value:function(be,Ke){function st(){return new H(function(ot,qt){ee(be,Ke,ot,qt)})}return se=se?se.then(st,st):st()}})}function Te(W,H,ee){var se="suspendedStart";return function(ge,be){if(se==="executing")throw new Error("Generator is already running");if(se==="completed"){if(ge==="throw")throw be;return ae()}for(ee.method=ge,ee.arg=be;;){var Ke=ee.delegate;if(Ke){var st=Ne(Ke,ee);if(st){if(st===V)continue;return st}}if(ee.method==="next")ee.sent=ee._sent=ee.arg;else if(ee.method==="throw"){if(se==="suspendedStart")throw se="completed",ee.arg;ee.dispatchException(ee.arg)}else ee.method==="return"&&ee.abrupt("return",ee.arg);se="executing";var ot=U(W,H,ee);if(ot.type==="normal"){if(se=ee.done?"completed":"suspendedYield",ot.arg===V)continue;return{value:ot.arg,done:ee.done}}ot.type==="throw"&&(se="completed",ee.method="throw",ee.arg=ot.arg)}}}function Ne(W,H){var ee=H.method,se=W.iterator[ee];if(se===void 0)return H.delegate=null,ee==="throw"&&W.iterator.return&&(H.method="return",H.arg=void 0,Ne(W,H),H.method==="throw")||ee!=="return"&&(H.method="throw",H.arg=new TypeError("The iterator does not provide a '"+ee+"' method")),V;var ge=U(se,W.iterator,H.arg);if(ge.type==="throw")return H.method="throw",H.arg=ge.arg,H.delegate=null,V;var be=ge.arg;return be?be.done?(H[W.resultName]=be.value,H.next=W.nextLoc,H.method!=="return"&&(H.method="next",H.arg=void 0),H.delegate=null,V):be:(H.method="throw",H.arg=new TypeError("iterator result is not an object"),H.delegate=null,V)}function je(W){var H={tryLoc:W[0]};1 in W&&(H.catchLoc=W[1]),2 in W&&(H.finallyLoc=W[2],H.afterLoc=W[3]),this.tryEntries.push(H)}function xe(W){var H=W.completion||{};H.type="normal",delete H.arg,W.completion=H}function yt(W){this.tryEntries=[{tryLoc:"root"}],W.forEach(je,this),this.reset(!0)}function he(W){if(W){var H=W[L];if(H)return H.call(W);if(typeof W.next=="function")return W;if(!isNaN(W.length)){var ee=-1,se=function ge(){for(;++ee<W.length;)if(N.call(W,ee))return ge.value=W[ee],ge.done=!1,ge;return ge.value=void 0,ge.done=!0,ge};return se.next=se}}return{next:ae}}function ae(){return{value:void 0,done:!0}}return J.prototype=te,A(Se,"constructor",{value:te,configurable:!0}),A(te,"constructor",{value:J,configurable:!0}),J.displayName=k(te,B,"GeneratorFunction"),j.isGeneratorFunction=function(W){var H=typeof W=="function"&&W.constructor;return!!H&&(H===J||(H.displayName||H.name)==="GeneratorFunction")},j.mark=function(W){return Object.setPrototypeOf?Object.setPrototypeOf(W,te):(W.__proto__=te,k(W,B,"GeneratorFunction")),W.prototype=Object.create(Se),W},j.awrap=function(W){return{__await:W}},Y(pe.prototype),k(pe.prototype,P,function(){return this}),j.AsyncIterator=pe,j.async=function(W,H,ee,se,ge){ge===void 0&&(ge=Promise);var be=new pe(O(W,H,ee,se),ge);return j.isGeneratorFunction(H)?be:be.next().then(function(Ke){return Ke.done?Ke.value:be.next()})},Y(Se),k(Se,B,"Generator"),k(Se,L,function(){return this}),k(Se,"toString",function(){return"[object Generator]"}),j.keys=function(W){var H=Object(W),ee=[];for(var se in H)ee.push(se);return ee.reverse(),function ge(){for(;ee.length;){var be=ee.pop();if(be in H)return ge.value=be,ge.done=!1,ge}return ge.done=!0,ge}},j.values=he,yt.prototype={constructor:yt,reset:function(H){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(xe),!H)for(var ee in this)ee.charAt(0)==="t"&&N.call(this,ee)&&!isNaN(+ee.slice(1))&&(this[ee]=void 0)},stop:function(){this.done=!0;var H=this.tryEntries[0].completion;if(H.type==="throw")throw H.arg;return this.rval},dispatchException:function(H){if(this.done)throw H;var ee=this;function se(qt,kn){return Ke.type="throw",Ke.arg=H,ee.next=qt,kn&&(ee.method="next",ee.arg=void 0),!!kn}for(var ge=this.tryEntries.length-1;ge>=0;--ge){var be=this.tryEntries[ge],Ke=be.completion;if(be.tryLoc==="root")return se("end");if(be.tryLoc<=this.prev){var st=N.call(be,"catchLoc"),ot=N.call(be,"finallyLoc");if(st&&ot){if(this.prev<be.catchLoc)return se(be.catchLoc,!0);if(this.prev<be.finallyLoc)return se(be.finallyLoc)}else if(st){if(this.prev<be.catchLoc)return se(be.catchLoc,!0)}else{if(!ot)throw new Error("try statement without catch or finally");if(this.prev<be.finallyLoc)return se(be.finallyLoc)}}}},abrupt:function(H,ee){for(var se=this.tryEntries.length-1;se>=0;--se){var ge=this.tryEntries[se];if(ge.tryLoc<=this.prev&&N.call(ge,"finallyLoc")&&this.prev<ge.finallyLoc){var be=ge;break}}be&&(H==="break"||H==="continue")&&be.tryLoc<=ee&&ee<=be.finallyLoc&&(be=null);var Ke=be?be.completion:{};return Ke.type=H,Ke.arg=ee,be?(this.method="next",this.next=be.finallyLoc,V):this.complete(Ke)},complete:function(H,ee){if(H.type==="throw")throw H.arg;return H.type==="break"||H.type==="continue"?this.next=H.arg:H.type==="return"?(this.rval=this.arg=H.arg,this.method="return",this.next="end"):H.type==="normal"&&ee&&(this.next=ee),V},finish:function(H){for(var ee=this.tryEntries.length-1;ee>=0;--ee){var se=this.tryEntries[ee];if(se.finallyLoc===H)return this.complete(se.completion,se.afterLoc),xe(se),V}},catch:function(H){for(var ee=this.tryEntries.length-1;ee>=0;--ee){var se=this.tryEntries[ee];if(se.tryLoc===H){var ge=se.completion;if(ge.type==="throw"){var be=ge.arg;xe(se)}return be}}throw new Error("illegal catch attempt")},delegateYield:function(H,ee,se){return this.delegate={iterator:he(H),resultName:ee,nextLoc:se},this.method==="next"&&(this.arg=void 0),V}},j}function y(j,K,N,A,M,L,P){try{var B=j[L](P),k=B.value}catch(O){N(O);return}B.done?K(k):Promise.resolve(k).then(A,M)}function C(j){return function(){var K=this,N=arguments;return new Promise(function(A,M){var L=j.apply(K,N);function P(k){y(L,A,M,P,B,"next",k)}function B(k){y(L,A,M,P,B,"throw",k)}P(void 0)})}}function w(j,K){if(!(j instanceof K))throw new TypeError("Cannot call a class as a function")}function D(j,K){for(var N=0;N<K.length;N++){var A=K[N];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(j,ce(A.key),A)}}function x(j,K,N){return K&&D(j.prototype,K),Object.defineProperty(j,"prototype",{writable:!1}),j}function G(j,K){if(typeof K!="function"&&K!==null)throw new TypeError("Super expression must either be null or a function");j.prototype=Object.create(K&&K.prototype,{constructor:{value:j,writable:!0,configurable:!0}}),Object.defineProperty(j,"prototype",{writable:!1}),K&&oe(j,K)}function oe(j,K){return oe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(A,M){return A.__proto__=M,A},oe(j,K)}function de(j){var K=re();return function(){var A=Z(j),M;if(K){var L=Z(this).constructor;M=Reflect.construct(A,arguments,L)}else M=A.apply(this,arguments);return Ee(this,M)}}function Ee(j,K){if(K&&(d(K)==="object"||typeof K=="function"))return K;if(K!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return X(j)}function X(j){if(j===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return j}function re(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Z(j){return Z=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(N){return N.__proto__||Object.getPrototypeOf(N)},Z(j)}function ne(j,K,N){return K=ce(K),K in j?Object.defineProperty(j,K,{value:N,enumerable:!0,configurable:!0,writable:!0}):j[K]=N,j}function ce(j){var K=we(j,"string");return d(K)==="symbol"?K:String(K)}function we(j,K){if(d(j)!=="object"||j===null)return j;var N=j[Symbol.toPrimitive];if(N!==void 0){var A=N.call(j,K);if(d(A)!=="object")return A;throw new TypeError("@@toPrimitive must return a primitive value.")}return(K==="string"?String:Number)(j)}function Be(j){var K,N,A,M=2;for(typeof Symbol<"u"&&(N=Symbol.asyncIterator,A=Symbol.iterator);M--;){if(N&&(K=j[N])!=null)return K.call(j);if(A&&(K=j[A])!=null)return new Q(K.call(j));N="@@asyncIterator",A="@@iterator"}throw new TypeError("Object is not async iterable")}function Q(j){function K(N){if(Object(N)!==N)return Promise.reject(new TypeError(N+" is not an object."));var A=N.done;return Promise.resolve(N.value).then(function(M){return{value:M,done:A}})}return Q=function(A){this.s=A,this.n=A.next},Q.prototype={s:null,n:null,next:function(){return K(this.n.apply(this.s,arguments))},return:function(A){var M=this.s.return;return M===void 0?Promise.resolve({value:A,done:!0}):K(M.apply(this.s,arguments))},throw:function(A){var M=this.s.return;return M===void 0?Promise.reject(A):K(M.apply(this.s,arguments))}},new Q(j)}var le=function(j){G(N,j);var K=de(N);function N(A,M,L){var P;if(w(this,N),P=K.call(this),P.widget=A,P.iframe=M,P.driver=L,ne(X(P),"transport",void 0),ne(X(P),"cachedWidgetVersions",null),ne(X(P),"contentLoadedActionSent",!1),ne(X(P),"allowedCapabilities",new Set),ne(X(P),"allowedEvents",[]),ne(X(P),"isStopped",!1),ne(X(P),"turnServers",null),ne(X(P),"contentLoadedWaitTimer",void 0),ne(X(P),"pushRoomStateTasks",new Set),ne(X(P),"pushRoomStateResult",new Map),ne(X(P),"flushRoomStateTask",null),ne(X(P),"viewedRoomId",null),!(M!=null&&M.contentWindow))throw new Error("No iframe supplied");if(!A)throw new Error("Invalid widget");if(!L)throw new Error("Invalid driver");return P.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,A.id,M.contentWindow,window),P.transport.targetOrigin=A.origin,P.transport.on("message",P.handleMessage.bind(X(P))),M.addEventListener("load",P.onIframeLoad.bind(X(P))),P.transport.start(),P}return x(N,[{key:"hasCapability",value:function(M){return this.allowedCapabilities.has(M)}},{key:"canUseRoomTimeline",value:function(M){return this.hasCapability("org.matrix.msc2762.timeline:".concat(u.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(M))}},{key:"canSendRoomEvent",value:function(M){var L=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(P){return P.matchesAsRoomEvent(o.EventDirection.Send,M,L)})}},{key:"canSendStateEvent",value:function(M,L){return this.allowedEvents.some(function(P){return P.matchesAsStateEvent(o.EventDirection.Send,M,L)})}},{key:"canSendToDeviceEvent",value:function(M){return this.allowedEvents.some(function(L){return L.matchesAsToDeviceEvent(o.EventDirection.Send,M)})}},{key:"canReceiveRoomEvent",value:function(M){var L=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(P){return P.matchesAsRoomEvent(o.EventDirection.Receive,M,L)})}},{key:"canReceiveStateEvent",value:function(M,L){return this.allowedEvents.some(function(P){return P.matchesAsStateEvent(o.EventDirection.Receive,M,L)})}},{key:"canReceiveToDeviceEvent",value:function(M){return this.allowedEvents.some(function(L){return L.matchesAsToDeviceEvent(o.EventDirection.Receive,M)})}},{key:"canReceiveRoomAccountData",value:function(M){return this.allowedEvents.some(function(L){return L.matchesAsRoomAccountData(o.EventDirection.Receive,M)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:function(){var A=C(I().mark(function L(){var P;return I().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){k.next=2;break}return k.abrupt("return",Promise.resolve(this.cachedWidgetVersions));case 2:return k.prev=2,k.next=5,this.transport.send(r.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return P=k.sent,this.cachedWidgetVersions=P.supported_versions,k.abrupt("return",P.supported_versions);case 10:return k.prev=10,k.t0=k.catch(2),console.warn("non-fatal error getting supported widget versions: ",k.t0),k.abrupt("return",[]);case 14:case"end":return k.stop()}},L,this,[[2,10]])}));function M(){return A.apply(this,arguments)}return M}()},{key:"beginCapabilities",value:function(){var M=this;this.emit("preparing");var L;this.transport.send(r.WidgetApiToWidgetAction.Capabilities,{}).then(function(P){return L=P.capabilities,M.driver.validateCapabilities(new Set(P.capabilities))}).then(function(P){M.allowCapabilities(m(P),L),M.emit("ready")}).catch(function(P){M.emit("error:preparing",P)})}},{key:"allowCapabilities",value:function(M,L){var P,B=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),M);var k=v(M),O;try{for(k.s();!(O=k.n()).done;){var U=O.value;this.allowedCapabilities.add(U)}}catch(Y){k.e(Y)}finally{k.f()}var V=o.WidgetEventCapability.findEventCapabilities(M);(P=this.allowedEvents).push.apply(P,m(V)),this.transport.send(r.WidgetApiToWidgetAction.NotifyCapabilities,{requested:L,approved:Array.from(this.allowedCapabilities)}).catch(function(Y){console.warn("non-fatal error notifying widget of approved capabilities:",Y)}).then(function(){B.emit("capabilitiesNotified")});var q=v(M),J;try{for(q.s();!(J=q.n()).done;){var te=J.value;if((0,n.isTimelineCapability)(te)){var $=(0,n.getTimelineRoomIDFromCapability)(te);if($===u.Symbols.AnyRoom){var ue=v(this.driver.getKnownRooms()),ie;try{for(ue.s();!(ie=ue.n()).done;){var Se=ie.value;this.pushRoomState(Se)}}catch(Y){ue.e(Y)}finally{ue.f()}}else this.pushRoomState($)}}}catch(Y){q.e(Y)}finally{q.f()}V.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(M){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(M){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(M,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(M,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(M){this.transport.reply(M,{supported_versions:s.CurrentApiVersions})}},{key:"supportsUpdateState",value:function(){var A=C(I().mark(function L(){return I().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:return B.next=2,this.getWidgetVersions();case 2:return B.abrupt("return",B.sent.includes(s.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return B.stop()}},L,this)}));function M(){return A.apply(this,arguments)}return M}()},{key:"handleCapabilitiesRenegotiate",value:function(M){var L,P=this;this.transport.reply(M,{});var B=((L=M.data)===null||L===void 0?void 0:L.capabilities)||[],k=new Set(B.filter(function(O){return!P.hasCapability(O)}));k.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(k).then(function(O){return P.allowCapabilities(m(O),m(k))})}},{key:"handleNavigate",value:function(M){var L,P,B=this;if(!this.hasCapability(n.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(M,{error:{message:"Missing capability"}});if(!((L=M.data)!==null&&L!==void 0&&L.uri)||!((P=M.data)!==null&&P!==void 0&&P.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(M,{error:{message:"Invalid matrix.to URI"}});var k=function(U){console.error("[ClientWidgetApi] Failed to handle navigation: ",U),B.handleDriverError(U,M,"Error handling navigation")};try{this.driver.navigate(M.data.uri.toString()).catch(function(O){return k(O)}).then(function(){return B.transport.reply(M,{})})}catch(O){return k(O)}}},{key:"handleOIDC",value:function(M){var L=this,P=1,B=function(V,q){return q=q||{},P>1?L.transport.send(r.WidgetApiToWidgetAction.OpenIDCredentials,g({state:V,original_request_id:M.requestId},q)):L.transport.reply(M,g({state:V},q))},k=function(V){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",V),P>1?B(a.OpenIDRequestState.Blocked):L.transport.reply(M,{error:{message:V}})},O=new l.SimpleObservable(function(U){if(U.state===a.OpenIDRequestState.PendingUserConfirmation&&P>1)return O.close(),k("client provided out-of-phase response to OIDC flow");if(U.state===a.OpenIDRequestState.PendingUserConfirmation){B(U.state),P++;return}return U.state===a.OpenIDRequestState.Allowed&&!U.token?k("client provided invalid OIDC token for an allowed request"):(U.state===a.OpenIDRequestState.Blocked&&(U.token=void 0),O.close(),B(U.state,U.token))});this.driver.askOpenID(O)}},{key:"handleReadRoomAccountData",value:function(M){var L=this,P=Promise.resolve([]);return P=this.driver.readRoomAccountData(M.data.type),this.canReceiveRoomAccountData(M.data.type)?P.then(function(B){L.transport.reply(M,{events:B})}):this.transport.reply(M,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(){var A=C(I().mark(function L(P){var B=this,k,O,U,V,q,J,te,$,ue,ie;return I().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(P.data.type){Y.next=2;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(P.data.limit!==void 0&&(!P.data.limit||P.data.limit<0))){Y.next=4;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 4:if(P.data.room_ids!==void 0){Y.next=8;break}k=this.viewedRoomId===null?[]:[this.viewedRoomId],Y.next=30;break;case 8:if(P.data.room_ids!==u.Symbols.AnyRoom){Y.next=12;break}k=this.driver.getKnownRooms().filter(function(pe){return B.canUseRoomTimeline(pe)}),Y.next=30;break;case 12:k=P.data.room_ids,O=v(k),Y.prev=14,O.s();case 16:if((U=O.n()).done){Y.next=22;break}if(V=U.value,this.canUseRoomTimeline(V)){Y.next=20;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(V)}}));case 20:Y.next=16;break;case 22:Y.next=27;break;case 24:Y.prev=24,Y.t0=Y.catch(14),O.e(Y.t0);case 27:return Y.prev=27,O.f(),Y.finish(27);case 30:if(q=P.data.limit||0,J=P.data.since,te=void 0,$=void 0,P.data.state_key===void 0){Y.next=40;break}if(te=P.data.state_key===!0?void 0:P.data.state_key.toString(),this.canReceiveStateEvent(P.data.type,(ue=te)!==null&&ue!==void 0?ue:null)){Y.next=38;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Cannot read state events of this type"}}));case 38:Y.next=43;break;case 40:if($=P.data.msgtype,this.canReceiveRoomEvent(P.data.type,$)){Y.next=43;break}return Y.abrupt("return",this.transport.reply(P,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(P.data.room_ids===void 0&&k.length===0)){Y.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),Y.next=47,P.data.state_key===void 0?this.driver.readRoomEvents(P.data.type,$,q,null,J):this.driver.readStateEvents(P.data.type,te,q,null);case 47:ie=Y.sent,Y.next=68;break;case 50:return Y.next=52,this.supportsUpdateState();case 52:if(!Y.sent){Y.next=58;break}return Y.next=55,Promise.all(k.map(function(pe){return B.driver.readRoomTimeline(pe,P.data.type,$,te,q,J)}));case 55:ie=Y.sent.flat(1),Y.next=68;break;case 58:if(P.data.state_key!==void 0){Y.next=64;break}return Y.next=61,Promise.all(k.map(function(pe){return B.driver.readRoomTimeline(pe,P.data.type,$,te,q,J)}));case 61:Y.t1=Y.sent,Y.next=67;break;case 64:return Y.next=66,Promise.all(k.map(function(pe){return B.driver.readRoomState(pe,P.data.type,te)}));case 66:Y.t1=Y.sent;case 67:ie=Y.t1.flat(1);case 68:this.transport.reply(P,{events:ie});case 69:case"end":return Y.stop()}},L,this,[[14,24,27,30]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleSendEvent",value:function(M){var L=this;if(!M.data.type)return this.transport.reply(M,{error:{message:"Invalid request - missing event type"}});if(M.data.room_id&&!this.canUseRoomTimeline(M.data.room_id))return this.transport.reply(M,{error:{message:"Unable to access room timeline: ".concat(M.data.room_id)}});var P=M.data.delay!==void 0||M.data.parent_delay_id!==void 0;if(P&&!this.hasCapability(n.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(M,{error:{message:"Missing capability"}});var B;if(M.data.state_key!==void 0){if(!this.canSendStateEvent(M.data.type,M.data.state_key))return this.transport.reply(M,{error:{message:"Cannot send state events of this type"}});if(!P)B=this.driver.sendEvent(M.data.type,M.data.content||{},M.data.state_key,M.data.room_id);else{var k,O;B=this.driver.sendDelayedEvent((k=M.data.delay)!==null&&k!==void 0?k:null,(O=M.data.parent_delay_id)!==null&&O!==void 0?O:null,M.data.type,M.data.content||{},M.data.state_key,M.data.room_id)}}else{var U=M.data.content||{},V=U.msgtype;if(!this.canSendRoomEvent(M.data.type,V))return this.transport.reply(M,{error:{message:"Cannot send room events of this type"}});if(!P)B=this.driver.sendEvent(M.data.type,U,null,M.data.room_id);else{var q,J;B=this.driver.sendDelayedEvent((q=M.data.delay)!==null&&q!==void 0?q:null,(J=M.data.parent_delay_id)!==null&&J!==void 0?J:null,M.data.type,U,null,M.data.room_id)}}B.then(function(te){return L.transport.reply(M,g({room_id:te.roomId},"eventId"in te?{event_id:te.eventId}:{delay_id:te.delayId}))}).catch(function(te){console.error("error sending event: ",te),L.handleDriverError(te,M,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(M){var L=this;if(!M.data.delay_id)return this.transport.reply(M,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(n.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(M,{error:{message:"Missing capability"}});switch(M.data.action){case c.UpdateDelayedEventAction.Cancel:case c.UpdateDelayedEventAction.Restart:case c.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(M.data.delay_id,M.data.action).then(function(){return L.transport.reply(M,{})}).catch(function(P){console.error("error updating delayed event: ",P),L.handleDriverError(P,M,"Error updating delayed event")});break;default:return this.transport.reply(M,{error:{message:"Invalid request - unsupported action"}})}}},{key:"handleSendToDevice",value:function(){var A=C(I().mark(function L(P){return I().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:if(P.data.type){k.next=5;break}return k.next=3,this.transport.reply(P,{error:{message:"Invalid request - missing event type"}});case 3:k.next=31;break;case 5:if(P.data.messages){k.next=10;break}return k.next=8,this.transport.reply(P,{error:{message:"Invalid request - missing event contents"}});case 8:k.next=31;break;case 10:if(typeof P.data.encrypted=="boolean"){k.next=15;break}return k.next=13,this.transport.reply(P,{error:{message:"Invalid request - missing encryption flag"}});case 13:k.next=31;break;case 15:if(this.canSendToDeviceEvent(P.data.type)){k.next=20;break}return k.next=18,this.transport.reply(P,{error:{message:"Cannot send to-device events of this type"}});case 18:k.next=31;break;case 20:return k.prev=20,k.next=23,this.driver.sendToDevice(P.data.type,P.data.encrypted,P.data.messages);case 23:return k.next=25,this.transport.reply(P,{});case 25:k.next=31;break;case 27:k.prev=27,k.t0=k.catch(20),console.error("error sending to-device event",k.t0),this.handleDriverError(k.t0,P,"Error sending event");case 31:case"end":return k.stop()}},L,this,[[20,27]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"pollTurnServers",value:function(){var A=C(I().mark(function L(P,B){var k,O,U,V,q,J;return I().wrap(function($){for(;;)switch($.prev=$.next){case 0:return $.prev=0,$.next=3,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,B);case 3:k=!1,O=!1,$.prev=5,V=Be(P);case 7:return $.next=9,V.next();case 9:if(!(k=!(q=$.sent).done)){$.next=16;break}return J=q.value,$.next=13,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,J);case 13:k=!1,$.next=7;break;case 16:$.next=22;break;case 18:$.prev=18,$.t0=$.catch(5),O=!0,U=$.t0;case 22:if($.prev=22,$.prev=23,!(k&&V.return!=null)){$.next=27;break}return $.next=27,V.return();case 27:if($.prev=27,!O){$.next=30;break}throw U;case 30:return $.finish(27);case 31:return $.finish(22);case 32:$.next=37;break;case 34:$.prev=34,$.t1=$.catch(0),console.error("error polling for TURN servers",$.t1);case 37:case"end":return $.stop()}},L,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function M(L,P){return A.apply(this,arguments)}return M}()},{key:"handleWatchTurnServers",value:function(){var A=C(I().mark(function L(P){var B,k,O,U;return I().wrap(function(q){for(;;)switch(q.prev=q.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){q.next=5;break}return q.next=3,this.transport.reply(P,{error:{message:"Missing capability"}});case 3:q.next=30;break;case 5:if(!this.turnServers){q.next=10;break}return q.next=8,this.transport.reply(P,{});case 8:q.next=30;break;case 10:return q.prev=10,B=this.driver.getTurnServers(),q.next=14,B.next();case 14:if(k=q.sent,O=k.done,U=k.value,!O){q.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return q.next=21,this.transport.reply(P,{});case 21:this.pollTurnServers(B,U),this.turnServers=B,q.next=30;break;case 25:return q.prev=25,q.t0=q.catch(10),console.error("error getting first TURN server results",q.t0),q.next=30,this.transport.reply(P,{error:{message:"TURN servers not available"}});case 30:case"end":return q.stop()}},L,this,[[10,25]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleUnwatchTurnServers",value:function(){var A=C(I().mark(function L(P){return I().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){k.next=5;break}return k.next=3,this.transport.reply(P,{error:{message:"Missing capability"}});case 3:k.next=15;break;case 5:if(this.turnServers){k.next=10;break}return k.next=8,this.transport.reply(P,{});case 8:k.next=15;break;case 10:return k.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,k.next=15,this.transport.reply(P,{});case 15:case"end":return k.stop()}},L,this)}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleReadRelations",value:function(){var A=C(I().mark(function L(P){var B=this,k,O;return I().wrap(function(V){for(;;)switch(V.prev=V.next){case 0:if(P.data.event_id){V.next=2;break}return V.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(P.data.limit!==void 0&&P.data.limit<0)){V.next=4;break}return V.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(P.data.room_id!==void 0&&!this.canUseRoomTimeline(P.data.room_id))){V.next=6;break}return V.abrupt("return",this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(P.data.room_id)}}));case 6:return V.prev=6,V.next=9,this.driver.readEventRelations(P.data.event_id,P.data.room_id,P.data.rel_type,P.data.event_type,P.data.from,P.data.to,P.data.limit,P.data.direction);case 9:return k=V.sent,O=k.chunk.filter(function(q){return q.state_key!==void 0?B.canReceiveStateEvent(q.type,q.state_key):B.canReceiveRoomEvent(q.type,q.content.msgtype)}),V.abrupt("return",this.transport.reply(P,{chunk:O,prev_batch:k.prevBatch,next_batch:k.nextBatch}));case 14:V.prev=14,V.t0=V.catch(6),console.error("error getting the relations",V.t0),this.handleDriverError(V.t0,P,"Unexpected error while reading relations");case 18:case"end":return V.stop()}},L,this,[[6,14]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleUserDirectorySearch",value:function(){var A=C(I().mark(function L(P){var B;return I().wrap(function(O){for(;;)switch(O.prev=O.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3973UserDirectorySearch)){O.next=2;break}return O.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:if(typeof P.data.search_term=="string"){O.next=4;break}return O.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(P.data.limit!==void 0&&P.data.limit<0)){O.next=6;break}return O.abrupt("return",this.transport.reply(P,{error:{message:"Invalid request - limit out of range"}}));case 6:return O.prev=6,O.next=9,this.driver.searchUserDirectory(P.data.search_term,P.data.limit);case 9:return B=O.sent,O.abrupt("return",this.transport.reply(P,{limited:B.limited,results:B.results.map(function(U){return{user_id:U.userId,display_name:U.displayName,avatar_url:U.avatarUrl}})}));case 13:O.prev=13,O.t0=O.catch(6),console.error("error searching in the user directory",O.t0),this.handleDriverError(O.t0,P,"Unexpected error while searching in the user directory");case 17:case"end":return O.stop()}},L,this,[[6,13]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleGetMediaConfig",value:function(){var A=C(I().mark(function L(P){var B;return I().wrap(function(O){for(;;)switch(O.prev=O.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){O.next=2;break}return O.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return O.prev=2,O.next=5,this.driver.getMediaConfig();case 5:return B=O.sent,O.abrupt("return",this.transport.reply(P,B));case 9:O.prev=9,O.t0=O.catch(2),console.error("error while getting the media configuration",O.t0),this.handleDriverError(O.t0,P,"Unexpected error while getting the media configuration");case 13:case"end":return O.stop()}},L,this,[[2,9]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleUploadFile",value:function(){var A=C(I().mark(function L(P){var B;return I().wrap(function(O){for(;;)switch(O.prev=O.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){O.next=2;break}return O.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return O.prev=2,O.next=5,this.driver.uploadFile(P.data.file);case 5:return B=O.sent,O.abrupt("return",this.transport.reply(P,{content_uri:B.contentUri}));case 9:O.prev=9,O.t0=O.catch(2),console.error("error while uploading a file",O.t0),this.handleDriverError(O.t0,P,"Unexpected error while uploading a file");case 13:case"end":return O.stop()}},L,this,[[2,9]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleDownloadFile",value:function(){var A=C(I().mark(function L(P){var B;return I().wrap(function(O){for(;;)switch(O.prev=O.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039DownloadFile)){O.next=2;break}return O.abrupt("return",this.transport.reply(P,{error:{message:"Missing capability"}}));case 2:return O.prev=2,O.next=5,this.driver.downloadFile(P.data.content_uri);case 5:return B=O.sent,O.abrupt("return",this.transport.reply(P,{file:B.file}));case 9:O.prev=9,O.t0=O.catch(2),console.error("error while downloading a file",O.t0),this.handleDriverError(O.t0,P,"Unexpected error while downloading a file");case 13:case"end":return O.stop()}},L,this,[[2,9]])}));function M(L){return A.apply(this,arguments)}return M}()},{key:"handleDriverError",value:function(M,L,P){var B=this.driver.processError(M);this.transport.reply(L,{error:g({message:P},B)})}},{key:"handleMessage",value:function(M){if(!this.isStopped){var L=new CustomEvent("action:".concat(M.detail.action),{detail:M.detail,cancelable:!0});if(this.emit("action:".concat(M.detail.action),L),!L.defaultPrevented)switch(M.detail.action){case r.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(M.detail);case r.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(M.detail);case r.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(M.detail);case r.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(M.detail);case r.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(M.detail);case r.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(M.detail);case r.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(M.detail);case r.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(M.detail);case r.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(M.detail);case r.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(M.detail);case r.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(M.detail);case r.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(M.detail);case r.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(M.detail);case r.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(M.detail);case r.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(M.detail);case r.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(M.detail);case r.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(M.detail);default:return this.transport.reply(M.detail,{error:{message:"Unknown or unsupported action: "+M.detail.action}})}}}},{key:"updateTheme",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.ThemeChange,M)}},{key:"updateLanguage",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.LanguageChange,{lang:M})}},{key:"takeScreenshot",value:function(){return this.transport.send(r.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.UpdateVisibility,{visible:M})}},{key:"sendWidgetConfig",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.WidgetConfig,M).then()}},{key:"notifyModalWidgetButtonClicked",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.ButtonClicked,{id:M}).then()}},{key:"notifyModalWidgetClose",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.CloseModalWidget,M).then()}},{key:"feedEvent",value:function(){var A=C(I().mark(function L(P,B){var k;return I().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:if(B!==void 0&&this.setViewedRoomId(B),!(P.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(P.room_id))){U.next=3;break}return U.abrupt("return");case 3:if(!(P.state_key!==void 0&&P.state_key!==null)){U.next=8;break}if(this.canReceiveStateEvent(P.type,P.state_key)){U.next=6;break}return U.abrupt("return");case 6:U.next=10;break;case 8:if(this.canReceiveRoomEvent(P.type,(k=P.content)===null||k===void 0?void 0:k.msgtype)){U.next=10;break}return U.abrupt("return");case 10:return U.next=12,this.transport.send(r.WidgetApiToWidgetAction.SendEvent,P);case 12:case"end":return U.stop()}},L,this)}));function M(L,P){return A.apply(this,arguments)}return M}()},{key:"feedToDevice",value:function(){var A=C(I().mark(function L(P,B){return I().wrap(function(O){for(;;)switch(O.prev=O.next){case 0:if(!this.canReceiveToDeviceEvent(P.type)){O.next=3;break}return O.next=3,this.transport.send(r.WidgetApiToWidgetAction.SendToDevice,g(g({},P),{},{encrypted:B}));case 3:case"end":return O.stop()}},L,this)}));function M(L,P){return A.apply(this,arguments)}return M}()},{key:"setViewedRoomId",value:function(M){this.viewedRoomId=M,M!==null&&!this.canUseRoomTimeline(M)&&this.pushRoomState(M)}},{key:"flushRoomState",value:function(){var A=C(I().mark(function L(){var P,B,k,O,U,V,q;return I().wrap(function(te){for(;;)switch(te.prev=te.next){case 0:te.prev=0;case 1:return te.next=3,Promise.all(m(this.pushRoomStateTasks));case 3:if(this.pushRoomStateTasks.size>0){te.next=1;break}case 4:P=[],B=v(this.pushRoomStateResult.values());try{for(B.s();!(k=B.n()).done;){O=k.value,U=v(O.values());try{for(U.s();!(V=U.n()).done;)q=V.value,P.push.apply(P,m(q.values()))}catch($){U.e($)}finally{U.f()}}}catch($){B.e($)}finally{B.f()}return te.next=9,this.getWidgetVersions();case 9:if(!te.sent.includes(s.UnstableApiVersion.MSC2762_UPDATE_STATE)){te.next=12;break}return te.next=12,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:P});case 12:return te.prev=12,this.flushRoomStateTask=null,te.finish(12);case 15:case"end":return te.stop()}},L,this,[[0,,12,15]])}));function M(){return A.apply(this,arguments)}return M}()},{key:"pushRoomState",value:function(M){var L=this,P=v(this.allowedEvents),B;try{var k=function(){var U=B.value;if(U.kind===o.EventKind.State&&U.direction===o.EventDirection.Receive){var V,q,J=L.driver.readRoomState(M,U.eventType,(V=U.keyStr)!==null&&V!==void 0?V:void 0),te=J.then(function($){var ue=v($),ie;try{for(ue.s();!(ie=ue.n()).done;){var Se=ie.value,Y=L.pushRoomStateResult.get(M);Y===void 0&&(Y=new Map,L.pushRoomStateResult.set(M,Y));var pe=Y.get(U.eventType);pe===void 0&&(pe=new Map,Y.set(U.eventType,pe)),pe.has(Se.state_key)||pe.set(Se.state_key,Se)}}catch(Te){ue.e(Te)}finally{ue.f()}},function($){return console.error("Failed to read room state for ".concat(M," (").concat(U.eventType,", ").concat(U.keyStr,")"),$)}).then(function(){L.pushRoomStateTasks.delete(te)});L.pushRoomStateTasks.add(te),(q=L.flushRoomStateTask)!==null&&q!==void 0||(L.flushRoomStateTask=L.flushRoomState()),L.flushRoomStateTask.catch(function($){return console.error("Failed to push room state",$)})}};for(P.s();!(B=P.n()).done;)k()}catch(O){P.e(O)}finally{P.f()}}},{key:"feedStateUpdate",value:function(){var A=C(I().mark(function L(P){var B,k;return I().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:if(P.state_key!==void 0){U.next=2;break}throw new Error("Not a state event");case 2:if(!((P.room_id===this.viewedRoomId||this.canUseRoomTimeline(P.room_id))&&this.canReceiveStateEvent(P.type,P.state_key))){U.next=21;break}if(this.pushRoomStateTasks.size!==0){U.next=11;break}return U.next=6,this.getWidgetVersions();case 6:if(!U.sent.includes(s.UnstableApiVersion.MSC2762_UPDATE_STATE)){U.next=9;break}return U.next=9,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:[P]});case 9:U.next=21;break;case 11:B=this.pushRoomStateResult.get(P.room_id),B===void 0&&(B=new Map,this.pushRoomStateResult.set(P.room_id,B)),k=B.get(P.type),k===void 0&&(k=new Map,B.set(P.type,k)),k.has(P.type)||k.set(P.state_key,P);case 16:return U.next=18,Promise.all(m(this.pushRoomStateTasks));case 18:if(this.pushRoomStateTasks.size>0){U.next=16;break}case 19:return U.next=21,this.flushRoomStateTask;case 21:case"end":return U.stop()}},L,this)}));function M(L){return A.apply(this,arguments)}return M}()}]),N}(i.EventEmitter);return lo.ClientWidgetApi=le,lo}var ja={},hp;function RC(){if(hp)return ja;hp=1,Object.defineProperty(ja,"__esModule",{value:!0}),ja.isErrorResponse=e;function i(t){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},i(t)}function e(t){var r=t.error;return i(r)==="object"&&r!==null&&"message"in r&&typeof r.message=="string"}return ja}var ho={},fp;function TC(){if(fp)return ho;fp=1,Object.defineProperty(ho,"__esModule",{value:!0}),ho.WidgetKind=void 0;var i=function(e){return e.Room="room",e.Account="account",e.Modal="modal",e}({});return ho.WidgetKind=i,ho}var fo={},vp;function IC(){if(vp)return fo;vp=1,Object.defineProperty(fo,"__esModule",{value:!0}),fo.ModalButtonKind=void 0;var i=function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e}({});return fo.ModalButtonKind=i,fo}var qa={},gp;function zS(){if(gp)return qa;gp=1,Object.defineProperty(qa,"__esModule",{value:!0}),qa.isValidUrl=i;function i(e){if(!e)return!1;try{var t=new URL(e);return!(t.protocol!=="http"&&t.protocol!=="https")}catch(r){if(r instanceof TypeError)return!1;throw r}}return qa}var Va={},pp;function JS(){if(pp)return Va;pp=1,Object.defineProperty(Va,"__esModule",{value:!0}),Va.assertPresent=i;function i(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}return Va}var vo={},mp;function YS(){if(mp)return vo;mp=1,Object.defineProperty(vo,"__esModule",{value:!0}),vo.Widget=void 0;var i=JS(),e=au();function t(u){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(c){return typeof c}:function(c){return c&&typeof Symbol=="function"&&c.constructor===Symbol&&c!==Symbol.prototype?"symbol":typeof c},t(u)}function r(u,c){if(!(u instanceof c))throw new TypeError("Cannot call a class as a function")}function n(u,c){for(var d=0;d<c.length;d++){var h=c[d];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(u,o(h.key),h)}}function s(u,c,d){return c&&n(u.prototype,c),Object.defineProperty(u,"prototype",{writable:!1}),u}function o(u){var c=a(u,"string");return t(c)==="symbol"?c:String(c)}function a(u,c){if(t(u)!=="object"||u===null)return u;var d=u[Symbol.toPrimitive];if(d!==void 0){var h=d.call(u,c);if(t(h)!=="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(u)}var l=function(){function u(c){if(r(this,u),this.definition=c,!this.definition)throw new Error("Definition is required");(0,i.assertPresent)(c,"id"),(0,i.assertPresent)(c,"creatorUserId"),(0,i.assertPresent)(c,"type"),(0,i.assertPresent)(c,"url")}return s(u,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(d){return(0,e.runTemplate)(this.templateUrl,this.definition,d)}}]),u}();return vo.Widget=l,vo}var go={},yp;function CC(){if(yp)return go;yp=1,Object.defineProperty(go,"__esModule",{value:!0}),go.WidgetParser=void 0;var i=YS(),e=zS();function t(h){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},t(h)}function r(h,g){var v=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(!v){if(Array.isArray(h)||(v=n(h))||g){v&&(h=v);var m=0,E=function(){};return{s:E,n:function(){return m>=h.length?{done:!0}:{done:!1,value:h[m++]}},e:function(I){throw I},f:E}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var R=!0,_=!1,T;return{s:function(){v=v.call(h)},n:function(){var I=v.next();return R=I.done,I},e:function(I){_=!0,T=I},f:function(){try{!R&&v.return!=null&&v.return()}finally{if(_)throw T}}}}function n(h,g){if(h){if(typeof h=="string")return s(h,g);var v=Object.prototype.toString.call(h).slice(8,-1);if(v==="Object"&&h.constructor&&(v=h.constructor.name),v==="Map"||v==="Set")return Array.from(h);if(v==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(v))return s(h,g)}}function s(h,g){(g==null||g>h.length)&&(g=h.length);for(var v=0,m=new Array(g);v<g;v++)m[v]=h[v];return m}function o(h,g){if(!(h instanceof g))throw new TypeError("Cannot call a class as a function")}function a(h,g){for(var v=0;v<g.length;v++){var m=g[v];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(h,u(m.key),m)}}function l(h,g,v){return v&&a(h,v),Object.defineProperty(h,"prototype",{writable:!1}),h}function u(h){var g=c(h,"string");return t(g)==="symbol"?g:String(g)}function c(h,g){if(t(h)!=="object"||h===null)return h;var v=h[Symbol.toPrimitive];if(v!==void 0){var m=v.call(h,g);if(t(m)!=="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(h)}var d=function(){function h(){o(this,h)}return l(h,null,[{key:"parseAccountData",value:function(v){if(!v)return[];for(var m=[],E=0,R=Object.keys(v);E<R.length;E++){var _=R[E],T=v[_];if(T&&!(T.type!=="m.widget"&&T.type!=="im.vector.modular.widgets")&&T.sender){var b=T.state_key||T.id;if(b===_){var I={content:T.content,sender:T.sender,type:"m.widget",state_key:_,event_id:"$example",room_id:"!example",origin_server_ts:1},y=h.parseRoomWidget(I);y&&m.push(y)}}}return m}},{key:"parseWidgetsFromRoomState",value:function(v){if(!v)return[];var m=[],E=r(v),R;try{for(E.s();!(R=E.n()).done;){var _=R.value,T=h.parseRoomWidget(_);T&&m.push(T)}}catch(b){E.e(b)}finally{E.f()}return m}},{key:"parseRoomWidget",value:function(v){if(!v||v.type!=="m.widget"&&v.type!=="im.vector.modular.widgets")return null;var m=v.content||{},E={id:v.state_key,creatorUserId:m.creatorUserId||v.sender,name:m.name,type:m.type,url:m.url,waitForIframeLoad:m.waitForIframeLoad,data:m.data};return h.processEstimatedWidget(E)}},{key:"processEstimatedWidget",value:function(v){return!v.id||!v.creatorUserId||!v.type||!(0,e.isValidUrl)(v.url)?null:new i.Widget(v)}}]),h}();return go.WidgetParser=d,go}var po={},Sp;function kC(){if(Sp)return po;Sp=1,Object.defineProperty(po,"__esModule",{value:!0}),po.runTemplate=i,po.toString=e;function i(t,r,n){for(var s=Object.assign({},r.data,{matrix_room_id:n.widgetRoomId||"",matrix_user_id:n.currentUserId,matrix_display_name:n.userDisplayName||n.currentUserId,matrix_avatar_url:n.userHttpAvatarUrl||"",matrix_widget_id:r.id,"org.matrix.msc2873.client_id":n.clientId||"","org.matrix.msc2873.client_theme":n.clientTheme||"","org.matrix.msc2873.client_language":n.clientLanguage||"","org.matrix.msc3819.matrix_device_id":n.deviceId||"","org.matrix.msc4039.matrix_base_url":n.baseUrl||""}),o=t,a=0,l=Object.keys(s);a<l.length;a++){var u=l[a],c="$".concat(u).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp(c,"g");o=o.replace(d,encodeURIComponent(e(s[u])))}return o}function e(t){return t==null?"".concat(t):String(t)}return po}var mo={},_p;function OC(){if(_p)return mo;_p=1,Object.defineProperty(mo,"__esModule",{value:!0}),mo.WidgetDriver=void 0;var i=au();function e(l){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(u){return typeof u}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u},e(l)}function t(l,u){if(!(l instanceof u))throw new TypeError("Cannot call a class as a function")}function r(l,u){for(var c=0;c<u.length;c++){var d=u[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(l,s(d.key),d)}}function n(l,u,c){return u&&r(l.prototype,u),Object.defineProperty(l,"prototype",{writable:!1}),l}function s(l){var u=o(l,"string");return e(u)==="symbol"?u:String(u)}function o(l,u){if(e(l)!=="object"||l===null)return l;var c=l[Symbol.toPrimitive];if(c!==void 0){var d=c.call(l,u);if(e(d)!=="object")return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}var a=function(){function l(){t(this,l)}return n(l,[{key:"validateCapabilities",value:function(c){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(c,d){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedEvent",value:function(c,d,h,g){return Promise.reject(new Error("Failed to override function"))}},{key:"updateDelayedEvent",value:function(c,d){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(c,d,h){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(c){return Promise.resolve([])}},{key:"readRoomEvents",value:function(c,d,h){return Promise.resolve([])}},{key:"readStateEvents",value:function(c,d,h){return Promise.resolve([])}},{key:"readRoomTimeline",value:function(c,d,h,g,v,m){return g===void 0?this.readRoomEvents(d,h,v,[c],m):this.readStateEvents(d,g,v,[c])}},{key:"readRoomState",value:function(c,d,h){return this.readStateEvents(d,h,Number.MAX_SAFE_INTEGER,[c])}},{key:"readEventRelations",value:function(c,d,h,g,v,m,E,R){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(c){c.update({state:i.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(c){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(c,d){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(c){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(c){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(c){}}]),l}();return mo.WidgetDriver=a,mo}var bp;function au(){return bp||(bp=1,function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=EC();Object.keys(e).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===e[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return e[w]}})});var t=wC();Object.keys(t).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===t[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return t[w]}})});var r=Uh();Object.keys(r).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===r[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return r[w]}})});var n=Ph();Object.keys(n).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===n[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return n[w]}})});var s=VS();Object.keys(s).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===s[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return s[w]}})});var o=RC();Object.keys(o).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===o[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return o[w]}})});var a=Mh();Object.keys(a).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===a[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return a[w]}})});var l=kh();Object.keys(l).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===l[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return l[w]}})});var u=Oh();Object.keys(u).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===u[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return u[w]}})});var c=GS();Object.keys(c).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===c[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return c[w]}})});var d=Ah();Object.keys(d).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===d[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return d[w]}})});var h=TC();Object.keys(h).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===h[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return h[w]}})});var g=IC();Object.keys(g).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===g[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return g[w]}})});var v=WS();Object.keys(v).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===v[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return v[w]}})});var m=$S();Object.keys(m).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===m[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return m[w]}})});var E=Dh();Object.keys(E).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===E[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return E[w]}})});var R=zS();Object.keys(R).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===R[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return R[w]}})});var _=JS();Object.keys(_).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===_[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return _[w]}})});var T=YS();Object.keys(T).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===T[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return T[w]}})});var b=CC();Object.keys(b).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===b[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return b[w]}})});var I=kC();Object.keys(I).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===I[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return I[w]}})});var y=HS();Object.keys(y).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===y[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return y[w]}})});var C=OC();Object.keys(C).forEach(function(w){w==="default"||w==="__esModule"||w in i&&i[w]===C[w]||Object.defineProperty(i,w,{enumerable:!0,get:function(){return C[w]}})})}(oc)),oc}var yo=au();function PC(i){var e,t,r,n=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,r=Symbol.iterator);n--;){if(t&&(e=i[t])!=null)return e.call(i);if(r&&(e=i[r])!=null)return new il(e.call(i));t="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function il(i){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var r=t.done;return Promise.resolve(t.value).then(function(n){return{value:n,done:r}})}return il=function(r){this.s=r,this.n=r.next},il.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(r){var n=this.s.return;return n===void 0?Promise.resolve({value:r,done:!0}):e(n.apply(this.s,arguments))},throw:function(r){var n=this.s.return;return n===void 0?Promise.reject(r):e(n.apply(this.s,arguments))}},new il(i)}class QS extends si{constructor(e,t,r,n,s){var o,a,l,u,c,d,h,g,v,m,E;super(n),o=this,this.widgetApi=e,this.capabilities=t,this.roomId=r,f(this,"room",void 0),f(this,"widgetApiReady",void 0),f(this,"lifecycle",void 0),f(this,"syncState",null),f(this,"onEvent",function(){var R=S(function*(_){if(_.preventDefault(),_.detail.data.room_id===o.roomId){var T=new Ot(_.detail.data);yield o.syncApi.injectRoomEvents(o.room,[],[T]),o.emit(_e.Event,T),o.setSyncState($e.Syncing),p.info("Received event ".concat(T.getId()," ").concat(T.getType()," ").concat(T.getStateKey()))}else{var{event_id:b,room_id:I}=_.detail.data;p.info("Received event ".concat(b," for a different room ").concat(I,"; discarding"))}yield o.ack(_)});return function(_){return R.apply(this,arguments)}}()),f(this,"onToDevice",function(){var R=S(function*(_){_.preventDefault();var T=new Ot({type:_.detail.data.type,sender:_.detail.data.sender,content:_.detail.data.content});_.detail.data.encrypted&&T.makeEncrypted(F.RoomMessageEncrypted,{},"",""),o.emit(_e.ToDeviceEvent,T),o.setSyncState($e.Syncing),yield o.ack(_)});return function(_){return R.apply(this,arguments)}}()),this.widgetApiReady=new Promise(R=>this.widgetApi.once("ready",R)),((a=t.sendEvent)!==null&&a!==void 0&&a.length||(l=t.receiveEvent)!==null&&l!==void 0&&l.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(u=t.sendState)!==null&&u!==void 0&&u.length||(c=t.receiveState)!==null&&c!==void 0&&c.length)&&e.requestCapabilityForRoomTimeline(r),(d=t.sendEvent)===null||d===void 0||d.forEach(R=>e.requestCapabilityToSendEvent(R)),(h=t.receiveEvent)===null||h===void 0||h.forEach(R=>e.requestCapabilityToReceiveEvent(R)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(R=>e.requestCapabilityToSendMessage(R)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(R=>e.requestCapabilityToReceiveMessage(R)),(g=t.sendState)===null||g===void 0||g.forEach(R=>{var{eventType:_,stateKey:T}=R;return e.requestCapabilityToSendState(_,T)}),(v=t.receiveState)===null||v===void 0||v.forEach(R=>{var{eventType:_,stateKey:T}=R;return e.requestCapabilityToReceiveState(_,T)}),(m=t.sendToDevice)===null||m===void 0||m.forEach(R=>e.requestCapabilityToSendToDevice(R)),(E=t.receiveToDevice)===null||E===void 0||E.forEach(R=>e.requestCapabilityToReceiveToDevice(R)),t.turnServers&&e.requestCapability(yo.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(yo.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(yo.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.start(),s&&e.sendContentLoaded()}startClient(){var e=arguments,t=this;return S(function*(){var r,n,s=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var o=t.getUserId();o&&t.store.storeUser(new En(o)),s.slidingSync?t.syncApi=new LS(s.slidingSync,t,s,t.buildSyncApiOptions()):t.syncApi=new bo(t,s,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield Promise.all((r=(n=t.capabilities.receiveState)===null||n===void 0?void 0:n.map(function(){var a=S(function*(l){var{eventType:u,stateKey:c}=l,d=yield t.widgetApi.readStateEvents(u,void 0,c,[t.roomId]),h=d.map(g=>new Ot(g));yield t.syncApi.injectRoomEvents(t.room,[],h),h.forEach(g=>{t.emit(_e.Event,g),p.info("Backfilled event ".concat(g.getId()," ").concat(g.getType()," ").concat(g.getStateKey()))})});return function(l){return a.apply(this,arguments)}}()))!==null&&r!==void 0?r:[]),t.setSyncState($e.Syncing),p.info("Finished backfilling events"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(yo.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(yo.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return S(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t){var r=this;return S(function*(){var n;try{n=yield r.widgetApi.sendRoomEvent(t.getType(),t.getContent(),e.roomId)}catch(s){throw r.updatePendingEventStatus(e,t,Re.NOT_SENT),s}return e.updatePendingEvent(t,Re.SENT,n.event_id),{event_id:n.event_id}})()}sendStateEvent(e,t,r){var n=arguments,s=this;return S(function*(){var o=n.length>3&&n[3]!==void 0?n[3]:"";return yield s.widgetApi.sendStateEvent(t,o,r,e)})()}sendToDevice(e,t){var r=this;return S(function*(){return yield r.widgetApi.sendToDevice(e,!1,Ui(t)),{}})()}getOpenIdToken(){var e=this;return S(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken();return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return S(function*(){var{eventType:r,batch:n}=e,s=new ht(()=>new Map);for(var{userId:o,deviceId:a,payload:l}of n)s.getOrCreate(o).set(a,l);yield t.widgetApi.sendToDevice(r,!1,Ui(s))})()}encryptAndSendToDevices(e,t){var r=this;return S(function*(){var n=new ht(()=>new Map);for(var{userId:s,deviceInfo:{deviceId:o}}of e)n.getOrCreate(s).set(o,t);yield r.widgetApi.sendToDevice(t.type,!0,Ui(n))})()}checkTurnServers(){var e=this;return S(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(_e.Sync,e,t)}ack(e){var t=this;return S(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return S(function*(){var t=e.widgetApi.getTurnServers(),r=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",r);try{var n=!1,s=!1,o;try{for(var a=PC(t),l;n=!(l=yield a.next()).done;n=!1){var u=l.value;e.turnServers=[{urls:u.uris,username:u.username,credential:u.password}],e.emit(_e.TurnServers,e.turnServers),p.log("Received TURN server: ".concat(u.uris))}}catch(c){s=!0,o=c}finally{try{n&&a.return!=null&&(yield a.return())}finally{if(s)throw o}}}catch(c){p.warn("Error watching TURN servers",c)}finally{e.lifecycle.signal.removeEventListener("abort",r)}})()}}class MC{constructor(){f(this,"unthreadedReadReceipts",new Map),f(this,"threadedReadReceipts",new ht(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e==null||e.forEach(t=>{t.type!==F.Receipt||!t.content||Object.keys(t.content).forEach(r=>{Object.entries(t.content[r]).forEach(n=>{var[s,o]=n;if(oh(s))for(var a of Object.keys(o)){var l=t.content[r][s][a],u={data:t.content[r][s][a],type:s,eventId:r};l.thread_id?this.setThreaded(l.thread_id,a,u):this.setUnthreaded(a,u)}})})})}buildAccumulatedReceiptEvent(e){var t={type:F.Receipt,room_id:e,content:{}},r=new ht(()=>new ht(()=>new Map));for(var[n,s]of this.allUnthreaded())r.getOrCreate(s.eventId).getOrCreate(s.type).set(n,s.data);for(var[o,a]of this.allThreaded())r.getOrCreate(a.eventId).getOrCreate(a.type).set(o,a.data);return t.content=Ui(r),r.size>0?t:null}}var un=function(i){return i.Invite="invite",i.Leave="leave",i.Join="join",i.Knock="knock",i}({});function AC(i){return"_localTs"in i&&i._localTs!==void 0}class XS{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,f(this,"accountData",{}),f(this,"inviteRooms",{}),f(this,"knockRooms",{}),f(this,"joinRooms",{}),f(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(r=>{this.accumulateRoom(r,un.Invite,e.rooms.invite[r],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(r=>{this.accumulateRoom(r,un.Join,e.rooms.join[r],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(r=>{this.accumulateRoom(r,un.Leave,e.rooms.leave[r],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(r=>{this.accumulateRoom(r,un.Knock,e.rooms.knock[r],t)}))}accumulateRoom(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case un.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case un.Knock:this.accumulateKnockState(e,r);break;case un.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case un.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:p.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var r=this.inviteRooms[e];t.invite_state.events.forEach(n=>{for(var s=!1,o=0;o<r.invite_state.events.length;o++){var a=r.invite_state.events[o];a.type===n.type&&a.state_key==n.state_key&&(r.invite_state.events[o]=n,s=!0)}s||r.invite_state.events.push(n)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var r=this.knockRooms[e];t.knock_state.events.forEach(n=>{for(var s=!1,o=0;o<r.knock_state.events.length;o++){var a=r.knock_state.events[o];a.type===n.type&&a.state_key==n.state_key&&(r.knock_state.events[o]=n,s=!0)}s||r.knock_state.events.push(n)})}}accumulateJoinState(e,t){var r,n,s,o,a,l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new MC});var u=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(b=>{u._accountData[b.type]=b}),t.unread_notifications&&(u._unreadNotifications=t.unread_notifications),u._unreadThreadNotifications=(r=(n=t[ra.stable])!==null&&n!==void 0?n:t[ra.unstable])!==null&&r!==void 0?r:void 0,t.summary){var c,d,h,g="m.heroes",v="m.invited_member_count",m="m.joined_member_count",E=u._summary,R=t.summary;E[g]=(c=R[g])!==null&&c!==void 0?c:E[g],E[m]=(d=R[m])!==null&&d!==void 0?d:E[m],E[v]=(h=R[v])!==null&&h!==void 0?h:E[v]}if(u._receipts.consumeEphemeralEvents((s=t.ephemeral)===null||s===void 0?void 0:s.events),t.timeline&&t.timeline.limited&&(u._timeline=[]),(o=t.state)===null||o===void 0||(o=o.events)===null||o===void 0||o.forEach(b=>{ac(u._currentState,b)}),(a=t.timeline)===null||a===void 0||(a=a.events)===null||a===void 0||a.forEach((b,I)=>{var y;ac(u._currentState,b);var C;if(l)C=b;else{var w;C=Object.assign({},b),C.unsigned!==void 0&&(C.unsigned=Object.assign({},C.unsigned));var D=(w=b.unsigned)===null||w===void 0?void 0:w.age;D!==void 0&&(C._localTs=Date.now()-D)}u._timeline.push({event:C,token:I===0&&(y=t.timeline.prev_batch)!==null&&y!==void 0?y:null})}),u._timeline.length>this.opts.maxTimelineEntries){for(var _=u._timeline.length-this.opts.maxTimelineEntries,T=_;T<u._timeline.length;T++)if(u._timeline[T].token){u._timeline=u._timeline.slice(T,u._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(n=>{t.invite[n]=this.inviteRooms[n]}),Object.keys(this.knockRooms).forEach(n=>{t.knock[n]=this.knockRooms[n]}),Object.keys(this.joinRooms).forEach(n=>{var s=this.joinRooms[n],o={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:s._unreadNotifications,unread_thread_notifications:s._unreadThreadNotifications,summary:s._summary};Object.keys(s._accountData).forEach(h=>{o.account_data.events.push(s._accountData[h])});var a=s._receipts.buildAccumulatedReceiptEvent(n);a&&o.ephemeral.events.push(a),s._timeline.forEach(h=>{if(!o.timeline.prev_batch){if(!h.token)return;o.timeline.prev_batch=h.token}var g;!e&&AC(h.event)?(g=Object.assign({},h.event),g.unsigned!==void 0&&(g.unsigned=Object.assign({},g.unsigned)),delete g._localTs,g.unsigned=g.unsigned||{},g.unsigned.age=Date.now()-h.event._localTs):g=h.event,o.timeline.events.push(g)});for(var l=Object.create(null),u=o.timeline.events.length-1;u>=0;u--){var c=o.timeline.events[u];if(!(c.state_key===null||c.state_key===void 0)){var d=Jl(c);d.unsigned&&(d.unsigned.prev_content&&(d.content=d.unsigned.prev_content),d.unsigned.prev_sender&&(d.sender=d.unsigned.prev_sender)),ac(l,d)}}Object.keys(s._currentState).forEach(h=>{Object.keys(s._currentState[h]).forEach(g=>{var v=s._currentState[h][g];l[h]&&l[h][g]&&(v=l[h][g]),o.state.events.push(v)})}),t.join[n]=o});var r=[];return Object.keys(this.accountData).forEach(n=>{r.push(this.accountData[n])}),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function ac(i,e){e.state_key===null||e.state_key===void 0||!e.type||(i[e.type]||(i[e.type]=Object.create(null)),i[e.type][e.state_key]=e)}class Ro extends Error{}Ro.prototype.name="InvalidTokenError";function DC(i){return decodeURIComponent(atob(i).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function UC(i){let e=i.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return DC(e)}catch{return atob(e)}}function ZS(i,e){if(typeof i!="string")throw new Ro("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,r=i.split(".")[t];if(typeof r!="string")throw new Ro(`Invalid token specified: missing part #${t+1}`);let n;try{n=UC(r)}catch(s){throw new Ro(`Invalid token specified: invalid base64 for part #${t+1} (${s.message})`)}try{return JSON.parse(n)}catch(s){throw new Ro(`Invalid token specified: invalid json for part #${t+1} (${s.message})`)}}var LC={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},Gr,Hr,ca=(i=>(i[i.NONE=0]="NONE",i[i.ERROR=1]="ERROR",i[i.WARN=2]="WARN",i[i.INFO=3]="INFO",i[i.DEBUG=4]="DEBUG",i))(ca||{});(i=>{function e(){Gr=3,Hr=LC}i.reset=e;function t(n){if(!(0<=n&&n<=4))throw new Error("Invalid log level");Gr=n}i.setLevel=t;function r(n){Hr=n}i.setLogger=r})(ca||(ca={}));var mt=class jr{constructor(e){this._name=e}debug(...e){Gr>=4&&Hr.debug(jr._format(this._name,this._method),...e)}info(...e){Gr>=3&&Hr.info(jr._format(this._name,this._method),...e)}warn(...e){Gr>=2&&Hr.warn(jr._format(this._name,this._method),...e)}error(...e){Gr>=1&&Hr.error(jr._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const r=new jr(`${e}.${t}`);return r.debug("begin"),r}static _format(e,t){const r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(e,...t){Gr>=4&&Hr.debug(jr._format(e),...t)}static info(e,...t){Gr>=3&&Hr.info(jr._format(e),...t)}static warn(e,...t){Gr>=2&&Hr.warn(jr._format(e),...t)}static error(e,...t){Gr>=1&&Hr.error(jr._format(e),...t)}};ca.reset();var Ol=class{static decode(i){try{return ZS(i)}catch(e){throw mt.error("JwtUtils.decode",e),e}}static async generateSignedJwt(i,e,t){const r=Ur.encodeBase64Url(new TextEncoder().encode(JSON.stringify(i))),n=Ur.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),s=`${r}.${n}`,o=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new TextEncoder().encode(s)),a=Ur.encodeBase64Url(new Uint8Array(o));return`${s}.${a}`}},NC="10000000-1000-4000-8000-100000000000",wd=i=>btoa([...new Uint8Array(i)].map(e=>String.fromCharCode(e)).join("")),e_=class qr{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return NC.replace(/[018]/g,t=>(+t^qr._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return qr.generateUUIDv4()+qr.generateUUIDv4()+qr.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const r=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",r);return wd(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw mt.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const n=new TextEncoder().encode([e,t].join(":"));return wd(n)}static async hash(e,t){const r=new TextEncoder().encode(t),n=await crypto.subtle.digest(e,r);return new Uint8Array(n)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const r=await qr.hash("SHA-256",JSON.stringify(t));return qr.encodeBase64Url(r)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:r,keyPair:n,nonce:s}){let o,a;const l={jti:window.crypto.randomUUID(),htm:r??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(o=await qr.hash("SHA-256",t),a=qr.encodeBase64Url(o),l.ath=a),s&&(l.nonce=s);try{const u=await crypto.subtle.exportKey("jwk",n.publicKey),c={alg:"ES256",typ:"dpop+jwt",jwk:{crv:u.crv,kty:u.kty,x:u.x,y:u.y}};return await Ol.generateSignedJwt(c,l,n.privateKey)}catch(u){throw u instanceof TypeError?new Error(`Error exporting dpop public key: ${u.message}`):u}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await qr.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}};e_.encodeBase64Url=i=>wd(i).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var Ur=e_,xC=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new mt(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},Pl=class sl extends xC{constructor(){super(...arguments),this._logger=new mt(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-sl.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=sl.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const r=sl.getEpochTime()+e;if(this.expiration===r&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=r;const n=Math.min(e,5);this._timerHandle=setInterval(this._callback,n*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},Ep=class{static readParams(i,e="query"){if(!i)throw new TypeError("Invalid URL");const r=new URL(i,"http://127.0.0.1")[e==="fragment"?"hash":"search"];return new URLSearchParams(r.slice(1))}},Rd=";",da=class extends Error{constructor(i,e){var t,r,n;if(super(i.error_description||i.error||""),this.form=e,this.name="ErrorResponse",!i.error)throw mt.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=i.error,this.error_description=(t=i.error_description)!=null?t:null,this.error_uri=(r=i.error_uri)!=null?r:null,this.state=i.userState,this.session_state=(n=i.session_state)!=null?n:null,this.url_state=i.url_state}},KC=class extends Error{constructor(i){super(i),this.name="ErrorTimeout"}},FC=class{constructor(){this._logger=new mt("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(i){return this._logger.create(`getItem('${i}')`),this._data[i]}setItem(i,e){this._logger.create(`setItem('${i}')`),this._data[i]=e}removeItem(i){this._logger.create(`removeItem('${i}')`),delete this._data[i]}get length(){return Object.getOwnPropertyNames(this._data).length}key(i){return Object.getOwnPropertyNames(this._data)[i]}},Td=class extends Error{constructor(i,e){super(e),this.name="ErrorDPoPNonce",this.nonce=i}},Lh=class{constructor(i=[],e=null,t={}){this._jwtHandler=e,this._extraHeaders=t,this._logger=new mt("JsonService"),this._contentTypes=[],this._contentTypes.push(...i,"application/json"),e&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(i,e={}){const{timeoutInSeconds:t,...r}=e;if(!t)return await fetch(i,r);const n=new AbortController,s=setTimeout(()=>n.abort(),t*1e3);try{return await fetch(i,{...e,signal:n.signal})}catch(o){throw o instanceof DOMException&&o.name==="AbortError"?new KC("Network timed out"):o}finally{clearTimeout(s)}}async getJson(i,{token:e,credentials:t,timeoutInSeconds:r}={}){const n=this._logger.create("getJson"),s={Accept:this._contentTypes.join(", ")};e&&(n.debug("token passed, setting Authorization header"),s.Authorization="Bearer "+e),this.appendExtraHeaders(s);let o;try{n.debug("url:",i),o=await this.fetchWithTimeout(i,{method:"GET",headers:s,timeoutInSeconds:r,credentials:t})}catch(u){throw n.error("Network Error"),u}n.debug("HTTP response received, status",o.status);const a=o.headers.get("Content-Type");if(a&&!this._contentTypes.find(u=>a.startsWith(u))&&n.throw(new Error(`Invalid response Content-Type: ${a??"undefined"}, from URL: ${i}`)),o.ok&&this._jwtHandler&&(a!=null&&a.startsWith("application/jwt")))return await this._jwtHandler(await o.text());let l;try{l=await o.json()}catch(u){throw n.error("Error parsing JSON response",u),o.ok?u:new Error(`${o.statusText} (${o.status})`)}if(!o.ok)throw n.error("Error from server:",l),l.error?new da(l):new Error(`${o.statusText} (${o.status}): ${JSON.stringify(l)}`);return l}async postForm(i,{body:e,basicAuth:t,timeoutInSeconds:r,initCredentials:n,extraHeaders:s}){const o=this._logger.create("postForm"),a={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...s};t!==void 0&&(a.Authorization="Basic "+t),this.appendExtraHeaders(a);let l;try{o.debug("url:",i),l=await this.fetchWithTimeout(i,{method:"POST",headers:a,body:e,timeoutInSeconds:r,credentials:n})}catch(h){throw o.error("Network error"),h}o.debug("HTTP response received, status",l.status);const u=l.headers.get("Content-Type");if(u&&!this._contentTypes.find(h=>u.startsWith(h)))throw new Error(`Invalid response Content-Type: ${u??"undefined"}, from URL: ${i}`);const c=await l.text();let d={};if(c)try{d=JSON.parse(c)}catch(h){throw o.error("Error parsing JSON response",h),l.ok?h:new Error(`${l.statusText} (${l.status})`)}if(!l.ok){if(o.error("Error from server:",d),l.headers.has("dpop-nonce")){const h=l.headers.get("dpop-nonce");throw new Td(h,`${JSON.stringify(d)}`)}throw d.error?new da(d,e):new Error(`${l.statusText} (${l.status}): ${JSON.stringify(d)}`)}return d}appendExtraHeaders(i){const e=this._logger.create("appendExtraHeaders"),t=Object.keys(this._extraHeaders),r=["authorization","accept","content-type"];t.length!==0&&t.forEach(n=>{if(r.includes(n.toLocaleLowerCase())){e.warn("Protected header could not be overridden",n,r);return}const s=typeof this._extraHeaders[n]=="function"?this._extraHeaders[n]():this._extraHeaders[n];s&&s!==""&&(i[n]=s)})}},t_=class{constructor(i){this._settings=i,this._logger=new mt("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new Lh(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const i=this._logger.create("getMetadata");if(this._metadata)return i.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw i.throw(new Error("No authority or metadataUrl configured on settings")),null;i.debug("getting metadata from",this._metadataUrl);const e=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return i.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},this._settings.metadataSeed,e),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(i=!0){return this._getMetadataProperty("token_endpoint",i)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(i=!0){return this._getMetadataProperty("revocation_endpoint",i)}getKeysEndpoint(i=!0){return this._getMetadataProperty("jwks_uri",i)}async _getMetadataProperty(i,e=!1){const t=this._logger.create(`_getMetadataProperty('${i}')`),r=await this.getMetadata();if(t.debug("resolved"),r[i]===void 0){if(e===!0){t.warn("Metadata does not contain optional property");return}t.throw(new Error("Metadata does not contain property "+i))}return r[i]}async getSigningKeys(){const i=this._logger.create("getSigningKeys");if(this._signingKeys)return i.debug("returning signingKeys from cache"),this._signingKeys;const e=await this.getKeysEndpoint(!1);i.debug("got jwks_uri",e);const t=await this._jsonService.getJson(e,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(i.debug("got key set",t),!Array.isArray(t.keys))throw i.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=t.keys,this._signingKeys}},lu=class{constructor({prefix:i="oidc.",store:e=localStorage}={}){this._logger=new mt("WebStorageStateStore"),this._store=e,this._prefix=i}async set(i,e){this._logger.create(`set('${i}')`),i=this._prefix+i,await this._store.setItem(i,e)}async get(i){return this._logger.create(`get('${i}')`),i=this._prefix+i,await this._store.getItem(i)}async remove(i){this._logger.create(`remove('${i}')`),i=this._prefix+i;const e=await this._store.getItem(i);return await this._store.removeItem(i),e}async getAllKeys(){this._logger.create("getAllKeys");const i=await this._store.length,e=[];for(let t=0;t<i;t++){const r=await this._store.key(t);r&&r.indexOf(this._prefix)===0&&e.push(r.substr(this._prefix.length))}return e}},BC="code",jC="openid",qC="client_secret_post",VC=60*15,Id=class{constructor({authority:i,metadataUrl:e,metadata:t,signingKeys:r,metadataSeed:n,client_id:s,client_secret:o,response_type:a=BC,scope:l=jC,redirect_uri:u,post_logout_redirect_uri:c,client_authentication:d=qC,prompt:h,display:g,max_age:v,ui_locales:m,acr_values:E,resource:R,response_mode:_,filterProtocolClaims:T=!0,loadUserInfo:b=!1,requestTimeoutInSeconds:I,staleStateAgeInSeconds:y=VC,mergeClaimsStrategy:C={array:"replace"},disablePKCE:w=!1,stateStore:D,revokeTokenAdditionalContentTypes:x,fetchRequestCredentials:G,refreshTokenAllowedScope:oe,extraQueryParams:de={},extraTokenParams:Ee={},extraHeaders:X={},dpop:re,omitScopeWhenRequesting:Z=!1}){var ne;if(this.authority=i,e?this.metadataUrl=e:(this.metadataUrl=i,i&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=t,this.metadataSeed=n,this.signingKeys=r,this.client_id=s,this.client_secret=o,this.response_type=a,this.scope=l,this.redirect_uri=u,this.post_logout_redirect_uri=c,this.client_authentication=d,this.prompt=h,this.display=g,this.max_age=v,this.ui_locales=m,this.acr_values=E,this.resource=R,this.response_mode=_,this.filterProtocolClaims=T??!0,this.loadUserInfo=!!b,this.staleStateAgeInSeconds=y,this.mergeClaimsStrategy=C,this.omitScopeWhenRequesting=Z,this.disablePKCE=!!w,this.revokeTokenAdditionalContentTypes=x,this.fetchRequestCredentials=G||"same-origin",this.requestTimeoutInSeconds=I,D)this.stateStore=D;else{const ce=typeof window<"u"?window.localStorage:new FC;this.stateStore=new lu({store:ce})}if(this.refreshTokenAllowedScope=oe,this.extraQueryParams=de,this.extraTokenParams=Ee,this.extraHeaders=X,this.dpop=re,this.dpop&&!((ne=this.dpop)!=null&&ne.store))throw new Error("A DPoPStore is required when dpop is enabled")}},WC=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new mt("UserInfoService"),this._getClaimsFromJwt=async t=>{const r=this._logger.create("_getClaimsFromJwt");try{const n=Ol.decode(t);return r.debug("JWT decoding successful"),n}catch(n){throw r.error("Error parsing JWT response"),n}},this._jsonService=new Lh(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(i){const e=this._logger.create("getClaims");i||this._logger.throw(new Error("No token passed"));const t=await this._metadataService.getUserInfoEndpoint();e.debug("got userinfo url",t);const r=await this._jsonService.getJson(t,{token:i,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("got claims",r),r}},r_=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new mt("TokenClient"),this._jsonService=new Lh(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:i="authorization_code",redirect_uri:e=this._settings.redirect_uri,client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,extraHeaders:n,...s}){const o=this._logger.create("exchangeCode");t||o.throw(new Error("A client_id is required")),e||o.throw(new Error("A redirect_uri is required")),s.code||o.throw(new Error("A code is required"));const a=new URLSearchParams({grant_type:i,redirect_uri:e});for(const[d,h]of Object.entries(s))h!=null&&a.set(d,h);let l;switch(this._settings.client_authentication){case"client_secret_basic":if(!r)throw o.throw(new Error("A client_secret is required")),null;l=Ur.generateBasicAuth(t,r);break;case"client_secret_post":a.append("client_id",t),r&&a.append("client_secret",r);break}const u=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const c=await this._jsonService.postForm(u,{body:a,basicAuth:l,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return o.debug("got response"),c}async exchangeCredentials({grant_type:i="password",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,scope:r=this._settings.scope,...n}){const s=this._logger.create("exchangeCredentials");e||s.throw(new Error("A client_id is required"));const o=new URLSearchParams({grant_type:i});this._settings.omitScopeWhenRequesting||o.set("scope",r);for(const[c,d]of Object.entries(n))d!=null&&o.set(c,d);let a;switch(this._settings.client_authentication){case"client_secret_basic":if(!t)throw s.throw(new Error("A client_secret is required")),null;a=Ur.generateBasicAuth(e,t);break;case"client_secret_post":o.append("client_id",e),t&&o.append("client_secret",t);break}const l=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const u=await this._jsonService.postForm(l,{body:o,basicAuth:a,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return s.debug("got response"),u}async exchangeRefreshToken({grant_type:i="refresh_token",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,timeoutInSeconds:r,extraHeaders:n,...s}){const o=this._logger.create("exchangeRefreshToken");e||o.throw(new Error("A client_id is required")),s.refresh_token||o.throw(new Error("A refresh_token is required"));const a=new URLSearchParams({grant_type:i});for(const[d,h]of Object.entries(s))Array.isArray(h)?h.forEach(g=>a.append(d,g)):h!=null&&a.set(d,h);let l;switch(this._settings.client_authentication){case"client_secret_basic":if(!t)throw o.throw(new Error("A client_secret is required")),null;l=Ur.generateBasicAuth(e,t);break;case"client_secret_post":a.append("client_id",e),t&&a.append("client_secret",t);break}const u=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const c=await this._jsonService.postForm(u,{body:a,basicAuth:l,timeoutInSeconds:r,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return o.debug("got response"),c}async revoke(i){var e;const t=this._logger.create("revoke");i.token||t.throw(new Error("A token is required"));const r=await this._metadataService.getRevocationEndpoint(!1);t.debug(`got revocation endpoint, revoking ${(e=i.token_type_hint)!=null?e:"default token type"}`);const n=new URLSearchParams;for(const[s,o]of Object.entries(i))o!=null&&n.set(s,o);n.set("client_id",this._settings.client_id),this._settings.client_secret&&n.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(r,{body:n,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),t.debug("got response")}},GC=class{constructor(i,e,t){this._settings=i,this._metadataService=e,this._claimsService=t,this._logger=new mt("ResponseValidator"),this._userInfoService=new WC(this._settings,this._metadataService),this._tokenClient=new r_(this._settings,this._metadataService)}async validateSigninResponse(i,e,t){const r=this._logger.create("validateSigninResponse");this._processSigninState(i,e),r.debug("state processed"),await this._processCode(i,e,t),r.debug("code processed"),i.isOpenId&&this._validateIdTokenAttributes(i),r.debug("tokens validated"),await this._processClaims(i,e==null?void 0:e.skipUserInfo,i.isOpenId),r.debug("claims processed")}async validateCredentialsResponse(i,e){const t=this._logger.create("validateCredentialsResponse");i.isOpenId&&i.id_token&&this._validateIdTokenAttributes(i),t.debug("tokens validated"),await this._processClaims(i,e,i.isOpenId),t.debug("claims processed")}async validateRefreshResponse(i,e){var t,r;const n=this._logger.create("validateRefreshResponse");i.userState=e.data,(t=i.session_state)!=null||(i.session_state=e.session_state),(r=i.scope)!=null||(i.scope=e.scope),i.isOpenId&&i.id_token&&(this._validateIdTokenAttributes(i,e.id_token),n.debug("ID Token validated")),i.id_token||(i.id_token=e.id_token,i.profile=e.profile);const s=i.isOpenId&&!!i.id_token;await this._processClaims(i,!1,s),n.debug("claims processed")}validateSignoutResponse(i,e){const t=this._logger.create("validateSignoutResponse");if(e.id!==i.state&&t.throw(new Error("State does not match")),t.debug("state validated"),i.userState=e.data,i.error)throw t.warn("Response was error",i.error),new da(i)}_processSigninState(i,e){var t;const r=this._logger.create("_processSigninState");if(e.id!==i.state&&r.throw(new Error("State does not match")),e.client_id||r.throw(new Error("No client_id on state")),e.authority||r.throw(new Error("No authority on state")),this._settings.authority!==e.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==e.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),i.userState=e.data,i.url_state=e.url_state,(t=i.scope)!=null||(i.scope=e.scope),i.error)throw r.warn("Response was error",i.error),new da(i);e.code_verifier&&!i.code&&r.throw(new Error("Expected code in response"))}async _processClaims(i,e=!1,t=!0){const r=this._logger.create("_processClaims");if(i.profile=this._claimsService.filterProtocolClaims(i.profile),e||!this._settings.loadUserInfo||!i.access_token){r.debug("not loading user info");return}r.debug("loading user info");const n=await this._userInfoService.getClaims(i.access_token);r.debug("user info claims received from user info endpoint"),t&&n.sub!==i.profile.sub&&r.throw(new Error("subject from UserInfo response does not match subject in ID Token")),i.profile=this._claimsService.mergeClaims(i.profile,this._claimsService.filterProtocolClaims(n)),r.debug("user info claims received, updated profile:",i.profile)}async _processCode(i,e,t){const r=this._logger.create("_processCode");if(i.code){r.debug("Validating code");const n=await this._tokenClient.exchangeCode({client_id:e.client_id,client_secret:e.client_secret,code:i.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier,extraHeaders:t,...e.extraTokenParams});Object.assign(i,n)}else r.debug("No code to process")}_validateIdTokenAttributes(i,e){var t;const r=this._logger.create("_validateIdTokenAttributes");r.debug("decoding ID Token JWT");const n=Ol.decode((t=i.id_token)!=null?t:"");if(n.sub||r.throw(new Error("ID Token is missing a subject claim")),e){const s=Ol.decode(e);n.sub!==s.sub&&r.throw(new Error("sub in id_token does not match current sub")),n.auth_time&&n.auth_time!==s.auth_time&&r.throw(new Error("auth_time in id_token does not match original auth_time")),n.azp&&n.azp!==s.azp&&r.throw(new Error("azp in id_token does not match original azp")),!n.azp&&s.azp&&r.throw(new Error("azp not in id_token, but present in original id_token"))}i.profile=n}},Ml=class Cd{constructor(e){this.id=e.id||Ur.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=Pl.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new mt("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return mt.createStatic("State","fromStorageString"),Promise.resolve(new Cd(JSON.parse(e)))}static async clearStaleState(e,t){const r=mt.createStatic("State","clearStaleState"),n=Pl.getEpochTime()-t,s=await e.getAllKeys();r.debug("got keys",s);for(let o=0;o<s.length;o++){const a=s[o],l=await e.get(a);let u=!1;if(l)try{const c=await Cd.fromStorageString(l);r.debug("got item from key:",a,c.created),c.created<=n&&(u=!0)}catch(c){r.error("Error parsing state for key:",a,c),u=!0}else r.debug("no item in storage for key:",a),u=!0;u&&(r.debug("removed item for key:",a),e.remove(a))}}},Nh=class kd extends Ml{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?Ur.generateCodeVerifier():e.code_verifier||void 0,r=t?await Ur.generateCodeChallenge(t):void 0;return new kd({...e,code_verifier:t,code_challenge:r})}toStorageString(){return new mt("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){mt.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return kd.create(t)}},n_=class i_{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:r,redirect_uri:n,response_type:s,scope:o,state_data:a,response_mode:l,request_type:u,client_secret:c,nonce:d,url_state:h,resource:g,skipUserInfo:v,extraQueryParams:m,extraTokenParams:E,disablePKCE:R,dpopJkt:_,omitScopeWhenRequesting:T,...b}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!r)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!n)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!s)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!o)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const I=await Nh.create({data:a,request_type:u,url_state:h,code_verifier:!R,client_id:r,authority:t,redirect_uri:n,response_mode:l,client_secret:c,scope:o,extraTokenParams:E,skipUserInfo:v}),y=new URL(e);y.searchParams.append("client_id",r),y.searchParams.append("redirect_uri",n),y.searchParams.append("response_type",s),T||y.searchParams.append("scope",o),d&&y.searchParams.append("nonce",d),_&&y.searchParams.append("dpop_jkt",_);let C=I.id;h&&(C=`${C}${Rd}${h}`),y.searchParams.append("state",C),I.code_challenge&&(y.searchParams.append("code_challenge",I.code_challenge),y.searchParams.append("code_challenge_method","S256")),g&&(Array.isArray(g)?g:[g]).forEach(D=>y.searchParams.append("resource",D));for(const[w,D]of Object.entries({response_mode:l,...b,...m}))D!=null&&y.searchParams.append(w,D.toString());return new i_({url:y.href,state:I})}};n_._logger=new mt("SigninRequest");var HC=n_,$C="openid",ol=class{constructor(i){if(this.access_token="",this.token_type="",this.profile={},this.state=i.get("state"),this.session_state=i.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(Rd);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(Rd))}this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri"),this.code=i.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-Pl.getEpochTime()}set expires_in(i){typeof i=="string"&&(i=Number(i)),i!==void 0&&i>=0&&(this.expires_at=Math.floor(i)+Pl.getEpochTime())}get isOpenId(){var i;return((i=this.scope)==null?void 0:i.split(" ").includes($C))||!!this.id_token}},zC=class{constructor({url:i,state_data:e,id_token_hint:t,post_logout_redirect_uri:r,extraQueryParams:n,request_type:s,client_id:o}){if(this._logger=new mt("SignoutRequest"),!i)throw this._logger.error("ctor: No url passed"),new Error("url");const a=new URL(i);t&&a.searchParams.append("id_token_hint",t),o&&a.searchParams.append("client_id",o),r&&(a.searchParams.append("post_logout_redirect_uri",r),e&&(this.state=new Ml({data:e,request_type:s}),a.searchParams.append("state",this.state.id)));for(const[l,u]of Object.entries({...n}))u!=null&&a.searchParams.append(l,u.toString());this.url=a.href}},JC=class{constructor(i){this.state=i.get("state"),this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri")}},YC=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],QC=["sub","iss","aud","exp","iat"],XC=class{constructor(i){this._settings=i,this._logger=new mt("ClaimsService")}filterProtocolClaims(i){const e={...i};if(this._settings.filterProtocolClaims){let t;Array.isArray(this._settings.filterProtocolClaims)?t=this._settings.filterProtocolClaims:t=YC;for(const r of t)QC.includes(r)||delete e[r]}return e}mergeClaims(i,e){const t={...i};for(const[r,n]of Object.entries(e))if(t[r]!==n)if(Array.isArray(t[r])||Array.isArray(n))if(this._settings.mergeClaimsStrategy.array=="replace")t[r]=n;else{const s=Array.isArray(t[r])?t[r]:[t[r]];for(const o of Array.isArray(n)?n:[n])s.includes(o)||s.push(o);t[r]=s}else typeof t[r]=="object"&&typeof n=="object"?t[r]=this.mergeClaims(t[r],n):t[r]=n;return t}},ZC=class{constructor(i,e){this.keys=i,this.nonce=e}},xh=class{constructor(i,e){this._logger=new mt("OidcClient"),this.settings=i instanceof Id?i:new Id(i),this.metadataService=e??new t_(this.settings),this._claimsService=new XC(this.settings),this._validator=new GC(this.settings,this.metadataService,this._claimsService),this._tokenClient=new r_(this.settings,this.metadataService)}async createSigninRequest({state:i,request:e,request_uri:t,request_type:r,id_token_hint:n,login_hint:s,skipUserInfo:o,nonce:a,url_state:l,response_type:u=this.settings.response_type,scope:c=this.settings.scope,redirect_uri:d=this.settings.redirect_uri,prompt:h=this.settings.prompt,display:g=this.settings.display,max_age:v=this.settings.max_age,ui_locales:m=this.settings.ui_locales,acr_values:E=this.settings.acr_values,resource:R=this.settings.resource,response_mode:_=this.settings.response_mode,extraQueryParams:T=this.settings.extraQueryParams,extraTokenParams:b=this.settings.extraTokenParams,dpopJkt:I,omitScopeWhenRequesting:y=this.settings.omitScopeWhenRequesting}){const C=this._logger.create("createSigninRequest");if(u!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const w=await this.metadataService.getAuthorizationEndpoint();C.debug("Received authorization endpoint",w);const D=await HC.create({url:w,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:d,response_type:u,scope:c,state_data:i,url_state:l,prompt:h,display:g,max_age:v,ui_locales:m,id_token_hint:n,login_hint:s,acr_values:E,dpopJkt:I,resource:R,request:e,request_uri:t,extraQueryParams:T,extraTokenParams:b,request_type:r,response_mode:_,client_secret:this.settings.client_secret,skipUserInfo:o,nonce:a,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:y});await this.clearStaleState();const x=D.state;return await this.settings.stateStore.set(x.id,x.toStorageString()),D}async readSigninResponseState(i,e=!1){const t=this._logger.create("readSigninResponseState"),r=new ol(Ep.readParams(i,this.settings.response_mode));if(!r.state)throw t.throw(new Error("No state in response")),null;const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await Nh.fromStorageString(n),response:r}}async processSigninResponse(i,e){const t=this._logger.create("processSigninResponse"),{state:r,response:n}=await this.readSigninResponseState(i,!0);if(t.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const s=await this.getDpopProof(this.settings.dpop.store);e={...e,DPoP:s}}try{await this._validator.validateSigninResponse(n,r,e)}catch(s){if(s instanceof Td&&this.settings.dpop){const o=await this.getDpopProof(this.settings.dpop.store,s.nonce);e.DPoP=o,await this._validator.validateSigninResponse(n,r,e)}else throw s}return n}async getDpopProof(i,e){let t,r;return(await i.getAllKeys()).includes(this.settings.client_id)?(r=await i.get(this.settings.client_id),r.nonce!==e&&e&&(r.nonce=e,await i.set(this.settings.client_id,r))):(t=await Ur.generateDPoPKeys(),r=new ZC(t,e),await i.set(this.settings.client_id,r)),await Ur.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:r.keys,nonce:r.nonce})}async processResourceOwnerPasswordCredentials({username:i,password:e,skipUserInfo:t=!1,extraTokenParams:r={}}){const n=await this._tokenClient.exchangeCredentials({username:i,password:e,...r}),s=new ol(new URLSearchParams);return Object.assign(s,n),await this._validator.validateCredentialsResponse(s,t),s}async useRefreshToken({state:i,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,extraTokenParams:s}){var o;const a=this._logger.create("useRefreshToken");let l;if(this.settings.refreshTokenAllowedScope===void 0)l=i.scope;else{const d=this.settings.refreshTokenAllowedScope.split(" ");l=(((o=i.scope)==null?void 0:o.split(" "))||[]).filter(g=>d.includes(g)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const d=await this.getDpopProof(this.settings.dpop.store);n={...n,DPoP:d}}let u;try{u=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:l,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...s})}catch(d){if(d instanceof Td&&this.settings.dpop)n.DPoP=await this.getDpopProof(this.settings.dpop.store,d.nonce),u=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:l,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...s});else throw d}const c=new ol(new URLSearchParams);return Object.assign(c,u),a.debug("validating response",c),await this._validator.validateRefreshResponse(c,{...i,scope:l}),c}async createSignoutRequest({state:i,id_token_hint:e,client_id:t,request_type:r,post_logout_redirect_uri:n=this.settings.post_logout_redirect_uri,extraQueryParams:s=this.settings.extraQueryParams}={}){const o=this._logger.create("createSignoutRequest"),a=await this.metadataService.getEndSessionEndpoint();if(!a)throw o.throw(new Error("No end session endpoint")),null;o.debug("Received end session endpoint",a),!t&&n&&!e&&(t=this.settings.client_id);const l=new zC({url:a,id_token_hint:e,client_id:t,post_logout_redirect_uri:n,state_data:i,extraQueryParams:s,request_type:r});await this.clearStaleState();const u=l.state;return u&&(o.debug("Signout request has state to persist"),await this.settings.stateStore.set(u.id,u.toStorageString())),l}async readSignoutResponseState(i,e=!1){const t=this._logger.create("readSignoutResponseState"),r=new JC(Ep.readParams(i,this.settings.response_mode));if(!r.state){if(t.debug("No state in response"),r.error)throw t.warn("Response was error:",r.error),new da(r);return{state:void 0,response:r}}const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await Ml.fromStorageString(n),response:r}}async processSignoutResponse(i){const e=this._logger.create("processSignoutResponse"),{state:t,response:r}=await this.readSignoutResponseState(i,!0);return t?(e.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(r,t)):e.debug("No state from storage; skipping response validation"),r}clearStaleState(){return this._logger.create("clearStaleState"),Ml.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(i,e){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:i,token_type_hint:e})}},Kt=function(i){return i.NotSupported="OIDC authentication not supported",i.Misconfigured="OIDC is misconfigured",i.General="Something went wrong with OIDC discovery",i.OpSupport="Configured OIDC OP does not support required functions",i.DynamicRegistrationNotSupported="Dynamic registration not supported",i.DynamicRegistrationFailed="Dynamic registration failed",i.DynamicRegistrationInvalid="Dynamic registration invalid response",i.CodeExchangeFailed="Failed to exchange code for token",i.InvalidBearerTokenResponse="Invalid bearer token response",i.InvalidIdToken="Invalid ID token",i.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",i}({}),Kh=i=>!!i&&typeof i=="object"&&!Array.isArray(i),Jn=(i,e)=>!i[e]||!Vo(i,e)?(p.error("Missing or invalid property: ".concat(e)),!1):!0,Vo=(i,e)=>i[e]&&typeof i[e]!="string"?(p.error("Invalid property: ".concat(e)),!1):!0,ek=(i,e)=>i[e]&&(!Array.isArray(i[e])||!i[e].every(t=>typeof t=="string"))?(p.error("Invalid property: ".concat(e)),!1):!0,lc=(i,e,t)=>{var r=i[e];return!r||!Array.isArray(r)||!r.includes(t)?(p.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},Fh=i=>{if(!Kh(i))throw p.error("Issuer configuration not found or malformed"),new Error(Kt.OpSupport);var e=[Jn(i,"authorization_endpoint"),Jn(i,"token_endpoint"),Jn(i,"revocation_endpoint"),Vo(i,"registration_endpoint"),Vo(i,"account_management_uri"),Vo(i,"device_authorization_endpoint"),ek(i,"account_management_actions_supported"),lc(i,"response_types_supported","code"),lc(i,"grant_types_supported","authorization_code"),lc(i,"code_challenge_methods_supported","S256")].some(t=>!t);if(!e)return{authorizationEndpoint:i.authorization_endpoint,tokenEndpoint:i.token_endpoint,registrationEndpoint:i.registration_endpoint,accountManagementEndpoint:i.account_management_uri,accountManagementActionsSupported:i.account_management_actions_supported};throw p.error("Issuer configuration not valid"),new Error(Kt.OpSupport)};function s_(i){Fh(i)}var o_=i=>{try{return ZS(i)}catch(e){throw p.error("Could not decode id_token",e),e}},a_=(i,e,t,r)=>{try{if(!i)throw new Error("No ID token");var n=o_(i);if(n.iss!==e)throw new Error("Invalid issuer");if(n.aud!==t)throw new Error("Invalid audience");if(r!==void 0&&n.nonce!==r)throw new Error("Invalid nonce");if(!n.exp||Date.now()>n.exp*1e3)throw new Error("Invalid expiry")}catch(s){throw p.error("Invalid ID token",s),new Error(Kt.InvalidIdToken)}};function l_(i){if(!Kh(i))throw p.error("Stored user state not found"),new Error(Kt.MissingOrInvalidStoredState);var e=[Jn(i,"homeserverUrl"),Jn(i,"nonce"),Vo(i,"identityServerUrl")].some(t=>!t);if(e)throw new Error(Kt.MissingOrInvalidStoredState)}var tk=i=>Kh(i)&&Jn(i,"token_type")&&i.token_type.toLowerCase()==="bearer"&&Jn(i,"access_token")&&Jn(i,"refresh_token")&&(!("expires_in"in i)||typeof i.expires_in=="number");function u_(i){if(!tk(i))throw new Error(Kt.InvalidBearerTokenResponse)}function wp(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Al(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wp(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):wp(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var uu=i=>{var e=i??Dr(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},rk=function(){var i=S(function*(e){if(!Xt)return p.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=new $n().encode(e),r=yield Xt.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")});return function(t){return i.apply(this,arguments)}}(),nk=i=>{var{redirectUri:e}=i;return{scope:uu(),redirectUri:e,state:Dr(8),nonce:Dr(8),codeVerifier:Dr(64)}},ik=function(){var i=S(function*(e,t,r){var{scope:n,redirectUri:s,state:o,nonce:a,codeVerifier:l}=r,u=new URL(e);return u.searchParams.append("response_mode","query"),u.searchParams.append("response_type","code"),u.searchParams.append("redirect_uri",s),u.searchParams.append("client_id",t),u.searchParams.append("state",o),u.searchParams.append("scope",n),u.searchParams.append("nonce",a),u.searchParams.append("code_challenge_method","S256"),u.searchParams.append("code_challenge",yield rk(l)),u.toString()});return function(t,r,n){return i.apply(this,arguments)}}(),sk=function(){var i=S(function*(e){var{metadata:t,redirectUri:r,clientId:n,homeserverUrl:s,identityServerUrl:o,nonce:a,prompt:l,urlState:u}=e,c=uu(),d=new xh(Al(Al({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:c,stateStore:new lu({prefix:"mx_oidc_",store:window.sessionStorage})})),h={homeserverUrl:s,nonce:a,identityServerUrl:o},g=yield d.createSigninRequest({state:h,nonce:a,prompt:l,url_state:u});return g.url});return function(t){return i.apply(this,arguments)}}(),ok=i=>({id_token:i.id_token,scope:i.scope,expires_at:i.expires_at,refresh_token:i.refresh_token,access_token:i.access_token,token_type:"Bearer"}),ak=function(){var i=S(function*(e,t){var r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),ca.setLogger(p);try{var n=new ol(r.searchParams),s=new lu({prefix:"mx_oidc_",store:window.sessionStorage}),o=yield s.get(n.state);if(!o)throw new Error(Kt.MissingOrInvalidStoredState);var a=yield Nh.fromStorageString(o),l=new xh(Al(Al({},a),{},{stateStore:s})),u=yield l.processSigninResponse(r.href),c=u.userState;l_(c),u_(u),a_(u.id_token,l.settings.authority,l.settings.client_id,c.nonce);var d=ok(u);return{oidcClientSettings:{clientId:l.settings.client_id,issuer:l.settings.authority},tokenResponse:d,homeserverUrl:c.homeserverUrl,identityServerUrl:c.identityServerUrl,idTokenClaims:u.profile}}catch(g){p.error("Oidc login failed",g);var h=g.message;throw Object.values(Kt).includes(h)?g:new Error(Kt.CodeExchangeFailed)}});return function(t,r){return i.apply(this,arguments)}}();function Rp(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Tp(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Rp(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Rp(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var c_=function(){var i=S(function*(e){var t,r=new URL(".well-known/openid-configuration",e),n=yield fetch(r,{method:z.Get,signal:Zl(5e3)}),s=yield n.json(),o=Fh(s),a=new Id({authority:e,redirect_uri:"",client_id:""}),l=new t_(a),u=yield l.getMetadata(),c=(t=yield l.getSigningKeys())!==null&&t!==void 0?t:void 0;return s_(u),Tp(Tp({},o),{},{metadata:u,signingKeys:c})});return function(t){return i.apply(this,arguments)}}(),lk="urn:ietf:params:oauth:grant-type:device_code",uk=function(){var i=S(function*(e,t){if(!e.registrationEndpoint)throw new Error(Kt.DynamicRegistrationNotSupported);var r=["authorization_code","refresh_token"];if(r.some(u=>!e.metadata.grant_types_supported.includes(u)))throw new Error(Kt.DynamicRegistrationNotSupported);var n={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,logo_uri:t.logoUri,contacts:t.contacts,policy_uri:t.policyUri,tos_uri:t.tosUri},s={Accept:"application/json","Content-Type":"application/json"};try{var o=yield fetch(e.registrationEndpoint,{method:z.Post,headers:s,body:JSON.stringify(n)});if(o.status>=400)throw new Error(Kt.DynamicRegistrationFailed);var a=yield o.json(),l=a.client_id;if(!l||typeof l!="string")throw new Error(Kt.DynamicRegistrationInvalid);return l}catch(u){throw Object.values(Kt).includes(u.message)?u:(p.error("Dynamic registration request failed",u),new Error(Kt.DynamicRegistrationFailed))}});return function(t,r){return i.apply(this,arguments)}}();function Ip(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Cp(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ip(Object(t),!0).forEach(function(r){f(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Ip(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class ck{constructor(e,t,r,n,s){this.idTokenClaims=s,f(this,"oidcClientReady",void 0),f(this,"oidcClient",void 0),f(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,n,r)}initialiseOidcClient(e,t,r,n){var s=this;return S(function*(){try{var o=yield c_(e),a=uu(r);s.oidcClient=new xh(Cp(Cp({},o.metadata),{},{client_id:t,scope:a,redirect_uri:n,authority:o.metadata.issuer,stateStore:new lu({prefix:"mx_oidc_",store:window.sessionStorage})}))}catch(l){throw p.error("Failed to initialise OIDC client.",l),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return S(function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var r=yield t.inflightRefreshRequest;return r}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return S(function*(){})()}getNewTokens(e){var t=this;return S(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var r={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},n=yield t.oidcClient.useRefreshToken({state:r,timeoutInSeconds:300}),s={accessToken:n.access_token,refreshToken:n.refresh_token};return yield t.persistTokens(s),s})()}}var kp=function(){},dk=10;class hk{constructor(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,f(this,"windowLimit",void 0),f(this,"start",void 0),f(this,"end",void 0),f(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3,(r=t.room)===null||r===void 0||r.on(ye.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,r=n=>{if(!n)throw new Error("No timeline given to initFields");var s,o=n.getEvents();if(!e)s=o.length;else if(s=o.findIndex(u=>u.getId()===e),s<0)throw new Error("getEventTimeline result didn't include requested event");var a=Math.min(o.length,s+Math.ceil(t/2)),l=Math.max(0,a-t);this.start=new Od(n,l-n.getBaseIndex()),this.end=new Od(n,a-n.getBaseIndex()),this.eventCount=a-l};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==ve.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==ve.FORWARDS){var r;return(r=this.end)!==null&&r!==void 0?r:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var r=this.getTimelineIndex(e);if(!r)return!1;var n=e==ve.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,kp("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");var s=this.eventCount-this.windowLimit;return s>0&&this.unpaginate(s,e!=ve.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==ve.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return!!r||!!n}paginate(e,t){var r=arguments,n=this;return S(function*(){var s=r.length>2&&r[2]!==void 0?r[2]:!0,o=r.length>3&&r[3]!==void 0?r[3]:dk,a=n.getTimelineIndex(e);if(!a)return!1;if(a.pendingPaginate)return a.pendingPaginate;if(n.extend(e,t))return!0;if(!s||o===0)return!1;var l=a.timeline.getPaginationToken(e);if(!l)return!1;var u=n.client.paginateEventTimeline(a.timeline,{backwards:e==ve.BACKWARDS,limit:t}).finally(function(){a.pendingPaginate=void 0}).then(c=>c?n.paginate(e,t,!0,o-1):n.paginate(e,t,!1,0));return a.pendingPaginate=u,u})()}unpaginate(e,t){var r=t?this.start:this.end;if(!r)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,kp("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var r,n,s=t.getEvents(),o=0,a=s.length;t===this.start.timeline&&(o=this.start.index+t.getBaseIndex()),t===((r=this.end)===null||r===void 0?void 0:r.timeline)&&(a=this.end.index+t.getBaseIndex());for(var l=o;l<a;l++)e.push(s[l]);if(t===((n=this.end)===null||n===void 0?void 0:n.timeline))break;t=t.getNeighbouringTimeline(ve.FORWARDS)}return e}}class Od{constructor(e,t){this.timeline=e,this.index=t,f(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?ve.BACKWARDS:ve.FORWARDS);return r?(this.timeline=r,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}}var So="m.login.email.identity",Op="m.login.msisdn",Pd=function(i){return i.Password="m.login.password",i.Recaptcha="m.login.recaptcha",i.Terms="m.login.terms",i.Email="m.login.email.identity",i.Msisdn="m.login.msisdn",i.Sso="m.login.sso",i.SsoUnstable="org.matrix.login.sso",i.Dummy="m.login.dummy",i.RegistrationToken="m.login.registration_token",i.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",i}({});class d_ extends Error{constructor(e,t,r){super(e),this.required_stages=t,this.flows=r,f(this,"name","NoAuthFlowFoundError")}}class fk{constructor(e){var t=this;f(this,"matrixClient",void 0),f(this,"inputs",void 0),f(this,"clientSecret",void 0),f(this,"requestCallback",void 0),f(this,"busyChangedCallback",void 0),f(this,"stateUpdatedCallback",void 0),f(this,"requestEmailTokenCallback",void 0),f(this,"supportedStages",void 0),f(this,"data",void 0),f(this,"emailSid",void 0),f(this,"requestingEmailToken",!1),f(this,"attemptAuthDeferred",null),f(this,"chosenFlow",null),f(this,"currentStage",null),f(this,"emailAttempt",1),f(this,"submitPromise",null),f(this,"requestEmailToken",S(function*(){if(t.requestingEmailToken)p.warn("Could not request email token: Already requesting");else{p.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var r=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=r.sid,p.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return S(function*(){var t;e.attemptAuthDeferred=ni();var r=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var n;(n=e.busyChangedCallback)===null||n===void 0||n.call(e,!0);var s=e.data.session?{session:e.data.session}:null;e.doRequest(s).finally(()=>{var o;(o=e.busyChangedCallback)===null||o===void 0||o.call(e,!1)})}return r})()}poll(){var e=this;return S(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==So&&e.emailSid){var r={sid:e.emailSid,client_secret:e.clientSecret},n=e.matrixClient.getIdentityServerUrl();n&&(r.id_server=new URL(n).host),t={type:So,threepid_creds:r}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,r=this;return S(function*(){var n,s=t.length>1&&t[1]!==void 0?t[1]:!1;if(!r.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!s){var o;(o=r.busyChangedCallback)===null||o===void 0||o.call(r,!0)}for(;r.submitPromise;)try{yield r.submitPromise}catch{}var a;(n=r.data)!==null&&n!==void 0&&n.session?(a={session:r.data.session},Object.assign(a,e)):a=e;try{r.submitPromise=r.doRequest(a,s),yield r.submitPromise}finally{if(r.submitPromise=null,!s){var l;(l=r.busyChangedCallback)===null||l===void 0||l.call(r,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,r=this;return S(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;try{var s=yield r.requestCallback(e,n);r.attemptAuthDeferred.resolve(s),r.attemptAuthDeferred=null}catch(v){var o,a,l,u,c=v instanceof Qt?v:null,d=(o=c==null||(a=c.data)===null||a===void 0?void 0:a.flows)!==null&&o!==void 0?o:null,h=((l=r.data)===null||l===void 0?void 0:l.flows)||!!d;if(!c||c.httpStatus!==401||!c.data||!h)if(n)p.log("Background poll request failed doing UI auth: ignoring",v);else{var g;(g=r.attemptAuthDeferred)===null||g===void 0||g.reject(v)}c&&!c.data&&(c.data={}),c&&!c.data.flows&&!c.data.completed&&!c.data.session&&(c.data.flows=r.data.flows,c.data.completed=r.data.completed,c.data.session=r.data.session),c&&(r.data=c.data);try{r.startNextAuthStage()}catch(m){r.attemptAuthDeferred.reject(m),r.attemptAuthDeferred=null;return}if(!r.emailSid&&(u=r.chosenFlow)!==null&&u!==void 0&&u.stages.includes(Pd.Email))try{yield r.requestEmailToken()}catch(m){r.attemptAuthDeferred.reject(m),r.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,r=this.chooseStage();if(!r)throw new Error("No incomplete flows from the server");if(this.currentStage=r,r===Pd.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var n,s;this.stateUpdatedCallback(r,{errcode:((n=this.data)===null||n===void 0?void 0:n.errcode)||"",error:((s=this.data)===null||s===void 0?void 0:s.error)||""});return}this.stateUpdatedCallback(r,r===So?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),p.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return p.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(r=>!this.supportedStages.has(r)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],r=!!this.inputs.emailAddress||!!this.emailSid,n=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((c,d)=>this.scoreFlow(c)-this.scoreFlow(d));for(var s of t){var o=!1,a=!1;for(var l of s.stages)l===So?o=!0:l==Op&&(a=!0);if(o==r&&a==n)return s}var u=[];throw r&&u.push(So),n&&u.push(Op),new d_("No appropriate authentication flow found",u,t)}firstUncompletedStage(e){var t,r=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(n=>!r.includes(n))}}var h_=[i=>{i.createObjectStore("users",{keyPath:["userId"]}),i.createObjectStore("accountData",{keyPath:["type"]}),i.createObjectStore("sync",{keyPath:["clobber"]})},i=>{var e=i.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},i=>{i.createObjectStore("client_options",{keyPath:["clobber"]})},i=>{i.createObjectStore("to_device_queue",{autoIncrement:!0})}],vk=h_.length;function Wa(i,e,t){var r=i.openCursor(e);return new Promise((n,s)=>{var o=[];r.onerror=()=>{s(new Error("Query failed: "+r.error))},r.onsuccess=()=>{var a=r.result;if(!a){n(o);return}o.push(t(a)),a.continue()}})}function _i(i){return new Promise((e,t)=>{i.oncomplete=function(r){e(r)},i.onerror=function(){t(i.error)}})}function f_(i){return new Promise((e,t)=>{i.onsuccess=function(r){e(r)},i.onerror=function(){t(i.error)}})}function gk(i){return new Promise((e,t)=>{i.onsuccess=()=>e(i),i.onerror=r=>t(r)})}function uc(i){return f_(i).then(e=>i.result)}class Pp{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),pS(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,f(this,"dbName",void 0),f(this,"syncAccumulator",void 0),f(this,"db",void 0),f(this,"disconnected",!0),f(this,"_isNewlyCreated",!1),f(this,"syncToDatabasePromise",void 0),f(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new XS}connect(e){var t=this;if(!this.disconnected)return p.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,p.log("LocalIndexedDBStoreBackend.connect: connecting...");var r=this.indexedDB.open(this.dbName,vk);return r.onupgradeneeded=n=>{var s=r.result,o=n.oldVersion;p.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(o)),o<1&&(this._isNewlyCreated=!0),h_.forEach((a,l)=>{o<=l&&a(s)})},r.onblocked=()=>{p.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},p.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),f_(r).then(S(function*(){p.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=r.result,t.db.onversionchange=()=>{var n;(n=t.db)===null||n===void 0||n.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e==null||e()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,r]=e;p.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,r)=>{var n=this.db.transaction(["oob_membership_events"],"readonly"),s=n.objectStore("oob_membership_events"),o=s.index("room"),a=IDBKeyRange.only(e),l=o.openCursor(a),u=[],c=!1;l.onsuccess=()=>{var d=l.result;if(!d)return!u.length&&!c?t(null):t(u);var h=d.value;h.oob_written?c=!0:u.push(h),d.continue()},l.onerror=d=>{r(d)}}).then(t=>(p.log("LL: got ".concat(t==null?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var r=this;return S(function*(){p.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var n=r.db.transaction(["oob_membership_events"],"readwrite"),s=n.objectStore("oob_membership_events");t.forEach(a=>{s.put(a)});var o={room_id:e,oob_written:!0,state_key:0};s.put(o),yield _i(n),p.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return S(function*(){var r=t.db.transaction(["oob_membership_events"],"readonly"),n=r.objectStore("oob_membership_events"),s=n.index("room"),o=IDBKeyRange.only(e),a=uc(s.openKeyCursor(o,"next")).then(v=>(v==null?void 0:v.primaryKey)[1]),l=uc(s.openKeyCursor(o,"prev")).then(v=>(v==null?void 0:v.primaryKey)[1]),[u,c]=yield Promise.all([a,l]),d=t.db.transaction(["oob_membership_events"],"readwrite"),h=d.objectStore("oob_membership_events"),g=IDBKeyRange.bound([e,u],[e,c]);p.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,u],[e,c]),yield gk(h.delete(g))})()}clearDatabase(){return new Promise(e=>{var t;p.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{p.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{p.warn("unable to delete js-sdk store indexeddb: ".concat(r.error)),e()},r.onsuccess=()=>{p.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(Jl(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return S(function*(){return t.syncToDatabasePromise?(p.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return S(function*(){try{var r=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(r.accountData),t.persistSyncData(r.nextBatch,r.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return p.log("Persisting sync data up to",e),Ei(()=>{var r=this.db.transaction(["sync"],"readwrite"),n=r.objectStore("sync");return n.put({clobber:"-",nextBatch:e,roomsData:t}),_i(r).then(()=>{p.log("Persisted sync data up to",e)})})}persistAccountData(e){return Ei(()=>{var t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(var n of e)r.put(n);return _i(t).then()})}persistUserPresenceEvents(e){return Ei(()=>{var t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(var n of e)r.put({userId:n[0],event:n[1]});return _i(t).then()})}getUserPresenceEvents(){return Ei(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return Wa(t,void 0,r=>[r.value.userId,r.value.event])})}loadAccountData(){return p.log("LocalIndexedDBStoreBackend: loading account data..."),Ei(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return Wa(t,void 0,r=>r.value).then(r=>(p.log("LocalIndexedDBStoreBackend: loaded account data"),r))})}loadSyncData(){return p.log("LocalIndexedDBStoreBackend: loading sync data..."),Ei(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return Wa(t,void 0,r=>r.value).then(r=>(p.log("LocalIndexedDBStoreBackend: loaded sync data"),r.length>1&&p.warn("loadSyncData: More than 1 sync row found."),r.length>0?r[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return Wa(t,void 0,r=>{var n;return(n=r.value)===null||n===void 0?void 0:n.options}).then(r=>r[0])})}storeClientOptions(e){var t=this;return S(function*(){var r=t.db.transaction(["client_options"],"readwrite"),n=r.objectStore("client_options");n.put({clobber:"-",options:e}),yield _i(r)})()}saveToDeviceBatches(e){var t=this;return S(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");for(var s of e)n.add(s);yield _i(r)})()}getOldestToDeviceBatch(){var e=this;return S(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),r=t.objectStore("to_device_queue"),n=yield uc(r.openCursor());if(!n)return null;var s=n.value;return{id:n.key,txnId:s.txnId,eventType:s.eventType,batch:s.batch}})()}removeToDeviceBatch(e){var t=this;return S(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");n.delete(e),yield _i(r)})()}destroy(){var e=this;return S(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}}class pk{constructor(e,t){this.workerFactory=e,this.dbName=t,f(this,"worker",void 0),f(this,"nextSeq",0),f(this,"inFlight",{}),f(this,"startPromise",void 0),f(this,"onWorkerMessage",r=>{var n=r.data;if(n.command=="closed"){var s;(s=this.onClose)===null||s===void 0||s.call(this)}else if(n.command=="cmd_success"||n.command=="cmd_fail"){if(n.seq===void 0){p.error("Got reply from worker with no seq");return}var o=this.inFlight[n.seq];if(o===void 0){p.error("Got reply for unknown seq "+n.seq);return}if(delete this.inFlight[n.seq],n.command=="cmd_success")o.resolve(n.result);else{var a=new Error(n.error.message);a.name=n.error.name,o.reject(a)}}else p.warn("Unrecognised message from worker: ",n)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return S(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return S(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return S(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{p.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var r,n=this.nextSeq++,s=ni();return this.inFlight[n]=s,(r=this.worker)===null||r===void 0||r.postMessage({command:e,seq:n,args:t}),s.promise})}destroy(){var e=this;return S(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}}var mk=1e3*60*5;class yk extends Ch{static exists(e,t){return Pp.exists(e,t)}constructor(e){if(super(e),f(this,"backend",void 0),f(this,"startedUp",!1),f(this,"syncTs",0),f(this,"userModifiedMap",{}),f(this,"emitter",new rt),f(this,"on",this.emitter.on.bind(this.emitter)),f(this,"onClose",()=>{this.emitter.emit("closed")}),f(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),f(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),f(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),f(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{p.log("Deleted indexeddb data.")},t=>{throw p.error("Failed to delete indexeddb data: ".concat(t)),t})))),f(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var r of this.getUsers())this.userModifiedMap[r.userId]!==r.getLastModifiedTime()&&r.events.presence&&(t.push([r.userId,r.events.presence.event]),this.userModifiedMap[r.userId]=r.getLastModifiedTime());return this.backend.syncToDatabase(t)})),f(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),f(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),f(this,"setOutOfBandMembers",this.degradable((t,r)=>(super.setOutOfBandMembers(t,r),this.backend.setOutOfBandMembers(t,r)),"setOutOfBandMembers")),f(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),f(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),f(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new pk(e.workerFactory,e.dbName):this.backend=new Pp(e.indexedDB,e.dbName)}startup(){return this.startedUp?(p.log("IndexedDBStore.startup: already started"),Promise.resolve()):(p.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(p.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{p.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[r,n]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var s=this.createUser(r);n&&s.setPresenceEvent(new Ot(n)),this.userModifiedMap[s.userId]=s.getLastModifiedTime(),this.storeUser(s)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>mk}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var r=this,n=t?super[t]:null;return S(function*(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];try{return yield e.call(r,...o)}catch(l){p.error("IndexedDBStore failure, degrading to MemoryStore",l),r.emitter.emit("degraded",l);try{p.log("IndexedDBStore trying to delete degraded data"),yield r.backend.clearDatabase(),p.log("IndexedDBStore delete after degrading succeeded")}catch(u){p.warn("IndexedDBStore delete after degrading failed",u)}if(n)return n.call(r,...o)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,r=this;return S(function*(){if(!r.localStorage)return t().call(r,e);var n=r.localStorage.getItem(cc(e));if(n)try{return JSON.parse(n)}catch(s){p.error("Could not parse persisted pending events",s)}return[]})()}setPendingEvents(e,t){var r=()=>super.setPendingEvents,n=this;return S(function*(){if(!n.localStorage)return r().call(n,e,t);t.length>0?n.localStorage.setItem(cc(e),JSON.stringify(t)):n.localStorage.removeItem(cc(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function cc(i){return"mx_pending_events_".concat(i)}var Sk=function(i){return i.Email="email",i.Phone="msisdn",i}({}),_k=new ut("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),bk=function(i){return i.Gitlab="gitlab",i.Github="github",i.Apple="apple",i.Google="google",i.Facebook="facebook",i.Twitter="twitter",i}({}),Ek=function(i){return i.LOGIN="login",i.REGISTER="register",i}({}),wk=function(i){return i.Global="Global",i.SetItemError="setItem",i.GetItemError="getItem",i.RemoveItemError="removeItem",i.ClearError="clear",i.QuotaExceededError="QuotaExceededError",i}({});class Rk extends rt{}new Rk;var v_=()=>new Yl;function g_(i){v_=i}function p_(i){var e,t,r;return i.store=(e=i.store)!==null&&e!==void 0?e:new Ch({localStorage:global.localStorage}),i.scheduler=(t=i.scheduler)!==null&&t!==void 0?t:new Ts,i.cryptoStore=(r=i.cryptoStore)!==null&&r!==void 0?r:v_(),i}function Md(i){return new si(p_(i))}function Tk(i,e,t,r){var n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new QS(i,e,t,p_(r),n)}const Ik=Object.freeze(Object.defineProperty({__proto__:null,AuthType:Pd,AutoDiscovery:ke,AutoDiscoveryAction:vr,AutoDiscoveryError:_r,Beacon:Vy,BeaconEvent:tt,CRYPTO_ENABLED:pC,CallEvent:De,CallFeedEvent:Br,Category:un,ClientEvent:_e,ClientPrefix:vt,ClientStoppedError:CI,ConditionKind:_t,ConditionOperator:uI,ConnectionError:Sa,ContentHelpers:YR,Crypto:kI,CryptoEvent:Ce,DELEGATED_OIDC_COMPATIBILITY:_k,DEVICE_CODE_SCOPE:lk,DMMemberCountCondition:cI,Device:uS,DeviceVerification:_n,Direction:Ue,DuplicateStrategy:xo,EVENT_VISIBILITY_CHANGE_TYPE:Oi,EventEmitterEvents:Ry,EventStatus:Re,EventTimeline:ve,EventTimelineSet:ns,EventType:F,FILTER_RELATED_BY_REL_TYPES:gs,FILTER_RELATED_BY_SENDERS:vs,FeatureSupport:Lt,Filter:rr,GET_LOGIN_TOKEN_CAPABILITY:yC,GroupCall:vh,GroupCallEvent:Ye,GroupCallIntent:dS,GroupCallState:at,GroupCallStatsReportEvent:Eo,GroupCallType:ru,GuestAccess:kl,HTTPError:wl,HistoryVisibility:Ih,HttpApiEvent:Vc,IdentityPrefix:ln,IdentityProviderBrand:bk,IndexedDBCryptoStore:fe,IndexedDBStore:yk,InteractiveAuth:fk,InvalidCryptoStoreError:Sh,InvalidCryptoStoreState:yh,JoinRule:DS,KNOWN_SAFE_ROOM_VERSION:nS,KeySignatureUploadError:wo,LOCAL_NOTIFICATION_SETTINGS_PREFIX:ky,LocalStorageCryptoStore:iu,LocalStorageErrors:wk,LocationAssetType:Ss,MAIN_ROOM_TIMELINE:ya,MSC3912_RELATION_BASED_REDACTIONS_PROP:Kc,M_ASSET:pa,M_BEACON:Uc,M_BEACON_INFO:ah,M_HTML:yR,M_LOCATION:ma,M_MESSAGE:mR,M_POLL_END:yl,M_POLL_KIND_DISCLOSED:PR,M_POLL_KIND_UNDISCLOSED:MR,M_POLL_RESPONSE:ta,M_POLL_START:AR,M_TEXT:sh,M_TIMESTAMP:ri,M_TOPIC:uh,MatrixClient:si,MatrixError:Qt,MatrixEvent:Ot,MatrixEventEvent:Fe,MatrixHttpApi:eS,MatrixScheduler:Ts,MediaHandlerEvent:Ii,MediaPrefix:ls,MemoryCryptoStore:Yl,MemoryStore:Ch,Method:z,MsgType:Nr,NoAuthFlowFoundError:d_,NotificationCountType:Ve,OidcError:Kt,OidcTokenRefresher:ck,PUSHER_DEVICE_ID:DR,PUSHER_ENABLED:Fc,PendingEventOrdering:Is,Poll:Hy,PollEvent:jn,Preset:Th,PushRuleActionName:zn,PushRuleKind:Ct,REFERENCE_RELATION:my,ReceiptType:Gt,RelationType:lt,Relations:lh,RelationsEvent:Qa,RestrictedAllowType:$0,Room:eu,RoomCreateTypeField:Sl,RoomEvent:ye,RoomMember:bl,RoomMemberEvent:Yt,RoomNameType:Fr,RoomState:ua,RoomStateEvent:Ae,RoomSummary:My,RoomType:as,RoomVersionStability:tS,RoomWidgetClient:QS,RuleId:It,SERVICE_TYPES:id,SSOAction:Ek,SearchOrderBy:US,SearchResult:ou,SecretStorage:e0,ServerCapabilities:rS,SetPresence:iS,SlidingSyncEvent:Ed,StatsReport:bn,SyncAccumulator:XS,SyncState:$e,THREAD_RELATION_TYPE:Je,Thread:et,ThreadEvent:Ht,ThreadFilterType:Rr,ThreepidMedium:Sk,TimelineIndex:Od,TimelineWindow:hk,ToDeviceMessageId:Zt,TweakName:gh,TypedEventEmitter:rt,UNSIGNED_MEMBERSHIP_FIELD:Oy,UNSIGNED_THREAD_ID_FIELD:_l,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:Cy,UNSTABLE_MSC2666_MUTUAL_ROOMS:FS,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:BS,UNSTABLE_MSC2666_SHARED_ROOMS:KS,UNSTABLE_MSC2716_MARKER:Iy,UNSTABLE_MSC3088_ENABLED:Nc,UNSTABLE_MSC3088_PURPOSE:Lc,UNSTABLE_MSC3089_BRANCH:pn,UNSTABLE_MSC3089_LEAF:Ty,UNSTABLE_MSC3089_TREE_SUBTYPE:xc,UNSTABLE_MSC3852_LAST_SEEN_UA:mC,User:En,UserEvent:hr,Visibility:H0,anySignal:Yy,calculateRetryBackoff:Zy,completeAuthorizationCodeGrant:ak,createClient:Md,createNewMatrixCall:na,createRoomWidgetClient:Tk,decodeBase64:At,decodeIdToken:o_,determineFeatureSupport:nl,discoverAndValidateOIDCIssuerWellKnown:c_,encodeBase64:zt,encodeUnpaddedBase64:tu,encodeUnpaddedBase64Url:lS,fixNotificationCountOnDecryption:jS,generateAuthorizationParams:nk,generateAuthorizationUrl:ik,generateOidcAuthorizationUrl:sk,generateScope:uu,getBeaconInfoIdentifier:El,getHttpUriForMxc:Ql,inMainTimelineForReceipt:la,isDmMemberCountCondition:dI,isEventTypeSame:SR,isPollEvent:$y,isTimestampInDuration:jc,isValidatedIssuerMetadata:s_,parseErrorResponse:dh,registerOidcClient:uk,retryNetworkOperation:Xy,setCryptoStoreFactory:g_,threadFilterTypeToFilter:qS,threadIdForReceipt:Cs,timeoutSignal:Zl,validateBearerTokenResponse:u_,validateIdToken:a_,validateOIDCIssuerWellKnown:Fh,validateStoredUserState:l_},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var Ad;try{Ad=globalThis.indexedDB}catch{}Ad&&g_(()=>new fe(Ad,"matrix-js-sdk:crypto"));globalThis.matrixcs=Ik;const Ck={class:"login-container"},kk={key:0,class:"error"},Ok={__name:"HomeView",setup(i){const e=Zd(),t=yn("https://matrix.org"),r=yn(""),n=yn(""),s=yn(""),o=async()=>{try{const l=await si({baseUrl:t.value}).loginWithPassword(r.value,n.value);localStorage.setItem("access_token",l.access_token),localStorage.setItem("user_id",l.user_id),e.push("/home")}catch{s.value=" .    ."}};return(a,l)=>(Yr(),gn("div",Ck,[l[3]||(l[3]=Ft("h2",null,"  Matrix",-1)),gu(Ft("input",{"onUpdate:modelValue":l[0]||(l[0]=u=>t.value=u),placeholder:" "},null,512),[[Eu,t.value]]),gu(Ft("input",{"onUpdate:modelValue":l[1]||(l[1]=u=>r.value=u),placeholder:""},null,512),[[Eu,r.value]]),gu(Ft("input",{"onUpdate:modelValue":l[2]||(l[2]=u=>n.value=u),type:"password",placeholder:""},null,512),[[Eu,n.value]]),Ft("button",{onClick:o},""),s.value?(Yr(),gn("p",kk,Io(s.value),1)):_c("",!0)]))}},Pk=eh(Ok,[["__scopeId","data-v-55d16415"]]),Mk=WE("matrix",{state:()=>({client:null,rooms:[]}),actions:{async login(i,e,t){this.client=Md({baseUrl:i});const{access_token:r,user_id:n,device_id:s}=await this.client.loginWithPassword(e,t);this.client=Md({baseUrl:i,accessToken:r,userId:n,deviceId:s}),localStorage.setItem("matrix_token",r),await this.client.startClient(),this.fetchRooms()},async fetchRooms(){if(!this.client)return;const i=this.client.getRooms();this.rooms=i.map(e=>{var t,r,n,s;return{roomId:e.roomId,name:e.name||" ",lastEvent:(t=e.timeline)!=null&&t.length?(s=(n=(r=e.timeline[e.timeline.length-1])==null?void 0:r.event)==null?void 0:n.content)==null?void 0:s.body:" ",unreadCount:e.getUnreadNotificationCount(),avatar:e.getAvatarUrl(this.client.baseUrl,40,40,"crop")}})},async getMessages(i){if(!this.client)return[];const e=this.client.getRoom(i);return e?e.timeline.map(t=>({id:t.getId(),sender:t.getSender(),text:t.getContent().body||""})):[]}}}),Ak={class:"chat-list"},Dk=["onClick"],Uk=["src"],Lk={class:"chat-info"},Nk={key:1,class:"unread"},xk={__name:"ChatList",setup(i){const e=Mk(),t=Zd(),r=gr(()=>e.rooms),n=s=>{t.push(`/chat/${s}`)};return(s,o)=>(Yr(),gn("div",Ak,[o[0]||(o[0]=Ft("h2",null,"",-1)),Ft("ul",null,[(Yr(!0),gn($r,null,Eb(r.value,a=>(Yr(),gn("li",{key:a.roomId,onClick:l=>n(a.roomId)},[a.avatar?(Yr(),gn("img",{key:0,src:a.avatar,class:"avatar"},null,8,Uk)):_c("",!0),Ft("div",Lk,[Ft("h3",null,Io(a.name),1),Ft("p",null,Io(a.lastEvent),1)]),a.unreadCount?(Yr(),gn("span",Nk,Io(a.unreadCount),1)):_c("",!0)],8,Dk))),128))])]))}},Kk=eh(xk,[["__scopeId","data-v-28bb3b6e"]]),Fk={__name:"ChatView",setup(i){const e=Zd(),t=yn(null),r=yn([]);return pm(async()=>{const n=localStorage.getItem("access_token"),s=localStorage.getItem("user_id");if(!n||!s){e.push("/");return}t.value=si({baseUrl:"https://matrix.org",accessToken:n,userId:s}),await t.value.startClient(),r.value=t.value.getRooms()}),(n,s)=>(Yr(),gn("div",null,[s[0]||(s[0]=Ft("h2",null," ",-1)),Jt(Kk,{rooms:r.value},null,8,["rooms"])]))}},Bk=[{path:"/",component:Pk},{path:"/chat/:id",component:Fk}],jk=Gw({history:bw(),routes:Bk}),Bh=LE(Jw);Bh.use(KE());Bh.use(jk);Bh.mount("#app");export{Dr as A,wn as B,Ce as C,_n as D,F as E,Fe as F,ht as G,Ih as H,wt as I,bt as J,Oe as K,Vk as L,z as M,Nn as N,ts as O,fe as P,_s as Q,_a as R,Jr as S,Zt as T,jo as U,Ti as V,f as _,Gk as a,S as b,qk as c,Tn as d,tu as e,At as f,me as g,Zy as h,uS as i,rt as j,Ms as k,p as l,ii as m,Eh as n,Nr as o,su as p,ni as q,Qt as r,Zo as s,vt as t,CI as u,zt as v,yS as w,_h as x,Rh as y,bd as z};
